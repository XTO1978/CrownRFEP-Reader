<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="CrownRFEP_Reader.Views.ParallelPlayerPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:behaviors="clr-namespace:CrownRFEP_Reader.Behaviors"
    xmlns:controls="clr-namespace:CrownRFEP_Reader.Views.Controls"
    xmlns:precision="clr-namespace:CrownRFEP_Reader.Controls"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:vm="clr-namespace:CrownRFEP_Reader.ViewModels"
    Title="Análisis Paralelo"
    x:DataType="vm:ParallelPlayerViewModel"
    BackgroundColor="#FF0D0D0D"
    Shell.BackgroundColor="#FF0D0D0D"
    Shell.ForegroundColor="White"
    Shell.TitleColor="White">
    <Shell.NavBarIsVisible>
        <OnPlatform x:TypeArguments="x:Boolean">
            <On Platform="WinUI" Value="False" />
            <On Platform="Default" Value="True" />
        </OnPlatform>
    </Shell.NavBarIsVisible>

    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- Fallback local: evita crash si el recurso global no está disponible en runtime -->
            <OnPlatform x:TypeArguments="x:Double" x:Key="FontSizeMedium">
                <On Platform="WinUI" Value="12" />
                <On Platform="Default" Value="14" />
            </OnPlatform>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="*,Auto">
        <!--  Contenedor de vídeos  -->
        <Grid Grid.Row="0" Margin="20,20,20,0">
            <!--  Layout Horizontal  -->
            <Grid
                IsVisible="{Binding IsHorizontalOrientation}">
            <Grid
                ColumnDefinitions="*,*"
                ColumnSpacing="1">
                <!--  Vídeo 1  -->
                <Grid RowDefinitions="*,Auto">
                    <Border
                        BackgroundColor="#FF3A3A3A"
                        Stroke="{Binding ShowPlayer1Selected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF6DDDFF|Transparent'}"
                        StrokeShape="RoundRectangle 8"
                        StrokeThickness="2">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding SelectPlayer1Command}" />
                        </Border.GestureRecognizers>
                        <Grid>
                            <precision:PrecisionVideoPlayer
                                x:Name="MediaPlayer1H"
                                Aspect="AspectFit"
                                IsMuted="False" BackgroundColor="#FF0D0D0D"
                                Source="{Binding Video1.LocalClipPath}" />
                            <!--  Overlay para scrubbing con trackpad/mouse wheel  -->
                            <BoxView
                                BackgroundColor="Transparent"
                                InputTransparent="False">
                                <BoxView.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding SelectPlayer1Command}" />
                                </BoxView.GestureRecognizers>
                                <BoxView.Behaviors>
                                    <behaviors:VideoScrubBehavior VideoIndex="1" />
                                </BoxView.Behaviors>
                            </BoxView>
                            <!--  Indicador de selección  -->
                            <Border
                                Margin="12"
                                Padding="6,3"
                                BackgroundColor="#FF6DDDFF"
                                HorizontalOptions="End"
                                IsVisible="{Binding ShowPlayer1Selected}"
                                StrokeShape="RoundRectangle 4"
                                StrokeThickness="0"
                                VerticalOptions="Start">
                                <Label
                                    FontSize="{StaticResource FontSizeCaption}"
                                    FontAttributes="Bold"
                                    Text="ACTIVO"
                                    TextColor="Black" />
                            </Border>
                            <!--  Lap actual (overlay)  -->
                            <Border
                                Margin="12"
                                Padding="8,4"
                                BackgroundColor="#CC000000"
                                HorizontalOptions="Start"
                                InputTransparent="True"
                                IsVisible="{Binding HasLapTiming}"
                                StrokeShape="RoundRectangle 4"
                                StrokeThickness="0"
                                VerticalOptions="Start">
                                <Label
                                    FontAttributes="Bold"
                                    FontSize="{StaticResource FontSizeSmall}"
                                    Text="{Binding CurrentLapText1}"
                                    TextColor="{Binding CurrentLapColor1}" />
                            </Border>
                            <!--  Nombre del atleta  -->
                            <Border
                                Margin="12"
                                Padding="8,4"
                                BackgroundColor="#99000000"
                                HorizontalOptions="Start"
                                StrokeShape="RoundRectangle 4"
                                StrokeThickness="0"
                                VerticalOptions="End">
                                <Label
                                    FontSize="{StaticResource FontSizeSmall}"
                                    Text="{Binding Video1.Atleta.NombreCompleto}"
                                    TextColor="White" />
                            </Border>
                        </Grid>
                    </Border>
                    <!--  Controles individuales Video 1 (modo individual)  -->
                    <Border
                        Grid.Row="1"
                        Margin="0,8,0,0"
                        Padding="12,8"
                        BackgroundColor="Transparent"
                        IsVisible="{Binding IsIndividualMode}"
                        Stroke="#FF3A3A3A"
                        StrokeShape="RoundRectangle 8"
                        StrokeThickness="0">
                        <Grid RowDefinitions="Auto,Auto" RowSpacing="8">
                            <!--  Barra de progreso  -->
                            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="8">
                                <Label
                                    Text="{Binding CurrentPositionText1}"
                                    TextColor="#FFB1B1B1"
                                    FontSize="{StaticResource FontSizeCaption}"
                                    VerticalOptions="Center" />
                                <Slider
                                    x:Name="ProgressSlider1H"
                                    Grid.Column="1"
                                    Maximum="1"
                                    Minimum="0"
                                    ThumbColor="#FF6DDDFF"
                                    MinimumTrackColor="#FF6DDDFF"
                                    MaximumTrackColor="#FF3A3A3A"
                                    DragStarted="OnSlider1DragStarted"
                                    ValueChanged="OnSlider1ValueChanged"
                                    DragCompleted="OnSlider1DragCompleted" />
                                <Label
                                    Grid.Column="2"
                                    Text="{Binding DurationText1}"
                                    TextColor="#FFB1B1B1"
                                    FontSize="{StaticResource FontSizeCaption}"
                                    VerticalOptions="Center" />
                            </Grid>
                            <!--  Botones de control  -->
                            <HorizontalStackLayout Grid.Row="1" HorizontalOptions="Center" Spacing="8">
                                <Border Padding="8" BackgroundColor="#FF2A2A2A" StrokeShape="RoundRectangle 6" StrokeThickness="0">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding FrameBackwardCommand1}" />
                                    </Border.GestureRecognizers>
                                    <controls:SymbolIcon HeightRequest="{StaticResource IconSizeMedium}" SymbolName="backward.frame.fill" TintColor="White" WidthRequest="{StaticResource IconSizeMedium}" />
                                </Border>
                                <Border Padding="8" BackgroundColor="#FF2A2A2A" StrokeShape="RoundRectangle 6" StrokeThickness="0">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding SeekBackwardCommand1}" />
                                    </Border.GestureRecognizers>
                                    <controls:SymbolIcon HeightRequest="{StaticResource IconSizeMedium}" SymbolName="gobackward.5" TintColor="White" WidthRequest="{StaticResource IconSizeMedium}" />
                                </Border>
                                <Border Padding="10" BackgroundColor="#FF6DDDFF" StrokeShape="RoundRectangle 20" StrokeThickness="0">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding PlayPauseCommand1}" />
                                    </Border.GestureRecognizers>
                                    <controls:SymbolIcon HeightRequest="{StaticResource IconSizeDefault}" SymbolName="{Binding PlayPauseIcon1}" TintColor="Black" WidthRequest="{StaticResource IconSizeDefault}" />
                                </Border>
                                <Border Padding="8" BackgroundColor="#FF2A2A2A" StrokeShape="RoundRectangle 6" StrokeThickness="0">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding SeekForwardCommand1}" />
                                    </Border.GestureRecognizers>
                                    <controls:SymbolIcon HeightRequest="{StaticResource IconSizeMedium}" SymbolName="goforward.5" TintColor="White" WidthRequest="{StaticResource IconSizeMedium}" />
                                </Border>
                                <Border Padding="8" BackgroundColor="#FF2A2A2A" StrokeShape="RoundRectangle 6" StrokeThickness="0">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding FrameForwardCommand1}" />
                                    </Border.GestureRecognizers>
                                    <controls:SymbolIcon HeightRequest="{StaticResource IconSizeMedium}" SymbolName="forward.frame.fill" TintColor="White" WidthRequest="{StaticResource IconSizeMedium}" />
                                </Border>
                            </HorizontalStackLayout>
                        </Grid>
                    </Border>
                </Grid>
                <!--  Vídeo 2  -->
                <Grid Grid.Column="1" RowDefinitions="*,Auto">
                    <Border
                        BackgroundColor="#FF0D0D0D"
                        Stroke="{Binding ShowPlayer2Selected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF6DDDFF|Transparent'}"
                        StrokeShape="RoundRectangle 8"
                        StrokeThickness="2">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding SelectPlayer2Command}" />
                        </Border.GestureRecognizers>
                        <Grid>
                            <precision:PrecisionVideoPlayer
                                x:Name="MediaPlayer2H" BackgroundColor="#FF0D0D0D"
                                Aspect="AspectFit"
                                IsMuted="False"
                                Source="{Binding Video2.LocalClipPath}" />
                            <!--  Overlay para scrubbing con trackpad/mouse wheel  -->
                            <BoxView
                                BackgroundColor="Transparent"
                                InputTransparent="False">
                                <BoxView.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding SelectPlayer2Command}" />
                                </BoxView.GestureRecognizers>
                                <BoxView.Behaviors>
                                    <behaviors:VideoScrubBehavior VideoIndex="2" />
                                </BoxView.Behaviors>
                            </BoxView>
                            <!--  Indicador de selección  -->
                            <Border
                                Margin="12"
                                Padding="6,3"
                                BackgroundColor="#FF6DDDFF"
                                HorizontalOptions="End"
                                IsVisible="{Binding ShowPlayer2Selected}"
                                StrokeShape="RoundRectangle 4"
                                StrokeThickness="0"
                                VerticalOptions="Start">
                                <Label
                                    FontSize="{StaticResource FontSizeCaption}"
                                    FontAttributes="Bold"
                                    Text="ACTIVO"
                                    TextColor="Black" />
                            </Border>
                            <!--  Lap actual (overlay)  -->
                            <Border
                                Margin="12"
                                Padding="8,4"
                                BackgroundColor="#CC000000"
                                HorizontalOptions="Start"
                                InputTransparent="True"
                                IsVisible="{Binding HasLapTiming}"
                                StrokeShape="RoundRectangle 4"
                                StrokeThickness="0"
                                VerticalOptions="Start">
                                <Label
                                    FontAttributes="Bold"
                                    FontSize="{StaticResource FontSizeSmall}"
                                    Text="{Binding CurrentLapText2}"
                                    TextColor="{Binding CurrentLapColor2}" />
                            </Border>
                            <!--  Nombre del atleta  -->
                            <Border
                                Margin="12"
                                Padding="8,4"
                                BackgroundColor="#99000000"
                                HorizontalOptions="Start"
                                StrokeShape="RoundRectangle 4"
                                StrokeThickness="0"
                                VerticalOptions="End">
                                <Label
                                    FontSize="{StaticResource FontSizeSmall}"
                                    Text="{Binding Video2.Atleta.NombreCompleto}"
                                    TextColor="White" />
                            </Border>
                        </Grid>
                    </Border>
                    <!--  Controles individuales Video 2 (modo individual)  -->
                    <Border
                        Grid.Row="1"
                        Margin="0,8,0,0"
                        Padding="12,8"
                        BackgroundColor="#FF0D0D0D"
                        IsVisible="{Binding IsIndividualMode}"
                        Stroke="#FF3A3A3A"
                        StrokeShape="RoundRectangle 8"
                        StrokeThickness="0">
                        <Grid RowDefinitions="Auto,Auto" RowSpacing="8">
                            <!--  Barra de progreso  -->
                            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="8">
                                <Label
                                    Text="{Binding CurrentPositionText2}"
                                    TextColor="#FFB1B1B1"
                                    FontSize="{StaticResource FontSizeCaption}"
                                    VerticalOptions="Center" />
                                <Slider
                                    x:Name="ProgressSlider2H"
                                    Grid.Column="1"
                                    Maximum="1"
                                    Minimum="0"
                                    ThumbColor="#FF6DDDFF"
                                    MinimumTrackColor="#FF6DDDFF"
                                    MaximumTrackColor="#FF3A3A3A"
                                    DragStarted="OnSlider2DragStarted"
                                    ValueChanged="OnSlider2ValueChanged"
                                    DragCompleted="OnSlider2DragCompleted" />
                                <Label
                                    Grid.Column="2"
                                    Text="{Binding DurationText2}"
                                    TextColor="#FFB1B1B1"
                                    FontSize="{StaticResource FontSizeCaption}"
                                    VerticalOptions="Center" />
                            </Grid>
                            <!--  Botones de control  -->
                            <HorizontalStackLayout Grid.Row="1" HorizontalOptions="Center" Spacing="8">
                                <Border Padding="8" BackgroundColor="#FF2A2A2A" StrokeShape="RoundRectangle 6" StrokeThickness="0">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding FrameBackwardCommand2}" />
                                    </Border.GestureRecognizers>
                                    <controls:SymbolIcon HeightRequest="{StaticResource IconSizeMedium}" SymbolName="backward.frame.fill" TintColor="White" WidthRequest="{StaticResource IconSizeMedium}" />
                                </Border>
                                <Border Padding="8" BackgroundColor="#FF2A2A2A" StrokeShape="RoundRectangle 6" StrokeThickness="0">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding SeekBackwardCommand2}" />
                                    </Border.GestureRecognizers>
                                    <controls:SymbolIcon HeightRequest="{StaticResource IconSizeMedium}" SymbolName="gobackward.5" TintColor="White" WidthRequest="{StaticResource IconSizeMedium}" />
                                </Border>
                                <Border Padding="10" BackgroundColor="#FF6DDDFF" StrokeShape="RoundRectangle 20" StrokeThickness="0">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding PlayPauseCommand2}" />
                                    </Border.GestureRecognizers>
                                    <controls:SymbolIcon HeightRequest="{StaticResource IconSizeDefault}" SymbolName="{Binding PlayPauseIcon2}" TintColor="Black" WidthRequest="{StaticResource IconSizeDefault}" />
                                </Border>
                                <Border Padding="8" BackgroundColor="#FF2A2A2A" StrokeShape="RoundRectangle 6" StrokeThickness="0">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding SeekForwardCommand2}" />
                                    </Border.GestureRecognizers>
                                    <controls:SymbolIcon HeightRequest="{StaticResource IconSizeMedium}" SymbolName="goforward.5" TintColor="White" WidthRequest="{StaticResource IconSizeMedium}" />
                                </Border>
                                <Border Padding="8" BackgroundColor="#FF2A2A2A" StrokeShape="RoundRectangle 6" StrokeThickness="0">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding FrameForwardCommand2}" />
                                    </Border.GestureRecognizers>
                                    <controls:SymbolIcon HeightRequest="{StaticResource IconSizeMedium}" SymbolName="forward.frame.fill" TintColor="White" WidthRequest="{StaticResource IconSizeMedium}" />
                                </Border>
                            </HorizontalStackLayout>
                        </Grid>
                    </Border>
                </Grid>

                <!--  Diferencia (Δ) centrada entre ambos vídeos  -->
                <Border
                    Grid.ColumnSpan="2"
                    Padding="10,6"
                    BackgroundColor="#CC000000"
                    HorizontalOptions="Center"
                    InputTransparent="True"
                    IsVisible="{Binding HasLapTiming}"
                    StrokeShape="RoundRectangle 8"
                    StrokeThickness="0"
                    VerticalOptions="Center">
                    <Label
                        FontAttributes="Bold"
                        FontSize="{StaticResource FontSizeSubtitle}"
                        Text="{Binding CurrentLapDiffText}"
                        TextColor="White" />
                </Border>
            </Grid>
            </Grid>

            <!--  Layout Vertical  -->
            <Grid
                IsVisible="{Binding IsVerticalOrientation}"
                HorizontalOptions="Center"
                VerticalOptions="Fill">
                <Grid.MaximumWidthRequest>
                    <OnPlatform x:TypeArguments="x:Double">
                        <On Platform="WinUI" Value="700" />
                        <On Platform="Default" Value="900" />
                    </OnPlatform>
                </Grid.MaximumWidthRequest>
            <Grid
                RowDefinitions="*,*"
                RowSpacing="0"
                VerticalOptions="Fill">
                <!--  Diferencia (Δ) centrada entre ambos vídeos  -->
                <Border
                    Grid.RowSpan="2"
                    Padding="10,6"
                    BackgroundColor="#CC000000"
                    HorizontalOptions="Center"
                    InputTransparent="True"
                    IsVisible="{Binding HasLapTiming}"
                    StrokeShape="RoundRectangle 8"
                    StrokeThickness="0"
                    VerticalOptions="Center">
                    <Label
                        FontAttributes="Bold"
                        FontSize="{StaticResource FontSizeSubtitle}"
                        Text="{Binding CurrentLapDiffText}"
                        TextColor="White" />
                </Border>
                <!--  Vídeo 1  -->
                <Border
                    BackgroundColor="#FF0D0D0D"
                    Stroke="{Binding ShowPlayer1Selected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF6DDDFF|Transparent'}"
                    StrokeShape="RoundRectangle 8"
                    StrokeThickness="2">
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding SelectPlayer1Command}" />
                    </Border.GestureRecognizers>
                    <Grid RowDefinitions="*,Auto">
                        <Grid>
                            <precision:PrecisionVideoPlayer
                                x:Name="MediaPlayer1V"
                                Aspect="AspectFill" BackgroundColor="#FF0D0D0D"
                                IsMuted="False"
                                Source="{Binding Video1.LocalClipPath}" />
                            <!--  Overlay para scrubbing con trackpad/mouse wheel  -->
                            <BoxView
                                BackgroundColor="Transparent"
                                InputTransparent="False">
                                <BoxView.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding SelectPlayer1Command}" />
                                </BoxView.GestureRecognizers>
                                <BoxView.Behaviors>
                                    <behaviors:VideoScrubBehavior VideoIndex="1" />
                                </BoxView.Behaviors>
                            </BoxView>
                            <!--  Indicador de selección  -->
                            <Border
                                Margin="12"
                                Padding="6,3"
                                BackgroundColor="#FF6DDDFF"
                                HorizontalOptions="End"
                                IsVisible="{Binding ShowPlayer1Selected}"
                                StrokeShape="RoundRectangle 4"
                                StrokeThickness="0"
                                VerticalOptions="Start">
                                <Label
                                    FontSize="{StaticResource FontSizeCaption}"
                                    FontAttributes="Bold"
                                    Text="ACTIVO"
                                    TextColor="Black" />
                            </Border>
                            <!--  Lap actual (overlay)  -->
                            <Border
                                Margin="12"
                                Padding="8,4"
                                BackgroundColor="#CC000000"
                                HorizontalOptions="Start"
                                InputTransparent="True"
                                IsVisible="{Binding HasLapTiming}"
                                StrokeShape="RoundRectangle 4"
                                StrokeThickness="0"
                                VerticalOptions="Start">
                                <Label
                                    FontAttributes="Bold"
                                    FontSize="{StaticResource FontSizeSmall}"
                                    Text="{Binding CurrentLapText1}"
                                    TextColor="{Binding CurrentLapColor1}" />
                            </Border>
                            <!--  Nombre del atleta (overlay)  -->
                            <Border
                                Margin="12"
                                Padding="8,4"
                                BackgroundColor="#99000000"
                                HorizontalOptions="Start"
                                StrokeShape="RoundRectangle 4"
                                StrokeThickness="0"
                                VerticalOptions="End">
                                <Label
                                    FontSize="{StaticResource FontSizeSmall}"
                                    Text="{Binding Video1.Atleta.NombreCompleto}"
                                    TextColor="White" />
                            </Border>
                        </Grid>
                        <!--  Controles individuales Video 1 (dentro del Border)  -->
                        <Border
                            Grid.Row="1"
                            Padding="12,6"
                            BackgroundColor="#FF121212"
                            IsVisible="{Binding IsIndividualMode}"
                            StrokeThickness="0">
                            <Grid ColumnDefinitions="Auto,*,Auto,Auto" ColumnSpacing="8">
                                <Label
                                    Text="{Binding CurrentPositionText1}"
                                    TextColor="#FFB1B1B1"
                                    FontSize="{StaticResource FontSizeCaption}"
                                    VerticalOptions="Center" />
                                <Slider
                                    x:Name="ProgressSlider1V"
                                    Grid.Column="1"
                                    Maximum="1"
                                    Minimum="0"
                                    ThumbColor="#FF6DDDFF"
                                    MinimumTrackColor="#FF6DDDFF"
                                    MaximumTrackColor="#FF3A3A3A"
                                    DragStarted="OnSlider1DragStarted"
                                    ValueChanged="OnSlider1ValueChanged"
                                    DragCompleted="OnSlider1DragCompleted"
                                    VerticalOptions="Center" />
                                <Label
                                    Grid.Column="2"
                                    Text="{Binding DurationText1}"
                                    TextColor="#FFB1B1B1"
                                    FontSize="{StaticResource FontSizeCaption}"
                                    VerticalOptions="Center" />
                                <HorizontalStackLayout Grid.Column="3" Spacing="4">
                                    <Border Padding="6" BackgroundColor="#FF2A2A2A" StrokeShape="RoundRectangle 4" StrokeThickness="0">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding SeekBackwardCommand1}" />
                                        </Border.GestureRecognizers>
                                        <controls:SymbolIcon HeightRequest="{StaticResource IconSizeSmall}" SymbolName="gobackward.5" TintColor="White" WidthRequest="{StaticResource IconSizeSmall}" />
                                    </Border>
                                    <Border Padding="8" BackgroundColor="#FF6DDDFF" StrokeShape="RoundRectangle 16" StrokeThickness="0">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding PlayPauseCommand1}" />
                                        </Border.GestureRecognizers>
                                        <controls:SymbolIcon HeightRequest="{StaticResource IconSizeSmall}" SymbolName="{Binding PlayPauseIcon1}" TintColor="Black" WidthRequest="{StaticResource IconSizeSmall}" />
                                    </Border>
                                    <Border Padding="6" BackgroundColor="#FF2A2A2A" StrokeShape="RoundRectangle 4" StrokeThickness="0">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding SeekForwardCommand1}" />
                                        </Border.GestureRecognizers>
                                        <controls:SymbolIcon HeightRequest="{StaticResource IconSizeSmall}" SymbolName="goforward.5" TintColor="White" WidthRequest="{StaticResource IconSizeSmall}" />
                                    </Border>
                                </HorizontalStackLayout>
                            </Grid>
                        </Border>
                    </Grid>
                </Border>
                <!--  Vídeo 2  -->
                <Border
                    Grid.Row="1"
                    BackgroundColor="#FF0D0D0D"
                    Stroke="{Binding ShowPlayer2Selected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF6DDDFF|Transparent'}"
                    StrokeShape="RoundRectangle 8"
                    StrokeThickness="2">
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding SelectPlayer2Command}" />
                    </Border.GestureRecognizers>
                    <Grid RowDefinitions="*,Auto">
                        <Grid>
                            <precision:PrecisionVideoPlayer
                                x:Name="MediaPlayer2V"
                                Aspect="AspectFill" BackgroundColor="#FF0D0D0D"
                                IsMuted="False"
                                Source="{Binding Video2.LocalClipPath}" />
                            <!--  Overlay para scrubbing con trackpad/mouse wheel  -->
                            <BoxView
                                BackgroundColor="Transparent"
                                InputTransparent="False">
                                <BoxView.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding SelectPlayer2Command}" />
                                </BoxView.GestureRecognizers>
                                <BoxView.Behaviors>
                                    <behaviors:VideoScrubBehavior VideoIndex="2" />
                                </BoxView.Behaviors>
                            </BoxView>
                            <!--  Indicador de selección  -->
                            <Border
                                Margin="12"
                                Padding="6,3"
                                BackgroundColor="#FF6DDDFF"
                                HorizontalOptions="End"
                                IsVisible="{Binding ShowPlayer2Selected}"
                                StrokeShape="RoundRectangle 4"
                                StrokeThickness="0"
                                VerticalOptions="Start">
                                <Label
                                    FontSize="{StaticResource FontSizeCaption}"
                                    FontAttributes="Bold"
                                    Text="ACTIVO"
                                    TextColor="Black" />
                            </Border>
                            <!--  Lap actual (overlay)  -->
                            <Border
                                Margin="12"
                                Padding="8,4"
                                BackgroundColor="#CC000000"
                                HorizontalOptions="Start"
                                InputTransparent="True"
                                IsVisible="{Binding HasLapTiming}"
                                StrokeShape="RoundRectangle 4"
                                StrokeThickness="0"
                                VerticalOptions="Start">
                                <Label
                                    FontAttributes="Bold"
                                    FontSize="{StaticResource FontSizeSmall}"
                                    Text="{Binding CurrentLapText2}"
                                    TextColor="{Binding CurrentLapColor2}" />
                            </Border>
                            <!--  Nombre del atleta (overlay)  -->
                            <Border
                                Margin="12"
                                Padding="8,4"
                                BackgroundColor="#99000000"
                                HorizontalOptions="Start"
                                StrokeShape="RoundRectangle 4"
                                StrokeThickness="0"
                                VerticalOptions="End">
                                <Label
                                    FontSize="{StaticResource FontSizeSmall}"
                                    Text="{Binding Video2.Atleta.NombreCompleto}"
                                    TextColor="White" />
                            </Border>
                        </Grid>
                        <!--  Controles individuales Video 2 (dentro del Border)  -->
                        <Border
                            Grid.Row="1"
                            Padding="12,6"
                            BackgroundColor="#FF121212"
                            IsVisible="{Binding IsIndividualMode}"
                            StrokeThickness="0">
                            <Grid ColumnDefinitions="Auto,*,Auto,Auto" ColumnSpacing="8">
                                <Label
                                    Text="{Binding CurrentPositionText2}"
                                    TextColor="#FFB1B1B1"
                                    FontSize="{StaticResource FontSizeCaption}"
                                    VerticalOptions="Center" />
                                <Slider
                                    x:Name="ProgressSlider2V"
                                    Grid.Column="1"
                                    Maximum="1"
                                    Minimum="0"
                                    ThumbColor="#FF6DDDFF"
                                    MinimumTrackColor="#FF6DDDFF"
                                    MaximumTrackColor="#FF3A3A3A"
                                    DragStarted="OnSlider2DragStarted"
                                    ValueChanged="OnSlider2ValueChanged"
                                    DragCompleted="OnSlider2DragCompleted"
                                    VerticalOptions="Center" />
                                <Label
                                    Grid.Column="2"
                                    Text="{Binding DurationText2}"
                                    TextColor="#FFB1B1B1"
                                    FontSize="{StaticResource FontSizeCaption}"
                                    VerticalOptions="Center" />
                                <HorizontalStackLayout Grid.Column="3" Spacing="4">
                                    <Border Padding="6" BackgroundColor="#FF2A2A2A" StrokeShape="RoundRectangle 4" StrokeThickness="0">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding SeekBackwardCommand2}" />
                                        </Border.GestureRecognizers>
                                        <controls:SymbolIcon HeightRequest="{StaticResource IconSizeSmall}" SymbolName="gobackward.5" TintColor="White" WidthRequest="{StaticResource IconSizeSmall}" />
                                    </Border>
                                    <Border Padding="8" BackgroundColor="#FF6DDDFF" StrokeShape="RoundRectangle 16" StrokeThickness="0">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding PlayPauseCommand2}" />
                                        </Border.GestureRecognizers>
                                        <controls:SymbolIcon HeightRequest="{StaticResource IconSizeSmall}" SymbolName="{Binding PlayPauseIcon2}" TintColor="Black" WidthRequest="{StaticResource IconSizeSmall}" />
                                    </Border>
                                    <Border Padding="6" BackgroundColor="#FF2A2A2A" StrokeShape="RoundRectangle 4" StrokeThickness="0">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding SeekForwardCommand2}" />
                                        </Border.GestureRecognizers>
                                        <controls:SymbolIcon HeightRequest="{StaticResource IconSizeSmall}" SymbolName="goforward.5" TintColor="White" WidthRequest="{StaticResource IconSizeSmall}" />
                                    </Border>
                                </HorizontalStackLayout>
                            </Grid>
                        </Border>
                    </Grid>
                </Border>
            </Grid>
            </Grid>
        </Grid>

        <!--  Controles globales (modo simultáneo)  -->
        <Border
            Grid.Row="1"
            Margin="20"
            Padding="16"
            BackgroundColor="#FF121212"
            IsVisible="{Binding IsSimultaneousMode}"
            Stroke="#FF3A3A3A"
            StrokeShape="RoundRectangle 12"
            StrokeThickness="0">
            <Grid RowDefinitions="Auto,Auto,Auto" RowSpacing="12">
                <!--  Barra de progreso  -->
                <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12">
                    <Label
                        Text="{Binding CurrentPositionText}"
                        TextColor="#FFB1B1B1"
                        VerticalOptions="Center"
                        FontSize="{StaticResource FontSizeSmall}"
                        WidthRequest="70" />
                    <Slider
                        x:Name="ProgressSlider"
                        Grid.Column="1"
                        Maximum="1"
                        Minimum="0"
                        ThumbColor="#FF6DDDFF"
                        MinimumTrackColor="#FF6DDDFF"
                        MaximumTrackColor="#FF3A3A3A"
                        DragStarted="OnSliderDragStarted"
                        ValueChanged="OnSliderValueChanged"
                        DragCompleted="OnSliderDragCompleted" />
                    <Label
                        Grid.Column="2"
                        Text="{Binding DurationText}"
                        TextColor="#FFB1B1B1"
                        VerticalOptions="Center"
                        FontSize="{StaticResource FontSizeSmall}"
                        WidthRequest="70" />
                </Grid>

                <!--  Controles principales  -->
                <HorizontalStackLayout
                    Grid.Row="1"
                    HorizontalOptions="Center"
                    Spacing="6">
                    <!--  Frame anterior  -->
                    <Border
                        Padding="16,6"
                        BackgroundColor="#FF2A2A2A"
                        StrokeShape="RoundRectangle 4"
                        StrokeThickness="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding FrameBackwardCommand}" />
                        </Border.GestureRecognizers>
                        <controls:SymbolIcon
                            HeightRequest="{StaticResource IconSizeDefault}"
                            SymbolName="backward.frame.fill"
                            TintColor="White"
                            WidthRequest="{StaticResource IconSizeLarge}" />
                    </Border>

                    <!--  Retroceder 5s  -->
                    <Border
                        Padding="16,6"
                        BackgroundColor="#FF2A2A2A"
                        StrokeShape="RoundRectangle 4"
                        StrokeThickness="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding SeekBackwardCommand}" />
                        </Border.GestureRecognizers>
                        <controls:SymbolIcon
                            HeightRequest="{StaticResource IconSizeLarge}"
                            SymbolName="gobackward.5"
                            TintColor="White"
                            WidthRequest="{StaticResource IconSizeLarge}" />
                    </Border>

                    <!--  Play/Pause  -->
                    <Border
                        Padding="36,6"
                        BackgroundColor="#FF6DDDFF"
                        StrokeShape="RoundRectangle 4"
                        StrokeThickness="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding PlayPauseCommand}" />
                        </Border.GestureRecognizers>
                        <controls:SymbolIcon
                            HeightRequest="{StaticResource IconSizeLarge}"
                            SymbolName="{Binding PlayPauseIcon}"
                            TintColor="Black"
                            WidthRequest="{StaticResource IconSizeLarge}" />
                    </Border>

                    <!--  Avanzar 5s  -->
                    <Border
                        Padding="16,6"
                        BackgroundColor="#FF2A2A2A"
                        StrokeShape="RoundRectangle 4"
                        StrokeThickness="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding SeekForwardCommand}" />
                        </Border.GestureRecognizers>
                        <controls:SymbolIcon
                            HeightRequest="{StaticResource IconSizeLarge}"
                            SymbolName="goforward.5"
                            TintColor="White"
                            WidthRequest="{StaticResource IconSizeLarge}" />
                    </Border>

                    <!--  Frame siguiente  -->
                    <Border
                        Padding="16,6"
                        BackgroundColor="#FF2A2A2A"
                        StrokeShape="RoundRectangle 4"
                        StrokeThickness="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding FrameForwardCommand}" />
                        </Border.GestureRecognizers>
                        <controls:SymbolIcon
                            HeightRequest="{StaticResource IconSizeLarge}"
                            SymbolName="forward.frame.fill"
                            TintColor="White"
                            WidthRequest="{StaticResource IconSizeLarge}" />
                    </Border>
                </HorizontalStackLayout>

                <!--  Controles secundarios  -->
                <Grid Grid.Row="2" ColumnDefinitions="Auto,*,Auto,Auto,Auto">
                    <!--  Velocidad  -->
                    <HorizontalStackLayout Spacing="4">
                        <Label
                            Text="Velocidad:"
                            TextColor="#FFB1B1B1"
                            VerticalOptions="Center"
                            FontSize="{StaticResource FontSizeBody}" Margin="0,0,8,0" />
                        <Border
                            Padding="16,6"
                            BackgroundColor="#FF2A2A2A"
                            StrokeShape="RoundRectangle 4"
                            StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding SetSpeedCommand}" CommandParameter="0.25" />
                            </Border.GestureRecognizers>
                            <Label Text="0.25x" TextColor="White" FontSize="{StaticResource FontSizeBody}" />
                        </Border>
                        <Border
                            Padding="16,6"
                            BackgroundColor="#FF2A2A2A"
                            StrokeShape="RoundRectangle 4"
                            StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding SetSpeedCommand}" CommandParameter="0.5" />
                            </Border.GestureRecognizers>
                            <Label Text="0.5x" TextColor="White" FontSize="{StaticResource FontSizeBody}" />
                        </Border>
                        <Border
                            Padding="16,6"
                            BackgroundColor="#FF2A2A2A"
                            StrokeShape="RoundRectangle 4"
                            StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding SetSpeedCommand}" CommandParameter="1" />
                            </Border.GestureRecognizers>
                            <Label Text="1x" TextColor="White" FontSize="{StaticResource FontSizeBody}" />
                        </Border>
                        <Border
                            Padding="16,6"
                            BackgroundColor="#FF2A2A2A"
                            StrokeShape="RoundRectangle 4"
                            StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding SetSpeedCommand}" CommandParameter="2" />
                            </Border.GestureRecognizers>
                            <Label Text="2x" TextColor="White" FontSize="{StaticResource FontSizeBody}" />
                        </Border>
                        <Label
                            Margin="8,0,0,0"
                            Text="{Binding SpeedText}"
                            TextColor="#FF6DDDFF"
                            VerticalOptions="Center"
                            FontSize="{StaticResource FontSizeSubtitle}"
                            FontAttributes="Bold" />

                            <Border WidthRequest="1" HeightRequest="30" BackgroundColor="#FF3A3A3A" Margin="12,0" Stroke="#FF5E5E5E"/>
                    
                    <!--  Toggle orientación  -->
                        <Border
                            Padding="16,6"
                            BackgroundColor="{Binding IsHorizontalOrientation, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF6DDDFF|#FF2A2A2A'}"
                            StrokeShape="RoundRectangle 4"
                            StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ToggleOrientationCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="6">
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeLarge}"
                                    SymbolName="rectangle.split.2x1"
                                    TintColor="{Binding IsHorizontalOrientation, Converter={StaticResource BoolToColorConverter}, ConverterParameter='Black|White'}"
                                    WidthRequest="{StaticResource IconSizeLarge}" />
                                <Label
                                    Text="Horizontal"
                                    TextColor="{Binding IsHorizontalOrientation, Converter={StaticResource BoolToColorConverter}, ConverterParameter='Black|White'}"
                                    FontSize="{StaticResource FontSizeSubtitle}" />
                            </HorizontalStackLayout>
                        </Border>
                        <Border
                            Padding="16,6"
                            BackgroundColor="{Binding IsVerticalOrientation, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF6DDDFF|#FF2A2A2A'}"
                            StrokeShape="RoundRectangle 4"
                            StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ToggleOrientationCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="6">
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeLarge}"
                                    SymbolName="rectangle.split.1x2"
                                    TintColor="{Binding IsVerticalOrientation, Converter={StaticResource BoolToColorConverter}, ConverterParameter='Black|White'}"
                                    WidthRequest="{StaticResource IconSizeLarge}" />
                                <Label
                                    Text="Vertical"
                                    TextColor="{Binding IsVerticalOrientation, Converter={StaticResource BoolToColorConverter}, ConverterParameter='Black|White'}"
                                    FontSize="{StaticResource FontSizeSubtitle}" />
                            </HorizontalStackLayout>
                        </Border>
                    </HorizontalStackLayout>

                    <!--  Sincronizar por laps  -->
                    <Border
                        Grid.Column="2"
                        Margin="16,0"
                        Padding="12,8"
                        BackgroundColor="#FF2A2A2A"
                        StrokeShape="RoundRectangle 6"
                        StrokeThickness="0">
                        <HorizontalStackLayout Spacing="10" VerticalOptions="Center">
                            <Label
                                Text="Sincronizar laps"
                                TextColor="White"
                                FontSize="{StaticResource FontSizeSubtitle}"
                                VerticalOptions="Center" />
                            <Switch
                                IsToggled="{Binding IsLapSyncEnabled, Mode=TwoWay}"
                                VerticalOptions="Center" />
                        </HorizontalStackLayout>
                    </Border>

                    <!--  Toggle modo  -->
                    <Border
                        Grid.Column="3"
                        Margin="16,0"
                        Padding="12,8"
                        BackgroundColor="#FF2A2A2A"
                        StrokeShape="RoundRectangle 6"
                        StrokeThickness="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding ToggleModeCommand}" />
                        </Border.GestureRecognizers>
                        <HorizontalStackLayout Spacing="6">
                            <controls:SymbolIcon
                                HeightRequest="{StaticResource IconSizeLarge}"
                                SymbolName="{Binding ModeIcon}"
                                TintColor="#FF6DDDFF"
                                WidthRequest="{StaticResource IconSizeLarge}" />
                            <Label
                                Text="{Binding ModeText}"
                                TextColor="White"
                                FontSize="{StaticResource FontSizeSubtitle}" />
                        </HorizontalStackLayout>
                    </Border>

                    <!--  Botón de exportación  -->
                    <Border
                        Grid.Column="4"
                        Padding="12,8"
                        BackgroundColor="{Binding IsExporting, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF34C759|#FF2A2A2A'}"
                        IsEnabled="{Binding CanExport}"
                        Opacity="{Binding CanExport, Converter={StaticResource BoolToDoubleConverter}}"
                        StrokeShape="RoundRectangle 6"
                        StrokeThickness="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding ExportCommand}" />
                        </Border.GestureRecognizers>
                        <HorizontalStackLayout Spacing="6">
                            <controls:SymbolIcon
                                HeightRequest="{StaticResource IconSizeLarge}"
                                IsVisible="{Binding IsExporting, Converter={StaticResource InvertedBoolConverter}}"
                                SymbolName="square.and.arrow.up"
                                TintColor="White"
                                WidthRequest="{StaticResource IconSizeLarge}" />
                            <Label
                                Text="{Binding ExportStatus, TargetNullValue='Exportar'}"
                                TextColor="White"
                                FontSize="{StaticResource FontSizeBody}"
                                IsVisible="{Binding IsExporting}" />
                            <Label
                                Text="Exportar"
                                TextColor="White"
                                FontSize="{StaticResource FontSizeBody}"
                                IsVisible="{Binding IsExporting, Converter={StaticResource InvertedBoolConverter}}" />
                        </HorizontalStackLayout>
                    </Border>

                </Grid>
            </Grid>
        </Border>

        <!--  Barra inferior (modo individual) - Solo toggle modo  -->
        <Border
            Grid.Row="1"
            Margin="20"
            Padding="16,12"
            BackgroundColor="#FF121212"
            IsVisible="{Binding IsIndividualMode}"
            Stroke="#FF3A3A3A"
            StrokeShape="RoundRectangle 12"
            StrokeThickness="0">
            <Grid ColumnDefinitions="Auto,*,Auto,Auto,Auto">
                <!--  Velocidad  -->
                <HorizontalStackLayout Spacing="4">
                    <Label
                        Text="Velocidad:"
                        TextColor="#FFB1B1B1"
                        VerticalOptions="Center"
                        FontSize="{StaticResource FontSizeBody}" />
                    <Border Padding="16,6" BackgroundColor="#FF2A2A2A" StrokeShape="RoundRectangle 4" StrokeThickness="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding SetSpeedCommand}" CommandParameter="0.25" />
                        </Border.GestureRecognizers>
                        <Label Text="0.25x" TextColor="White" FontSize="{StaticResource FontSizeBody}" />
                    </Border>
                    <Border Padding="16,6" BackgroundColor="#FF2A2A2A" StrokeShape="RoundRectangle 4" StrokeThickness="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding SetSpeedCommand}" CommandParameter="0.5" />
                        </Border.GestureRecognizers>
                        <Label Text="0.5x" TextColor="White" FontSize="{StaticResource FontSizeBody}" />
                    </Border>
                    <Border Padding="16,6" BackgroundColor="#FF2A2A2A" StrokeShape="RoundRectangle 4" StrokeThickness="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding SetSpeedCommand}" CommandParameter="1" />
                        </Border.GestureRecognizers>
                        <Label Text="1x" TextColor="White" FontSize="{StaticResource FontSizeBody}" />
                    </Border>
                    <Border Padding="16,6" BackgroundColor="#FF2A2A2A" StrokeShape="RoundRectangle 4" StrokeThickness="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding SetSpeedCommand}" CommandParameter="2" />
                        </Border.GestureRecognizers>
                        <Label Text="2x" TextColor="White" FontSize="{StaticResource FontSizeBody}" />
                    </Border>
                    <Label
                        Margin="8,0,0,0"
                        Text="{Binding SpeedText}"
                        TextColor="#FF6DDDFF"
                        VerticalOptions="Center"
                        FontSize="{StaticResource FontSizeSubtitle}"
                        FontAttributes="Bold" />
                        <Border WidthRequest="1" HeightRequest="30" BackgroundColor="#FF3A3A3A" Margin="12,0" Stroke="#FF5E5E5E"/>
                    <Border
                        Padding="16,6"
                        BackgroundColor="{Binding IsHorizontalOrientation, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF6DDDFF|#FF2A2A2A'}"
                        StrokeShape="RoundRectangle 4"
                        StrokeThickness="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding ToggleOrientationCommand}" />
                        </Border.GestureRecognizers>
                        <controls:SymbolIcon
                            HeightRequest="{StaticResource IconSizeLarge}"
                            SymbolName="rectangle.split.2x1"
                            TintColor="{Binding IsHorizontalOrientation, Converter={StaticResource BoolToColorConverter}, ConverterParameter='Black|White'}"
                            WidthRequest="{StaticResource IconSizeLarge}" />
                    </Border>
                    <Border
                        Padding="16,6"
                        BackgroundColor="{Binding IsVerticalOrientation, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF6DDDFF|#FF2A2A2A'}"
                        StrokeShape="RoundRectangle 4"
                        StrokeThickness="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding ToggleOrientationCommand}" />
                        </Border.GestureRecognizers>
                        <controls:SymbolIcon
                            HeightRequest="{StaticResource IconSizeLarge}"
                            SymbolName="rectangle.split.1x2"
                            TintColor="{Binding IsVerticalOrientation, Converter={StaticResource BoolToColorConverter}, ConverterParameter='Black|White'}"
                            WidthRequest="{StaticResource IconSizeLarge}" />
                    </Border>
                </HorizontalStackLayout>

                <!--  Sincronizar por laps  -->
                <Border
                    Grid.Column="2"
                    Margin="16,0"
                    Padding="16,6"
                    BackgroundColor="#FF2A2A2A"
                    StrokeShape="RoundRectangle 4"
                    StrokeThickness="0">
                    <HorizontalStackLayout Spacing="10" VerticalOptions="Center">
                        <Label
                            Text="Sincronizar laps"
                            TextColor="White"
                            FontSize="{StaticResource FontSizeSubtitle}"
                            VerticalOptions="Center" />
                        <Switch
                            IsToggled="{Binding IsLapSyncEnabled, Mode=TwoWay}"
                            VerticalOptions="Center" />
                    </HorizontalStackLayout>
                </Border>

                <!--  Toggle modo  -->
                <Border
                    Grid.Column="3"
                    Margin="16,0"
                    Padding="16,6"
                    BackgroundColor="#FF6DDDFF"
                    StrokeShape="RoundRectangle 4"
                    StrokeThickness="0">
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding ToggleModeCommand}" />
                    </Border.GestureRecognizers>
                    <HorizontalStackLayout Spacing="2">
                        <controls:SymbolIcon
                            HeightRequest="{StaticResource IconSizeLarge}"
                            SymbolName="{Binding ModeIcon}"
                            TintColor="Black"
                            WidthRequest="{StaticResource IconSizeLarge}" />
                        <Label
                            Text="{Binding ModeText}"
                            TextColor="Black"
                            FontSize="{StaticResource FontSizeSubtitle}" />
                    </HorizontalStackLayout>
                </Border>

                <!--  Botón de exportación  -->
                <Border
                    Grid.Column="4"
                    Padding="16,6"
                    BackgroundColor="{Binding IsExporting, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF34C759|#FF2A2A2A'}"
                    IsEnabled="{Binding CanExport}"
                    Opacity="{Binding CanExport, Converter={StaticResource BoolToDoubleConverter}}"
                    StrokeShape="RoundRectangle 4"
                    StrokeThickness="0">
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding ExportCommand}" />
                    </Border.GestureRecognizers>
                    <HorizontalStackLayout Spacing="6">
                        <controls:SymbolIcon
                            HeightRequest="{StaticResource IconSizeLarge}"
                            IsVisible="{Binding IsExporting, Converter={StaticResource InvertedBoolConverter}}"
                            SymbolName="square.and.arrow.up"
                            TintColor="White"
                            WidthRequest="{StaticResource IconSizeLarge}" />
                        <Label
                            Text="{Binding ExportStatus, TargetNullValue='Exportar'}"
                            TextColor="White"
                            FontSize="{StaticResource FontSizeSubtitle}"
                            IsVisible="{Binding IsExporting}" />
                        <Label
                            Text="Exportar"
                            TextColor="White"
                            FontSize="{StaticResource FontSizeSubtitle}"
                            IsVisible="{Binding IsExporting, Converter={StaticResource InvertedBoolConverter}}" />
                    </HorizontalStackLayout>
                </Border>

            </Grid>
        </Border>
    </Grid>
</ContentPage>
