<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:CrownRFEP_Reader.ViewModels"
             xmlns:services="clr-namespace:CrownRFEP_Reader.Services"
             xmlns:controls="clr-namespace:CrownRFEP_Reader.Views.Controls"
             x:Class="CrownRFEP_Reader.Views.StatisticsPage"
             x:DataType="vm:StatisticsViewModel"
             Title="{Binding Title}">

    <Grid RowDefinitions="Auto,*,Auto">
        <controls:TopTabsBar Grid.Row="0" />

        <RefreshView Grid.Row="1" Command="{Binding RefreshCommand}" IsRefreshing="{Binding IsBusy}">
            <ScrollView Padding="15">
                <VerticalStackLayout Spacing="20">

                <!-- Selector de a침o -->
                <Frame Padding="15" CornerRadius="12" HasShadow="True">
                    <Grid ColumnDefinitions="*,Auto">
                        <Label Text="Estad칤sticas por A침o" 
                               FontSize="{StaticResource FontSizeTitle}" 
                               FontAttributes="Bold" 
                               VerticalOptions="Center"/>
                        <Picker Grid.Column="1" 
                                ItemsSource="{Binding AvailableYears}"
                                SelectedItem="{Binding SelectedYear}"
                                Title="A침o"/>
                    </Grid>
                </Frame>

                <!-- Estad칤sticas mensuales -->
                <Label Text="Sesiones por Mes" FontSize="{StaticResource FontSizeTitle}" FontAttributes="Bold"/>
                
                <CollectionView ItemsSource="{Binding MonthlyStats}" HeightRequest="200">
                    <CollectionView.ItemsLayout>
                        <LinearItemsLayout Orientation="Horizontal" ItemSpacing="10"/>
                    </CollectionView.ItemsLayout>
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="services:MonthlyStats">
                            <Frame Padding="15" CornerRadius="10" HasShadow="True" WidthRequest="100">
                                <VerticalStackLayout Spacing="5" VerticalOptions="Center">
                                    <Label Text="{Binding MonthName}" 
                                           FontSize="{StaticResource FontSizeSmall}" 
                                           FontAttributes="Bold"
                                           HorizontalOptions="Center"/>
                                    <Frame BackgroundColor="{StaticResource Primary}" 
                                           CornerRadius="8" 
                                           Padding="10"
                                           HasShadow="False">
                                        <Label Text="{Binding SessionCount}" 
                                               FontSize="{StaticResource FontSizeHeader}" 
                                               FontAttributes="Bold" 
                                               TextColor="White"
                                               HorizontalOptions="Center"/>
                                    </Frame>
                                    <Label Text="sesiones" FontSize="{StaticResource FontSizeCaption}" TextColor="Gray" HorizontalOptions="Center"/>
                                    <Label FontSize="{StaticResource FontSizeCaption}" TextColor="Gray" HorizontalOptions="Center">
                                        <Label.FormattedText>
                                            <FormattedString>
                                                <Span Text="{Binding VideoCount}"/>
                                                <Span Text=" videos"/>
                                            </FormattedString>
                                        </Label.FormattedText>
                                    </Label>
                                </VerticalStackLayout>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                    <CollectionView.EmptyView>
                        <Label Text="No hay datos para este a침o" 
                               TextColor="Gray" 
                               HorizontalOptions="Center"/>
                    </CollectionView.EmptyView>
                </CollectionView>

                <!-- Estad칤sticas por atleta -->
                <Label Text="Videos por Atleta" FontSize="{StaticResource FontSizeTitle}" FontAttributes="Bold" Margin="0,10,0,0"/>
                
                <CollectionView ItemsSource="{Binding AthleteStats}">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="services:AthleteVideoStats">
                            <Frame Margin="0,5" Padding="15" CornerRadius="10" HasShadow="True">
                                <Grid ColumnDefinitions="*,Auto,Auto" RowDefinitions="Auto,Auto">
                                    <Label Text="{Binding Athlete.NombreCompleto}" 
                                           FontSize="{StaticResource FontSizeSubtitle}" 
                                           FontAttributes="Bold"/>
                                    <Label Grid.Row="1" 
                                           Text="{Binding Athlete.CategoriaNombre}" 
                                           FontSize="{StaticResource FontSizeSmall}" 
                                           TextColor="Gray"/>
                                    
                                    <VerticalStackLayout Grid.Column="1" Grid.RowSpan="2" Margin="15,0">
                                        <Label Text="{Binding VideoCount}" 
                                               FontSize="{StaticResource FontSizeTitle}" 
                                               FontAttributes="Bold" 
                                               TextColor="{StaticResource Primary}"
                                               HorizontalOptions="Center"/>
                                        <Label Text="videos" FontSize="{StaticResource FontSizeCaption}" TextColor="Gray"/>
                                    </VerticalStackLayout>
                                    
                                    <VerticalStackLayout Grid.Column="2" Grid.RowSpan="2">
                                        <Label Text="{Binding TotalDurationFormatted}" 
                                               FontSize="{StaticResource FontSizeSubtitle}" 
                                               FontAttributes="Bold"
                                               HorizontalOptions="Center"/>
                                        <Label Text="duraci칩n" FontSize="{StaticResource FontSizeCaption}" TextColor="Gray"/>
                                    </VerticalStackLayout>
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                    <CollectionView.EmptyView>
                        <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center" Padding="40">
                            <Label Text="游늵" FontSize="{StaticResource FontSizeDisplay}" HorizontalOptions="Center"/>
                            <Label Text="No hay estad칤sticas disponibles" 
                                   FontSize="{StaticResource FontSizeSubtitle}" 
                                   HorizontalOptions="Center" 
                                   TextColor="Gray"/>
                        </VerticalStackLayout>
                    </CollectionView.EmptyView>
                </CollectionView>

                </VerticalStackLayout>
            </ScrollView>
        </RefreshView>

        <!--  Footer de la aplicaci칩n  -->
        <controls:AppFooter Grid.Row="2" />
    </Grid>
</ContentPage>
