<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="CrownRFEP_Reader.Views.DashboardPage"
    x:Name="ThisPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:behaviors="clr-namespace:CrownRFEP_Reader.Behaviors"
    xmlns:controls="clr-namespace:CrownRFEP_Reader.Views.Controls"
    xmlns:appcontrols="clr-namespace:CrownRFEP_Reader.Controls"
    xmlns:converters="clr-namespace:CrownRFEP_Reader.Converters"
    xmlns:markup="clr-namespace:CrownRFEP_Reader.Markup"
    xmlns:models="clr-namespace:CrownRFEP_Reader.Models"
    xmlns:services="clr-namespace:CrownRFEP_Reader.Services"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:viewmodels="clr-namespace:CrownRFEP_Reader.ViewModels"
    xmlns:vm="clr-namespace:CrownRFEP_Reader.ViewModels"
    Title="{Binding Title}"
    x:DataType="vm:DashboardViewModel"
    BackgroundColor="#FF121212">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:BoolToTextConverter x:Key="BoolToTextConverter" />
            <converters:BoolToOpacityConverter x:Key="BoolToOpacityConverter" />
            <converters:EqualityToBorderWidthConverter x:Key="EqualityToBorderWidthConverter" />
            <converters:NotNullOrEmptyBoolConverter x:Key="NotNullOrEmptyBoolConverter" />
            <converters:IsNotNullConverter x:Key="IsNotNullConverter" />
            <converters:HexStringToColorConverter x:Key="HexStringToColorConverter" />
            <converters:SmartFolderIconParameterConverter x:Key="SmartFolderIconParameterConverter" />
            <converters:SmartFolderColorParameterConverter x:Key="SmartFolderColorParameterConverter" />
            <converters:SessionIconParameterConverter x:Key="SessionIconParameterConverter" />
            <converters:SessionColorParameterConverter x:Key="SessionColorParameterConverter" />
            <converters:StringEqualsConverter x:Key="StringEqualsConverter" />
            <converters:BoolToStrokeColorConverter x:Key="BoolToStrokeColorConverter" />

            <controls:SessionsListRowTemplateSelector x:Key="SessionsListRowTemplateSelector">
                <controls:SessionsListRowTemplateSelector.HeaderTemplate>
                    <DataTemplate x:DataType="vm:SessionGroupHeaderRow">
                        <Grid 
                            BackgroundColor="Transparent"
                            HorizontalOptions="Fill">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="{OnPlatform iOS=24, WinUI=24, MacCatalyst=48, Default=48}" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <!-- Columna 1: contenido del header -->
                            <Border
                                Grid.Column="1"
                                BackgroundColor="Transparent"
                                HorizontalOptions="Fill"
                                Stroke="Transparent"
                                StrokeThickness="0"
                                StrokeShape="RoundRectangle 4">
                                <Border.Margin>
                                    <OnPlatform x:TypeArguments="Thickness">
                                        <On Platform="iOS" Value="0,1,0,0" />
                                        <On Platform="MacCatalyst,WinUI" Value="0,6,0,0" />
                                    </OnPlatform>
                                </Border.Margin>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ToggleSessionGroupExpandedCommand}"
                                        CommandParameter="{Binding Key}" />
                                </Border.GestureRecognizers>
                                <Grid
                                    ColumnDefinitions="Auto,*"
                                    VerticalOptions="Center"
                                    HorizontalOptions="Fill">
                                    <Grid.Padding>
                                        <OnPlatform x:TypeArguments="Thickness">
                                            <On Platform="iOS" Value="0,2" />
                                            <On Platform="MacCatalyst,WinUI" Value="0,8" />
                                        </OnPlatform>
                                    </Grid.Padding>
                                    <!-- Chevron de expansión -->
                                    <controls:SymbolIcon
                                        Grid.Column="0"
                                        HeightRequest="{StaticResource IconSizeSmall}"
                                        WidthRequest="{StaticResource IconSizeSmall}"
                                        TintColor="#FF888888"
                                        VerticalOptions="Center">
                                        <controls:SymbolIcon.Triggers>
                                            <DataTrigger TargetType="controls:SymbolIcon" Binding="{Binding IsExpanded}" Value="True">
                                                <Setter Property="SymbolName" Value="chevron.down" />
                                            </DataTrigger>
                                            <DataTrigger TargetType="controls:SymbolIcon" Binding="{Binding IsExpanded}" Value="False">
                                                <Setter Property="SymbolName" Value="chevron.right" />
                                            </DataTrigger>
                                        </controls:SymbolIcon.Triggers>
                                    </controls:SymbolIcon>
                                    <!-- Título del grupo -->
                                    <Label
                                        Grid.Column="1"
                                        Margin="8,0,0,0"
                                        FontFamily="{StaticResource AppFontBody}"
                                        FontSize="{StaticResource FontSizeBody}"
                                        FontAttributes="None"
                                        Text="{Binding Title}"
                                        TextColor="#FF888888"
                                        VerticalOptions="Center" />
                                </Grid>
                            </Border>
                        </Grid>
                    </DataTemplate>
                </controls:SessionsListRowTemplateSelector.HeaderTemplate>

                <controls:SessionsListRowTemplateSelector.SessionTemplate>
                    <DataTemplate x:DataType="vm:SessionRow">
                        <Grid 
                            BackgroundColor="Transparent"
                            HorizontalOptions="Fill">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="{OnPlatform iOS=24, WinUI=24, MacCatalyst=48, Default=48}" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <!-- Columna 1: contenido del subitem -->
                            <Border 
                                Grid.Column="1"
                                BackgroundColor="Transparent"
                                Stroke="Transparent"
                                StrokeThickness="0"
                                StrokeShape="RoundRectangle 6"
                                HorizontalOptions="Fill">
                                <Border.Padding>
                                    <OnPlatform x:TypeArguments="Thickness">
                                        <On Platform="iOS" Value="10,8,4,8" />
                                        <On Platform="Default" Value="10,6,4,6" />
                                    </OnPlatform>
                                </Border.Padding>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer
                                        Buttons="Primary"
                                        Tapped="OnSessionRowPrimaryTapped" />
                                    <TapGestureRecognizer
                                        Buttons="Secondary"
                                        Tapped="OnSessionRowContextMenuTapped">
                                        <TapGestureRecognizer.NumberOfTapsRequired>
                                            <OnPlatform x:TypeArguments="x:Int32">
                                                <On Platform="iOS" Value="99" />
                                                <On Platform="MacCatalyst,WinUI" Value="1" />
                                            </OnPlatform>
                                        </TapGestureRecognizer.NumberOfTapsRequired>
                                    </TapGestureRecognizer>
                                </Border.GestureRecognizers>
                            <Border.Behaviors>
                                <behaviors:SidebarHoverBehavior />
                            </Border.Behaviors>
                            <Border.Triggers>
                                <DataTrigger
                                    TargetType="Border"
                                    Binding="{Binding IsSelected}"
                                    Value="True">
                                    <Setter Property="BackgroundColor" Value="#FF2A2A2A" />
                                </DataTrigger>
                            </Border.Triggers>
                            <Grid
                                ColumnDefinitions="Auto,*,Auto,Auto"
                                VerticalOptions="Center"
                                HorizontalOptions="Fill">
                                <controls:SymbolIcon
                                    Grid.Column="0"
                                    HeightRequest="{StaticResource IconSizeSidebarMenu}"
                                    SymbolName="{Binding Session.Icon}"
                                    TintColor="{Binding Session.IconColor, Converter={StaticResource HexStringToColorConverter}}"
                                    VerticalOptions="Center"
                                    WidthRequest="{StaticResource IconSizeSidebarMenu}" />
                                <Label Grid.Column="1" Margin="8,0,0,0" Style="{StaticResource SidebarMenuSubItemLabel}">
                                    <Label.FormattedText>
                                        <FormattedString>
                                            <Span
                                                Text="{Binding Session.Lugar}"
                                                TextColor="White" />
                                            <Span
                                                Text=" · "
                                                TextColor="White" />
                                            <Span
                                                Text="{Binding Session.FechaDateTime, StringFormat='{0:dd/MM}'}"
                                                TextColor="White" />
                                        </FormattedString>
                                    </Label.FormattedText>
                                </Label>
                                <Label
                                    Grid.Column="2"
                                    Margin="0,0,8,0"
                                    FontFamily="{StaticResource AppFontMono}"
                                    FontSize="{StaticResource FontSizeSmall}"
                                    HorizontalOptions="End"
                                    HorizontalTextAlignment="End"
                                    TextColor="#FF888888"
                                    Text="{Binding Session.VideoCount}"
                                    VerticalOptions="Center" />
                                <Border
                                    ClassId="ContextMenuButton"
                                    Grid.Column="3"
                                    Margin="0,0,4,0"
                                    Padding="4"
                                    BackgroundColor="Transparent"
                                    StrokeThickness="0"
                                    HorizontalOptions="End"
                                    VerticalOptions="Center">
                                    <Border.IsVisible>
                                        <OnPlatform x:TypeArguments="x:Boolean">
                                            <On Platform="iOS" Value="True" />
                                            <On Platform="Default" Value="False" />
                                        </OnPlatform>
                                    </Border.IsVisible>
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Tapped="OnSessionRowContextMenuTapped" />
                                    </Border.GestureRecognizers>
                                    <controls:SymbolIcon
                                        HeightRequest="{StaticResource IconSizeSmall}"
                                        WidthRequest="{StaticResource IconSizeSmall}"
                                        SymbolName="ellipsis.circle"
                                        TintColor="#FF888888"
                                        VerticalOptions="Center" />
                                </Border>
                            </Grid>
                        </Border>
                        </Grid>
                    </DataTemplate>
                </controls:SessionsListRowTemplateSelector.SessionTemplate>
            </controls:SessionsListRowTemplateSelector>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid
        x:Name="RootGrid"
        Padding="0"
        RowDefinitions="Auto,*,Auto">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="{StaticResource SidebarWidthDefault}" />
            <ColumnDefinition Width="8" />
            <ColumnDefinition Width="{Binding MainPanelWidth}" />
            <ColumnDefinition Width="{Binding RightSplitterWidth}" />
            <ColumnDefinition Width="{Binding RightPanelWidth}" />
        </Grid.ColumnDefinitions>
        <controls:TopTabsBar
            Grid.Row="0"
            Grid.ColumnSpan="5"
            BackgroundColor="#FF121212"
            HorizontalOptions="Center" />

        <!--  Línea horizontal separadora entre fila 0 y fila 1  -->
        <BoxView
            Grid.Row="0"
            Grid.ColumnSpan="5"
            Margin="0"
            BackgroundColor="#FF3A3A3A"
            HeightRequest="1"
            HorizontalOptions="Fill"
            VerticalOptions="End" />

        <!--  GridSplitter entre columna 0 y 2  -->
        <controls:GridSplitter
            Grid.Row="1"
            Grid.Column="1"
            LeftColumnIndex="0"
            MinLeftWidth="200"
            MinRightWidth="300"
            RightColumnIndex="2"
            WidthRequest="8" />

        <!--  GridSplitter entre columna 2 y 4  -->
        <controls:GridSplitter
            Grid.Row="1"
            Grid.Column="3"
            LeftColumnIndex="2"
            LeftColumnWidth="{Binding MainPanelWidth, Mode=TwoWay}"
            MinLeftWidth="300"
            MinRightWidth="200"
            RightColumnIndex="4"
            RightColumnWidth="{Binding RightPanelWidth, Mode=TwoWay}"
            WidthRequest="8">
            <controls:GridSplitter.IsVisible>
                <Binding Path="IsVideoLessonsSelected" Converter="{toolkit:InvertedBoolConverter}" />
            </controls:GridSplitter.IsVisible>
        </controls:GridSplitter>

        <!--  Lista de sesiones recientes + acciones en la parte baja  -->
        <Grid
            Grid.Row="1"
            Grid.Column="0"
            BackgroundColor="#FF1E1E1E"
            RowDefinitions="Auto,*,Auto">

            <Grid.Padding>
                <OnPlatform x:TypeArguments="Thickness">
                    <On Platform="iOS" Value="8,0" />
                    <On Platform="Default" Value="20,0" />
                </OnPlatform>
            </Grid.Padding>

            <!--  Items fijos del sidebar (fuera del CollectionView para que funcionen gestos en WinUI)  -->
            <VerticalStackLayout
                x:Name="SidebarFixedItemsHeader"
                Grid.Row="0"
                HorizontalOptions="Fill">

                <VerticalStackLayout.Margin>
                    <OnPlatform x:TypeArguments="Thickness">
                        <On Platform="iOS" Value="0,8,0,0" />
                        <On Platform="Default" Value="0,20,0,0" />
                    </OnPlatform>
                </VerticalStackLayout.Margin>

                <VerticalStackLayout.Spacing>
                    <OnPlatform x:TypeArguments="x:Double">
                        <On Platform="iOS" Value="6" />
                        <On Platform="Default" Value="{StaticResource SpacingXSmall}" />
                    </OnPlatform>
                </VerticalStackLayout.Spacing>

                        <!--  Equipo (biblioteca remota en Wasabi) - PRIMERO  -->
                        <VerticalStackLayout
                            x:Name="RemoteLibraryContainer"
                            HorizontalOptions="Fill"
                            IsVisible="{Binding IsRemoteLibraryVisible}">

                            <Border
                                x:Name="RemoteLibraryHeaderBorder"
                                Style="{StaticResource SidebarMenuItemBorder}"
                                BackgroundColor="#FF2E7D32"
                                Stroke="Transparent"
                                StrokeThickness="0"
                                StrokeShape="RoundRectangle 6">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer
                                        Buttons="Secondary"
                                        Tapped="OnRemoteLibraryHeaderContextMenu"
                                        NumberOfTapsRequired="1" />
                                </Border.GestureRecognizers>
                                <Border.Padding>
                                    <OnPlatform x:TypeArguments="Thickness">
                                        <On Platform="iOS" Value="10,6,4,6" />
                                        <On Platform="Default" Value="10,10,4,10" />
                                    </OnPlatform>
                                </Border.Padding>
                                <Grid ColumnDefinitions="*,Auto" VerticalOptions="Center" HorizontalOptions="Fill">
                                    <Grid
                                        Grid.Column="0"
                                        ColumnDefinitions="Auto,*"
                                        VerticalOptions="Center"
                                        HorizontalOptions="Fill">
                                        <Grid.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding ToggleRemoteLibraryExpandedCommand}" />
                                        </Grid.GestureRecognizers>

                                        <controls:SymbolIcon
                                            Grid.Column="0"
                                            Margin="4,0,0,0"
                                            HeightRequest="{StaticResource IconSizeSidebarMenu}"
                                            WidthRequest="{StaticResource IconSizeSidebarMenu}"
                                            SymbolName="person.2"
                                            TintColor="White"
                                            VerticalOptions="Center" />
                                        <Label
                                            Grid.Column="1"
                                            Margin="8,0,0,0"
                                            FontFamily="{StaticResource AppFontEmphasis}"
                                            FontSize="{StaticResource FontSizeBody}"
                                            FontAttributes="Bold"
                                            Text="{Binding RemoteLibraryDisplayName}"
                                            TextColor="White"
                                            VerticalOptions="Center" />
                                    </Grid>

                                    <Border
                                        Grid.Column="1"
                                        Padding="2"
                                        Margin="0,0,8,0"
                                        BackgroundColor="Transparent"
                                        StrokeThickness="0">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding ToggleRemoteLibraryExpandedCommand}" />
                                        </Border.GestureRecognizers>
                                        <controls:SymbolIcon
                                            HeightRequest="{StaticResource IconSizeSmall}"
                                            WidthRequest="{StaticResource IconSizeSmall}"
                                            SymbolName="chevron.up.chevron.down"
                                            TintColor="White"
                                            VerticalOptions="Center" />
                                    </Border>
                                </Grid>
                            </Border>

                            <VerticalStackLayout
                                x:Name="RemoteLibraryItemsContainer"
                                HorizontalOptions="Fill"
                                IsVisible="{Binding IsRemoteLibraryExpanded}">
                                <VerticalStackLayout.Spacing>
                                    <OnPlatform x:TypeArguments="x:Double">
                                        <On Platform="iOS" Value="6" />
                                        <On Platform="Default" Value="{StaticResource SpacingXSmall}" />
                                    </OnPlatform>
                                </VerticalStackLayout.Spacing>

                                <Border
                                    x:Name="RemoteAllGalleryHeaderBorder"
                                    Style="{StaticResource SidebarMenuItemBorder}">
                                    <Border.Padding>
                                        <OnPlatform x:TypeArguments="Thickness">
                                            <On Platform="iOS" Value="10,8,4,8" />
                                            <On Platform="Default" Value="10,6,4,6" />
                                        </OnPlatform>
                                    </Border.Padding>
                                    <Border.Behaviors>
                                        <behaviors:SidebarHoverBehavior />
                                    </Border.Behaviors>
                                    <Border.Triggers>
                                        <DataTrigger
                                            TargetType="Border"
                                            Binding="{Binding IsRemoteAllGallerySelected}"
                                            Value="True">
                                            <Setter Property="BackgroundColor" Value="#FF2A2A2A" />
                                        </DataTrigger>
                                    </Border.Triggers>
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding RemoteSelectAllGalleryCommand}" />
                                    </Border.GestureRecognizers>
                                    <Grid ColumnDefinitions="Auto,*,Auto" Margin="18,0,0,0" VerticalOptions="Center" HorizontalOptions="Fill">
                                        <controls:SymbolIcon
                                            Grid.Column="0"
                                            Margin="4,0,0,0"
                                            HeightRequest="{StaticResource IconSizeSidebarMenu}"
                                            SymbolName="photo.on.rectangle.angled"
                                            TintColor="White"
                                            VerticalOptions="Center"
                                            WidthRequest="{StaticResource IconSizeSidebarMenu}" />
                                        <Label
                                            Grid.Column="1"
                                            Margin="8,0,0,0"
                                            Style="{StaticResource SidebarMenuItemLabel}"
                                            Text="Galería General" />
                                        <Label
                                            Grid.Column="2"
                                            Margin="0,0,8,0"
                                            FontFamily="{StaticResource AppFontMono}"
                                            FontSize="{StaticResource FontSizeSmall}"
                                            HorizontalOptions="End"
                                            HorizontalTextAlignment="End"
                                            Text="{Binding RemoteAllGalleryItemCount}"
                                            TextColor="#FF888888"
                                            VerticalOptions="Center" />
                                    </Grid>
                                </Border>

                                <Border
                                    x:Name="RemoteVideoLessonsHeaderBorder"
                                    Style="{StaticResource SidebarMenuItemBorder}">
                                    <Border.Padding>
                                        <OnPlatform x:TypeArguments="Thickness">
                                            <On Platform="iOS" Value="10,8,4,8" />
                                            <On Platform="Default" Value="10,6,4,6" />
                                        </OnPlatform>
                                    </Border.Padding>
                                    <Border.Behaviors>
                                        <behaviors:SidebarHoverBehavior />
                                    </Border.Behaviors>
                                    <Border.Triggers>
                                        <DataTrigger
                                            TargetType="Border"
                                            Binding="{Binding IsRemoteVideoLessonsSelected}"
                                            Value="True">
                                            <Setter Property="BackgroundColor" Value="#FF2A2A2A" />
                                        </DataTrigger>
                                    </Border.Triggers>
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding RemoteViewVideoLessonsCommand}" />
                                    </Border.GestureRecognizers>
                                    <Grid ColumnDefinitions="Auto,*,Auto" Margin="18,0,0,0" VerticalOptions="Center" HorizontalOptions="Fill">
                                        <controls:SymbolIcon
                                            Grid.Column="0"
                                            Margin="4,0,0,0"
                                            HeightRequest="{StaticResource IconSizeSidebarMenu}"
                                            SymbolName="video"
                                            TintColor="White"
                                            VerticalOptions="Center"
                                            WidthRequest="{StaticResource IconSizeSidebarMenu}" />
                                        <Label
                                            Grid.Column="1"
                                            Margin="8,0,0,0"
                                            Style="{StaticResource SidebarMenuItemLabel}"
                                            Text="Videolecciones" />
                                        <Label
                                            Grid.Column="2"
                                            Margin="0,0,8,0"
                                            FontFamily="{StaticResource AppFontMono}"
                                            FontSize="{StaticResource FontSizeSmall}"
                                            HorizontalOptions="End"
                                            HorizontalTextAlignment="End"
                                            Text="{Binding RemoteVideoLessonsCount}"
                                            TextColor="#FF888888"
                                            VerticalOptions="Center" />
                                    </Grid>
                                </Border>

                                <Border
                                    x:Name="RemoteTrashHeaderBorder"
                                    Style="{StaticResource SidebarMenuItemBorder}">
                                    <Border.Padding>
                                        <OnPlatform x:TypeArguments="Thickness">
                                            <On Platform="iOS" Value="10,8,4,8" />
                                            <On Platform="Default" Value="10,6,4,6" />
                                        </OnPlatform>
                                    </Border.Padding>
                                    <Border.Behaviors>
                                        <behaviors:SidebarHoverBehavior />
                                    </Border.Behaviors>
                                    <Border.Triggers>
                                        <DataTrigger
                                            TargetType="Border"
                                            Binding="{Binding IsRemoteTrashSelected}"
                                            Value="True">
                                            <Setter Property="BackgroundColor" Value="#FF2A2A2A" />
                                        </DataTrigger>
                                    </Border.Triggers>
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding RemoteViewTrashCommand}" />
                                    </Border.GestureRecognizers>
                                    <Grid ColumnDefinitions="Auto,*,Auto" Margin="18,0,0,0" VerticalOptions="Center" HorizontalOptions="Fill">
                                        <controls:SymbolIcon
                                            Grid.Column="0"
                                            Margin="4,0,0,0"
                                            HeightRequest="{StaticResource IconSizeSidebarMenu}"
                                            SymbolName="trash"
                                            TintColor="White"
                                            VerticalOptions="Center"
                                            WidthRequest="{StaticResource IconSizeSidebarMenu}" />
                                        <Label
                                            Grid.Column="1"
                                            Margin="8,0,0,0"
                                            Style="{StaticResource SidebarMenuItemLabel}"
                                            Text="Papelera" />
                                        <Label
                                            Grid.Column="2"
                                            Margin="0,0,8,0"
                                            FontFamily="{StaticResource AppFontMono}"
                                            FontSize="{StaticResource FontSizeSmall}"
                                            HorizontalOptions="End"
                                            HorizontalTextAlignment="End"
                                            Text="{Binding RemoteTrashItemCount}"
                                            TextColor="#FF888888"
                                            VerticalOptions="Center" />
                                    </Grid>
                                </Border>

                                <Border
                                    x:Name="RemoteSmartFoldersHeaderBorder"
                                    Style="{StaticResource SidebarMenuItemBorder}">
                                    <Border.Padding>
                                        <OnPlatform x:TypeArguments="Thickness">
                                            <On Platform="iOS" Value="10,8,4,8" />
                                            <On Platform="Default" Value="10,6,4,6" />
                                        </OnPlatform>
                                    </Border.Padding>
                                    <Border.Behaviors>
                                        <behaviors:SidebarHoverBehavior />
                                    </Border.Behaviors>
                                    <Grid ColumnDefinitions="Auto,Auto,*,Auto" VerticalOptions="Center" HorizontalOptions="Fill">
                                        <Border
                                            Grid.Column="0"
                                            Padding="2"
                                            BackgroundColor="Transparent"
                                            StrokeThickness="0">
                                            <Border.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding ToggleRemoteSmartFoldersExpandedCommand}" />
                                            </Border.GestureRecognizers>
                                            <controls:SymbolIcon
                                                HeightRequest="{StaticResource IconSizeSmall}"
                                                WidthRequest="{StaticResource IconSizeSmall}"
                                                TintColor="#FF888888"
                                                VerticalOptions="Center">
                                                <controls:SymbolIcon.Triggers>
                                                    <DataTrigger TargetType="controls:SymbolIcon" Binding="{Binding IsRemoteSmartFoldersExpanded}" Value="True">
                                                        <Setter Property="SymbolName" Value="chevron.down" />
                                                    </DataTrigger>
                                                    <DataTrigger TargetType="controls:SymbolIcon" Binding="{Binding IsRemoteSmartFoldersExpanded}" Value="False">
                                                        <Setter Property="SymbolName" Value="chevron.right" />
                                                    </DataTrigger>
                                                </controls:SymbolIcon.Triggers>
                                            </controls:SymbolIcon>
                                        </Border>
                                        <controls:SymbolIcon
                                            Grid.Column="1"
                                            Margin="4,0,0,0"
                                            HeightRequest="{StaticResource IconSizeSidebarMenu}"
                                            SymbolName="folder"
                                            TintColor="White"
                                            VerticalOptions="Center"
                                            WidthRequest="{StaticResource IconSizeSidebarMenu}" />
                                        <Label
                                            Grid.Column="2"
                                            Margin="8,0,0,0"
                                            Style="{StaticResource SidebarMenuItemLabel}"
                                            Text="Carpeta inteligente" />
                                    </Grid>
                                </Border>

                                <VerticalStackLayout
                                    Spacing="{StaticResource SpacingXSmall}"
                                    HorizontalOptions="Fill"
                                    IsVisible="{Binding IsRemoteSmartFoldersExpanded}"
                                    BindableLayout.ItemsSource="{Binding RemoteSmartFolders}">
                                    <VerticalStackLayout.Margin>
                                        <OnPlatform x:TypeArguments="Thickness">
                                            <On Platform="iOS" Value="0,0,0,2" />
                                            <On Platform="Default" Value="0,0,0,6" />
                                        </OnPlatform>
                                    </VerticalStackLayout.Margin>
                                    <BindableLayout.ItemTemplate>
                                        <DataTemplate x:DataType="models:SmartFolderDefinition">
                                            <Border Style="{StaticResource SidebarMenuSubItemBorder}">
                                                <Border.Behaviors>
                                                    <behaviors:SidebarHoverBehavior />
                                                </Border.Behaviors>
                                                <Grid ColumnDefinitions="Auto,*,Auto" VerticalOptions="Center" HorizontalOptions="Fill">
                                                    <controls:SymbolIcon
                                                        Grid.Column="0"
                                                        HeightRequest="{StaticResource IconSizeSidebarMenu}"
                                                        WidthRequest="{StaticResource IconSizeSidebarMenu}"
                                                        SymbolName="{Binding Icon}"
                                                        TintColor="{Binding IconColor, Converter={StaticResource HexStringToColorConverter}}"
                                                        VerticalOptions="Center" />
                                                    <Label
                                                        Grid.Column="1"
                                                        Margin="8,0,0,0"
                                                        Style="{StaticResource SidebarMenuSubItemLabel}"
                                                        Text="{Binding Name}" />
                                                    <Label
                                                        Grid.Column="2"
                                                        Margin="0,0,8,0"
                                                        FontFamily="{StaticResource AppFontMono}"
                                                        FontSize="{StaticResource FontSizeSmall}"
                                                        HorizontalOptions="End"
                                                        HorizontalTextAlignment="End"
                                                        TextColor="#FF888888"
                                                        Text="{Binding MatchingVideoCount}"
                                                        VerticalOptions="Center" />
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </BindableLayout.ItemTemplate>
                                </VerticalStackLayout>

                            </VerticalStackLayout>
                        </VerticalStackLayout>

                        <!--  Separador entre Equipo y Mi biblioteca  -->
                        <BoxView
                            Margin="0,12,0,6"
                            BackgroundColor="#FF2A2A2A"
                            HeightRequest="1"
                            HorizontalOptions="Fill" />

                        <!--  Barra de sincronización cloud  -->
                        <Border
                            x:Name="SyncStatusBar"
                            Margin="0,0,0,8"
                            Padding="10,8"
                            BackgroundColor="#FF1E1E1E"
                            Stroke="#FF333333"
                            StrokeShape="RoundRectangle 8"
                            StrokeThickness="1">
                            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="10">
                                <!--  Icono de cloud  -->
                                <controls:SymbolIcon
                                    Grid.Column="0"
                                    HeightRequest="{StaticResource IconSizeMedium}"
                                    WidthRequest="{StaticResource IconSizeMedium}"
                                    SymbolName="icloud.and.arrow.up"
                                    TintColor="{Binding SyncStatusColor, FallbackValue='#9E9E9E'}"
                                    VerticalOptions="Center" />

                                <!--  Texto de estado  -->
                                <VerticalStackLayout Grid.Column="1" VerticalOptions="Center" Spacing="2">
                                    <Label
                                        FontSize="{StaticResource FontSizeSmall}"
                                        Text="{Binding SyncStatusText, FallbackValue='Sincronización'}"
                                        TextColor="White"
                                        IsVisible="{Binding IsSyncing, Converter={StaticResource InvertedBoolConverter}}" />
                                    <Label
                                        FontSize="{StaticResource FontSizeSmall}"
                                        Text="{Binding SyncStatusText}"
                                        TextColor="#4CAF50"
                                        IsVisible="{Binding IsSyncing}" />
                                    <Label
                                        FontSize="{StaticResource FontSizeCaption}"
                                        TextColor="#888888"
                                        IsVisible="{Binding HasPendingSync}">
                                        <Label.Text>
                                            <MultiBinding StringFormat="{}{0} videos pendientes">
                                                <Binding Path="PendingSyncCount" />
                                            </MultiBinding>
                                        </Label.Text>
                                    </Label>
                                    <!--  Barra de progreso durante sincronización  -->
                                    <ProgressBar
                                        HeightRequest="4"
                                        Progress="{Binding SyncProgress, Converter={StaticResource ProgressConverter}, ConverterParameter=100}"
                                        ProgressColor="#4CAF50"
                                        IsVisible="{Binding IsSyncing}" />
                                </VerticalStackLayout>

                                <!--  Botón de sincronización  -->
                                <Border
                                    Grid.Column="2"
                                    Padding="10,6"
                                    BackgroundColor="#FF0066"
                                    StrokeShape="RoundRectangle 6"
                                    StrokeThickness="0"
                                    IsVisible="{Binding IsSyncing, Converter={StaticResource InvertedBoolConverter}}">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding SyncAllCommand}" />
                                    </Border.GestureRecognizers>
                                    <HorizontalStackLayout Spacing="6">
                                        <controls:SymbolIcon
                                            HeightRequest="{StaticResource IconSizeSmall}"
                                            WidthRequest="{StaticResource IconSizeSmall}"
                                            SymbolName="arrow.triangle.2.circlepath"
                                            TintColor="White"
                                            VerticalOptions="Center" />
                                        <Label
                                            FontSize="{StaticResource FontSizeSmall}"
                                            Text="Sincronizar"
                                            TextColor="White"
                                            VerticalOptions="Center" />
                                    </HorizontalStackLayout>
                                </Border>

                                <!--  Indicador de progreso giratorio durante sincronización  -->
                                <ActivityIndicator
                                    Grid.Column="2"
                                    Color="#4CAF50"
                                    IsRunning="{Binding IsSyncing}"
                                    IsVisible="{Binding IsSyncing}"
                                    HeightRequest="24"
                                    WidthRequest="24" />
                            </Grid>
                        </Border>

                        <!--  Item padre: Mi biblioteca (colección del usuario con lectura/escritura)  -->
                        <Border
                            x:Name="UserLibraryHeaderBorder"
                            Style="{StaticResource SidebarMenuItemBorder}"
                            BackgroundColor="#FF0066"
                            Stroke="Transparent"
                            StrokeThickness="0"
                            StrokeShape="RoundRectangle 6">
                            <Border.Padding>
                                <OnPlatform x:TypeArguments="Thickness">
                                    <On Platform="iOS" Value="10,6,4,6" />
                                    <On Platform="Default" Value="10,10,4,10" />
                                </OnPlatform>
                            </Border.Padding>
                            <Grid ColumnDefinitions="*,Auto" VerticalOptions="Center" HorizontalOptions="Fill">
                                <!--  Contenido principal del item: abre menú contextual  -->
                                <Grid
                                    Grid.Column="0"
                                    ColumnDefinitions="Auto,*"
                                    VerticalOptions="Center"
                                    HorizontalOptions="Fill">
                                    <Grid.GestureRecognizers>
                                        <TapGestureRecognizer Buttons="Primary" Tapped="OnUserLibraryMenuTapped" />
                                        <TapGestureRecognizer Buttons="Secondary" Tapped="OnUserLibraryMenuTapped">
                                            <TapGestureRecognizer.NumberOfTapsRequired>
                                                <OnPlatform x:TypeArguments="x:Int32">
                                                    <On Platform="iOS" Value="99" />
                                                    <On Platform="MacCatalyst,WinUI" Value="1" />
                                                </OnPlatform>
                                            </TapGestureRecognizer.NumberOfTapsRequired>
                                        </TapGestureRecognizer>
                                    </Grid.GestureRecognizers>

                                    <controls:SymbolIcon
                                        Grid.Column="0"
                                        Margin="4,0,0,0"
                                        HeightRequest="{StaticResource IconSizeSidebarMenu}"
                                        WidthRequest="{StaticResource IconSizeSidebarMenu}"
                                        SymbolName="books.vertical"
                                        TintColor="White"
                                        VerticalOptions="Center" />
                                    <Label
                                        Grid.Column="1"
                                        Margin="8,0,0,0"
                                        FontFamily="{StaticResource AppFontEmphasis}"
                                        FontSize="{StaticResource FontSizeBody}"
                                        FontAttributes="Bold"
                                        Text="Mi biblioteca"
                                        TextColor="White"
                                        VerticalOptions="Center" />
                                </Grid>

                                <!--  Icono selector a la derecha  -->
                                <Border
                                    Grid.Column="1"
                                    Padding="2"
                                    Margin="0,0,8,0"
                                    BackgroundColor="Transparent"
                                    StrokeThickness="0">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Buttons="Primary" Tapped="OnUserLibraryMenuTapped" />
                                        <TapGestureRecognizer Buttons="Secondary" Tapped="OnUserLibraryMenuTapped">
                                            <TapGestureRecognizer.NumberOfTapsRequired>
                                                <OnPlatform x:TypeArguments="x:Int32">
                                                    <On Platform="iOS" Value="99" />
                                                    <On Platform="MacCatalyst,WinUI" Value="1" />
                                                </OnPlatform>
                                            </TapGestureRecognizer.NumberOfTapsRequired>
                                        </TapGestureRecognizer>
                                    </Border.GestureRecognizers>
                                    <controls:SymbolIcon
                                        HeightRequest="{StaticResource IconSizeSmall}"
                                        WidthRequest="{StaticResource IconSizeSmall}"
                                        SymbolName="chevron.up.chevron.down"
                                        TintColor="White"
                                        VerticalOptions="Center" />
                                </Border>
                            </Grid>
                        </Border>

                        <VerticalStackLayout
                            x:Name="UserLibraryItemsContainer"
                            HorizontalOptions="Fill"
                            IsVisible="{Binding IsUserLibraryExpanded}">
                            <VerticalStackLayout.Spacing>
                                <OnPlatform x:TypeArguments="x:Double">
                                    <On Platform="iOS" Value="6" />
                                    <On Platform="Default" Value="{StaticResource SpacingXSmall}" />
                                </OnPlatform>
                            </VerticalStackLayout.Spacing>

                        <Border
                            x:Name="AllGalleryHeaderBorder"
                            Style="{StaticResource SidebarMenuItemBorder}">
                            <Border.Padding>
                                <OnPlatform x:TypeArguments="Thickness">
                                    <On Platform="iOS" Value="10,8,4,8" />
                                    <On Platform="Default" Value="10,6,4,6" />
                                </OnPlatform>
                            </Border.Padding>
                            <Border.Behaviors>
                                <behaviors:SidebarHoverBehavior />
                            </Border.Behaviors>
                            <Border.Triggers>
                                <DataTrigger
                                    TargetType="Border"
                                    Binding="{Binding IsAllGallerySelected}"
                                    Value="True">
                                    <Setter Property="BackgroundColor" Value="#FF2A2A2A" />
                                </DataTrigger>
                            </Border.Triggers>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding SelectAllGalleryCommand}" Tapped="OnAllGalleryTapped" />
                            </Border.GestureRecognizers>
                            <Grid ColumnDefinitions="Auto,*,Auto" Margin="18,0,0,0" VerticalOptions="Center" HorizontalOptions="Fill">
                                <controls:SymbolIcon
                                    Grid.Column="0"
                                    Margin="4,0,0,0"
                                    HeightRequest="{StaticResource IconSizeSidebarMenu}"
                                    SymbolName="photo.on.rectangle.angled"
                                    TintColor="White"
                                    VerticalOptions="Center"
                                    WidthRequest="{StaticResource IconSizeSidebarMenu}" />
                                <Label
                                    Grid.Column="1"
                                    Margin="8,0,0,0"
                                    Style="{StaticResource SidebarMenuItemLabel}"
                                    Text="Galería General" />
                                <Label
                                    Grid.Column="2"
                                    Margin="0,0,8,0"
                                    FontFamily="{StaticResource AppFontMono}"
                                    FontSize="{StaticResource FontSizeSmall}"
                                    HorizontalOptions="End"
                                    HorizontalTextAlignment="End"
                                    Text="{Binding AllGalleryItemCount}"
                                    TextColor="#FF888888"
                                    VerticalOptions="Center" />
                            </Grid>
                        </Border>

                        <Border
                            x:Name="VideoLessonsHeaderBorder"
                            Style="{StaticResource SidebarMenuItemBorder}">
                            <Border.Padding>
                                <OnPlatform x:TypeArguments="Thickness">
                                    <On Platform="iOS" Value="10,8,4,8" />
                                    <On Platform="Default" Value="10,6,4,6" />
                                </OnPlatform>
                            </Border.Padding>
                            <Border.Behaviors>
                                <behaviors:SidebarHoverBehavior />
                            </Border.Behaviors>
                            <Border.Triggers>
                                <DataTrigger
                                    TargetType="Border"
                                    Binding="{Binding IsVideoLessonsSelected}"
                                    Value="True">
                                    <Setter Property="BackgroundColor" Value="#FF2A2A2A" />
                                </DataTrigger>
                            </Border.Triggers>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ViewVideoLessonsCommand}" Tapped="OnVideoLessonsTapped" />
                            </Border.GestureRecognizers>
                            <Grid ColumnDefinitions="Auto,*,Auto" Margin="18,0,0,0" VerticalOptions="Center" HorizontalOptions="Fill">
                                <controls:SymbolIcon
                                    Grid.Column="0"
                                    Margin="4,0,0,0"
                                    HeightRequest="{StaticResource IconSizeSidebarMenu}"
                                    SymbolName="video"
                                    TintColor="White"
                                    VerticalOptions="Center"
                                    WidthRequest="{StaticResource IconSizeSidebarMenu}" />
                                <Label
                                    Grid.Column="1"
                                    Margin="8,0,0,0"
                                    Style="{StaticResource SidebarMenuItemLabel}"
                                    Text="Videolecciones" />
                                <Label
                                    Grid.Column="2"
                                    Margin="0,0,8,0"
                                    FontFamily="{StaticResource AppFontMono}"
                                    FontSize="{StaticResource FontSizeSmall}"
                                    HorizontalOptions="End"
                                    HorizontalTextAlignment="End"
                                    Text="{Binding VideoLessonsCount}"
                                    TextColor="#FF888888"
                                    VerticalOptions="Center" />
                            </Grid>
                        </Border>

                        <Border
                            x:Name="TrashHeaderBorder"
                            Style="{StaticResource SidebarMenuItemBorder}">
                            <Border.Padding>
                                <OnPlatform x:TypeArguments="Thickness">
                                    <On Platform="iOS" Value="10,8,4,8" />
                                    <On Platform="Default" Value="10,6,4,6" />
                                </OnPlatform>
                            </Border.Padding>
                            <Border.Behaviors>
                                <behaviors:SidebarHoverBehavior />
                            </Border.Behaviors>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ViewTrashCommand}" Tapped="OnTrashTapped" />
                            </Border.GestureRecognizers>
                            <Grid ColumnDefinitions="Auto,*,Auto" Margin="18,0,0,0" VerticalOptions="Center" HorizontalOptions="Fill">
                                <controls:SymbolIcon
                                    Grid.Column="0"
                                    Margin="4,0,0,0"
                                    HeightRequest="{StaticResource IconSizeSidebarMenu}"
                                    SymbolName="trash"
                                    TintColor="White"
                                    VerticalOptions="Center"
                                    WidthRequest="{StaticResource IconSizeSidebarMenu}" />
                                <Label
                                    Grid.Column="1"
                                    Margin="8,0,0,0"
                                    Style="{StaticResource SidebarMenuItemLabel}"
                                    Text="Papelera" />
                                <Label
                                    Grid.Column="2"
                                    Margin="0,0,8,0"
                                    FontFamily="{StaticResource AppFontMono}"
                                    FontSize="{StaticResource FontSizeSmall}"
                                    HorizontalOptions="End"
                                    HorizontalTextAlignment="End"
                                    Text="{Binding TrashItemCount}"
                                    TextColor="#FF888888"
                                    VerticalOptions="Center" />
                            </Grid>
                        </Border>

                        <!--  Carpetas inteligentes  -->
                        <Border
                            x:Name="SmartFoldersHeaderBorder"
                            Style="{StaticResource SidebarMenuItemBorder}">
                            <Border.Padding>
                                <OnPlatform x:TypeArguments="Thickness">
                                    <On Platform="iOS" Value="10,8,4,8" />
                                    <On Platform="Default" Value="10,6,4,6" />
                                </OnPlatform>
                            </Border.Padding>
                            <Border.Behaviors>
                                <behaviors:SidebarHoverBehavior />
                            </Border.Behaviors>
                            <Grid ColumnDefinitions="Auto,Auto,*,Auto,Auto" VerticalOptions="Center" HorizontalOptions="Fill">
                                <!-- Expansion toggle button -->
                                <Border
                                    Grid.Column="0"
                                    Padding="2"
                                    BackgroundColor="Transparent"
                                    StrokeThickness="0">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding ToggleSmartFoldersExpansionCommand}" Tapped="OnSmartFoldersToggleTapped" />
                                    </Border.GestureRecognizers>
                                    <controls:SymbolIcon
                                        HeightRequest="{StaticResource IconSizeSmall}"
                                        WidthRequest="{StaticResource IconSizeSmall}"
                                        TintColor="#FF888888"
                                        VerticalOptions="Center">
                                        <controls:SymbolIcon.Triggers>
                                            <DataTrigger TargetType="controls:SymbolIcon" Binding="{Binding IsSmartFoldersExpanded}" Value="True">
                                                <Setter Property="SymbolName" Value="chevron.down" />
                                            </DataTrigger>
                                            <DataTrigger TargetType="controls:SymbolIcon" Binding="{Binding IsSmartFoldersExpanded}" Value="False">
                                                <Setter Property="SymbolName" Value="chevron.right" />
                                            </DataTrigger>
                                        </controls:SymbolIcon.Triggers>
                                    </controls:SymbolIcon>
                                </Border>
                                <controls:SymbolIcon
                                    Grid.Column="1"
                                    Margin="4,0,0,0"
                                    HeightRequest="{StaticResource IconSizeSidebarMenu}"
                                    SymbolName="folder"
                                    TintColor="White"
                                    VerticalOptions="Center"
                                    WidthRequest="{StaticResource IconSizeSidebarMenu}" />
                                <Label
                                    Grid.Column="2"
                                    Margin="8,0,0,0"
                                    Style="{StaticResource SidebarMenuItemLabel}"
                                    Text="Carpeta inteligente" />
                                <!-- Add button - visible on hover via behavior -->
                                <Border
                                    x:Name="SmartFolderAddButton"
                                    Grid.Column="3"
                                    Margin="8,0,0,0"
                                    Padding="2"
                                    BackgroundColor="Transparent"
                                    Stroke="Transparent"
                                    StrokeShape="RoundRectangle 4"
                                    HorizontalOptions="End"
                                    VerticalOptions="Center">
                                    <Border.Opacity>
                                        <OnPlatform x:TypeArguments="x:Double">
                                            <On Platform="iOS" Value="1" />
                                            <On Platform="Default" Value="0" />
                                        </OnPlatform>
                                    </Border.Opacity>
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding OpenSmartFolderSidebarPopupCommand}" Tapped="OnAddSmartFolderTapped" />
                                    </Border.GestureRecognizers>
                                    <controls:SymbolIcon
                                        HeightRequest="{StaticResource IconSizeSmall}"
                                        SymbolName="plus"
                                        TintColor="#FF888888"
                                        WidthRequest="{StaticResource IconSizeSmall}" />
                                </Border>
                            </Grid>
                        </Border>

                        <VerticalStackLayout
                            Spacing="{StaticResource SpacingXSmall}"
                            HorizontalOptions="Fill"
                            IsVisible="{Binding IsSmartFoldersExpanded}"
                            BindableLayout.ItemsSource="{Binding SmartFolders}">
                            <VerticalStackLayout.Margin>
                                <OnPlatform x:TypeArguments="Thickness">
                                    <On Platform="iOS" Value="0,0,0,2" />
                                    <On Platform="Default" Value="0,0,0,6" />
                                </OnPlatform>
                            </VerticalStackLayout.Margin>
                            <BindableLayout.ItemTemplate>
                                <DataTemplate x:DataType="models:SmartFolderDefinition">
                                    <Border Style="{StaticResource SidebarMenuSubItemBorder}">
                                        <Border.Behaviors>
                                            <behaviors:SidebarHoverBehavior />
                                        </Border.Behaviors>
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer
                                                Buttons="Primary"
                                                Tapped="OnSmartFolderPrimaryTapped" />
                                            <TapGestureRecognizer
                                                Buttons="Secondary"
                                                Tapped="OnSmartFolderContextMenuTapped">
                                                <TapGestureRecognizer.NumberOfTapsRequired>
                                                    <OnPlatform x:TypeArguments="x:Int32">
                                                        <On Platform="iOS" Value="99" />
                                                        <On Platform="MacCatalyst,WinUI" Value="1" />
                                                    </OnPlatform>
                                                </TapGestureRecognizer.NumberOfTapsRequired>
                                            </TapGestureRecognizer>
                                        </Border.GestureRecognizers>
                                        <Grid ColumnDefinitions="Auto,*,Auto,Auto" VerticalOptions="Center" HorizontalOptions="Fill">
                                            <controls:SymbolIcon
                                                Grid.Column="0"
                                                HeightRequest="{StaticResource IconSizeSidebarMenu}"
                                                WidthRequest="{StaticResource IconSizeSidebarMenu}"
                                                SymbolName="{Binding Icon}"
                                                TintColor="{Binding IconColor, Converter={StaticResource HexStringToColorConverter}}"
                                                VerticalOptions="Center" />
                                            <Label
                                                Grid.Column="1"
                                                Margin="8,0,0,0"
                                                Style="{StaticResource SidebarMenuSubItemLabel}"
                                                Text="{Binding Name}" />
                                            <Label
                                                Grid.Column="2"
                                                Margin="0,0,8,0"
                                                FontFamily="{StaticResource AppFontMono}"
                                                FontSize="{StaticResource FontSizeSmall}"
                                                HorizontalOptions="End"
                                                HorizontalTextAlignment="End"
                                                TextColor="#FF888888"
                                                Text="{Binding MatchingVideoCount}"
                                                VerticalOptions="Center" />
                                            <Border
                                                ClassId="ContextMenuButton"
                                                Grid.Column="3"
                                                Margin="0,0,4,0"
                                                Padding="4"
                                                BackgroundColor="Transparent"
                                                StrokeThickness="0"
                                                HorizontalOptions="End"
                                                VerticalOptions="Center">
                                                <Border.IsVisible>
                                                    <OnPlatform x:TypeArguments="x:Boolean">
                                                        <On Platform="iOS" Value="True" />
                                                        <On Platform="Default" Value="False" />
                                                    </OnPlatform>
                                                </Border.IsVisible>
                                                <Border.GestureRecognizers>
                                                    <TapGestureRecognizer Tapped="OnSmartFolderContextMenuTapped" />
                                                </Border.GestureRecognizers>
                                                <controls:SymbolIcon
                                                    HeightRequest="{StaticResource IconSizeSmall}"
                                                    WidthRequest="{StaticResource IconSizeSmall}"
                                                    SymbolName="ellipsis.circle"
                                                    TintColor="#FF888888"
                                                    VerticalOptions="Center" />
                                            </Border>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </BindableLayout.ItemTemplate>
                        </VerticalStackLayout>

                        </VerticalStackLayout>
                        <!--  Cierra UserLibraryItemsContainer  -->

                        <!--  Diario Personal  -->
                        <Border
                            x:Name="DiaryHeaderBorder"
                            Style="{StaticResource SidebarMenuItemBorder}">
                            <Border.Padding>
                                <OnPlatform x:TypeArguments="Thickness">
                                    <On Platform="iOS" Value="10,8,4,8" />
                                    <On Platform="Default" Value="10,6,4,6" />
                                </OnPlatform>
                            </Border.Padding>
                            <Border.Behaviors>
                                <behaviors:SidebarHoverBehavior />
                            </Border.Behaviors>
                            <Border.Triggers>
                                <DataTrigger
                                    TargetType="Border"
                                    Binding="{Binding IsDiaryViewSelected}"
                                    Value="True">
                                    <Setter Property="BackgroundColor" Value="#FF2A2A2A" />
                                </DataTrigger>
                            </Border.Triggers>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ViewDiaryCommand}" Tapped="OnDiaryTapped" />
                            </Border.GestureRecognizers>
                            <Grid ColumnDefinitions="Auto,*" Margin="18,0,0,0" VerticalOptions="Center" HorizontalOptions="Fill">
                                <controls:SymbolIcon
                                    Grid.Column="0"
                                    Margin="4,0,0,0"
                                    HeightRequest="{StaticResource IconSizeSidebarMenu}"
                                    SymbolName="book"
                                    TintColor="White"
                                    VerticalOptions="Center"
                                    WidthRequest="{StaticResource IconSizeSidebarMenu}" />
                                <Label
                                    Grid.Column="1"
                                    Margin="8,0,0,0"
                                    Style="{StaticResource SidebarMenuItemLabel}"
                                    Text="Diario" />
                            </Grid>
                        </Border>

                        <!--  Item padre: Sesiones (expandible)  -->
                        <Border
                            x:Name="SessionsHeaderBorder"
                            Style="{StaticResource SidebarMenuItemBorder}">
                            <Border.Padding>
                                <OnPlatform x:TypeArguments="Thickness">
                                    <On Platform="iOS" Value="10,8,4,8" />
                                    <On Platform="Default" Value="10,6,4,6" />
                                </OnPlatform>
                            </Border.Padding>
                            <Border.Behaviors>
                                <behaviors:SidebarHoverBehavior />
                            </Border.Behaviors>
                            <Grid ColumnDefinitions="Auto,Auto,*,Auto,Auto" VerticalOptions="Center" HorizontalOptions="Fill">
                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer Buttons="Secondary" Tapped="OnSessionsMenuTapped">
                                        <TapGestureRecognizer.NumberOfTapsRequired>
                                            <OnPlatform x:TypeArguments="x:Int32">
                                                <On Platform="iOS" Value="99" />
                                                <On Platform="MacCatalyst,WinUI" Value="1" />
                                            </OnPlatform>
                                        </TapGestureRecognizer.NumberOfTapsRequired>
                                    </TapGestureRecognizer>
                                </Grid.GestureRecognizers>
                                <!-- Expansion toggle button (oculto en Windows por ahora) -->
                                <Border
                                    Grid.Column="0"
                                    Padding="2"
                                    BackgroundColor="Transparent"
                                    StrokeThickness="0">
                                    <Border.IsVisible>
                                        <OnPlatform x:TypeArguments="x:Boolean">
                                            <On Platform="WinUI" Value="False" />
                                            <On Platform="iOS,MacCatalyst,Android" Value="True" />
                                        </OnPlatform>
                                    </Border.IsVisible>
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding ToggleSessionsListExpandedCommand}" />
                                    </Border.GestureRecognizers>
                                    <controls:SymbolIcon
                                        HeightRequest="{StaticResource IconSizeSmall}"
                                        WidthRequest="{StaticResource IconSizeSmall}"
                                        TintColor="#FF888888"
                                        VerticalOptions="Center">
                                        <controls:SymbolIcon.Triggers>
                                            <DataTrigger TargetType="controls:SymbolIcon" Binding="{Binding IsSessionsListExpanded}" Value="True">
                                                <Setter Property="SymbolName" Value="chevron.down" />
                                            </DataTrigger>
                                            <DataTrigger TargetType="controls:SymbolIcon" Binding="{Binding IsSessionsListExpanded}" Value="False">
                                                <Setter Property="SymbolName" Value="chevron.right" />
                                            </DataTrigger>
                                        </controls:SymbolIcon.Triggers>
                                    </controls:SymbolIcon>
                                </Border>
                                <controls:SymbolIcon
                                    Grid.Column="1"
                                    Margin="4,0,0,0"
                                    HeightRequest="{StaticResource IconSizeSidebarMenu}"
                                    SymbolName="clock"
                                    TintColor="White"
                                    VerticalOptions="Center"
                                    WidthRequest="{StaticResource IconSizeSidebarMenu}" />
                                <Label
                                    Grid.Column="2"
                                    Margin="8,0,0,0"
                                    Style="{StaticResource SidebarMenuItemLabel}"
                                    Text="Sesiones" />
                                <!-- Add button - visible on hover via behavior -->
                                <Border
                                    x:Name="SessionsImportAddButton"
                                    Grid.Column="3"
                                    Margin="8,0,0,0"
                                    Padding="2"
                                    BackgroundColor="Transparent"
                                    Stroke="Transparent"
                                    StrokeShape="RoundRectangle 4"
                                    HorizontalOptions="End"
                                    VerticalOptions="Center">
                                    <Border.Opacity>
                                        <OnPlatform x:TypeArguments="x:Double">
                                            <On Platform="iOS" Value="1" />
                                            <On Platform="Default" Value="0" />
                                        </OnPlatform>
                                    </Border.Opacity>
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Buttons="Primary" Tapped="OnSessionsMenuTapped" />
                                        <TapGestureRecognizer Buttons="Secondary" Tapped="OnSessionsMenuTapped">
                                            <TapGestureRecognizer.NumberOfTapsRequired>
                                                <OnPlatform x:TypeArguments="x:Int32">
                                                    <On Platform="iOS" Value="99" />
                                                    <On Platform="MacCatalyst,WinUI" Value="1" />
                                                </OnPlatform>
                                            </TapGestureRecognizer.NumberOfTapsRequired>
                                        </TapGestureRecognizer>
                                    </Border.GestureRecognizers>
                                    <controls:SymbolIcon
                                        HeightRequest="{StaticResource IconSizeSmall}"
                                        SymbolName="plus"
                                        TintColor="#FF888888"
                                        WidthRequest="{StaticResource IconSizeSmall}" />
                                </Border>
                            </Grid>
                        </Border>

                        <!--  Item de sesión en importación (con barra de progreso)  -->
                        <Border
                            x:Name="ImportingSessionBorder"
                            Margin="0,4,0,0"
                            Padding="0"
                            BackgroundColor="#FF1A1A1A"
                            Stroke="#FF0066"
                            StrokeThickness="1"
                            StrokeShape="RoundRectangle 6"
                            IsVisible="{Binding IsBackgroundImporting}">
                            <Grid RowDefinitions="Auto,4">
                                <!--  Contenido del item  -->
                                <HorizontalStackLayout
                                    Grid.Row="0"
                                    Padding="16,10"
                                    Spacing="8"
                                    VerticalOptions="Center">
                                    <ActivityIndicator
                                        HeightRequest="18"
                                        WidthRequest="18"
                                        IsRunning="True"
                                        Color="#FF0066" />
                                    <VerticalStackLayout Spacing="2" VerticalOptions="Center">
                                        <Label
                                            FontFamily="{StaticResource AppFontBody}"
                                            FontSize="13"
                                            Text="{Binding ImportingSessionName}"
                                            TextColor="#FF0066"
                                            LineBreakMode="TailTruncation"
                                            MaximumWidthRequest="220" />
                                        <Label
                                            FontFamily="{StaticResource AppFontBody}"
                                            FontSize="10"
                                            Text="{Binding ImportingCurrentFile}"
                                            TextColor="#FF888888"
                                            LineBreakMode="TailTruncation"
                                            MaximumWidthRequest="220" />
                                    </VerticalStackLayout>
                                    <Label
                                        FontFamily="{StaticResource AppFontBody}"
                                        FontSize="11"
                                        FontAttributes="None"
                                        Text="{Binding BackgroundImportProgress, StringFormat='{0}%'}"
                                        TextColor="#FF0066"
                                        VerticalOptions="Center"
                                        HorizontalOptions="EndAndExpand" />
                                </HorizontalStackLayout>
                                <!--  Barra de progreso  -->
                                <ProgressBar
                                    Grid.Row="1"
                                    Margin="0"
                                    Progress="{Binding BackgroundImportProgressNormalized}"
                                    ProgressColor="#FF0066"
                                    BackgroundColor="#FF404040"
                                    HeightRequest="4" />
                            </Grid>
                        </Border>
            </VerticalStackLayout>

            <!--  CollectionView de sesiones (ahora en Row="1" para quedar debajo de los items fijos)  -->
            <CollectionView
                x:Name="SidebarSessionsCollectionView"
                Grid.Row="1"
                BackgroundColor="#00BBBABA"
                ItemsSource="{Binding SessionRows}"
                ItemTemplate="{StaticResource SessionsListRowTemplateSelector}"
                SelectionMode="None">

                <CollectionView.ItemsLayout>
                    <LinearItemsLayout Orientation="Vertical">
                        <LinearItemsLayout.ItemSpacing>
                            <OnPlatform x:TypeArguments="x:Double">
                                <On Platform="iOS" Value="2" />
                                <On Platform="Default" Value="{StaticResource SpacingXSmall}" />
                            </OnPlatform>
                        </LinearItemsLayout.ItemSpacing>
                    </LinearItemsLayout>
                </CollectionView.ItemsLayout>

                <CollectionView.EmptyView>
                    <VerticalStackLayout
                        Padding="40"
                        HorizontalOptions="Center"
                        VerticalOptions="Center">
                        <Label
                            FontSize="{StaticResource FontSizeTitle}"
                            HorizontalOptions="Center"
                            Text="No hay sesiones"
                            TextColor="Gray" />
                    </VerticalStackLayout>
                </CollectionView.EmptyView>
            </CollectionView>

            <!--  Acciones de sesión  -->
            <VerticalStackLayout Grid.Row="2" Spacing="{StaticResource SpacingSmall}" Margin="{StaticResource MarginVerticalSection}">
                
                <!--  Botón Nueva sesión (solo iOS)  -->
                <Border
                    Padding="{StaticResource PaddingActionButton}"
                    BackgroundColor="#FF404040"
                    Stroke="Transparent"
                    StrokeShape="RoundRectangle 4">
                    <Border.IsVisible>
                        <OnPlatform x:TypeArguments="x:Boolean">
                            <On Platform="iOS" Value="True" />
                            <On Platform="MacCatalyst,WinUI,Android" Value="False" />
                        </OnPlatform>
                    </Border.IsVisible>
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding OpenNewSessionSidebarPopupCommand}" />
                    </Border.GestureRecognizers>
                    <HorizontalStackLayout HorizontalOptions="Center" Spacing="6">
                        <controls:SymbolIcon
                            HeightRequest="{StaticResource IconSizeMedium}"
                            SymbolName="video.badge.plus"
                            TintColor="White"
                            WidthRequest="{StaticResource IconSizeMedium}"
                            VerticalOptions="Center" />
                        <Label Text="Nueva sesión" TextColor="White" VerticalOptions="Center" />
                    </HorizontalStackLayout>
                </Border>
                
                <!--  Botón Exportar sesión (solo iOS)  -->
                <Border
                    Padding="{StaticResource PaddingActionButton}"
                    BackgroundColor="#FF404040"
                    Stroke="Transparent"
                    StrokeShape="RoundRectangle 4">
                    <Border.IsVisible>
                        <OnPlatform x:TypeArguments="x:Boolean">
                            <On Platform="iOS" Value="True" />
                            <On Platform="MacCatalyst,WinUI,Android" Value="False" />
                        </OnPlatform>
                    </Border.IsVisible>
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding ExportSelectedSessionCommand}" />
                    </Border.GestureRecognizers>
                    <HorizontalStackLayout HorizontalOptions="Center" Spacing="6">
                        <controls:SymbolIcon
                            HeightRequest="{StaticResource IconSizeMedium}"
                            SymbolName="square.and.arrow.up"
                            TintColor="#FF0066"
                            WidthRequest="{StaticResource IconSizeMedium}"
                            VerticalOptions="Center" />
                        <Label Text="Exportar" TextColor="#FF0066" VerticalOptions="Center" />
                    </HorizontalStackLayout>
                </Border>
            </VerticalStackLayout>
        </Grid>

        <!--  Panel derecho: vídeos de la sesión seleccionada  -->
        <Grid
            Grid.Row="1"
            Grid.Column="2"
            Padding="20"
            RowDefinitions="Auto,Auto,*">
            
            <!--  Header con título y botón Grabar  -->
            <Grid Grid.Row="0" ColumnDefinitions="*,Auto">
                <Label
                    Grid.Column="0"
                    FontSize="{StaticResource FontSizeTitle}"
                    LineBreakMode="TailTruncation"
                    Text="{Binding SelectedSessionTitle}"
                    TextColor="White"
                    VerticalOptions="Center" />
                
                <!--  Botón Grabar (solo iOS, solo cuando hay sesión seleccionada)  -->
                <Border
                    Grid.Column="1"
                    Padding="12,8"
                    BackgroundColor="#FFFF3B30"
                    Stroke="Transparent"
                    StrokeShape="RoundRectangle 4"
                    IsVisible="{Binding CanShowRecordButton}">
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding RecordForSelectedSessionCommand}" />
                    </Border.GestureRecognizers>
                    <HorizontalStackLayout Spacing="6">
                        <controls:SymbolIcon
                            HeightRequest="{StaticResource IconSizeMedium}"
                            SymbolName="video.fill"
                            TintColor="White"
                            WidthRequest="{StaticResource IconSizeMedium}"
                            VerticalOptions="Center" />
                        <Label 
                            Text="Grabar" 
                            TextColor="White" 
                            FontAttributes="None" 
                            FontSize="{StaticResource FontSizeBody}"
                            VerticalOptions="Center" />
                    </HorizontalStackLayout>
                </Border>
            </Grid>

            <HorizontalStackLayout
                Grid.Row="1"
                Spacing="10"
                VerticalOptions="Center">
                <Label
                    FontSize="{StaticResource FontSizeBody}"
                    Text="{Binding VideoCountDisplayText}"
                    TextColor="#FFCCCCCC" />
                <ActivityIndicator
                    HeightRequest="16"
                    IsRunning="{Binding IsLoadingSelectedSessionVideos}"
                    IsVisible="{Binding IsLoadingSelectedSessionVideos}"
                    WidthRequest="16"
                    Color="White" />
            </HorizontalStackLayout>

            <CollectionView
                x:Name="VideoGallery"
                Grid.Row="2"
                ItemsSource="{Binding SelectedSessionVideos}"
                IsVisible="{Binding ShowVideoGallery}"
                RemainingItemsThreshold="{OnPlatform MacCatalyst=50, WinUI=10, iOS=10, Default=10}"
                RemainingItemsThresholdReachedCommand="{Binding LoadMoreVideosCommand}"
                SelectionMode="None" 
                Margin="{StaticResource MarginTopSmall}"
                ItemSizingStrategy="MeasureFirstItem"
                ItemsUpdatingScrollMode="KeepScrollOffset"
                Scrolled="OnVideoGalleryScrolled">
                <CollectionView.ItemsLayout>
                    <GridItemsLayout
                        HorizontalItemSpacing="{StaticResource SpacingLarge}"
                        Orientation="Vertical"
                        Span="{Binding VideoGalleryColumnSpan}"
                        VerticalItemSpacing="50" />
                </CollectionView.ItemsLayout>

                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:VideoClip">
                        <Grid RowDefinitions="Auto,Auto,Auto,Auto" RowSpacing="4">
                            <!--  Fila 0: Thumbnail con Border  -->
                            <Border
                                Grid.Row="0"
                                BackgroundColor="Transparent"
                                Stroke="Transparent"
                                StrokeShape="RoundRectangle 10"
                                StrokeThickness="0">
                                <Border.Behaviors>
                                    <!-- HoverBackgroundBehavior solo activo en Windows (código protegido con #if WINDOWS) -->
                                    <behaviors:HoverBackgroundBehavior />
                                </Border.Behaviors>
                                <Border.GestureRecognizers>
                                    <!-- iOS: clic simple abre reproductor. MacCatalyst/Windows: doble clic -->
                                    <TapGestureRecognizer Command="{Binding Source={x:Reference ThisPage}, Path=BindingContext.VideoTapCommand}" CommandParameter="{Binding .}">
                                        <TapGestureRecognizer.NumberOfTapsRequired>
                                            <OnPlatform x:TypeArguments="x:Int32">
                                                <On Platform="iOS" Value="1" />
                                                <On Platform="MacCatalyst" Value="2" />
                                                <On Platform="WinUI" Value="2" />
                                            </OnPlatform>
                                        </TapGestureRecognizer.NumberOfTapsRequired>
                                    </TapGestureRecognizer>
                                    <!-- MacCatalyst/Windows: clic simple selecciona (deshabilitado en iOS con 99 taps) -->
                                    <TapGestureRecognizer Tapped="OnVideoItemSingleTapped">
                                        <TapGestureRecognizer.NumberOfTapsRequired>
                                            <OnPlatform x:TypeArguments="x:Int32">
                                                <On Platform="iOS" Value="99" />
                                                <On Platform="MacCatalyst" Value="1" />
                                                <On Platform="WinUI" Value="1" />
                                            </OnPlatform>
                                        </TapGestureRecognizer.NumberOfTapsRequired>
                                    </TapGestureRecognizer>
                                    <TapGestureRecognizer Buttons="Secondary" Tapped="OnVideoItemContextMenuTapped">
                                        <TapGestureRecognizer.NumberOfTapsRequired>
                                            <OnPlatform x:TypeArguments="x:Int32">
                                                <On Platform="iOS" Value="99" />
                                                <On Platform="MacCatalyst,WinUI" Value="1" />
                                            </OnPlatform>
                                        </TapGestureRecognizer.NumberOfTapsRequired>
                                    </TapGestureRecognizer>
                                    <DragGestureRecognizer CanDrag="True" DragStarting="OnDragStarting" />
                                </Border.GestureRecognizers>
                                <Border.Triggers>
                                    <DataTrigger TargetType="Border" Binding="{Binding IsSelected}" Value="True">
                                        <Setter Property="Stroke" Value="#FF0066" />
                                        <Setter Property="StrokeThickness" Value="2" />
                                    </DataTrigger>
                                </Border.Triggers>
                                
                                <controls:AspectRatioContainer AspectRatio="1.777" MinimumHeightRequest="100">
                                    <Grid>
                                        <!--  Behavior de long press para preview en iOS  -->
                                        <Grid.Behaviors>
                                            <!-- LongPressVideoPreviewBehavior solo activo en iOS (código protegido con #if IOS) -->
                                            <behaviors:LongPressVideoPreviewBehavior />
                                        </Grid.Behaviors>
                                        <Image
                                            Aspect="AspectFill"
                                            BackgroundColor="{StaticResource Gray300}"
                                            Source="{Binding EffectiveThumbnailPath}" />

                                        <!--  Overlay de play (oculto cuando está seleccionado en multiselect)  -->
                                        <controls:SymbolIcon
                                            HeightRequest="{StaticResource IconSizeXXLarge}"
                                            SymbolName="play.circle.fill"
                                            TintColor="White"
                                            Opacity="0.5"
                                            VerticalOptions="Center"
                                            WidthRequest="{StaticResource IconSizeXXLarge}">
                                            <controls:SymbolIcon.IsVisible>
                                                <OnPlatform x:TypeArguments="x:Boolean">
                                                    <On Platform="MacCatalyst" Value="False" />
                                                    <On Platform="Default" Value="True" />
                                                </OnPlatform>
                                            </controls:SymbolIcon.IsVisible>
                                        </controls:SymbolIcon>

                                        <!--  Checkmark de selección  -->
                                        <Border
                                            BackgroundColor="#34000000"
                                            HeightRequest="32"
                                            HorizontalOptions="End"
                                            Margin="6"
                                            StrokeShape="RoundRectangle 16"
                                            VerticalOptions="Start"
                                            WidthRequest="32">
                                            <Border.IsVisible>
                                                <MultiBinding Converter="{StaticResource AllTrueConverter}">
                                                    <Binding Path="IsSelected" />
                                                    <Binding>
                                                        <Binding.Source>
                                                            <OnPlatform x:TypeArguments="x:Boolean">
                                                                <On Platform="MacCatalyst" Value="False" />
                                                                <On Platform="Default" Value="True" />
                                                            </OnPlatform>
                                                        </Binding.Source>
                                                    </Binding>
                                                </MultiBinding>
                                            </Border.IsVisible>
                                            <controls:SymbolIcon
                                                HeightRequest="{StaticResource IconSizeLarge}"
                                                HorizontalOptions="Center"
                                                SymbolName="checkmark"
                                                TintColor="LightGray"
                                                VerticalOptions="Center"
                                                WidthRequest="{StaticResource IconSizeLarge}" />
                                        </Border>
                                        
                                        <!--  Indicador de video comparativo  -->
                                        <Border
                                            BackgroundColor="#CC000000"
                                            HeightRequest="28"
                                            HorizontalOptions="Start"
                                            Margin="6"
                                            Padding="6,4"
                                            StrokeShape="RoundRectangle 4"
                                            StrokeThickness="0"
                                            VerticalOptions="Start">
                                            <Border.IsVisible>
                                                <MultiBinding Converter="{StaticResource AllTrueConverter}">
                                                    <Binding Path="IsComparisonVideo" />
                                                    <Binding>
                                                        <Binding.Source>
                                                            <OnPlatform x:TypeArguments="x:Boolean">
                                                                <On Platform="MacCatalyst" Value="False" />
                                                                <On Platform="Default" Value="True" />
                                                            </OnPlatform>
                                                        </Binding.Source>
                                                    </Binding>
                                                </MultiBinding>
                                            </Border.IsVisible>
                                            <HorizontalStackLayout Spacing="4">
                                                <controls:SymbolIcon
                                                    HeightRequest="{StaticResource IconSizeMedium}"
                                                    SymbolName="rectangle.on.rectangle"
                                                    TintColor="#FF0066"
                                                    VerticalOptions="Center"
                                                    WidthRequest="{StaticResource IconSizeMedium}" />
                                                <Label
                                                    FontSize="{StaticResource FontSizeCaption}"
                                                    Text="VS"
                                                    TextColor="#FF0066"
                                                    VerticalOptions="Center"
                                                    FontAttributes="None" />
                                            </HorizontalStackLayout>
                                        </Border>

                                        <!--  Indicador de tiempo/split  -->
                                        <Border
                                            BackgroundColor="#CC000000"
                                            HeightRequest="28"
                                            HorizontalOptions="Start"
                                            Margin="6"
                                            Padding="6,4"
                                            StrokeShape="RoundRectangle 4"
                                            StrokeThickness="0"
                                            VerticalOptions="End">
                                            <Border.IsVisible>
                                                <MultiBinding Converter="{StaticResource AllTrueConverter}">
                                                    <Binding Path="HasTiming" />
                                                    <Binding>
                                                        <Binding.Source>
                                                            <OnPlatform x:TypeArguments="x:Boolean">
                                                                <On Platform="MacCatalyst" Value="False" />
                                                                <On Platform="Default" Value="True" />
                                                            </OnPlatform>
                                                        </Binding.Source>
                                                    </Binding>
                                                </MultiBinding>
                                            </Border.IsVisible>
                                            <controls:SymbolIcon
                                                HeightRequest="{StaticResource IconSizeMedium}"
                                                SymbolName="timer"
                                                TintColor="White"
                                                VerticalOptions="Center"
                                                WidthRequest="{StaticResource IconSizeMedium}" />
                                        </Border>

                                        <!--  Indicador de sincronización cloud  -->
                                        <Border
                                            BackgroundColor="{Binding SyncStatusColor}"
                                            HeightRequest="24"
                                            HorizontalOptions="End"
                                            Margin="6"
                                            Padding="6,2"
                                            StrokeShape="RoundRectangle 12"
                                            StrokeThickness="0"
                                            VerticalOptions="End">
                                            <Label
                                                FontSize="11"
                                                Text="{Binding SyncStatusIcon}"
                                                TextColor="White"
                                                VerticalOptions="Center" />
                                        </Border>
                                    </Grid>
                                </controls:AspectRatioContainer>
                            </Border>
                            
                            <!--  Fila 1: Nombre del atleta  -->
                            <Label
                                Grid.Row="1"
                                FontSize="{StaticResource FontSizeSubtitle}"
                                FontAttributes="Bold"
                                HorizontalTextAlignment="Center"
                                LineBreakMode="TailTruncation"
                                Text="{Binding DisplayLine1}"
                                TextColor="White" />
                            
                            <!--  Fila 2: Lugar, fecha y hora  -->
                            <Label
                                Grid.Row="2"
                                FontSize="{StaticResource FontSizeBody}"
                                HorizontalTextAlignment="Center"
                                LineBreakMode="TailTruncation"
                                Text="{Binding DisplayLine2}"
                                TextColor="White" />
                            
                            <!--  Fila 3: Etiquetas  -->
                            <HorizontalStackLayout
                                Grid.Row="3"
                                HorizontalOptions="Center"
                                Spacing="4"
                                IsVisible="{Binding HasTagsSummary}">
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeSmall}"
                                    SymbolName="tag.fill"
                                    TintColor="White"
                                    VerticalOptions="Center"
                                    WidthRequest="{StaticResource IconSizeSmall}" />
                                <Label
                                    FontSize="{StaticResource FontSizeSmall}"
                                    LineBreakMode="TailTruncation"
                                    Text="{Binding TagsSummary}"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>

                <CollectionView.EmptyView>
                    <VerticalStackLayout
                        Padding="40"
                        HorizontalOptions="Center"
                        VerticalOptions="Center">
                        <Label
                            FontSize="{StaticResource FontSizeTitle}"
                            HorizontalOptions="Center"
                            Text="Selecciona una sesión"
                            TextColor="Gray" />
                    </VerticalStackLayout>
                </CollectionView.EmptyView>

                <CollectionView.Footer>
                    <VerticalStackLayout
                        Padding="20"
                        HorizontalOptions="Center"
                        IsVisible="{Binding HasMoreVideos}">
                        <ActivityIndicator
                            HeightRequest="24"
                            IsRunning="{Binding IsLoadingMore}"
                            IsVisible="{Binding IsLoadingMore}"
                            WidthRequest="24"
                            Color="{StaticResource Primary}" />
                        <Label
                            FontSize="{StaticResource FontSizeSmall}"
                            HorizontalOptions="Center"
                            IsVisible="{Binding HasMoreVideos}"
                            Text="Desplázate para cargar más..."
                            TextColor="Gray" />
                    </VerticalStackLayout>
                </CollectionView.Footer>
            </CollectionView>

            <!--  Galería de videos remotos (Wasabi)  -->
            <CollectionView
                x:Name="RemoteVideoGallery"
                Grid.Row="2"
                ItemsSource="{Binding RemoteVideos}"
                IsVisible="{Binding ShowRemoteGallery}"
                SelectionMode="None"
                Margin="{StaticResource MarginTopSmall}"
                ItemSizingStrategy="MeasureFirstItem">
                <CollectionView.ItemsLayout>
                    <GridItemsLayout
                        HorizontalItemSpacing="{StaticResource SpacingLarge}"
                        Orientation="Vertical"
                        Span="{Binding VideoGalleryColumnSpan}"
                        VerticalItemSpacing="50" />
                </CollectionView.ItemsLayout>

                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:RemoteVideoItem">
                        <Grid RowDefinitions="Auto,Auto,Auto,Auto" RowSpacing="4">
                            <!--  Fila 0: Thumbnail con Border  -->
                            <Border
                                Grid.Row="0"
                                BackgroundColor="#FF2A2A2A"
                                Stroke="Transparent"
                                StrokeShape="RoundRectangle 10"
                                StrokeThickness="0">
                                <Border.Triggers>
                                    <DataTrigger TargetType="Border" Binding="{Binding IsSelected}" Value="True">
                                        <Setter Property="Stroke" Value="#FF0066" />
                                        <Setter Property="StrokeThickness" Value="3" />
                                    </DataTrigger>
                                </Border.Triggers>
                                <Border.GestureRecognizers>
                                    <!--  Tap simple: seleccionar si está en modo multi-select  -->
                                    <TapGestureRecognizer
                                        Command="{Binding Source={x:Reference ThisPage}, Path=BindingContext.ToggleRemoteVideoSelectionCommand}"
                                        CommandParameter="{Binding .}"
                                        NumberOfTapsRequired="1" />
                                    <!--  Doble clic: reproducir (descarga si es necesario)  -->
                                    <TapGestureRecognizer
                                        Command="{Binding Source={x:Reference ThisPage}, Path=BindingContext.PlayRemoteVideoCommand}"
                                        CommandParameter="{Binding .}"
                                        NumberOfTapsRequired="2" />
                                    <!--  Clic derecho: menú contextual  -->
                                    <TapGestureRecognizer
                                        Buttons="Secondary"
                                        Tapped="OnRemoteVideoContextMenu"
                                        NumberOfTapsRequired="1" />
                                </Border.GestureRecognizers>
                                <controls:AspectRatioContainer AspectRatio="1.777">
                                    <Grid>
                                        <!--  Placeholder con icono de cloud  -->
                                        <Border BackgroundColor="#FF333333" StrokeThickness="0">
                                            <VerticalStackLayout HorizontalOptions="Center" VerticalOptions="Center" Spacing="8">
                                                <controls:SymbolIcon
                                                    HeightRequest="48"
                                                    WidthRequest="48"
                                                    SymbolName="{Binding StatusIcon}"
                                                    TintColor="{Binding StatusColor}"
                                                    HorizontalOptions="Center" />
                                                <Label
                                                    FontSize="{StaticResource FontSizeCaption}"
                                                    Text="{Binding SizeFormatted}"
                                                    TextColor="#888888"
                                                    HorizontalOptions="Center" />
                                            </VerticalStackLayout>
                                        </Border>

                                        <!--  Thumbnail remota/local si existe  -->
                                        <Image
                                            Aspect="AspectFill"
                                            Source="{Binding EffectiveThumbnailSource}"
                                            IsVisible="{Binding EffectiveThumbnailSource, Converter={StaticResource NotNullOrEmptyBoolConverter}}" />

                                        <!--  Indicador de descarga  -->
                                        <Border
                                            BackgroundColor="#80000000"
                                            IsVisible="{Binding IsDownloading}">
                                            <VerticalStackLayout HorizontalOptions="Center" VerticalOptions="Center" Spacing="8">
                                                <ActivityIndicator
                                                    Color="#FF0066"
                                                    IsRunning="{Binding IsDownloading}"
                                                    HeightRequest="32"
                                                    WidthRequest="32" />
                                                <ProgressBar
                                                    Progress="{Binding DownloadProgress}"
                                                    ProgressColor="#FF0066"
                                                    WidthRequest="100" />
                                            </VerticalStackLayout>
                                        </Border>

                                        <!--  Badge de estado  -->
                                        <Border
                                            Margin="8"
                                            BackgroundColor="{Binding StatusColor}"
                                            HorizontalOptions="End"
                                            Padding="6,2"
                                            StrokeShape="RoundRectangle 12"
                                            StrokeThickness="0"
                                            VerticalOptions="Start">
                                            <HorizontalStackLayout Spacing="4">
                                                <controls:SymbolIcon
                                                    HeightRequest="12"
                                                    WidthRequest="12"
                                                    SymbolName="{Binding StatusIcon}"
                                                    TintColor="White" />
                                                <Label
                                                    FontSize="10"
                                                    Text="{Binding IsLocallyAvailable, Converter={StaticResource BoolToStringConverter}, ConverterParameter='Local|Nube'}"
                                                    TextColor="White"
                                                    VerticalOptions="Center" />
                                            </HorizontalStackLayout>
                                        </Border>
                                        
                                        <!--  Checkbox de selección (visible en modo multi-select)  -->
                                        <Border
                                            Margin="8"
                                            HeightRequest="28"
                                            WidthRequest="28"
                                            HorizontalOptions="Start"
                                            VerticalOptions="Start"
                                            StrokeShape="RoundRectangle 14"
                                            StrokeThickness="2"
                                            Stroke="White"
                                            BackgroundColor="#80000000"
                                            IsVisible="{Binding Source={x:Reference ThisPage}, Path=BindingContext.IsRemoteMultiSelectMode}">
                                            <Border.Triggers>
                                                <DataTrigger TargetType="Border" Binding="{Binding IsSelected}" Value="True">
                                                    <Setter Property="BackgroundColor" Value="#FF0066" />
                                                    <Setter Property="Stroke" Value="#FF0066" />
                                                </DataTrigger>
                                            </Border.Triggers>
                                            <controls:SymbolIcon
                                                HeightRequest="16"
                                                WidthRequest="16"
                                                SymbolName="checkmark"
                                                TintColor="White"
                                                HorizontalOptions="Center"
                                                VerticalOptions="Center"
                                                IsVisible="{Binding IsSelected}" />
                                        </Border>
                                    </Grid>
                                </controls:AspectRatioContainer>
                            </Border>
                            
                            <!--  Fila 1: Nombre del video  -->
                            <Label
                                Grid.Row="1"
                                FontSize="{StaticResource FontSizeSubtitle}"
                                FontAttributes="Bold"
                                HorizontalTextAlignment="Center"
                                LineBreakMode="TailTruncation"
                                Text="{Binding FileName}"
                                TextColor="White" />
                            
                            <!--  Fila 2: Sesión y tamaño  -->
                            <Label
                                Grid.Row="2"
                                FontSize="{StaticResource FontSizeBody}"
                                HorizontalTextAlignment="Center"
                                LineBreakMode="TailTruncation"
                                Text="{Binding SessionName}"
                                TextColor="#AAAAAA" />
                            
                            <!--  Fila 3: Fecha  -->
                            <Label
                                Grid.Row="3"
                                FontSize="{StaticResource FontSizeSmall}"
                                HorizontalTextAlignment="Center"
                                Text="{Binding LastModified, StringFormat='{0:dd/MM/yyyy HH:mm}'}"
                                TextColor="#888888" />
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>

                <CollectionView.EmptyView>
                    <VerticalStackLayout
                        Padding="40"
                        HorizontalOptions="Center"
                        VerticalOptions="Center">
                        <controls:SymbolIcon
                            HeightRequest="64"
                            WidthRequest="64"
                            SymbolName="icloud"
                            TintColor="Gray"
                            HorizontalOptions="Center"
                            Margin="0,0,0,16" />
                        <Label
                            FontSize="{StaticResource FontSizeTitle}"
                            HorizontalOptions="Center"
                            Text="No hay videos en la nube"
                            TextColor="Gray" />
                        <Label
                            FontSize="{StaticResource FontSizeBody}"
                            HorizontalOptions="Center"
                            Text="Sincroniza tus videos para verlos aquí"
                            TextColor="#666666"
                            Margin="0,8,0,0" />
                    </VerticalStackLayout>
                </CollectionView.EmptyView>

                <!--  Indicador de carga  -->
                <CollectionView.Header>
                    <ActivityIndicator
                        HeightRequest="32"
                        WidthRequest="32"
                        IsRunning="{Binding IsLoadingRemoteVideos}"
                        IsVisible="{Binding IsLoadingRemoteVideos}"
                        Color="#FF0066"
                        HorizontalOptions="Center"
                        Margin="0,20,0,0" />
                </CollectionView.Header>
            </CollectionView>

            <CollectionView
                x:Name="VideoLessonsGallery"
                Grid.Row="2"
                ItemsSource="{Binding VideoLessons}"
                IsVisible="{Binding IsVideoLessonsSelected}"
                SelectionMode="None"
                Margin="{StaticResource MarginTopSmall}">
                <CollectionView.ItemsLayout>
                    <GridItemsLayout
                        HorizontalItemSpacing="{StaticResource SpacingXSmall}"
                        Orientation="Vertical"
                        Span="{Binding VideoGalleryColumnSpan}"
                        VerticalItemSpacing="{StaticResource SpacingSmall}" />
                </CollectionView.ItemsLayout>

                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:VideoLesson">
                        <Border
                            BackgroundColor="Transparent"
                            Stroke="Transparent"
                            StrokeShape="RoundRectangle 4"
                            StrokeThickness="0">
                            <Border.Behaviors>
                                <behaviors:HoverBackgroundBehavior />
                            </Border.Behaviors>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer
                                    Command="{Binding Source={x:Reference ThisPage}, Path=BindingContext.VideoLessonTapCommand}"
                                    CommandParameter="{Binding .}" />
                            </Border.GestureRecognizers>

                            <Grid RowDefinitions="Auto,Auto">
                                <!--  Thumbnail con aspect ratio 16:9  -->
                                <controls:AspectRatioContainer AspectRatio="1.777">
                                    <Grid>
                                        <Image
                                            Aspect="AspectFill"
                                            BackgroundColor="{StaticResource Gray300}"
                                            Source="{Binding EffectiveThumbnailPath}" />

                                        <!--  Overlay de play  -->
                                        <controls:SymbolIcon
                            HeightRequest="{StaticResource IconSizeXXLarge}"
                            SymbolName="play.circle.fill"
                            TintColor="Black" Opacity="0.5"
                            VerticalOptions="Center"
                            WidthRequest="{StaticResource IconSizeXXLarge}" />
                                    </Grid>
                                </controls:AspectRatioContainer>

                                <!--  Footer con info y acciones  -->
                                <Grid
                                    Grid.Row="1"
                                    Padding="8"
                                    ColumnDefinitions="*,Auto">
                                    <VerticalStackLayout Grid.Column="0" Spacing="2">
                                        <Label
                                            FontSize="{StaticResource FontSizeSmall}"
                                            LineBreakMode="TailTruncation"
                                            Text="{Binding DisplayTitle}"
                                            TextColor="White" />
                                        <Label
                                            FontSize="{StaticResource FontSizeSmall}"
                                            LineBreakMode="TailTruncation"
                                            Text="{Binding SessionDisplayName}"
                                            TextColor="#FFCCCCCC" />
                                        <Label
                                            FontSize="{StaticResource FontSizeSmall}"
                                            Text="{Binding CreatedAtUtc, StringFormat='{0:dd/MM/yyyy HH:mm}'}"
                                            TextColor="#FFCCCCCC" />
                                    </VerticalStackLayout>
                                    
                                    <!--  Botones de acción  -->
                                    <HorizontalStackLayout Grid.Column="1" Spacing="4" VerticalOptions="Center">
                                        <Border
                                            WidthRequest="{StaticResource ElementHeightMedium}"
                                            HeightRequest="{StaticResource ElementHeightMedium}"
                                            Padding="{StaticResource PaddingXSmall}"
                                            BackgroundColor="#FF3A3A3A"
                                            StrokeShape="RoundRectangle 14"
                                            StrokeThickness="0">
                                            <Border.GestureRecognizers>
                                                <TapGestureRecognizer
                                                    Command="{Binding Source={x:Reference ThisPage}, Path=BindingContext.ShareVideoLessonCommand}"
                                                    CommandParameter="{Binding .}" />
                                            </Border.GestureRecognizers>
                                            <controls:SymbolIcon
                                                WidthRequest="{StaticResource IconSizeSmall}"
                                                HeightRequest="{StaticResource IconSizeSmall}"
                                                SymbolName="square.and.arrow.up"
                                                TintColor="White"
                                                HorizontalOptions="Center"
                                                VerticalOptions="Center" />
                                        </Border>
                                        <Border
                                            WidthRequest="{StaticResource ElementHeightMedium}"
                                            HeightRequest="{StaticResource ElementHeightMedium}"
                                            Padding="{StaticResource PaddingXSmall}"
                                            BackgroundColor="#FF3A3A3A"
                                            StrokeShape="RoundRectangle 14"
                                            StrokeThickness="0">
                                            <Border.GestureRecognizers>
                                                <TapGestureRecognizer
                                                    Command="{Binding Source={x:Reference ThisPage}, Path=BindingContext.DeleteVideoLessonCommand}"
                                                    CommandParameter="{Binding .}" />
                                            </Border.GestureRecognizers>
                                            <controls:SymbolIcon
                                                WidthRequest="{StaticResource IconSizeSmall}"
                                                HeightRequest="{StaticResource IconSizeSmall}"
                                                SymbolName="trash"
                                                TintColor="#FFFF6B6B"
                                                HorizontalOptions="Center"
                                                VerticalOptions="Center" />
                                        </Border>
                                    </HorizontalStackLayout>
                                </Grid>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>

                <CollectionView.EmptyView>
                    <VerticalStackLayout
                        Padding="40"
                        HorizontalOptions="Center"
                        VerticalOptions="Center">
                        <Label
                            FontSize="{StaticResource FontSizeTitle}"
                            HorizontalOptions="Center"
                            Text="No hay videolecciones"
                            TextColor="Gray" />
                    </VerticalStackLayout>
                </CollectionView.EmptyView>
            </CollectionView>

            <!--  Vista Diario: Calendario  -->
            <controls:CalendarView
                Grid.Row="2"
                Margin="0,10,0,0"
                IsVisible="{Binding IsDiaryViewSelected}"
                SelectedDate="{Binding SelectedDiaryDate}"
                DateSelectedCommand="{Binding SelectDiaryDateCommand}"
                DiaryEntries="{Binding DiaryEntriesForMonth}"
                Sessions="{Binding SessionsForMonth}"
                WellnessData="{Binding WellnessDataForMonth}"
                AverageWellnessScore="{Binding AverageWellnessScore}"
                HorizontalOptions="Fill"
                VerticalOptions="Fill" />
        </Grid>

        <!--  Columna 4 (quinta): estadísticas de la sesión seleccionada  -->
        <ScrollView
            Grid.Row="1"
            Grid.Column="4"
            Padding="20"
            BackgroundColor="#FF1E1E1E">
            <ScrollView.IsVisible>
                <Binding Path="IsVideoLessonsSelected" Converter="{toolkit:InvertedBoolConverter}" />
            </ScrollView.IsVisible>
            <VerticalStackLayout Spacing="12">

                <!--  Pestañas: Acciones / Estadísticas / Diario  -->
                <Grid ColumnDefinitions="*,*,*" ColumnSpacing="8">
                    <Grid.IsVisible>
                        <MultiBinding Converter="{StaticResource AllTrueConverter}">
                            <Binding Path="IsDiaryViewSelected" Converter="{toolkit:InvertedBoolConverter}" />
                            <Binding Path="IsQuickAnalysisIsolatedMode" Converter="{toolkit:InvertedBoolConverter}" />
                        </MultiBinding>
                    </Grid.IsVisible>
                    <Border
                        Padding="10,8"
                        BackgroundColor="#FF404040"
                        Stroke="Transparent"
                        StrokeShape="RoundRectangle 6">
                        <Border.Triggers>
                            <DataTrigger TargetType="Border" Binding="{Binding IsCrudTechTabSelected}" Value="True">
                                <Setter Property="BackgroundColor" Value="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BackgroundColor}" />
                            </DataTrigger>
                        </Border.Triggers>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding SelectCrudTechTabCommand}" />
                        </Border.GestureRecognizers>
                        <Grid>
                            <!-- iOS: Solo icono -->
                            <controls:SymbolIcon
                                SymbolName="slider.horizontal.3"
                                TintColor="White"
                                HeightRequest="18"
                                WidthRequest="18"
                                HorizontalOptions="Center">
                                <controls:SymbolIcon.IsVisible>
                                    <OnPlatform x:TypeArguments="x:Boolean">
                                        <On Platform="iOS" Value="True" />
                                        <On Platform="Default" Value="False" />
                                    </OnPlatform>
                                </controls:SymbolIcon.IsVisible>
                            </controls:SymbolIcon>
                            <!-- Otras plataformas: Texto -->
                            <Label Text="Acciones y Análisis" TextColor="White" HorizontalOptions="Center">
                                <Label.IsVisible>
                                    <OnPlatform x:TypeArguments="x:Boolean">
                                        <On Platform="iOS" Value="False" />
                                        <On Platform="Default" Value="True" />
                                    </OnPlatform>
                                </Label.IsVisible>
                                <Label.Triggers>
                                    <DataTrigger TargetType="Label" Binding="{Binding IsCrudTechTabSelected}" Value="True">
                                        <Setter Property="FontAttributes" Value="None" />
                                    </DataTrigger>
                                    <DataTrigger TargetType="Label" Binding="{Binding IsCrudTechTabSelected}" Value="False">
                                        <Setter Property="FontAttributes" Value="None" />
                                    </DataTrigger>
                                </Label.Triggers>
                            </Label>
                        </Grid>
                    </Border>

                    <Border
                        Grid.Column="1"
                        Padding="10,8"
                        BackgroundColor="#FF404040"
                        Stroke="Transparent"
                        StrokeShape="RoundRectangle 6">
                        <Border.Triggers>
                            <DataTrigger TargetType="Border" Binding="{Binding IsStatsTabSelected}" Value="True">
                                <Setter Property="BackgroundColor" Value="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BackgroundColor}" />
                            </DataTrigger>
                        </Border.Triggers>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding SelectStatsTabCommand}" />
                        </Border.GestureRecognizers>
                        <Grid>
                            <!-- iOS: Solo icono -->
                            <controls:SymbolIcon
                                SymbolName="chart.bar.fill"
                                TintColor="White"
                                HeightRequest="18"
                                WidthRequest="18"
                                HorizontalOptions="Center">
                                <controls:SymbolIcon.IsVisible>
                                    <OnPlatform x:TypeArguments="x:Boolean">
                                        <On Platform="iOS" Value="True" />
                                        <On Platform="Default" Value="False" />
                                    </OnPlatform>
                                </controls:SymbolIcon.IsVisible>
                            </controls:SymbolIcon>
                            <!-- Otras plataformas: Texto -->
                            <Label Text="Filtros y Estadísticas" TextColor="White" HorizontalOptions="Center">
                                <Label.IsVisible>
                                    <OnPlatform x:TypeArguments="x:Boolean">
                                        <On Platform="iOS" Value="False" />
                                        <On Platform="Default" Value="True" />
                                    </OnPlatform>
                                </Label.IsVisible>
                                <Label.Triggers>
                                    <DataTrigger TargetType="Label" Binding="{Binding IsStatsTabSelected}" Value="True">
                                        <Setter Property="FontAttributes" Value="None" />
                                    </DataTrigger>
                                    <DataTrigger TargetType="Label" Binding="{Binding IsStatsTabSelected}" Value="False">
                                        <Setter Property="FontAttributes" Value="None" />
                                    </DataTrigger>
                                </Label.Triggers>
                            </Label>
                        </Grid>
                    </Border>

                    <Border
                        Grid.Column="2"
                        Padding="10,8"
                        BackgroundColor="#FF404040"
                        Stroke="Transparent"
                        StrokeShape="RoundRectangle 6"
                        IsVisible="{Binding HasSpecificSessionSelected}">
                        <Border.Triggers>
                            <DataTrigger TargetType="Border" Binding="{Binding IsDiaryTabSelected}" Value="True">
                                <Setter Property="BackgroundColor" Value="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BackgroundColor}" />
                            </DataTrigger>
                        </Border.Triggers>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding SelectDiaryTabCommand}" />
                        </Border.GestureRecognizers>
                        <Grid>
                            <!-- iOS: Solo icono -->
                            <controls:SymbolIcon
                                SymbolName="calendar"
                                TintColor="White"
                                HeightRequest="18"
                                WidthRequest="18"
                                HorizontalOptions="Center">
                                <controls:SymbolIcon.IsVisible>
                                    <OnPlatform x:TypeArguments="x:Boolean">
                                        <On Platform="iOS" Value="True" />
                                        <On Platform="Default" Value="False" />
                                    </OnPlatform>
                                </controls:SymbolIcon.IsVisible>
                            </controls:SymbolIcon>
                            <!-- Otras plataformas: Texto -->
                            <Label Text="Diario de Sesión" TextColor="White" HorizontalOptions="Center">
                                <Label.IsVisible>
                                    <OnPlatform x:TypeArguments="x:Boolean">
                                        <On Platform="iOS" Value="False" />
                                        <On Platform="Default" Value="True" />
                                    </OnPlatform>
                                </Label.IsVisible>
                                <Label.Triggers>
                                    <DataTrigger TargetType="Label" Binding="{Binding IsDiaryTabSelected}" Value="True">
                                        <Setter Property="FontAttributes" Value="None" />
                                    </DataTrigger>
                                    <DataTrigger TargetType="Label" Binding="{Binding IsDiaryTabSelected}" Value="False">
                                        <Setter Property="FontAttributes" Value="None" />
                                    </DataTrigger>
                                </Label.Triggers>
                            </Label>
                        </Grid>
                    </Border>

                </Grid>


                <!--  Pestaña: Acciones CRUD + análisis técnico (no por defecto)  -->
                <VerticalStackLayout Spacing="12">
                    <VerticalStackLayout.IsVisible>
                        <MultiBinding Converter="{StaticResource AllTrueConverter}">
                            <Binding Path="IsCrudTechTabSelected" />
                            <Binding Path="IsDiaryViewSelected" Converter="{toolkit:InvertedBoolConverter}" />
                        </MultiBinding>
                    </VerticalStackLayout.IsVisible>
                    <HorizontalStackLayout Spacing="12" VerticalOptions="Center" IsVisible="{Binding IsQuickAnalysisIsolatedMode, Converter={toolkit:InvertedBoolConverter}}">
                        <controls:SymbolIcon
                            HeightRequest="{StaticResource IconSizeLarge}"
                            SymbolName="film.stack"
                            TintColor="#FF0066"
                            VerticalOptions="Center"
                            WidthRequest="{StaticResource IconSizeLarge}" />
                        <Label
                            FontSize="{StaticResource FontSizeHeader}"
                            Text="Acciones en lote"
                            TextColor="White" />
                    </HorizontalStackLayout>

                    <!--  Toggles de selección  -->
                    <Label
                        FontSize="{StaticResource FontSizeBody}"
                        Text="Selección de vídeos"
                        TextColor="#FFCCCCCC"
                        IsVisible="{Binding IsQuickAnalysisIsolatedMode, Converter={toolkit:InvertedBoolConverter}}" />

                    <Grid ColumnDefinitions="*,*" ColumnSpacing="8" IsVisible="{Binding IsQuickAnalysisIsolatedMode, Converter={toolkit:InvertedBoolConverter}}">
                        <!--  Toggle: Selección múltiple  -->
                        <Border
                            Padding="10,8"
                            BackgroundColor="#FF404040"
                            Stroke="Transparent"
                            StrokeShape="RoundRectangle 6">
                            <Border.Triggers>
                                <DataTrigger TargetType="Border" Binding="{Binding IsMultiSelectMode}" Value="True">
                                    <Setter Property="BackgroundColor" Value="#FF0066" />
                                </DataTrigger>
                            </Border.Triggers>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ToggleMultiSelectModeCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout HorizontalOptions="Center" Spacing="6">
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeMedium}"
                                    SymbolName="checkmark.circle"
                                    TintColor="White"
                                    WidthRequest="{StaticResource IconSizeMedium}"
                                    VerticalOptions="Center">
                                    <controls:SymbolIcon.Triggers>
                                        <DataTrigger TargetType="controls:SymbolIcon" Binding="{Binding IsMultiSelectMode}" Value="True">
                                            <Setter Property="SymbolName" Value="checkmark.circle.fill" />
                                        </DataTrigger>
                                    </controls:SymbolIcon.Triggers>
                                </controls:SymbolIcon>
                                <Label Text="Seleccionar" TextColor="White" VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>

                        <!--  Toggle: Seleccionar todos  -->
                        <Border
                            Grid.Column="1"
                            Padding="10,8"
                            BackgroundColor="#FF404040"
                            Stroke="Transparent"
                            StrokeShape="RoundRectangle 6">
                            <Border.Triggers>
                                <DataTrigger TargetType="Border" Binding="{Binding IsSelectAllActive}" Value="True">
                                    <Setter Property="BackgroundColor" Value="#FF0066" />
                                </DataTrigger>
                            </Border.Triggers>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ToggleSelectAllCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout HorizontalOptions="Center" Spacing="6">
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeMedium}"
                                    SymbolName="checkmark.circle"
                                    TintColor="White"
                                    WidthRequest="{StaticResource IconSizeMedium}"
                                    VerticalOptions="Center">
                                    <controls:SymbolIcon.Triggers>
                                        <DataTrigger TargetType="controls:SymbolIcon" Binding="{Binding IsSelectAllActive}" Value="True">
                                            <Setter Property="SymbolName" Value="checkmark.circle.fill" />
                                        </DataTrigger>
                                    </controls:SymbolIcon.Triggers>
                                </controls:SymbolIcon>
                                <Label Text="Todos" TextColor="White" VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>
                    </Grid>

                    <!--  Sección: Acciones  -->
                    <Label
                        Margin="0,12,0,0"
                        FontSize="{StaticResource FontSizeBody}"
                        Text="Acciones en lote"
                        TextColor="#FFCCCCCC"
                        IsVisible="{Binding IsQuickAnalysisIsolatedMode, Converter={toolkit:InvertedBoolConverter}}" />

                    <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto" ColumnSpacing="8" RowSpacing="8" IsVisible="{Binding IsQuickAnalysisIsolatedMode, Converter={toolkit:InvertedBoolConverter}}">
                        <!--  Botón: Reproducir como playlist  -->
                        <Border
                            Grid.Row="0"
                            Grid.Column="0"
                            Padding="{StaticResource PaddingActionButton}"
                            BackgroundColor="#FF404040"
                            Stroke="Transparent"
                            StrokeShape="RoundRectangle 6">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding PlayAsPlaylistCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout HorizontalOptions="Center" Spacing="6">
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeMedium}"
                                    SymbolName="play.rectangle.on.rectangle"
                                    TintColor="White"
                                    WidthRequest="{StaticResource IconSizeMedium}"
                                    VerticalOptions="Center" />
                                <Label Text="Playlist" TextColor="White" VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>

                        <!--  Botón: Editar detalles  -->
                        <Border
                            Grid.Row="0"
                            Grid.Column="1"
                            Padding="{StaticResource PaddingActionButton}"
                            BackgroundColor="#FF404040"
                            Stroke="Transparent"
                            StrokeShape="RoundRectangle 6">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding EditVideoDetailsCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout HorizontalOptions="Center" Spacing="6">
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeMedium}"
                                    SymbolName="pencil.circle"
                                    TintColor="White"
                                    WidthRequest="{StaticResource IconSizeMedium}"
                                    VerticalOptions="Center" />
                                <Label Text="Editar" TextColor="White" VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>

                        <!--  Botón: Compartir  -->
                        <Border
                            Grid.Row="1"
                            Grid.Column="0"
                            Padding="{StaticResource PaddingActionButton}"
                            BackgroundColor="#FF404040"
                            Stroke="Transparent"
                            StrokeShape="RoundRectangle 6">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ShareSelectedVideosCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout HorizontalOptions="Center" Spacing="6">
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeMedium}"
                                    SymbolName="square.and.arrow.up"
                                    TintColor="#FF0066"
                                    WidthRequest="{StaticResource IconSizeMedium}"
                                    VerticalOptions="Center" />
                                <Label Text="Compartir" TextColor="#FF0066" VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>

                        <!--  Botón: Eliminar selección  -->
                        <Border
                            Grid.Row="1"
                            Grid.Column="1"
                            Padding="{StaticResource PaddingActionButton}"
                            BackgroundColor="#FF404040"
                            Stroke="Transparent"
                            StrokeShape="RoundRectangle 6">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding DeleteSelectedVideosCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout HorizontalOptions="Center" Spacing="6">
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeMedium}"
                                    SymbolName="trash.circle"
                                    TintColor="#FFFF6B6B"
                                    WidthRequest="{StaticResource IconSizeMedium}"
                                    VerticalOptions="Center" />
                                <Label Text="Eliminar" TextColor="#FFFF6B6B" VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>
                    </Grid>

                    <!--  ========== SECCIÓN: ACCIONES EN LOTE PARA VIDEOS REMOTOS ==========  -->
                    <VerticalStackLayout
                        Spacing="12"
                        IsVisible="{Binding ShowRemoteGallery}">
                        
                        <!--  Separador  -->
                        <Border
                            HeightRequest="1"
                            BackgroundColor="#FF464646"
                            Stroke="Transparent"
                            Margin="0,8,0,0" />
                        
                        <!--  Título sección remota  -->
                        <HorizontalStackLayout Spacing="12" VerticalOptions="Center">
                            <controls:SymbolIcon
                                HeightRequest="{StaticResource IconSizeLarge}"
                                SymbolName="icloud"
                                TintColor="#2196F3"
                                VerticalOptions="Center"
                                WidthRequest="{StaticResource IconSizeLarge}" />
                            <Label
                                FontSize="{StaticResource FontSizeHeader}"
                                Text="Acciones Remotas"
                                TextColor="White" />
                        </HorizontalStackLayout>

                        <!--  Toggles de selección remotos  -->
                        <Label
                            FontSize="{StaticResource FontSizeBody}"
                            Text="Selección de vídeos remotos"
                            TextColor="#FFCCCCCC" />

                        <Grid ColumnDefinitions="*,*" ColumnSpacing="8">
                            <!--  Toggle: Selección múltiple remota  -->
                            <Border
                                Padding="10,8"
                                BackgroundColor="#FF404040"
                                Stroke="Transparent"
                                StrokeShape="RoundRectangle 6">
                                <Border.Triggers>
                                    <DataTrigger TargetType="Border" Binding="{Binding IsRemoteMultiSelectMode}" Value="True">
                                        <Setter Property="BackgroundColor" Value="#2196F3" />
                                    </DataTrigger>
                                </Border.Triggers>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ToggleRemoteMultiSelectModeCommand}" />
                                </Border.GestureRecognizers>
                                <HorizontalStackLayout HorizontalOptions="Center" Spacing="6">
                                    <controls:SymbolIcon
                                        HeightRequest="{StaticResource IconSizeMedium}"
                                        SymbolName="checkmark.circle"
                                        TintColor="White"
                                        WidthRequest="{StaticResource IconSizeMedium}"
                                        VerticalOptions="Center">
                                        <controls:SymbolIcon.Triggers>
                                            <DataTrigger TargetType="controls:SymbolIcon" Binding="{Binding IsRemoteMultiSelectMode}" Value="True">
                                                <Setter Property="SymbolName" Value="checkmark.circle.fill" />
                                            </DataTrigger>
                                        </controls:SymbolIcon.Triggers>
                                    </controls:SymbolIcon>
                                    <Label Text="Seleccionar" TextColor="White" VerticalOptions="Center" />
                                </HorizontalStackLayout>
                            </Border>

                            <!--  Toggle: Seleccionar todos remotos  -->
                            <Border
                                Grid.Column="1"
                                Padding="10,8"
                                BackgroundColor="#FF404040"
                                Stroke="Transparent"
                                StrokeShape="RoundRectangle 6">
                                <Border.Triggers>
                                    <DataTrigger TargetType="Border" Binding="{Binding IsRemoteSelectAllActive}" Value="True">
                                        <Setter Property="BackgroundColor" Value="#2196F3" />
                                    </DataTrigger>
                                </Border.Triggers>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ToggleRemoteSelectAllCommand}" />
                                </Border.GestureRecognizers>
                                <HorizontalStackLayout HorizontalOptions="Center" Spacing="6">
                                    <controls:SymbolIcon
                                        HeightRequest="{StaticResource IconSizeMedium}"
                                        SymbolName="checkmark.circle"
                                        TintColor="White"
                                        WidthRequest="{StaticResource IconSizeMedium}"
                                        VerticalOptions="Center">
                                        <controls:SymbolIcon.Triggers>
                                            <DataTrigger TargetType="controls:SymbolIcon" Binding="{Binding IsRemoteSelectAllActive}" Value="True">
                                                <Setter Property="SymbolName" Value="checkmark.circle.fill" />
                                            </DataTrigger>
                                        </controls:SymbolIcon.Triggers>
                                    </controls:SymbolIcon>
                                    <Label Text="Todos" TextColor="White" VerticalOptions="Center" />
                                </HorizontalStackLayout>
                            </Border>
                        </Grid>

                        <!--  Contador de selección  -->
                        <Label
                            FontSize="{StaticResource FontSizeBody}"
                            HorizontalOptions="Center"
                            TextColor="#2196F3"
                            IsVisible="{Binding IsRemoteMultiSelectMode}">
                            <Label.Text>
                                <Binding Path="SelectedRemoteVideoCount" StringFormat="{}{0} vídeo(s) seleccionado(s)" />
                            </Label.Text>
                        </Label>

                        <!--  Sección: Acciones remotas  -->
                        <Label
                            Margin="0,8,0,0"
                            FontSize="{StaticResource FontSizeBody}"
                            Text="Acciones en lote"
                            TextColor="#FFCCCCCC" />

                        <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto,Auto" ColumnSpacing="8" RowSpacing="8">
                            <!--  Botón: Descargar selección  -->
                            <Border
                                Grid.Row="0"
                                Grid.Column="0"
                                Padding="{StaticResource PaddingActionButton}"
                                BackgroundColor="#FF404040"
                                Stroke="Transparent"
                                StrokeShape="RoundRectangle 6">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding DownloadSelectedRemoteVideosCommand}" />
                                </Border.GestureRecognizers>
                                <HorizontalStackLayout HorizontalOptions="Center" Spacing="6">
                                    <controls:SymbolIcon
                                        HeightRequest="{StaticResource IconSizeMedium}"
                                        SymbolName="arrow.down.circle"
                                        TintColor="#4CAF50"
                                        WidthRequest="{StaticResource IconSizeMedium}"
                                        VerticalOptions="Center" />
                                    <Label Text="Descargar" TextColor="#4CAF50" VerticalOptions="Center" />
                                </HorizontalStackLayout>
                            </Border>

                            <!--  Botón: Añadir a biblioteca  -->
                            <Border
                                Grid.Row="0"
                                Grid.Column="1"
                                Padding="{StaticResource PaddingActionButton}"
                                BackgroundColor="#FF404040"
                                Stroke="Transparent"
                                StrokeShape="RoundRectangle 6">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding AddSelectedRemoteToLibraryCommand}" />
                                </Border.GestureRecognizers>
                                <HorizontalStackLayout HorizontalOptions="Center" Spacing="6">
                                    <controls:SymbolIcon
                                        HeightRequest="{StaticResource IconSizeMedium}"
                                        SymbolName="plus.circle"
                                        TintColor="#2196F3"
                                        WidthRequest="{StaticResource IconSizeMedium}"
                                        VerticalOptions="Center" />
                                    <Label Text="Añadir" TextColor="#2196F3" VerticalOptions="Center" />
                                </HorizontalStackLayout>
                            </Border>

                            <!--  Botón: Quitar de biblioteca local  -->
                            <Border
                                Grid.Row="1"
                                Grid.Column="0"
                                Padding="{StaticResource PaddingActionButton}"
                                BackgroundColor="#FF404040"
                                Stroke="Transparent"
                                StrokeShape="RoundRectangle 6">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding DeleteSelectedRemoteFromLibraryCommand}" />
                                </Border.GestureRecognizers>
                                <HorizontalStackLayout HorizontalOptions="Center" Spacing="6">
                                    <controls:SymbolIcon
                                        HeightRequest="{StaticResource IconSizeMedium}"
                                        SymbolName="minus.circle"
                                        TintColor="#FFA500"
                                        WidthRequest="{StaticResource IconSizeMedium}"
                                        VerticalOptions="Center" />
                                    <Label Text="Quitar local" TextColor="#FFA500" VerticalOptions="Center" />
                                </HorizontalStackLayout>
                            </Border>

                            <!--  Botón: Eliminar de la nube (destructivo)  -->
                            <Border
                                Grid.Row="1"
                                Grid.Column="1"
                                Padding="{StaticResource PaddingActionButton}"
                                BackgroundColor="#FF404040"
                                Stroke="Transparent"
                                StrokeShape="RoundRectangle 6">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding DeleteSelectedRemoteFromCloudCommand}" />
                                </Border.GestureRecognizers>
                                <HorizontalStackLayout HorizontalOptions="Center" Spacing="6">
                                    <controls:SymbolIcon
                                        HeightRequest="{StaticResource IconSizeMedium}"
                                        SymbolName="trash.circle"
                                        TintColor="#FFFF6B6B"
                                        WidthRequest="{StaticResource IconSizeMedium}"
                                        VerticalOptions="Center" />
                                    <Label Text="Eliminar nube" TextColor="#FFFF6B6B" VerticalOptions="Center" />
                                </HorizontalStackLayout>
                            </Border>
                        </Grid>
                    </VerticalStackLayout>
                    <!--  ========== FIN SECCIÓN ACCIONES REMOTAS ==========  -->

                    <!--  Sección: Análisis técnico  -->
                    <Border
                        HeightRequest="1"
                        BackgroundColor="#FF464646"
                        Stroke="Transparent"
                        IsVisible="{Binding IsQuickAnalysisIsolatedMode, Converter={toolkit:InvertedBoolConverter}}">
                        <Border.Margin>
                            <OnPlatform x:TypeArguments="Thickness">
                                <On Platform="WinUI" Value="0,4,0,0" />
                                <On Platform="Default" Value="0,12,0,0" />
                            </OnPlatform>
                        </Border.Margin>
                    </Border>

                    <HorizontalStackLayout Spacing="12" VerticalOptions="Center" IsVisible="{Binding IsQuickAnalysisIsolatedMode, Converter={toolkit:InvertedBoolConverter}}">
                        <HorizontalStackLayout.Margin>
                            <OnPlatform x:TypeArguments="Thickness">
                                <On Platform="WinUI" Value="0,8,0,0" />
                                <On Platform="Default" Value="0,20,0,0" />
                            </OnPlatform>
                        </HorizontalStackLayout.Margin>
                        <controls:SymbolIcon
                            HeightRequest="{StaticResource IconSizeLarge}"
                            SymbolName="waveform.path.ecg"
                            TintColor="#FF0066"
                            VerticalOptions="Center"
                            WidthRequest="{StaticResource IconSizeLarge}" />
                        <Label
                            FontSize="{StaticResource FontSizeHeader}"
                            Text="Análisis técnico"
                            TextColor="White" />
                    </HorizontalStackLayout>

                    <!--  Sección: Análisis rápido + botón Modo aislado (+ play/pause iOS)  -->
                    <Grid ColumnDefinitions="*,Auto" VerticalOptions="Center">
                        <Grid.Margin>
                            <OnPlatform x:TypeArguments="Thickness">
                                <On Platform="WinUI" Value="0,4,0,0" />
                                <On Platform="Default" Value="0,12,0,0" />
                            </OnPlatform>
                        </Grid.Margin>
                        <Label
                            Grid.Column="0"
                            FontSize="{StaticResource FontSizeBody}"
                            Text="Análisis rápido"
                            TextColor="#FFCCCCCC"
                            IsVisible="{Binding IsQuickAnalysisIsolatedMode, Converter={toolkit:InvertedBoolConverter}}" />

                        <HorizontalStackLayout Grid.Column="1" Spacing="8" VerticalOptions="Center">
                            <!-- Play/Pause discreto (iOS) para controlar ambos reproductores -->
                            <Border
                                Padding="8"
                                BackgroundColor="#33000000"
                                Stroke="#33000000"
                                StrokeShape="RoundRectangle 999">
                                <Border.IsVisible>
                                    <OnPlatform x:TypeArguments="x:Boolean">
                                        <On Platform="iOS" Value="True" />
                                        <On Platform="Default" Value="False" />
                                    </OnPlatform>
                                </Border.IsVisible>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnQuickAnalysisPlayPauseTapped" />
                                </Border.GestureRecognizers>
                                <controls:SymbolIcon
                                    HeightRequest="18"
                                    WidthRequest="18"
                                    SymbolName="playpause"
                                    TintColor="#DDFFFFFF"
                                    VerticalOptions="Center"
                                    HorizontalOptions="Center" />
                            </Border>

                            <Border
                                Padding="10,8"
                                BackgroundColor="#FF404040"
                                Stroke="Transparent"
                                StrokeShape="RoundRectangle 6">
                                <Border.Triggers>
                                    <DataTrigger TargetType="Border" Binding="{Binding IsQuickAnalysisIsolatedMode}" Value="True">
                                        <Setter Property="BackgroundColor" Value="#FF0066" />
                                    </DataTrigger>
                                </Border.Triggers>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ToggleQuickAnalysisIsolatedModeCommand}" />
                                </Border.GestureRecognizers>
                                <HorizontalStackLayout HorizontalOptions="Center" Spacing="6">
                                    <controls:SymbolIcon
                                        HeightRequest="{StaticResource IconSizeMedium}"
                                        SymbolName="eye"
                                        TintColor="White"
                                        WidthRequest="{StaticResource IconSizeMedium}"
                                        VerticalOptions="Center" />
                                    <Label Text="Modo aislado" TextColor="White" VerticalOptions="Center">
                                        <Label.IsVisible>
                                            <OnPlatform x:TypeArguments="x:Boolean">
                                                <On Platform="iOS" Value="False" />
                                                <On Platform="Default" Value="True" />
                                            </OnPlatform>
                                        </Label.IsVisible>
                                    </Label>
                                </HorizontalStackLayout>
                            </Border>
                        </HorizontalStackLayout>
                    </Grid>

                    <!--  Layout Cuádruple (2x2)  -->
                    <Grid 
                        RowDefinitions="*,*" 
                        ColumnDefinitions="*,*" 
                        RowSpacing="8" 
                        ColumnSpacing="8">
                        <!--  Video 1 (arriba izquierda)  -->
                        <controls:AspectRatioContainer AspectRatio="1.777">
                            <Border
                                BackgroundColor="#FF404040"
                                Stroke="Transparent"
                                StrokeShape="RoundRectangle 6">
                                <Border.GestureRecognizers>
                                    <DropGestureRecognizer AllowDrop="True" Drop="OnDropScreen1" />
                                </Border.GestureRecognizers>
                                <Grid>
                                    <!--  PrecisionVideoPlayer para scrubbing preciso (capa inferior)  -->
                                    <appcontrols:PrecisionVideoPlayer
                                        x:Name="PreviewPlayer1Q"
                                        Aspect="AspectFill"
                                        IsMuted="True"
                                        Source="{Binding ParallelVideo1ClipPath}"
                                        IsVisible="False">
                                        <appcontrols:PrecisionVideoPlayer.Triggers>
                                            <MultiTrigger TargetType="appcontrols:PrecisionVideoPlayer">
                                                <MultiTrigger.Conditions>
                                                    <BindingCondition Binding="{Binding HasParallelVideo1}" Value="True" />
                                                    <BindingCondition Binding="{Binding IsPreviewMode}" Value="True" />
                                                </MultiTrigger.Conditions>
                                                <Setter Property="IsVisible" Value="True" />
                                            </MultiTrigger>
                                        </appcontrols:PrecisionVideoPlayer.Triggers>
                                    </appcontrols:PrecisionVideoPlayer>
                                    <!--  Miniatura del vídeo (cuando no está en preview)  -->
                                    <Image
                                        Aspect="AspectFill"
                                        Source="{Binding ParallelVideo1ThumbnailPath}"
                                        IsVisible="{Binding ShowParallelVideo1Thumbnail}" />
                                    <!--  Placeholder cuando no hay vídeo  -->
                                    <Label
                                        HorizontalOptions="Center"
                                        VerticalOptions="Center"
                                        Text="1"
                                        TextColor="#FF888888"
                                        FontSize="{StaticResource FontSizeHeader}"
                                        FontAttributes="None"
                                        IsVisible="{Binding HasParallelVideo1, Converter={StaticResource InvertedBoolConverter}}" />
                                    <!--  Overlay para scrubbing  -->
                                    <BoxView
                                        BackgroundColor="Transparent"
                                        IsVisible="{Binding HasParallelVideo1}">
                                        <BoxView.GestureRecognizers>
                                            <DropGestureRecognizer AllowDrop="True" Drop="OnDropScreen1" />
                                        </BoxView.GestureRecognizers>
                                    </BoxView>
                                </Grid>
                            </Border>
                        </controls:AspectRatioContainer>
                        <!--  Video 2 (arriba derecha)  -->
                        <controls:AspectRatioContainer Grid.Column="1" AspectRatio="1.777">
                            <Border
                                BackgroundColor="#FF404040"
                                Stroke="Transparent"
                                StrokeShape="RoundRectangle 6">
                                <Border.GestureRecognizers>
                                    <DropGestureRecognizer AllowDrop="True" Drop="OnDropScreen2" />
                                </Border.GestureRecognizers>
                                <Grid>
                                    <!--  PrecisionVideoPlayer para scrubbing preciso (capa inferior)  -->
                                    <appcontrols:PrecisionVideoPlayer
                                        x:Name="PreviewPlayer2Q"
                                        Aspect="AspectFill"
                                        IsMuted="True"
                                        Source="{Binding ParallelVideo2ClipPath}"
                                        IsVisible="False">
                                        <appcontrols:PrecisionVideoPlayer.Triggers>
                                            <MultiTrigger TargetType="appcontrols:PrecisionVideoPlayer">
                                                <MultiTrigger.Conditions>
                                                    <BindingCondition Binding="{Binding HasParallelVideo2}" Value="True" />
                                                    <BindingCondition Binding="{Binding IsPreviewMode}" Value="True" />
                                                </MultiTrigger.Conditions>
                                                <Setter Property="IsVisible" Value="True" />
                                            </MultiTrigger>
                                        </appcontrols:PrecisionVideoPlayer.Triggers>
                                    </appcontrols:PrecisionVideoPlayer>
                                    <!--  Miniatura del vídeo (cuando no está en preview)  -->
                                    <Image
                                        Aspect="AspectFill"
                                        Source="{Binding ParallelVideo2ThumbnailPath}"
                                        IsVisible="{Binding ShowParallelVideo2Thumbnail}" />
                                    <!--  Placeholder cuando no hay vídeo  -->
                                    <Label
                                        HorizontalOptions="Center"
                                        VerticalOptions="Center"
                                        Text="2"
                                        TextColor="#FF888888"
                                        FontSize="{StaticResource FontSizeHeader}"
                                        FontAttributes="None"
                                        IsVisible="{Binding HasParallelVideo2, Converter={StaticResource InvertedBoolConverter}}" />
                                    <!--  Overlay para scrubbing  -->
                                    <BoxView
                                        BackgroundColor="Transparent"
                                        IsVisible="{Binding HasParallelVideo2}">
                                        <BoxView.GestureRecognizers>
                                            <DropGestureRecognizer AllowDrop="True" Drop="OnDropScreen2" />
                                        </BoxView.GestureRecognizers>
                                    </BoxView>
                                </Grid>
                            </Border>
                        </controls:AspectRatioContainer>
                        <!--  Video 3 (abajo izquierda)  -->
                        <controls:AspectRatioContainer Grid.Row="1" AspectRatio="1.777">
                            <Border
                                BackgroundColor="#FF404040"
                                Stroke="Transparent"
                                StrokeShape="RoundRectangle 6">
                                <Border.GestureRecognizers>
                                    <DropGestureRecognizer AllowDrop="True" Drop="OnDropScreen3" />
                                </Border.GestureRecognizers>
                                <Grid>
                                    <!--  PrecisionVideoPlayer para scrubbing preciso (capa inferior)  -->
                                    <appcontrols:PrecisionVideoPlayer
                                        x:Name="PreviewPlayer3Q"
                                        Aspect="AspectFill"
                                        IsMuted="True"
                                        Source="{Binding ParallelVideo3ClipPath}"
                                        IsVisible="False">
                                        <appcontrols:PrecisionVideoPlayer.Triggers>
                                            <MultiTrigger TargetType="appcontrols:PrecisionVideoPlayer">
                                                <MultiTrigger.Conditions>
                                                    <BindingCondition Binding="{Binding HasParallelVideo3}" Value="True" />
                                                    <BindingCondition Binding="{Binding IsPreviewMode}" Value="True" />
                                                </MultiTrigger.Conditions>
                                                <Setter Property="IsVisible" Value="True" />
                                            </MultiTrigger>
                                        </appcontrols:PrecisionVideoPlayer.Triggers>
                                    </appcontrols:PrecisionVideoPlayer>
                                    <!--  Miniatura del vídeo (cuando no está en preview)  -->
                                    <Image
                                        Aspect="AspectFill"
                                        Source="{Binding ParallelVideo3ThumbnailPath}"
                                        IsVisible="{Binding ShowParallelVideo3Thumbnail}" />
                                    <!--  Placeholder cuando no hay vídeo  -->
                                    <Label
                                        HorizontalOptions="Center"
                                        VerticalOptions="Center"
                                        Text="3"
                                        TextColor="#FF888888"
                                        FontSize="{StaticResource FontSizeHeader}"
                                        FontAttributes="None"
                                        IsVisible="{Binding HasParallelVideo3, Converter={StaticResource InvertedBoolConverter}}" />
                                    <!--  Overlay para scrubbing  -->
                                    <BoxView
                                        BackgroundColor="Transparent"
                                        IsVisible="{Binding HasParallelVideo3}">
                                        <BoxView.GestureRecognizers>
                                            <DropGestureRecognizer AllowDrop="True" Drop="OnDropScreen3" />
                                        </BoxView.GestureRecognizers>
                                    </BoxView>
                                </Grid>
                            </Border>
                        </controls:AspectRatioContainer>
                        <!--  Video 4 (abajo derecha)  -->
                        <controls:AspectRatioContainer Grid.Row="1" Grid.Column="1" AspectRatio="1.777">
                            <Border
                                BackgroundColor="#FF404040"
                                Stroke="Transparent"
                                StrokeShape="RoundRectangle 6">
                                <Border.GestureRecognizers>
                                    <DropGestureRecognizer AllowDrop="True" Drop="OnDropScreen4" />
                                </Border.GestureRecognizers>
                                <Grid>
                                    <!--  PrecisionVideoPlayer para scrubbing preciso (capa inferior)  -->
                                    <appcontrols:PrecisionVideoPlayer
                                        x:Name="PreviewPlayer4Q"
                                        Aspect="AspectFill"
                                        IsMuted="True"
                                        Source="{Binding ParallelVideo4ClipPath}"
                                        IsVisible="False">
                                        <appcontrols:PrecisionVideoPlayer.Triggers>
                                            <MultiTrigger TargetType="appcontrols:PrecisionVideoPlayer">
                                                <MultiTrigger.Conditions>
                                                    <BindingCondition Binding="{Binding HasParallelVideo4}" Value="True" />
                                                    <BindingCondition Binding="{Binding IsPreviewMode}" Value="True" />
                                                </MultiTrigger.Conditions>
                                                <Setter Property="IsVisible" Value="True" />
                                            </MultiTrigger>
                                        </appcontrols:PrecisionVideoPlayer.Triggers>
                                    </appcontrols:PrecisionVideoPlayer>
                                    <!--  Miniatura del vídeo (cuando no está en preview)  -->
                                    <Image
                                        Aspect="AspectFill"
                                        Source="{Binding ParallelVideo4ThumbnailPath}"
                                        IsVisible="{Binding ShowParallelVideo4Thumbnail}" />
                                    <!--  Placeholder cuando no hay vídeo  -->
                                    <Label
                                        HorizontalOptions="Center"
                                        VerticalOptions="Center"
                                        Text="4"
                                        TextColor="#FF888888"
                                        FontSize="{StaticResource FontSizeHeader}"
                                        FontAttributes="None"
                                        IsVisible="{Binding HasParallelVideo4, Converter={StaticResource InvertedBoolConverter}}" />
                                    <!--  Overlay para scrubbing  -->
                                    <BoxView
                                        BackgroundColor="Transparent"
                                        IsVisible="{Binding HasParallelVideo4}">
                                        <BoxView.GestureRecognizers>
                                            <DropGestureRecognizer AllowDrop="True" Drop="OnDropScreen4" />
                                        </BoxView.GestureRecognizers>
                                    </BoxView>
                                </Grid>
                            </Border>
                        </controls:AspectRatioContainer>
                    </Grid>

                    <!--  Botones Reproducir y Limpiar  -->
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="8" IsVisible="{Binding IsQuickAnalysisIsolatedMode, Converter={toolkit:InvertedBoolConverter}}">
                        <Border
                            Padding="10,8"
                            BackgroundColor="#FF404040"
                            Stroke="Transparent"
                            StrokeShape="RoundRectangle 6">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding PlayParallelAnalysisCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout HorizontalOptions="Center" Spacing="6">
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeMedium}"
                                    SymbolName="play.fill"
                                    TintColor="White"
                                    WidthRequest="{StaticResource IconSizeMedium}"
                                    VerticalOptions="Center" />
                                <Label Text="Reproducir" TextColor="White" VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>

                        <Border
                            Grid.Column="1"
                            Padding="10,8"
                            BackgroundColor="#FF404040"
                            Stroke="Transparent"
                            StrokeShape="RoundRectangle 6">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ClearParallelAnalysisCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout HorizontalOptions="Center" Spacing="6">
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeMedium}"
                                    SymbolName="xmark.circle"
                                    TintColor="White"
                                    WidthRequest="{StaticResource IconSizeMedium}"
                                    VerticalOptions="Center" />
                                <Label Text="Limpiar" TextColor="White" VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>
                    </Grid>

                </VerticalStackLayout>


                <!--  Panel de filtros (ahora dentro de Estadísticas)  -->
                <VerticalStackLayout Spacing="12">
                    <VerticalStackLayout.IsVisible>
                        <MultiBinding Converter="{StaticResource AllTrueConverter}">
                            <Binding Path="IsStatsTabSelected" />
                            <Binding Path="IsDiaryViewSelected" Converter="{toolkit:InvertedBoolConverter}" />
                        </MultiBinding>
                    </VerticalStackLayout.IsVisible>
                    <!--  Filtros para Galería General  -->
                    <Border
                        Margin="0,8,0,8"
                        Padding="12"
                        BackgroundColor="Transparent"
                        IsVisible="{Binding IsAllGallerySelected}"
                        Stroke="Transparent"
                        StrokeShape="RoundRectangle 8">
                        <Grid>
                            <!--  Capa principal con los headers de filtros  -->
                            <VerticalStackLayout Spacing="10" ZIndex="1">
                                <HorizontalStackLayout Spacing="8" VerticalOptions="Center">

                                    <controls:SymbolIcon
                                        HeightRequest="{StaticResource IconSizeLarge}"
                                        SymbolName="line.3.horizontal.circle"
                                        TintColor="#FF0066"
                                        VerticalOptions="Center"
                                        WidthRequest="{StaticResource IconSizeLarge}" />
                                    <Label
                                        FontSize="{StaticResource FontSizeHeader}"
                                        Text="Filtros"
                                        TextColor="White" VerticalOptions="Center" />
                                    <Button
                                        Padding="8,4"
                                        BackgroundColor="Transparent"
                                        Command="{Binding ClearFiltersCommand}"
                                        FontSize="{StaticResource FontSizeBody}"
                                        Text="Limpiar"
                                        TextColor="#FF0066"
                                        VerticalOptions="Center" />
                                </HorizontalStackLayout>

                                <!--  Header Lugar  -->
                                <Border
                                    x:Name="PlacesHeader"
                                    Padding="10,8"
                                    BackgroundColor="#FF404040"
                                    Stroke="Transparent"
                                    StrokeShape="RoundRectangle 4">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding TogglePlacesExpandedCommand}" />
                                    </Border.GestureRecognizers>
                                    <Grid ColumnDefinitions="*,Auto">
                                        <VerticalStackLayout Grid.Column="0">
                                            <Label
                                                FontSize="{StaticResource FontSizeSubtitle}"
                                                Text="Lugar"
                                                TextColor="#FFCCCCCC" />
                                            <Label
                                                FontSize="{StaticResource FontSizeSubtitle}"
                                                Text="{Binding SelectedPlacesSummary}"
                                                TextColor="White" />
                                        </VerticalStackLayout>
                                        <Label
                                            Grid.Column="1"
                                            FontSize="{StaticResource FontSizeSubtitle}"
                                            Text="{Binding IsPlacesExpanded, Converter={StaticResource BoolToExpandIconConverter}}"
                                            TextColor="Gray"
                                            VerticalOptions="Center" />
                                    </Grid>
                                </Border>

                                <!--  Header Deportista  -->
                                <Border
                                    x:Name="AthletesHeader"
                                    Padding="10,8"
                                    BackgroundColor="#FF404040"
                                    Stroke="Transparent"
                                    StrokeShape="RoundRectangle 4">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding ToggleAthletesExpandedCommand}" />
                                    </Border.GestureRecognizers>
                                    <Grid ColumnDefinitions="*,Auto">
                                        <VerticalStackLayout Grid.Column="0">
                                            <Label
                                                FontSize="{StaticResource FontSizeSubtitle}"
                                                Text="Deportista"
                                                TextColor="#FFCCCCCC" />
                                            <Label
                                                FontSize="{StaticResource FontSizeSubtitle}"
                                                Text="{Binding SelectedAthletesSummary}"
                                                TextColor="White" />
                                        </VerticalStackLayout>
                                        <Label
                                            Grid.Column="1"
                                            FontSize="{StaticResource FontSizeSubtitle}"
                                            Text="{Binding IsAthletesExpanded, Converter={StaticResource BoolToExpandIconConverter}}"
                                            TextColor="Gray"
                                            VerticalOptions="Center" />
                                    </Grid>
                                </Border>

                                <!--  Header Sección  -->
                                <Border
                                    x:Name="SectionsHeader"
                                    Padding="10,8"
                                    BackgroundColor="#FF404040"
                                    Stroke="Transparent"
                                    StrokeShape="RoundRectangle 4">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding ToggleSectionsExpandedCommand}" />
                                    </Border.GestureRecognizers>
                                    <Grid ColumnDefinitions="*,Auto">
                                        <VerticalStackLayout Grid.Column="0">
                                            <Label
                                                FontSize="{StaticResource FontSizeSubtitle}"
                                                Text="Sección"
                                                TextColor="#FFCCCCCC" />
                                            <Label
                                                FontSize="{StaticResource FontSizeSubtitle}"
                                                Text="{Binding SelectedSectionsSummary}"
                                                TextColor="White" />
                                        </VerticalStackLayout>
                                        <Label
                                            Grid.Column="1"
                                            FontSize="{StaticResource FontSizeSubtitle}"
                                            Text="{Binding IsSectionsExpanded, Converter={StaticResource BoolToExpandIconConverter}}"
                                            TextColor="Gray"
                                            VerticalOptions="Center" />
                                    </Grid>
                                </Border>

                                <!--  Header Tag  -->
                                <Border
                                    x:Name="TagsHeader"
                                    Padding="10,8"
                                    BackgroundColor="#FF404040"
                                    Stroke="Transparent"
                                    StrokeShape="RoundRectangle 4">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding ToggleTagsExpandedCommand}" />
                                    </Border.GestureRecognizers>
                                    <Grid ColumnDefinitions="*,Auto">
                                        <VerticalStackLayout Grid.Column="0">
                                            <Label
                                                FontFamily="{StaticResource AppFontBody}"
                                                FontSize="{StaticResource FontSizeSubtitle}"
                                                Text="Tag"
                                                TextColor="#FFCCCCCC" />
                                            <Label
                                                FontFamily="{StaticResource AppFontBody}"
                                                FontSize="{StaticResource FontSizeSubtitle}"
                                                Text="{Binding SelectedTagsSummary}"
                                                TextColor="White" />
                                        </VerticalStackLayout>
                                        <Label
                                            Grid.Column="1"
                                            FontSize="{StaticResource FontSizeSubtitle}"
                                            Text="{Binding IsTagsExpanded, Converter={StaticResource BoolToExpandIconConverter}}"
                                            TextColor="Gray"
                                            VerticalOptions="Center" />
                                    </Grid>
                                </Border>
                                <Grid ColumnDefinitions="*,*" ColumnSpacing="12">
                                    <!--  Fecha desde  -->
                                    <VerticalStackLayout Grid.Column="0" Spacing="4">
                                        <Label
                                            FontSize="{StaticResource FontSizeSubtitle}"
                                            Text="Fecha desde"
                                            TextColor="#FFCCCCCC" />
                                        <Border
                                            StrokeShape="RoundRectangle 4"
                                            Stroke="Transparent"
                                            HorizontalOptions="Fill">
                                            <Border.Padding>
                                                <OnPlatform x:TypeArguments="Thickness">
                                                    <On Platform="WinUI" Value="0" />
                                                    <On Platform="Default" Value="12,12,0,-6" />
                                                </OnPlatform>
                                            </Border.Padding>
                                            <Border.BackgroundColor>
                                                <OnPlatform x:TypeArguments="Color">
                                                    <On Platform="WinUI" Value="Transparent" />
                                                    <On Platform="Default" Value="#FF2A2A2A" />
                                                </OnPlatform>
                                            </Border.BackgroundColor>
                                            <DatePicker
                                                Date="{Binding SelectedFilterDateFrom}"
                                                TextColor="White"
                                                BackgroundColor="Transparent"
                                                HorizontalOptions="Fill"
                                                VerticalOptions="Fill" />
                                        </Border>
                                    </VerticalStackLayout>

                                    <!--  Fecha hasta  -->
                                    <VerticalStackLayout Grid.Column="1" Spacing="4">
                                        <Label
                                            FontSize="{StaticResource FontSizeSubtitle}"
                                            Text="Fecha hasta"
                                            TextColor="#FFCCCCCC" />
                                        <Border
                                            StrokeShape="RoundRectangle 4"
                                            Stroke="Transparent"
                                            HorizontalOptions="Fill">
                                            <Border.Padding>
                                                <OnPlatform x:TypeArguments="Thickness">
                                                    <On Platform="WinUI" Value="0" />
                                                    <On Platform="Default" Value="12,12,0,-6" />
                                                </OnPlatform>
                                            </Border.Padding>
                                            <Border.BackgroundColor>
                                                <OnPlatform x:TypeArguments="Color">
                                                    <On Platform="WinUI" Value="Transparent" />
                                                    <On Platform="Default" Value="#FF2A2A2A" />
                                                </OnPlatform>
                                            </Border.BackgroundColor>
                                            <DatePicker
                                                Date="{Binding SelectedFilterDateTo}"
                                                TextColor="White"
                                                BackgroundColor="Transparent"
                                                HorizontalOptions="Fill"
                                                VerticalOptions="Center" />
                                        </Border>
                                    </VerticalStackLayout>
                                </Grid>
                            </VerticalStackLayout>

                            <!--  Capa de overlay para dropdowns flotantes  -->
                            <!--  Dropdown Lugar  -->
                            <Border
                                Margin="0,114,0,0"
                                Padding="8"
                                BackgroundColor="#FF404040"
                                HorizontalOptions="Fill"
                                IsVisible="{Binding IsPlacesExpanded}"
                                Stroke="Transparent"
                                StrokeShape="RoundRectangle 4"
                                StrokeThickness="1"
                                VerticalOptions="Start"
                                ZIndex="100" HeightRequest="280">
                                <ScrollView HeightRequest="280">
                                    <FlexLayout
                                        BindableLayout.ItemsSource="{Binding FilterPlaces}"
                                        Direction="Row"
                                        Wrap="Wrap"
                                        AlignItems="Start"
                                        AlignContent="Start">
                                        <BindableLayout.ItemTemplate>
                                            <DataTemplate x:DataType="models:PlaceFilterItem">
                                                <Border
                                                    Margin="0,2,2,0"
                                                    Padding="12,5" HeightRequest="38"
                                                    BackgroundColor="{Binding IsSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF4A9FD4|#FF1E1E1E'}"
                                                    Stroke="{Binding IsSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF4A9FD4|#FF3A3A3A'}"
                                                    StrokeShape="RoundRectangle 4">
                                                    <Border.GestureRecognizers>
                                                        <TapGestureRecognizer
                                                            Command="{Binding BindingContext.ToggleFilterItemCommand, Source={x:Reference ThisPage}}"
                                                            CommandParameter="{Binding .}" />
                                                    </Border.GestureRecognizers>
                                                    <Label
                                                        FontFamily="{StaticResource AppFontBody}"
                                                        FontSize="{StaticResource FontSizeSubtitle}"
                                                        Text="{Binding DisplayName}"
                                                        TextColor="White"
                                                        VerticalOptions="Center" />
                                                </Border>
                                            </DataTemplate>
                                        </BindableLayout.ItemTemplate>
                                    </FlexLayout>
                                </ScrollView>
                            </Border>

                            <!--  Dropdown Deportista  -->
                            <Border
                                Margin="0,180,0,0"
                                Padding="8"
                                BackgroundColor="#FF404040"
                                HorizontalOptions="Fill"
                                IsVisible="{Binding IsAthletesExpanded}"
                                Stroke="Transparent"
                                StrokeShape="RoundRectangle 4"
                                StrokeThickness="1"
                                VerticalOptions="Start"
                                ZIndex="100" HeightRequest="280">
                                <ScrollView HeightRequest="280">
                                    <FlexLayout
                                        BindableLayout.ItemsSource="{Binding FilterAthletes}"
                                        Direction="Row"
                                        Wrap="Wrap"
                                        AlignItems="Start"
                                        AlignContent="Start">
                                        <BindableLayout.ItemTemplate>
                                            <DataTemplate x:DataType="models:AthleteFilterItem">
                                                <Border
                                                    Margin="0,2,2,0"
                                                    Padding="12,5" HeightRequest="38"
                                                    BackgroundColor="{Binding IsSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF4A9FD4|#FF1E1E1E'}"
                                                    Stroke="{Binding IsSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF4A9FD4|#FF3A3A3A'}"
                                                    StrokeShape="RoundRectangle 4">
                                                    <Border.GestureRecognizers>
                                                        <TapGestureRecognizer
                                                            Command="{Binding BindingContext.ToggleFilterItemCommand, Source={x:Reference ThisPage}}"
                                                            CommandParameter="{Binding .}" />
                                                    </Border.GestureRecognizers>
                                                    <Label
                                                        FontFamily="{StaticResource AppFontBody}"
                                                        FontSize="{StaticResource FontSizeSubtitle}"
                                                        Text="{Binding DisplayName}"
                                                        TextColor="White"
                                                        VerticalOptions="Center" />
                                                </Border>
                                            </DataTemplate>
                                        </BindableLayout.ItemTemplate>
                                    </FlexLayout>
                                </ScrollView>
                            </Border>

                            <!--  Dropdown Sección  -->
                            <Border
                                Margin="0,244,0,0"
                                Padding="8"
                                BackgroundColor="#FF404040"
                                HorizontalOptions="Fill"
                                IsVisible="{Binding IsSectionsExpanded}"
                                Stroke="Transparent"
                                StrokeShape="RoundRectangle 4"
                                StrokeThickness="1"
                                VerticalOptions="Start"
                                ZIndex="100" HeightRequest="280">
                                <ScrollView HeightRequest="280">
                                    <FlexLayout
                                        BindableLayout.ItemsSource="{Binding FilterSections}"
                                        Direction="Row"
                                        Wrap="Wrap"
                                        AlignItems="Start"
                                        AlignContent="Start">
                                        <BindableLayout.ItemTemplate>
                                            <DataTemplate x:DataType="models:SectionFilterItem">
                                                <Border
                                                    Margin="0,2,2,0"
                                                    Padding="12,5" HeightRequest="38"
                                                    BackgroundColor="{Binding IsSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF4A9FD4|#FF1E1E1E'}"
                                                    Stroke="{Binding IsSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF4A9FD4|#FF3A3A3A'}"
                                                    StrokeShape="RoundRectangle 4">
                                                    <Border.GestureRecognizers>
                                                        <TapGestureRecognizer
                                                            Command="{Binding BindingContext.ToggleFilterItemCommand, Source={x:Reference ThisPage}}"
                                                            CommandParameter="{Binding .}" />
                                                    </Border.GestureRecognizers>
                                                    <Label
                                                        FontFamily="{StaticResource AppFontBody}"
                                                        FontSize="{StaticResource FontSizeSubtitle}"
                                                        Text="{Binding DisplayName}"
                                                        TextColor="White"
                                                        VerticalOptions="Center" />
                                                </Border>
                                            </DataTemplate>
                                        </BindableLayout.ItemTemplate>
                                    </FlexLayout>
                                </ScrollView>
                            </Border>

                            <!--  Dropdown Tag  -->
                            <Border
                                Margin="0,310,0,0"
                                Padding="8"
                                BackgroundColor="#FF404040"
                                HorizontalOptions="Fill"
                                IsVisible="{Binding IsTagsExpanded}"
                                Stroke="Transparent"
                                StrokeShape="RoundRectangle 4"
                                StrokeThickness="1"
                                VerticalOptions="Start"
                                ZIndex="100" HeightRequest="280">
                                <ScrollView HeightRequest="280">
                                    <FlexLayout
                                        BindableLayout.ItemsSource="{Binding FilterTagItems}"
                                        Direction="Row"
                                        Wrap="Wrap"
                                        AlignItems="Start"
                                        AlignContent="Start">
                                        <BindableLayout.ItemTemplate>
                                            <DataTemplate x:DataType="models:TagFilterItem">
                                                <Border
                                                    Margin="0,2,2,0"
                                                    Padding="12,5" HeightRequest="38"
                                                    BackgroundColor="{Binding IsSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF4A9FD4|#FF1E1E1E'}"
                                                    Stroke="{Binding IsSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF4A9FD4|#FF3A3A3A'}"
                                                    StrokeShape="RoundRectangle 4">
                                                    <Border.GestureRecognizers>
                                                        <TapGestureRecognizer
                                                            Command="{Binding BindingContext.ToggleFilterItemCommand, Source={x:Reference ThisPage}}"
                                                            CommandParameter="{Binding .}" />
                                                    </Border.GestureRecognizers>
                                                    <Label
                                                        FontFamily="{StaticResource AppFontBody}"
                                                        FontSize="{StaticResource FontSizeSubtitle}"
                                                        Text="{Binding DisplayName}"
                                                        TextColor="White"
                                                        VerticalOptions="Center" />
                                                </Border>
                                            </DataTemplate>
                                        </BindableLayout.ItemTemplate>
                                    </FlexLayout>
                                </ScrollView>
                            </Border>
                        </Grid>
                    </Border>
                </VerticalStackLayout>

                <!--  Vista actual de estadísticas  -->
                <VerticalStackLayout Spacing="12">
                    <VerticalStackLayout.IsVisible>
                        <MultiBinding Converter="{StaticResource AllTrueConverter}">
                            <Binding Path="IsStatsTabSelected" />
                            <Binding Path="IsDiaryViewSelected" Converter="{toolkit:InvertedBoolConverter}" />
                        </MultiBinding>
                    </VerticalStackLayout.IsVisible>
                <HorizontalStackLayout Spacing="12" VerticalOptions="Center">
                    <controls:SymbolIcon
                        HeightRequest="{StaticResource IconSizeLarge}"
                        SymbolName="chart.pie"
                        TintColor="#FF0066"
                        VerticalOptions="Center"
                        WidthRequest="{StaticResource IconSizeLarge}" />
                    <Label
                        FontSize="{StaticResource FontSizeHeader}"
                        Text="Datos y Estadísticas"
                        TextColor="White" />
                </HorizontalStackLayout>

                <!--  ===== ESTADÍSTICAS =====  -->
                <VerticalStackLayout Spacing="12">

                <Label
                    FontSize="{StaticResource FontSizeBody}"
                    LineBreakMode="TailTruncation"
                    Text="{Binding SelectedSessionTitle}"
                    TextColor="#FFCCCCCC" />

                <!--  RESUMEN PRINCIPAL  -->
                <Grid ColumnDefinitions="*,*,*" ColumnSpacing="8">
                    <!--  Número de vídeos  -->
                    <Border
                        Padding="12"
                        BackgroundColor="#FF404040"
                        StrokeShape="RoundRectangle 10"
                        StrokeThickness="0">
                        <VerticalStackLayout HorizontalOptions="Center" Spacing="4">
                            <Label
                                FontAttributes="None"
                                FontSize="{StaticResource FontSizeHeader}"
                                HorizontalOptions="Center"
                                Text="{Binding TotalFilteredVideoCount}"
                                TextColor="#FF0066" />
                            <Label
                                FontSize="{StaticResource FontSizeSmall}"
                                HorizontalOptions="Center"
                                Text="Vídeos"
                                TextColor="#FFCCCCCC" />
                        </VerticalStackLayout>
                    </Border>
                    <!--  Tiempo Total  -->
                    <Border
                        Grid.Column="1"
                        Padding="12"
                        BackgroundColor="#FF404040"
                        StrokeShape="RoundRectangle 10"
                        StrokeThickness="0">
                        <VerticalStackLayout HorizontalOptions="Center" Spacing="4">
                            <Label
                                FontAttributes="None"
                                FontSize="{StaticResource FontSizeHeader}"
                                HorizontalOptions="Center"
                                Text="{Binding SelectedSessionTotalDurationFormatted}"
                                TextColor="White" />
                            <Label
                                FontSize="{StaticResource FontSizeSmall}"
                                HorizontalOptions="Center"
                                Text="Tiempo"
                                TextColor="#FFCCCCCC" />
                        </VerticalStackLayout>
                    </Border>
                    <!--  Sesiones  -->
                    <Border
                        Grid.Column="2"
                        Padding="12"
                        BackgroundColor="#FF404040"
                        StrokeShape="RoundRectangle 10"
                        StrokeThickness="0">
                        <VerticalStackLayout HorizontalOptions="Center" Spacing="4">
                            <Label
                                FontAttributes="None"
                                FontSize="{StaticResource FontSizeHeader}"
                                HorizontalOptions="Center"
                                Text="{Binding Stats.TotalSessions}"
                                TextColor="White" />
                            <Label
                                FontSize="{StaticResource FontSizeSmall}"
                                HorizontalOptions="Center"
                                Text="Sesiones"
                                TextColor="#FFCCCCCC" />
                        </VerticalStackLayout>
                    </Border>
                </Grid>

                <!--  ===== TABLA DE TIEMPOS POR SECCIÓN =====  -->
                <VerticalStackLayout IsVisible="{Binding ShowSectionTimesTable}" Spacing="8" Margin="0,16,0,0">
                    <!--  Cabecera con título, botón expandir y toggle  -->
                    <Grid ColumnDefinitions="Auto,Auto,*,Auto" ColumnSpacing="8">
                        <Label
                            FontAttributes="None"
                            FontSize="{StaticResource FontSizeSubtitle}"
                            Text="⏱ Tiempos por Sección"
                            TextColor="White"
                            VerticalOptions="Center" />
                        
                        <!--  Botón para abrir tabla detallada  -->
                        <Border
                            Grid.Column="1"
                            Padding="8,4"
                            BackgroundColor="#FF404040"
                            StrokeShape="RoundRectangle 4"
                            StrokeThickness="0"
                            VerticalOptions="Center">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding OpenDetailedTimesPopupCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="4">
                                <controls:SymbolIcon
                                    HeightRequest="14"
                                    SymbolName="arrow.up.left.and.arrow.down.right"
                                    TintColor="#FF0066"
                                    WidthRequest="14"
                                    VerticalOptions="Center" />
                                <Label
                                    FontSize="{StaticResource FontSizeSmall}"
                                    Text="Abrir"
                                    TextColor="#FF0066"
                                    VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>
                        
                        <!--  Toggle entre Tiempos y Diferencias  -->
                        <Grid Grid.Column="3" ColumnDefinitions="Auto,Auto" ColumnSpacing="4" IsVisible="{Binding HasReferenceAthlete}">
                            <!--  Botón Tiempos  -->
                            <Border
                                Padding="16,6"
                                BackgroundColor="{Binding ShowSectionTimesAbsolute, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF2A2A2A,#FF1A1A1A'}"
                                StrokeShape="RoundRectangle 4"
                                StrokeThickness="0"
                                MinimumWidthRequest="80">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ToggleSectionTimesViewCommand}" />
                                </Border.GestureRecognizers>
                                <Label
                                    FontSize="{StaticResource FontSizeSmall}"
                                    Text="Tiempos"
                                    HorizontalOptions="Center"
                                    TextColor="White" />
                            </Border>
                            <!--  Botón Diferencias  -->
                            <Border
                                Grid.Column="1"
                                Padding="16,6"
                                BackgroundColor="{Binding ShowSectionTimesDifferences, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF2A2A2A,#FF1A1A1A'}"
                                StrokeShape="RoundRectangle 4"
                                StrokeThickness="0"
                                MinimumWidthRequest="80">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ToggleSectionTimesViewCommand}" />
                                </Border.GestureRecognizers>
                                <Label
                                    FontSize="{StaticResource FontSizeSmall}"
                                    Text="vs Tú"
                                    HorizontalOptions="Center"
                                    TextColor="White" />
                            </Border>
                        </Grid>
                    </Grid>
                    
                    <!--  Iteramos por cada sección  -->
                    <VerticalStackLayout Spacing="12">
                        <BindableLayout.ItemsSource>
                            <Binding Path="SectionTimes" />
                        </BindableLayout.ItemsSource>
                        <BindableLayout.ItemTemplate>
                            <DataTemplate x:DataType="services:SectionWithAthleteRows">
                                <Border
                                    Padding="8"
                                    BackgroundColor="#FF1A1A1A"
                                    StrokeShape="RoundRectangle 8"
                                    StrokeThickness="0">
                                    <VerticalStackLayout Spacing="6">
                                        <!--  Nombre de la sección  -->
                                        <Label
                                            FontAttributes="None"
                                            FontSize="{StaticResource FontSizeBody}"
                                            Text="{Binding SectionName}"
                                            TextColor="#FF0066" />
                                        
                                        <!--  ===== VISTA TIEMPOS ABSOLUTOS =====  -->
                                        <VerticalStackLayout Spacing="4" IsVisible="{Binding Source={x:Reference ThisPage}, Path=BindingContext.ShowSectionTimesAbsolute}">
                                            <!--  Cabecera de tabla (absoluta)  -->
                                            <Grid ColumnDefinitions="2*,*,*,*,*" ColumnSpacing="4" Padding="4,2" BackgroundColor="#FF252525">
                                                <Label Grid.Column="0" FontSize="{StaticResource FontSizeSmall}" FontAttributes="None" Text="ATLETA" TextColor="#FFCCCCCC" />
                                                <Label Grid.Column="1" FontSize="{StaticResource FontSizeSmall}" FontAttributes="None" Text="CAT." TextColor="#FFCCCCCC" />
                                                <Label Grid.Column="2" FontSize="{StaticResource FontSizeSmall}" FontAttributes="None" Text="TIEMPO" TextColor="#FFCCCCCC" HorizontalTextAlignment="End" />
                                                <Label Grid.Column="3" FontSize="{StaticResource FontSizeSmall}" FontAttributes="None" Text="PENAL." TextColor="#FFCCCCCC" HorizontalTextAlignment="End" />
                                                <Label Grid.Column="4" FontSize="{StaticResource FontSizeSmall}" FontAttributes="None" Text="TOTAL" TextColor="#FFCCCCCC" HorizontalTextAlignment="End" />
                                            </Grid>
                                            
                                            <!--  Filas de atletas (tiempos absolutos)  -->
                                            <VerticalStackLayout Spacing="2">
                                                <BindableLayout.ItemsSource>
                                                    <Binding Path="Athletes" />
                                                </BindableLayout.ItemsSource>
                                                <BindableLayout.ItemTemplate>
                                                    <DataTemplate x:DataType="services:AthleteSectionTimeRow">
                                                        <Grid ColumnDefinitions="2*,*,*,*,*" ColumnSpacing="4" Padding="4,3" BackgroundColor="{Binding RowBackgroundColor}">
                                                            <Label Grid.Column="0" FontSize="{StaticResource FontSizeSmall}" Text="{Binding AthleteName}" TextColor="White" LineBreakMode="TailTruncation" VerticalOptions="Center" />
                                                            <Label Grid.Column="1" FontSize="{StaticResource FontSizeSmall}" Text="{Binding CategoryName}" TextColor="#FF808080" LineBreakMode="TailTruncation" VerticalOptions="Center" />
                                                            <Label Grid.Column="2" FontSize="{StaticResource FontSizeSmall}" Text="{Binding DurationFormatted}" TextColor="#FF4CAF50" HorizontalTextAlignment="End" VerticalOptions="Center" />
                                                            <Label Grid.Column="3" FontSize="{StaticResource FontSizeSmall}" Text="{Binding PenaltyFormatted}" TextColor="#FFFF6B6B" HorizontalTextAlignment="End" VerticalOptions="Center" />
                                                            <Label Grid.Column="4" FontSize="{StaticResource FontSizeSmall}" FontAttributes="None" Text="{Binding TotalFormatted}" TextColor="#FFFFD700" HorizontalTextAlignment="End" VerticalOptions="Center" />
                                                        </Grid>
                                                    </DataTemplate>
                                                </BindableLayout.ItemTemplate>
                                            </VerticalStackLayout>
                                        </VerticalStackLayout>
                                        
                                        <!--  ===== VISTA DIFERENCIAS =====  -->
                                        <VerticalStackLayout Spacing="4" IsVisible="{Binding Source={x:Reference ThisPage}, Path=BindingContext.ShowSectionTimesDifferences}">
                                            <!--  Cabecera de tabla (diferencias)  -->
                                            <Grid ColumnDefinitions="2*,*,*,*" ColumnSpacing="4" Padding="4,2" BackgroundColor="#FF252525">
                                                <Label Grid.Column="0" FontSize="{StaticResource FontSizeSmall}" FontAttributes="None" Text="ATLETA" TextColor="#FFCCCCCC" />
                                                <Label Grid.Column="1" FontSize="{StaticResource FontSizeSmall}" FontAttributes="None" Text="CAT." TextColor="#FFCCCCCC" />
                                                <Label Grid.Column="2" FontSize="{StaticResource FontSizeSmall}" FontAttributes="None" Text="TOTAL" TextColor="#FFCCCCCC" HorizontalTextAlignment="End" />
                                                <Label Grid.Column="3" FontSize="{StaticResource FontSizeSmall}" FontAttributes="None" Text="vs TÚ" TextColor="#FFCCCCCC" HorizontalTextAlignment="End" />
                                            </Grid>
                                            
                                            <!--  Filas de atletas (diferencias)  -->
                                            <VerticalStackLayout Spacing="2">
                                                <BindableLayout.ItemsSource>
                                                    <Binding Path="Athletes" />
                                                </BindableLayout.ItemsSource>
                                                <BindableLayout.ItemTemplate>
                                                    <DataTemplate x:DataType="services:AthleteSectionTimeRow">
                                                        <Grid ColumnDefinitions="2*,*,*,*" ColumnSpacing="4" Padding="4,3" BackgroundColor="{Binding RowBackgroundColor}">
                                                            <Label Grid.Column="0" FontSize="{StaticResource FontSizeSmall}" Text="{Binding AthleteName}" TextColor="White" LineBreakMode="TailTruncation" VerticalOptions="Center" FontAttributes="{Binding IsReferenceAthlete, Converter={StaticResource BoolToFontAttributesConverter}}" />
                                                            <Label Grid.Column="1" FontSize="{StaticResource FontSizeSmall}" Text="{Binding CategoryName}" TextColor="#FF808080" LineBreakMode="TailTruncation" VerticalOptions="Center" />
                                                            <Label Grid.Column="2" FontSize="{StaticResource FontSizeSmall}" Text="{Binding TotalFormatted}" TextColor="#FFFFD700" HorizontalTextAlignment="End" VerticalOptions="Center" />
                                                            <Label Grid.Column="3" FontSize="{StaticResource FontSizeSmall}" FontAttributes="None" Text="{Binding DifferenceFormatted}" TextColor="{Binding DifferenceColor}" HorizontalTextAlignment="End" VerticalOptions="Center" />
                                                        </Grid>
                                                    </DataTemplate>
                                                </BindableLayout.ItemTemplate>
                                            </VerticalStackLayout>
                                        </VerticalStackLayout>
                                        
                                    </VerticalStackLayout>
                                </Border>
                            </DataTemplate>
                        </BindableLayout.ItemTemplate>
                    </VerticalStackLayout>
                </VerticalStackLayout>

                <!--  VÍDEOS ETIQUETADOS  -->
                <Border
                    Padding="12"
                    BackgroundColor="#FF1F1F1F"
                    StrokeShape="RoundRectangle 10"
                    StrokeThickness="0">
                    <Grid ColumnDefinitions="*,Auto">
                        <VerticalStackLayout Spacing="4">
                            <Label
                                FontSize="{StaticResource FontSizeBody}"
                                Text="Vídeos etiquetados/nombrados"
                                TextColor="White" />
                            <Label
                                FontSize="{StaticResource FontSizeSmall}"
                                Text="{Binding LabeledVideosText, StringFormat='{0} vídeos con nombre asignado'}"
                                TextColor="#FFCCCCCC" />
                        </VerticalStackLayout>
                        <Label
                            Grid.Column="1"
                            FontAttributes="None"
                            FontSize="{StaticResource FontSizeTitle}"
                            Text="{Binding LabeledVideosPercentage, StringFormat='{0:F0}%'}"
                            TextColor="#FF0066"
                            VerticalOptions="Center" />
                    </Grid>
                </Border>

                <!--  TAGS DE EVENTOS  -->
                <Label
                    FontSize="{StaticResource FontSizeBody}"
                    Text="Tags de eventos"
                    TextColor="#FFCCCCCC" />
                <Grid ColumnDefinitions="*,*" ColumnSpacing="8">
                    <Border
                        Padding="10"
                        BackgroundColor="#FF404040"
                        StrokeShape="RoundRectangle 8"
                        StrokeThickness="0">
                        <HorizontalStackLayout Spacing="8">
                            <Label
                                FontAttributes="None"
                                FontSize="{StaticResource FontSizeTitle}"
                                Text="{Binding TotalEventTagsCount}"
                                TextColor="White"
                                VerticalOptions="Center" />
                            <Label
                                FontSize="{StaticResource FontSizeSmall}"
                                Text="eventos totales"
                                TextColor="#FF808080"
                                VerticalOptions="Center" />
                        </HorizontalStackLayout>
                    </Border>
                    <Border
                        Grid.Column="1"
                        Padding="10"
                        BackgroundColor="#FF404040"
                        StrokeShape="RoundRectangle 8"
                        StrokeThickness="0">
                        <HorizontalStackLayout Spacing="8">
                            <Label
                                FontAttributes="None"
                                FontSize="{StaticResource FontSizeTitle}"
                                Text="{Binding TotalUniqueEventTagsCount}"
                                TextColor="White"
                                VerticalOptions="Center" />
                            <Label
                                FontSize="{StaticResource FontSizeSmall}"
                                Text="tipos únicos"
                                TextColor="#FF808080"
                                VerticalOptions="Center" />
                        </HorizontalStackLayout>
                    </Border>
                </Grid>

                <!--  TOP EVENTOS MÁS USADOS  -->
                <Label
                    FontSize="{StaticResource FontSizeBody}"
                    Margin="0,4,0,0"
                    Text="Eventos más utilizados"
                    TextColor="#FF808080" />
                <controls:SimplePieChart
                    MinimumHeightRequest="120"
                    HorizontalOptions="Fill"
                    VerticalOptions="FillAndExpand"
                    Labels="{Binding TopEventTagNames}"
                    ShowLegend="True"
                    TextColor="White"
                    Values="{Binding TopEventTagValues}" />

                <!--  ETIQUETAS  -->
                <Label
                    FontSize="{StaticResource FontSizeBody}"
                    Text="Etiquetas"
                    TextColor="#FFCCCCCC" />
                <Grid ColumnDefinitions="*,*,*" ColumnSpacing="8">
                    <Border
                        Padding="10"
                        BackgroundColor="#FF404040"
                        StrokeShape="RoundRectangle 8"
                        StrokeThickness="0">
                        <VerticalStackLayout HorizontalOptions="Center" Spacing="2">
                            <Label
                                FontAttributes="None"
                                FontSize="{StaticResource FontSizeSubtitle}"
                                HorizontalOptions="Center"
                                Text="{Binding TotalLabelTagsCount}"
                                TextColor="White" />
                            <Label
                                FontSize="{StaticResource FontSizeCaption}"
                                HorizontalOptions="Center"
                                Text="asignadas"
                                TextColor="#FF808080" />
                        </VerticalStackLayout>
                    </Border>
                    <Border
                        Grid.Column="1"
                        Padding="10"
                        BackgroundColor="#FF404040"
                        StrokeShape="RoundRectangle 8"
                        StrokeThickness="0">
                        <VerticalStackLayout HorizontalOptions="Center" Spacing="2">
                            <Label
                                FontAttributes="None"
                                FontSize="{StaticResource FontSizeSubtitle}"
                                HorizontalOptions="Center"
                                Text="{Binding TotalUniqueLabelTagsCount}"
                                TextColor="White" />
                            <Label
                                FontSize="{StaticResource FontSizeCaption}"
                                HorizontalOptions="Center"
                                Text="únicas"
                                TextColor="#FF808080" />
                        </VerticalStackLayout>
                    </Border>
                    <Border
                        Grid.Column="2"
                        Padding="10"
                        BackgroundColor="#FF404040"
                        StrokeShape="RoundRectangle 8"
                        StrokeThickness="0">
                        <VerticalStackLayout HorizontalOptions="Center" Spacing="2">
                            <Label
                                FontAttributes="None"
                                FontSize="{StaticResource FontSizeSubtitle}"
                                HorizontalOptions="Center"
                                Text="{Binding AvgTagsPerSession, StringFormat='{0:F1}'}"
                                TextColor="White" />
                            <Label
                                FontSize="{StaticResource FontSizeCaption}"
                                HorizontalOptions="Center"
                                Text="por sesión"
                                TextColor="#FF808080" />
                        </VerticalStackLayout>
                    </Border>
                </Grid>

                <!--  TOP ETIQUETAS MÁS USADAS (GRÁFICO CIRCULAR)  -->
                <Label
                    FontSize="{StaticResource FontSizeBody}"
                    Margin="0,4,0,0"
                    Text="Etiquetas más utilizadas"
                    TextColor="#FF808080" />
                <controls:SimplePieChart
                    MinimumHeightRequest="120"
                    HorizontalOptions="Fill"
                    VerticalOptions="FillAndExpand"
                    Labels="{Binding TopLabelTagNames}"
                    ShowLegend="True"
                    TextColor="White"
                    Values="{Binding TopLabelTagValues}" />

                </VerticalStackLayout>

                </VerticalStackLayout>

                <!--  ===== PESTAÑA: DIARIO DE SESIÓN =====  -->
                <VerticalStackLayout Spacing="16">
                    <VerticalStackLayout.IsVisible>
                        <MultiBinding Converter="{StaticResource AllTrueConverter}">
                            <Binding Path="IsDiaryTabSelected" />
                            <Binding Path="IsDiaryViewSelected" Converter="{toolkit:InvertedBoolConverter}" />
                        </MultiBinding>
                    </VerticalStackLayout.IsVisible>
                    
                    <!--  Título  -->
                    <Label
                        FontAttributes="None"
                        FontSize="{StaticResource FontSizeTitle}"
                        Text="Diario de Sesión"
                        TextColor="White" />
                    
                    <!--  ===== VISTA DE RESULTADOS (cuando hay datos guardados y no está editando) =====  -->
                    <Border
                        Padding="16"
                        BackgroundColor="#FF1E1E1E"
                        StrokeShape="RoundRectangle 12"
                        StrokeThickness="0"
                        IsVisible="{Binding ShowDiaryResults}">
                        <VerticalStackLayout Spacing="16">
                            <Label
                                FontAttributes="None"
                                FontSize="{StaticResource FontSizeBody}"
                                Text="Tu valoración de esta sesión"
                                TextColor="White" />
                            
                            <!--  Resultados de valoración  -->
                            <Grid ColumnDefinitions="*,*,*" ColumnSpacing="12">
                                <!--  Físico  -->
                                <Border
                                    Padding="12"
                                    BackgroundColor="#FF2A2A2A"
                                    StrokeShape="RoundRectangle 8"
                                    StrokeThickness="0">
                                    <VerticalStackLayout Spacing="4" HorizontalOptions="Center">
                                        <Label
                                            FontAttributes="None"
                                            FontSize="{StaticResource FontSizeHeader}"
                                            HorizontalOptions="Center"
                                            Text="{Binding DiaryValoracionFisica}"
                                            TextColor="#FF8DD3C7" />
                                        <Label
                                            FontSize="{StaticResource FontSizeSmall}"
                                            HorizontalOptions="Center"
                                            Text="Físico"
                                            TextColor="#FF808080" />
                                    </VerticalStackLayout>
                                </Border>
                                
                                <!--  Mental  -->
                                <Border
                                    Grid.Column="1"
                                    Padding="12"
                                    BackgroundColor="#FF2A2A2A"
                                    StrokeShape="RoundRectangle 8"
                                    StrokeThickness="0">
                                    <VerticalStackLayout Spacing="4" HorizontalOptions="Center">
                                        <Label
                                            FontAttributes="None"
                                            FontSize="{StaticResource FontSizeHeader}"
                                            HorizontalOptions="Center"
                                            Text="{Binding DiaryValoracionMental}"
                                            TextColor="#FFFFED6F" />
                                        <Label
                                            FontSize="{StaticResource FontSizeSmall}"
                                            HorizontalOptions="Center"
                                            Text="Mental"
                                            TextColor="#FF808080" />
                                    </VerticalStackLayout>
                                </Border>
                                
                                <!--  Técnico  -->
                                <Border
                                    Grid.Column="2"
                                    Padding="12"
                                    BackgroundColor="#FF2A2A2A"
                                    StrokeShape="RoundRectangle 8"
                                    StrokeThickness="0">
                                    <VerticalStackLayout Spacing="4" HorizontalOptions="Center">
                                        <Label
                                            FontAttributes="None"
                                            FontSize="{StaticResource FontSizeHeader}"
                                            HorizontalOptions="Center"
                                            Text="{Binding DiaryValoracionTecnica}"
                                            TextColor="#FFBEBADA" />
                                        <Label
                                            FontSize="{StaticResource FontSizeSmall}"
                                            HorizontalOptions="Center"
                                            Text="Técnico"
                                            TextColor="#FF808080" />
                                    </VerticalStackLayout>
                                </Border>
                            </Grid>
                            
                            <!--  Notas guardadas  -->
                            <VerticalStackLayout Spacing="4" IsVisible="{Binding DiaryNotas, Converter={StaticResource NotNullOrEmptyBoolConverter}}">
                                <Label
                                    FontSize="{StaticResource FontSizeSmall}"
                                    Text="Notas"
                                    TextColor="#FF808080" />
                                <Label
                                    FontSize="{StaticResource FontSizeBody}"
                                    Text="{Binding DiaryNotas}"
                                    TextColor="#FFCCCCCC" />
                            </VerticalStackLayout>
                            
                            <!--  Botón Editar valoración  -->
                            <Button
                                Padding="16,10"
                                BackgroundColor="#FF404040"
                                Command="{Binding EditDiaryCommand}"
                                CornerRadius="4"
                                HorizontalOptions="Start"
                                Text="Editar valoración"
                                TextColor="White" />
                        </VerticalStackLayout>
                    </Border>
                    
                    <!--  ===== FORMULARIO DE VALORACIÓN (cuando no hay datos o está editando) =====  -->
                    <!--  Cuestionario de valoraciones  -->
                    <Border
                        Padding="16"
                        BackgroundColor="Transparent"
                        StrokeShape="RoundRectangle 12"
                        StrokeThickness="0"
                        IsVisible="{Binding ShowDiaryForm}">
                        <VerticalStackLayout Spacing="16">
                            <Label
                                FontAttributes="None"
                                FontSize="{StaticResource FontSizeBody}"
                                Text="¿Cómo te has sentido hoy?"
                                TextColor="White" />
                            
                            <!--  Valoración Física  -->
                            <Grid ColumnDefinitions="100,*,40" ColumnSpacing="12">
                                <Label
                                    FontSize="{StaticResource FontSizeBody}"
                                    Text="Físico"
                                    TextColor="#FFCCCCCC"
                                    VerticalOptions="Center" />
                                <Slider
                                    Grid.Column="1"
                                    Maximum="5"
                                    Minimum="1"
                                    MinimumTrackColor="#FF8DD3C7"
                                    MaximumTrackColor="#FF404040"
                                    ThumbColor="#FF8DD3C7"
                                    Value="{Binding DiaryValoracionFisica}" />
                                <Label
                                    Grid.Column="2"
                                    FontAttributes="None"
                                    FontSize="{StaticResource FontSizeSubtitle}"
                                    HorizontalOptions="Center"
                                    Text="{Binding DiaryValoracionFisica}"
                                    TextColor="#FF8DD3C7"
                                    VerticalOptions="Center" />
                            </Grid>
                            
                            <!--  Valoración Mental  -->
                            <Grid ColumnDefinitions="100,*,40" ColumnSpacing="12">
                                <Label
                                    FontSize="{StaticResource FontSizeBody}"
                                    Text="Mental"
                                    TextColor="#FFCCCCCC"
                                    VerticalOptions="Center" />
                                <Slider
                                    Grid.Column="1"
                                    Maximum="5"
                                    Minimum="1"
                                    MinimumTrackColor="#FFFFED6F"
                                    MaximumTrackColor="#FF404040"
                                    ThumbColor="#FFFFED6F"
                                    Value="{Binding DiaryValoracionMental}" />
                                <Label
                                    Grid.Column="2"
                                    FontAttributes="None"
                                    FontSize="{StaticResource FontSizeSubtitle}"
                                    HorizontalOptions="Center"
                                    Text="{Binding DiaryValoracionMental}"
                                    TextColor="#FFFFED6F"
                                    VerticalOptions="Center" />
                            </Grid>
                            
                            <!--  Valoración Técnica  -->
                            <Grid ColumnDefinitions="100,*,40" ColumnSpacing="12">
                                <Label
                                    FontSize="{StaticResource FontSizeBody}"
                                    Text="Técnico"
                                    TextColor="#FFCCCCCC"
                                    VerticalOptions="Center" />
                                <Slider
                                    Grid.Column="1"
                                    Maximum="5"
                                    Minimum="1"
                                    MinimumTrackColor="#FFBEBADA"
                                    MaximumTrackColor="#FF404040"
                                    ThumbColor="#FFBEBADA"
                                    Value="{Binding DiaryValoracionTecnica}" />
                                <Label
                                    Grid.Column="2"
                                    FontAttributes="None"
                                    FontSize="{StaticResource FontSizeSubtitle}"
                                    HorizontalOptions="Center"
                                    Text="{Binding DiaryValoracionTecnica}"
                                    TextColor="#FFBEBADA"
                                    VerticalOptions="Center" />
                            </Grid>
                        </VerticalStackLayout>
                    </Border>

                    <Border HeightRequest="0.4" BackgroundColor="#FF0A0A0A"/>
                    <!--  Notas de sesión  -->
                    
                    <!--  Promedios últimos 30 días  -->
                    <Border
                        Padding="16"
                        BackgroundColor="Transparent"
                        StrokeShape="RoundRectangle 12"
                        StrokeThickness="0">
                        <VerticalStackLayout Spacing="12">
                            <Grid ColumnDefinitions="*,Auto">
                                <Label
                                    FontAttributes="None"
                                    FontSize="{StaticResource FontSizeBody}"
                                    Text="Promedios (últimos 30 días)"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                                <Label
                                    Grid.Column="1"
                                    FontSize="{StaticResource FontSizeSmall}"
                                    Text="{Binding AvgValoracionCount, StringFormat='{0} sesiones'}"
                                    TextColor="#FF808080"
                                    VerticalOptions="Center" />
                            </Grid>
                            
                            <Grid ColumnDefinitions="*,*,*" ColumnSpacing="12">
                                <!--  Promedio Físico  -->
                                <Border
                                    Padding="12"
                                    BackgroundColor="#FF1E1E1E"
                                    StrokeShape="RoundRectangle 8"
                                    StrokeThickness="0">
                                    <VerticalStackLayout Spacing="4" HorizontalOptions="Center">
                                        <Label
                                            FontAttributes="None"
                                            FontSize="{StaticResource FontSizeHeader}"
                                            HorizontalOptions="Center"
                                            Text="{Binding AvgValoracionFisica, StringFormat='{0:F1}'}"
                                            TextColor="#FF8DD3C7" />
                                        <Label
                                            FontSize="{StaticResource FontSizeSmall}"
                                            HorizontalOptions="Center"
                                            Text="Físico"
                                            TextColor="#FF808080" />
                                    </VerticalStackLayout>
                                </Border>
                                
                                <!--  Promedio Mental  -->
                                <Border
                                    Grid.Column="1"
                                    Padding="12"
                                    BackgroundColor="#FF1E1E1E"
                                    StrokeShape="RoundRectangle 8"
                                    StrokeThickness="0">
                                    <VerticalStackLayout Spacing="4" HorizontalOptions="Center">
                                        <Label
                                            FontAttributes="None"
                                            FontSize="{StaticResource FontSizeHeader}"
                                            HorizontalOptions="Center"
                                            Text="{Binding AvgValoracionMental, StringFormat='{0:F1}'}"
                                            TextColor="#FFFFED6F" />
                                        <Label
                                            FontSize="{StaticResource FontSizeSmall}"
                                            HorizontalOptions="Center"
                                            Text="Mental"
                                            TextColor="#FF808080" />
                                    </VerticalStackLayout>
                                </Border>
                                
                                <!--  Promedio Técnico  -->
                                <Border
                                    Grid.Column="2"
                                    Padding="12"
                                    BackgroundColor="#FF1E1E1E"
                                    StrokeShape="RoundRectangle 8"
                                    StrokeThickness="0">
                                    <VerticalStackLayout Spacing="4" HorizontalOptions="Center">
                                        <Label
                                            FontAttributes="None"
                                            FontSize="{StaticResource FontSizeHeader}"
                                            HorizontalOptions="Center"
                                            Text="{Binding AvgValoracionTecnica, StringFormat='{0:F1}'}"
                                            TextColor="#FFBEBADA" />
                                        <Label
                                            FontSize="{StaticResource FontSizeSmall}"
                                            HorizontalOptions="Center"
                                            Text="Técnico"
                                            TextColor="#FF808080" />
                                    </VerticalStackLayout>
                                </Border>
                            </Grid>
                        </VerticalStackLayout>
                    </Border>
                    <Border HeightRequest="0.4" BackgroundColor="#FF0A0A0A"/>
                    
                    <!--  Gráfico de evolución  -->
                    <Border
                        Padding="16"
                        BackgroundColor="Transparent"
                        StrokeShape="RoundRectangle 12"
                        StrokeThickness="0">
                        <VerticalStackLayout Spacing="12">
                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                                <Label
                                    FontAttributes="None"
                                    FontSize="{StaticResource FontSizeBody}"
                                    Text="Evolución"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                                
                                <!--  Selector de periodo  -->
                                <Grid Grid.Column="1" ColumnDefinitions="Auto,Auto,Auto,Auto" ColumnSpacing="4">
                                    <Border
                                        Padding="8,4"
                                        BackgroundColor="{Binding SelectedEvolutionPeriod, Converter={StaticResource IntEqualityToColorConverter}, ConverterParameter='0:#FF3A3A3A:#FF1E1E1E'}"
                                        StrokeShape="RoundRectangle 4"
                                        StrokeThickness="0">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding SetEvolutionPeriodCommand}" CommandParameter="0" />
                                        </Border.GestureRecognizers>
                                        <Label FontSize="{StaticResource FontSizeSmall}" Text="Semana" TextColor="White" />
                                    </Border>
                                    <Border
                                        Grid.Column="1"
                                        Padding="8,4"
                                        BackgroundColor="{Binding SelectedEvolutionPeriod, Converter={StaticResource IntEqualityToColorConverter}, ConverterParameter='1:#FF3A3A3A:#FF1E1E1E'}"
                                        StrokeShape="RoundRectangle 4"
                                        StrokeThickness="0">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding SetEvolutionPeriodCommand}" CommandParameter="1" />
                                        </Border.GestureRecognizers>
                                        <Label FontSize="{StaticResource FontSizeSmall}" Text="Mes" TextColor="White" />
                                    </Border>
                                    <Border
                                        Grid.Column="2"
                                        Padding="8,4"
                                        BackgroundColor="{Binding SelectedEvolutionPeriod, Converter={StaticResource IntEqualityToColorConverter}, ConverterParameter='2:#FF3A3A3A:#FF1E1E1E'}"
                                        StrokeShape="RoundRectangle 4"
                                        StrokeThickness="0">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding SetEvolutionPeriodCommand}" CommandParameter="2" />
                                        </Border.GestureRecognizers>
                                        <Label FontSize="{StaticResource FontSizeSmall}" Text="Año" TextColor="White" />
                                    </Border>
                                    <Border
                                        Grid.Column="3"
                                        Padding="8,4"
                                        BackgroundColor="{Binding SelectedEvolutionPeriod, Converter={StaticResource IntEqualityToColorConverter}, ConverterParameter='3:#FF3A3A3A:#FF1E1E1E'}"
                                        StrokeShape="RoundRectangle 4"
                                        StrokeThickness="0">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding SetEvolutionPeriodCommand}" CommandParameter="3" />
                                        </Border.GestureRecognizers>
                                        <Label FontSize="{StaticResource FontSizeSmall}" Text="Todo" TextColor="White" />
                                    </Border>
                                </Grid>
                            </Grid>
                            
                            <!--  Leyenda  -->
                            <HorizontalStackLayout Spacing="16" HorizontalOptions="Center">
                                <HorizontalStackLayout Spacing="4">
                                    <BoxView WidthRequest="12" HeightRequest="12" Color="#FF8DD3C7" CornerRadius="2" />
                                    <Label FontSize="{StaticResource FontSizeSmall}" Text="Físico" TextColor="#FF808080" />
                                </HorizontalStackLayout>
                                <HorizontalStackLayout Spacing="4">
                                    <BoxView WidthRequest="12" HeightRequest="12" Color="#FFFFED6F" CornerRadius="2" />
                                    <Label FontSize="{StaticResource FontSizeSmall}" Text="Mental" TextColor="#FF808080" />
                                </HorizontalStackLayout>
                                <HorizontalStackLayout Spacing="4">
                                    <BoxView WidthRequest="12" HeightRequest="12" Color="#FFBEBADA" CornerRadius="2" />
                                    <Label FontSize="{StaticResource FontSizeSmall}" Text="Técnico" TextColor="#FF808080" />
                                </HorizontalStackLayout>
                            </HorizontalStackLayout>
                            
                            <!--  Mensaje si no hay datos  -->
                            <Label
                                IsVisible="{Binding ValoracionEvolution.Count, Converter={StaticResource IntToBoolConverter}, ConverterParameter=invert}"
                                FontSize="{StaticResource FontSizeBody}"
                                HorizontalOptions="Center"
                                Text="No hay datos de evolución para el periodo seleccionado"
                                TextColor="#FF808080" />
                            
                            <!--  Gráfico de evolución de valoraciones  -->
                            <controls:MultiLineChart 
                                IsVisible="{Binding ValoracionEvolution.Count, Converter={StaticResource IntToBoolConverter}}"
                                HeightRequest="180"
                                Values1="{Binding EvolutionFisicaValues}"
                                Values2="{Binding EvolutionMentalValues}"
                                Values3="{Binding EvolutionTecnicaValues}"
                                Labels="{Binding EvolutionLabels}"
                                MinValue="1"
                                MaxValue="5" />
                        </VerticalStackLayout>
                    </Border>

                    <Border HeightRequest="0.4" BackgroundColor="#FF0A0A0A"/>
                    
                    
                    <!--  Notas de sesión (solo en modo edición)  -->
                    <Border
                        Padding="16"
                        BackgroundColor="#FF1E1E1E"
                        StrokeShape="RoundRectangle 12"
                        StrokeThickness="0"
                        IsVisible="{Binding ShowDiaryForm}">
                        <VerticalStackLayout Spacing="12">
                            <Label
                                FontAttributes="None"
                                FontSize="{StaticResource FontSizeBody}"
                                Text="Notas de sesión"
                                TextColor="White" />
                            
                            <Editor
                                AutoSize="TextChanges"
                                BackgroundColor="#FF1E1E1E"
                                MinimumHeightRequest="500"
                                Placeholder="Escribe tus notas sobre la sesión...&#x0a;Cómo te has sentido, qué esperas de tu siguiente sesión, etc."
                                PlaceholderColor="#FF606060"
                                Text="{Binding DiaryNotas}"
                                TextColor="White" />
                        </VerticalStackLayout>
                    </Border>
                    
                    <!--  Botón Guardar (solo en modo edición)  -->
                    <Button
                        Padding="20,12"
                        BackgroundColor="#FF303030"
                        Command="{Binding SaveDiaryCommand}"
                        CornerRadius="4"
                        HorizontalOptions="Fill"
                        Text="Guardar Diario"
                        TextColor="White"
                        IsVisible="{Binding ShowDiaryForm}" />
                    
                </VerticalStackLayout>

                <!--  ===== VISTA: DIARIO PERSONAL (CALENDARIO) =====  -->
                <VerticalStackLayout IsVisible="{Binding IsDiaryViewSelected}" Spacing="16">
                    
                    <!--  Título y botón agregar sesión  -->
                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="16">
                        <HorizontalStackLayout Grid.Column="0" Spacing="12" VerticalOptions="Center">
                            <controls:SymbolIcon
                                HeightRequest="{StaticResource IconSizeLarge}"
                                SymbolName="book"
                                TintColor="#FF0066"
                                VerticalOptions="Center"
                                WidthRequest="{StaticResource IconSizeLarge}" />
                            <Label
                                FontSize="{StaticResource FontSizeHeader}"
                                Text="Diario Personal"
                                TextColor="White" />
                        </HorizontalStackLayout>
                        
                        <!--  Botón agregar sesión  -->
                        <HorizontalStackLayout
                            Grid.Column="1"
                            Spacing="8"
                            VerticalOptions="Center"
                            IsVisible="{Binding IsAddingNewSession, Converter={toolkit:InvertedBoolConverter}}">
                            
                            <!--  Botón + Nueva sesión manual  -->
                            <Border
                                Padding="6"
                                BackgroundColor="#FF404040"
                                StrokeShape="RoundRectangle 8"
                                StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ToggleAddNewSessionCommand}" />
                                </Border.GestureRecognizers>
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeLarge}"
                                    WidthRequest="{StaticResource IconSizeLarge}"
                                    SymbolName="plus.circle.fill"
                                    TintColor="#FF0066" />
                            </Border>
                        </HorizontalStackLayout>
                    </Grid>
                    
                    <!--  Fecha seleccionada  -->
                    <Label
                        FontSize="{StaticResource FontSizeBody}"
                        Text="{Binding SelectedDiaryDate, StringFormat='{0:dddd, dd MMMM yyyy}'}"
                        TextColor="#FFCCCCCC" />

                    <!--  Formulario nueva sesión  -->
                    <Border
                        Padding="16"
                        BackgroundColor="#FF1E1E1E"
                        StrokeShape="RoundRectangle 12"
                        Stroke="#FF0066"
                        StrokeThickness="1"
                        IsVisible="{Binding IsAddingNewSession}">
                        <VerticalStackLayout Spacing="16">
                            <Label
                                FontAttributes="None"
                                FontSize="{StaticResource FontSizeSubtitle}"
                                Text="Nueva sesión"
                                TextColor="White" />
                            
                            <!--  Nombre de la sesión  -->
                            <VerticalStackLayout Spacing="4">
                                <Label
                                    FontSize="{StaticResource FontSizeSmall}"
                                    Text="Nombre de la sesión"
                                    TextColor="#FFCCCCCC" />
                                <Entry
                                    Placeholder="Ej: Entrenamiento de fuerza"
                                    PlaceholderColor="#FF666666"
                                    Text="{Binding NewSessionName}"
                                    TextColor="White"
                                    BackgroundColor="#FF404040" />
                            </VerticalStackLayout>
                            
                            <!--  Tipo de sesión  -->
                            <VerticalStackLayout Spacing="8">
                                <Label
                                    FontSize="{StaticResource FontSizeSmall}"
                                    Text="Tipo de sesión"
                                    TextColor="#FFCCCCCC" />
                                <FlexLayout 
                                    Wrap="Wrap" 
                                    JustifyContent="Start"
                                    BindableLayout.ItemsSource="{Binding SessionTypeOptions}">
                                    <BindableLayout.ItemTemplate>
                                        <DataTemplate x:DataType="vm:SessionTypeOption">
                                            <Border
                                                Margin="0,0,8,8"
                                                Padding="12,6"
                                                StrokeShape="RoundRectangle 6"
                                                StrokeThickness="0"
                                                BackgroundColor="{Binding IsSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=#FF0066|#FF2A2A2A}"
                                                Stroke="{Binding IsSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=#FF0066|#FF404040}">
                                                <Border.GestureRecognizers>
                                                    <TapGestureRecognizer 
                                                        Command="{Binding Source={x:Reference ThisPage}, Path=BindingContext.SelectSessionTypeCommand}"
                                                        CommandParameter="{Binding .}" />
                                                </Border.GestureRecognizers>
                                                <Label
                                                    FontSize="{StaticResource FontSizeSmall}"
                                                    Text="{Binding Name}"
                                                    TextColor="{Binding IsSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=#FF121212|#FFB1B1B1}"
                                                    FontAttributes="{Binding IsSelected, Converter={StaticResource BoolToFontAttributesConverter}}"
                                                    VerticalOptions="Center" />
                                            </Border>
                                        </DataTemplate>
                                    </BindableLayout.ItemTemplate>
                                </FlexLayout>
                            </VerticalStackLayout>
                            
                            <!--  Lugar  -->
                            <VerticalStackLayout Spacing="4">
                                <Label
                                    FontSize="{StaticResource FontSizeSmall}"
                                    Text="Lugar (opcional)"
                                    TextColor="#FFCCCCCC" />
                                <Entry
                                    Placeholder="Ej: Gimnasio municipal"
                                    PlaceholderColor="#FF666666"
                                    Text="{Binding NewSessionLugar}"
                                    TextColor="White"
                                    BackgroundColor="#FF404040" />
                            </VerticalStackLayout>
                            
                            <!--  Botones  -->
                            <Grid ColumnDefinitions="*,*,*" ColumnSpacing="12">
                                <Button
                                    Text="Cancelar"
                                    BackgroundColor="#FF404040"
                                    TextColor="#FFCCCCCC"
                                    CornerRadius="8"
                                    HeightRequest="{StaticResource ElementHeightLarge}"
                                    Command="{Binding CancelNewSessionCommand}" />
                                <Button
                                    Grid.Column="1"
                                    Text="Crear sesión"
                                    BackgroundColor="#FF0066"
                                    TextColor="#FF121212"
                                    FontAttributes="None"
                                    CornerRadius="8"
                                    HeightRequest="{StaticResource ElementHeightLarge}"
                                    Command="{Binding CreateNewSessionCommand}" />
                            </Grid>
                        </VerticalStackLayout>
                    </Border>

                    <!--  Lista de sesiones del día seleccionado  -->
                    <VerticalStackLayout 
                        BindableLayout.ItemsSource="{Binding SelectedDateSessionsWithDiary}"
                        Spacing="16"
                        IsVisible="{Binding HasSelectedDateSessions}">
                        <BindableLayout.ItemTemplate>
                            <DataTemplate x:DataType="vm:SessionWithDiary">
                                <Border
                                    Padding="16"
                                    BackgroundColor="#FF1E1E1E"
                                    StrokeShape="RoundRectangle 12"
                                    StrokeThickness="0">
                                    <VerticalStackLayout Spacing="16">
                                        
                                        <!--  Título de la sesión  -->
                                        <Grid ColumnDefinitions="*,Auto">
                                            <HorizontalStackLayout Spacing="10">
                                                <controls:SymbolIcon
                                                    HeightRequest="{StaticResource IconSizeLarge}"
                                                    SymbolName="figure.pool.swim"
                                                    TintColor="#FF0066"
                                                    VerticalOptions="Center"
                                                    WidthRequest="{StaticResource IconSizeLarge}" />
                                                <VerticalStackLayout>
                                                    <Label
                                                        FontAttributes="None"
                                                        FontSize="{StaticResource FontSizeSubtitle}"
                                                        Text="{Binding Session.DisplayName}"
                                                        TextColor="White" />
                                                    <Label
                                                        FontSize="{StaticResource FontSizeSmall}"
                                                        Text="{Binding Session.FechaDateTime, StringFormat='{0:HH:mm}'}"
                                                        TextColor="#FF888888" />
                                                </VerticalStackLayout>
                                            </HorizontalStackLayout>
                                        </Grid>

                                        <!--  Mini galería de vídeos  -->
                                        <VerticalStackLayout Spacing="8" IsVisible="{Binding HasVideos}">
                                            <Label
                                                FontSize="{StaticResource FontSizeSmall}"
                                                Text="{Binding VideoCount, StringFormat='{0} vídeos'}"
                                                TextColor="#FF888888" />
                                            <FlexLayout
                                                Wrap="Wrap"
                                                JustifyContent="Start"
                                                BindableLayout.ItemsSource="{Binding Videos}">
                                                <BindableLayout.ItemTemplate>
                                                    <DataTemplate x:DataType="models:VideoClip">
                                                        <Border
                                                            Margin="0,0,2,6"
                                                            WidthRequest="60"
                                                            HeightRequest="40"
                                                            StrokeShape="RoundRectangle 2"
                                                            StrokeThickness="0"
                                                            BackgroundColor="#FF404040">
                                                            <Image
                                                                Source="{Binding EffectiveThumbnailPath}"
                                                                Aspect="AspectFill" />
                                                        </Border>
                                                    </DataTemplate>
                                                </BindableLayout.ItemTemplate>
                                            </FlexLayout>
                                            <Label
                                                FontSize="{StaticResource FontSizeSmall}"
                                                Text="{Binding ExtraVideosCount, StringFormat='+ {0} más'}"
                                                TextColor="#FF0066"
                                                IsVisible="{Binding HasExtraVideos}" />
                                            <Button
                                                Text="Ver sesión"
                                                BackgroundColor="#FF404040"
                                                TextColor="#FF0066"
                                                FontSize="{StaticResource FontSizeSmall}"
                                                CornerRadius="6"
                                                Padding="12,6"
                                                HeightRequest="{StaticResource ElementHeightDefault}"
                                                HorizontalOptions="Start"
                                                Command="{Binding Source={x:Reference ThisPage}, Path=BindingContext.ViewSessionAsPlaylistCommand}"
                                                CommandParameter="{Binding .}" />
                                        </VerticalStackLayout>

                                        <!--  Valoraciones existentes (solo lectura)  -->
                                        <VerticalStackLayout Spacing="12" IsVisible="{Binding HasValoraciones}">
                                            <Label
                                                FontAttributes="None"
                                                FontSize="{StaticResource FontSizeBody}"
                                                Text="Valoraciones"
                                                TextColor="White" />
                                            
                                            <!--  Valoración Física  -->
                                            <Grid ColumnDefinitions="80,*,40" ColumnSpacing="12">
                                                <Label
                                                    FontSize="{StaticResource FontSizeBody}"
                                                    Text="Físico"
                                                    TextColor="#FFCCCCCC"
                                                    VerticalOptions="Center" />
                                                <ProgressBar
                                                    Grid.Column="1"
                                                    Progress="{Binding Diary.ValoracionFisica, Converter={StaticResource ProgressConverter}, ConverterParameter=5}"
                                                    ProgressColor="#FF8DD3C7"
                                                    VerticalOptions="Center" />
                                                <Label
                                                    Grid.Column="2"
                                                    FontAttributes="None"
                                                    FontSize="{StaticResource FontSizeSubtitle}"
                                                    HorizontalOptions="Center"
                                                    Text="{Binding Diary.ValoracionFisica}"
                                                    TextColor="#FF8DD3C7"
                                                    VerticalOptions="Center" />
                                            </Grid>
                                            
                                            <!--  Valoración Mental  -->
                                            <Grid ColumnDefinitions="80,*,40" ColumnSpacing="12">
                                                <Label
                                                    FontSize="{StaticResource FontSizeBody}"
                                                    Text="Mental"
                                                    TextColor="#FFCCCCCC"
                                                    VerticalOptions="Center" />
                                                <ProgressBar
                                                    Grid.Column="1"
                                                    Progress="{Binding Diary.ValoracionMental, Converter={StaticResource ProgressConverter}, ConverterParameter=5}"
                                                    ProgressColor="#FFFFED6F"
                                                    VerticalOptions="Center" />
                                                <Label
                                                    Grid.Column="2"
                                                    FontAttributes="None"
                                                    FontSize="{StaticResource FontSizeSubtitle}"
                                                    HorizontalOptions="Center"
                                                    Text="{Binding Diary.ValoracionMental}"
                                                    TextColor="#FFFFED6F"
                                                    VerticalOptions="Center" />
                                            </Grid>
                                            
                                            <!--  Valoración Técnica  -->
                                            <Grid ColumnDefinitions="80,*,40" ColumnSpacing="12">
                                                <Label
                                                    FontSize="{StaticResource FontSizeBody}"
                                                    Text="Técnico"
                                                    TextColor="#FFCCCCCC"
                                                    VerticalOptions="Center" />
                                                <ProgressBar
                                                    Grid.Column="1"
                                                    Progress="{Binding Diary.ValoracionTecnica, Converter={StaticResource ProgressConverter}, ConverterParameter=5}"
                                                    ProgressColor="#FFBEBADA"
                                                    VerticalOptions="Center" />
                                                <Label
                                                    Grid.Column="2"
                                                    FontAttributes="None"
                                                    FontSize="{StaticResource FontSizeSubtitle}"
                                                    HorizontalOptions="Center"
                                                    Text="{Binding Diary.ValoracionTecnica}"
                                                    TextColor="#FFBEBADA"
                                                    VerticalOptions="Center" />
                                            </Grid>
                                        </VerticalStackLayout>

                                        <!--  Formulario de valoraciones (si no existen)  -->
                                        <VerticalStackLayout Spacing="12" IsVisible="{Binding HasValoraciones, Converter={toolkit:InvertedBoolConverter}}">
                                            <Label
                                                FontAttributes="None"
                                                FontSize="{StaticResource FontSizeBody}"
                                                Text="¿Cómo te sentiste en esta sesión?"
                                                TextColor="White" />
                                            
                                            <!--  Valoración Física  -->
                                            <Grid ColumnDefinitions="80,*,40" ColumnSpacing="12">
                                                <Label
                                                    FontSize="{StaticResource FontSizeBody}"
                                                    Text="Físico"
                                                    TextColor="#FFCCCCCC"
                                                    VerticalOptions="Center" />
                                                <Slider
                                                    Grid.Column="1"
                                                    Maximum="5"
                                                    Minimum="1"
                                                    MinimumTrackColor="#FF8DD3C7"
                                                    MaximumTrackColor="#FF404040"
                                                    ThumbColor="#FF8DD3C7"
                                                    Value="{Binding EditValoracionFisica}" />
                                                <Label
                                                    Grid.Column="2"
                                                    FontAttributes="None"
                                                    FontSize="{StaticResource FontSizeSubtitle}"
                                                    HorizontalOptions="Center"
                                                    Text="{Binding EditValoracionFisica}"
                                                    TextColor="#FF8DD3C7"
                                                    VerticalOptions="Center" />
                                            </Grid>
                                            
                                            <!--  Valoración Mental  -->
                                            <Grid ColumnDefinitions="80,*,40" ColumnSpacing="12">
                                                <Label
                                                    FontSize="{StaticResource FontSizeBody}"
                                                    Text="Mental"
                                                    TextColor="#FFCCCCCC"
                                                    VerticalOptions="Center" />
                                                <Slider
                                                    Grid.Column="1"
                                                    Maximum="5"
                                                    Minimum="1"
                                                    MinimumTrackColor="#FFFFED6F"
                                                    MaximumTrackColor="#FF404040"
                                                    ThumbColor="#FFFFED6F"
                                                    Value="{Binding EditValoracionMental}" />
                                                <Label
                                                    Grid.Column="2"
                                                    FontAttributes="None"
                                                    FontSize="{StaticResource FontSizeSubtitle}"
                                                    HorizontalOptions="Center"
                                                    Text="{Binding EditValoracionMental}"
                                                    TextColor="#FFFFED6F"
                                                    VerticalOptions="Center" />
                                            </Grid>
                                            
                                            <!--  Valoración Técnica  -->
                                            <Grid ColumnDefinitions="80,*,40" ColumnSpacing="12">
                                                <Label
                                                    FontSize="{StaticResource FontSizeBody}"
                                                    Text="Técnico"
                                                    TextColor="#FFCCCCCC"
                                                    VerticalOptions="Center" />
                                                <Slider
                                                    Grid.Column="1"
                                                    Maximum="5"
                                                    Minimum="1"
                                                    MinimumTrackColor="#FFBEBADA"
                                                    MaximumTrackColor="#FF404040"
                                                    ThumbColor="#FFBEBADA"
                                                    Value="{Binding EditValoracionTecnica}" />
                                                <Label
                                                    Grid.Column="2"
                                                    FontAttributes="None"
                                                    FontSize="{StaticResource FontSizeSubtitle}"
                                                    HorizontalOptions="Center"
                                                    Text="{Binding EditValoracionTecnica}"
                                                    TextColor="#FFBEBADA"
                                                    VerticalOptions="Center" />
                                            </Grid>
                                        </VerticalStackLayout>

                                        <!--  Notas existentes  -->
                                        <VerticalStackLayout Spacing="8" IsVisible="{Binding HasNotas}">
                                            <Label
                                                FontAttributes="None"
                                                FontSize="{StaticResource FontSizeBody}"
                                                Text="Notas"
                                                TextColor="White" />
                                            <Label
                                                FontSize="{StaticResource FontSizeBody}"
                                                Text="{Binding Diary.Notas}"
                                                TextColor="#FFCCCCCC"
                                                LineBreakMode="WordWrap" />
                                        </VerticalStackLayout>

                                        <!--  Editor de notas (si no hay valoraciones o no hay notas)  -->
                                        <VerticalStackLayout Spacing="8" IsVisible="{Binding HasValoraciones, Converter={toolkit:InvertedBoolConverter}}">
                                            <Label
                                                FontAttributes="None"
                                                FontSize="{StaticResource FontSizeBody}"
                                                Text="Notas"
                                                TextColor="White" />
                                            <Editor
                                                Placeholder="Escribe tus notas sobre esta sesión..."
                                                PlaceholderColor="#FF666666"
                                                Text="{Binding EditNotas}"
                                                TextColor="White"
                                                BackgroundColor="#FF404040"
                                                HeightRequest="100"
                                                AutoSize="TextChanges" />
                                        </VerticalStackLayout>

                                        <!--  Botón guardar (si no hay valoraciones)  -->
                                        <Button
                                            Text="Guardar"
                                            BackgroundColor="#FF0066"
                                            TextColor="#FF121212"
                                            FontAttributes="None"
                                            CornerRadius="8"
                                            HeightRequest="{StaticResource ElementHeightLarge}"
                                            Command="{Binding Source={x:Reference ThisPage}, Path=BindingContext.SaveCalendarDiaryCommand}"
                                            CommandParameter="{Binding .}"
                                            IsVisible="{Binding HasValoraciones, Converter={toolkit:InvertedBoolConverter}}" />

                                    </VerticalStackLayout>
                                </Border>
                            </DataTemplate>
                        </BindableLayout.ItemTemplate>
                    </VerticalStackLayout>
                    
                    <!--  ===== SECCIÓN BIENESTAR DIARIO (Entrada Manual) =====  -->
                    <Border
                        Padding="16"
                        BackgroundColor="#FF1E1E1E"
                        StrokeShape="RoundRectangle 12"
                        StrokeThickness="0">
                        <VerticalStackLayout Spacing="12">
                            
                            <!--  Título y botón editar  -->
                            <Grid ColumnDefinitions="*,Auto">
                                <HorizontalStackLayout Spacing="10">
                                    <controls:SymbolIcon
                                        HeightRequest="{StaticResource IconSizeXLarge}"
                                        SymbolName="heart.fill"
                                        TintColor="#FFFF6B6B"
                                        VerticalOptions="Center"
                                        WidthRequest="{StaticResource IconSizeXLarge}" />
                                    <Label
                                        FontAttributes="None"
                                        FontSize="{StaticResource FontSizeSubtitle}"
                                        Text="Bienestar"
                                        TextColor="White"
                                        VerticalOptions="Center" />
                                </HorizontalStackLayout>
                                
                                <Button
                                    Grid.Column="1"
                                    Text="{Binding HasWellnessData, Converter={StaticResource BoolToTextConverter}, ConverterParameter='Editar|Añadir'}"
                                    BackgroundColor="#FF404040"
                                    TextColor="#FFFF6B6B"
                                    FontSize="{StaticResource FontSizeSmall}"
                                    CornerRadius="6"
                                    Padding="12,6"
                                    HeightRequest="{StaticResource ElementHeightDefault}"
                                    VerticalOptions="Center"
                                    Command="{Binding StartEditWellnessCommand}"
                                    IsVisible="{Binding IsEditingWellness, Converter={toolkit:InvertedBoolConverter}}" />
                            </Grid>

                            <!--  Formulario de edición  -->
                            <VerticalStackLayout 
                                Spacing="12"
                                IsVisible="{Binding IsEditingWellness}">
                                
                                <!--  Botón importar de Apple Salud (solo visible si HealthKit disponible)  -->
                                <Border
                                    Padding="12"
                                    BackgroundColor="#FF1A3A1A"
                                    StrokeShape="RoundRectangle 8"
                                    Stroke="#FF4CD964"
                                    StrokeThickness="1"
                                    IsVisible="{Binding IsHealthKitAvailable}">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding ImportHealthDataToWellnessCommand}" />
                                    </Border.GestureRecognizers>
                                    <HorizontalStackLayout Spacing="12" HorizontalOptions="Center">
                                        <controls:SymbolIcon
                                            HeightRequest="{StaticResource IconSizeLarge}"
                                            WidthRequest="{StaticResource IconSizeLarge}"
                                            SymbolName="heart.text.square.fill"
                                            TintColor="#FF4CD964"
                                            VerticalOptions="Center" />
                                        <Label
                                            Text="Importar datos de Salud"
                                            TextColor="#FF4CD964"
                                            FontSize="{StaticResource FontSizeBody}"
                                            VerticalOptions="Center" />
                                    </HorizontalStackLayout>
                                </Border>
                                
                                <!--  Sueño  -->
                                <Border
                                    Padding="12"
                                    BackgroundColor="#FF404040"
                                    StrokeShape="RoundRectangle 8"
                                    StrokeThickness="0">
                                    <VerticalStackLayout Spacing="8">
                                        <Label Text="Horas de sueño" TextColor="#FF888888" FontSize="{StaticResource FontSizeSmall}" />
                                        <Grid ColumnDefinitions="*,80">
                                            <Slider
                                                Minimum="0"
                                                Maximum="12"
                                                Value="{Binding WellnessSleepHours, Mode=TwoWay, TargetNullValue=7}"
                                                MinimumTrackColor="#FF5856D6"
                                                MaximumTrackColor="#FF555555"
                                                ThumbColor="#FF5856D6" />
                                            <Label
                                                Grid.Column="1"
                                                Text="{Binding WellnessSleepHours, StringFormat='{0:F1} h'}"
                                                TextColor="White"
                                                FontSize="{StaticResource FontSizeSubtitle}"
                                                FontAttributes="None"
                                                HorizontalOptions="End"
                                                VerticalOptions="Center" />
                                        </Grid>
                                    </VerticalStackLayout>
                                </Border>

                                <!--  Sensación de recuperación  -->
                                <Border
                                    Padding="12"
                                    BackgroundColor="#FF404040"
                                    StrokeShape="RoundRectangle 8"
                                    StrokeThickness="0">
                                    <VerticalStackLayout Spacing="8">
                                        <Label Text="¿Cómo te sientes hoy? (1-10)" TextColor="#FF888888" FontSize="{StaticResource FontSizeSmall}" />
                                        <Grid ColumnDefinitions="*,60">
                                            <Slider
                                                Minimum="1"
                                                Maximum="10"
                                                Value="{Binding WellnessRecoveryFeeling, Mode=TwoWay, TargetNullValue=5}"
                                                MinimumTrackColor="#FF4CD964"
                                                MaximumTrackColor="#FF555555"
                                                ThumbColor="#FF4CD964" />
                                            <Label
                                                Grid.Column="1"
                                                Text="{Binding WellnessRecoveryFeeling}"
                                                TextColor="White"
                                                FontSize="{StaticResource FontSizeTitle}"
                                                FontAttributes="None"
                                                HorizontalOptions="End"
                                                VerticalOptions="Center" />
                                        </Grid>
                                    </VerticalStackLayout>
                                </Border>

                                <!--  Fatiga muscular  -->
                                <Border
                                    Padding="12"
                                    BackgroundColor="#FF404040"
                                    StrokeShape="RoundRectangle 8"
                                    StrokeThickness="0">
                                    <VerticalStackLayout Spacing="8">
                                        <Label Text="Fatiga muscular (1=ninguna, 10=mucha)" TextColor="#FF888888" FontSize="{StaticResource FontSizeSmall}" />
                                        <Grid ColumnDefinitions="*,60">
                                            <Slider
                                                Minimum="1"
                                                Maximum="10"
                                                Value="{Binding WellnessMuscleFatigue, Mode=TwoWay, TargetNullValue=3}"
                                                MinimumTrackColor="#FFFF9500"
                                                MaximumTrackColor="#FF555555"
                                                ThumbColor="#FFFF9500" />
                                            <Label
                                                Grid.Column="1"
                                                Text="{Binding WellnessMuscleFatigue}"
                                                TextColor="White"
                                                FontSize="{StaticResource FontSizeTitle}"
                                                FontAttributes="None"
                                                HorizontalOptions="End"
                                                VerticalOptions="Center" />
                                        </Grid>
                                    </VerticalStackLayout>
                                </Border>

                                <!--  Estado de ánimo  -->
                                <Border
                                    Padding="12"
                                    BackgroundColor="#FF404040"
                                    StrokeShape="RoundRectangle 8"
                                    StrokeThickness="0">
                                    <VerticalStackLayout Spacing="8">
                                        <Label Text="Estado de ánimo" TextColor="#FF888888" FontSize="{StaticResource FontSizeSmall}" />
                                        <HorizontalStackLayout HorizontalOptions="Center" Spacing="8">
                                            <Border
                                                Padding="8"
                                                WidthRequest="50"
                                                HeightRequest="50"
                                                StrokeShape="RoundRectangle 4"
                                                BackgroundColor="Transparent"
                                                StrokeThickness="{Binding WellnessMoodRating, Converter={StaticResource EqualityToBorderWidthConverter}, ConverterParameter=1}"
                                                Stroke="#FFFF6B6B">
                                                <Border.GestureRecognizers>
                                                    <TapGestureRecognizer 
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:DashboardViewModel}}, Path=SetMoodCommand}"
                                                        CommandParameter="1" />
                                                </Border.GestureRecognizers>
                                                <controls:SymbolIcon
                                                    HeightRequest="{StaticResource IconSizeXLarge}"
                                                    WidthRequest="{StaticResource IconSizeXLarge}"
                                                    SymbolName="cloud.heavyrain.fill"
                                                    TintColor="#FFFF6B6B"
                                                    HorizontalOptions="Center"
                                                    VerticalOptions="Center" />
                                            </Border>
                                            <Border
                                                Padding="8"
                                                WidthRequest="50"
                                                HeightRequest="50"
                                                StrokeShape="RoundRectangle 4"
                                                BackgroundColor="Transparent"
                                                StrokeThickness="{Binding WellnessMoodRating, Converter={StaticResource EqualityToBorderWidthConverter}, ConverterParameter=2}"
                                                Stroke="#FFFF9500">
                                                <Border.GestureRecognizers>
                                                    <TapGestureRecognizer 
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:DashboardViewModel}}, Path=SetMoodCommand}"
                                                        CommandParameter="2" />
                                                </Border.GestureRecognizers>
                                                <controls:SymbolIcon
                                                    HeightRequest="{StaticResource IconSizeXLarge}"
                                                    WidthRequest="{StaticResource IconSizeXLarge}"
                                                    SymbolName="cloud.fill"
                                                    TintColor="#FFFF9500"
                                                    HorizontalOptions="Center"
                                                    VerticalOptions="Center" />
                                            </Border>
                                            <Border
                                                Padding="8"
                                                WidthRequest="50"
                                                HeightRequest="50"
                                                StrokeShape="RoundRectangle 4"
                                                BackgroundColor="Transparent"
                                                StrokeThickness="{Binding WellnessMoodRating, Converter={StaticResource EqualityToBorderWidthConverter}, ConverterParameter=3}"
                                                Stroke="#FFFFC107">
                                                <Border.GestureRecognizers>
                                                    <TapGestureRecognizer 
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:DashboardViewModel}}, Path=SetMoodCommand}"
                                                        CommandParameter="3" />
                                                </Border.GestureRecognizers>
                                                <controls:SymbolIcon
                                                    HeightRequest="{StaticResource IconSizeXLarge}"
                                                    WidthRequest="{StaticResource IconSizeXLarge}"
                                                    SymbolName="cloud.sun.fill"
                                                    TintColor="#FFFFC107"
                                                    HorizontalOptions="Center"
                                                    VerticalOptions="Center" />
                                            </Border>
                                            <Border
                                                Padding="8"
                                                WidthRequest="50"
                                                HeightRequest="50"
                                                StrokeShape="RoundRectangle 4"
                                                BackgroundColor="Transparent"
                                                StrokeThickness="{Binding WellnessMoodRating, Converter={StaticResource EqualityToBorderWidthConverter}, ConverterParameter=4}"
                                                Stroke="#FF8BC34A">
                                                <Border.GestureRecognizers>
                                                    <TapGestureRecognizer 
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:DashboardViewModel}}, Path=SetMoodCommand}"
                                                        CommandParameter="4" />
                                                </Border.GestureRecognizers>
                                                <controls:SymbolIcon
                                                    HeightRequest="{StaticResource IconSizeXLarge}"
                                                    WidthRequest="{StaticResource IconSizeXLarge}"
                                                    SymbolName="sun.max.fill"
                                                    TintColor="#FF8BC34A"
                                                    HorizontalOptions="Center"
                                                    VerticalOptions="Center" />
                                            </Border>
                                            <Border
                                                Padding="8"
                                                WidthRequest="50"
                                                HeightRequest="50"
                                                StrokeShape="RoundRectangle 4"
                                                BackgroundColor="Transparent"
                                                StrokeThickness="{Binding WellnessMoodRating, Converter={StaticResource EqualityToBorderWidthConverter}, ConverterParameter=5}"
                                                Stroke="#FF4CD964">
                                                <Border.GestureRecognizers>
                                                    <TapGestureRecognizer 
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:DashboardViewModel}}, Path=SetMoodCommand}"
                                                        CommandParameter="5" />
                                                </Border.GestureRecognizers>
                                                <controls:SymbolIcon
                                                    HeightRequest="{StaticResource IconSizeXLarge}"
                                                    WidthRequest="{StaticResource IconSizeXLarge}"
                                                    SymbolName="sparkles"
                                                    TintColor="#FF4CD964"
                                                    HorizontalOptions="Center"
                                                    VerticalOptions="Center" />
                                            </Border>
                                        </HorizontalStackLayout>
                                    </VerticalStackLayout>
                                </Border>

                                <!--  PPM Basal y HRV  -->
                                <Grid ColumnDefinitions="*,*" ColumnSpacing="12">
                                    <!--  PPM Basal  -->
                                    <Border
                                        Padding="12"
                                        BackgroundColor="#FF404040"
                                        StrokeShape="RoundRectangle 8"
                                        StrokeThickness="0">
                                        <VerticalStackLayout Spacing="8">
                                            <Grid ColumnDefinitions="Auto,*,Auto">
                                                <HorizontalStackLayout Spacing="6">
                                                    <controls:SymbolIcon
                                                        HeightRequest="{StaticResource IconSizeLarge}"
                                                        SymbolName="heart.fill"
                                                        TintColor="#FFFF6B6B"
                                                        VerticalOptions="Center"
                                                        WidthRequest="{StaticResource IconSizeLarge}" />
                                                    <Label Text="PPM Basal" TextColor="#FF888888" FontSize="{StaticResource FontSizeSmall}" VerticalOptions="Center" />
                                                </HorizontalStackLayout>
                                                <Button
                                                    Grid.Column="2"
                                                    Text="?"
                                                    FontSize="{StaticResource FontSizeBody}"
                                                    FontAttributes="None"
                                                    BackgroundColor="Transparent"
                                                    TextColor="#FFABABAB"
                                                    CornerRadius="4"
                                                    Padding="0"
                                                    WidthRequest="20"
                                                    HeightRequest="20"
                                                    Command="{Binding ShowPPMInfoCommand}" />
                                            </Grid>
                                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                                                <Entry
                                                    Text="{Binding WellnessRestingHeartRate}"
                                                    Placeholder="60"
                                                    PlaceholderColor="#FF555555"
                                                    TextColor="White"
                                                    BackgroundColor="#FF1E1E1E"
                                                    Keyboard="Numeric"
                                                    HorizontalTextAlignment="Center"
                                                    FontSize="{StaticResource FontSizeTitle}"
                                                    FontAttributes="None" />
                                                <Label
                                                    Grid.Column="1"
                                                    Text="bpm"
                                                    TextColor="#FF888888"
                                                    FontSize="{StaticResource FontSizeBody}"
                                                    VerticalOptions="Center" />
                                            </Grid>
                                        </VerticalStackLayout>
                                    </Border>

                                    <!--  HRV  -->
                                    <Border
                                        Grid.Column="1"
                                        Padding="12"
                                        BackgroundColor="#FF404040"
                                        StrokeShape="RoundRectangle 8"
                                        StrokeThickness="0">
                                        <VerticalStackLayout Spacing="8">
                                            <Grid ColumnDefinitions="Auto,*,Auto">
                                                <HorizontalStackLayout Spacing="6">
                                                    <controls:SymbolIcon
                                                        HeightRequest="{StaticResource IconSizeLarge}"
                                                        SymbolName="waveform.path.ecg"
                                                        TintColor="#FFAEADFF"
                                                        VerticalOptions="Center"
                                                        WidthRequest="{StaticResource IconSizeLarge}" />
                                                    <Label Text="HRV" TextColor="#FF888888" FontSize="{StaticResource FontSizeSmall}" VerticalOptions="Center" />
                                                </HorizontalStackLayout>
                                                <Button
                                                    Grid.Column="2"
                                                    Text="?"
                                                    FontSize="{StaticResource FontSizeBody}"
                                                    FontAttributes="None"
                                                    BackgroundColor="Transparent"
                                                    TextColor="#FFADADAD"
                                                    CornerRadius="4"
                                                    Padding="0"
                                                    WidthRequest="20"
                                                    HeightRequest="20"
                                                    Command="{Binding ShowHRVInfoCommand}" />
                                            </Grid>
                                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                                                <Entry
                                                    Text="{Binding WellnessHRV}"
                                                    Placeholder="50"
                                                    PlaceholderColor="#FF555555"
                                                    TextColor="White"
                                                    BackgroundColor="#FF1E1E1E"
                                                    Keyboard="Numeric"
                                                    HorizontalTextAlignment="Center"
                                                    FontSize="{StaticResource FontSizeTitle}"
                                                    FontAttributes="None" />
                                                <Label
                                                    Grid.Column="1"
                                                    Text="ms"
                                                    TextColor="#FF888888"
                                                    FontSize="{StaticResource FontSizeBody}"
                                                    VerticalOptions="Center" />
                                            </Grid>
                                        </VerticalStackLayout>
                                    </Border>
                                </Grid>

                                <!--  Notas  -->
                                <Border
                                    Padding="12"
                                    BackgroundColor="#FF404040"
                                    StrokeShape="RoundRectangle 8"
                                    StrokeThickness="0">
                                    <VerticalStackLayout Spacing="8">
                                        <Label Text="Notas (opcional)" TextColor="#FF888888" FontSize="{StaticResource FontSizeSmall}" />
                                        <Editor
                                            Text="{Binding WellnessNotes}"
                                            Placeholder="¿Algo que destacar sobre tu estado hoy?"
                                            PlaceholderColor="#FF555555"
                                            TextColor="White"
                                            BackgroundColor="#FF1E1E1E"
                                            HeightRequest="80"
                                            AutoSize="TextChanges" />
                                    </VerticalStackLayout>
                                </Border>

                                <!--  Botones guardar/cancelar  -->
                                <Grid ColumnDefinitions="*,*" ColumnSpacing="12">
                                    <Button
                                        Text="Cancelar"
                                        BackgroundColor="#FF3A3A3A"
                                        TextColor="#FF888888"
                                        CornerRadius="8"
                                        Command="{Binding CancelEditWellnessCommand}" />
                                    <Button
                                        Grid.Column="1"
                                        Text="Guardar"
                                        BackgroundColor="#FF4CD964"
                                        TextColor="White"
                                        CornerRadius="8"
                                        Command="{Binding SaveWellnessCommand}" />
                                </Grid>
                            </VerticalStackLayout>

                            <!--  Vista de datos guardados (cuando no está editando)  -->
                            <VerticalStackLayout 
                                Spacing="12"
                                IsVisible="{Binding IsEditingWellness, Converter={toolkit:InvertedBoolConverter}}">
                                
                                <!--  Indicador de bienestar si hay datos  -->
                                <Border
                                    Padding="12"
                                    BackgroundColor="{Binding SelectedDateWellness.WellnessColor}"
                                    StrokeShape="RoundRectangle 8"
                                    StrokeThickness="0"
                                    IsVisible="{Binding HasWellnessData}">
                                    <Grid ColumnDefinitions="*,Auto">
                                        <VerticalStackLayout>
                                            <Label
                                                FontSize="{StaticResource FontSizeSmall}"
                                                Text="Nivel de bienestar"
                                                TextColor="#FF121212"
                                                Opacity="0.7" />
                                            <Label
                                                FontAttributes="None"
                                                FontSize="{StaticResource FontSizeTitle}"
                                                Text="{Binding SelectedDateWellness.WellnessText}"
                                                TextColor="#FF121212" />
                                        </VerticalStackLayout>
                                        <Label
                                            Grid.Column="1"
                                            FontAttributes="None"
                                            FontSize="{StaticResource FontSizeDisplay}"
                                            Text="{Binding SelectedDateWellness.WellnessScore}"
                                            TextColor="#FF121212"
                                            VerticalOptions="Center" />
                                    </Grid>
                                </Border>

                                <!--  Métricas si hay datos  -->
                                <Grid ColumnDefinitions="*,*,*" ColumnSpacing="8"
                                      IsVisible="{Binding HasWellnessData}">
                                    <!--  Sueño  -->
                                    <Border
                                        Padding="10"
                                        BackgroundColor="#FF404040"
                                        StrokeShape="RoundRectangle 8"
                                        StrokeThickness="0">
                                        <VerticalStackLayout HorizontalOptions="Center" Spacing="2">
                                            <controls:SymbolIcon
                                                HeightRequest="{StaticResource IconSizeLarge}"
                                                SymbolName="moon.fill"
                                                TintColor="#FF5856D6"
                                                HorizontalOptions="Center"
                                                WidthRequest="{StaticResource IconSizeLarge}" />
                                            <Label
                                                FontAttributes="None"
                                                FontSize="{StaticResource FontSizeSubtitle}"
                                                Text="{Binding SelectedDateWellness.SleepFormatted}"
                                                TextColor="White"
                                                HorizontalOptions="Center" />
                                            <Label
                                                FontSize="{StaticResource FontSizeCaption}"
                                                Text="sueño"
                                                TextColor="#FF888888"
                                                HorizontalOptions="Center" />
                                        </VerticalStackLayout>
                                    </Border>
                                    
                                    <!--  Recuperación  -->
                                    <Border
                                        Grid.Column="1"
                                        Padding="10"
                                        BackgroundColor="#FF404040"
                                        StrokeShape="RoundRectangle 8"
                                        StrokeThickness="0">
                                        <VerticalStackLayout HorizontalOptions="Center" Spacing="2">
                                            <controls:SymbolIcon
                                                HeightRequest="{StaticResource IconSizeLarge}"
                                                SymbolName="bolt.fill"
                                                TintColor="#FF4CD964"
                                                HorizontalOptions="Center"
                                                WidthRequest="{StaticResource IconSizeLarge}" />
                                            <Label
                                                FontAttributes="None"
                                                FontSize="{StaticResource FontSizeSubtitle}"
                                                Text="{Binding SelectedDateWellness.RecoveryFeeling, StringFormat='{0}/10'}"
                                                TextColor="White"
                                                HorizontalOptions="Center" />
                                            <Label
                                                FontSize="{StaticResource FontSizeCaption}"
                                                Text="energía"
                                                TextColor="#FF888888"
                                                HorizontalOptions="Center" />
                                        </VerticalStackLayout>
                                    </Border>
                                    
                                    <!--  Ánimo  -->
                                    <Border
                                        Grid.Column="2"
                                        Padding="10"
                                        BackgroundColor="#FF404040"
                                        StrokeShape="RoundRectangle 8"
                                        StrokeThickness="0">
                                        <VerticalStackLayout HorizontalOptions="Center" Spacing="2">
                                            <controls:SymbolIcon
                                                HeightRequest="{StaticResource IconSizeLarge}"
                                                WidthRequest="{StaticResource IconSizeLarge}"
                                                SymbolName="{Binding SelectedDateWellness.MoodSymbol}"
                                                TintColor="{Binding SelectedDateWellness.MoodColor}"
                                                HorizontalOptions="Center" />
                                            <Label
                                                FontSize="{StaticResource FontSizeCaption}"
                                                Text="ánimo"
                                                TextColor="#FF888888"
                                                HorizontalOptions="Center" />
                                        </VerticalStackLayout>
                                    </Border>
                                </Grid>

                                <!--  PPM Basal y HRV (si están registrados)  -->
                                <Grid ColumnDefinitions="*,*" ColumnSpacing="8"
                                      IsVisible="{Binding HasWellnessData}">
                                    <!--  PPM Basal  -->
                                    <Border
                                        Padding="10"
                                        BackgroundColor="#FF404040"
                                        StrokeShape="RoundRectangle 8"
                                        StrokeThickness="0"
                                        IsVisible="{Binding SelectedDateWellness.RestingHeartRate, Converter={StaticResource IsNotNullConverter}}">
                                        <HorizontalStackLayout HorizontalOptions="Center" Spacing="8">
                                            <controls:SymbolIcon
                                                HeightRequest="{StaticResource IconSizeDefault}"
                                                SymbolName="heart.fill"
                                                TintColor="#FFFF6B6B"
                                                VerticalOptions="Center"
                                                WidthRequest="{StaticResource IconSizeDefault}" />
                                            <VerticalStackLayout Spacing="0">
                                                <HorizontalStackLayout Spacing="4">
                                                    <Label
                                                        FontAttributes="None"
                                                        FontSize="{StaticResource FontSizeSubtitle}"
                                                        Text="{Binding SelectedDateWellness.RestingHeartRate}"
                                                        TextColor="White"
                                                        VerticalOptions="Center" />
                                                    <Label
                                                        FontSize="{StaticResource FontSizeSmall}"
                                                        Text="bpm"
                                                        TextColor="#FF888888"
                                                        VerticalOptions="Center" />
                                                </HorizontalStackLayout>
                                                <Label
                                                    FontSize="{StaticResource FontSizeCaption}"
                                                    Text="PPM basal"
                                                    TextColor="#FF888888" />
                                            </VerticalStackLayout>
                                        </HorizontalStackLayout>
                                    </Border>
                                    
                                    <!--  HRV  -->
                                    <Border
                                        Grid.Column="1"
                                        Padding="10"
                                        BackgroundColor="#FF404040"
                                        StrokeShape="RoundRectangle 8"
                                        StrokeThickness="0"
                                        IsVisible="{Binding SelectedDateWellness.HeartRateVariability, Converter={StaticResource IsNotNullConverter}}">
                                        <HorizontalStackLayout HorizontalOptions="Center" Spacing="8">
                                            <controls:SymbolIcon
                                                HeightRequest="{StaticResource IconSizeDefault}"
                                                SymbolName="waveform.path.ecg"
                                                TintColor="#FF5856D6"
                                                VerticalOptions="Center"
                                                WidthRequest="{StaticResource IconSizeDefault}" />
                                            <VerticalStackLayout Spacing="0">
                                                <HorizontalStackLayout Spacing="4">
                                                    <Label
                                                        FontAttributes="None"
                                                        FontSize="{StaticResource FontSizeSubtitle}"
                                                        Text="{Binding SelectedDateWellness.HeartRateVariability}"
                                                        TextColor="White"
                                                        VerticalOptions="Center" />
                                                    <Label
                                                        FontSize="{StaticResource FontSizeSmall}"
                                                        Text="ms"
                                                        TextColor="#FF888888"
                                                        VerticalOptions="Center" />
                                                </HorizontalStackLayout>
                                                <Label
                                                    FontSize="{StaticResource FontSizeCaption}"
                                                    Text="HRV"
                                                    TextColor="#FF888888" />
                                            </VerticalStackLayout>
                                        </HorizontalStackLayout>
                                    </Border>
                                </Grid>

                                <!--  Notas si existen  -->
                                <Border
                                    Padding="12"
                                    BackgroundColor="#FF404040"
                                    StrokeShape="RoundRectangle 8"
                                    StrokeThickness="0"
                                    IsVisible="{Binding SelectedDateWellness.Notes, Converter={StaticResource NotNullOrEmptyBoolConverter}}">
                                    <VerticalStackLayout Spacing="4">
                                        <Label Text="Notas" TextColor="#FF888888" FontSize="{StaticResource FontSizeSmall}" />
                                        <Label 
                                            Text="{Binding SelectedDateWellness.Notes}" 
                                            TextColor="White" 
                                            FontSize="{StaticResource FontSizeBody}"
                                            LineBreakMode="WordWrap" />
                                    </VerticalStackLayout>
                                </Border>

                                <!--  Mensaje si no hay datos  -->
                                <Label
                                    Text="Pulsa 'Añadir' para registrar tu bienestar del día"
                                    TextColor="#FF888888"
                                    FontSize="{StaticResource FontSizeBody}"
                                    HorizontalTextAlignment="Center"
                                    IsVisible="{Binding HasWellnessData, Converter={toolkit:InvertedBoolConverter}}" />
                            </VerticalStackLayout>
                        </VerticalStackLayout>
                    </Border>
                    
                    <!--  Mensaje cuando no hay sesiones para la fecha  -->
                    <Border
                        Padding="24"
                        BackgroundColor="#FF1E1E1E"
                        StrokeShape="RoundRectangle 12"
                        StrokeThickness="0"
                        IsVisible="{Binding HasSelectedDateSessions, Converter={toolkit:InvertedBoolConverter}}">
                        <VerticalStackLayout HorizontalOptions="Center" Spacing="12">
                            <controls:SymbolIcon
                                HeightRequest="{StaticResource IconSizeXXLarge}"
                                SymbolName="calendar.badge.exclamationmark"
                                TintColor="#FF555555"
                                HorizontalOptions="Center"
                                WidthRequest="{StaticResource IconSizeXXLarge}" />
                            <Label
                                FontSize="{StaticResource FontSizeSubtitle}"
                                Text="No hay sesiones para este día"
                                TextColor="#FF888888"
                                HorizontalOptions="Center" />
                            <Label
                                FontSize="{StaticResource FontSizeBody}"
                                Text="Puedes crear una sesión manual para registrar&#x0a;entrenamientos sin vídeo (gimnasio, agua tranquila, etc.)"
                                TextColor="#FF888888"
                                HorizontalOptions="Center"
                                HorizontalTextAlignment="Center" />
                            <Button
                                Text="+ Crear nueva sesión"
                                BackgroundColor="#FF0066"
                                TextColor="#FF121212"
                                FontAttributes="None"
                                CornerRadius="8"
                                Padding="24,0"
                                HeightRequest="{StaticResource ElementHeightLarge}"
                                Margin="0,8,0,0"
                                HorizontalOptions="Center"
                                Command="{Binding ToggleAddNewSessionCommand}" />
                        </VerticalStackLayout>
                    </Border>
                    
                </VerticalStackLayout>

            </VerticalStackLayout>
        </ScrollView>
        <Border
            x:Name="HoverPreviewContainer"
            Grid.Row="0"
            Grid.RowSpan="3"
            Grid.Column="0"
            Grid.ColumnSpan="5"
            Margin="0"
            BackgroundColor="#FF121212"
            InputTransparent="True"
            HorizontalOptions="Start"
            IsVisible="{Binding HasHoverVideo}"
            Stroke="#FF3A3A3A"
            StrokeShape="RoundRectangle 12"
            StrokeThickness="1"
            VerticalOptions="Start"
            WidthRequest="960"
            ZIndex="50">
            <Grid RowDefinitions="Auto,Auto">
                <controls:AspectRatioContainer AspectRatio="1.777">
                    <appcontrols:PrecisionVideoPlayer
                        x:Name="HoverPreviewPlayer"
                        Aspect="AspectFit"
                        IsMuted="True"
                        Source="{Binding HoverVideo.LocalClipPath}" />
                </controls:AspectRatioContainer>
                <Label
                    Grid.Row="1"
                    Padding="12,8"
                    FontSize="{StaticResource FontSizeBody}"
                    LineBreakMode="TailTruncation"
                    Text="{Binding HoverVideo.Atleta.NombreCompleto}"
                    TextColor="White" />
            </Grid>
        </Border>

        <ActivityIndicator
            Grid.Row="1"
            Grid.ColumnSpan="5"
            HorizontalOptions="Center"
            IsRunning="{Binding IsBusy}"
            IsVisible="{Binding IsBusy}"
            VerticalOptions="Center"
            Color="#FF0066" />

        <!--  Popup de nueva sesión desde barra lateral (solo iOS)  -->
        <Grid
            Grid.Row="0"
            Grid.RowSpan="2"
            Grid.ColumnSpan="5"
            BackgroundColor="#CC000000"
            IsVisible="{Binding ShowNewSessionSidebarPopup}">
            <Border
                Padding="24"
                BackgroundColor="#FF1E1E1E"
                HorizontalOptions="Center"
                Stroke="#FF3A3A3A"
                StrokeShape="RoundRectangle 12"
                StrokeThickness="1"
                VerticalOptions="Center"
                WidthRequest="400">
                <VerticalStackLayout Spacing="16">
                    <!--  Título  -->
                    <Grid ColumnDefinitions="*,Auto">
                        <VerticalStackLayout Grid.Column="0">
                            <Label
                                FontAttributes="None"
                                FontSize="{StaticResource FontSizeTitle}"
                                Text="Nueva sesión de grabación"
                                TextColor="White" />
                            <Label
                                FontSize="{StaticResource FontSizeSmall}"
                                Text="Crea una sesión y graba vídeos directamente"
                                TextColor="#FF888888" />
                        </VerticalStackLayout>
                        <Border
                            Grid.Column="1"
                            Padding="4"
                            BackgroundColor="Transparent"
                            Stroke="Transparent"
                            StrokeShape="RoundRectangle 4">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding CancelNewSessionSidebarPopupCommand}" />
                            </Border.GestureRecognizers>
                            <controls:SymbolIcon
                                HeightRequest="{StaticResource IconSizeLarge}"
                                SymbolName="xmark"
                                TintColor="#FF888888"
                                WidthRequest="{StaticResource IconSizeLarge}" />
                        </Border>
                    </Grid>

                    <!--  Nombre de la sesión  -->
                    <VerticalStackLayout Spacing="4">
                        <Label
                            FontSize="{StaticResource FontSizeSmall}"
                            Text="Nombre de la sesión"
                            TextColor="#FFCCCCCC" />
                        <Entry
                            Placeholder="Ej: Entrenamiento mañana"
                            PlaceholderColor="#FF666666"
                            Text="{Binding NewSessionName}"
                            TextColor="White"
                            BackgroundColor="#FF404040" />
                    </VerticalStackLayout>

                    <!--  Tipo de sesión  -->
                    <VerticalStackLayout Spacing="8">
                        <Label
                            FontSize="{StaticResource FontSizeSmall}"
                            Text="Tipo de sesión"
                            TextColor="#FFCCCCCC" />
                        <FlexLayout 
                            Wrap="Wrap" 
                            JustifyContent="Start"
                            BindableLayout.ItemsSource="{Binding SessionTypeOptions}">
                            <BindableLayout.ItemTemplate>
                                <DataTemplate x:DataType="vm:SessionTypeOption">
                                    <Border
                                        Margin="0,0,8,8"
                                        Padding="12,6"
                                        StrokeShape="RoundRectangle 6"
                                        StrokeThickness="0"
                                        BackgroundColor="{Binding IsSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=#FF0066|#FF2A2A2A}"
                                        Stroke="{Binding IsSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=#FF0066|#FF404040}">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer 
                                                Command="{Binding Source={x:Reference ThisPage}, Path=BindingContext.SelectSessionTypeCommand}"
                                                CommandParameter="{Binding .}" />
                                        </Border.GestureRecognizers>
                                        <Label
                                            FontSize="{StaticResource FontSizeSmall}"
                                            Text="{Binding Name}"
                                            TextColor="{Binding IsSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=#FF121212|#FFB1B1B1}"
                                            FontAttributes="{Binding IsSelected, Converter={StaticResource BoolToFontAttributesConverter}}"
                                            VerticalOptions="Center" />
                                    </Border>
                                </DataTemplate>
                            </BindableLayout.ItemTemplate>
                        </FlexLayout>
                    </VerticalStackLayout>

                    <!--  Lugar  -->
                    <VerticalStackLayout Spacing="4">
                        <Label
                            FontSize="{StaticResource FontSizeSmall}"
                            Text="Lugar (opcional)"
                            TextColor="#FFCCCCCC" />
                        <Entry
                            Placeholder="Ej: Canal olímpico"
                            PlaceholderColor="#FF666666"
                            Text="{Binding NewSessionLugar}"
                            TextColor="White"
                            BackgroundColor="#FF404040" />
                    </VerticalStackLayout>

                    <!--  Botones  -->
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="12" Margin="0,8,0,0">
                        <Button
                            Grid.Column="0"
                            Text="Cancelar"
                            BackgroundColor="#FF404040"
                            TextColor="#FFCCCCCC"
                            CornerRadius="8"
                            HeightRequest="{StaticResource ElementHeightLarge}"
                            Command="{Binding CancelNewSessionSidebarPopupCommand}" />
                        <Button
                            Grid.Column="1"
                            Text="Crear y grabar"
                            BackgroundColor="#FFFF3B30"
                            TextColor="White"
                            FontAttributes="None"
                            CornerRadius="8"
                            HeightRequest="{StaticResource ElementHeightLarge}"
                            Command="{Binding CreateSessionAndRecordCommand}" />
                    </Grid>
                </VerticalStackLayout>
            </Border>
        </Grid>

        <!--  Popup de carpeta inteligente  -->
        <Grid
            Grid.Row="0"
            Grid.RowSpan="2"
            Grid.ColumnSpan="5"
            BackgroundColor="#CC000000"
            IsVisible="{Binding ShowSmartFolderSidebarPopup}">
            <Border
                Padding="24"
                BackgroundColor="#FF1E1E1E"
                HorizontalOptions="Center"
                Stroke="#FF3A3A3A"
                StrokeShape="RoundRectangle 12"
                StrokeThickness="1"
                VerticalOptions="Center"
                WidthRequest="520">
                <VerticalStackLayout Spacing="16">
                    <!--  Título  -->
                    <Grid ColumnDefinitions="*,Auto">
                        <VerticalStackLayout Grid.Column="0">
                            <Label
                                FontAttributes="None"
                                FontSize="{StaticResource FontSizeTitle}"
                                Text="Carpeta inteligente"
                                TextColor="White" />
                            <Label
                                FontSize="{StaticResource FontSizeSmall}"
                                Text="Define criterios para agrupar vídeos automáticamente"
                                TextColor="#FF888888" />
                        </VerticalStackLayout>
                        <Border
                            Grid.Column="1"
                            Padding="4"
                            BackgroundColor="Transparent"
                            Stroke="Transparent"
                            StrokeShape="RoundRectangle 4">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding CancelSmartFolderSidebarPopupCommand}" />
                            </Border.GestureRecognizers>
                            <controls:SymbolIcon
                                HeightRequest="{StaticResource IconSizeLarge}"
                                SymbolName="xmark"
                                TintColor="#FF888888"
                                WidthRequest="{StaticResource IconSizeLarge}" />
                        </Border>
                    </Grid>

                    <!--  Nombre  -->
                    <VerticalStackLayout Spacing="4">
                        <Label
                            FontSize="{StaticResource FontSizeSmall}"
                            Text="Nombre"
                            TextColor="#FFCCCCCC" />
                        <Entry
                            Placeholder="Ej: Técnica - tags"
                            PlaceholderColor="#FF666666"
                            Text="{Binding NewSmartFolderName}"
                            TextColor="White"
                            BackgroundColor="#FF404040" />
                    </VerticalStackLayout>

                    <!--  Match mode: AND/OR  -->
                    <VerticalStackLayout Spacing="8">
                        <Label
                            FontSize="{StaticResource FontSizeSmall}"
                            Text="Condiciones"
                            TextColor="#FFCCCCCC" />
                        <Grid ColumnDefinitions="*,*" ColumnSpacing="12">
                            <Border
                                Grid.Column="0"
                                Padding="12,8"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0"
                                BackgroundColor="{Binding IsSmartFolderMatchAll, Converter={StaticResource BoolToColorConverter}, ConverterParameter=#FF0066|#FF2A2A2A}">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding SetSmartFolderMatchModeCommand}" CommandParameter="All" />
                                </Border.GestureRecognizers>
                                <Label
                                    FontSize="{StaticResource FontSizeSmall}"
                                    Text="Y (AND)"
                                    TextColor="{Binding IsSmartFolderMatchAll, Converter={StaticResource BoolToColorConverter}, ConverterParameter=#FF121212|#FFB1B1B1}"
                                    FontAttributes="{Binding IsSmartFolderMatchAll, Converter={StaticResource BoolToFontAttributesConverter}}"
                                    HorizontalOptions="Center"
                                    VerticalOptions="Center" />
                            </Border>
                            <Border
                                Grid.Column="1"
                                Padding="12,8"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0"
                                BackgroundColor="{Binding IsSmartFolderMatchAny, Converter={StaticResource BoolToColorConverter}, ConverterParameter=#FF0066|#FF2A2A2A}">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding SetSmartFolderMatchModeCommand}" CommandParameter="Any" />
                                </Border.GestureRecognizers>
                                <Label
                                    FontSize="{StaticResource FontSizeSmall}"
                                    Text="O (OR)"
                                    TextColor="{Binding IsSmartFolderMatchAny, Converter={StaticResource BoolToColorConverter}, ConverterParameter=#FF121212|#FFB1B1B1}"
                                    FontAttributes="{Binding IsSmartFolderMatchAny, Converter={StaticResource BoolToFontAttributesConverter}}"
                                    HorizontalOptions="Center"
                                    VerticalOptions="Center" />
                            </Border>
                        </Grid>
                    </VerticalStackLayout>

                    <!--  Lista de criterios  -->
                    <VerticalStackLayout Spacing="8">
                        <CollectionView
                            ItemsSource="{Binding NewSmartFolderCriteria}"
                            SelectionMode="None">
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:SmartFolderCriterion">
                                    <Grid ColumnDefinitions="*,*,*,Auto" ColumnSpacing="8" RowDefinitions="Auto,Auto" Margin="0,0,0,8">
                                        <Border
                                            Grid.Row="0"
                                            Grid.Column="0"
                                            Padding="12,8"
                                            BackgroundColor="#FF404040"
                                            Stroke="#FF3A3A3A"
                                            StrokeShape="RoundRectangle 4"
                                            HeightRequest="44">
                                            <Border.GestureRecognizers>
                                                <TapGestureRecognizer
                                                    Command="{Binding BindingContext.SelectCriterionFieldCommand, Source={x:Reference ThisPage}}"
                                                    CommandParameter="{Binding .}" />
                                            </Border.GestureRecognizers>
                                            <Grid ColumnDefinitions="*,Auto">
                                                <Label
                                                    Grid.Column="0"
                                                    Text="{Binding Field}"
                                                    TextColor="White"
                                                    VerticalOptions="Center" />
                                                <Label
                                                    Grid.Column="1"
                                                    Text="▼"
                                                    TextColor="#FF888888"
                                                    VerticalOptions="Center" />
                                            </Grid>
                                        </Border>
                                        <Border
                                            Grid.Row="0"
                                            Grid.Column="1"
                                            Padding="12,8"
                                            BackgroundColor="#FF404040"
                                            Stroke="#FF3A3A3A"
                                            StrokeShape="RoundRectangle 4"
                                            HeightRequest="44">
                                            <Border.GestureRecognizers>
                                                <TapGestureRecognizer
                                                    Command="{Binding BindingContext.SelectCriterionOperatorCommand, Source={x:Reference ThisPage}}"
                                                    CommandParameter="{Binding .}" />
                                            </Border.GestureRecognizers>
                                            <Grid ColumnDefinitions="*,Auto">
                                                <Label
                                                    Grid.Column="0"
                                                    Text="{Binding Operator}"
                                                    TextColor="White"
                                                    VerticalOptions="Center" />
                                                <Label
                                                    Grid.Column="1"
                                                    Text="▼"
                                                    TextColor="#FF888888"
                                                    VerticalOptions="Center" />
                                            </Grid>
                                        </Border>
                                        <Entry
                                            Grid.Row="0"
                                            Grid.Column="2"
                                            Placeholder="Valor"
                                            PlaceholderColor="#FF666666"
                                            Text="{Binding Value}"
                                            TextColor="White"
                                            BackgroundColor="#FF404040" />
                                        <Border
                                            Grid.Row="0"
                                            Grid.Column="3"
                                            Padding="4"
                                            BackgroundColor="Transparent"
                                            Stroke="Transparent"
                                            StrokeShape="RoundRectangle 4"
                                            VerticalOptions="Center">
                                            <Border.GestureRecognizers>
                                                <TapGestureRecognizer
                                                    Command="{Binding BindingContext.RemoveSmartFolderCriterionCommand, Source={x:Reference ThisPage}}"
                                                    CommandParameter="{Binding .}" />
                                            </Border.GestureRecognizers>
                                            <controls:SymbolIcon
                                                HeightRequest="{StaticResource IconSizeLarge}"
                                                SymbolName="trash"
                                                TintColor="#FF888888"
                                                WidthRequest="{StaticResource IconSizeLarge}" />
                                        </Border>

                                        <Entry
                                            Grid.Row="1"
                                            Grid.Column="2"
                                            IsVisible="{Binding ShowSecondValue}"
                                            Placeholder="Segundo valor (fecha)"
                                            PlaceholderColor="#FF666666"
                                            Text="{Binding Value2}"
                                            TextColor="White"
                                            BackgroundColor="#FF404040" />
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>

                        <Button
                            Text="Añadir condición"
                            BackgroundColor="#FF404040"
                            TextColor="#FFCCCCCC"
                            CornerRadius="8"
                            HeightRequest="{StaticResource ElementHeightLarge}"
                            Command="{Binding AddSmartFolderCriterionCommand}" />

                        <Label
                            FontSize="{StaticResource FontSizeSmall}"
                            TextColor="#FF888888"
                            Text="{Binding NewSmartFolderLiveMatchCount, StringFormat='Coinciden: {0}'}" />
                    </VerticalStackLayout>

                    <!--  Botones  -->
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="12" Margin="0,8,0,0">
                        <Button
                            Grid.Column="0"
                            Text="Cancelar"
                            BackgroundColor="#FF404040"
                            TextColor="#FFCCCCCC"
                            CornerRadius="8"
                            HeightRequest="{StaticResource ElementHeightLarge}"
                            Command="{Binding CancelSmartFolderSidebarPopupCommand}" />
                        <Button
                            Grid.Column="1"
                            Text="Crear"
                            BackgroundColor="#FF0066"
                            TextColor="#FF121212"
                            FontAttributes="None"
                            CornerRadius="8"
                            HeightRequest="{StaticResource ElementHeightLarge}"
                            Command="{Binding CreateSmartFolderCommand}" />
                    </Grid>
                </VerticalStackLayout>
            </Border>
        </Grid>

        <!--  Popup de selección de icono y color  -->
        <Grid
            Grid.Row="0"
            Grid.RowSpan="2"
            Grid.ColumnSpan="5"
            BackgroundColor="#CC000000"
            IsVisible="{Binding ShowIconColorPickerPopup}">
            <Grid.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding CloseIconColorPickerCommand}" />
            </Grid.GestureRecognizers>
            <Border
                Padding="20"
                BackgroundColor="#FF1E1E1E"
                HorizontalOptions="Center"
                Stroke="#FF3A3A3A"
                StrokeShape="RoundRectangle 12"
                StrokeThickness="1"
                VerticalOptions="Center"
                WidthRequest="380">
                <Border.GestureRecognizers>
                    <TapGestureRecognizer />
                </Border.GestureRecognizers>
                <VerticalStackLayout Spacing="16">
                    <!--  Cabecera con título y botón cerrar  -->
                    <Grid ColumnDefinitions="*,Auto">
                        <Label
                            Grid.Column="0"
                            FontAttributes="None"
                            FontSize="{StaticResource FontSizeTitle}"
                            Text="{Binding IconColorPickerTitle}"
                            TextColor="White"
                            VerticalOptions="Center" />
                        <Border
                            Grid.Column="1"
                            Padding="4"
                            BackgroundColor="Transparent"
                            Stroke="Transparent"
                            StrokeShape="RoundRectangle 4">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding CloseIconColorPickerCommand}" />
                            </Border.GestureRecognizers>
                            <controls:SymbolIcon
                                HeightRequest="{StaticResource IconSizeLarge}"
                                SymbolName="xmark"
                                TintColor="#FF888888"
                                WidthRequest="{StaticResource IconSizeLarge}" />
                        </Border>
                    </Grid>

                    <!--  Fila de colores  -->
                    <VerticalStackLayout Spacing="8">
                        <Label
                            FontSize="{StaticResource FontSizeSmall}"
                            Text="Color"
                            TextColor="#FF888888" />
                        <HorizontalStackLayout Spacing="8" HorizontalOptions="Center">
                            <!--  Círculos de color con marca de selección  -->
                            <!-- Blanco -->
                            <Border
                                WidthRequest="28"
                                HeightRequest="28"
                                BackgroundColor="#FFFFFFFF"
                                StrokeShape="RoundRectangle 14"
                                Stroke="#FF888888"
                                StrokeThickness="1">
                                <Border.Triggers>
                                    <DataTrigger TargetType="Border" Binding="{Binding SelectedPickerColor}" Value="#FFFFFFFF">
                                        <Setter Property="Stroke" Value="#FF0A84FF" />
                                        <Setter Property="StrokeThickness" Value="3" />
                                    </DataTrigger>
                                </Border.Triggers>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding SelectPickerColorCommand}" CommandParameter="#FFFFFFFF" />
                                </Border.GestureRecognizers>
                            </Border>
                            <!-- Gris -->
                            <Border
                                WidthRequest="28"
                                HeightRequest="28"
                                BackgroundColor="#FF888888"
                                StrokeShape="RoundRectangle 14"
                                Stroke="Transparent"
                                StrokeThickness="3">
                                <Border.Triggers>
                                    <DataTrigger TargetType="Border" Binding="{Binding SelectedPickerColor}" Value="#FF888888">
                                        <Setter Property="Stroke" Value="White" />
                                    </DataTrigger>
                                </Border.Triggers>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding SelectPickerColorCommand}" CommandParameter="#FF888888" />
                                </Border.GestureRecognizers>
                            </Border>
                            <Border
                                WidthRequest="28"
                                HeightRequest="28"
                                BackgroundColor="#FFFF453A"
                                StrokeShape="RoundRectangle 14"
                                Stroke="Transparent"
                                StrokeThickness="3">
                                <Border.Triggers>
                                    <DataTrigger TargetType="Border" Binding="{Binding SelectedPickerColor}" Value="#FFFF453A">
                                        <Setter Property="Stroke" Value="White" />
                                    </DataTrigger>
                                </Border.Triggers>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding SelectPickerColorCommand}" CommandParameter="#FFFF453A" />
                                </Border.GestureRecognizers>
                            </Border>
                            <Border
                                WidthRequest="28"
                                HeightRequest="28"
                                BackgroundColor="#FFFF9F0A"
                                StrokeShape="RoundRectangle 14"
                                Stroke="Transparent"
                                StrokeThickness="3">
                                <Border.Triggers>
                                    <DataTrigger TargetType="Border" Binding="{Binding SelectedPickerColor}" Value="#FFFF9F0A">
                                        <Setter Property="Stroke" Value="White" />
                                    </DataTrigger>
                                </Border.Triggers>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding SelectPickerColorCommand}" CommandParameter="#FFFF9F0A" />
                                </Border.GestureRecognizers>
                            </Border>
                            <Border
                                WidthRequest="28"
                                HeightRequest="28"
                                BackgroundColor="#FFFFD60A"
                                StrokeShape="RoundRectangle 14"
                                Stroke="Transparent"
                                StrokeThickness="3">
                                <Border.Triggers>
                                    <DataTrigger TargetType="Border" Binding="{Binding SelectedPickerColor}" Value="#FFFFD60A">
                                        <Setter Property="Stroke" Value="White" />
                                    </DataTrigger>
                                </Border.Triggers>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding SelectPickerColorCommand}" CommandParameter="#FFFFD60A" />
                                </Border.GestureRecognizers>
                            </Border>
                            <Border
                                WidthRequest="28"
                                HeightRequest="28"
                                BackgroundColor="#FF30D158"
                                StrokeShape="RoundRectangle 14"
                                Stroke="Transparent"
                                StrokeThickness="3">
                                <Border.Triggers>
                                    <DataTrigger TargetType="Border" Binding="{Binding SelectedPickerColor}" Value="#FF30D158">
                                        <Setter Property="Stroke" Value="White" />
                                    </DataTrigger>
                                </Border.Triggers>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding SelectPickerColorCommand}" CommandParameter="#FF30D158" />
                                </Border.GestureRecognizers>
                            </Border>
                            <Border
                                WidthRequest="28"
                                HeightRequest="28"
                                BackgroundColor="#FF64D2FF"
                                StrokeShape="RoundRectangle 14"
                                Stroke="Transparent"
                                StrokeThickness="3">
                                <Border.Triggers>
                                    <DataTrigger TargetType="Border" Binding="{Binding SelectedPickerColor}" Value="#FF64D2FF">
                                        <Setter Property="Stroke" Value="White" />
                                    </DataTrigger>
                                </Border.Triggers>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding SelectPickerColorCommand}" CommandParameter="#FF64D2FF" />
                                </Border.GestureRecognizers>
                            </Border>
                            <Border
                                WidthRequest="28"
                                HeightRequest="28"
                                BackgroundColor="#FF0A84FF"
                                StrokeShape="RoundRectangle 14"
                                Stroke="Transparent"
                                StrokeThickness="3">
                                <Border.Triggers>
                                    <DataTrigger TargetType="Border" Binding="{Binding SelectedPickerColor}" Value="#FF0A84FF">
                                        <Setter Property="Stroke" Value="White" />
                                    </DataTrigger>
                                </Border.Triggers>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding SelectPickerColorCommand}" CommandParameter="#FF0A84FF" />
                                </Border.GestureRecognizers>
                            </Border>
                            <Border
                                WidthRequest="28"
                                HeightRequest="28"
                                BackgroundColor="#FFBF5AF2"
                                StrokeShape="RoundRectangle 14"
                                Stroke="Transparent"
                                StrokeThickness="3">
                                <Border.Triggers>
                                    <DataTrigger TargetType="Border" Binding="{Binding SelectedPickerColor}" Value="#FFBF5AF2">
                                        <Setter Property="Stroke" Value="White" />
                                    </DataTrigger>
                                </Border.Triggers>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding SelectPickerColorCommand}" CommandParameter="#FFBF5AF2" />
                                </Border.GestureRecognizers>
                            </Border>
                            <Border
                                WidthRequest="28"
                                HeightRequest="28"
                                BackgroundColor="#FFFF375F"
                                StrokeShape="RoundRectangle 14"
                                Stroke="Transparent"
                                StrokeThickness="3">
                                <Border.Triggers>
                                    <DataTrigger TargetType="Border" Binding="{Binding SelectedPickerColor}" Value="#FFFF375F">
                                        <Setter Property="Stroke" Value="White" />
                                    </DataTrigger>
                                </Border.Triggers>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding SelectPickerColorCommand}" CommandParameter="#FFFF375F" />
                                </Border.GestureRecognizers>
                            </Border>
                            <Border
                                WidthRequest="28"
                                HeightRequest="28"
                                BackgroundColor="#FF0066"
                                StrokeShape="RoundRectangle 14"
                                Stroke="Transparent"
                                StrokeThickness="3">
                                <Border.Triggers>
                                    <DataTrigger TargetType="Border" Binding="{Binding SelectedPickerColor}" Value="#FF0066">
                                        <Setter Property="Stroke" Value="White" />
                                    </DataTrigger>
                                </Border.Triggers>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding SelectPickerColorCommand}" CommandParameter="#FF0066" />
                                </Border.GestureRecognizers>
                            </Border>
                        </HorizontalStackLayout>
                    </VerticalStackLayout>

                    <!--  Separador  -->
                    <BoxView HeightRequest="1" BackgroundColor="#FF3A3A3A" />

                    <!--  Grid de iconos  -->
                    <VerticalStackLayout Spacing="8">
                        <Label
                            FontSize="{StaticResource FontSizeSmall}"
                            Text="Icono"
                            TextColor="#FF888888" />
                        <FlexLayout
                            Direction="Row"
                            Wrap="Wrap"
                            JustifyContent="Start"
                            AlignContent="Start"
                            BindableLayout.ItemsSource="{Binding AvailableIcons}">
                            <BindableLayout.ItemTemplate>
                                <DataTemplate x:DataType="vm:IconPickerItem">
                                    <Border
                                        Margin="4"
                                        Padding="8"
                                        BackgroundColor="{Binding IsSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=#FF3A5A6A|#FF2A2A2A}"
                                        StrokeShape="RoundRectangle 6"
                                        Stroke="{Binding IsSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=#FF0066|Transparent}"
                                        StrokeThickness="2"
                                        WidthRequest="40"
                                        HeightRequest="40">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer
                                                Command="{Binding Source={x:Reference ThisPage}, Path=BindingContext.SelectPickerIconCommand}"
                                                CommandParameter="{Binding Name}" />
                                        </Border.GestureRecognizers>
                                        <controls:SymbolIcon
                                            SymbolName="{Binding Name}"
                                            TintColor="{Binding Source={x:Reference ThisPage}, Path=BindingContext.SelectedPickerColor, Converter={StaticResource HexStringToColorConverter}}"
                                            WidthRequest="20"
                                            HeightRequest="20"
                                            HorizontalOptions="Center"
                                            VerticalOptions="Center" />
                                    </Border>
                                </DataTemplate>
                            </BindableLayout.ItemTemplate>
                        </FlexLayout>
                    </VerticalStackLayout>
                </VerticalStackLayout>
            </Border>
        </Grid>

        <!--  Popup de edición en lote  -->
        <Grid
            Grid.Row="0"
            Grid.RowSpan="2"
            Grid.ColumnSpan="5"
            BackgroundColor="#CC000000"
            IsVisible="{Binding ShowBatchEditPopup}">
            <Border
                Padding="24"
                BackgroundColor="#FF1E1E1E"
                HorizontalOptions="Center"
                Stroke="#FF3A3A3A"
                StrokeShape="RoundRectangle 12"
                StrokeThickness="1"
                VerticalOptions="Center"
                WidthRequest="400">
                <VerticalStackLayout Spacing="16">
                    <!--  Título  -->
                    <Grid ColumnDefinitions="*,Auto">
                        <Label
                            FontAttributes="None"
                            FontSize="{StaticResource FontSizeTitle}"
                            Text="Editar vídeos seleccionados"
                            TextColor="White" />
                        <Border
                            Grid.Column="1"
                            Padding="4"
                            BackgroundColor="Transparent"
                            Stroke="Transparent"
                            StrokeShape="RoundRectangle 4">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding CloseBatchEditPopupCommand}" />
                            </Border.GestureRecognizers>
                            <controls:SymbolIcon
                                HeightRequest="{StaticResource IconSizeLarge}"
                                SymbolName="xmark"
                                TintColor="#FF888888"
                                WidthRequest="{StaticResource IconSizeLarge}" />
                        </Border>
                    </Grid>

                    <Label
                        FontSize="{StaticResource FontSizeBody}"
                        Text="{Binding SelectedVideoCount, StringFormat='Se modificarán {0} vídeos'}"
                        TextColor="#FFAAAAAA" />

                    <!--  Atleta  -->
                    <VerticalStackLayout Spacing="8">
                        <Grid ColumnDefinitions="Auto,*">
                            <CheckBox
                                IsChecked="{Binding BatchEditAthleteEnabled}"
                                Color="#FF0066"
                                VerticalOptions="Center" />
                            <Label
                                Grid.Column="1"
                                FontSize="{StaticResource FontSizeBody}"
                                Text="Asignar atleta"
                                TextColor="White"
                                VerticalOptions="Center" />
                        </Grid>
                        <ScrollView 
                            HeightRequest="120" 
                            IsEnabled="{Binding BatchEditAthleteEnabled}">
                            <FlexLayout
                                BindableLayout.ItemsSource="{Binding BatchEditAthletes}"
                                Direction="Row"
                                Wrap="Wrap">
                                <BindableLayout.ItemTemplate>
                                    <DataTemplate x:DataType="models:Athlete">
                                        <Border
                                            Margin="0,0,8,8"
                                            Padding="10,6"
                                            BackgroundColor="{Binding IsSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF4A9FD4|#FF2A2A2A'}"
                                            Stroke="{Binding IsSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF4A9FD4|#FF3A3A3A'}"
                                            StrokeShape="RoundRectangle 4">
                                            <Border.GestureRecognizers>
                                                <TapGestureRecognizer
                                                    Command="{Binding Source={x:Reference ThisPage}, Path=BindingContext.SelectBatchAthleteCommand}"
                                                    CommandParameter="{Binding .}" />
                                            </Border.GestureRecognizers>
                                            <Label
                                                FontSize="{StaticResource FontSizeSmall}"
                                                Text="{Binding NombreCompleto}"
                                                TextColor="White" />
                                        </Border>
                                    </DataTemplate>
                                </BindableLayout.ItemTemplate>
                            </FlexLayout>
                        </ScrollView>

                        <!--  Nuevo atleta (no existente)  -->
                        <Grid ColumnDefinitions="*,*,Auto" ColumnSpacing="8">
                            <Entry
                                BackgroundColor="#FF404040"
                                Placeholder="Apellido"
                                Text="{Binding NewBatchAthleteSurname}"
                                TextColor="White" />
                            <Entry
                                Grid.Column="1"
                                BackgroundColor="#FF404040"
                                Placeholder="Nombre"
                                Text="{Binding NewBatchAthleteName}"
                                TextColor="White" />
                            <Button
                                Grid.Column="2"
                                BackgroundColor="#FF3A3A3A"
                                Command="{Binding AddNewBatchAthleteCommand}"
                                Text="Añadir"
                                TextColor="White" />
                        </Grid>

                        <Label
                            FontSize="{StaticResource FontSizeSmall}"
                            Text="No hay atletas disponibles"
                            TextColor="#FF888888">
                            <Label.Triggers>
                                <DataTrigger TargetType="Label" Binding="{Binding BatchEditAthletes.Count}" Value="0">
                                    <Setter Property="IsVisible" Value="True" />
                                </DataTrigger>
                            </Label.Triggers>
                            <Label.Style>
                                <Style TargetType="Label">
                                    <Setter Property="IsVisible" Value="False" />
                                </Style>
                            </Label.Style>
                        </Label>
                    </VerticalStackLayout>

                    <!--  Sección  -->
                    <VerticalStackLayout Spacing="8">
                        <Grid ColumnDefinitions="Auto,*">
                            <CheckBox
                                IsChecked="{Binding BatchEditSectionEnabled}"
                                Color="#FF0066"
                                VerticalOptions="Center" />
                            <Label
                                Grid.Column="1"
                                FontSize="{StaticResource FontSizeBody}"
                                Text="Asignar sección/tramo"
                                TextColor="White"
                                VerticalOptions="Center" />
                        </Grid>
                        <HorizontalStackLayout IsEnabled="{Binding BatchEditSectionEnabled}" Spacing="12">
                            <Entry
                                BackgroundColor="#FF404040"
                                Keyboard="Numeric"
                                Text="{Binding BatchEditSection}"
                                TextColor="White"
                                WidthRequest="80" />
                            <Label
                                FontSize="{StaticResource FontSizeBody}"
                                Text="(1-99)"
                                TextColor="#FF888888"
                                VerticalOptions="Center" />
                        </HorizontalStackLayout>
                    </VerticalStackLayout>

                    <!--  Etiquetas  -->
                    <VerticalStackLayout Spacing="8">
                        <Label
                            FontSize="{StaticResource FontSizeBody}"
                            Text="Añadir etiquetas"
                            TextColor="White" />

                        <!--  Nueva etiqueta (no existente)  -->
                        <HorizontalStackLayout Spacing="12">
                            <Entry
                                BackgroundColor="#FF404040"
                                HorizontalOptions="FillAndExpand"
                                Placeholder="Nueva etiqueta"
                                Text="{Binding NewBatchTagText}"
                                TextColor="White" />
                            <Button
                                BackgroundColor="#FF3A3A3A"
                                Command="{Binding AddNewBatchTagCommand}"
                                Text="Añadir"
                                TextColor="White" />
                        </HorizontalStackLayout>

                        <FlexLayout
                            BindableLayout.ItemsSource="{Binding BatchEditTags}"
                            Direction="Row"
                            Wrap="Wrap">
                            <BindableLayout.ItemTemplate>
                                <DataTemplate x:DataType="models:Tag">
                                    <Border
                                        Margin="0,0,8,8"
                                        Padding="10,6"
                                        BackgroundColor="{Binding IsSelectedBool, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF4A9FD4|#FF2A2A2A'}"
                                        Stroke="{Binding IsSelectedBool, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF4A9FD4|#FF3A3A3A'}"
                                        StrokeShape="RoundRectangle 4">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer
                                                Command="{Binding Source={x:Reference ThisPage}, Path=BindingContext.ToggleBatchTagCommand}"
                                                CommandParameter="{Binding .}" />
                                        </Border.GestureRecognizers>
                                        <Label
                                            FontSize="{StaticResource FontSizeSmall}"
                                            Text="{Binding NombreTag}"
                                            TextColor="White" />
                                    </Border>
                                </DataTemplate>
                            </BindableLayout.ItemTemplate>
                        </FlexLayout>
                        <Label
                            FontSize="{StaticResource FontSizeSmall}"
                            Text="No hay etiquetas disponibles"
                            TextColor="#FF888888">
                            <Label.Triggers>
                                <DataTrigger TargetType="Label" Binding="{Binding BatchEditTags.Count}" Value="0">
                                    <Setter Property="IsVisible" Value="True" />
                                </DataTrigger>
                            </Label.Triggers>
                            <Label.Style>
                                <Style TargetType="Label">
                                    <Setter Property="IsVisible" Value="False" />
                                </Style>
                            </Label.Style>
                        </Label>
                    </VerticalStackLayout>

                    <!--  Botones  -->
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="12" Margin="0,8,0,0">
                        <Button
                            BackgroundColor="#FF3A3A3A"
                            Command="{Binding CloseBatchEditPopupCommand}"
                            Text="Cancelar"
                            TextColor="White" />
                        <Button
                            Grid.Column="1"
                            BackgroundColor="#FF4A9FD4"
                            Command="{Binding ApplyBatchEditCommand}"
                            Text="Aplicar"
                            TextColor="White" />
                    </Grid>
                </VerticalStackLayout>
            </Border>
        </Grid>

        <!--  Popup de edición de sesión  -->
        <Grid
            Grid.Row="0"
            Grid.RowSpan="2"
            Grid.ColumnSpan="5"
            BackgroundColor="#CC000000"
            IsVisible="{Binding ShowSessionEditPopup}">
            <Border
                Padding="24"
                BackgroundColor="#FF1E1E1E"
                HorizontalOptions="Center"
                Stroke="#FF3A3A3A"
                StrokeShape="RoundRectangle 12"
                StrokeThickness="1"
                VerticalOptions="Center"
                WidthRequest="400">
                <VerticalStackLayout Spacing="16">
                    <!--  Título  -->
                    <Grid ColumnDefinitions="*,Auto">
                        <Label
                            FontAttributes="None"
                            FontSize="{StaticResource FontSizeTitle}"
                            Text="Editar sesión"
                            TextColor="White" />
                        <Border
                            Grid.Column="1"
                            Padding="4"
                            BackgroundColor="Transparent"
                            Stroke="Transparent"
                            StrokeShape="RoundRectangle 4">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding CloseSessionEditPopupCommand}" />
                            </Border.GestureRecognizers>
                            <controls:SymbolIcon
                                HeightRequest="{StaticResource IconSizeLarge}"
                                SymbolName="xmark"
                                TintColor="#FF888888"
                                WidthRequest="{StaticResource IconSizeLarge}" />
                        </Border>
                    </Grid>

                    <!--  Nombre de sesión  -->
                    <VerticalStackLayout Spacing="8">
                        <Label
                            FontSize="{StaticResource FontSizeBody}"
                            Text="Nombre"
                            TextColor="#FFAAAAAA" />
                        <Entry
                            BackgroundColor="#FF404040"
                            Placeholder="Nombre de la sesión"
                            Text="{Binding SessionEditName}"
                            TextColor="White" />
                    </VerticalStackLayout>

                    <!--  Lugar  -->
                    <VerticalStackLayout Spacing="8">
                        <Label
                            FontSize="{StaticResource FontSizeBody}"
                            Text="Lugar"
                            TextColor="#FFAAAAAA" />
                        <Entry
                            BackgroundColor="#FF404040"
                            Placeholder="Lugar de la sesión"
                            Text="{Binding SessionEditLugar}"
                            TextColor="White" />
                    </VerticalStackLayout>

                    <!--  Tipo de sesión  -->
                    <VerticalStackLayout Spacing="8">
                        <Label
                            FontSize="{StaticResource FontSizeBody}"
                            Text="Tipo de sesión"
                            TextColor="#FFAAAAAA" />
                        <Entry
                            BackgroundColor="#FF404040"
                            Placeholder="Tipo de sesión"
                            Text="{Binding SessionEditTipoSesion}"
                            TextColor="White" />
                    </VerticalStackLayout>

                    <!--  Botones  -->
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="12" Margin="0,8,0,0">
                        <Button
                            BackgroundColor="#FF3A3A3A"
                            Command="{Binding CloseSessionEditPopupCommand}"
                            Text="Cancelar"
                            TextColor="White" />
                        <Button
                            Grid.Column="1"
                            BackgroundColor="#FF4A9FD4"
                            Command="{Binding ApplySessionEditCommand}"
                            Text="Guardar"
                            TextColor="White" />
                    </Grid>
                </VerticalStackLayout>
            </Border>
        </Grid>

        <!--  ===== POPUP: TABLA DE TIEMPOS DETALLADA =====  -->
        <Grid
            Grid.Row="0"
            Grid.RowSpan="2"
            Grid.ColumnSpan="5"
            BackgroundColor="#CC000000"
            IsVisible="{Binding ShowDetailedTimesPopup}">
            <Border
                Margin="12"
                Padding="12"
                BackgroundColor="#FF1E1E1E"
                HorizontalOptions="Fill"
                VerticalOptions="Fill"
                Stroke="#FF3A3A3A"
                StrokeShape="RoundRectangle 4"
                StrokeThickness="1">
                <Grid RowDefinitions="Auto,*,Auto" RowSpacing="16">
                    <!--  Cabecera  -->
                    <Grid ColumnDefinitions="*,Auto,Auto,Auto,Auto,Auto" ColumnSpacing="12">
                        <VerticalStackLayout Grid.Column="0" Spacing="2">
                            <Label
                                FontAttributes="None"
                                FontSize="{StaticResource FontSizeTitle}"
                                Text="Tiempos por Sección"
                                TextColor="White" />
                            <Label
                                FontSize="{StaticResource FontSizeSmall}"
                                LineBreakMode="TailTruncation"
                                Text="{Binding SelectedSessionTitle}"
                                TextColor="#FFCCCCCC" />
                        </VerticalStackLayout>
                        
                        <!--  Selector de atleta de referencia (dropdown estilo chip)  -->
                        <Grid Grid.Column="1" ColumnDefinitions="*,Auto" ColumnSpacing="6" VerticalOptions="Center" x:Name="AthleteDropdownTrigger">
                            <!--  Botón que abre el dropdown  -->
                            <Border
                                Grid.Column="0"
                                Padding="12,8"
                                BackgroundColor="#FF404040"
                                Stroke="#FF3A3A3A"
                                StrokeShape="RoundRectangle 4"
                                MinimumWidthRequest="180">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ToggleAthleteDropdownCommand}" />
                                </Border.GestureRecognizers>
                                <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                                    <Label
                                        Grid.Column="0"
                                        FontSize="{StaticResource FontSizeSubtitle}"
                                        Text="{Binding SelectedDetailedTimesAthleteName}"
                                        TextColor="White"
                                        LineBreakMode="TailTruncation"
                                        VerticalOptions="Center" />
                                    <controls:SymbolIcon
                                        Grid.Column="1"
                                        HeightRequest="12"
                                        SymbolName="chevron.down"
                                        TintColor="#FFB1B1B1"
                                        WidthRequest="12"
                                        VerticalOptions="Center" />
                                </Grid>
                            </Border>
                            <!--  Botón limpiar  -->
                            <Border
                                Grid.Column="1"
                                Padding="6"
                                BackgroundColor="Transparent"
                                Stroke="Transparent"
                                StrokeShape="RoundRectangle 4"
                                IsVisible="{Binding HasSelectedDetailedTimesAthlete}">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ClearDetailedTimesAthleteCommand}" />
                                </Border.GestureRecognizers>
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeSmall}"
                                    SymbolName="xmark.circle.fill"
                                    TintColor="#FFB1B1B1"
                                    WidthRequest="{StaticResource IconSizeSmall}" />
                            </Border>
                        </Grid>
                        
                        <!--  Botón de opciones de informe  -->
                        <Border
                            Grid.Column="2"
                            Padding="10,8"
                            BackgroundColor="#FF404040"
                            Stroke="#FF3A3A3A"
                            StrokeShape="RoundRectangle 4"
                            VerticalOptions="Center"
                            x:Name="ReportOptionsDropdownTrigger">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ToggleReportOptionsPanelCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="6">
                                <controls:SymbolIcon
                                    HeightRequest="14"
                                    SymbolName="slider.horizontal.3"
                                    TintColor="White"
                                    WidthRequest="14"
                                    VerticalOptions="Center" />
                                <Label
                                    FontSize="{StaticResource FontSizeSubtitle}"
                                    Text="Secciones"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                                <controls:SymbolIcon
                                    HeightRequest="10"
                                    SymbolName="chevron.down"
                                    TintColor="#FFB1B1B1"
                                    WidthRequest="10"
                                    VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>
                        
                        <!--  Botones Exportar  -->
                        <Border
                            Grid.Column="3"
                            Padding="10,8"
                            BackgroundColor="#FF404040"
                            Stroke="#FF3A3A3A"
                            StrokeShape="RoundRectangle 4"
                            VerticalOptions="Center"
                            Opacity="{Binding IsExportingDetailedTimes, Converter={StaticResource BoolToOpacityConverter}}">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ExportDetailedTimesHtmlCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="6">
                                <controls:SymbolIcon
                                    HeightRequest="14"
                                    SymbolName="arrow.down.doc"
                                    TintColor="White"
                                    WidthRequest="14"
                                    VerticalOptions="Center" />
                                <Label
                                    FontSize="{StaticResource FontSizeSubtitle}"
                                    Text="HTML"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>
                        <Border
                            Grid.Column="4"
                            Padding="10,8"
                            BackgroundColor="#FF404040"
                            Stroke="#FF3A3A3A"
                            StrokeShape="RoundRectangle 4"
                            VerticalOptions="Center"
                            Opacity="{Binding IsExportingDetailedTimes, Converter={StaticResource BoolToOpacityConverter}}">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ExportDetailedTimesPdfCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="6">
                                <controls:SymbolIcon
                                    HeightRequest="14"
                                    SymbolName="doc.richtext"
                                    TintColor="White"
                                    WidthRequest="14"
                                    VerticalOptions="Center" />
                                <Label
                                    FontSize="{StaticResource FontSizeSubtitle}"
                                    Text="PDF"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>
                        
                        <Border
                            Grid.Column="5"
                            Padding="6"
                            BackgroundColor="Transparent"
                            Stroke="Transparent"
                            StrokeShape="RoundRectangle 4"
                            VerticalOptions="Start">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding CloseDetailedTimesPopupCommand}" />
                            </Border.GestureRecognizers>
                            <controls:SymbolIcon
                                HeightRequest="{StaticResource IconSizeLarge}"
                                SymbolName="xmark"
                                TintColor="#FFB1B1B1"
                                WidthRequest="{StaticResource IconSizeLarge}" />
                        </Border>
                    </Grid>
                    
                    <!--  Contenido HTML/SVG (gráficos + tablas)  -->
                    <Grid Grid.Row="1">
                        <Border
                            BackgroundColor="White"
                            StrokeShape="RoundRectangle 12"
                            StrokeThickness="0">
                            <WebView BackgroundColor="White">
                                <WebView.Source>
                                    <HtmlWebViewSource Html="{Binding DetailedTimesHtml}" />
                                </WebView.Source>
                            </WebView>
                        </Border>
                        <ActivityIndicator
                            IsRunning="{Binding IsLoadingDetailedTimes}"
                            IsVisible="{Binding IsLoadingDetailedTimes}"
                            Color="#FF0066"
                            HeightRequest="48"
                            WidthRequest="48"
                            HorizontalOptions="Center"
                            VerticalOptions="Center" />
                    </Grid>
                    
                    <!--  Pie  -->
                    <Label
                        Grid.Row="2"
                        FontSize="{StaticResource FontSizeSmall}"
                        Text="Lap = tiempo parcial · Acum. = tiempo acumulado · CV% = Coeficiente de Variación = (σ / x̄) × 100 (menor = más consistente)"
                        TextColor="#FFCCCCCC"
                        VerticalOptions="Center" />
                    
                    <!--  ===== DROPDOWNS FLOTANTES (absolutos sobre todo el contenido) =====  -->
                    
                    <!--  Dropdown flotante de atletas  -->
                    <Border
                        Grid.RowSpan="3"
                        Margin="0,52,380,0"
                        Padding="8"
                        BackgroundColor="#FF404040"
                        HorizontalOptions="End"
                        IsVisible="{Binding IsAthleteDropdownExpanded}"
                        Stroke="#FF3A3A3A"
                        StrokeShape="RoundRectangle 4"
                        StrokeThickness="1"
                        VerticalOptions="Start"
                        ZIndex="200"
                        MaximumHeightRequest="280"
                        MinimumWidthRequest="220"
                        InputTransparent="False"
                        x:Name="AthleteDropdownPanel">
                        <ScrollView MaximumHeightRequest="260">
                            <VerticalStackLayout
                                BindableLayout.ItemsSource="{Binding DetailedTimesAthletes}"
                                Spacing="2">
                                <BindableLayout.ItemTemplate>
                                    <DataTemplate x:DataType="models:AthletePickerItem">
                                        <Border
                                            Padding="12,8"
                                            BackgroundColor="Transparent"
                                            Stroke="Transparent"
                                            StrokeShape="RoundRectangle 4">
                                            <Border.GestureRecognizers>
                                                <TapGestureRecognizer 
                                                    Command="{Binding Source={x:Reference ThisPage}, Path=BindingContext.SelectDetailedTimesAthleteCommand}"
                                                    CommandParameter="{Binding .}" />
                                            </Border.GestureRecognizers>
                                            <Label
                                                FontSize="{StaticResource FontSizeSubtitle}"
                                                Text="{Binding DisplayName}"
                                                TextColor="White"
                                                VerticalOptions="Center" />
                                        </Border>
                                    </DataTemplate>
                                </BindableLayout.ItemTemplate>
                            </VerticalStackLayout>
                        </ScrollView>
                    </Border>
                    
                    <!--  Panel flotante de opciones de secciones  -->
                    <Border
                        Grid.RowSpan="3"
                        Margin="0,52,200,0"
                        Padding="16"
                        BackgroundColor="#FF404040"
                        HorizontalOptions="End"
                        IsVisible="{Binding ShowReportOptionsPanel}"
                        Stroke="#FF3A3A3A"
                        StrokeShape="RoundRectangle 8"
                        StrokeThickness="1"
                        VerticalOptions="Start"
                        ZIndex="300"
                        MinimumWidthRequest="300"
                        InputTransparent="False"
                        x:Name="SectionsDropdownPanel">
                        <VerticalStackLayout Spacing="12">
                            <Label
                                FontAttributes="None"
                                FontSize="{StaticResource FontSizeSubtitle}"
                                Text="Secciones del informe"
                                TextColor="White" />
                            
                            <!--  Presets  -->
                            <HorizontalStackLayout Spacing="8">
                                <Border
                                    Padding="8,4"
                                    BackgroundColor="#FF3A3A3A"
                                    Stroke="Transparent"
                                    StrokeShape="RoundRectangle 4">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding ApplyQuickSummaryPresetCommand}" />
                                    </Border.GestureRecognizers>
                                    <Label
                                        FontSize="{StaticResource FontSizeSmall}"
                                        Text="Resumen rápido"
                                        TextColor="#FF0066" />
                                </Border>
                                <Border
                                    Padding="8,4"
                                    BackgroundColor="#FF3A3A3A"
                                    Stroke="Transparent"
                                    StrokeShape="RoundRectangle 4">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding ApplyFullAnalysisPresetCommand}" />
                                    </Border.GestureRecognizers>
                                    <Label
                                        FontSize="{StaticResource FontSizeSmall}"
                                        Text="Análisis completo"
                                        TextColor="#FF0066" />
                                </Border>
                                <Border
                                    Padding="8,4"
                                    BackgroundColor="#FF3A3A3A"
                                    Stroke="Transparent"
                                    StrokeShape="RoundRectangle 4">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding ApplyAthleteReportPresetCommand}" />
                                    </Border.GestureRecognizers>
                                    <Label
                                        FontSize="{StaticResource FontSizeSmall}"
                                        Text="Informe atleta"
                                        TextColor="#FF0066" />
                                </Border>
                            </HorizontalStackLayout>
                            
                            <BoxView HeightRequest="1" BackgroundColor="#FF3A3A3A" />
                            
                            <!--  Checkboxes de secciones  -->
                            <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto,Auto,Auto,Auto" RowSpacing="10" ColumnSpacing="16">
                                <HorizontalStackLayout Grid.Row="0" Grid.Column="0" Spacing="8">
                                    <CheckBox IsChecked="{Binding ReportOptions.ShowSessionHeader}" Color="#FF0066" />
                                    <Label Text="Cabecera de sesión" TextColor="White" FontSize="{StaticResource FontSizeSmall}" VerticalOptions="Center" />
                                </HorizontalStackLayout>
                                <HorizontalStackLayout Grid.Row="0" Grid.Column="1" Spacing="8">
                                    <CheckBox IsChecked="{Binding ReportOptions.ShowTrainingSummary}" Color="#FF0066" />
                                    <Label Text="Resumen entrenamiento" TextColor="White" FontSize="{StaticResource FontSizeSmall}" VerticalOptions="Center" />
                                </HorizontalStackLayout>
                                
                                <HorizontalStackLayout Grid.Row="1" Grid.Column="0" Spacing="8">
                                    <CheckBox IsChecked="{Binding ReportOptions.ShowGroupConsistency}" Color="#FF0066" />
                                    <Label Text="Consistencia grupo" TextColor="White" FontSize="{StaticResource FontSizeSmall}" VerticalOptions="Center" />
                                </HorizontalStackLayout>
                                <HorizontalStackLayout Grid.Row="1" Grid.Column="1" Spacing="8">
                                    <CheckBox IsChecked="{Binding ReportOptions.ShowMinMaxCharts}" Color="#FF0066" />
                                    <Label Text="Gráficos Min-Max" TextColor="White" FontSize="{StaticResource FontSizeSmall}" VerticalOptions="Center" />
                                </HorizontalStackLayout>
                                
                                <HorizontalStackLayout Grid.Row="2" Grid.Column="0" Spacing="8">
                                    <CheckBox IsChecked="{Binding ReportOptions.ShowTimeTables}" Color="#FF0066" />
                                    <Label Text="Tablas de tiempos" TextColor="White" FontSize="{StaticResource FontSizeSmall}" VerticalOptions="Center" />
                                </HorizontalStackLayout>
                                <HorizontalStackLayout Grid.Row="2" Grid.Column="1" Spacing="8">
                                    <CheckBox IsChecked="{Binding ReportOptions.ShowIndividualConsistency}" Color="#FF0066" />
                                    <Label Text="Consistencia individual" TextColor="White" FontSize="{StaticResource FontSizeSmall}" VerticalOptions="Center" />
                                </HorizontalStackLayout>
                                
                                <HorizontalStackLayout Grid.Row="3" Grid.Column="0" Spacing="8">
                                    <CheckBox IsChecked="{Binding ReportOptions.ShowLapAnalysis}" Color="#FF0066" />
                                    <Label Text="Análisis de parciales" TextColor="White" FontSize="{StaticResource FontSizeSmall}" VerticalOptions="Center" />
                                </HorizontalStackLayout>
                                <HorizontalStackLayout Grid.Row="3" Grid.Column="1" Spacing="8">
                                    <CheckBox IsChecked="{Binding ReportOptions.ShowRanking}" Color="#FF0066" />
                                    <Label Text="Ranking" TextColor="White" FontSize="{StaticResource FontSizeSmall}" VerticalOptions="Center" />
                                </HorizontalStackLayout>
                                
                                <HorizontalStackLayout Grid.Row="4" Grid.Column="0" Spacing="8">
                                    <CheckBox IsChecked="{Binding ReportOptions.ShowPenalties}" Color="#FF0066" />
                                    <Label Text="Penalizaciones" TextColor="White" FontSize="{StaticResource FontSizeSmall}" VerticalOptions="Center" />
                                </HorizontalStackLayout>
                                <HorizontalStackLayout Grid.Row="4" Grid.Column="1" Spacing="8">
                                    <CheckBox IsChecked="{Binding ReportOptions.ShowAthleteProfile}" Color="#FF0066" />
                                    <Label Text="Perfil del atleta" TextColor="White" FontSize="{StaticResource FontSizeSmall}" VerticalOptions="Center" />
                                </HorizontalStackLayout>
                            </Grid>
                            
                            <BoxView HeightRequest="1" BackgroundColor="#FF3A3A3A" />
                            
                            <!--  Botón aplicar  -->
                            <Button
                                BackgroundColor="#FF0066"
                                Command="{Binding ToggleReportOptionsPanelCommand}"
                                Text="Aplicar"
                                TextColor="#FF1E1E1E"
                                HeightRequest="36"
                                Padding="16,0" />
                        </VerticalStackLayout>
                    </Border>
                </Grid>
            </Border>
        </Grid>

        <!--  Footer de la aplicación  -->
        <controls:AppFooter
            Grid.Row="2"
            Grid.ColumnSpan="5" />

        <!--  Capa global para cerrar menús contextuales (solo visible cuando hay algún menú abierto)  -->
        <BoxView
            x:Name="GlobalDismissOverlay"
            Grid.RowSpan="3"
            Grid.ColumnSpan="5"
            BackgroundColor="#00000000"
            IsVisible="False"
            InputTransparent="{OnPlatform iOS=False, Default=True}"
            ZIndex="999">
            <BoxView.GestureRecognizers>
                <TapGestureRecognizer Buttons="Primary" Tapped="OnGlobalTapToDismissContextMenus" />
            </BoxView.GestureRecognizers>
        </BoxView>

        <!--  Menú contextual (overlay) para Mi biblioteca  -->
        <Grid
            x:Name="UserLibraryContextMenuOverlay"
            Grid.RowSpan="3"
            Grid.ColumnSpan="5"
            IsVisible="False"
            InputTransparent="True"
            CascadeInputTransparent="False"
            ZIndex="1000">
            <!-- Tap fuera para cerrar -->
            <BoxView BackgroundColor="#00000000" InputTransparent="True">
                <BoxView.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnUserLibraryContextMenuDismissTapped" />
                </BoxView.GestureRecognizers>
            </BoxView>

            <Border
                x:Name="UserLibraryContextMenu"
                WidthRequest="300"
                InputTransparent="False"
                Style="{StaticResource ContextMenuOverlayBorder}">
                <VerticalStackLayout Spacing="2">
                    <!--  Crear nueva biblioteca  -->
                    <Border Style="{StaticResource ContextMenuItemBorder}">
                        <Border.Behaviors>
                            <behaviors:SidebarHoverBehavior />
                        </Border.Behaviors>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnUserLibraryMenuCreateTapped" />
                        </Border.GestureRecognizers>
                        <HorizontalStackLayout Spacing="12" VerticalOptions="Center">
                            <controls:SymbolIcon
                                HeightRequest="18"
                                WidthRequest="18"
                                SymbolName="plus.rectangle.on.folder"
                                TintColor="#FFAAAAAA"
                                VerticalOptions="Center" />
                            <Label 
                                Text="Crear nueva biblioteca..." 
                                Style="{StaticResource ContextMenuItemLabel}" />
                        </HorizontalStackLayout>
                    </Border>

                    <!--  Importar otra biblioteca  -->
                    <Border Style="{StaticResource ContextMenuItemBorder}">
                        <Border.Behaviors>
                            <behaviors:SidebarHoverBehavior />
                        </Border.Behaviors>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnUserLibraryMenuImportTapped" />
                        </Border.GestureRecognizers>
                        <HorizontalStackLayout Spacing="12" VerticalOptions="Center">
                            <controls:SymbolIcon
                                HeightRequest="18"
                                WidthRequest="18"
                                SymbolName="folder.badge.plus"
                                TintColor="#FFAAAAAA"
                                VerticalOptions="Center" />
                            <Label 
                                Text="Importar otra biblioteca..." 
                                Style="{StaticResource ContextMenuItemLabel}" />
                        </HorizontalStackLayout>
                    </Border>

                    <!--  Vaciar caché y recargar  -->
                    <Border Style="{StaticResource ContextMenuItemBorder}">
                        <Border.Behaviors>
                            <behaviors:SidebarHoverBehavior />
                        </Border.Behaviors>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnUserLibraryMenuRefreshTapped" />
                        </Border.GestureRecognizers>
                        <HorizontalStackLayout Spacing="12" VerticalOptions="Center">
                            <controls:SymbolIcon
                                HeightRequest="18"
                                WidthRequest="18"
                                SymbolName="arrow.clockwise"
                                TintColor="#FFAAAAAA"
                                VerticalOptions="Center" />
                            <Label 
                                Text="Vaciar caché y recargar" 
                                Style="{StaticResource ContextMenuItemLabel}" />
                        </HorizontalStackLayout>
                    </Border>

                    <!--  Combinar con otra biblioteca  -->
                    <Border Style="{StaticResource ContextMenuItemBorder}">
                        <Border.Behaviors>
                            <behaviors:SidebarHoverBehavior />
                        </Border.Behaviors>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnUserLibraryMenuMergeTapped" />
                        </Border.GestureRecognizers>
                        <HorizontalStackLayout Spacing="12" VerticalOptions="Center">
                            <controls:SymbolIcon
                                HeightRequest="18"
                                WidthRequest="18"
                                SymbolName="arrow.triangle.merge"
                                TintColor="#FFAAAAAA"
                                VerticalOptions="Center" />
                            <Label 
                                Text="Combinar con otra biblioteca..." 
                                Style="{StaticResource ContextMenuItemLabel}" />
                        </HorizontalStackLayout>
                    </Border>
                </VerticalStackLayout>
            </Border>
        </Grid>

        <!--  Menú contextual (overlay) para Sesiones  -->
        <Grid
            x:Name="SessionsContextMenuOverlay"
            Grid.RowSpan="3"
            Grid.ColumnSpan="5"
            IsVisible="False"
            InputTransparent="True"
            CascadeInputTransparent="False"
            ZIndex="1000">
            <!-- Tap fuera para cerrar -->
            <BoxView BackgroundColor="#00000000" InputTransparent="True">
                <BoxView.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnSessionsContextMenuDismissTapped" />
                </BoxView.GestureRecognizers>
            </BoxView>

            <Border
                x:Name="SessionsContextMenu"
                WidthRequest="360"
                InputTransparent="False"
                Style="{StaticResource ContextMenuOverlayBorder}">
                <VerticalStackLayout Spacing="2">
                    <!--  Importar desde .crown  -->
                    <Border Style="{StaticResource ContextMenuItemBorder}">
                        <Border.Behaviors>
                            <behaviors:SidebarHoverBehavior />
                        </Border.Behaviors>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnSessionsMenuImportCrownTapped" />
                        </Border.GestureRecognizers>
                        <HorizontalStackLayout Spacing="12" VerticalOptions="Center">
                            <controls:SymbolIcon
                                HeightRequest="18"
                                WidthRequest="18"
                                SymbolName="square.and.arrow.down"
                                TintColor="#FFAAAAAA"
                                VerticalOptions="Center" />
                            <Label
                                Text="Importar desde .crown"
                                Style="{StaticResource ContextMenuItemLabel}" />
                        </HorizontalStackLayout>
                    </Border>

                    <!--  Nueva sesión desde archivos de video  -->
                    <Border Style="{StaticResource ContextMenuItemBorder}">
                        <Border.Behaviors>
                            <behaviors:SidebarHoverBehavior />
                        </Border.Behaviors>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnSessionsMenuNewFromVideosTapped" />
                        </Border.GestureRecognizers>
                        <HorizontalStackLayout Spacing="12" VerticalOptions="Center">
                            <controls:SymbolIcon
                                HeightRequest="18"
                                WidthRequest="18"
                                SymbolName="video.badge.plus"
                                TintColor="#FFAAAAAA"
                                VerticalOptions="Center" />
                            <Label
                                Text="Nueva sesión desde archivos de video"
                                Style="{StaticResource ContextMenuItemLabel}" />
                        </HorizontalStackLayout>
                    </Border>
                </VerticalStackLayout>
            </Border>
        </Grid>

        <!--  Menús contextuales de subitems (capa que NO afecta al layout ni bloquea clicks fuera)  -->
        <Grid
            x:Name="SubItemContextMenusLayer"
            Grid.Row="1"
            Grid.RowSpan="2"
            Grid.ColumnSpan="5"
            IsVisible="False"
            InputTransparent="True"
            CascadeInputTransparent="False"
            ZIndex="1000">

            <!-- Tap fuera para cerrar (no interfiere con el menú: el menú consume su propio tap) -->
            <BoxView BackgroundColor="#00000000" InputTransparent="True">
                <BoxView.GestureRecognizers>
                    <TapGestureRecognizer Buttons="Primary" Tapped="OnGlobalTapToDismissContextMenus" />
                </BoxView.GestureRecognizers>
            </BoxView>

            <!--  Menú contextual para subitem de Sesión  -->
            <Border
                x:Name="SessionRowContextMenu"
                IsVisible="False"
                WidthRequest="280"
                InputTransparent="False"
                Style="{StaticResource ContextMenuOverlayBorder}">
                <Border.GestureRecognizers>
                    <TapGestureRecognizer Buttons="Primary" Tapped="OnContextMenuSurfaceTapped" />
                </Border.GestureRecognizers>
                <VerticalStackLayout Spacing="2">
                    <Border Style="{StaticResource ContextMenuItemBorder}">
                        <Border.Behaviors>
                            <behaviors:SidebarHoverBehavior />
                        </Border.Behaviors>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnSessionRowMenuEditTapped" />
                        </Border.GestureRecognizers>
                        <HorizontalStackLayout Spacing="12" VerticalOptions="Center">
                            <controls:SymbolIcon
                                HeightRequest="18"
                                WidthRequest="18"
                                SymbolName="pencil"
                                TintColor="#FFAAAAAA"
                                VerticalOptions="Center" />
                            <Label
                                Text="Editar..."
                                Style="{StaticResource ContextMenuItemLabel}" />
                        </HorizontalStackLayout>
                    </Border>

                    <Border Style="{StaticResource ContextMenuItemBorder}">
                        <Border.Behaviors>
                            <behaviors:SidebarHoverBehavior />
                        </Border.Behaviors>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnSessionRowMenuCustomizeTapped" />
                        </Border.GestureRecognizers>
                        <HorizontalStackLayout Spacing="12" VerticalOptions="Center">
                            <controls:SymbolIcon
                                HeightRequest="18"
                                WidthRequest="18"
                                SymbolName="gearshape"
                                TintColor="#FFAAAAAA"
                                VerticalOptions="Center" />
                            <Label
                                Text="Personalizar..."
                                Style="{StaticResource ContextMenuItemLabel}" />
                        </HorizontalStackLayout>
                    </Border>


                    <Border
                        IsVisible="{OnPlatform iOS=True, MacCatalyst=True, WinUI=True, Default=False}"
                        Style="{StaticResource ContextMenuItemBorder}">
                        <Border.Behaviors>
                            <behaviors:SidebarHoverBehavior />
                        </Border.Behaviors>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnSessionRowMenuExportTapped" />
                        </Border.GestureRecognizers>
                        <HorizontalStackLayout Spacing="12" VerticalOptions="Center">
                            <controls:SymbolIcon
                                HeightRequest="18"
                                WidthRequest="18"
                                SymbolName="square.and.arrow.up"
                                TintColor="#FFAAAAAA"
                                VerticalOptions="Center" />
                            <Label
                                Text="Exportar"
                                Style="{StaticResource ContextMenuItemLabel}" />
                        </HorizontalStackLayout>
                    </Border>

                    <!-- Separador -->
                    <Border 
                        HeightRequest="1" 
                        BackgroundColor="#FF3A3A3A" 
                        Margin="4,6" 
                        HorizontalOptions="Fill"
                        Stroke="Transparent"
                        StrokeThickness="0" />

                    <Border Style="{StaticResource ContextMenuItemBorder}">
                        <Border.Behaviors>
                            <behaviors:SidebarHoverBehavior />
                        </Border.Behaviors>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnSessionRowMenuDeleteTapped" />
                        </Border.GestureRecognizers>
                        <HorizontalStackLayout Spacing="12" VerticalOptions="Center">
                            <controls:SymbolIcon
                                HeightRequest="18"
                                WidthRequest="18"
                                SymbolName="trash"
                                TintColor="#FFFF453A"
                                VerticalOptions="Center" />
                            <Label
                                Text="Eliminar"
                                Style="{StaticResource ContextMenuItemLabel}" />
                        </HorizontalStackLayout>
                    </Border>
                </VerticalStackLayout>
            </Border>

            <!--  Menú contextual para subitem de Carpeta inteligente  -->
            <Border
                x:Name="SmartFolderContextMenu"
                IsVisible="False"
                WidthRequest="300"
                InputTransparent="False"
                Style="{StaticResource ContextMenuOverlayBorder}">
                <Border.GestureRecognizers>
                    <TapGestureRecognizer Buttons="Primary" Tapped="OnContextMenuSurfaceTapped" />
                </Border.GestureRecognizers>
                <VerticalStackLayout Spacing="2">
                    <Border Style="{StaticResource ContextMenuItemBorder}">
                        <Border.Behaviors>
                            <behaviors:SidebarHoverBehavior />
                        </Border.Behaviors>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnSmartFolderMenuEditTapped" />
                        </Border.GestureRecognizers>
                        <HorizontalStackLayout Spacing="12" VerticalOptions="Center">
                            <controls:SymbolIcon
                                HeightRequest="18"
                                WidthRequest="18"
                                SymbolName="pencil"
                                TintColor="#FFAAAAAA"
                                VerticalOptions="Center" />
                            <Label
                                Text="Editar..."
                                Style="{StaticResource ContextMenuItemLabel}" />
                        </HorizontalStackLayout>
                    </Border>

                    <Border Style="{StaticResource ContextMenuItemBorder}">
                        <Border.Behaviors>
                            <behaviors:SidebarHoverBehavior />
                        </Border.Behaviors>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnSmartFolderMenuCustomizeTapped" />
                        </Border.GestureRecognizers>
                        <HorizontalStackLayout Spacing="12" VerticalOptions="Center">
                            <controls:SymbolIcon
                                HeightRequest="18"
                                WidthRequest="18"
                                SymbolName="gearshape"
                                TintColor="#FFAAAAAA"
                                VerticalOptions="Center" />
                            <Label
                                Text="Personalizar..."
                                Style="{StaticResource ContextMenuItemLabel}" />
                        </HorizontalStackLayout>
                    </Border>

                    <!-- Separador -->
                    <Border 
                        HeightRequest="1" 
                        BackgroundColor="#FF3A3A3A" 
                        Margin="4,6" 
                        HorizontalOptions="Fill"
                        Stroke="Transparent"
                        StrokeThickness="0" />

                    <Border Style="{StaticResource ContextMenuItemBorder}">
                        <Border.Behaviors>
                            <behaviors:SidebarHoverBehavior />
                        </Border.Behaviors>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnSmartFolderMenuDeleteTapped" />
                        </Border.GestureRecognizers>
                        <HorizontalStackLayout Spacing="12" VerticalOptions="Center">
                            <controls:SymbolIcon
                                HeightRequest="18"
                                WidthRequest="18"
                                SymbolName="trash"
                                TintColor="#FFFF453A"
                                VerticalOptions="Center" />
                            <Label
                                Text="Eliminar"
                                Style="{StaticResource ContextMenuItemLabel}" />
                        </HorizontalStackLayout>
                    </Border>
                </VerticalStackLayout>
            </Border>

            <!--  Menú contextual para Video Item  -->
            <Border
                x:Name="VideoItemContextMenu"
                IsVisible="False"
                WidthRequest="280"
                InputTransparent="False"
                Style="{StaticResource ContextMenuOverlayBorder}">
                <Border.GestureRecognizers>
                    <TapGestureRecognizer Buttons="Primary" Tapped="OnContextMenuSurfaceTapped" />
                </Border.GestureRecognizers>
                <VerticalStackLayout Spacing="2">
                    <!--  Abrir en reproductor  -->
                    <Border Style="{StaticResource ContextMenuItemBorder}">
                        <Border.Behaviors>
                            <behaviors:SidebarHoverBehavior />
                        </Border.Behaviors>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnVideoItemMenuOpenTapped" />
                        </Border.GestureRecognizers>
                        <HorizontalStackLayout Spacing="12" VerticalOptions="Center">
                            <controls:SymbolIcon
                                HeightRequest="18"
                                WidthRequest="18"
                                SymbolName="play.rectangle"
                                TintColor="#FFAAAAAA"
                                VerticalOptions="Center" />
                            <Label
                                Text="Abrir en reproductor"
                                Style="{StaticResource ContextMenuItemLabel}" />
                        </HorizontalStackLayout>
                    </Border>

                    <!--  Editar  -->
                    <Border Style="{StaticResource ContextMenuItemBorder}">
                        <Border.Behaviors>
                            <behaviors:SidebarHoverBehavior />
                        </Border.Behaviors>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnVideoItemMenuEditTapped" />
                        </Border.GestureRecognizers>
                        <HorizontalStackLayout Spacing="12" VerticalOptions="Center">
                            <controls:SymbolIcon
                                HeightRequest="18"
                                WidthRequest="18"
                                SymbolName="pencil"
                                TintColor="#FFAAAAAA"
                                VerticalOptions="Center" />
                            <Label
                                Text="Editar..."
                                Style="{StaticResource ContextMenuItemLabel}" />
                        </HorizontalStackLayout>
                    </Border>

                    <!--  Compartir  -->
                    <Border Style="{StaticResource ContextMenuItemBorder}">
                        <Border.Behaviors>
                            <behaviors:SidebarHoverBehavior />
                        </Border.Behaviors>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnVideoItemMenuShareTapped" />
                        </Border.GestureRecognizers>
                        <HorizontalStackLayout Spacing="12" VerticalOptions="Center">
                            <controls:SymbolIcon
                                HeightRequest="18"
                                WidthRequest="18"
                                SymbolName="square.and.arrow.up"
                                TintColor="#FFAAAAAA"
                                VerticalOptions="Center" />
                            <Label
                                Text="Compartir"
                                Style="{StaticResource ContextMenuItemLabel}" />
                        </HorizontalStackLayout>
                    </Border>

                    <!-- Separador -->
                    <Border 
                        HeightRequest="1" 
                        BackgroundColor="#FF3A3A3A" 
                        Margin="4,6" 
                        HorizontalOptions="Fill"
                        Stroke="Transparent"
                        StrokeThickness="0" />

                    <!--  Eliminar  -->
                    <Border Style="{StaticResource ContextMenuItemBorder}">
                        <Border.Behaviors>
                            <behaviors:SidebarHoverBehavior />
                        </Border.Behaviors>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnVideoItemMenuDeleteTapped" />
                        </Border.GestureRecognizers>
                        <HorizontalStackLayout Spacing="12" VerticalOptions="Center">
                            <controls:SymbolIcon
                                HeightRequest="18"
                                WidthRequest="18"
                                SymbolName="trash"
                                TintColor="#FFFF453A"
                                VerticalOptions="Center" />
                            <Label
                                Text="Eliminar"
                                Style="{StaticResource ContextMenuItemLabel}"
                                TextColor="#FFFF453A" />
                        </HorizontalStackLayout>
                    </Border>
                </VerticalStackLayout>
            </Border>
        </Grid>
    </Grid>
</ContentPage>
