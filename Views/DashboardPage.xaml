<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="CrownRFEP_Reader.Views.DashboardPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:behaviors="clr-namespace:CrownRFEP_Reader.Behaviors"
    xmlns:controls="clr-namespace:CrownRFEP_Reader.Views.Controls"
    xmlns:appcontrols="clr-namespace:CrownRFEP_Reader.Controls"
    xmlns:converters="clr-namespace:CrownRFEP_Reader.Converters"
    xmlns:models="clr-namespace:CrownRFEP_Reader.Models"
    xmlns:services="clr-namespace:CrownRFEP_Reader.Services"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:viewmodels="clr-namespace:CrownRFEP_Reader.ViewModels"
    xmlns:vm="clr-namespace:CrownRFEP_Reader.ViewModels"
    Title="{Binding Title}"
    x:DataType="vm:DashboardViewModel"
    BackgroundColor="#FF121212">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:BoolToTextConverter x:Key="BoolToTextConverter" />
            <converters:EqualityToBorderWidthConverter x:Key="EqualityToBorderWidthConverter" />
            <converters:NotNullOrEmptyBoolConverter x:Key="NotNullOrEmptyBoolConverter" />
            <converters:IsNotNullConverter x:Key="IsNotNullConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid
        Padding="0"
        RowDefinitions="Auto,*,Auto">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="350" />
            <ColumnDefinition Width="8" />
            <ColumnDefinition Width="2.5*" />
            <ColumnDefinition Width="{Binding RightSplitterWidth}" />
            <ColumnDefinition Width="{Binding RightPanelWidth}" />
        </Grid.ColumnDefinitions>
        <controls:TopTabsBar
            Grid.Row="0"
            Grid.ColumnSpan="5"
            BackgroundColor="#FF121212"
            HorizontalOptions="Center" />

        <!--  Línea horizontal separadora entre fila 0 y fila 1  -->
        <BoxView
            Grid.Row="0"
            Grid.ColumnSpan="5"
            Margin="0"
            BackgroundColor="#FF3A3A3A"
            HeightRequest="1"
            HorizontalOptions="Fill"
            VerticalOptions="End" />

        <!--  GridSplitter entre columna 0 y 2  -->
        <controls:GridSplitter
            Grid.Row="1"
            Grid.Column="1"
            LeftColumnIndex="0"
            MinLeftWidth="200"
            MinRightWidth="300"
            RightColumnIndex="2"
            WidthRequest="8" />

        <!--  GridSplitter entre columna 2 y 4  -->
        <controls:GridSplitter
            Grid.Row="1"
            Grid.Column="3"
            LeftColumnIndex="2"
            MinLeftWidth="300"
            MinRightWidth="200"
            RightColumnIndex="4"
            IsVisible="{Binding IsVideoLessonsSelected, Converter={toolkit:InvertedBoolConverter}}"
            WidthRequest="8" />

        <!--  Lista de sesiones recientes + acciones en la parte baja  -->
        <Grid
            Grid.Row="1"
            Grid.Column="0"
            Padding="20,0"
            RowDefinitions="*,Auto">

            <CollectionView
                Grid.Row="0"
                Margin="0,20,0,0"
                BackgroundColor="#00BBBABA"
                ItemsSource="{Binding VisibleRecentSessions}"
                SelectedItem="{Binding SelectedSession, Mode=TwoWay}"
                SelectionMode="Single">

                <!--  Items fijos: Galería General + Videolecciones  -->
                <CollectionView.Header>
                    <VerticalStackLayout Spacing="4">
                        <Border
                            x:Name="AllGalleryHeaderBorder"
                            Margin="0,0,0,0"
                            BackgroundColor="Transparent"
                            Stroke="Transparent"
                            StrokeThickness="0"
                            StrokeShape="RoundRectangle 4">
                            <Border.Behaviors>
                                <behaviors:DashboardAllGalleryHoverBehavior />
                            </Border.Behaviors>
                            <Border.Triggers>
                                <DataTrigger
                                    TargetType="Border"
                                    Binding="{Binding IsAllGallerySelected}"
                                    Value="True">
                                    <Setter Property="BackgroundColor" Value="#FF3A3A3A" />
                                </DataTrigger>
                            </Border.Triggers>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding SelectAllGalleryCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout
                                Padding="16,10"
                                Spacing="8"
                                VerticalOptions="Center">
                                <controls:SymbolIcon
                                    HeightRequest="24"
                                    SymbolName="photo.on.rectangle.angled"
                                    TintColor="#FF6DDDFF"
                                    VerticalOptions="Center"
                                    WidthRequest="24" />
                                <Label
                                    FontFamily="SF Pro Text"
                                    FontSize="16"
                                    Text="Galería General"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>

                        <Border
                            x:Name="VideoLessonsHeaderBorder"
                            Margin="0"
                            BackgroundColor="Transparent"
                            Stroke="Transparent"
                            StrokeThickness="0"
                            StrokeShape="RoundRectangle 4">
                            <Border.Behaviors>
                                <behaviors:DashboardAllGalleryHoverBehavior />
                            </Border.Behaviors>
                            <Border.Triggers>
                                <DataTrigger
                                    TargetType="Border"
                                    Binding="{Binding IsVideoLessonsSelected}"
                                    Value="True">
                                    <Setter Property="BackgroundColor" Value="#FF3A3A3A" />
                                </DataTrigger>
                            </Border.Triggers>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ViewVideoLessonsCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout
                                Padding="16,10"
                                Spacing="8"
                                VerticalOptions="Center">
                                <controls:SymbolIcon
                                    HeightRequest="24"
                                    SymbolName="video"
                                    TintColor="#FF6DDDFF"
                                    VerticalOptions="Center"
                                    WidthRequest="24" />
                                <Label
                                    FontFamily="SF Pro Text"
                                    FontSize="16"
                                    Text="Videolecciones"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>

                        <!--  Diario Personal  -->
                        <Border
                            x:Name="DiaryHeaderBorder"
                            Margin="0"
                            BackgroundColor="Transparent"
                            Stroke="Transparent"
                            StrokeThickness="0"
                            StrokeShape="RoundRectangle 4">
                            <Border.Behaviors>
                                <behaviors:DashboardAllGalleryHoverBehavior />
                            </Border.Behaviors>
                            <Border.Triggers>
                                <DataTrigger
                                    TargetType="Border"
                                    Binding="{Binding IsDiaryViewSelected}"
                                    Value="True">
                                    <Setter Property="BackgroundColor" Value="#FF3A3A3A" />
                                </DataTrigger>
                            </Border.Triggers>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ViewDiaryCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout
                                Padding="16,10"
                                Spacing="8"
                                VerticalOptions="Center">
                                <controls:SymbolIcon
                                    HeightRequest="24"
                                    SymbolName="book"
                                    TintColor="#FF6DDDFF"
                                    VerticalOptions="Center"
                                    WidthRequest="24" />
                                <Label
                                    FontFamily="SF Pro Text"
                                    FontSize="16"
                                    Text="Diario"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>

                        <!--  Item padre: Sesiones (expandir/colapsar)  -->
                        <Border
                            x:Name="SessionsHeaderBorder"
                            Margin="0"
                            BackgroundColor="Transparent"
                            Stroke="Transparent"
                            StrokeThickness="0"
                            StrokeShape="RoundRectangle 4">
                            <Border.Behaviors>
                                <behaviors:DashboardAllGalleryHoverBehavior />
                            </Border.Behaviors>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ToggleSessionsListExpandedCommand}" />
                            </Border.GestureRecognizers>
                            <Grid
                                Padding="16,10"
                                ColumnDefinitions="*,Auto"
                                VerticalOptions="Center">
                                <HorizontalStackLayout
                                    Grid.Column="0"
                                    Spacing="8"
                                    VerticalOptions="Center">
                                    <controls:SymbolIcon
                                        HeightRequest="24"
                                        SymbolName="clock"
                                        TintColor="#FF6DDDFF"
                                        VerticalOptions="Center"
                                        WidthRequest="24" />
                                    <Label
                                        FontFamily="SF Pro Text"
                                        FontSize="16"
                                        Text="Sesiones"
                                        TextColor="White"
                                        VerticalOptions="Center" />
                                </HorizontalStackLayout>
                                <Label
                                    Grid.Column="1"
                                    FontSize="16"
                                    Text="{Binding IsSessionsListExpanded, Converter={StaticResource BoolToExpandIconConverter}}"
                                    TextColor="Gray"
                                    VerticalOptions="Center" />
                            </Grid>
                        </Border>
                    </VerticalStackLayout>
                </CollectionView.Header>

                <CollectionView.ItemsLayout>
                    <LinearItemsLayout ItemSpacing="4" Orientation="Vertical" />
                </CollectionView.ItemsLayout>
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:Session">
                        <Border
                            Margin="0"
                            BackgroundColor="Transparent"
                            Stroke="Transparent"
                            StrokeShape="RoundRectangle 4">
                            <Border.Behaviors>
                                <behaviors:DashboardSessionItemHoverBehavior />
                            </Border.Behaviors>
                            <HorizontalStackLayout
                                Padding="16,10"
                                Spacing="8"
                                VerticalOptions="Center">
                                <controls:SymbolIcon
                                    HeightRequest="20"
                                    SymbolName="arrow.turn.down.right"
                                    TintColor="#FF888888"
                                    VerticalOptions="Center"
                                    WidthRequest="20" />
                                <controls:SymbolIcon
                                    HeightRequest="24"
                                    SymbolName="oar.2.crossed"
                                    TintColor="#FF6DDDFF"
                                    VerticalOptions="Center"
                                    WidthRequest="24" />
                                <Label
                                    FontFamily="SF Pro Text"
                                    FontSize="16"
                                    LineBreakMode="TailTruncation"
                                    TextColor="White">
                                    <Label.FormattedText>
                                        <FormattedString>
                                            <Span
                                                FontSize="16"
                                                Text="{Binding FechaDateTime, StringFormat='{0:dd/MM/yyyy}'}"
                                                TextColor="White" />
                                            <Span
                                                FontSize="16"
                                                Text=" en "
                                                TextColor="White" />
                                            <Span
                                                FontSize="16"
                                                Text="{Binding Lugar}"
                                                TextColor="White" />
                                            <Span
                                                FontSize="16"
                                                Text=" - "
                                                TextColor="White" />
                                            <Span
                                                FontSize="16"
                                                Text="{Binding DisplayName}"
                                                TextColor="White" />
                                        </FormattedString>
                                    </Label.FormattedText>
                                </Label>
                            </HorizontalStackLayout>
                            <VisualStateManager.VisualStateGroups>
                                <VisualStateGroup Name="CommonStates">
                                    <VisualState Name="Normal">
                                        <VisualState.Setters>
                                            <Setter Property="BackgroundColor" Value="Transparent" />
                                        </VisualState.Setters>
                                    </VisualState>
                                    <VisualState Name="Selected">
                                        <VisualState.Setters>
                                            <Setter Property="BackgroundColor" Value="#FF3A3A3A" />
                                        </VisualState.Setters>
                                    </VisualState>
                                </VisualStateGroup>
                            </VisualStateManager.VisualStateGroups>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>

                <CollectionView.EmptyView>
                    <VerticalStackLayout
                        Padding="40"
                        HorizontalOptions="Center"
                        VerticalOptions="Center"
                        IsVisible="{Binding IsSessionsListExpanded}">
                        <Label
                            FontSize="18"
                            HorizontalOptions="Center"
                            Text="No hay sesiones"
                            TextColor="Gray" />
                        <Label
                            FontSize="14"
                            HorizontalOptions="Center"
                            Text="Importa un archivo .crown para comenzar"
                            TextColor="Gray" />
                    </VerticalStackLayout>
                </CollectionView.EmptyView>
            </CollectionView>

            <!--  Acciones de sesión  -->
            <VerticalStackLayout Grid.Row="1" Spacing="10" Margin="0,20,0,20">
                <Label
                    FontFamily="SF Pro Text"
                    FontSize="14"
                    FontAttributes="Bold"
                    Text="Acciones de sesión"
                    TextColor="#FF888888" />
                <Grid ColumnDefinitions="*,*" ColumnSpacing="4">
                    <Border
                        Grid.Column="0"
                        Padding="10,8"
                        BackgroundColor="#FF2A2A2A"
                        Stroke="Transparent"
                        StrokeShape="RoundRectangle 4">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding ImportCommand}" />
                        </Border.GestureRecognizers>
                        <HorizontalStackLayout HorizontalOptions="Center" Spacing="6">
                            <controls:SymbolIcon
                                HeightRequest="16"
                                SymbolName="square.and.arrow.down"
                                TintColor="White"
                                WidthRequest="16"
                                VerticalOptions="Center" />
                            <Label Text="Importar" TextColor="White" VerticalOptions="Center" />
                        </HorizontalStackLayout>
                    </Border>
                    <Border
                        Grid.Column="1"
                        Padding="10,8"
                        BackgroundColor="#FF2A2A2A"
                        Stroke="Transparent"
                        StrokeShape="RoundRectangle 4">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding DeleteSelectedSessionCommand}" />
                        </Border.GestureRecognizers>
                        <HorizontalStackLayout HorizontalOptions="Center" Spacing="6">
                            <controls:SymbolIcon
                                HeightRequest="16"
                                SymbolName="trash"
                                TintColor="#FFFF9696"
                                WidthRequest="16"
                                VerticalOptions="Center" />
                            <Label Text="Eliminar" TextColor="#FFFF9696" VerticalOptions="Center" />
                        </HorizontalStackLayout>
                    </Border>
                </Grid>
            </VerticalStackLayout>
        </Grid>

        <!--  Panel derecho: vídeos de la sesión seleccionada  -->
        <Grid
            Grid.Row="1"
            Grid.Column="2"
            Padding="20"
            RowDefinitions="Auto,Auto,*">
            <Label
                Grid.Row="0"
                FontSize="18"
                LineBreakMode="TailTruncation"
                Text="{Binding SelectedSessionTitle}"
                TextColor="White" />

            <HorizontalStackLayout
                Grid.Row="1"
                Spacing="10"
                VerticalOptions="Center">
                <Label
                    FontSize="14"
                    Text="{Binding VideoCountDisplayText}"
                    TextColor="#FFB1B1B1" />
                <ActivityIndicator
                    HeightRequest="16"
                    IsRunning="{Binding IsLoadingSelectedSessionVideos}"
                    IsVisible="{Binding IsLoadingSelectedSessionVideos}"
                    WidthRequest="16"
                    Color="White" />
            </HorizontalStackLayout>

            <CollectionView
                x:Name="VideoGallery"
                Grid.Row="2"
                ItemsSource="{Binding SelectedSessionVideos}"
                IsVisible="{Binding ShowVideoGallery}"
                RemainingItemsThreshold="10"
                RemainingItemsThresholdReachedCommand="{Binding LoadMoreVideosCommand}"
                SelectionMode="None" Margin="0,10,0,0">
                <CollectionView.ItemsLayout>
                    <GridItemsLayout
                        HorizontalItemSpacing="4"
                        Orientation="Vertical"
                        Span="4"
                        VerticalItemSpacing="10" />
                </CollectionView.ItemsLayout>

                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:VideoClip">
                        <Border
                            BackgroundColor="#FF2A2A2A"
                            Stroke="Transparent"
                            StrokeShape="RoundRectangle 4"
                            StrokeThickness="0">
                            <Border.Behaviors>
                                <behaviors:HoverBackgroundBehavior />
                            </Border.Behaviors>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:DashboardViewModel}}, Path=VideoTapCommand}" CommandParameter="{Binding .}" />
                                <DragGestureRecognizer CanDrag="True" DragStarting="OnDragStarting" />
                            </Border.GestureRecognizers>
                            <Border.Triggers>
                                <DataTrigger TargetType="Border" Binding="{Binding IsSelected}" Value="True">
                                    <Setter Property="Stroke" Value="#FF6DDDFF" />
                                    <Setter Property="StrokeThickness" Value="2" />
                                </DataTrigger>
                            </Border.Triggers>

                            <Grid RowDefinitions="Auto,Auto">
                                <!--  Thumbnail con aspect ratio 16:9  -->
                                <controls:AspectRatioContainer AspectRatio="1.777">
                                    <Grid>
                                        <Image
                                            Aspect="AspectFill"
                                            BackgroundColor="{StaticResource Gray300}"
                                            Source="{Binding LocalThumbnailPath}" />

                                        <!--  Overlay de play (oculto cuando está seleccionado en multiselect)  -->
                                       <controls:SymbolIcon
                            HeightRequest="50"
                            SymbolName="play.circle.fill"
                            TintColor="Black" Opacity="0.5"
                            VerticalOptions="Center"
                            WidthRequest="50" />

                                        <!--  Checkmark de selección  -->
                                        <Border
                                            BackgroundColor="#34000000"
                                            HeightRequest="32"
                                            HorizontalOptions="End"
                                            IsVisible="{Binding IsSelected}"
                                            Margin="6"
                                            StrokeShape="RoundRectangle 16"
                                            VerticalOptions="Start"
                                            WidthRequest="32">
                                            <controls:SymbolIcon
                                                HeightRequest="20"
                                                HorizontalOptions="Center"
                                                SymbolName="checkmark"
                                                TintColor="LightGray"
                                                VerticalOptions="Center"
                                                WidthRequest="20" />
                                        </Border>
                                        
                                        <!--  Indicador de video comparativo  -->
                                        <Border
                                            BackgroundColor="#CC000000"
                                            HeightRequest="28"
                                            HorizontalOptions="Start"
                                            IsVisible="{Binding IsComparisonVideo}"
                                            Margin="6"
                                            Padding="6,4"
                                            StrokeShape="RoundRectangle 4"
                                            StrokeThickness="0"
                                            VerticalOptions="Start">
                                            <HorizontalStackLayout Spacing="4">
                                                <controls:SymbolIcon
                                                    HeightRequest="16"
                                                    SymbolName="rectangle.on.rectangle"
                                                    TintColor="#FF6DDDFF"
                                                    VerticalOptions="Center"
                                                    WidthRequest="16" />
                                                <Label
                                                    FontSize="10"
                                                    Text="VS"
                                                    TextColor="#FF6DDDFF"
                                                    VerticalOptions="Center"
                                                    FontAttributes="Bold" />
                                            </HorizontalStackLayout>
                                        </Border>
                                    </Grid>
                                </controls:AspectRatioContainer>

                                <!--  Footer con info y botón de preview  -->
                                <Grid
                                    Grid.Row="1"
                                    Padding="8"
                                    ColumnDefinitions="*,Auto">
                                    <VerticalStackLayout Spacing="2">
                                        <!--  Primera línea: APELLIDOS Nombre - Sesión  -->
                                        <Label
                                            FontSize="12"
                                            FontAttributes="Bold"
                                            LineBreakMode="TailTruncation"
                                            Text="{Binding DisplayLine1}"
                                            TextColor="White" />
                                        <!--  Segunda línea: Lugar, fecha y hora  -->
                                        <Label
                                            FontSize="11"
                                            LineBreakMode="TailTruncation"
                                            Text="{Binding DisplayLine2}"
                                            TextColor="#FFB1B1B1" />
                                        
                                        <!--  Tags del video (chips)  -->
                                        <ScrollView
                                            Orientation="Horizontal"
                                            Margin="0,2,0,0"
                                            HorizontalScrollBarVisibility="Never">
                                            <HorizontalStackLayout Spacing="4">
                                                <!--  Tags asignados (verde)  -->
                                                <HorizontalStackLayout
                                                    Spacing="4"
                                                    BindableLayout.ItemsSource="{Binding Tags}">
                                                    <BindableLayout.ItemTemplate>
                                                        <DataTemplate x:DataType="models:Tag">
                                                            <Border
                                                                Padding="6,2"
                                                                BackgroundColor="#FF006A05"
                                                                StrokeShape="RoundRectangle 2"
                                                                StrokeThickness="0">
                                                                <Label
                                                                    FontSize="10"
                                                                    Text="{Binding NombreTag}"
                                                                    TextColor="White"
                                                                    LineBreakMode="TailTruncation"
                                                                    MaximumWidthRequest="120" />
                                                            </Border>
                                                        </DataTemplate>
                                                    </BindableLayout.ItemTemplate>
                                                </HorizontalStackLayout>
                                                <!--  Tags de eventos (naranja)  -->
                                                <HorizontalStackLayout
                                                    Spacing="4"
                                                    BindableLayout.ItemsSource="{Binding EventTags}">
                                                    <BindableLayout.ItemTemplate>
                                                        <DataTemplate x:DataType="models:Tag">
                                                            <Border
                                                                Padding="6,2"
                                                                BackgroundColor="#FFFF8C00"
                                                                StrokeShape="RoundRectangle 2"
                                                                StrokeThickness="0">
                                                                <Label
                                                                    FontSize="10"
                                                                    Text="{Binding DisplayText}"
                                                                    TextColor="White"
                                                                    LineBreakMode="TailTruncation"
                                                                    MaximumWidthRequest="120" />
                                                            </Border>
                                                        </DataTemplate>
                                                    </BindableLayout.ItemTemplate>
                                                </HorizontalStackLayout>
                                            </HorizontalStackLayout>
                                        </ScrollView>
                                    </VerticalStackLayout>

                                    <!--  Zona de vista previa (hover para mostrar preview)  -->
                                    <Border
                                        Grid.Column="1"
                                        Padding="6"
                                        BackgroundColor="Transparent"
                                        StrokeShape="RoundRectangle 4"
                                        StrokeThickness="0"
                                        VerticalOptions="Center">
                                        <Border.Behaviors>
                                            <behaviors:HoverVideoPreviewBehavior />
                                        </Border.Behaviors>
                                        <controls:SymbolIcon
                                            HeightRequest="20"
                                            SymbolName="eye"
                                            TintColor="#FF888888"
                                            WidthRequest="20" />
                                    </Border>
                                </Grid>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>

                <CollectionView.EmptyView>
                    <VerticalStackLayout
                        Padding="40"
                        HorizontalOptions="Center"
                        VerticalOptions="Center">
                        <Label
                            FontSize="18"
                            HorizontalOptions="Center"
                            Text="Selecciona una sesión"
                            TextColor="Gray" />
                    </VerticalStackLayout>
                </CollectionView.EmptyView>

                <CollectionView.Footer>
                    <VerticalStackLayout
                        Padding="20"
                        HorizontalOptions="Center"
                        IsVisible="{Binding HasMoreVideos}">
                        <ActivityIndicator
                            HeightRequest="24"
                            IsRunning="{Binding IsLoadingMore}"
                            IsVisible="{Binding IsLoadingMore}"
                            WidthRequest="24"
                            Color="{StaticResource Primary}" />
                        <Label
                            FontSize="12"
                            HorizontalOptions="Center"
                            IsVisible="{Binding HasMoreVideos}"
                            Text="Desplázate para cargar más..."
                            TextColor="Gray" />
                    </VerticalStackLayout>
                </CollectionView.Footer>
            </CollectionView>

            <CollectionView
                x:Name="VideoLessonsGallery"
                Grid.Row="2"
                ItemsSource="{Binding VideoLessons}"
                IsVisible="{Binding IsVideoLessonsSelected}"
                SelectionMode="None"
                Margin="0,10,0,0">
                <CollectionView.ItemsLayout>
                    <GridItemsLayout
                        HorizontalItemSpacing="4"
                        Orientation="Vertical"
                        Span="4"
                        VerticalItemSpacing="10" />
                </CollectionView.ItemsLayout>

                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:VideoLesson">
                        <Border
                            BackgroundColor="#FF2A2A2A"
                            Stroke="Transparent"
                            StrokeShape="RoundRectangle 4"
                            StrokeThickness="0">
                            <Border.Behaviors>
                                <behaviors:HoverBackgroundBehavior />
                            </Border.Behaviors>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer
                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:DashboardViewModel}}, Path=VideoLessonTapCommand}"
                                    CommandParameter="{Binding .}" />
                            </Border.GestureRecognizers>

                            <Grid RowDefinitions="Auto,Auto">
                                <!--  Thumbnail con aspect ratio 16:9  -->
                                <controls:AspectRatioContainer AspectRatio="1.777">
                                    <Grid>
                                        <Image
                                            Aspect="AspectFill"
                                            BackgroundColor="{StaticResource Gray300}"
                                            Source="{Binding LocalThumbnailPath}" />

                                        <!--  Overlay de play  -->
                                        <controls:SymbolIcon
                            HeightRequest="50"
                            SymbolName="play.circle.fill"
                            TintColor="Black" Opacity="0.5"
                            VerticalOptions="Center"
                            WidthRequest="50" />
                                    </Grid>
                                </controls:AspectRatioContainer>

                                <!--  Footer con info y acciones  -->
                                <Grid
                                    Grid.Row="1"
                                    Padding="8"
                                    ColumnDefinitions="*,Auto">
                                    <VerticalStackLayout Grid.Column="0" Spacing="2">
                                        <Label
                                            FontSize="12"
                                            LineBreakMode="TailTruncation"
                                            Text="{Binding DisplayTitle}"
                                            TextColor="White" />
                                        <Label
                                            FontSize="12"
                                            LineBreakMode="TailTruncation"
                                            Text="{Binding SessionDisplayName}"
                                            TextColor="#FFB1B1B1" />
                                        <Label
                                            FontSize="12"
                                            Text="{Binding CreatedAtUtc, StringFormat='{0:dd/MM/yyyy HH:mm}'}"
                                            TextColor="#FFB1B1B1" />
                                    </VerticalStackLayout>
                                    
                                    <!--  Botones de acción  -->
                                    <HorizontalStackLayout Grid.Column="1" Spacing="4" VerticalOptions="Center">
                                        <Border
                                            WidthRequest="28"
                                            HeightRequest="28"
                                            Padding="0"
                                            BackgroundColor="#FF3A3A3A"
                                            StrokeShape="RoundRectangle 14"
                                            StrokeThickness="0">
                                            <Border.GestureRecognizers>
                                                <TapGestureRecognizer
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:DashboardViewModel}}, Path=ShareVideoLessonCommand}"
                                                    CommandParameter="{Binding .}" />
                                            </Border.GestureRecognizers>
                                            <controls:SymbolIcon
                                                WidthRequest="14"
                                                HeightRequest="14"
                                                SymbolName="square.and.arrow.up"
                                                TintColor="White"
                                                HorizontalOptions="Center"
                                                VerticalOptions="Center" />
                                        </Border>
                                        <Border
                                            WidthRequest="28"
                                            HeightRequest="28"
                                            Padding="0"
                                            BackgroundColor="#FF3A3A3A"
                                            StrokeShape="RoundRectangle 14"
                                            StrokeThickness="0">
                                            <Border.GestureRecognizers>
                                                <TapGestureRecognizer
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:DashboardViewModel}}, Path=DeleteVideoLessonCommand}"
                                                    CommandParameter="{Binding .}" />
                                            </Border.GestureRecognizers>
                                            <controls:SymbolIcon
                                                WidthRequest="14"
                                                HeightRequest="14"
                                                SymbolName="trash"
                                                TintColor="#FFFF6B6B"
                                                HorizontalOptions="Center"
                                                VerticalOptions="Center" />
                                        </Border>
                                    </HorizontalStackLayout>
                                </Grid>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>

                <CollectionView.EmptyView>
                    <VerticalStackLayout
                        Padding="40"
                        HorizontalOptions="Center"
                        VerticalOptions="Center">
                        <Label
                            FontSize="18"
                            HorizontalOptions="Center"
                            Text="No hay videolecciones"
                            TextColor="Gray" />
                    </VerticalStackLayout>
                </CollectionView.EmptyView>
            </CollectionView>

            <!--  Vista Diario: Calendario  -->
            <controls:CalendarView
                Grid.Row="2"
                Margin="0,10,0,0"
                IsVisible="{Binding IsDiaryViewSelected}"
                SelectedDate="{Binding SelectedDiaryDate}"
                DateSelectedCommand="{Binding SelectDiaryDateCommand}"
                DiaryEntries="{Binding DiaryEntriesForMonth}"
                Sessions="{Binding SessionsForMonth}"
                WellnessData="{Binding WellnessDataForMonth}"
                AverageWellnessScore="{Binding AverageWellnessScore}"
                HorizontalOptions="Fill"
                VerticalOptions="Fill" />
        </Grid>

        <!--  Columna 4 (quinta): estadísticas de la sesión seleccionada  -->
        <ScrollView
            Grid.Row="1"
            Grid.Column="4"
            Padding="20">
            <ScrollView.IsVisible>
                <Binding Path="IsVideoLessonsSelected" Converter="{toolkit:InvertedBoolConverter}" />
            </ScrollView.IsVisible>
            <VerticalStackLayout Spacing="12">

                <!--  Pestañas: Acciones / Estadísticas / Diario  -->
                <Grid ColumnDefinitions="*,*,*" ColumnSpacing="8">
                    <Grid.IsVisible>
                        <Binding Path="IsDiaryViewSelected" Converter="{toolkit:InvertedBoolConverter}" />
                    </Grid.IsVisible>
                    <Border
                        Padding="10,8"
                        BackgroundColor="#FF2A2A2A"
                        Stroke="Transparent"
                        StrokeShape="RoundRectangle 6">
                        <Border.Triggers>
                            <DataTrigger TargetType="Border" Binding="{Binding IsCrudTechTabSelected}" Value="True">
                                <Setter Property="BackgroundColor" Value="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BackgroundColor}" />
                            </DataTrigger>
                        </Border.Triggers>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding SelectCrudTechTabCommand}" />
                        </Border.GestureRecognizers>
                        <Label Text="Acciones y Análisis" TextColor="White" HorizontalOptions="Center" FontSize="12">
                            <Label.Triggers>
                                <DataTrigger TargetType="Label" Binding="{Binding IsCrudTechTabSelected}" Value="True">
                                    <Setter Property="FontAttributes" Value="Bold" />
                                </DataTrigger>
                                <DataTrigger TargetType="Label" Binding="{Binding IsCrudTechTabSelected}" Value="False">
                                    <Setter Property="FontAttributes" Value="None" />
                                </DataTrigger>
                            </Label.Triggers>
                        </Label>
                    </Border>

                    <Border
                        Grid.Column="1"
                        Padding="10,8"
                        BackgroundColor="#FF2A2A2A"
                        Stroke="Transparent"
                        StrokeShape="RoundRectangle 6">
                        <Border.Triggers>
                            <DataTrigger TargetType="Border" Binding="{Binding IsStatsTabSelected}" Value="True">
                                <Setter Property="BackgroundColor" Value="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BackgroundColor}" />
                            </DataTrigger>
                        </Border.Triggers>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding SelectStatsTabCommand}" />
                        </Border.GestureRecognizers>
                        <Label Text="Filtros y Estadísticas" TextColor="White" HorizontalOptions="Center" FontSize="12">
                            <Label.Triggers>
                                <DataTrigger TargetType="Label" Binding="{Binding IsStatsTabSelected}" Value="True">
                                    <Setter Property="FontAttributes" Value="Bold" />
                                </DataTrigger>
                                <DataTrigger TargetType="Label" Binding="{Binding IsStatsTabSelected}" Value="False">
                                    <Setter Property="FontAttributes" Value="None" />
                                </DataTrigger>
                            </Label.Triggers>
                        </Label>
                    </Border>

                    <Border
                        Grid.Column="2"
                        Padding="10,8"
                        BackgroundColor="#FF2A2A2A"
                        Stroke="Transparent"
                        StrokeShape="RoundRectangle 6"
                        IsVisible="{Binding HasSpecificSessionSelected}">
                        <Border.Triggers>
                            <DataTrigger TargetType="Border" Binding="{Binding IsDiaryTabSelected}" Value="True">
                                <Setter Property="BackgroundColor" Value="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BackgroundColor}" />
                            </DataTrigger>
                        </Border.Triggers>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding SelectDiaryTabCommand}" />
                        </Border.GestureRecognizers>
                        <Label Text="Diario de Sesión" TextColor="White" HorizontalOptions="Center" FontSize="12">
                            <Label.Triggers>
                                <DataTrigger TargetType="Label" Binding="{Binding IsDiaryTabSelected}" Value="True">
                                    <Setter Property="FontAttributes" Value="Bold" />
                                </DataTrigger>
                                <DataTrigger TargetType="Label" Binding="{Binding IsDiaryTabSelected}" Value="False">
                                    <Setter Property="FontAttributes" Value="None" />
                                </DataTrigger>
                            </Label.Triggers>
                        </Label>
                    </Border>

                </Grid>


                <!--  Pestaña: Acciones CRUD + análisis técnico (no por defecto)  -->
                <VerticalStackLayout Spacing="12">
                    <VerticalStackLayout.IsVisible>
                        <MultiBinding Converter="{StaticResource AllTrueConverter}">
                            <Binding Path="IsCrudTechTabSelected" />
                            <Binding Path="IsDiaryViewSelected" Converter="{toolkit:InvertedBoolConverter}" />
                        </MultiBinding>
                    </VerticalStackLayout.IsVisible>
                    <HorizontalStackLayout Spacing="12" VerticalOptions="Center">
                        <controls:SymbolIcon
                            HeightRequest="24"
                            SymbolName="film.stack"
                            TintColor="#FF6DDDFF"
                            VerticalOptions="Center"
                            WidthRequest="24" />
                        <Label
                            FontSize="24"
                            Text="Acciones en lote"
                            TextColor="White" />
                    </HorizontalStackLayout>

                    <!--  Toggles de selección  -->
                    <Label
                        FontSize="14"
                        Text="Selección de vídeos"
                        TextColor="#FFB1B1B1" />

                    <Grid ColumnDefinitions="*,*" ColumnSpacing="8">
                        <!--  Toggle: Selección múltiple  -->
                        <Border
                            Padding="10,8"
                            BackgroundColor="#FF2A2A2A"
                            Stroke="Transparent"
                            StrokeShape="RoundRectangle 6">
                            <Border.Triggers>
                                <DataTrigger TargetType="Border" Binding="{Binding IsMultiSelectMode}" Value="True">
                                    <Setter Property="BackgroundColor" Value="#FF6DDDFF" />
                                </DataTrigger>
                            </Border.Triggers>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ToggleMultiSelectModeCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout HorizontalOptions="Center" Spacing="6">
                                <controls:SymbolIcon
                                    HeightRequest="16"
                                    SymbolName="checkmark.circle"
                                    TintColor="White"
                                    WidthRequest="16"
                                    VerticalOptions="Center" />
                                <Label Text="Seleccionar" TextColor="White" VerticalOptions="Center">
                                    <Label.Triggers>
                                        <DataTrigger TargetType="Label" Binding="{Binding IsMultiSelectMode}" Value="True">
                                            <Setter Property="FontAttributes" Value="Bold" />
                                        </DataTrigger>
                                    </Label.Triggers>
                                </Label>
                            </HorizontalStackLayout>
                        </Border>

                        <!--  Toggle: Seleccionar todos  -->
                        <Border
                            Grid.Column="1"
                            Padding="10,8"
                            BackgroundColor="#FF2A2A2A"
                            Stroke="Transparent"
                            StrokeShape="RoundRectangle 6">
                            <Border.Triggers>
                                <DataTrigger TargetType="Border" Binding="{Binding IsSelectAllActive}" Value="True">
                                    <Setter Property="BackgroundColor" Value="#FF6DDDFF" />
                                </DataTrigger>
                            </Border.Triggers>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ToggleSelectAllCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout HorizontalOptions="Center" Spacing="6">
                                <controls:SymbolIcon
                                    HeightRequest="16"
                                    SymbolName="checkmark.circle.fill"
                                    TintColor="White"
                                    WidthRequest="16"
                                    VerticalOptions="Center" />
                                <Label Text="Todos" TextColor="White" VerticalOptions="Center">
                                    <Label.Triggers>
                                        <DataTrigger TargetType="Label" Binding="{Binding IsSelectAllActive}" Value="True">
                                            <Setter Property="FontAttributes" Value="Bold" />
                                        </DataTrigger>
                                    </Label.Triggers>
                                </Label>
                            </HorizontalStackLayout>
                        </Border>
                    </Grid>

                    <!--  Sección: Acciones  -->
                    <Label
                        Margin="0,12,0,0"
                        FontSize="14"
                        Text="Acciones en lote"
                        TextColor="#FFB1B1B1" />

                    <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto" ColumnSpacing="8" RowSpacing="8">
                        <!--  Botón: Reproducir como playlist  -->
                        <Border
                            Grid.Row="0"
                            Grid.Column="0"
                            Padding="10,8"
                            BackgroundColor="#FF2A2A2A"
                            Stroke="Transparent"
                            StrokeShape="RoundRectangle 6">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding PlayAsPlaylistCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout HorizontalOptions="Center" Spacing="6">
                                <controls:SymbolIcon
                                    HeightRequest="16"
                                    SymbolName="play.rectangle.on.rectangle"
                                    TintColor="White"
                                    WidthRequest="16"
                                    VerticalOptions="Center" />
                                <Label Text="Playlist" TextColor="White" VerticalOptions="Center" FontSize="12" />
                            </HorizontalStackLayout>
                        </Border>

                        <!--  Botón: Editar detalles  -->
                        <Border
                            Grid.Row="0"
                            Grid.Column="1"
                            Padding="10,8"
                            BackgroundColor="#FF2A2A2A"
                            Stroke="Transparent"
                            StrokeShape="RoundRectangle 6">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding EditVideoDetailsCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout HorizontalOptions="Center" Spacing="6">
                                <controls:SymbolIcon
                                    HeightRequest="16"
                                    SymbolName="pencil.circle"
                                    TintColor="White"
                                    WidthRequest="16"
                                    VerticalOptions="Center" />
                                <Label Text="Editar" TextColor="White" VerticalOptions="Center" FontSize="12" />
                            </HorizontalStackLayout>
                        </Border>

                        <!--  Botón: Compartir  -->
                        <Border
                            Grid.Row="1"
                            Grid.Column="0"
                            Padding="10,8"
                            BackgroundColor="#FF2A2A2A"
                            Stroke="Transparent"
                            StrokeShape="RoundRectangle 6">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ShareSelectedVideosCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout HorizontalOptions="Center" Spacing="6">
                                <controls:SymbolIcon
                                    HeightRequest="16"
                                    SymbolName="square.and.arrow.up"
                                    TintColor="#FF6DDDFF"
                                    WidthRequest="16"
                                    VerticalOptions="Center" />
                                <Label Text="Compartir" TextColor="#FF6DDDFF" VerticalOptions="Center" FontSize="12" />
                            </HorizontalStackLayout>
                        </Border>

                        <!--  Botón: Eliminar selección  -->
                        <Border
                            Grid.Row="1"
                            Grid.Column="1"
                            Padding="10,8"
                            BackgroundColor="#FF2A2A2A"
                            Stroke="Transparent"
                            StrokeShape="RoundRectangle 6">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding DeleteSelectedVideosCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout HorizontalOptions="Center" Spacing="6">
                                <controls:SymbolIcon
                                    HeightRequest="16"
                                    SymbolName="trash.circle"
                                    TintColor="#FFFF6B6B"
                                    WidthRequest="16"
                                    VerticalOptions="Center" />
                                <Label Text="Eliminar" TextColor="#FFFF6B6B" VerticalOptions="Center" FontSize="12" />
                            </HorizontalStackLayout>
                        </Border>
                    </Grid>

                    <!--  Sección: Análisis técnico  -->
                    <Border
                        Margin="0,12,0,0" HeightRequest="1"
                        BackgroundColor="#FF464646"
                        Stroke="Transparent"
                        />

                    <HorizontalStackLayout Spacing="12" VerticalOptions="Center" Margin="0,20,0,0">
                        <controls:SymbolIcon
                            HeightRequest="24"
                            SymbolName="waveform.path.ecg"
                            TintColor="#FF6DDDFF"
                            VerticalOptions="Center"
                            WidthRequest="24" />
                        <Label
                            FontSize="24"
                            Text="Análisis técnico"
                            TextColor="White" />
                    </HorizontalStackLayout>

                    <!--  Sección: Análisis rápido  -->
                    <Label
                        Margin="0,12,0,0"
                        FontSize="14"
                        Text="Análisis rápido"
                        TextColor="#FFB1B1B1" />

                    <!--  Toggle: Único / Paralelo / Cuádruple  -->
                    <HorizontalStackLayout Spacing="16" HorizontalOptions="Center" Margin="0,0,0,8">
                        <HorizontalStackLayout Spacing="6">
                            <RadioButton
                                GroupName="AnalysisMode"
                                IsChecked="{Binding IsSingleVideoMode}"
                                BackgroundColor="Transparent"
                                VerticalOptions="Center">
                                <RadioButton.ControlTemplate>
                                    <ControlTemplate>
                                        <Grid>
                                            <Ellipse
                                                WidthRequest="18"
                                                HeightRequest="18"
                                                Stroke="#FF888888"
                                                StrokeThickness="2"
                                                Fill="Transparent" />
                                            <Ellipse
                                                WidthRequest="10"
                                                HeightRequest="10"
                                                Fill="#FF6DDDFF"
                                                HorizontalOptions="Center"
                                                VerticalOptions="Center"
                                                IsVisible="{TemplateBinding IsChecked}" />
                                        </Grid>
                                    </ControlTemplate>
                                </RadioButton.ControlTemplate>
                            </RadioButton>
                            <Label Text="Único" TextColor="White" VerticalOptions="Center" />
                        </HorizontalStackLayout>
                        <HorizontalStackLayout Spacing="6">
                            <RadioButton
                                GroupName="AnalysisMode"
                                IsChecked="{Binding IsParallelVideoMode}"
                                BackgroundColor="Transparent"
                                VerticalOptions="Center">
                                <RadioButton.ControlTemplate>
                                    <ControlTemplate>
                                        <Grid>
                                            <Ellipse
                                                WidthRequest="18"
                                                HeightRequest="18"
                                                Stroke="#FF888888"
                                                StrokeThickness="2"
                                                Fill="Transparent" />
                                            <Ellipse
                                                WidthRequest="10"
                                                HeightRequest="10"
                                                Fill="#FF6DDDFF"
                                                HorizontalOptions="Center"
                                                VerticalOptions="Center"
                                                IsVisible="{TemplateBinding IsChecked}" />
                                        </Grid>
                                    </ControlTemplate>
                                </RadioButton.ControlTemplate>
                            </RadioButton>
                            <Label Text="Paralelo" TextColor="White" VerticalOptions="Center" />
                        </HorizontalStackLayout>
                        <HorizontalStackLayout Spacing="6">
                            <RadioButton
                                GroupName="AnalysisMode"
                                IsChecked="{Binding IsQuadVideoMode}"
                                BackgroundColor="Transparent"
                                VerticalOptions="Center">
                                <RadioButton.ControlTemplate>
                                    <ControlTemplate>
                                        <Grid>
                                            <Ellipse
                                                WidthRequest="18"
                                                HeightRequest="18"
                                                Stroke="#FF888888"
                                                StrokeThickness="2"
                                                Fill="Transparent" />
                                            <Ellipse
                                                WidthRequest="10"
                                                HeightRequest="10"
                                                Fill="#FF6DDDFF"
                                                HorizontalOptions="Center"
                                                VerticalOptions="Center"
                                                IsVisible="{TemplateBinding IsChecked}" />
                                        </Grid>
                                    </ControlTemplate>
                                </RadioButton.ControlTemplate>
                            </RadioButton>
                            <Label Text="Cuádruple" TextColor="White" VerticalOptions="Center" />
                        </HorizontalStackLayout>
                    </HorizontalStackLayout>

                    <!--  Layout Único (un solo video)  -->
                    <controls:AspectRatioContainer 
                        AspectRatio="1.777" 
                        IsVisible="{Binding IsSingleVideoMode}"
                        HorizontalOptions="Fill">
                        <Border
                            BackgroundColor="#FF2A2A2A"
                            Stroke="Transparent"
                            StrokeShape="RoundRectangle 6">
                            <Border.GestureRecognizers>
                                <DropGestureRecognizer AllowDrop="True" Drop="OnDropScreen1" />
                            </Border.GestureRecognizers>
                            <Grid>
                                <!--  Placeholder cuando no hay vídeo  -->
                                <Label
                                    HorizontalOptions="Center"
                                    VerticalOptions="Center"
                                    Text="Arrastra un clip aquí"
                                    TextColor="#FF666666"
                                    FontSize="14"
                                    IsVisible="{Binding HasParallelVideo1, Converter={StaticResource InvertedBoolConverter}}" />
                                <!--  Miniatura del vídeo (cuando no está en preview)  -->
                                <Image
                                    Aspect="AspectFill"
                                    Source="{Binding ParallelVideo1.LocalThumbnailPath}"
                                    IsVisible="{Binding HasParallelVideo1}">
                                    <Image.Triggers>
                                        <DataTrigger TargetType="Image" Binding="{Binding IsPreviewMode}" Value="True">
                                            <Setter Property="IsVisible" Value="False" />
                                        </DataTrigger>
                                    </Image.Triggers>
                                </Image>
                                <!--  PrecisionVideoPlayer para scrubbing preciso  -->
                                <appcontrols:PrecisionVideoPlayer
                                    x:Name="PreviewPlayerSingle"
                                    Aspect="AspectFill"
                                    IsMuted="True"
                                    Source="{Binding ParallelVideo1.LocalClipPath}"
                                    IsVisible="False">
                                    <appcontrols:PrecisionVideoPlayer.Triggers>
                                        <MultiTrigger TargetType="appcontrols:PrecisionVideoPlayer">
                                            <MultiTrigger.Conditions>
                                                <BindingCondition Binding="{Binding HasParallelVideo1}" Value="True" />
                                                <BindingCondition Binding="{Binding IsPreviewMode}" Value="True" />
                                                <BindingCondition Binding="{Binding IsSingleVideoMode}" Value="True" />
                                            </MultiTrigger.Conditions>
                                            <Setter Property="IsVisible" Value="True" />
                                        </MultiTrigger>
                                    </appcontrols:PrecisionVideoPlayer.Triggers>
                                </appcontrols:PrecisionVideoPlayer>
                                <!--  Overlay transparente para capturar gestos de scrubbing  -->
                                <BoxView
                                    x:Name="ScrubOverlaySingle"
                                    BackgroundColor="Transparent"
                                    IsVisible="{Binding HasParallelVideo1}">
                                    <BoxView.Behaviors>
                                        <behaviors:VideoScrubBehavior VideoIndex="0" />
                                    </BoxView.Behaviors>
                                </BoxView>
                            </Grid>
                        </Border>
                    </controls:AspectRatioContainer>

                    <!--  Layout Horizontal (paralelo)  -->
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="8">
                        <Grid.Triggers>
                            <MultiTrigger TargetType="Grid">
                                <MultiTrigger.Conditions>
                                    <BindingCondition Binding="{Binding IsParallelVideoMode}" Value="True" />
                                    <BindingCondition Binding="{Binding IsHorizontalOrientation}" Value="True" />
                                </MultiTrigger.Conditions>
                                <Setter Property="IsVisible" Value="True" />
                            </MultiTrigger>
                        </Grid.Triggers>
                        <Grid.Style>
                            <Style TargetType="Grid">
                                <Setter Property="IsVisible" Value="False" />
                            </Style>
                        </Grid.Style>
                        <controls:AspectRatioContainer AspectRatio="1.777">
                            <Border
                                BackgroundColor="#FF2A2A2A"
                                Stroke="Transparent"
                                StrokeShape="RoundRectangle 6">
                                <Border.GestureRecognizers>
                                    <DropGestureRecognizer AllowDrop="True" Drop="OnDropScreen1" />
                                </Border.GestureRecognizers>
                                <Grid>
                                    <!--  Placeholder cuando no hay vídeo  -->
                                    <Label
                                        HorizontalOptions="Center"
                                        VerticalOptions="Center"
                                        Text="1"
                                        TextColor="#FF666666"
                                        FontSize="24"
                                        FontAttributes="Bold"
                                        IsVisible="{Binding HasParallelVideo1, Converter={StaticResource InvertedBoolConverter}}" />
                                    <!--  Miniatura del vídeo (cuando no está en preview)  -->
                                    <Image
                                        Aspect="AspectFill"
                                        Source="{Binding ParallelVideo1.LocalThumbnailPath}"
                                        IsVisible="{Binding HasParallelVideo1}">
                                        <Image.Triggers>
                                            <DataTrigger TargetType="Image" Binding="{Binding IsPreviewMode}" Value="True">
                                                <Setter Property="IsVisible" Value="False" />
                                            </DataTrigger>
                                        </Image.Triggers>
                                    </Image>
                                    <!--  PrecisionVideoPlayer para scrubbing preciso  -->
                                    <appcontrols:PrecisionVideoPlayer
                                        x:Name="PreviewPlayer1H"
                                        Aspect="AspectFill"
                                        IsMuted="True"
                                        Source="{Binding ParallelVideo1.LocalClipPath}"
                                        IsVisible="False">
                                        <appcontrols:PrecisionVideoPlayer.Triggers>
                                            <MultiTrigger TargetType="appcontrols:PrecisionVideoPlayer">
                                                <MultiTrigger.Conditions>
                                                    <BindingCondition Binding="{Binding HasParallelVideo1}" Value="True" />
                                                    <BindingCondition Binding="{Binding IsPreviewMode}" Value="True" />
                                                </MultiTrigger.Conditions>
                                                <Setter Property="IsVisible" Value="True" />
                                            </MultiTrigger>
                                        </appcontrols:PrecisionVideoPlayer.Triggers>
                                    </appcontrols:PrecisionVideoPlayer>
                                    <!--  Overlay para scrubbing  -->
                                    <BoxView
                                        BackgroundColor="Transparent"
                                        IsVisible="{Binding HasParallelVideo1}">
                                        <BoxView.Behaviors>
                                            <behaviors:VideoScrubBehavior VideoIndex="1" />
                                        </BoxView.Behaviors>
                                    </BoxView>
                                </Grid>
                            </Border>
                        </controls:AspectRatioContainer>
                        <controls:AspectRatioContainer Grid.Column="1" AspectRatio="1.777">
                            <Border
                                BackgroundColor="#FF2A2A2A"
                                Stroke="Transparent"
                                StrokeShape="RoundRectangle 6">
                                <Border.GestureRecognizers>
                                    <DropGestureRecognizer AllowDrop="True" Drop="OnDropScreen2" />
                                </Border.GestureRecognizers>
                                <Grid>
                                    <!--  Placeholder cuando no hay vídeo  -->
                                    <Label
                                        HorizontalOptions="Center"
                                        VerticalOptions="Center"
                                        Text="2"
                                        TextColor="#FF666666"
                                        FontSize="24"
                                        FontAttributes="Bold"
                                        IsVisible="{Binding HasParallelVideo2, Converter={StaticResource InvertedBoolConverter}}" />
                                    <!--  Miniatura del vídeo (cuando no está en preview)  -->
                                    <Image
                                        Aspect="AspectFill"
                                        Source="{Binding ParallelVideo2.LocalThumbnailPath}"
                                        IsVisible="{Binding HasParallelVideo2}">
                                        <Image.Triggers>
                                            <DataTrigger TargetType="Image" Binding="{Binding IsPreviewMode}" Value="True">
                                                <Setter Property="IsVisible" Value="False" />
                                            </DataTrigger>
                                        </Image.Triggers>
                                    </Image>
                                    <!--  PrecisionVideoPlayer para scrubbing preciso  -->
                                    <appcontrols:PrecisionVideoPlayer
                                        x:Name="PreviewPlayer2H"
                                        Aspect="AspectFill"
                                        IsMuted="True"
                                        Source="{Binding ParallelVideo2.LocalClipPath}"
                                        IsVisible="False">
                                        <appcontrols:PrecisionVideoPlayer.Triggers>
                                            <MultiTrigger TargetType="appcontrols:PrecisionVideoPlayer">
                                                <MultiTrigger.Conditions>
                                                    <BindingCondition Binding="{Binding HasParallelVideo2}" Value="True" />
                                                    <BindingCondition Binding="{Binding IsPreviewMode}" Value="True" />
                                                </MultiTrigger.Conditions>
                                                <Setter Property="IsVisible" Value="True" />
                                            </MultiTrigger>
                                        </appcontrols:PrecisionVideoPlayer.Triggers>
                                    </appcontrols:PrecisionVideoPlayer>
                                    <!--  Overlay para scrubbing  -->
                                    <BoxView
                                        BackgroundColor="Transparent"
                                        IsVisible="{Binding HasParallelVideo2}">
                                        <BoxView.Behaviors>
                                            <behaviors:VideoScrubBehavior VideoIndex="2" />
                                        </BoxView.Behaviors>
                                    </BoxView>
                                </Grid>
                            </Border>
                        </controls:AspectRatioContainer>
                    </Grid>

                    <!--  Layout Vertical (paralelo)  -->
                    <Grid RowDefinitions="*,*" RowSpacing="8">
                        <Grid.Triggers>
                            <MultiTrigger TargetType="Grid">
                                <MultiTrigger.Conditions>
                                    <BindingCondition Binding="{Binding IsParallelVideoMode}" Value="True" />
                                    <BindingCondition Binding="{Binding IsVerticalOrientation}" Value="True" />
                                </MultiTrigger.Conditions>
                                <Setter Property="IsVisible" Value="True" />
                            </MultiTrigger>
                        </Grid.Triggers>
                        <Grid.Style>
                            <Style TargetType="Grid">
                                <Setter Property="IsVisible" Value="False" />
                            </Style>
                        </Grid.Style>
                        <controls:AspectRatioContainer AspectRatio="1.777">
                            <Border
                                BackgroundColor="#FF2A2A2A"
                                Stroke="Transparent"
                                StrokeShape="RoundRectangle 6">
                                <Border.GestureRecognizers>
                                    <DropGestureRecognizer AllowDrop="True" Drop="OnDropScreen1" />
                                </Border.GestureRecognizers>
                                <Grid>
                                    <!--  Placeholder cuando no hay vídeo  -->
                                    <Label
                                        HorizontalOptions="Center"
                                        VerticalOptions="Center"
                                        Text="1"
                                        TextColor="#FF666666"
                                        FontSize="24"
                                        FontAttributes="Bold"
                                        IsVisible="{Binding HasParallelVideo1, Converter={StaticResource InvertedBoolConverter}}" />
                                    <!--  Miniatura del vídeo (cuando no está en preview)  -->
                                    <Image
                                        Aspect="AspectFill"
                                        Source="{Binding ParallelVideo1.LocalThumbnailPath}"
                                        IsVisible="{Binding HasParallelVideo1}">
                                        <Image.Triggers>
                                            <DataTrigger TargetType="Image" Binding="{Binding IsPreviewMode}" Value="True">
                                                <Setter Property="IsVisible" Value="False" />
                                            </DataTrigger>
                                        </Image.Triggers>
                                    </Image>
                                    <!--  PrecisionVideoPlayer para scrubbing preciso  -->
                                    <appcontrols:PrecisionVideoPlayer
                                        x:Name="PreviewPlayer1V"
                                        Aspect="AspectFill"
                                        IsMuted="True"
                                        Source="{Binding ParallelVideo1.LocalClipPath}"
                                        IsVisible="False">
                                        <appcontrols:PrecisionVideoPlayer.Triggers>
                                            <MultiTrigger TargetType="appcontrols:PrecisionVideoPlayer">
                                                <MultiTrigger.Conditions>
                                                    <BindingCondition Binding="{Binding HasParallelVideo1}" Value="True" />
                                                    <BindingCondition Binding="{Binding IsPreviewMode}" Value="True" />
                                                </MultiTrigger.Conditions>
                                                <Setter Property="IsVisible" Value="True" />
                                            </MultiTrigger>
                                        </appcontrols:PrecisionVideoPlayer.Triggers>
                                    </appcontrols:PrecisionVideoPlayer>
                                    <!--  Overlay para scrubbing  -->
                                    <BoxView
                                        BackgroundColor="Transparent"
                                        IsVisible="{Binding HasParallelVideo1}">
                                        <BoxView.Behaviors>
                                            <behaviors:VideoScrubBehavior VideoIndex="1" />
                                        </BoxView.Behaviors>
                                    </BoxView>
                                </Grid>
                            </Border>
                        </controls:AspectRatioContainer>
                        <controls:AspectRatioContainer Grid.Row="1" AspectRatio="1.777">
                            <Border
                                BackgroundColor="#FF2A2A2A"
                                Stroke="Transparent"
                                StrokeShape="RoundRectangle 6">
                                <Border.GestureRecognizers>
                                    <DropGestureRecognizer AllowDrop="True" Drop="OnDropScreen2" />
                                </Border.GestureRecognizers>
                                <Grid>
                                    <!--  Placeholder cuando no hay vídeo  -->
                                    <Label
                                        HorizontalOptions="Center"
                                        VerticalOptions="Center"
                                        Text="2"
                                        TextColor="#FF666666"
                                        FontSize="24"
                                        FontAttributes="Bold"
                                        IsVisible="{Binding HasParallelVideo2, Converter={StaticResource InvertedBoolConverter}}" />
                                    <!--  Miniatura del vídeo (cuando no está en preview)  -->
                                    <Image
                                        Aspect="AspectFill"
                                        Source="{Binding ParallelVideo2.LocalThumbnailPath}"
                                        IsVisible="{Binding HasParallelVideo2}">
                                        <Image.Triggers>
                                            <DataTrigger TargetType="Image" Binding="{Binding IsPreviewMode}" Value="True">
                                                <Setter Property="IsVisible" Value="False" />
                                            </DataTrigger>
                                        </Image.Triggers>
                                    </Image>
                                    <!--  PrecisionVideoPlayer para scrubbing preciso  -->
                                    <appcontrols:PrecisionVideoPlayer
                                        x:Name="PreviewPlayer2V"
                                        Aspect="AspectFill"
                                        IsMuted="True"
                                        Source="{Binding ParallelVideo2.LocalClipPath}"
                                        IsVisible="False">
                                        <appcontrols:PrecisionVideoPlayer.Triggers>
                                            <MultiTrigger TargetType="appcontrols:PrecisionVideoPlayer">
                                                <MultiTrigger.Conditions>
                                                    <BindingCondition Binding="{Binding HasParallelVideo2}" Value="True" />
                                                    <BindingCondition Binding="{Binding IsPreviewMode}" Value="True" />
                                                </MultiTrigger.Conditions>
                                                <Setter Property="IsVisible" Value="True" />
                                            </MultiTrigger>
                                        </appcontrols:PrecisionVideoPlayer.Triggers>
                                    </appcontrols:PrecisionVideoPlayer>
                                    <!--  Overlay para scrubbing  -->
                                    <BoxView
                                        BackgroundColor="Transparent"
                                        IsVisible="{Binding HasParallelVideo2}">
                                        <BoxView.Behaviors>
                                            <behaviors:VideoScrubBehavior VideoIndex="2" />
                                        </BoxView.Behaviors>
                                    </BoxView>
                                </Grid>
                            </Border>
                        </controls:AspectRatioContainer>
                    </Grid>

                    <!--  Layout Cuádruple (2x2)  -->
                    <Grid 
                        RowDefinitions="*,*" 
                        ColumnDefinitions="*,*" 
                        RowSpacing="8" 
                        ColumnSpacing="8"
                        IsVisible="{Binding IsQuadVideoMode}">
                        <!--  Video 1 (arriba izquierda)  -->
                        <controls:AspectRatioContainer AspectRatio="1.777">
                            <Border
                                BackgroundColor="#FF2A2A2A"
                                Stroke="Transparent"
                                StrokeShape="RoundRectangle 6">
                                <Border.GestureRecognizers>
                                    <DropGestureRecognizer AllowDrop="True" Drop="OnDropScreen1" />
                                </Border.GestureRecognizers>
                                <Grid>
                                    <Label
                                        HorizontalOptions="Center"
                                        VerticalOptions="Center"
                                        Text="1"
                                        TextColor="#FF666666"
                                        FontSize="24"
                                        FontAttributes="Bold"
                                        IsVisible="{Binding HasParallelVideo1, Converter={StaticResource InvertedBoolConverter}}" />
                                    <Image
                                        Aspect="AspectFill"
                                        Source="{Binding ParallelVideo1.LocalThumbnailPath}"
                                        IsVisible="{Binding HasParallelVideo1}">
                                        <Image.Triggers>
                                            <DataTrigger TargetType="Image" Binding="{Binding IsPreviewMode}" Value="True">
                                                <Setter Property="IsVisible" Value="False" />
                                            </DataTrigger>
                                        </Image.Triggers>
                                    </Image>
                                    <appcontrols:PrecisionVideoPlayer
                                        x:Name="PreviewPlayer1Q"
                                        Aspect="AspectFill"
                                        IsMuted="True"
                                        Source="{Binding ParallelVideo1.LocalClipPath}"
                                        IsVisible="False">
                                        <appcontrols:PrecisionVideoPlayer.Triggers>
                                            <MultiTrigger TargetType="appcontrols:PrecisionVideoPlayer">
                                                <MultiTrigger.Conditions>
                                                    <BindingCondition Binding="{Binding HasParallelVideo1}" Value="True" />
                                                    <BindingCondition Binding="{Binding IsPreviewMode}" Value="True" />
                                                    <BindingCondition Binding="{Binding IsQuadVideoMode}" Value="True" />
                                                </MultiTrigger.Conditions>
                                                <Setter Property="IsVisible" Value="True" />
                                            </MultiTrigger>
                                        </appcontrols:PrecisionVideoPlayer.Triggers>
                                    </appcontrols:PrecisionVideoPlayer>
                                    <BoxView
                                        BackgroundColor="Transparent"
                                        IsVisible="{Binding HasParallelVideo1}">
                                        <BoxView.Behaviors>
                                            <behaviors:VideoScrubBehavior VideoIndex="1" />
                                        </BoxView.Behaviors>
                                    </BoxView>
                                </Grid>
                            </Border>
                        </controls:AspectRatioContainer>
                        <!--  Video 2 (arriba derecha)  -->
                        <controls:AspectRatioContainer Grid.Column="1" AspectRatio="1.777">
                            <Border
                                BackgroundColor="#FF2A2A2A"
                                Stroke="Transparent"
                                StrokeShape="RoundRectangle 6">
                                <Border.GestureRecognizers>
                                    <DropGestureRecognizer AllowDrop="True" Drop="OnDropScreen2" />
                                </Border.GestureRecognizers>
                                <Grid>
                                    <Label
                                        HorizontalOptions="Center"
                                        VerticalOptions="Center"
                                        Text="2"
                                        TextColor="#FF666666"
                                        FontSize="24"
                                        FontAttributes="Bold"
                                        IsVisible="{Binding HasParallelVideo2, Converter={StaticResource InvertedBoolConverter}}" />
                                    <Image
                                        Aspect="AspectFill"
                                        Source="{Binding ParallelVideo2.LocalThumbnailPath}"
                                        IsVisible="{Binding HasParallelVideo2}">
                                        <Image.Triggers>
                                            <DataTrigger TargetType="Image" Binding="{Binding IsPreviewMode}" Value="True">
                                                <Setter Property="IsVisible" Value="False" />
                                            </DataTrigger>
                                        </Image.Triggers>
                                    </Image>
                                    <appcontrols:PrecisionVideoPlayer
                                        x:Name="PreviewPlayer2Q"
                                        Aspect="AspectFill"
                                        IsMuted="True"
                                        Source="{Binding ParallelVideo2.LocalClipPath}"
                                        IsVisible="False">
                                        <appcontrols:PrecisionVideoPlayer.Triggers>
                                            <MultiTrigger TargetType="appcontrols:PrecisionVideoPlayer">
                                                <MultiTrigger.Conditions>
                                                    <BindingCondition Binding="{Binding HasParallelVideo2}" Value="True" />
                                                    <BindingCondition Binding="{Binding IsPreviewMode}" Value="True" />
                                                    <BindingCondition Binding="{Binding IsQuadVideoMode}" Value="True" />
                                                </MultiTrigger.Conditions>
                                                <Setter Property="IsVisible" Value="True" />
                                            </MultiTrigger>
                                        </appcontrols:PrecisionVideoPlayer.Triggers>
                                    </appcontrols:PrecisionVideoPlayer>
                                    <BoxView
                                        BackgroundColor="Transparent"
                                        IsVisible="{Binding HasParallelVideo2}">
                                        <BoxView.Behaviors>
                                            <behaviors:VideoScrubBehavior VideoIndex="2" />
                                        </BoxView.Behaviors>
                                    </BoxView>
                                </Grid>
                            </Border>
                        </controls:AspectRatioContainer>
                        <!--  Video 3 (abajo izquierda)  -->
                        <controls:AspectRatioContainer Grid.Row="1" AspectRatio="1.777">
                            <Border
                                BackgroundColor="#FF2A2A2A"
                                Stroke="Transparent"
                                StrokeShape="RoundRectangle 6">
                                <Border.GestureRecognizers>
                                    <DropGestureRecognizer AllowDrop="True" Drop="OnDropScreen3" />
                                </Border.GestureRecognizers>
                                <Grid>
                                    <Label
                                        HorizontalOptions="Center"
                                        VerticalOptions="Center"
                                        Text="3"
                                        TextColor="#FF666666"
                                        FontSize="24"
                                        FontAttributes="Bold"
                                        IsVisible="{Binding HasParallelVideo3, Converter={StaticResource InvertedBoolConverter}}" />
                                    <Image
                                        Aspect="AspectFill"
                                        Source="{Binding ParallelVideo3.LocalThumbnailPath}"
                                        IsVisible="{Binding HasParallelVideo3}">
                                        <Image.Triggers>
                                            <DataTrigger TargetType="Image" Binding="{Binding IsPreviewMode}" Value="True">
                                                <Setter Property="IsVisible" Value="False" />
                                            </DataTrigger>
                                        </Image.Triggers>
                                    </Image>
                                    <appcontrols:PrecisionVideoPlayer
                                        x:Name="PreviewPlayer3Q"
                                        Aspect="AspectFill"
                                        IsMuted="True"
                                        Source="{Binding ParallelVideo3.LocalClipPath}"
                                        IsVisible="False">
                                        <appcontrols:PrecisionVideoPlayer.Triggers>
                                            <MultiTrigger TargetType="appcontrols:PrecisionVideoPlayer">
                                                <MultiTrigger.Conditions>
                                                    <BindingCondition Binding="{Binding HasParallelVideo3}" Value="True" />
                                                    <BindingCondition Binding="{Binding IsPreviewMode}" Value="True" />
                                                    <BindingCondition Binding="{Binding IsQuadVideoMode}" Value="True" />
                                                </MultiTrigger.Conditions>
                                                <Setter Property="IsVisible" Value="True" />
                                            </MultiTrigger>
                                        </appcontrols:PrecisionVideoPlayer.Triggers>
                                    </appcontrols:PrecisionVideoPlayer>
                                    <BoxView
                                        BackgroundColor="Transparent"
                                        IsVisible="{Binding HasParallelVideo3}">
                                        <BoxView.Behaviors>
                                            <behaviors:VideoScrubBehavior VideoIndex="3" />
                                        </BoxView.Behaviors>
                                    </BoxView>
                                </Grid>
                            </Border>
                        </controls:AspectRatioContainer>
                        <!--  Video 4 (abajo derecha)  -->
                        <controls:AspectRatioContainer Grid.Row="1" Grid.Column="1" AspectRatio="1.777">
                            <Border
                                BackgroundColor="#FF2A2A2A"
                                Stroke="Transparent"
                                StrokeShape="RoundRectangle 6">
                                <Border.GestureRecognizers>
                                    <DropGestureRecognizer AllowDrop="True" Drop="OnDropScreen4" />
                                </Border.GestureRecognizers>
                                <Grid>
                                    <Label
                                        HorizontalOptions="Center"
                                        VerticalOptions="Center"
                                        Text="4"
                                        TextColor="#FF666666"
                                        FontSize="24"
                                        FontAttributes="Bold"
                                        IsVisible="{Binding HasParallelVideo4, Converter={StaticResource InvertedBoolConverter}}" />
                                    <Image
                                        Aspect="AspectFill"
                                        Source="{Binding ParallelVideo4.LocalThumbnailPath}"
                                        IsVisible="{Binding HasParallelVideo4}">
                                        <Image.Triggers>
                                            <DataTrigger TargetType="Image" Binding="{Binding IsPreviewMode}" Value="True">
                                                <Setter Property="IsVisible" Value="False" />
                                            </DataTrigger>
                                        </Image.Triggers>
                                    </Image>
                                    <appcontrols:PrecisionVideoPlayer
                                        x:Name="PreviewPlayer4Q"
                                        Aspect="AspectFill"
                                        IsMuted="True"
                                        Source="{Binding ParallelVideo4.LocalClipPath}"
                                        IsVisible="False">
                                        <appcontrols:PrecisionVideoPlayer.Triggers>
                                            <MultiTrigger TargetType="appcontrols:PrecisionVideoPlayer">
                                                <MultiTrigger.Conditions>
                                                    <BindingCondition Binding="{Binding HasParallelVideo4}" Value="True" />
                                                    <BindingCondition Binding="{Binding IsPreviewMode}" Value="True" />
                                                    <BindingCondition Binding="{Binding IsQuadVideoMode}" Value="True" />
                                                </MultiTrigger.Conditions>
                                                <Setter Property="IsVisible" Value="True" />
                                            </MultiTrigger>
                                        </appcontrols:PrecisionVideoPlayer.Triggers>
                                    </appcontrols:PrecisionVideoPlayer>
                                    <BoxView
                                        BackgroundColor="Transparent"
                                        IsVisible="{Binding HasParallelVideo4}">
                                        <BoxView.Behaviors>
                                            <behaviors:VideoScrubBehavior VideoIndex="4" />
                                        </BoxView.Behaviors>
                                    </BoxView>
                                </Grid>
                            </Border>
                        </controls:AspectRatioContainer>
                    </Grid>

                    <!--  Radio buttons orientación (solo en modo paralelo)  -->
                    <HorizontalStackLayout Spacing="16" HorizontalOptions="Center" IsVisible="{Binding IsParallelVideoMode}">
                        <HorizontalStackLayout Spacing="6">
                            <RadioButton
                                GroupName="ParallelOrientation"
                                IsChecked="{Binding IsHorizontalOrientation}"
                                BackgroundColor="Transparent"
                                VerticalOptions="Center">
                                <RadioButton.ControlTemplate>
                                    <ControlTemplate>
                                        <Grid>
                                            <Ellipse
                                                WidthRequest="18"
                                                HeightRequest="18"
                                                Stroke="#FF888888"
                                                StrokeThickness="2"
                                                Fill="Transparent" />
                                            <Ellipse
                                                WidthRequest="10"
                                                HeightRequest="10"
                                                Fill="#FF6DDDFF"
                                                HorizontalOptions="Center"
                                                VerticalOptions="Center"
                                                IsVisible="{TemplateBinding IsChecked}" />
                                        </Grid>
                                    </ControlTemplate>
                                </RadioButton.ControlTemplate>
                            </RadioButton>
                            <Label Text="Horizontal" TextColor="White" VerticalOptions="Center" />
                        </HorizontalStackLayout>
                        <HorizontalStackLayout Spacing="6">
                            <RadioButton
                                GroupName="ParallelOrientation"
                                IsChecked="{Binding IsVerticalOrientation}"
                                BackgroundColor="Transparent"
                                VerticalOptions="Center">
                                <RadioButton.ControlTemplate>
                                    <ControlTemplate>
                                        <Grid>
                                            <Ellipse
                                                WidthRequest="18"
                                                HeightRequest="18"
                                                Stroke="#FF888888"
                                                StrokeThickness="2"
                                                Fill="Transparent" />
                                            <Ellipse
                                                WidthRequest="10"
                                                HeightRequest="10"
                                                Fill="#FF6DDDFF"
                                                HorizontalOptions="Center"
                                                VerticalOptions="Center"
                                                IsVisible="{TemplateBinding IsChecked}" />
                                        </Grid>
                                    </ControlTemplate>
                                </RadioButton.ControlTemplate>
                            </RadioButton>
                            <Label Text="Vertical" TextColor="White" VerticalOptions="Center" />
                        </HorizontalStackLayout>
                    </HorizontalStackLayout>

                    <!--  Botones Reproducir y Limpiar  -->
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="8">
                        <Border
                            Padding="10,8"
                            BackgroundColor="#FF2A2A2A"
                            Stroke="Transparent"
                            StrokeShape="RoundRectangle 6">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding PlayParallelAnalysisCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout HorizontalOptions="Center" Spacing="6">
                                <controls:SymbolIcon
                                    HeightRequest="16"
                                    SymbolName="play.fill"
                                    TintColor="White"
                                    WidthRequest="16"
                                    VerticalOptions="Center" />
                                <Label Text="Reproducir" TextColor="White" VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>

                        <Border
                            Grid.Column="1"
                            Padding="10,8"
                            BackgroundColor="#FF2A2A2A"
                            Stroke="Transparent"
                            StrokeShape="RoundRectangle 6">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ClearParallelAnalysisCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout HorizontalOptions="Center" Spacing="6">
                                <controls:SymbolIcon
                                    HeightRequest="16"
                                    SymbolName="xmark.circle"
                                    TintColor="White"
                                    WidthRequest="16"
                                    VerticalOptions="Center" />
                                <Label Text="Limpiar" TextColor="White" VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>
                    </Grid>

                </VerticalStackLayout>


                <!--  Panel de filtros (ahora dentro de Estadísticas)  -->
                <VerticalStackLayout Spacing="12">
                    <VerticalStackLayout.IsVisible>
                        <MultiBinding Converter="{StaticResource AllTrueConverter}">
                            <Binding Path="IsStatsTabSelected" />
                            <Binding Path="IsDiaryViewSelected" Converter="{toolkit:InvertedBoolConverter}" />
                        </MultiBinding>
                    </VerticalStackLayout.IsVisible>
                    <!--  Filtros para Galería General  -->
                    <Border
                        Margin="0,8,0,8"
                        Padding="12"
                        BackgroundColor="Transparent"
                        IsVisible="{Binding IsAllGallerySelected}"
                        Stroke="Transparent"
                        StrokeShape="RoundRectangle 8">
                        <Grid>
                            <!--  Capa principal con los headers de filtros  -->
                            <VerticalStackLayout Spacing="10" ZIndex="1">
                                <HorizontalStackLayout Spacing="8" VerticalOptions="Center">

                                    <controls:SymbolIcon
                                        HeightRequest="24"
                                        SymbolName="line.3.horizontal.circle"
                                        TintColor="#FF6DDDFF"
                                        VerticalOptions="Center"
                                        WidthRequest="24" />
                                    <Label
                                        FontSize="24"
                                        Text="Filtros"
                                        TextColor="White" VerticalOptions="Center" />
                                    <Button
                                        Padding="8,4"
                                        BackgroundColor="Transparent"
                                        Command="{Binding ClearFiltersCommand}"
                                        FontSize="14"
                                        Text="Limpiar"
                                        TextColor="#FF6DDDFF"
                                        VerticalOptions="Center" />
                                </HorizontalStackLayout>

                                <!--  Header Lugar  -->
                                <Border
                                    x:Name="PlacesHeader"
                                    Padding="10,8"
                                    BackgroundColor="#FF2A2A2A"
                                    Stroke="Transparent"
                                    StrokeShape="RoundRectangle 4">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding TogglePlacesExpandedCommand}" />
                                    </Border.GestureRecognizers>
                                    <Grid ColumnDefinitions="*,Auto">
                                        <VerticalStackLayout Grid.Column="0">
                                            <Label
                                                FontSize="16"
                                                Text="Lugar"
                                                TextColor="#FFB1B1B1" />
                                            <Label
                                                FontSize="16"
                                                Text="{Binding SelectedPlacesSummary}"
                                                TextColor="White" />
                                        </VerticalStackLayout>
                                        <Label
                                            Grid.Column="1"
                                            FontSize="16"
                                            Text="{Binding IsPlacesExpanded, Converter={StaticResource BoolToExpandIconConverter}}"
                                            TextColor="Gray"
                                            VerticalOptions="Center" />
                                    </Grid>
                                </Border>

                                <!--  Header Deportista  -->
                                <Border
                                    x:Name="AthletesHeader"
                                    Padding="10,8"
                                    BackgroundColor="#FF2A2A2A"
                                    Stroke="Transparent"
                                    StrokeShape="RoundRectangle 4">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding ToggleAthletesExpandedCommand}" />
                                    </Border.GestureRecognizers>
                                    <Grid ColumnDefinitions="*,Auto">
                                        <VerticalStackLayout Grid.Column="0">
                                            <Label
                                                FontSize="16"
                                                Text="Deportista"
                                                TextColor="#FFB1B1B1" />
                                            <Label
                                                FontSize="16"
                                                Text="{Binding SelectedAthletesSummary}"
                                                TextColor="White" />
                                        </VerticalStackLayout>
                                        <Label
                                            Grid.Column="1"
                                            FontSize="16"
                                            Text="{Binding IsAthletesExpanded, Converter={StaticResource BoolToExpandIconConverter}}"
                                            TextColor="Gray"
                                            VerticalOptions="Center" />
                                    </Grid>
                                </Border>

                                <!--  Header Sección  -->
                                <Border
                                    x:Name="SectionsHeader"
                                    Padding="10,8"
                                    BackgroundColor="#FF2A2A2A"
                                    Stroke="Transparent"
                                    StrokeShape="RoundRectangle 4">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding ToggleSectionsExpandedCommand}" />
                                    </Border.GestureRecognizers>
                                    <Grid ColumnDefinitions="*,Auto">
                                        <VerticalStackLayout Grid.Column="0">
                                            <Label
                                                FontSize="16"
                                                Text="Sección"
                                                TextColor="#FFB1B1B1" />
                                            <Label
                                                FontSize="16"
                                                Text="{Binding SelectedSectionsSummary}"
                                                TextColor="White" />
                                        </VerticalStackLayout>
                                        <Label
                                            Grid.Column="1"
                                            FontSize="16"
                                            Text="{Binding IsSectionsExpanded, Converter={StaticResource BoolToExpandIconConverter}}"
                                            TextColor="Gray"
                                            VerticalOptions="Center" />
                                    </Grid>
                                </Border>

                                <!--  Header Tag  -->
                                <Border
                                    x:Name="TagsHeader"
                                    Padding="10,8"
                                    BackgroundColor="#FF2A2A2A"
                                    Stroke="Transparent"
                                    StrokeShape="RoundRectangle 4">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding ToggleTagsExpandedCommand}" />
                                    </Border.GestureRecognizers>
                                    <Grid ColumnDefinitions="*,Auto">
                                        <VerticalStackLayout Grid.Column="0">
                                            <Label
                                                FontFamily="SF Pro Text"
                                                FontSize="16"
                                                Text="Tag"
                                                TextColor="#FFB1B1B1" />
                                            <Label
                                                FontFamily="SF Pro Text"
                                                FontSize="16"
                                                Text="{Binding SelectedTagsSummary}"
                                                TextColor="White" />
                                        </VerticalStackLayout>
                                        <Label
                                            Grid.Column="1"
                                            FontSize="16"
                                            Text="{Binding IsTagsExpanded, Converter={StaticResource BoolToExpandIconConverter}}"
                                            TextColor="Gray"
                                            VerticalOptions="Center" />
                                    </Grid>
                                </Border>
                                <Grid ColumnDefinitions="*,*" ColumnSpacing="12">
                                    <!--  Fecha desde  -->
                                    <VerticalStackLayout Grid.Column="0" Spacing="4">
                                        <Label
                                            FontSize="16"
                                            Text="Fecha desde"
                                            TextColor="#FFB1B1B1" />
                                        <Border
                                            BackgroundColor="#FF2A2A2A"
                                            StrokeShape="RoundRectangle 4"
                                            Stroke="Transparent"
                                            Padding="12,12,0,-6"
                                            HorizontalOptions="Fill">
                                            <DatePicker
                                                Date="{Binding SelectedFilterDateFrom}"
                                                TextColor="White"
                                                BackgroundColor="Transparent"
                                                HorizontalOptions="Fill"
                                                VerticalOptions="Fill" />
                                        </Border>
                                    </VerticalStackLayout>

                                    <!--  Fecha hasta  -->
                                    <VerticalStackLayout Grid.Column="1" Spacing="4">
                                        <Label
                                            FontSize="16"
                                            Text="Fecha hasta"
                                            TextColor="#FFB1B1B1" />
                                        <Border
                                            BackgroundColor="#FF2A2A2A"
                                            StrokeShape="RoundRectangle 4"
                                            Stroke="Transparent"
                                            Padding="12,12,0,-6"
                                            HorizontalOptions="Fill">
                                            <DatePicker
                                                Date="{Binding SelectedFilterDateTo}"
                                                TextColor="White"
                                                BackgroundColor="Transparent"
                                                HorizontalOptions="Fill"
                                                VerticalOptions="Center" />
                                        </Border>
                                    </VerticalStackLayout>
                                </Grid>
                            </VerticalStackLayout>

                            <!--  Capa de overlay para dropdowns flotantes  -->
                            <!--  Dropdown Lugar  -->
                            <Border
                                Margin="0,114,0,0"
                                Padding="8"
                                BackgroundColor="#FF2A2A2A"
                                HorizontalOptions="Fill"
                                IsVisible="{Binding IsPlacesExpanded}"
                                Stroke="Transparent"
                                StrokeShape="RoundRectangle 4"
                                StrokeThickness="1"
                                VerticalOptions="Start"
                                ZIndex="100" HeightRequest="280">
                                <ScrollView HeightRequest="280">
                                    <VerticalStackLayout BindableLayout.ItemsSource="{Binding FilterPlaces}" Spacing="2">
                                        <BindableLayout.ItemTemplate>
                                            <DataTemplate x:DataType="models:PlaceFilterItem">
                                                <HorizontalStackLayout Spacing="4">
                                                    <CheckBox IsChecked="{Binding IsSelected}" Color="#FF6DDDFF" />
                                                    <Label
                                                        FontFamily="SF Pro Text"
                                                        FontSize="16"
                                                        Text="{Binding DisplayName}"
                                                        TextColor="White"
                                                        VerticalOptions="Center" />
                                                </HorizontalStackLayout>
                                            </DataTemplate>
                                        </BindableLayout.ItemTemplate>
                                    </VerticalStackLayout>
                                </ScrollView>
                            </Border>

                            <!--  Dropdown Deportista  -->
                            <Border
                                Margin="0,180,0,0"
                                Padding="8"
                                BackgroundColor="#FF2A2A2A"
                                HorizontalOptions="Fill"
                                IsVisible="{Binding IsAthletesExpanded}"
                                Stroke="Transparent"
                                StrokeShape="RoundRectangle 4"
                                StrokeThickness="1"
                                VerticalOptions="Start"
                                ZIndex="100" HeightRequest="280">
                                <ScrollView HeightRequest="280">
                                    <VerticalStackLayout BindableLayout.ItemsSource="{Binding FilterAthletes}" Spacing="2">
                                        <BindableLayout.ItemTemplate>
                                            <DataTemplate x:DataType="models:AthleteFilterItem">
                                                <HorizontalStackLayout Spacing="4">
                                                    <CheckBox IsChecked="{Binding IsSelected}" Color="#FF6DDDFF" />
                                                    <Label
                                                        FontFamily="SF Pro Text"
                                                        FontSize="16"
                                                        Text="{Binding DisplayName}"
                                                        TextColor="White"
                                                        VerticalOptions="Center" />
                                                </HorizontalStackLayout>
                                            </DataTemplate>
                                        </BindableLayout.ItemTemplate>
                                    </VerticalStackLayout>
                                </ScrollView>
                            </Border>

                            <!--  Dropdown Sección  -->
                            <Border
                                Margin="0,244,0,0"
                                Padding="8"
                                BackgroundColor="#FF2A2A2A"
                                HorizontalOptions="Fill"
                                IsVisible="{Binding IsSectionsExpanded}"
                                Stroke="Transparent"
                                StrokeShape="RoundRectangle 4"
                                StrokeThickness="1"
                                VerticalOptions="Start"
                                ZIndex="100" HeightRequest="280">
                                <ScrollView HeightRequest="280">
                                    <VerticalStackLayout BindableLayout.ItemsSource="{Binding FilterSections}" Spacing="2">
                                        <BindableLayout.ItemTemplate>
                                            <DataTemplate x:DataType="models:SectionFilterItem">
                                                <HorizontalStackLayout Spacing="4">
                                                    <CheckBox IsChecked="{Binding IsSelected}" Color="#FF6DDDFF" />
                                                    <Label
                                                        FontFamily="SF Pro Text"
                                                        FontSize="16"
                                                        Text="{Binding DisplayName}"
                                                        TextColor="White"
                                                        VerticalOptions="Center" />
                                                </HorizontalStackLayout>
                                            </DataTemplate>
                                        </BindableLayout.ItemTemplate>
                                    </VerticalStackLayout>
                                </ScrollView>
                            </Border>

                            <!--  Dropdown Tag  -->
                            <Border
                                Margin="0,310,0,0"
                                Padding="8"
                                BackgroundColor="#FF2A2A2A"
                                HorizontalOptions="Fill"
                                IsVisible="{Binding IsTagsExpanded}"
                                Stroke="Transparent"
                                StrokeShape="RoundRectangle 4"
                                StrokeThickness="1"
                                VerticalOptions="Start"
                                ZIndex="100" HeightRequest="280">
                                <ScrollView HeightRequest="280">
                                    <VerticalStackLayout BindableLayout.ItemsSource="{Binding FilterTagItems}" Spacing="2">
                                        <BindableLayout.ItemTemplate>
                                            <DataTemplate x:DataType="models:TagFilterItem">
                                                <HorizontalStackLayout Spacing="4">
                                                    <CheckBox IsChecked="{Binding IsSelected}" Color="#FF6DDDFF" />
                                                    <Label
                                                        FontFamily="SF Pro Text"
                                                        FontSize="16"
                                                        Text="{Binding DisplayName}"
                                                        TextColor="White"
                                                        VerticalOptions="Center" />
                                                </HorizontalStackLayout>
                                            </DataTemplate>
                                        </BindableLayout.ItemTemplate>
                                    </VerticalStackLayout>
                                </ScrollView>
                            </Border>
                        </Grid>
                    </Border>
                </VerticalStackLayout>

                <!--  Vista actual de estadísticas  -->
                <VerticalStackLayout Spacing="12">
                    <VerticalStackLayout.IsVisible>
                        <MultiBinding Converter="{StaticResource AllTrueConverter}">
                            <Binding Path="IsStatsTabSelected" />
                            <Binding Path="IsDiaryViewSelected" Converter="{toolkit:InvertedBoolConverter}" />
                        </MultiBinding>
                    </VerticalStackLayout.IsVisible>
                <HorizontalStackLayout Spacing="12" VerticalOptions="Center">
                    <controls:SymbolIcon
                        HeightRequest="24"
                        SymbolName="chart.pie"
                        TintColor="#FF6DDDFF"
                        VerticalOptions="Center"
                        WidthRequest="24" />
                    <Label
                        FontSize="24"
                        Text="Datos y Estadísticas"
                        TextColor="White" />
                </HorizontalStackLayout>

                <!--  ===== ESTADÍSTICAS =====  -->
                <VerticalStackLayout Spacing="12">

                <Label
                    FontSize="14"
                    LineBreakMode="TailTruncation"
                    Text="{Binding SelectedSessionTitle}"
                    TextColor="#FFB1B1B1" />

                <!--  RESUMEN PRINCIPAL  -->
                <Grid ColumnDefinitions="*,*,*" ColumnSpacing="8">
                    <!--  Número de vídeos  -->
                    <Border
                        Padding="12"
                        BackgroundColor="#FF2A2A2A"
                        StrokeShape="RoundRectangle 10"
                        StrokeThickness="0">
                        <VerticalStackLayout HorizontalOptions="Center" Spacing="4">
                            <Label
                                FontAttributes="Bold"
                                FontSize="22"
                                HorizontalOptions="Center"
                                Text="{Binding TotalFilteredVideoCount}"
                                TextColor="#FF6DDDFF" />
                            <Label
                                FontSize="11"
                                HorizontalOptions="Center"
                                Text="Vídeos"
                                TextColor="#FFB1B1B1" />
                        </VerticalStackLayout>
                    </Border>
                    <!--  Tiempo Total  -->
                    <Border
                        Grid.Column="1"
                        Padding="12"
                        BackgroundColor="#FF2A2A2A"
                        StrokeShape="RoundRectangle 10"
                        StrokeThickness="0">
                        <VerticalStackLayout HorizontalOptions="Center" Spacing="4">
                            <Label
                                FontAttributes="Bold"
                                FontSize="22"
                                HorizontalOptions="Center"
                                Text="{Binding SelectedSessionTotalDurationFormatted}"
                                TextColor="White" />
                            <Label
                                FontSize="11"
                                HorizontalOptions="Center"
                                Text="Tiempo"
                                TextColor="#FFB1B1B1" />
                        </VerticalStackLayout>
                    </Border>
                    <!--  Sesiones  -->
                    <Border
                        Grid.Column="2"
                        Padding="12"
                        BackgroundColor="#FF2A2A2A"
                        StrokeShape="RoundRectangle 10"
                        StrokeThickness="0">
                        <VerticalStackLayout HorizontalOptions="Center" Spacing="4">
                            <Label
                                FontAttributes="Bold"
                                FontSize="22"
                                HorizontalOptions="Center"
                                Text="{Binding Stats.TotalSessions}"
                                TextColor="White" />
                            <Label
                                FontSize="11"
                                HorizontalOptions="Center"
                                Text="Sesiones"
                                TextColor="#FFB1B1B1" />
                        </VerticalStackLayout>
                    </Border>
                </Grid>

                <!--  VÍDEOS ETIQUETADOS  -->
                <Border
                    Padding="12"
                    BackgroundColor="#FF1F1F1F"
                    StrokeShape="RoundRectangle 10"
                    StrokeThickness="0">
                    <Grid ColumnDefinitions="*,Auto">
                        <VerticalStackLayout Spacing="4">
                            <Label
                                FontSize="14"
                                Text="Vídeos etiquetados/nombrados"
                                TextColor="White" />
                            <Label
                                FontSize="12"
                                Text="{Binding LabeledVideosText, StringFormat='{0} vídeos con nombre asignado'}"
                                TextColor="#FFB1B1B1" />
                        </VerticalStackLayout>
                        <Label
                            Grid.Column="1"
                            FontAttributes="Bold"
                            FontSize="18"
                            Text="{Binding LabeledVideosPercentage, StringFormat='{0:F0}%'}"
                            TextColor="#FF6DDDFF"
                            VerticalOptions="Center" />
                    </Grid>
                </Border>

                <!--  TAGS DE EVENTOS  -->
                <Label
                    FontSize="14"
                    Text="Tags de eventos"
                    TextColor="#FFB1B1B1" />
                <Grid ColumnDefinitions="*,*" ColumnSpacing="8">
                    <Border
                        Padding="10"
                        BackgroundColor="#FF2A2A2A"
                        StrokeShape="RoundRectangle 8"
                        StrokeThickness="0">
                        <HorizontalStackLayout Spacing="8">
                            <Label
                                FontAttributes="Bold"
                                FontSize="18"
                                Text="{Binding TotalEventTagsCount}"
                                TextColor="White"
                                VerticalOptions="Center" />
                            <Label
                                FontSize="12"
                                Text="eventos totales"
                                TextColor="#FF808080"
                                VerticalOptions="Center" />
                        </HorizontalStackLayout>
                    </Border>
                    <Border
                        Grid.Column="1"
                        Padding="10"
                        BackgroundColor="#FF2A2A2A"
                        StrokeShape="RoundRectangle 8"
                        StrokeThickness="0">
                        <HorizontalStackLayout Spacing="8">
                            <Label
                                FontAttributes="Bold"
                                FontSize="18"
                                Text="{Binding TotalUniqueEventTagsCount}"
                                TextColor="White"
                                VerticalOptions="Center" />
                            <Label
                                FontSize="12"
                                Text="tipos únicos"
                                TextColor="#FF808080"
                                VerticalOptions="Center" />
                        </HorizontalStackLayout>
                    </Border>
                </Grid>

                <!--  TOP EVENTOS MÁS USADOS  -->
                <Label
                    FontSize="13"
                    Margin="0,4,0,0"
                    Text="Eventos más utilizados"
                    TextColor="#FF808080" />
                <controls:SimplePieChart
                    MinimumHeightRequest="120"
                    HorizontalOptions="Fill"
                    VerticalOptions="FillAndExpand"
                    Labels="{Binding TopEventTagNames}"
                    ShowLegend="True"
                    TextColor="White"
                    Values="{Binding TopEventTagValues}" />

                <!--  ETIQUETAS  -->
                <Label
                    FontSize="14"
                    Text="Etiquetas"
                    TextColor="#FFB1B1B1" />
                <Grid ColumnDefinitions="*,*,*" ColumnSpacing="8">
                    <Border
                        Padding="10"
                        BackgroundColor="#FF2A2A2A"
                        StrokeShape="RoundRectangle 8"
                        StrokeThickness="0">
                        <VerticalStackLayout HorizontalOptions="Center" Spacing="2">
                            <Label
                                FontAttributes="Bold"
                                FontSize="16"
                                HorizontalOptions="Center"
                                Text="{Binding TotalLabelTagsCount}"
                                TextColor="White" />
                            <Label
                                FontSize="10"
                                HorizontalOptions="Center"
                                Text="asignadas"
                                TextColor="#FF808080" />
                        </VerticalStackLayout>
                    </Border>
                    <Border
                        Grid.Column="1"
                        Padding="10"
                        BackgroundColor="#FF2A2A2A"
                        StrokeShape="RoundRectangle 8"
                        StrokeThickness="0">
                        <VerticalStackLayout HorizontalOptions="Center" Spacing="2">
                            <Label
                                FontAttributes="Bold"
                                FontSize="16"
                                HorizontalOptions="Center"
                                Text="{Binding TotalUniqueLabelTagsCount}"
                                TextColor="White" />
                            <Label
                                FontSize="10"
                                HorizontalOptions="Center"
                                Text="únicas"
                                TextColor="#FF808080" />
                        </VerticalStackLayout>
                    </Border>
                    <Border
                        Grid.Column="2"
                        Padding="10"
                        BackgroundColor="#FF2A2A2A"
                        StrokeShape="RoundRectangle 8"
                        StrokeThickness="0">
                        <VerticalStackLayout HorizontalOptions="Center" Spacing="2">
                            <Label
                                FontAttributes="Bold"
                                FontSize="16"
                                HorizontalOptions="Center"
                                Text="{Binding AvgTagsPerSession, StringFormat='{0:F1}'}"
                                TextColor="White" />
                            <Label
                                FontSize="10"
                                HorizontalOptions="Center"
                                Text="por sesión"
                                TextColor="#FF808080" />
                        </VerticalStackLayout>
                    </Border>
                </Grid>

                <!--  TOP ETIQUETAS MÁS USADAS (GRÁFICO CIRCULAR)  -->
                <Label
                    FontSize="13"
                    Margin="0,4,0,0"
                    Text="Etiquetas más utilizadas"
                    TextColor="#FF808080" />
                <controls:SimplePieChart
                    MinimumHeightRequest="120"
                    HorizontalOptions="Fill"
                    VerticalOptions="FillAndExpand"
                    Labels="{Binding TopLabelTagNames}"
                    ShowLegend="True"
                    TextColor="White"
                    Values="{Binding TopLabelTagValues}" />

                <!--  ===== TABLA DE TIEMPOS POR SECCIÓN =====  -->
                <VerticalStackLayout IsVisible="{Binding ShowSectionTimesTable}" Spacing="8" Margin="0,16,0,0">
                    <!--  Cabecera con título y toggle  -->
                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                        <Label
                            FontAttributes="Bold"
                            FontSize="16"
                            Text="⏱ Tiempos por Sección"
                            TextColor="White"
                            VerticalOptions="Center" />
                        
                        <!--  Toggle entre Tiempos y Diferencias  -->
                        <Grid Grid.Column="1" ColumnDefinitions="Auto,Auto" ColumnSpacing="4" IsVisible="{Binding HasReferenceAthlete}">
                            <!--  Botón Tiempos  -->
                            <Border
                                Padding="16,6"
                                BackgroundColor="{Binding ShowSectionTimesAbsolute, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF2A2A2A,#FF1A1A1A'}"
                                StrokeShape="RoundRectangle 4"
                                StrokeThickness="0"
                                MinimumWidthRequest="80">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ToggleSectionTimesViewCommand}" />
                                </Border.GestureRecognizers>
                                <Label
                                    FontSize="12"
                                    Text="Tiempos"
                                    HorizontalOptions="Center"
                                    TextColor="White" />
                            </Border>
                            <!--  Botón Diferencias  -->
                            <Border
                                Grid.Column="1"
                                Padding="16,6"
                                BackgroundColor="{Binding ShowSectionTimesDifferences, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF2A2A2A,#FF1A1A1A'}"
                                StrokeShape="RoundRectangle 4"
                                StrokeThickness="0"
                                MinimumWidthRequest="80">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ToggleSectionTimesViewCommand}" />
                                </Border.GestureRecognizers>
                                <Label
                                    FontSize="12"
                                    Text="vs Tú"
                                    HorizontalOptions="Center"
                                    TextColor="White" />
                            </Border>
                        </Grid>
                    </Grid>
                    
                    <!--  Iteramos por cada sección  -->
                    <VerticalStackLayout Spacing="12">
                        <BindableLayout.ItemsSource>
                            <Binding Path="SectionTimes" />
                        </BindableLayout.ItemsSource>
                        <BindableLayout.ItemTemplate>
                            <DataTemplate x:DataType="services:SectionWithAthleteRows">
                                <Border
                                    Padding="8"
                                    BackgroundColor="#FF1A1A1A"
                                    StrokeShape="RoundRectangle 8"
                                    StrokeThickness="0">
                                    <VerticalStackLayout Spacing="6">
                                        <!--  Nombre de la sección  -->
                                        <Label
                                            FontAttributes="Bold"
                                            FontSize="14"
                                            Text="{Binding SectionName}"
                                            TextColor="#FF6DDDFF" />
                                        
                                        <!--  ===== VISTA TIEMPOS ABSOLUTOS =====  -->
                                        <VerticalStackLayout Spacing="4" IsVisible="{Binding Source={RelativeSource AncestorType={x:Type vm:DashboardViewModel}}, Path=ShowSectionTimesAbsolute}">
                                            <!--  Cabecera de tabla (absoluta)  -->
                                            <Grid ColumnDefinitions="2*,*,*,*,*" ColumnSpacing="4" Padding="4,2" BackgroundColor="#FF252525">
                                                <Label Grid.Column="0" FontSize="11" FontAttributes="Bold" Text="ATLETA" TextColor="#FFB1B1B1" />
                                                <Label Grid.Column="1" FontSize="11" FontAttributes="Bold" Text="CAT." TextColor="#FFB1B1B1" />
                                                <Label Grid.Column="2" FontSize="11" FontAttributes="Bold" Text="TIEMPO" TextColor="#FFB1B1B1" HorizontalTextAlignment="End" />
                                                <Label Grid.Column="3" FontSize="11" FontAttributes="Bold" Text="PENAL." TextColor="#FFB1B1B1" HorizontalTextAlignment="End" />
                                                <Label Grid.Column="4" FontSize="11" FontAttributes="Bold" Text="TOTAL" TextColor="#FFB1B1B1" HorizontalTextAlignment="End" />
                                            </Grid>
                                            
                                            <!--  Filas de atletas (tiempos absolutos)  -->
                                            <VerticalStackLayout Spacing="2">
                                                <BindableLayout.ItemsSource>
                                                    <Binding Path="Athletes" />
                                                </BindableLayout.ItemsSource>
                                                <BindableLayout.ItemTemplate>
                                                    <DataTemplate x:DataType="services:AthleteSectionTimeRow">
                                                        <Grid ColumnDefinitions="2*,*,*,*,*" ColumnSpacing="4" Padding="4,3" BackgroundColor="{Binding RowBackgroundColor}">
                                                            <Label Grid.Column="0" FontSize="12" Text="{Binding AthleteName}" TextColor="White" LineBreakMode="TailTruncation" VerticalOptions="Center" />
                                                            <Label Grid.Column="1" FontSize="11" Text="{Binding CategoryName}" TextColor="#FF808080" LineBreakMode="TailTruncation" VerticalOptions="Center" />
                                                            <Label Grid.Column="2" FontSize="12" Text="{Binding DurationFormatted}" TextColor="#FF4CAF50" HorizontalTextAlignment="End" VerticalOptions="Center" />
                                                            <Label Grid.Column="3" FontSize="12" Text="{Binding PenaltyFormatted}" TextColor="#FFFF6B6B" HorizontalTextAlignment="End" VerticalOptions="Center" />
                                                            <Label Grid.Column="4" FontSize="12" FontAttributes="Bold" Text="{Binding TotalFormatted}" TextColor="#FFFFD700" HorizontalTextAlignment="End" VerticalOptions="Center" />
                                                        </Grid>
                                                    </DataTemplate>
                                                </BindableLayout.ItemTemplate>
                                            </VerticalStackLayout>
                                        </VerticalStackLayout>
                                        
                                        <!--  ===== VISTA DIFERENCIAS =====  -->
                                        <VerticalStackLayout Spacing="4" IsVisible="{Binding Source={RelativeSource AncestorType={x:Type vm:DashboardViewModel}}, Path=ShowSectionTimesDifferences}">
                                            <!--  Cabecera de tabla (diferencias)  -->
                                            <Grid ColumnDefinitions="2*,*,*,*" ColumnSpacing="4" Padding="4,2" BackgroundColor="#FF252525">
                                                <Label Grid.Column="0" FontSize="11" FontAttributes="Bold" Text="ATLETA" TextColor="#FFB1B1B1" />
                                                <Label Grid.Column="1" FontSize="11" FontAttributes="Bold" Text="CAT." TextColor="#FFB1B1B1" />
                                                <Label Grid.Column="2" FontSize="11" FontAttributes="Bold" Text="TOTAL" TextColor="#FFB1B1B1" HorizontalTextAlignment="End" />
                                                <Label Grid.Column="3" FontSize="11" FontAttributes="Bold" Text="vs TÚ" TextColor="#FFB1B1B1" HorizontalTextAlignment="End" />
                                            </Grid>
                                            
                                            <!--  Filas de atletas (diferencias)  -->
                                            <VerticalStackLayout Spacing="2">
                                                <BindableLayout.ItemsSource>
                                                    <Binding Path="Athletes" />
                                                </BindableLayout.ItemsSource>
                                                <BindableLayout.ItemTemplate>
                                                    <DataTemplate x:DataType="services:AthleteSectionTimeRow">
                                                        <Grid ColumnDefinitions="2*,*,*,*" ColumnSpacing="4" Padding="4,3" BackgroundColor="{Binding RowBackgroundColor}">
                                                            <Label Grid.Column="0" FontSize="12" Text="{Binding AthleteName}" TextColor="White" LineBreakMode="TailTruncation" VerticalOptions="Center" FontAttributes="{Binding IsReferenceAthlete, Converter={StaticResource BoolToFontAttributesConverter}}" />
                                                            <Label Grid.Column="1" FontSize="11" Text="{Binding CategoryName}" TextColor="#FF808080" LineBreakMode="TailTruncation" VerticalOptions="Center" />
                                                            <Label Grid.Column="2" FontSize="12" Text="{Binding TotalFormatted}" TextColor="#FFFFD700" HorizontalTextAlignment="End" VerticalOptions="Center" />
                                                            <Label Grid.Column="3" FontSize="12" FontAttributes="Bold" Text="{Binding DifferenceFormatted}" TextColor="{Binding DifferenceColor}" HorizontalTextAlignment="End" VerticalOptions="Center" />
                                                        </Grid>
                                                    </DataTemplate>
                                                </BindableLayout.ItemTemplate>
                                            </VerticalStackLayout>
                                        </VerticalStackLayout>
                                        
                                    </VerticalStackLayout>
                                </Border>
                            </DataTemplate>
                        </BindableLayout.ItemTemplate>
                    </VerticalStackLayout>
                </VerticalStackLayout>

                </VerticalStackLayout>

                </VerticalStackLayout>

                <!--  ===== PESTAÑA: DIARIO DE SESIÓN =====  -->
                <VerticalStackLayout Spacing="16">
                    <VerticalStackLayout.IsVisible>
                        <MultiBinding Converter="{StaticResource AllTrueConverter}">
                            <Binding Path="IsDiaryTabSelected" />
                            <Binding Path="IsDiaryViewSelected" Converter="{toolkit:InvertedBoolConverter}" />
                        </MultiBinding>
                    </VerticalStackLayout.IsVisible>
                    
                    <!--  Título  -->
                    <Label
                        FontAttributes="Bold"
                        FontSize="18"
                        Text="Diario de Sesión"
                        TextColor="White" />
                    
                    <!--  Cuestionario de valoraciones  -->
                    <Border
                        Padding="16"
                        BackgroundColor="Transparent"
                        StrokeShape="RoundRectangle 12"
                        StrokeThickness="0">
                        <VerticalStackLayout Spacing="16">
                            <Label
                                FontAttributes="Bold"
                                FontSize="14"
                                Text="¿Cómo te has sentido hoy?"
                                TextColor="White" />
                            
                            <!--  Valoración Física  -->
                            <Grid ColumnDefinitions="100,*,40" ColumnSpacing="12">
                                <Label
                                    FontSize="14"
                                    Text="Físico"
                                    TextColor="#FFB1B1B1"
                                    VerticalOptions="Center" />
                                <Slider
                                    Grid.Column="1"
                                    Maximum="5"
                                    Minimum="1"
                                    MinimumTrackColor="#FF8DD3C7"
                                    MaximumTrackColor="#FF404040"
                                    ThumbColor="#FF8DD3C7"
                                    Value="{Binding DiaryValoracionFisica}" />
                                <Label
                                    Grid.Column="2"
                                    FontAttributes="Bold"
                                    FontSize="16"
                                    HorizontalOptions="Center"
                                    Text="{Binding DiaryValoracionFisica}"
                                    TextColor="#FF8DD3C7"
                                    VerticalOptions="Center" />
                            </Grid>
                            
                            <!--  Valoración Mental  -->
                            <Grid ColumnDefinitions="100,*,40" ColumnSpacing="12">
                                <Label
                                    FontSize="14"
                                    Text="Mental"
                                    TextColor="#FFB1B1B1"
                                    VerticalOptions="Center" />
                                <Slider
                                    Grid.Column="1"
                                    Maximum="5"
                                    Minimum="1"
                                    MinimumTrackColor="#FFFFED6F"
                                    MaximumTrackColor="#FF404040"
                                    ThumbColor="#FFFFED6F"
                                    Value="{Binding DiaryValoracionMental}" />
                                <Label
                                    Grid.Column="2"
                                    FontAttributes="Bold"
                                    FontSize="16"
                                    HorizontalOptions="Center"
                                    Text="{Binding DiaryValoracionMental}"
                                    TextColor="#FFFFED6F"
                                    VerticalOptions="Center" />
                            </Grid>
                            
                            <!--  Valoración Técnica  -->
                            <Grid ColumnDefinitions="100,*,40" ColumnSpacing="12">
                                <Label
                                    FontSize="14"
                                    Text="Técnico"
                                    TextColor="#FFB1B1B1"
                                    VerticalOptions="Center" />
                                <Slider
                                    Grid.Column="1"
                                    Maximum="5"
                                    Minimum="1"
                                    MinimumTrackColor="#FFBEBADA"
                                    MaximumTrackColor="#FF404040"
                                    ThumbColor="#FFBEBADA"
                                    Value="{Binding DiaryValoracionTecnica}" />
                                <Label
                                    Grid.Column="2"
                                    FontAttributes="Bold"
                                    FontSize="16"
                                    HorizontalOptions="Center"
                                    Text="{Binding DiaryValoracionTecnica}"
                                    TextColor="#FFBEBADA"
                                    VerticalOptions="Center" />
                            </Grid>
                        </VerticalStackLayout>
                    </Border>

                    <Border HeightRequest="0.4" BackgroundColor="#FF0A0A0A"/>
                    <!--  Notas de sesión  -->
                    
                    <!--  Promedios últimos 30 días  -->
                    <Border
                        Padding="16"
                        BackgroundColor="Transparent"
                        StrokeShape="RoundRectangle 12"
                        StrokeThickness="0">
                        <VerticalStackLayout Spacing="12">
                            <Grid ColumnDefinitions="*,Auto">
                                <Label
                                    FontAttributes="Bold"
                                    FontSize="14"
                                    Text="Promedios (últimos 30 días)"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                                <Label
                                    Grid.Column="1"
                                    FontSize="12"
                                    Text="{Binding AvgValoracionCount, StringFormat='{0} sesiones'}"
                                    TextColor="#FF808080"
                                    VerticalOptions="Center" />
                            </Grid>
                            
                            <Grid ColumnDefinitions="*,*,*" ColumnSpacing="12">
                                <!--  Promedio Físico  -->
                                <Border
                                    Padding="12"
                                    BackgroundColor="#FF1E1E1E"
                                    StrokeShape="RoundRectangle 8"
                                    StrokeThickness="0">
                                    <VerticalStackLayout Spacing="4" HorizontalOptions="Center">
                                        <Label
                                            FontAttributes="Bold"
                                            FontSize="24"
                                            HorizontalOptions="Center"
                                            Text="{Binding AvgValoracionFisica, StringFormat='{0:F1}'}"
                                            TextColor="#FF8DD3C7" />
                                        <Label
                                            FontSize="11"
                                            HorizontalOptions="Center"
                                            Text="Físico"
                                            TextColor="#FF808080" />
                                    </VerticalStackLayout>
                                </Border>
                                
                                <!--  Promedio Mental  -->
                                <Border
                                    Grid.Column="1"
                                    Padding="12"
                                    BackgroundColor="#FF1E1E1E"
                                    StrokeShape="RoundRectangle 8"
                                    StrokeThickness="0">
                                    <VerticalStackLayout Spacing="4" HorizontalOptions="Center">
                                        <Label
                                            FontAttributes="Bold"
                                            FontSize="24"
                                            HorizontalOptions="Center"
                                            Text="{Binding AvgValoracionMental, StringFormat='{0:F1}'}"
                                            TextColor="#FFFFED6F" />
                                        <Label
                                            FontSize="11"
                                            HorizontalOptions="Center"
                                            Text="Mental"
                                            TextColor="#FF808080" />
                                    </VerticalStackLayout>
                                </Border>
                                
                                <!--  Promedio Técnico  -->
                                <Border
                                    Grid.Column="2"
                                    Padding="12"
                                    BackgroundColor="#FF1E1E1E"
                                    StrokeShape="RoundRectangle 8"
                                    StrokeThickness="0">
                                    <VerticalStackLayout Spacing="4" HorizontalOptions="Center">
                                        <Label
                                            FontAttributes="Bold"
                                            FontSize="24"
                                            HorizontalOptions="Center"
                                            Text="{Binding AvgValoracionTecnica, StringFormat='{0:F1}'}"
                                            TextColor="#FFBEBADA" />
                                        <Label
                                            FontSize="11"
                                            HorizontalOptions="Center"
                                            Text="Técnico"
                                            TextColor="#FF808080" />
                                    </VerticalStackLayout>
                                </Border>
                            </Grid>
                        </VerticalStackLayout>
                    </Border>
                    <Border HeightRequest="0.4" BackgroundColor="#FF0A0A0A"/>
                    
                    <!--  Gráfico de evolución  -->
                    <Border
                        Padding="16"
                        BackgroundColor="Transparent"
                        StrokeShape="RoundRectangle 12"
                        StrokeThickness="0">
                        <VerticalStackLayout Spacing="12">
                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                                <Label
                                    FontAttributes="Bold"
                                    FontSize="14"
                                    Text="Evolución"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                                
                                <!--  Selector de periodo  -->
                                <Grid Grid.Column="1" ColumnDefinitions="Auto,Auto,Auto,Auto" ColumnSpacing="4">
                                    <Border
                                        Padding="8,4"
                                        BackgroundColor="{Binding SelectedEvolutionPeriod, Converter={StaticResource IntEqualityToColorConverter}, ConverterParameter='0:#FF3A3A3A:#FF1E1E1E'}"
                                        StrokeShape="RoundRectangle 4"
                                        StrokeThickness="0">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding SetEvolutionPeriodCommand}" CommandParameter="0" />
                                        </Border.GestureRecognizers>
                                        <Label FontSize="11" Text="Semana" TextColor="White" />
                                    </Border>
                                    <Border
                                        Grid.Column="1"
                                        Padding="8,4"
                                        BackgroundColor="{Binding SelectedEvolutionPeriod, Converter={StaticResource IntEqualityToColorConverter}, ConverterParameter='1:#FF3A3A3A:#FF1E1E1E'}"
                                        StrokeShape="RoundRectangle 4"
                                        StrokeThickness="0">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding SetEvolutionPeriodCommand}" CommandParameter="1" />
                                        </Border.GestureRecognizers>
                                        <Label FontSize="11" Text="Mes" TextColor="White" />
                                    </Border>
                                    <Border
                                        Grid.Column="2"
                                        Padding="8,4"
                                        BackgroundColor="{Binding SelectedEvolutionPeriod, Converter={StaticResource IntEqualityToColorConverter}, ConverterParameter='2:#FF3A3A3A:#FF1E1E1E'}"
                                        StrokeShape="RoundRectangle 4"
                                        StrokeThickness="0">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding SetEvolutionPeriodCommand}" CommandParameter="2" />
                                        </Border.GestureRecognizers>
                                        <Label FontSize="11" Text="Año" TextColor="White" />
                                    </Border>
                                    <Border
                                        Grid.Column="3"
                                        Padding="8,4"
                                        BackgroundColor="{Binding SelectedEvolutionPeriod, Converter={StaticResource IntEqualityToColorConverter}, ConverterParameter='3:#FF3A3A3A:#FF1E1E1E'}"
                                        StrokeShape="RoundRectangle 4"
                                        StrokeThickness="0">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding SetEvolutionPeriodCommand}" CommandParameter="3" />
                                        </Border.GestureRecognizers>
                                        <Label FontSize="11" Text="Todo" TextColor="White" />
                                    </Border>
                                </Grid>
                            </Grid>
                            
                            <!--  Leyenda  -->
                            <HorizontalStackLayout Spacing="16" HorizontalOptions="Center">
                                <HorizontalStackLayout Spacing="4">
                                    <BoxView WidthRequest="12" HeightRequest="12" Color="#FF8DD3C7" CornerRadius="2" />
                                    <Label FontSize="11" Text="Físico" TextColor="#FF808080" />
                                </HorizontalStackLayout>
                                <HorizontalStackLayout Spacing="4">
                                    <BoxView WidthRequest="12" HeightRequest="12" Color="#FFFFED6F" CornerRadius="2" />
                                    <Label FontSize="11" Text="Mental" TextColor="#FF808080" />
                                </HorizontalStackLayout>
                                <HorizontalStackLayout Spacing="4">
                                    <BoxView WidthRequest="12" HeightRequest="12" Color="#FFBEBADA" CornerRadius="2" />
                                    <Label FontSize="11" Text="Técnico" TextColor="#FF808080" />
                                </HorizontalStackLayout>
                            </HorizontalStackLayout>
                            
                            <!--  Mensaje si no hay datos  -->
                            <Label
                                IsVisible="{Binding ValoracionEvolution.Count, Converter={StaticResource IntToBoolConverter}, ConverterParameter=invert}"
                                FontSize="14"
                                HorizontalOptions="Center"
                                Text="No hay datos de evolución para el periodo seleccionado"
                                TextColor="#FF808080" />
                            
                            <!--  Gráfico de evolución de valoraciones  -->
                            <controls:MultiLineChart 
                                IsVisible="{Binding ValoracionEvolution.Count, Converter={StaticResource IntToBoolConverter}}"
                                HeightRequest="180"
                                Values1="{Binding EvolutionFisicaValues}"
                                Values2="{Binding EvolutionMentalValues}"
                                Values3="{Binding EvolutionTecnicaValues}"
                                Labels="{Binding EvolutionLabels}"
                                MinValue="1"
                                MaxValue="5" />
                        </VerticalStackLayout>
                    </Border>

                    <Border HeightRequest="0.4" BackgroundColor="#FF0A0A0A"/>
                    
                    
                    <!--  Notas de sesión  -->
                    <Border
                        Padding="16"
                        BackgroundColor="#FF1E1E1E"
                        StrokeShape="RoundRectangle 12"
                        StrokeThickness="0">
                        <VerticalStackLayout Spacing="12">
                            <Label
                                FontAttributes="Bold"
                                FontSize="14"
                                Text="Notas de sesión"
                                TextColor="White" />
                            
                            <Editor
                                AutoSize="TextChanges"
                                BackgroundColor="#FF1E1E1E"
                                MinimumHeightRequest="500"
                                Placeholder="Escribe tus notas sobre la sesión...&#x0a;Cómo te has sentido, qué esperas de tu siguiente sesión, etc."
                                PlaceholderColor="#FF606060"
                                Text="{Binding DiaryNotas}"
                                TextColor="White" />
                        </VerticalStackLayout>
                    </Border>
                    
                    <!--  Botón Guardar  -->
                    <Button
                        Padding="20,12"
                        BackgroundColor="#FF303030"
                        Command="{Binding SaveDiaryCommand}"
                        CornerRadius="4"
                        HorizontalOptions="Fill"
                        Text="Guardar Diario"
                        TextColor="White" />
                    
                </VerticalStackLayout>

                <!--  ===== VISTA: DIARIO PERSONAL (CALENDARIO) =====  -->
                <VerticalStackLayout IsVisible="{Binding IsDiaryViewSelected}" Spacing="16">
                    
                    <!--  Título y botón agregar sesión  -->
                    <Grid ColumnDefinitions="*,Auto">
                        <HorizontalStackLayout Spacing="12" VerticalOptions="Center">
                            <controls:SymbolIcon
                                HeightRequest="24"
                                SymbolName="book"
                                TintColor="#FF6DDDFF"
                                VerticalOptions="Center"
                                WidthRequest="24" />
                            <Label
                                FontSize="24"
                                Text="Diario Personal"
                                TextColor="White" />
                        </HorizontalStackLayout>
                        
                        <!--  Botón agregar sesión  -->
                        <Button
                            Grid.Column="1"
                            Text="+ Nueva sesión"
                            BackgroundColor="#FF2A2A2A"
                            TextColor="#FF6DDDFF"
                            FontSize="12"
                            CornerRadius="6"
                            Padding="12,6"
                            HeightRequest="32"
                            VerticalOptions="Center"
                            Command="{Binding ToggleAddNewSessionCommand}"
                            IsVisible="{Binding IsAddingNewSession, Converter={toolkit:InvertedBoolConverter}}" />
                    </Grid>
                    
                    <!--  Fecha seleccionada  -->
                    <Label
                        FontSize="14"
                        Text="{Binding SelectedDiaryDate, StringFormat='{0:dddd, dd MMMM yyyy}'}"
                        TextColor="#FFB1B1B1" />

                    <!--  Formulario nueva sesión  -->
                    <Border
                        Padding="16"
                        BackgroundColor="#FF1E1E1E"
                        StrokeShape="RoundRectangle 12"
                        Stroke="#FF6DDDFF"
                        StrokeThickness="1"
                        IsVisible="{Binding IsAddingNewSession}">
                        <VerticalStackLayout Spacing="16">
                            <Label
                                FontAttributes="Bold"
                                FontSize="16"
                                Text="Nueva sesión"
                                TextColor="White" />
                            
                            <!--  Nombre de la sesión  -->
                            <VerticalStackLayout Spacing="4">
                                <Label
                                    FontSize="12"
                                    Text="Nombre de la sesión"
                                    TextColor="#FFB1B1B1" />
                                <Entry
                                    Placeholder="Ej: Entrenamiento de fuerza"
                                    PlaceholderColor="#FF666666"
                                    Text="{Binding NewSessionName}"
                                    TextColor="White"
                                    BackgroundColor="#FF2A2A2A" />
                            </VerticalStackLayout>
                            
                            <!--  Tipo de sesión  -->
                            <VerticalStackLayout Spacing="8">
                                <Label
                                    FontSize="12"
                                    Text="Tipo de sesión"
                                    TextColor="#FFB1B1B1" />
                                <FlexLayout 
                                    Wrap="Wrap" 
                                    JustifyContent="Start"
                                    BindableLayout.ItemsSource="{Binding SessionTypeOptions}">
                                    <BindableLayout.ItemTemplate>
                                        <DataTemplate x:DataType="vm:SessionTypeOption">
                                            <Border
                                                Margin="0,0,8,8"
                                                Padding="12,6"
                                                StrokeShape="RoundRectangle 6"
                                                StrokeThickness="0"
                                                BackgroundColor="{Binding IsSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=#FF6DDDFF|#FF2A2A2A}"
                                                Stroke="{Binding IsSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=#FF6DDDFF|#FF404040}">
                                                <Border.GestureRecognizers>
                                                    <TapGestureRecognizer 
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:DashboardViewModel}}, Path=SelectSessionTypeCommand}"
                                                        CommandParameter="{Binding .}" />
                                                </Border.GestureRecognizers>
                                                <Label
                                                    FontSize="12"
                                                    Text="{Binding Name}"
                                                    TextColor="{Binding IsSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=#FF121212|#FFB1B1B1}"
                                                    FontAttributes="{Binding IsSelected, Converter={StaticResource BoolToFontAttributesConverter}}"
                                                    VerticalOptions="Center" />
                                            </Border>
                                        </DataTemplate>
                                    </BindableLayout.ItemTemplate>
                                </FlexLayout>
                            </VerticalStackLayout>
                            
                            <!--  Lugar  -->
                            <VerticalStackLayout Spacing="4">
                                <Label
                                    FontSize="12"
                                    Text="Lugar (opcional)"
                                    TextColor="#FFB1B1B1" />
                                <Entry
                                    Placeholder="Ej: Gimnasio municipal"
                                    PlaceholderColor="#FF666666"
                                    Text="{Binding NewSessionLugar}"
                                    TextColor="White"
                                    BackgroundColor="#FF2A2A2A" />
                            </VerticalStackLayout>
                            
                            <!--  Botones  -->
                            <Grid ColumnDefinitions="*,*" ColumnSpacing="12">
                                <Button
                                    Text="Cancelar"
                                    BackgroundColor="#FF2A2A2A"
                                    TextColor="#FFB1B1B1"
                                    CornerRadius="8"
                                    HeightRequest="40"
                                    Command="{Binding CancelNewSessionCommand}" />
                                <Button
                                    Grid.Column="1"
                                    Text="Crear sesión"
                                    BackgroundColor="#FF6DDDFF"
                                    TextColor="#FF121212"
                                    FontAttributes="Bold"
                                    CornerRadius="8"
                                    HeightRequest="40"
                                    Command="{Binding CreateNewSessionCommand}" />
                            </Grid>
                        </VerticalStackLayout>
                    </Border>

                    <!--  Lista de sesiones del día seleccionado  -->
                    <VerticalStackLayout 
                        BindableLayout.ItemsSource="{Binding SelectedDateSessionsWithDiary}"
                        Spacing="16"
                        IsVisible="{Binding HasSelectedDateSessions}">
                        <BindableLayout.ItemTemplate>
                            <DataTemplate x:DataType="vm:SessionWithDiary">
                                <Border
                                    Padding="16"
                                    BackgroundColor="#FF1E1E1E"
                                    StrokeShape="RoundRectangle 12"
                                    StrokeThickness="0">
                                    <VerticalStackLayout Spacing="16">
                                        
                                        <!--  Título de la sesión  -->
                                        <Grid ColumnDefinitions="*,Auto">
                                            <HorizontalStackLayout Spacing="10">
                                                <controls:SymbolIcon
                                                    HeightRequest="20"
                                                    SymbolName="figure.pool.swim"
                                                    TintColor="#FF6DDDFF"
                                                    VerticalOptions="Center"
                                                    WidthRequest="20" />
                                                <VerticalStackLayout>
                                                    <Label
                                                        FontAttributes="Bold"
                                                        FontSize="16"
                                                        Text="{Binding Session.DisplayName}"
                                                        TextColor="White" />
                                                    <Label
                                                        FontSize="12"
                                                        Text="{Binding Session.FechaDateTime, StringFormat='{0:HH:mm}'}"
                                                        TextColor="#FF888888" />
                                                </VerticalStackLayout>
                                            </HorizontalStackLayout>
                                        </Grid>

                                        <!--  Mini galería de vídeos  -->
                                        <VerticalStackLayout Spacing="8" IsVisible="{Binding HasVideos}">
                                            <Label
                                                FontSize="12"
                                                Text="{Binding VideoCount, StringFormat='{0} vídeos'}"
                                                TextColor="#FF888888" />
                                            <FlexLayout
                                                Wrap="Wrap"
                                                JustifyContent="Start"
                                                BindableLayout.ItemsSource="{Binding Videos}">
                                                <BindableLayout.ItemTemplate>
                                                    <DataTemplate x:DataType="models:VideoClip">
                                                        <Border
                                                            Margin="0,0,2,6"
                                                            WidthRequest="60"
                                                            HeightRequest="40"
                                                            StrokeShape="RoundRectangle 2"
                                                            StrokeThickness="0"
                                                            BackgroundColor="#FF2A2A2A">
                                                            <Image
                                                                Source="{Binding LocalThumbnailPath}"
                                                                Aspect="AspectFill" />
                                                        </Border>
                                                    </DataTemplate>
                                                </BindableLayout.ItemTemplate>
                                            </FlexLayout>
                                            <Label
                                                FontSize="11"
                                                Text="{Binding ExtraVideosCount, StringFormat='+ {0} más'}"
                                                TextColor="#FF6DDDFF"
                                                IsVisible="{Binding HasExtraVideos}" />
                                            <Button
                                                Text="Ver sesión"
                                                BackgroundColor="#FF2A2A2A"
                                                TextColor="#FF6DDDFF"
                                                FontSize="12"
                                                CornerRadius="6"
                                                Padding="12,6"
                                                HeightRequest="32"
                                                HorizontalOptions="Start"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type vm:DashboardViewModel}}, Path=ViewSessionAsPlaylistCommand}"
                                                CommandParameter="{Binding .}" />
                                        </VerticalStackLayout>

                                        <!--  Valoraciones existentes (solo lectura)  -->
                                        <VerticalStackLayout Spacing="12" IsVisible="{Binding HasValoraciones}">
                                            <Label
                                                FontAttributes="Bold"
                                                FontSize="14"
                                                Text="Valoraciones"
                                                TextColor="White" />
                                            
                                            <!--  Valoración Física  -->
                                            <Grid ColumnDefinitions="80,*,40" ColumnSpacing="12">
                                                <Label
                                                    FontSize="14"
                                                    Text="Físico"
                                                    TextColor="#FFB1B1B1"
                                                    VerticalOptions="Center" />
                                                <ProgressBar
                                                    Grid.Column="1"
                                                    Progress="{Binding Diary.ValoracionFisica, Converter={StaticResource ProgressConverter}, ConverterParameter=5}"
                                                    ProgressColor="#FF8DD3C7"
                                                    VerticalOptions="Center" />
                                                <Label
                                                    Grid.Column="2"
                                                    FontAttributes="Bold"
                                                    FontSize="16"
                                                    HorizontalOptions="Center"
                                                    Text="{Binding Diary.ValoracionFisica}"
                                                    TextColor="#FF8DD3C7"
                                                    VerticalOptions="Center" />
                                            </Grid>
                                            
                                            <!--  Valoración Mental  -->
                                            <Grid ColumnDefinitions="80,*,40" ColumnSpacing="12">
                                                <Label
                                                    FontSize="14"
                                                    Text="Mental"
                                                    TextColor="#FFB1B1B1"
                                                    VerticalOptions="Center" />
                                                <ProgressBar
                                                    Grid.Column="1"
                                                    Progress="{Binding Diary.ValoracionMental, Converter={StaticResource ProgressConverter}, ConverterParameter=5}"
                                                    ProgressColor="#FFFFED6F"
                                                    VerticalOptions="Center" />
                                                <Label
                                                    Grid.Column="2"
                                                    FontAttributes="Bold"
                                                    FontSize="16"
                                                    HorizontalOptions="Center"
                                                    Text="{Binding Diary.ValoracionMental}"
                                                    TextColor="#FFFFED6F"
                                                    VerticalOptions="Center" />
                                            </Grid>
                                            
                                            <!--  Valoración Técnica  -->
                                            <Grid ColumnDefinitions="80,*,40" ColumnSpacing="12">
                                                <Label
                                                    FontSize="14"
                                                    Text="Técnico"
                                                    TextColor="#FFB1B1B1"
                                                    VerticalOptions="Center" />
                                                <ProgressBar
                                                    Grid.Column="1"
                                                    Progress="{Binding Diary.ValoracionTecnica, Converter={StaticResource ProgressConverter}, ConverterParameter=5}"
                                                    ProgressColor="#FFBEBADA"
                                                    VerticalOptions="Center" />
                                                <Label
                                                    Grid.Column="2"
                                                    FontAttributes="Bold"
                                                    FontSize="16"
                                                    HorizontalOptions="Center"
                                                    Text="{Binding Diary.ValoracionTecnica}"
                                                    TextColor="#FFBEBADA"
                                                    VerticalOptions="Center" />
                                            </Grid>
                                        </VerticalStackLayout>

                                        <!--  Formulario de valoraciones (si no existen)  -->
                                        <VerticalStackLayout Spacing="12" IsVisible="{Binding HasValoraciones, Converter={toolkit:InvertedBoolConverter}}">
                                            <Label
                                                FontAttributes="Bold"
                                                FontSize="14"
                                                Text="¿Cómo te sentiste en esta sesión?"
                                                TextColor="White" />
                                            
                                            <!--  Valoración Física  -->
                                            <Grid ColumnDefinitions="80,*,40" ColumnSpacing="12">
                                                <Label
                                                    FontSize="14"
                                                    Text="Físico"
                                                    TextColor="#FFB1B1B1"
                                                    VerticalOptions="Center" />
                                                <Slider
                                                    Grid.Column="1"
                                                    Maximum="5"
                                                    Minimum="1"
                                                    MinimumTrackColor="#FF8DD3C7"
                                                    MaximumTrackColor="#FF404040"
                                                    ThumbColor="#FF8DD3C7"
                                                    Value="{Binding EditValoracionFisica}" />
                                                <Label
                                                    Grid.Column="2"
                                                    FontAttributes="Bold"
                                                    FontSize="16"
                                                    HorizontalOptions="Center"
                                                    Text="{Binding EditValoracionFisica}"
                                                    TextColor="#FF8DD3C7"
                                                    VerticalOptions="Center" />
                                            </Grid>
                                            
                                            <!--  Valoración Mental  -->
                                            <Grid ColumnDefinitions="80,*,40" ColumnSpacing="12">
                                                <Label
                                                    FontSize="14"
                                                    Text="Mental"
                                                    TextColor="#FFB1B1B1"
                                                    VerticalOptions="Center" />
                                                <Slider
                                                    Grid.Column="1"
                                                    Maximum="5"
                                                    Minimum="1"
                                                    MinimumTrackColor="#FFFFED6F"
                                                    MaximumTrackColor="#FF404040"
                                                    ThumbColor="#FFFFED6F"
                                                    Value="{Binding EditValoracionMental}" />
                                                <Label
                                                    Grid.Column="2"
                                                    FontAttributes="Bold"
                                                    FontSize="16"
                                                    HorizontalOptions="Center"
                                                    Text="{Binding EditValoracionMental}"
                                                    TextColor="#FFFFED6F"
                                                    VerticalOptions="Center" />
                                            </Grid>
                                            
                                            <!--  Valoración Técnica  -->
                                            <Grid ColumnDefinitions="80,*,40" ColumnSpacing="12">
                                                <Label
                                                    FontSize="14"
                                                    Text="Técnico"
                                                    TextColor="#FFB1B1B1"
                                                    VerticalOptions="Center" />
                                                <Slider
                                                    Grid.Column="1"
                                                    Maximum="5"
                                                    Minimum="1"
                                                    MinimumTrackColor="#FFBEBADA"
                                                    MaximumTrackColor="#FF404040"
                                                    ThumbColor="#FFBEBADA"
                                                    Value="{Binding EditValoracionTecnica}" />
                                                <Label
                                                    Grid.Column="2"
                                                    FontAttributes="Bold"
                                                    FontSize="16"
                                                    HorizontalOptions="Center"
                                                    Text="{Binding EditValoracionTecnica}"
                                                    TextColor="#FFBEBADA"
                                                    VerticalOptions="Center" />
                                            </Grid>
                                        </VerticalStackLayout>

                                        <!--  Notas existentes  -->
                                        <VerticalStackLayout Spacing="8" IsVisible="{Binding HasNotas}">
                                            <Label
                                                FontAttributes="Bold"
                                                FontSize="14"
                                                Text="Notas"
                                                TextColor="White" />
                                            <Label
                                                FontSize="14"
                                                Text="{Binding Diary.Notas}"
                                                TextColor="#FFB1B1B1"
                                                LineBreakMode="WordWrap" />
                                        </VerticalStackLayout>

                                        <!--  Editor de notas (si no hay valoraciones o no hay notas)  -->
                                        <VerticalStackLayout Spacing="8" IsVisible="{Binding HasValoraciones, Converter={toolkit:InvertedBoolConverter}}">
                                            <Label
                                                FontAttributes="Bold"
                                                FontSize="14"
                                                Text="Notas"
                                                TextColor="White" />
                                            <Editor
                                                Placeholder="Escribe tus notas sobre esta sesión..."
                                                PlaceholderColor="#FF666666"
                                                Text="{Binding EditNotas}"
                                                TextColor="White"
                                                BackgroundColor="#FF2A2A2A"
                                                HeightRequest="100"
                                                AutoSize="TextChanges" />
                                        </VerticalStackLayout>

                                        <!--  Botón guardar (si no hay valoraciones)  -->
                                        <Button
                                            Text="Guardar"
                                            BackgroundColor="#FF6DDDFF"
                                            TextColor="#FF121212"
                                            FontAttributes="Bold"
                                            CornerRadius="8"
                                            HeightRequest="40"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:DashboardViewModel}}, Path=SaveCalendarDiaryCommand}"
                                            CommandParameter="{Binding .}"
                                            IsVisible="{Binding HasValoraciones, Converter={toolkit:InvertedBoolConverter}}" />

                                    </VerticalStackLayout>
                                </Border>
                            </DataTemplate>
                        </BindableLayout.ItemTemplate>
                    </VerticalStackLayout>
                    
                    <!--  ===== SECCIÓN BIENESTAR DIARIO (Entrada Manual) =====  -->
                    <Border
                        Padding="16"
                        BackgroundColor="#FF1E1E1E"
                        StrokeShape="RoundRectangle 12"
                        StrokeThickness="0">
                        <VerticalStackLayout Spacing="12">
                            
                            <!--  Título y botón editar  -->
                            <Grid ColumnDefinitions="*,Auto">
                                <HorizontalStackLayout Spacing="10">
                                    <controls:SymbolIcon
                                        HeightRequest="30"
                                        SymbolName="heart.fill"
                                        TintColor="#FFFF6B6B"
                                        VerticalOptions="Center"
                                        WidthRequest="30" />
                                    <Label
                                        FontAttributes="Bold"
                                        FontSize="16"
                                        Text="Bienestar"
                                        TextColor="White"
                                        VerticalOptions="Center" />
                                </HorizontalStackLayout>
                                
                                <Button
                                    Grid.Column="1"
                                    Text="{Binding HasWellnessData, Converter={StaticResource BoolToTextConverter}, ConverterParameter='Editar|Añadir'}"
                                    BackgroundColor="#FF2A2A2A"
                                    TextColor="#FFFF6B6B"
                                    FontSize="12"
                                    CornerRadius="6"
                                    Padding="12,6"
                                    HeightRequest="32"
                                    VerticalOptions="Center"
                                    Command="{Binding StartEditWellnessCommand}"
                                    IsVisible="{Binding IsEditingWellness, Converter={toolkit:InvertedBoolConverter}}" />
                            </Grid>

                            <!--  Formulario de edición  -->
                            <VerticalStackLayout 
                                Spacing="12"
                                IsVisible="{Binding IsEditingWellness}">
                                
                                <!--  Sueño  -->
                                <Border
                                    Padding="12"
                                    BackgroundColor="#FF2A2A2A"
                                    StrokeShape="RoundRectangle 8"
                                    StrokeThickness="0">
                                    <VerticalStackLayout Spacing="8">
                                        <Label Text="Horas de sueño" TextColor="#FF888888" FontSize="12" />
                                        <Grid ColumnDefinitions="*,80">
                                            <Slider
                                                Minimum="0"
                                                Maximum="12"
                                                Value="{Binding WellnessSleepHours, Mode=TwoWay, TargetNullValue=7}"
                                                MinimumTrackColor="#FF5856D6"
                                                MaximumTrackColor="#FF555555"
                                                ThumbColor="#FF5856D6" />
                                            <Label
                                                Grid.Column="1"
                                                Text="{Binding WellnessSleepHours, StringFormat='{0:F1} h'}"
                                                TextColor="White"
                                                FontSize="16"
                                                FontAttributes="Bold"
                                                HorizontalOptions="End"
                                                VerticalOptions="Center" />
                                        </Grid>
                                    </VerticalStackLayout>
                                </Border>

                                <!--  Sensación de recuperación  -->
                                <Border
                                    Padding="12"
                                    BackgroundColor="#FF2A2A2A"
                                    StrokeShape="RoundRectangle 8"
                                    StrokeThickness="0">
                                    <VerticalStackLayout Spacing="8">
                                        <Label Text="¿Cómo te sientes hoy? (1-10)" TextColor="#FF888888" FontSize="12" />
                                        <Grid ColumnDefinitions="*,60">
                                            <Slider
                                                Minimum="1"
                                                Maximum="10"
                                                Value="{Binding WellnessRecoveryFeeling, Mode=TwoWay, TargetNullValue=5}"
                                                MinimumTrackColor="#FF4CD964"
                                                MaximumTrackColor="#FF555555"
                                                ThumbColor="#FF4CD964" />
                                            <Label
                                                Grid.Column="1"
                                                Text="{Binding WellnessRecoveryFeeling}"
                                                TextColor="White"
                                                FontSize="20"
                                                FontAttributes="Bold"
                                                HorizontalOptions="End"
                                                VerticalOptions="Center" />
                                        </Grid>
                                    </VerticalStackLayout>
                                </Border>

                                <!--  Fatiga muscular  -->
                                <Border
                                    Padding="12"
                                    BackgroundColor="#FF2A2A2A"
                                    StrokeShape="RoundRectangle 8"
                                    StrokeThickness="0">
                                    <VerticalStackLayout Spacing="8">
                                        <Label Text="Fatiga muscular (1=ninguna, 10=mucha)" TextColor="#FF888888" FontSize="12" />
                                        <Grid ColumnDefinitions="*,60">
                                            <Slider
                                                Minimum="1"
                                                Maximum="10"
                                                Value="{Binding WellnessMuscleFatigue, Mode=TwoWay, TargetNullValue=3}"
                                                MinimumTrackColor="#FFFF9500"
                                                MaximumTrackColor="#FF555555"
                                                ThumbColor="#FFFF9500" />
                                            <Label
                                                Grid.Column="1"
                                                Text="{Binding WellnessMuscleFatigue}"
                                                TextColor="White"
                                                FontSize="20"
                                                FontAttributes="Bold"
                                                HorizontalOptions="End"
                                                VerticalOptions="Center" />
                                        </Grid>
                                    </VerticalStackLayout>
                                </Border>

                                <!--  Estado de ánimo  -->
                                <Border
                                    Padding="12"
                                    BackgroundColor="#FF2A2A2A"
                                    StrokeShape="RoundRectangle 8"
                                    StrokeThickness="0">
                                    <VerticalStackLayout Spacing="8">
                                        <Label Text="Estado de ánimo" TextColor="#FF888888" FontSize="12" />
                                        <HorizontalStackLayout HorizontalOptions="Center" Spacing="8">
                                            <Border
                                                Padding="8"
                                                WidthRequest="50"
                                                HeightRequest="50"
                                                StrokeShape="RoundRectangle 4"
                                                BackgroundColor="Transparent"
                                                StrokeThickness="{Binding WellnessMoodRating, Converter={StaticResource EqualityToBorderWidthConverter}, ConverterParameter=1}"
                                                Stroke="#FFFF6B6B">
                                                <Border.GestureRecognizers>
                                                    <TapGestureRecognizer 
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:DashboardViewModel}}, Path=SetMoodCommand}"
                                                        CommandParameter="1" />
                                                </Border.GestureRecognizers>
                                                <controls:SymbolIcon
                                                    HeightRequest="28"
                                                    WidthRequest="28"
                                                    SymbolName="cloud.heavyrain.fill"
                                                    TintColor="#FFFF6B6B"
                                                    HorizontalOptions="Center"
                                                    VerticalOptions="Center" />
                                            </Border>
                                            <Border
                                                Padding="8"
                                                WidthRequest="50"
                                                HeightRequest="50"
                                                StrokeShape="RoundRectangle 4"
                                                BackgroundColor="Transparent"
                                                StrokeThickness="{Binding WellnessMoodRating, Converter={StaticResource EqualityToBorderWidthConverter}, ConverterParameter=2}"
                                                Stroke="#FFFF9500">
                                                <Border.GestureRecognizers>
                                                    <TapGestureRecognizer 
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:DashboardViewModel}}, Path=SetMoodCommand}"
                                                        CommandParameter="2" />
                                                </Border.GestureRecognizers>
                                                <controls:SymbolIcon
                                                    HeightRequest="28"
                                                    WidthRequest="28"
                                                    SymbolName="cloud.fill"
                                                    TintColor="#FFFF9500"
                                                    HorizontalOptions="Center"
                                                    VerticalOptions="Center" />
                                            </Border>
                                            <Border
                                                Padding="8"
                                                WidthRequest="50"
                                                HeightRequest="50"
                                                StrokeShape="RoundRectangle 4"
                                                BackgroundColor="Transparent"
                                                StrokeThickness="{Binding WellnessMoodRating, Converter={StaticResource EqualityToBorderWidthConverter}, ConverterParameter=3}"
                                                Stroke="#FFFFC107">
                                                <Border.GestureRecognizers>
                                                    <TapGestureRecognizer 
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:DashboardViewModel}}, Path=SetMoodCommand}"
                                                        CommandParameter="3" />
                                                </Border.GestureRecognizers>
                                                <controls:SymbolIcon
                                                    HeightRequest="28"
                                                    WidthRequest="28"
                                                    SymbolName="cloud.sun.fill"
                                                    TintColor="#FFFFC107"
                                                    HorizontalOptions="Center"
                                                    VerticalOptions="Center" />
                                            </Border>
                                            <Border
                                                Padding="8"
                                                WidthRequest="50"
                                                HeightRequest="50"
                                                StrokeShape="RoundRectangle 4"
                                                BackgroundColor="Transparent"
                                                StrokeThickness="{Binding WellnessMoodRating, Converter={StaticResource EqualityToBorderWidthConverter}, ConverterParameter=4}"
                                                Stroke="#FF8BC34A">
                                                <Border.GestureRecognizers>
                                                    <TapGestureRecognizer 
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:DashboardViewModel}}, Path=SetMoodCommand}"
                                                        CommandParameter="4" />
                                                </Border.GestureRecognizers>
                                                <controls:SymbolIcon
                                                    HeightRequest="28"
                                                    WidthRequest="28"
                                                    SymbolName="sun.max.fill"
                                                    TintColor="#FF8BC34A"
                                                    HorizontalOptions="Center"
                                                    VerticalOptions="Center" />
                                            </Border>
                                            <Border
                                                Padding="8"
                                                WidthRequest="50"
                                                HeightRequest="50"
                                                StrokeShape="RoundRectangle 4"
                                                BackgroundColor="Transparent"
                                                StrokeThickness="{Binding WellnessMoodRating, Converter={StaticResource EqualityToBorderWidthConverter}, ConverterParameter=5}"
                                                Stroke="#FF4CD964">
                                                <Border.GestureRecognizers>
                                                    <TapGestureRecognizer 
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:DashboardViewModel}}, Path=SetMoodCommand}"
                                                        CommandParameter="5" />
                                                </Border.GestureRecognizers>
                                                <controls:SymbolIcon
                                                    HeightRequest="28"
                                                    WidthRequest="28"
                                                    SymbolName="sparkles"
                                                    TintColor="#FF4CD964"
                                                    HorizontalOptions="Center"
                                                    VerticalOptions="Center" />
                                            </Border>
                                        </HorizontalStackLayout>
                                    </VerticalStackLayout>
                                </Border>

                                <!--  PPM Basal y HRV  -->
                                <Grid ColumnDefinitions="*,*" ColumnSpacing="12">
                                    <!--  PPM Basal  -->
                                    <Border
                                        Padding="12"
                                        BackgroundColor="#FF2A2A2A"
                                        StrokeShape="RoundRectangle 8"
                                        StrokeThickness="0">
                                        <VerticalStackLayout Spacing="8">
                                            <Grid ColumnDefinitions="Auto,*,Auto">
                                                <HorizontalStackLayout Spacing="6">
                                                    <controls:SymbolIcon
                                                        HeightRequest="24"
                                                        SymbolName="heart.fill"
                                                        TintColor="#FFFF6B6B"
                                                        VerticalOptions="Center"
                                                        WidthRequest="24" />
                                                    <Label Text="PPM Basal" TextColor="#FF888888" FontSize="12" VerticalOptions="Center" />
                                                </HorizontalStackLayout>
                                                <Button
                                                    Grid.Column="2"
                                                    Text="?"
                                                    FontSize="14"
                                                    FontAttributes="Bold"
                                                    BackgroundColor="Transparent"
                                                    TextColor="#FFABABAB"
                                                    CornerRadius="4"
                                                    Padding="0"
                                                    WidthRequest="20"
                                                    HeightRequest="20"
                                                    Command="{Binding ShowPPMInfoCommand}" />
                                            </Grid>
                                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                                                <Entry
                                                    Text="{Binding WellnessRestingHeartRate}"
                                                    Placeholder="60"
                                                    PlaceholderColor="#FF555555"
                                                    TextColor="White"
                                                    BackgroundColor="#FF1E1E1E"
                                                    Keyboard="Numeric"
                                                    HorizontalTextAlignment="Center"
                                                    FontSize="18"
                                                    FontAttributes="Bold" />
                                                <Label
                                                    Grid.Column="1"
                                                    Text="bpm"
                                                    TextColor="#FF888888"
                                                    FontSize="14"
                                                    VerticalOptions="Center" />
                                            </Grid>
                                        </VerticalStackLayout>
                                    </Border>

                                    <!--  HRV  -->
                                    <Border
                                        Grid.Column="1"
                                        Padding="12"
                                        BackgroundColor="#FF2A2A2A"
                                        StrokeShape="RoundRectangle 8"
                                        StrokeThickness="0">
                                        <VerticalStackLayout Spacing="8">
                                            <Grid ColumnDefinitions="Auto,*,Auto">
                                                <HorizontalStackLayout Spacing="6">
                                                    <controls:SymbolIcon
                                                        HeightRequest="24"
                                                        SymbolName="waveform.path.ecg"
                                                        TintColor="#FFAEADFF"
                                                        VerticalOptions="Center"
                                                        WidthRequest="24" />
                                                    <Label Text="HRV" TextColor="#FF888888" FontSize="12" VerticalOptions="Center" />
                                                </HorizontalStackLayout>
                                                <Button
                                                    Grid.Column="2"
                                                    Text="?"
                                                    FontSize="14"
                                                    FontAttributes="Bold"
                                                    BackgroundColor="Transparent"
                                                    TextColor="#FFADADAD"
                                                    CornerRadius="4"
                                                    Padding="0"
                                                    WidthRequest="20"
                                                    HeightRequest="20"
                                                    Command="{Binding ShowHRVInfoCommand}" />
                                            </Grid>
                                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                                                <Entry
                                                    Text="{Binding WellnessHRV}"
                                                    Placeholder="50"
                                                    PlaceholderColor="#FF555555"
                                                    TextColor="White"
                                                    BackgroundColor="#FF1E1E1E"
                                                    Keyboard="Numeric"
                                                    HorizontalTextAlignment="Center"
                                                    FontSize="18"
                                                    FontAttributes="Bold" />
                                                <Label
                                                    Grid.Column="1"
                                                    Text="ms"
                                                    TextColor="#FF888888"
                                                    FontSize="14"
                                                    VerticalOptions="Center" />
                                            </Grid>
                                        </VerticalStackLayout>
                                    </Border>
                                </Grid>

                                <!--  Notas  -->
                                <Border
                                    Padding="12"
                                    BackgroundColor="#FF2A2A2A"
                                    StrokeShape="RoundRectangle 8"
                                    StrokeThickness="0">
                                    <VerticalStackLayout Spacing="8">
                                        <Label Text="Notas (opcional)" TextColor="#FF888888" FontSize="12" />
                                        <Editor
                                            Text="{Binding WellnessNotes}"
                                            Placeholder="¿Algo que destacar sobre tu estado hoy?"
                                            PlaceholderColor="#FF555555"
                                            TextColor="White"
                                            BackgroundColor="#FF1E1E1E"
                                            HeightRequest="80"
                                            AutoSize="TextChanges" />
                                    </VerticalStackLayout>
                                </Border>

                                <!--  Botones guardar/cancelar  -->
                                <Grid ColumnDefinitions="*,*" ColumnSpacing="12">
                                    <Button
                                        Text="Cancelar"
                                        BackgroundColor="#FF3A3A3A"
                                        TextColor="#FF888888"
                                        CornerRadius="8"
                                        Command="{Binding CancelEditWellnessCommand}" />
                                    <Button
                                        Grid.Column="1"
                                        Text="Guardar"
                                        BackgroundColor="#FF4CD964"
                                        TextColor="White"
                                        CornerRadius="8"
                                        Command="{Binding SaveWellnessCommand}" />
                                </Grid>
                            </VerticalStackLayout>

                            <!--  Vista de datos guardados (cuando no está editando)  -->
                            <VerticalStackLayout 
                                Spacing="12"
                                IsVisible="{Binding IsEditingWellness, Converter={toolkit:InvertedBoolConverter}}">
                                
                                <!--  Indicador de bienestar si hay datos  -->
                                <Border
                                    Padding="12"
                                    BackgroundColor="{Binding SelectedDateWellness.WellnessColor}"
                                    StrokeShape="RoundRectangle 8"
                                    StrokeThickness="0"
                                    IsVisible="{Binding HasWellnessData}">
                                    <Grid ColumnDefinitions="*,Auto">
                                        <VerticalStackLayout>
                                            <Label
                                                FontSize="12"
                                                Text="Nivel de bienestar"
                                                TextColor="#FF121212"
                                                Opacity="0.7" />
                                            <Label
                                                FontAttributes="Bold"
                                                FontSize="18"
                                                Text="{Binding SelectedDateWellness.WellnessText}"
                                                TextColor="#FF121212" />
                                        </VerticalStackLayout>
                                        <Label
                                            Grid.Column="1"
                                            FontAttributes="Bold"
                                            FontSize="32"
                                            Text="{Binding SelectedDateWellness.WellnessScore}"
                                            TextColor="#FF121212"
                                            VerticalOptions="Center" />
                                    </Grid>
                                </Border>

                                <!--  Métricas si hay datos  -->
                                <Grid ColumnDefinitions="*,*,*" ColumnSpacing="8"
                                      IsVisible="{Binding HasWellnessData}">
                                    <!--  Sueño  -->
                                    <Border
                                        Padding="10"
                                        BackgroundColor="#FF2A2A2A"
                                        StrokeShape="RoundRectangle 8"
                                        StrokeThickness="0">
                                        <VerticalStackLayout HorizontalOptions="Center" Spacing="2">
                                            <controls:SymbolIcon
                                                HeightRequest="20"
                                                SymbolName="moon.fill"
                                                TintColor="#FF5856D6"
                                                HorizontalOptions="Center"
                                                WidthRequest="20" />
                                            <Label
                                                FontAttributes="Bold"
                                                FontSize="16"
                                                Text="{Binding SelectedDateWellness.SleepFormatted}"
                                                TextColor="White"
                                                HorizontalOptions="Center" />
                                            <Label
                                                FontSize="10"
                                                Text="sueño"
                                                TextColor="#FF888888"
                                                HorizontalOptions="Center" />
                                        </VerticalStackLayout>
                                    </Border>
                                    
                                    <!--  Recuperación  -->
                                    <Border
                                        Grid.Column="1"
                                        Padding="10"
                                        BackgroundColor="#FF2A2A2A"
                                        StrokeShape="RoundRectangle 8"
                                        StrokeThickness="0">
                                        <VerticalStackLayout HorizontalOptions="Center" Spacing="2">
                                            <controls:SymbolIcon
                                                HeightRequest="20"
                                                SymbolName="bolt.fill"
                                                TintColor="#FF4CD964"
                                                HorizontalOptions="Center"
                                                WidthRequest="20" />
                                            <Label
                                                FontAttributes="Bold"
                                                FontSize="16"
                                                Text="{Binding SelectedDateWellness.RecoveryFeeling, StringFormat='{0}/10'}"
                                                TextColor="White"
                                                HorizontalOptions="Center" />
                                            <Label
                                                FontSize="10"
                                                Text="energía"
                                                TextColor="#FF888888"
                                                HorizontalOptions="Center" />
                                        </VerticalStackLayout>
                                    </Border>
                                    
                                    <!--  Ánimo  -->
                                    <Border
                                        Grid.Column="2"
                                        Padding="10"
                                        BackgroundColor="#FF2A2A2A"
                                        StrokeShape="RoundRectangle 8"
                                        StrokeThickness="0">
                                        <VerticalStackLayout HorizontalOptions="Center" Spacing="2">
                                            <controls:SymbolIcon
                                                HeightRequest="24"
                                                WidthRequest="24"
                                                SymbolName="{Binding SelectedDateWellness.MoodSymbol}"
                                                TintColor="{Binding SelectedDateWellness.MoodColor}"
                                                HorizontalOptions="Center" />
                                            <Label
                                                FontSize="10"
                                                Text="ánimo"
                                                TextColor="#FF888888"
                                                HorizontalOptions="Center" />
                                        </VerticalStackLayout>
                                    </Border>
                                </Grid>

                                <!--  PPM Basal y HRV (si están registrados)  -->
                                <Grid ColumnDefinitions="*,*" ColumnSpacing="8"
                                      IsVisible="{Binding HasWellnessData}">
                                    <!--  PPM Basal  -->
                                    <Border
                                        Padding="10"
                                        BackgroundColor="#FF2A2A2A"
                                        StrokeShape="RoundRectangle 8"
                                        StrokeThickness="0"
                                        IsVisible="{Binding SelectedDateWellness.RestingHeartRate, Converter={StaticResource IsNotNullConverter}}">
                                        <HorizontalStackLayout HorizontalOptions="Center" Spacing="8">
                                            <controls:SymbolIcon
                                                HeightRequest="18"
                                                SymbolName="heart.fill"
                                                TintColor="#FFFF6B6B"
                                                VerticalOptions="Center"
                                                WidthRequest="18" />
                                            <VerticalStackLayout Spacing="0">
                                                <HorizontalStackLayout Spacing="4">
                                                    <Label
                                                        FontAttributes="Bold"
                                                        FontSize="16"
                                                        Text="{Binding SelectedDateWellness.RestingHeartRate}"
                                                        TextColor="White"
                                                        VerticalOptions="Center" />
                                                    <Label
                                                        FontSize="12"
                                                        Text="bpm"
                                                        TextColor="#FF888888"
                                                        VerticalOptions="Center" />
                                                </HorizontalStackLayout>
                                                <Label
                                                    FontSize="10"
                                                    Text="PPM basal"
                                                    TextColor="#FF888888" />
                                            </VerticalStackLayout>
                                        </HorizontalStackLayout>
                                    </Border>
                                    
                                    <!--  HRV  -->
                                    <Border
                                        Grid.Column="1"
                                        Padding="10"
                                        BackgroundColor="#FF2A2A2A"
                                        StrokeShape="RoundRectangle 8"
                                        StrokeThickness="0"
                                        IsVisible="{Binding SelectedDateWellness.HeartRateVariability, Converter={StaticResource IsNotNullConverter}}">
                                        <HorizontalStackLayout HorizontalOptions="Center" Spacing="8">
                                            <controls:SymbolIcon
                                                HeightRequest="18"
                                                SymbolName="waveform.path.ecg"
                                                TintColor="#FF5856D6"
                                                VerticalOptions="Center"
                                                WidthRequest="18" />
                                            <VerticalStackLayout Spacing="0">
                                                <HorizontalStackLayout Spacing="4">
                                                    <Label
                                                        FontAttributes="Bold"
                                                        FontSize="16"
                                                        Text="{Binding SelectedDateWellness.HeartRateVariability}"
                                                        TextColor="White"
                                                        VerticalOptions="Center" />
                                                    <Label
                                                        FontSize="12"
                                                        Text="ms"
                                                        TextColor="#FF888888"
                                                        VerticalOptions="Center" />
                                                </HorizontalStackLayout>
                                                <Label
                                                    FontSize="10"
                                                    Text="HRV"
                                                    TextColor="#FF888888" />
                                            </VerticalStackLayout>
                                        </HorizontalStackLayout>
                                    </Border>
                                </Grid>

                                <!--  Notas si existen  -->
                                <Border
                                    Padding="12"
                                    BackgroundColor="#FF2A2A2A"
                                    StrokeShape="RoundRectangle 8"
                                    StrokeThickness="0"
                                    IsVisible="{Binding SelectedDateWellness.Notes, Converter={StaticResource NotNullOrEmptyBoolConverter}}">
                                    <VerticalStackLayout Spacing="4">
                                        <Label Text="Notas" TextColor="#FF888888" FontSize="11" />
                                        <Label 
                                            Text="{Binding SelectedDateWellness.Notes}" 
                                            TextColor="White" 
                                            FontSize="13"
                                            LineBreakMode="WordWrap" />
                                    </VerticalStackLayout>
                                </Border>

                                <!--  Mensaje si no hay datos  -->
                                <Label
                                    Text="Pulsa 'Añadir' para registrar tu bienestar del día"
                                    TextColor="#FF666666"
                                    FontSize="13"
                                    HorizontalTextAlignment="Center"
                                    IsVisible="{Binding HasWellnessData, Converter={toolkit:InvertedBoolConverter}}" />
                            </VerticalStackLayout>
                        </VerticalStackLayout>
                    </Border>
                    
                    <!--  Mensaje cuando no hay sesiones para la fecha  -->
                    <Border
                        Padding="24"
                        BackgroundColor="#FF1E1E1E"
                        StrokeShape="RoundRectangle 12"
                        StrokeThickness="0"
                        IsVisible="{Binding HasSelectedDateSessions, Converter={toolkit:InvertedBoolConverter}}">
                        <VerticalStackLayout HorizontalOptions="Center" Spacing="12">
                            <controls:SymbolIcon
                                HeightRequest="48"
                                SymbolName="calendar.badge.exclamationmark"
                                TintColor="#FF555555"
                                HorizontalOptions="Center"
                                WidthRequest="48" />
                            <Label
                                FontSize="16"
                                Text="No hay sesiones para este día"
                                TextColor="#FF888888"
                                HorizontalOptions="Center" />
                            <Label
                                FontSize="14"
                                Text="Puedes crear una sesión manual para registrar&#x0a;entrenamientos sin vídeo (gimnasio, agua tranquila, etc.)"
                                TextColor="#FF666666"
                                HorizontalOptions="Center"
                                HorizontalTextAlignment="Center" />
                            <Button
                                Text="+ Crear nueva sesión"
                                BackgroundColor="#FF6DDDFF"
                                TextColor="#FF121212"
                                FontAttributes="Bold"
                                CornerRadius="8"
                                Padding="24,0"
                                HeightRequest="40"
                                Margin="0,8,0,0"
                                HorizontalOptions="Center"
                                Command="{Binding ToggleAddNewSessionCommand}" />
                        </VerticalStackLayout>
                    </Border>
                    
                </VerticalStackLayout>

            </VerticalStackLayout>
        </ScrollView>
        <Border
            x:Name="HoverPreviewContainer"
            Grid.Row="1"
            Grid.Column="2"
            Grid.ColumnSpan="3"
            Margin="20"
            BackgroundColor="#FF121212"
            HorizontalOptions="End"
            IsVisible="{Binding HasHoverVideo}"
            Stroke="#FF3A3A3A"
            StrokeShape="RoundRectangle 12"
            StrokeThickness="1"
            VerticalOptions="Start"
            WidthRequest="480">
            <Grid RowDefinitions="Auto,Auto">
                <controls:AspectRatioContainer AspectRatio="1.777">
                    <toolkit:MediaElement
                        x:Name="HoverPreviewMedia"
                        Aspect="AspectFill"
                        ShouldAutoPlay="True"
                        ShouldLoopPlayback="True"
                        ShouldMute="True"
                        ShouldShowPlaybackControls="False"
                        Source="{Binding HoverVideo.LocalClipPath}" />
                </controls:AspectRatioContainer>
                <Label
                    Grid.Row="1"
                    Padding="12,8"
                    FontSize="14"
                    LineBreakMode="TailTruncation"
                    Text="{Binding HoverVideo.Atleta.NombreCompleto}"
                    TextColor="White" />
            </Grid>
        </Border>

        <ActivityIndicator
            Grid.Row="1"
            Grid.ColumnSpan="5"
            HorizontalOptions="Center"
            IsRunning="{Binding IsBusy}"
            IsVisible="{Binding IsBusy}"
            VerticalOptions="Center"
            Color="#FF6DDDFF" />

        <!--  Popup de edición en lote  -->
        <Grid
            Grid.Row="0"
            Grid.RowSpan="2"
            Grid.ColumnSpan="5"
            BackgroundColor="#CC000000"
            IsVisible="{Binding ShowBatchEditPopup}">
            <Border
                Padding="24"
                BackgroundColor="#FF1E1E1E"
                HorizontalOptions="Center"
                Stroke="#FF3A3A3A"
                StrokeShape="RoundRectangle 12"
                StrokeThickness="1"
                VerticalOptions="Center"
                WidthRequest="400">
                <VerticalStackLayout Spacing="16">
                    <!--  Título  -->
                    <Grid ColumnDefinitions="*,Auto">
                        <Label
                            FontAttributes="Bold"
                            FontSize="18"
                            Text="Editar vídeos seleccionados"
                            TextColor="White" />
                        <Border
                            Grid.Column="1"
                            Padding="4"
                            BackgroundColor="Transparent"
                            Stroke="Transparent"
                            StrokeShape="RoundRectangle 4">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding CloseBatchEditPopupCommand}" />
                            </Border.GestureRecognizers>
                            <controls:SymbolIcon
                                HeightRequest="20"
                                SymbolName="xmark"
                                TintColor="#FF888888"
                                WidthRequest="20" />
                        </Border>
                    </Grid>

                    <Label
                        FontSize="13"
                        Text="{Binding SelectedVideoCount, StringFormat='Se modificarán {0} vídeos'}"
                        TextColor="#FFAAAAAA" />

                    <!--  Atleta  -->
                    <VerticalStackLayout Spacing="8">
                        <Grid ColumnDefinitions="Auto,*">
                            <CheckBox
                                IsChecked="{Binding BatchEditAthleteEnabled}"
                                Color="#FF6DDDFF"
                                VerticalOptions="Center" />
                            <Label
                                Grid.Column="1"
                                FontSize="14"
                                Text="Asignar atleta"
                                TextColor="White"
                                VerticalOptions="Center" />
                        </Grid>
                        <ScrollView 
                            HeightRequest="120" 
                            IsEnabled="{Binding BatchEditAthleteEnabled}">
                            <FlexLayout
                                BindableLayout.ItemsSource="{Binding BatchEditAthletes}"
                                Direction="Row"
                                Wrap="Wrap">
                                <BindableLayout.ItemTemplate>
                                    <DataTemplate x:DataType="models:Athlete">
                                        <Border
                                            Margin="0,0,8,8"
                                            Padding="10,6"
                                            BackgroundColor="{Binding IsSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF4A9FD4|#FF2A2A2A'}"
                                            Stroke="{Binding IsSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF4A9FD4|#FF3A3A3A'}"
                                            StrokeShape="RoundRectangle 4">
                                            <Border.GestureRecognizers>
                                                <TapGestureRecognizer
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:DashboardViewModel}}, Path=SelectBatchAthleteCommand}"
                                                    CommandParameter="{Binding .}" />
                                            </Border.GestureRecognizers>
                                            <Label
                                                FontSize="12"
                                                Text="{Binding NombreCompleto}"
                                                TextColor="White" />
                                        </Border>
                                    </DataTemplate>
                                </BindableLayout.ItemTemplate>
                            </FlexLayout>
                        </ScrollView>
                        <Label
                            FontSize="12"
                            Text="No hay atletas disponibles"
                            TextColor="#FF666666">
                            <Label.Triggers>
                                <DataTrigger TargetType="Label" Binding="{Binding BatchEditAthletes.Count}" Value="0">
                                    <Setter Property="IsVisible" Value="True" />
                                </DataTrigger>
                            </Label.Triggers>
                            <Label.Style>
                                <Style TargetType="Label">
                                    <Setter Property="IsVisible" Value="False" />
                                </Style>
                            </Label.Style>
                        </Label>
                    </VerticalStackLayout>

                    <!--  Sección  -->
                    <VerticalStackLayout Spacing="8">
                        <Grid ColumnDefinitions="Auto,*">
                            <CheckBox
                                IsChecked="{Binding BatchEditSectionEnabled}"
                                Color="#FF6DDDFF"
                                VerticalOptions="Center" />
                            <Label
                                Grid.Column="1"
                                FontSize="14"
                                Text="Asignar sección/tramo"
                                TextColor="White"
                                VerticalOptions="Center" />
                        </Grid>
                        <HorizontalStackLayout IsEnabled="{Binding BatchEditSectionEnabled}" Spacing="12">
                            <Entry
                                BackgroundColor="#FF2A2A2A"
                                Keyboard="Numeric"
                                Text="{Binding BatchEditSection}"
                                TextColor="White"
                                WidthRequest="80" />
                            <Label
                                FontSize="13"
                                Text="(1-99)"
                                TextColor="#FF888888"
                                VerticalOptions="Center" />
                        </HorizontalStackLayout>
                    </VerticalStackLayout>

                    <!--  Etiquetas  -->
                    <VerticalStackLayout Spacing="8">
                        <Label
                            FontSize="14"
                            Text="Añadir etiquetas"
                            TextColor="White" />
                        <FlexLayout
                            BindableLayout.ItemsSource="{Binding BatchEditTags}"
                            Direction="Row"
                            Wrap="Wrap">
                            <BindableLayout.ItemTemplate>
                                <DataTemplate x:DataType="models:Tag">
                                    <Border
                                        Margin="0,0,8,8"
                                        Padding="10,6"
                                        BackgroundColor="{Binding IsSelectedBool, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF4A9FD4|#FF2A2A2A'}"
                                        Stroke="{Binding IsSelectedBool, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF4A9FD4|#FF3A3A3A'}"
                                        StrokeShape="RoundRectangle 4">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type vm:DashboardViewModel}}, Path=ToggleBatchTagCommand}"
                                                CommandParameter="{Binding .}" />
                                        </Border.GestureRecognizers>
                                        <Label
                                            FontSize="12"
                                            Text="{Binding NombreTag}"
                                            TextColor="White" />
                                    </Border>
                                </DataTemplate>
                            </BindableLayout.ItemTemplate>
                        </FlexLayout>
                        <Label
                            FontSize="12"
                            Text="No hay etiquetas disponibles"
                            TextColor="#FF666666">
                            <Label.Triggers>
                                <DataTrigger TargetType="Label" Binding="{Binding BatchEditTags.Count}" Value="0">
                                    <Setter Property="IsVisible" Value="True" />
                                </DataTrigger>
                            </Label.Triggers>
                            <Label.Style>
                                <Style TargetType="Label">
                                    <Setter Property="IsVisible" Value="False" />
                                </Style>
                            </Label.Style>
                        </Label>
                    </VerticalStackLayout>

                    <!--  Botones  -->
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="12" Margin="0,8,0,0">
                        <Button
                            BackgroundColor="#FF3A3A3A"
                            Command="{Binding CloseBatchEditPopupCommand}"
                            Text="Cancelar"
                            TextColor="White" />
                        <Button
                            Grid.Column="1"
                            BackgroundColor="#FF4A9FD4"
                            Command="{Binding ApplyBatchEditCommand}"
                            Text="Aplicar"
                            TextColor="White" />
                    </Grid>
                </VerticalStackLayout>
            </Border>
        </Grid>

        <!--  Footer de la aplicación  -->
        <controls:AppFooter
            Grid.Row="2"
            Grid.ColumnSpan="5" />
    </Grid>
</ContentPage>
