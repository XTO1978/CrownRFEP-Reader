<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:CrownRFEP_Reader.ViewModels"
             xmlns:models="clr-namespace:CrownRFEP_Reader.Models"
             x:Class="CrownRFEP_Reader.Views.DashboardPage"
             x:DataType="vm:DashboardViewModel"
             Title="{Binding Title}">

    <Grid RowDefinitions="Auto,*" Padding="20">
        
        <!-- Header con botÃ³n de importar -->
        <VerticalStackLayout Grid.Row="0" Spacing="15">
            <Label Text="CrownRFEP Reader" 
                   FontSize="28" 
                   FontAttributes="Bold" 
                   TextColor="{StaticResource Primary}"
                   HorizontalOptions="Center"/>
            
            <Button Text="ðŸ“‚ Importar archivo .crown"
                    Command="{Binding ImportCommand}"
                    IsEnabled="{Binding IsImporting, Converter={StaticResource InvertedBoolConverter}}"
                    BackgroundColor="{StaticResource Primary}"
                    TextColor="White"
                    FontSize="16"
                    Padding="20,12"
                    CornerRadius="8"
                    HorizontalOptions="Center"/>

            <!-- Barra de progreso de importaciÃ³n -->
            <VerticalStackLayout IsVisible="{Binding IsImporting}" Spacing="5">
                <Label Text="{Binding ImportProgressText}" 
                       HorizontalOptions="Center"
                       FontSize="14"/>
                <ProgressBar Progress="{Binding ImportProgressValue, Converter={StaticResource ProgressConverter}}"
                             ProgressColor="{StaticResource Primary}"
                             HeightRequest="8"/>
            </VerticalStackLayout>
        </VerticalStackLayout>

        <ScrollView Grid.Row="1" Margin="0,20,0,0">
            <VerticalStackLayout Spacing="20">
                
                <!-- Tarjetas de estadÃ­sticas -->
                <Label Text="Resumen" FontSize="20" FontAttributes="Bold"/>
                
                <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto" ColumnSpacing="15" RowSpacing="15">
                    
                    <!-- Total Sesiones -->
                    <Frame Grid.Row="0" Grid.Column="0" 
                           BackgroundColor="{StaticResource Primary}" 
                           CornerRadius="12" 
                           Padding="15"
                           HasShadow="True">
                        <VerticalStackLayout>
                            <Label Text="ðŸ“…" FontSize="24"/>
                            <Label Text="{Binding Stats.TotalSessions}" 
                                   FontSize="32" 
                                   FontAttributes="Bold" 
                                   TextColor="White"/>
                            <Label Text="Sesiones" TextColor="White" FontSize="14"/>
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Total Videos -->
                    <Frame Grid.Row="0" Grid.Column="1" 
                           BackgroundColor="#4CAF50" 
                           CornerRadius="12" 
                           Padding="15"
                           HasShadow="True">
                        <VerticalStackLayout>
                            <Label Text="ðŸŽ¬" FontSize="24"/>
                            <Label Text="{Binding Stats.TotalVideos}" 
                                   FontSize="32" 
                                   FontAttributes="Bold" 
                                   TextColor="White"/>
                            <Label Text="Videos" TextColor="White" FontSize="14"/>
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Total Atletas -->
                    <Frame Grid.Row="1" Grid.Column="0" 
                           BackgroundColor="#FF9800" 
                           CornerRadius="12" 
                           Padding="15"
                           HasShadow="True">
                        <VerticalStackLayout>
                            <Label Text="ðŸƒ" FontSize="24"/>
                            <Label Text="{Binding Stats.TotalAthletes}" 
                                   FontSize="32" 
                                   FontAttributes="Bold" 
                                   TextColor="White"/>
                            <Label Text="Atletas" TextColor="White" FontSize="14"/>
                        </VerticalStackLayout>
                    </Frame>

                    <!-- DuraciÃ³n Total -->
                    <Frame Grid.Row="1" Grid.Column="1" 
                           BackgroundColor="#9C27B0" 
                           CornerRadius="12" 
                           Padding="15"
                           HasShadow="True">
                        <VerticalStackLayout>
                            <Label Text="â±ï¸" FontSize="24"/>
                            <Label Text="{Binding Stats.TotalDurationFormatted}" 
                                   FontSize="24" 
                                   FontAttributes="Bold" 
                                   TextColor="White"/>
                            <Label Text="DuraciÃ³n total" TextColor="White" FontSize="14"/>
                        </VerticalStackLayout>
                    </Frame>
                </Grid>

                <!-- Sesiones recientes -->
                <Grid ColumnDefinitions="*,Auto">
                    <Label Text="Sesiones Recientes" FontSize="20" FontAttributes="Bold"/>
                    <Button Grid.Column="1" 
                            Text="Ver todas â†’" 
                            Command="{Binding ViewAllSessionsCommand}"
                            BackgroundColor="Transparent"
                            TextColor="{StaticResource Primary}"
                            FontSize="14"/>
                </Grid>

                <CollectionView ItemsSource="{Binding RecentSessions}"
                                SelectionMode="Single"
                                SelectionChangedCommand="{Binding ViewSessionCommand}"
                                SelectionChangedCommandParameter="{Binding SelectedItem, Source={RelativeSource Self}}">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:Session">
                            <Frame Margin="0,0,0,10" Padding="15" CornerRadius="10" HasShadow="True">
                                <Grid ColumnDefinitions="*,Auto">
                                    <VerticalStackLayout>
                                        <Label Text="{Binding DisplayName}" 
                                               FontSize="16" 
                                               FontAttributes="Bold"/>
                                        <Label Text="{Binding Lugar}" 
                                               FontSize="14" 
                                               TextColor="Gray"/>
                                        <Label FontSize="12" TextColor="Gray">
                                            <Label.FormattedText>
                                                <FormattedString>
                                                    <Span Text="{Binding FechaDateTime, StringFormat='{0:dd/MM/yyyy}'}" />
                                                    <Span Text=" â€¢ " />
                                                    <Span Text="{Binding VideoCount}" />
                                                    <Span Text=" videos" />
                                                </FormattedString>
                                            </Label.FormattedText>
                                        </Label>
                                    </VerticalStackLayout>
                                    <Label Grid.Column="1" 
                                           Text="â†’" 
                                           FontSize="20" 
                                           VerticalOptions="Center"
                                           TextColor="Gray"/>
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                    <CollectionView.EmptyView>
                        <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center" Padding="40">
                            <Label Text="ðŸ“­" FontSize="48" HorizontalOptions="Center"/>
                            <Label Text="No hay sesiones" 
                                   FontSize="18" 
                                   HorizontalOptions="Center" 
                                   TextColor="Gray"/>
                            <Label Text="Importa un archivo .crown para comenzar" 
                                   FontSize="14" 
                                   HorizontalOptions="Center" 
                                   TextColor="Gray"/>
                        </VerticalStackLayout>
                    </CollectionView.EmptyView>
                </CollectionView>

            </VerticalStackLayout>
        </ScrollView>

        <!-- Indicador de carga -->
        <ActivityIndicator Grid.RowSpan="2" 
                           IsRunning="{Binding IsBusy}" 
                           IsVisible="{Binding IsBusy}"
                           Color="{StaticResource Primary}"
                           VerticalOptions="Center"
                           HorizontalOptions="Center"/>
    </Grid>
</ContentPage>
