<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="CrownRFEP_Reader.Views.SinglePlayerPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:behaviors="clr-namespace:CrownRFEP_Reader.Behaviors"
    xmlns:controls="clr-namespace:CrownRFEP_Reader.Views.Controls"
    xmlns:converters="clr-namespace:CrownRFEP_Reader.Converters"
    xmlns:models="clr-namespace:CrownRFEP_Reader.Models"
    xmlns:precision="clr-namespace:CrownRFEP_Reader.Controls"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:vm="clr-namespace:CrownRFEP_Reader.ViewModels"
    Title="{Binding VideoTitle}"
    x:DataType="vm:SinglePlayerViewModel"
    BackgroundColor="#FF121212"
    Shell.BackgroundColor="#FF121212"
    Shell.ForegroundColor="White"
    Shell.NavBarIsVisible="True"
    Shell.TitleColor="White">

    <ContentPage.Resources>
        <toolkit:InvertedBoolConverter x:Key="InvertedBoolConverter" />
        <converters:BoolToOpacityConverter x:Key="BoolToOpacityConverter" />
        <converters:TagSelectedColorConverter x:Key="TagSelectedColorConverter" />
        <converters:EventTagSelectedColorConverter x:Key="EventTagSelectedColorConverter" />
        <converters:NormalizedPositionToRectConverter x:Key="NormalizedPositionToRectConverter" />
        <converters:NormalizedPositionToTickRectConverter x:Key="NormalizedPositionToTickRectConverter" />
        <converters:BoolToColorConverter x:Key="BoolToAthleteBackgroundConverter" />
        <converters:BoolToColorConverter x:Key="BoolToTagEventBackgroundConverter" />
    </ContentPage.Resources>

    <Grid x:Name="RootGrid" Padding="0" RowDefinitions="*,Auto,Auto">

        <!--  Área del vídeo  -->
        <Border
            Grid.Row="0"
            Margin="0,0,0,0"
            BackgroundColor="#FF121212"
            Stroke="#FF3A3A3A"
            StrokeShape="RoundRectangle 8"
            StrokeThickness="0">
            <Grid>
                <precision:PrecisionVideoPlayer
                    x:Name="MediaPlayer"
                    Aspect="AspectFill"
                    IsMuted="False"
                    Source="{Binding VideoPath}" />
                
                <!--  Overlay transparente para capturar gestos de scrubbing (trackpad/mouse wheel)  -->
                <BoxView
                    x:Name="ScrubOverlay"
                    BackgroundColor="Transparent"
                    InputTransparent="False">
                    <BoxView.Behaviors>
                        <behaviors:VideoScrubBehavior VideoIndex="0" />
                    </BoxView.Behaviors>
                </BoxView>

                <!-- Overlay de dibujo para análisis técnico (solo interactivo cuando el modo dibujo está activo) -->
                <controls:AnalysisDrawingView
                    x:Name="AnalysisCanvas"
                    InputTransparent="True" />
                
                <!--  Overlay de información del video  -->
                <Border
                    Margin="16"
                    Padding="12,10"
                    BackgroundColor="#CC000000"
                    HorizontalOptions="Start"
                    IsVisible="{Binding ShowOverlay}"
                    StrokeShape="RoundRectangle 8"
                    StrokeThickness="0"
                    VerticalOptions="Start">
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding ToggleOverlayCommand}" />
                    </Border.GestureRecognizers>
                    <VerticalStackLayout Spacing="4">
                        <!--  Nombre del atleta  -->
                        <Label
                            FontAttributes="Bold"
                            FontSize="16"
                            Text="{Binding AthleteName}"
                            TextColor="White" />
                        
                        <!--  Sesión  -->
                        <HorizontalStackLayout Spacing="8">
                            <Label
                                FontSize="12"
                                Text="{Binding SessionName}"
                                TextColor="#FFAAAAAA" />
                            <Label
                                FontSize="12"
                                Text="•"
                                TextColor="#FF666666" />
                            <Label
                                FontSize="12"
                                Text="{Binding SessionPlace}"
                                TextColor="#FFAAAAAA" />
                        </HorizontalStackLayout>
                        
                        <!--  Fecha y sección  -->
                        <HorizontalStackLayout Spacing="8">
                            <Label
                                FontSize="11"
                                Text="{Binding SessionDate}"
                                TextColor="#FF888888" />
                            <Label
                                FontSize="11"
                                Text="•"
                                TextColor="#FF666666" />
                            <Label
                                FontSize="11"
                                Text="{Binding SectionText}"
                                TextColor="#FF888888" />
                        </HorizontalStackLayout>
                        
                        <!--  Duración y tamaño  -->
                        <HorizontalStackLayout Spacing="8">
                            <Label
                                FontSize="10"
                                Text="{Binding VideoDurationText, StringFormat='Duración: {0}'}"
                                TextColor="#FF666666" />
                            <Label
                                FontSize="10"
                                Text="{Binding VideoSizeText, StringFormat='({0})'}"
                                TextColor="#FF666666" />
                        </HorizontalStackLayout>
                        
                        <!--  Etiquetas asignadas (chips verdes con X)  -->
                        <VerticalStackLayout IsVisible="{Binding HasTags}" Spacing="2">
                            <Label
                                FontSize="9"
                                Text="ETIQUETAS"
                                TextColor="#FF666666" />
                            <FlexLayout
                                BindableLayout.ItemsSource="{Binding VideoClipTags}"
                                Wrap="Wrap"
                                Direction="Row"
                                JustifyContent="Start"
                                AlignItems="Start">
                                <BindableLayout.ItemTemplate>
                                    <DataTemplate x:DataType="models:Tag">
                                        <Border
                                            Margin="0,2,6,2"
                                            Padding="6,3,4,3"
                                            BackgroundColor="#FF66BB6A"
                                            StrokeShape="RoundRectangle 10"
                                            StrokeThickness="0">
                                            <HorizontalStackLayout Spacing="4">
                                                <controls:SymbolIcon
                                                    HeightRequest="10"
                                                    SymbolName="tag.fill"
                                                    TintColor="White"
                                                    VerticalOptions="Center"
                                                    WidthRequest="10" />
                                                <Label
                                                    FontSize="10"
                                                    Text="{Binding NombreTag}"
                                                    TextColor="White"
                                                    VerticalOptions="Center" />
                                                <Border
                                                    Padding="3"
                                                    BackgroundColor="#33000000"
                                                    StrokeShape="RoundRectangle 8"
                                                    StrokeThickness="0"
                                                    VerticalOptions="Center">
                                                    <Border.GestureRecognizers>
                                                        <TapGestureRecognizer 
                                                            Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.RemoveAssignedTagCommand}"
                                                            CommandParameter="{Binding .}" />
                                                    </Border.GestureRecognizers>
                                                    <controls:SymbolIcon
                                                        HeightRequest="8"
                                                        SymbolName="xmark"
                                                        TintColor="White"
                                                        WidthRequest="8" />
                                                </Border>
                                            </HorizontalStackLayout>
                                        </Border>
                                    </DataTemplate>
                                </BindableLayout.ItemTemplate>
                            </FlexLayout>
                        </VerticalStackLayout>
                        
                        <!--  Eventos (chips naranjas con X)  -->
                        <VerticalStackLayout IsVisible="{Binding HasEventTags}" Spacing="2">
                            <Label
                                FontSize="9"
                                Text="EVENTOS"
                                TextColor="#FF666666" />
                            <FlexLayout
                                BindableLayout.ItemsSource="{Binding VideoClipEventTags}"
                                Wrap="Wrap"
                                Direction="Row"
                                JustifyContent="Start"
                                AlignItems="Start">
                                <BindableLayout.ItemTemplate>
                                    <DataTemplate x:DataType="models:Tag">
                                        <Border
                                            Margin="0,2,6,2"
                                            Padding="6,3,4,3"
                                            BackgroundColor="#FFFF7043"
                                            StrokeShape="RoundRectangle 10"
                                            StrokeThickness="0">
                                            <HorizontalStackLayout Spacing="4">
                                                <controls:SymbolIcon
                                                    HeightRequest="10"
                                                    SymbolName="clock.badge.checkmark"
                                                    TintColor="White"
                                                    VerticalOptions="Center"
                                                    WidthRequest="10" />
                                                <Label
                                                    FontSize="10"
                                                    Text="{Binding NombreTag}"
                                                    TextColor="White"
                                                    VerticalOptions="Center" />
                                                <Border
                                                    Padding="3"
                                                    BackgroundColor="#33000000"
                                                    StrokeShape="RoundRectangle 8"
                                                    StrokeThickness="0"
                                                    VerticalOptions="Center">
                                                    <Border.GestureRecognizers>
                                                        <TapGestureRecognizer 
                                                            Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.RemoveEventTagCommand}"
                                                            CommandParameter="{Binding .}" />
                                                    </Border.GestureRecognizers>
                                                    <controls:SymbolIcon
                                                        HeightRequest="8"
                                                        SymbolName="xmark"
                                                        TintColor="White"
                                                        WidthRequest="8" />
                                                </Border>
                                            </HorizontalStackLayout>
                                        </Border>
                                    </DataTemplate>
                                </BindableLayout.ItemTemplate>
                            </FlexLayout>
                        </VerticalStackLayout>
                        
                        <!--  Badge si existe  -->
                        <Border
                            Margin="0,4,0,0"
                            Padding="8,4"
                            BackgroundColor="{Binding BadgeColor}"
                            IsVisible="{Binding HasBadge}"
                            StrokeShape="RoundRectangle 4"
                            StrokeThickness="0">
                            <Label
                                FontSize="11"
                                Text="{Binding BadgeText}"
                                TextColor="White" />
                        </Border>
                        
                        <!--  Lista de eventos con timestamp  -->
                        <VerticalStackLayout IsVisible="{Binding HasTagEvents}" Spacing="4" Margin="0,8,0,0">
                            <Label
                                FontSize="9"
                                Text="EVENTOS MARCADOS"
                                TextColor="#FF666666" />
                            <VerticalStackLayout
                                BindableLayout.ItemsSource="{Binding TagEvents}"
                                Spacing="4">
                                <BindableLayout.ItemTemplate>
                                    <DataTemplate x:DataType="models:TagEvent">
                                        <Border
                                            Padding="6,4"
                                            BackgroundColor="#FF2A2A2A"
                                            StrokeShape="RoundRectangle 4"
                                            StrokeThickness="0">
                                            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="6">
                                                <!--  Timestamp clickable  -->
                                                <Border
                                                    Grid.Column="0"
                                                    Padding="5,2"
                                                    BackgroundColor="#FF3A3A3A"
                                                    StrokeShape="RoundRectangle 3"
                                                    StrokeThickness="0">
                                                    <Border.GestureRecognizers>
                                                        <TapGestureRecognizer 
                                                            Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SeekToTagEventCommand}"
                                                            CommandParameter="{Binding .}" />
                                                    </Border.GestureRecognizers>
                                                    <HorizontalStackLayout Spacing="3">
                                                        <controls:SymbolIcon
                                                            HeightRequest="9"
                                                            SymbolName="play.fill"
                                                            TintColor="#FF6DDDFF"
                                                            WidthRequest="9" />
                                                        <Label
                                                            Text="{Binding TimestampFormatted}"
                                                            FontSize="10"
                                                            FontAttributes="Bold"
                                                            TextColor="#FF6DDDFF" />
                                                    </HorizontalStackLayout>
                                                </Border>
                                                
                                                <!--  Nombre del tag (naranja para eventos)  -->
                                                <Border
                                                    Grid.Column="1"
                                                    Padding="6,2"
                                                    BackgroundColor="#FFFF7043"
                                                    StrokeShape="RoundRectangle 8"
                                                    StrokeThickness="0"
                                                    HorizontalOptions="Start">
                                                    <Label
                                                        Text="{Binding TagName}"
                                                        FontSize="9"
                                                        TextColor="White" />
                                                </Border>
                                                
                                                <!--  Botón eliminar  -->
                                                <Border
                                                    Grid.Column="2"
                                                    Padding="4"
                                                    BackgroundColor="#44FF5555"
                                                    StrokeShape="RoundRectangle 3"
                                                    StrokeThickness="0">
                                                    <Border.GestureRecognizers>
                                                        <TapGestureRecognizer 
                                                            Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeleteTagEventCommand}"
                                                            CommandParameter="{Binding .}" />
                                                    </Border.GestureRecognizers>
                                                    <controls:SymbolIcon
                                                        HeightRequest="8"
                                                        SymbolName="trash.fill"
                                                        TintColor="#FFFF6B6B"
                                                        WidthRequest="8" />
                                                </Border>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </BindableLayout.ItemTemplate>
                            </VerticalStackLayout>
                        </VerticalStackLayout>
                    </VerticalStackLayout>
                </Border>
                
                <!--  Barra de botones de edición (esquina superior derecha)  -->
                <Border
                    Margin="16"
                    Padding="8"
                    BackgroundColor="#CC000000"
                    HorizontalOptions="End"
                    StrokeShape="RoundRectangle 8"
                    StrokeThickness="0"
                    VerticalOptions="Start">
                    <HorizontalStackLayout Spacing="4">

                        <!-- Videolección (toggle start/stop) - separado del resto -->
                        <Border
                            x:Name="VideoLessonRecordButton"
                            WidthRequest="44"
                            HeightRequest="44"
                            Padding="0"
                            BackgroundColor="#FF2A2A2A"
                            StrokeShape="RoundRectangle 22"
                            StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnToggleVideoLessonTapped" />
                            </Border.GestureRecognizers>
                            <Grid>
                                <controls:SymbolIcon
                                    x:Name="VideoLessonRecordIcon"
                                    WidthRequest="18"
                                    HeightRequest="18"
                                    SymbolName="record.circle"
                                    TintColor="White"
                                    HorizontalOptions="Center"
                                    VerticalOptions="Center" />
                            </Grid>
                        </Border>

                        <!-- Opciones Videolección (cámara / micrófono) -->
                        <Border
                            x:Name="VideoLessonOptionsPanel"
                            Margin="6,0,0,0"
                            Padding="6"
                            BackgroundColor="#EE1E1E1E"
                            IsVisible="False"
                            StrokeShape="RoundRectangle 10"
                            StrokeThickness="0"
                            VerticalOptions="Center">
                            <HorizontalStackLayout Spacing="6">
                                <Border
                                    x:Name="VideoLessonCameraToggle"
                                    WidthRequest="34"
                                    HeightRequest="34"
                                    Padding="0"
                                    BackgroundColor="#FF2A2A2A"
                                    StrokeShape="RoundRectangle 17"
                                    StrokeThickness="0">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Tapped="OnVideoLessonCameraToggleTapped" />
                                    </Border.GestureRecognizers>
                                    <Grid>
                                        <controls:SymbolIcon
                                            x:Name="VideoLessonCameraToggleIcon"
                                            WidthRequest="16"
                                            HeightRequest="16"
                                            SymbolName="video.fill"
                                            TintColor="White"
                                            HorizontalOptions="Center"
                                            VerticalOptions="Center" />
                                    </Grid>
                                </Border>

                                <Border
                                    x:Name="VideoLessonMicToggle"
                                    WidthRequest="34"
                                    HeightRequest="34"
                                    Padding="0"
                                    BackgroundColor="#FF2A2A2A"
                                    StrokeShape="RoundRectangle 17"
                                    StrokeThickness="0">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Tapped="OnVideoLessonMicToggleTapped" />
                                    </Border.GestureRecognizers>
                                    <Grid>
                                        <controls:SymbolIcon
                                            x:Name="VideoLessonMicToggleIcon"
                                            WidthRequest="16"
                                            HeightRequest="16"
                                            SymbolName="mic.fill"
                                            TintColor="White"
                                            HorizontalOptions="Center"
                                            VerticalOptions="Center" />
                                    </Grid>
                                </Border>
                            </HorizontalStackLayout>
                        </Border>

                        <BoxView WidthRequest="1" BackgroundColor="#FF555555" Margin="6,4" />

                        <!--  Botón Asignar Atleta  -->
                        <Border
                            Padding="8,6"
                            BackgroundColor="Transparent"
                            StrokeShape="RoundRectangle 6"
                            StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ToggleAthleteAssignPanelCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="6">
                                <controls:SymbolIcon
                                    HeightRequest="16"
                                    SymbolName="person.badge.plus"
                                    TintColor="#FF6DDDFF"
                                    WidthRequest="16" />
                                <Label
                                    FontSize="11"
                                    Text="Atleta"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>
                        
                        <BoxView WidthRequest="1" BackgroundColor="#FF555555" Margin="4,4" />
                        
                        <!--  Botón Asignar Sección  -->
                        <Border
                            Padding="8,6"
                            BackgroundColor="Transparent"
                            StrokeShape="RoundRectangle 6"
                            StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ToggleSectionAssignPanelCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="6">
                                <controls:SymbolIcon
                                    HeightRequest="16"
                                    SymbolName="arrow.triangle.branch"
                                    TintColor="#FFFFA726"
                                    WidthRequest="16" />
                                <Label
                                    FontSize="11"
                                    Text="Tramo"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>
                        
                        <BoxView WidthRequest="1" BackgroundColor="#FF555555" Margin="4,4" />
                        
                        <!--  Botón Asignar Etiquetas  -->
                        <Border
                            Padding="8,6"
                            BackgroundColor="Transparent"
                            StrokeShape="RoundRectangle 6"
                            StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ToggleTagsAssignPanelCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="6">
                                <controls:SymbolIcon
                                    HeightRequest="16"
                                    SymbolName="tag.fill"
                                    TintColor="#FF6DDDFF"
                                    WidthRequest="16" />
                                <Label
                                    FontSize="12"
                                    Text="Etiquetas"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>
                        
                        <BoxView WidthRequest="1" BackgroundColor="#FF555555" Margin="4,4" />
                        
                        <!--  Botón Eventos (etiquetas con timestamps)  -->
                        <Border
                            Padding="8,6"
                            BackgroundColor="Transparent"
                            StrokeShape="RoundRectangle 6"
                            StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ToggleTagEventsPanelCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="6">
                                <controls:SymbolIcon
                                    HeightRequest="16"
                                    SymbolName="clock.badge.checkmark"
                                    TintColor="#FFFF7043"
                                    WidthRequest="16" />
                                <Label
                                    FontSize="11"
                                    Text="Eventos"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>

                        <BoxView WidthRequest="1" BackgroundColor="#FF555555" Margin="4,4" />

                        <!-- Botón Dibujo -->
                        <Border
                            Padding="8,6"
                            BackgroundColor="Transparent"
                            StrokeShape="RoundRectangle 6"
                            StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnToggleDrawingToolsTapped" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="6">
                                <controls:SymbolIcon
                                    HeightRequest="16"
                                    SymbolName="pencil"
                                    TintColor="#FFFF7043"
                                    WidthRequest="16" />
                                <Label
                                    FontSize="11"
                                    Text="Dibujar"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>

                    </HorizontalStackLayout>
                </Border>

                <!-- Barra de herramientas de dibujo (pequeña) -->
                <Border
                    x:Name="DrawingToolsPanel"
                    Margin="16,60,16,16"
                    Padding="10"
                    BackgroundColor="#EE1E1E1E"
                    HorizontalOptions="End"
                    IsVisible="False"
                    StrokeShape="RoundRectangle 12"
                    StrokeThickness="0"
                    VerticalOptions="Start">
                    <VerticalStackLayout Spacing="8">
                        <HorizontalStackLayout Spacing="8">
                            <Border
                                x:Name="ToolStrokeButton"
                                Padding="10,6"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnSelectStrokeToolTapped" />
                                </Border.GestureRecognizers>
                                <controls:SymbolIcon
                                    HeightRequest="16"
                                    WidthRequest="16"
                                    SymbolName="scribble"
                                    TintColor="White" />
                            </Border>

                            <Border
                                x:Name="ToolTextButton"
                                Padding="10,6"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnSelectTextToolTapped" />
                                </Border.GestureRecognizers>
                                <controls:SymbolIcon
                                    HeightRequest="16"
                                    WidthRequest="16"
                                    SymbolName="textformat"
                                    TintColor="White" />
                            </Border>

                            <Border
                                x:Name="ToolShapeButton"
                                Padding="10,6"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnSelectShapeToolTapped" />
                                </Border.GestureRecognizers>
                                <controls:SymbolIcon
                                    HeightRequest="16"
                                    WidthRequest="16"
                                    SymbolName="square.on.circle"
                                    TintColor="White" />
                            </Border>

                            <!-- Botón para desplegar opciones de tinta -->
                            <Border
                                x:Name="InkOptionsToggleButton"
                                Padding="10,6"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnToggleInkOptionsTapped" />
                                </Border.GestureRecognizers>
                                <HorizontalStackLayout Spacing="6" VerticalOptions="Center">
                                    <controls:SymbolIcon
                                        HeightRequest="16"
                                        WidthRequest="16"
                                        SymbolName="paintpalette"
                                        TintColor="White" />
                                    <Border
                                        x:Name="InkColorSwatch"
                                        HeightRequest="12"
                                        WidthRequest="12"
                                        BackgroundColor="#FFFF7043"
                                        StrokeShape="RoundRectangle 6"
                                        StrokeThickness="0"
                                        VerticalOptions="Center" />
                                </HorizontalStackLayout>
                            </Border>
                        </HorizontalStackLayout>

                        <!-- Opciones de tinta (panel expandible) -->
                        <Border
                            x:Name="InkOptionsPanel"
                            IsVisible="False"
                            Padding="8"
                            BackgroundColor="#FF2A2A2A"
                            StrokeShape="RoundRectangle 8"
                            StrokeThickness="0">
                            <VerticalStackLayout Spacing="8">
                                <HorizontalStackLayout x:Name="InkColorsRow" Spacing="8">
                                    <Border
                                        x:Name="InkColorOrangeButton"
                                        Padding="6"
                                        BackgroundColor="#FF2A2A2A"
                                        StrokeShape="RoundRectangle 6"
                                        StrokeThickness="0">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="OnSelectInkOrangeTapped" />
                                        </Border.GestureRecognizers>
                                        <Border
                                            HeightRequest="16"
                                            WidthRequest="16"
                                            BackgroundColor="#FFFF7043"
                                            StrokeShape="RoundRectangle 8"
                                            StrokeThickness="0" />
                                    </Border>

                                    <Border
                                        x:Name="InkColorWhiteButton"
                                        Padding="6"
                                        BackgroundColor="#FF2A2A2A"
                                        StrokeShape="RoundRectangle 6"
                                        StrokeThickness="0">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="OnSelectInkWhiteTapped" />
                                        </Border.GestureRecognizers>
                                        <Border
                                            HeightRequest="16"
                                            WidthRequest="16"
                                            BackgroundColor="White"
                                            StrokeShape="RoundRectangle 8"
                                            StrokeThickness="0" />
                                    </Border>

                                    <Border
                                        x:Name="InkColorBlueButton"
                                        Padding="6"
                                        BackgroundColor="#FF2A2A2A"
                                        StrokeShape="RoundRectangle 6"
                                        StrokeThickness="0">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="OnSelectInkBlueTapped" />
                                        </Border.GestureRecognizers>
                                        <Border
                                            HeightRequest="16"
                                            WidthRequest="16"
                                            BackgroundColor="#FF6DDDFF"
                                            StrokeShape="RoundRectangle 8"
                                            StrokeThickness="0" />
                                    </Border>

                                    <Border
                                        x:Name="InkColorGreenButton"
                                        Padding="6"
                                        BackgroundColor="#FF2A2A2A"
                                        StrokeShape="RoundRectangle 6"
                                        StrokeThickness="0">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="OnSelectInkGreenTapped" />
                                        </Border.GestureRecognizers>
                                        <Border
                                            HeightRequest="16"
                                            WidthRequest="16"
                                            BackgroundColor="#FF66BB6A"
                                            StrokeShape="RoundRectangle 8"
                                            StrokeThickness="0" />
                                    </Border>
                                </HorizontalStackLayout>

                                <HorizontalStackLayout x:Name="InkThicknessRow" Spacing="8">
                                    <Border
                                        x:Name="InkThickness2Button"
                                        Padding="10,6"
                                        BackgroundColor="#FF2A2A2A"
                                        StrokeShape="RoundRectangle 6"
                                        StrokeThickness="0">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="OnSelectInkThickness2Tapped" />
                                        </Border.GestureRecognizers>
                                        <Border
                                            HeightRequest="2"
                                            WidthRequest="20"
                                            BackgroundColor="White"
                                            StrokeThickness="0"
                                            VerticalOptions="Center"
                                            HorizontalOptions="Center" />
                                    </Border>

                                    <Border
                                        x:Name="InkThickness4Button"
                                        Padding="10,6"
                                        BackgroundColor="#FF2A2A2A"
                                        StrokeShape="RoundRectangle 6"
                                        StrokeThickness="0">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="OnSelectInkThickness4Tapped" />
                                        </Border.GestureRecognizers>
                                        <Border
                                            HeightRequest="4"
                                            WidthRequest="20"
                                            BackgroundColor="White"
                                            StrokeThickness="0"
                                            VerticalOptions="Center"
                                            HorizontalOptions="Center" />
                                    </Border>

                                    <Border
                                        x:Name="InkThickness6Button"
                                        Padding="10,6"
                                        BackgroundColor="#FF2A2A2A"
                                        StrokeShape="RoundRectangle 6"
                                        StrokeThickness="0">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="OnSelectInkThickness6Tapped" />
                                        </Border.GestureRecognizers>
                                        <Border
                                            HeightRequest="6"
                                            WidthRequest="20"
                                            BackgroundColor="White"
                                            StrokeThickness="0"
                                            VerticalOptions="Center"
                                            HorizontalOptions="Center" />
                                    </Border>
                                </HorizontalStackLayout>

                                <HorizontalStackLayout x:Name="InkTextSizeRow" Spacing="8">
                                    <Border
                                        x:Name="TextSizeSmallButton"
                                        Padding="10,6"
                                        BackgroundColor="#FF2A2A2A"
                                        StrokeShape="RoundRectangle 6"
                                        StrokeThickness="0">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="OnSelectTextSizeSmallTapped" />
                                        </Border.GestureRecognizers>
                                        <Label Text="A" FontSize="12" TextColor="White" HorizontalOptions="Center" VerticalOptions="Center" />
                                    </Border>

                                    <Border
                                        x:Name="TextSizeMediumButton"
                                        Padding="10,6"
                                        BackgroundColor="#FF2A2A2A"
                                        StrokeShape="RoundRectangle 6"
                                        StrokeThickness="0">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="OnSelectTextSizeMediumTapped" />
                                        </Border.GestureRecognizers>
                                        <Label Text="A" FontSize="16" TextColor="White" HorizontalOptions="Center" VerticalOptions="Center" />
                                    </Border>

                                    <Border
                                        x:Name="TextSizeLargeButton"
                                        Padding="10,6"
                                        BackgroundColor="#FF2A2A2A"
                                        StrokeShape="RoundRectangle 6"
                                        StrokeThickness="0">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="OnSelectTextSizeLargeTapped" />
                                        </Border.GestureRecognizers>
                                        <Label Text="A" FontSize="22" TextColor="White" HorizontalOptions="Center" VerticalOptions="Center" />
                                    </Border>
                                </HorizontalStackLayout>
                            </VerticalStackLayout>
                        </Border>

                        <HorizontalStackLayout x:Name="ShapeOptionsRow" IsVisible="False" Spacing="8">
                            <Border
                                x:Name="ShapeRectButton"
                                Padding="10,6"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnSelectShapeRectTapped" />
                                </Border.GestureRecognizers>
                                <controls:SymbolIcon
                                    HeightRequest="16"
                                    WidthRequest="16"
                                    SymbolName="rectangle"
                                    TintColor="White" />
                            </Border>

                            <Border
                                x:Name="ShapeCircleButton"
                                Padding="10,6"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnSelectShapeCircleTapped" />
                                </Border.GestureRecognizers>
                                <controls:SymbolIcon
                                    HeightRequest="16"
                                    WidthRequest="16"
                                    SymbolName="circle"
                                    TintColor="White" />
                            </Border>

                            <Border
                                x:Name="ShapeLineButton"
                                Padding="10,6"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnSelectShapeLineTapped" />
                                </Border.GestureRecognizers>
                                <controls:SymbolIcon
                                    HeightRequest="16"
                                    WidthRequest="16"
                                    SymbolName="line.diagonal"
                                    TintColor="White" />
                            </Border>

                            <Border
                                x:Name="ShapeArrowButton"
                                Padding="10,6"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnSelectShapeArrowTapped" />
                                </Border.GestureRecognizers>
                                <controls:SymbolIcon
                                    HeightRequest="16"
                                    WidthRequest="16"
                                    SymbolName="arrow.right"
                                    TintColor="White" />
                            </Border>
                        </HorizontalStackLayout>

                        <Border
                            x:Name="ToolClearButton"
                            Padding="10,6"
                            BackgroundColor="#FF2A2A2A"
                            StrokeShape="RoundRectangle 6"
                            StrokeThickness="0"
                            HorizontalOptions="Fill">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnClearDrawingTapped" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="8" HorizontalOptions="Center">
                                <controls:SymbolIcon
                                    HeightRequest="16"
                                    WidthRequest="16"
                                    SymbolName="trash"
                                    TintColor="White" />
                                <Label Text="Borrar" FontSize="12" TextColor="White" VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>
                    </VerticalStackLayout>
                </Border>
                
                <!--  Panel de asignación de atleta  -->
                <Border
                    Margin="16,60,16,16"
                    Padding="16"
                    BackgroundColor="#EE1E1E1E"
                    HorizontalOptions="End"
                    IsVisible="{Binding ShowAthleteAssignPanel}"
                    StrokeShape="RoundRectangle 12"
                    StrokeThickness="0"
                    VerticalOptions="Start"
                    WidthRequest="320">
                    <VerticalStackLayout Spacing="16">
                        <!--  Título del panel  -->
                        <Grid ColumnDefinitions="*,Auto">
                            <Label
                                FontAttributes="Bold"
                                FontSize="16"
                                Text="Asignar atleta al video"
                                TextColor="White" />
                            <Border
                                Grid.Column="1"
                                Padding="4"
                                BackgroundColor="Transparent"
                                StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ToggleAthleteAssignPanelCommand}" />
                                </Border.GestureRecognizers>
                                <controls:SymbolIcon
                                    HeightRequest="16"
                                    SymbolName="xmark.circle.fill"
                                    TintColor="#FF888888"
                                    WidthRequest="16" />
                            </Border>
                        </Grid>
                        
                        <!--  Atleta actual  -->
                        <HorizontalStackLayout Spacing="8">
                            <Label
                                FontSize="12"
                                Text="Atleta actual:"
                                TextColor="#FF888888" />
                            <Label
                                FontSize="12"
                                FontAttributes="Bold"
                                Text="{Binding CurrentAthleteText}"
                                TextColor="#FFAAAAAA" />
                        </HorizontalStackLayout>
                        
                        <!--  Separador  -->
                        <BoxView
                            HeightRequest="1"
                            BackgroundColor="#FF3A3A3A" />
                        
                        <!--  Seleccionar atleta existente  -->
                        <Label
                            FontSize="13"
                            Text="Seleccionar atleta existente:"
                            TextColor="#FFCCCCCC" />
                        
                        <Border
                            Padding="8,4"
                            BackgroundColor="#FF2A2A2A"
                            StrokeShape="RoundRectangle 6"
                            StrokeThickness="0">
                            <ScrollView HeightRequest="160" BackgroundColor="Transparent">
                                <VerticalStackLayout
                                    BindableLayout.ItemsSource="{Binding AllAthletes}"
                                    Spacing="4">
                                    <BindableLayout.EmptyView>
                                        <Label
                                            Text="No hay atletas disponibles"
                                            FontSize="12"
                                            TextColor="#FF666666"
                                            HorizontalOptions="Center"
                                            Margin="0,20" />
                                    </BindableLayout.EmptyView>
                                    <BindableLayout.ItemTemplate>
                                        <DataTemplate x:DataType="models:Athlete">
                                            <Border
                                                Padding="10,8"
                                                BackgroundColor="{Binding IsSelected, Converter={StaticResource BoolToAthleteBackgroundConverter}, ConverterParameter='#FF3A6A8A|#FF1A1A1A'}"
                                                StrokeShape="RoundRectangle 6"
                                                StrokeThickness="0"
                                                InputTransparent="False">
                                                <Border.GestureRecognizers>
                                                    <TapGestureRecognizer
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SelectAthleteToAssignCommand}"
                                                        CommandParameter="{Binding .}" />
                                                </Border.GestureRecognizers>
                                                <Label
                                                    Text="{Binding NombreCompleto}"
                                                    FontSize="13"
                                                    TextColor="White"
                                                    LineBreakMode="TailTruncation"
                                                    InputTransparent="True" />
                                            </Border>
                                        </DataTemplate>
                                    </BindableLayout.ItemTemplate>
                                </VerticalStackLayout>
                            </ScrollView>
                        </Border>
                        
                        <Button
                            Command="{Binding AssignAthleteCommand}"
                            Text="Asignar seleccionado"
                            BackgroundColor="#FF6DDDFF"
                            TextColor="Black"
                            FontSize="13"
                            CornerRadius="6"
                            HeightRequest="40" />
                        
                        <!--  Separador con texto  -->
                        <Grid ColumnDefinitions="*,Auto,*" Margin="0,8">
                            <BoxView
                                Grid.Column="0"
                                HeightRequest="1"
                                BackgroundColor="#FF3A3A3A"
                                VerticalOptions="Center" />
                            <Label
                                Grid.Column="1"
                                Text="o crear nuevo"
                                FontSize="11"
                                TextColor="#FF666666"
                                Margin="8,0" />
                            <BoxView
                                Grid.Column="2"
                                HeightRequest="1"
                                BackgroundColor="#FF3A3A3A"
                                VerticalOptions="Center" />
                        </Grid>
                        
                        <!--  Crear nuevo atleta  -->
                        <Grid ColumnDefinitions="*,*" ColumnSpacing="8">
                            <Border
                                Grid.Column="0"
                                Padding="8,4"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0">
                                <Entry
                                    Text="{Binding NewAthleteName}"
                                    Placeholder="Nombre"
                                    PlaceholderColor="#FF666666"
                                    TextColor="White"
                                    BackgroundColor="Transparent" />
                            </Border>
                            <Border
                                Grid.Column="1"
                                Padding="8,4"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0">
                                <Entry
                                    Text="{Binding NewAthleteSurname}"
                                    Placeholder="Apellido"
                                    PlaceholderColor="#FF666666"
                                    TextColor="White"
                                    BackgroundColor="Transparent" />
                            </Border>
                        </Grid>
                        
                        <Button
                            Command="{Binding CreateAndAssignAthleteCommand}"
                            Text="Crear y asignar"
                            BackgroundColor="#FF6DDDFF"
                            TextColor="White"
                            FontSize="13"
                            CornerRadius="6"
                            HeightRequest="40" />
                    </VerticalStackLayout>
                </Border>
                
                <!--  Panel de asignación de sección/tramo  -->
                <Border
                    Margin="16,60,16,16"
                    Padding="16"
                    BackgroundColor="#EE1E1E1E"
                    HorizontalOptions="End"
                    IsVisible="{Binding ShowSectionAssignPanel}"
                    StrokeShape="RoundRectangle 12"
                    StrokeThickness="0"
                    VerticalOptions="Start"
                    WidthRequest="280">
                    <VerticalStackLayout Spacing="16">
                        <!--  Título del panel  -->
                        <Grid ColumnDefinitions="*,Auto">
                            <Label
                                FontAttributes="Bold"
                                FontSize="16"
                                Text="Asignar tramo/sección"
                                TextColor="White" />
                            <Border
                                Grid.Column="1"
                                Padding="4"
                                BackgroundColor="Transparent"
                                StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ToggleSectionAssignPanelCommand}" />
                                </Border.GestureRecognizers>
                                <controls:SymbolIcon
                                    HeightRequest="16"
                                    SymbolName="xmark.circle.fill"
                                    TintColor="#FF888888"
                                    WidthRequest="16" />
                            </Border>
                        </Grid>
                        
                        <!--  Sección actual  -->
                        <HorizontalStackLayout Spacing="8">
                            <Label
                                FontSize="12"
                                Text="Tramo actual:"
                                TextColor="#FF888888" />
                            <Label
                                FontSize="12"
                                FontAttributes="Bold"
                                Text="{Binding CurrentSectionText}"
                                TextColor="#FFAAAAAA" />
                        </HorizontalStackLayout>
                        
                        <BoxView HeightRequest="1" BackgroundColor="#FF3A3A3A" />
                        
                        <!--  Selector de sección  -->
                        <Label
                            FontSize="13"
                            Text="Seleccionar tramo:"
                            TextColor="#FFCCCCCC" />
                        
                        <Grid ColumnDefinitions="*,Auto,*" ColumnSpacing="12">
                            <Border
                                Grid.Column="0"
                                Padding="12,8"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding DecrementSectionCommand}" />
                                </Border.GestureRecognizers>
                                <Label
                                    Text="-"
                                    FontSize="18"
                                    FontAttributes="Bold"
                                    TextColor="White"
                                    HorizontalOptions="Center" />
                            </Border>
                            
                            <Label
                                Grid.Column="1"
                                Text="{Binding SectionToAssign, StringFormat='Tramo {0}'}"
                                FontSize="18"
                                FontAttributes="Bold"
                                TextColor="#FFFFA726"
                                VerticalOptions="Center"
                                HorizontalOptions="Center" />
                            
                            <Border
                                Grid.Column="2"
                                Padding="12,8"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding IncrementSectionCommand}" />
                                </Border.GestureRecognizers>
                                <Label
                                    Text="+"
                                    FontSize="18"
                                    FontAttributes="Bold"
                                    TextColor="White"
                                    HorizontalOptions="Center" />
                            </Border>
                        </Grid>
                        
                        <!--  Stepper alternativo  -->
                        <Stepper
                            x:Name="SectionStepper"
                            Minimum="1"
                            Maximum="99"
                            Increment="1"
                            Value="{Binding SectionToAssign}"
                            HorizontalOptions="Center" />
                        
                        <Button
                            Command="{Binding AssignSectionCommand}"
                            Text="Asignar tramo"
                            BackgroundColor="#FFFFA726"
                            TextColor="Black"
                            FontSize="13"
                            CornerRadius="6"
                            HeightRequest="40" />
                    </VerticalStackLayout>
                </Border>
                
                <!--  Panel de asignación de etiquetas  -->
                <Border
                    Margin="16,60,16,16"
                    Padding="16"
                    BackgroundColor="#EE1E1E1E"
                    HorizontalOptions="End"
                    IsVisible="{Binding ShowTagsAssignPanel}"
                    StrokeShape="RoundRectangle 12"
                    StrokeThickness="0"
                    VerticalOptions="Start"
                    WidthRequest="320">
                    <VerticalStackLayout Spacing="12">
                        <!--  Título del panel  -->
                        <Grid ColumnDefinitions="*,Auto">
                            <Label
                                FontAttributes="Bold"
                                FontSize="16"
                                Text="Asignar etiquetas"
                                TextColor="White" />
                            <Border
                                Grid.Column="1"
                                Padding="4"
                                BackgroundColor="Transparent"
                                StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ToggleTagsAssignPanelCommand}" />
                                </Border.GestureRecognizers>
                                <controls:SymbolIcon
                                    HeightRequest="16"
                                    SymbolName="xmark.circle.fill"
                                    TintColor="#FF888888"
                                    WidthRequest="16" />
                            </Border>
                        </Grid>
                        
                        <!--  Etiquetas actuales  -->
                        <HorizontalStackLayout Spacing="8">
                            <Label
                                FontSize="12"
                                Text="Etiquetas actuales:"
                                TextColor="#FF888888" />
                            <Label
                                FontSize="12"
                                FontAttributes="Bold"
                                Text="{Binding CurrentTagsText}"
                                TextColor="#FFAAAAAA"
                                LineBreakMode="TailTruncation"
                                MaximumWidthRequest="180" />
                        </HorizontalStackLayout>
                        
                        <BoxView HeightRequest="1" BackgroundColor="#FF3A3A3A" />
                        
                        <!--  Lista de tags disponibles  -->
                        <Label
                            FontSize="13"
                            Text="Seleccionar etiquetas:"
                            TextColor="#FFCCCCCC" />
                        
                        <ScrollView HeightRequest="150">
                            <FlexLayout
                                BindableLayout.ItemsSource="{Binding AllTags}"
                                Wrap="Wrap"
                                Direction="Row"
                                JustifyContent="Start"
                                AlignItems="Start">
                                <BindableLayout.ItemTemplate>
                                    <DataTemplate x:DataType="models:Tag">
                                        <Border
                                            Margin="0,0,8,8"
                                            Padding="8,6,4,6"
                                            BackgroundColor="{Binding IsSelected, Converter={StaticResource TagSelectedColorConverter}}"
                                            StrokeShape="RoundRectangle 12"
                                            StrokeThickness="0">
                                            <HorizontalStackLayout Spacing="4">
                                                <Label
                                                    Text="{Binding NombreTag}"
                                                    FontSize="12"
                                                    TextColor="White"
                                                    VerticalOptions="Center">
                                                    <Label.GestureRecognizers>
                                                        <TapGestureRecognizer 
                                                            Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ToggleTagSelectionCommand}"
                                                            CommandParameter="{Binding .}" />
                                                    </Label.GestureRecognizers>
                                                </Label>
                                                <Border
                                                    Padding="4"
                                                    BackgroundColor="#33000000"
                                                    StrokeShape="RoundRectangle 10"
                                                    StrokeThickness="0"
                                                    VerticalOptions="Center">
                                                    <Border.GestureRecognizers>
                                                        <TapGestureRecognizer 
                                                            Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeleteTagFromListCommand}"
                                                            CommandParameter="{Binding .}" />
                                                    </Border.GestureRecognizers>
                                                    <controls:SymbolIcon
                                                        HeightRequest="8"
                                                        SymbolName="xmark"
                                                        TintColor="White"
                                                        WidthRequest="8" />
                                                </Border>
                                            </HorizontalStackLayout>
                                        </Border>
                                    </DataTemplate>
                                </BindableLayout.ItemTemplate>
                            </FlexLayout>
                        </ScrollView>
                        
                        <!--  Separador  -->
                        <Grid ColumnDefinitions="*,Auto,*" Margin="0,4">
                            <BoxView Grid.Column="0" HeightRequest="1" BackgroundColor="#FF3A3A3A" VerticalOptions="Center" />
                            <Label Grid.Column="1" Text="o crear nueva" FontSize="11" TextColor="#FF666666" Margin="8,0" />
                            <BoxView Grid.Column="2" HeightRequest="1" BackgroundColor="#FF3A3A3A" VerticalOptions="Center" />
                        </Grid>
                        
                        <!--  Crear nueva etiqueta  -->
                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                            <Border
                                Grid.Column="0"
                                Padding="8,4"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0">
                                <Entry
                                    Text="{Binding NewTagName}"
                                    Placeholder="Nombre etiqueta"
                                    PlaceholderColor="#FF666666"
                                    TextColor="White"
                                    BackgroundColor="Transparent" />
                            </Border>
                            <Button
                                Grid.Column="1"
                                Command="{Binding CreateAndAddTagCommand}"
                                Text="+"
                                BackgroundColor="#FF66BB6A"
                                TextColor="White"
                                FontSize="16"
                                CornerRadius="6"
                                WidthRequest="44"
                                HeightRequest="40" />
                        </Grid>
                        
                        <Button
                            Command="{Binding SaveTagsCommand}"
                            Text="Guardar etiquetas"
                            BackgroundColor="#FF66BB6A"
                            TextColor="White"
                            FontSize="13"
                            CornerRadius="6"
                            HeightRequest="40" />
                    </VerticalStackLayout>
                </Border>
                
                <!--  Panel de eventos de etiquetas con timestamps  -->
                <Border
                    Margin="16,60,16,16"
                    Padding="16"
                    BackgroundColor="#EE1E1E1E"
                    HorizontalOptions="End"
                    IsVisible="{Binding ShowTagEventsPanel}"
                    StrokeShape="RoundRectangle 12"
                    StrokeThickness="0"
                    VerticalOptions="Start"
                    WidthRequest="380">
                    <VerticalStackLayout Spacing="12">
                        <!--  Título del panel  -->
                        <Grid ColumnDefinitions="*,Auto">
                            <HorizontalStackLayout Spacing="8">
                                <controls:SymbolIcon
                                    HeightRequest="18"
                                    SymbolName="clock.badge.checkmark"
                                    TintColor="#FFFF7043"
                                    WidthRequest="18" />
                                <Label
                                    FontAttributes="Bold"
                                    FontSize="16"
                                    Text="Eventos del video"
                                    TextColor="White" />
                            </HorizontalStackLayout>
                            <Border
                                Grid.Column="1"
                                Padding="4"
                                BackgroundColor="Transparent"
                                StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ToggleTagEventsPanelCommand}" />
                                </Border.GestureRecognizers>
                                <controls:SymbolIcon
                                    HeightRequest="16"
                                    SymbolName="xmark.circle.fill"
                                    TintColor="#FF888888"
                                    WidthRequest="16" />
                            </Border>
                        </Grid>
                        
                        <!--  Selector para añadir evento en posición actual  -->
                        <Border
                            Padding="12"
                            BackgroundColor="#FF2A2A2A"
                            StrokeShape="RoundRectangle 8"
                            StrokeThickness="0">
                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                                <VerticalStackLayout Grid.Column="0" Spacing="6">
                                    <Label
                                        FontSize="11"
                                        Text="Añadir evento en posición actual:"
                                        TextColor="#FF888888" />
                                    <ScrollView HeightRequest="140" BackgroundColor="Transparent">
                                        <FlexLayout
                                            BindableLayout.ItemsSource="{Binding AllEventTags}"
                                            Wrap="Wrap"
                                            Direction="Row"
                                            JustifyContent="Start"
                                            AlignItems="Start">
                                            <BindableLayout.EmptyView>
                                                <Label
                                                    Text="No hay etiquetas disponibles"
                                                    FontSize="12"
                                                    TextColor="#FF666666"
                                                    HorizontalOptions="Center"
                                                    Margin="0,20" />
                                            </BindableLayout.EmptyView>
                                            <BindableLayout.ItemTemplate>
                                                <DataTemplate x:DataType="models:EventTagDefinition">
                                                    <Border
                                                        Margin="0,0,8,8"
                                                        Padding="8,6,4,6"
                                                        BackgroundColor="{Binding IsSelected, Converter={StaticResource EventTagSelectedColorConverter}}"
                                                        StrokeShape="RoundRectangle 12"
                                                        StrokeThickness="0">
                                                        <Border.GestureRecognizers>
                                                            <TapGestureRecognizer
                                                                Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SelectTagToAddCommand}"
                                                                CommandParameter="{Binding .}" />
                                                        </Border.GestureRecognizers>
                                                        <HorizontalStackLayout Spacing="4">
                                                            <Label
                                                                Text="{Binding Nombre}"
                                                                FontSize="12"
                                                                TextColor="White"
                                                                VerticalOptions="Center" />
                                                            <Border
                                                                Padding="4"
                                                                BackgroundColor="#33000000"
                                                                StrokeShape="RoundRectangle 10"
                                                                StrokeThickness="0"
                                                                VerticalOptions="Center">
                                                                <Border.GestureRecognizers>
                                                                    <TapGestureRecognizer 
                                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeleteEventTagFromListCommand}"
                                                                        CommandParameter="{Binding .}" />
                                                                </Border.GestureRecognizers>
                                                                <controls:SymbolIcon
                                                                    HeightRequest="8"
                                                                    SymbolName="xmark"
                                                                    TintColor="White"
                                                                    WidthRequest="8" />
                                                            </Border>
                                                        </HorizontalStackLayout>
                                                    </Border>
                                                </DataTemplate>
                                            </BindableLayout.ItemTemplate>
                                        </FlexLayout>
                                    </ScrollView>
                                </VerticalStackLayout>
                                <Button
                                    Grid.Column="1"
                                    Command="{Binding AddTagEventCommand}"
                                    VerticalOptions="End"
                                    BackgroundColor="#FFFF7043"
                                    TextColor="White"
                                    FontSize="14"
                                    CornerRadius="6"
                                    WidthRequest="44"
                                    HeightRequest="40">
                                    <Button.ImageSource>
                                        <FontImageSource
                                            FontFamily="SymbolsFont"
                                            Glyph="+"
                                            Color="White"
                                            Size="20" />
                                    </Button.ImageSource>
                                </Button>
                            </Grid>
                        </Border>
                        
                        <!--  Separador "o crear nuevo"  -->
                        <Grid ColumnDefinitions="*,Auto,*" Margin="0,4">
                            <BoxView Grid.Column="0" HeightRequest="1" BackgroundColor="#FF3A3A3A" VerticalOptions="Center" />
                            <Label Grid.Column="1" Text="o crear nuevo" FontSize="11" TextColor="#FF666666" Margin="8,0" />
                            <BoxView Grid.Column="2" HeightRequest="1" BackgroundColor="#FF3A3A3A" VerticalOptions="Center" />
                        </Grid>
                        
                        <!--  Crear nuevo evento  -->
                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                            <Border
                                Grid.Column="0"
                                Padding="8,4"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0">
                                <Entry
                                    Text="{Binding NewEventName}"
                                    Placeholder="Nombre del evento"
                                    PlaceholderColor="#FF666666"
                                    TextColor="White"
                                    BackgroundColor="Transparent" />
                            </Border>
                            <Button
                                Grid.Column="1"
                                Command="{Binding CreateAndAddEventCommand}"
                                Text="+"
                                BackgroundColor="#FFFF7043"
                                TextColor="White"
                                FontSize="16"
                                CornerRadius="6"
                                WidthRequest="44"
                                HeightRequest="40" />
                        </Grid>
                        
                        <BoxView HeightRequest="1" BackgroundColor="#FF3A3A3A" />
                        
                        <!--  Lista de eventos  -->
                        <Label
                            FontSize="12"
                            Text="{Binding TagEventsCountText}"
                            TextColor="#FFAAAAAA" />
                        
                        <ScrollView HeightRequest="200">
                            <VerticalStackLayout
                                BindableLayout.ItemsSource="{Binding TagEvents}"
                                Spacing="6">
                                <BindableLayout.EmptyView>
                                    <Label
                                        Text="No hay eventos marcados"
                                        FontSize="12"
                                        TextColor="#FF666666"
                                        HorizontalOptions="Center"
                                        Margin="0,20" />
                                </BindableLayout.EmptyView>
                                <BindableLayout.ItemTemplate>
                                    <DataTemplate x:DataType="models:TagEvent">
                                        <Border
                                            Padding="10,8"
                                            BackgroundColor="#FF2A2A2A"
                                            StrokeShape="RoundRectangle 6"
                                            StrokeThickness="0">
                                            <Grid ColumnDefinitions="Auto,*,Auto,Auto" ColumnSpacing="10">
                                                <!--  Timestamp clickable  -->
                                                <Border
                                                    Grid.Column="0"
                                                    Padding="8,4"
                                                    BackgroundColor="#FF3A3A3A"
                                                    StrokeShape="RoundRectangle 4"
                                                    StrokeThickness="0">
                                                    <Border.GestureRecognizers>
                                                        <TapGestureRecognizer 
                                                            Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SeekToTagEventCommand}"
                                                            CommandParameter="{Binding .}" />
                                                    </Border.GestureRecognizers>
                                                    <HorizontalStackLayout Spacing="4">
                                                        <controls:SymbolIcon
                                                            HeightRequest="12"
                                                            SymbolName="play.fill"
                                                            TintColor="#FF6DDDFF"
                                                            WidthRequest="12" />
                                                        <Label
                                                            Text="{Binding TimestampFormatted}"
                                                            FontSize="12"
                                                            FontAttributes="Bold"
                                                            TextColor="#FF6DDDFF" />
                                                    </HorizontalStackLayout>
                                                </Border>
                                                
                                                <!--  Nombre del tag  -->
                                                <Border
                                                    Grid.Column="1"
                                                    Padding="8,4"
                                                    BackgroundColor="#FFFF7043"
                                                    StrokeShape="RoundRectangle 10"
                                                    StrokeThickness="0"
                                                    HorizontalOptions="Start">
                                                    <Label
                                                        Text="{Binding TagName}"
                                                        FontSize="11"
                                                        TextColor="White" />
                                                </Border>
                                                
                                                <!--  Spacer  -->
                                                <BoxView Grid.Column="2" WidthRequest="0" />
                                                
                                                <!--  Botón eliminar  -->
                                                <Border
                                                    Grid.Column="3"
                                                    Padding="6"
                                                    BackgroundColor="#00FF5555"
                                                    StrokeShape="RoundRectangle 4"
                                                    StrokeThickness="0">
                                                    <Border.GestureRecognizers>
                                                        <TapGestureRecognizer 
                                                            Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeleteTagEventCommand}"
                                                            CommandParameter="{Binding .}" />
                                                    </Border.GestureRecognizers>
                                                    <controls:SymbolIcon
                                                        HeightRequest="12"
                                                        SymbolName="trash"
                                                        TintColor="#FFFF5555"
                                                        WidthRequest="12" />
                                                </Border>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </BindableLayout.ItemTemplate>
                            </VerticalStackLayout>
                        </ScrollView>
                        
                        <!--  Nota informativa  -->
                        <HorizontalStackLayout Spacing="6" Opacity="0.7">
                            <controls:SymbolIcon
                                HeightRequest="12"
                                SymbolName="info.circle"
                                TintColor="#FF888888"
                                WidthRequest="12" />
                            <Label
                                FontSize="10"
                                Text="Haz clic en el tiempo para ir 1s antes del evento"
                                TextColor="#FF888888" />
                        </HorizontalStackLayout>
                    </VerticalStackLayout>
                </Border>
                
                <!--  Botón para mostrar overlay cuando está oculto  -->
                <Border
                    Margin="16"
                    Padding="8"
                    BackgroundColor="#99000000"
                    HorizontalOptions="Start"
                    IsVisible="{Binding ShowOverlay, Converter={StaticResource InvertedBoolConverter}}"
                    StrokeShape="RoundRectangle 20"
                    StrokeThickness="0"
                    VerticalOptions="Start">
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding ToggleOverlayCommand}" />
                    </Border.GestureRecognizers>
                    <controls:SymbolIcon
                        HeightRequest="20"
                        SymbolName="info.circle"
                        TintColor="White"
                        WidthRequest="20" />
                </Border>
            </Grid>
        </Border>

        <!-- PiP cámara (Videolección) - por encima de todo y arrastrable -->
        <Border
            x:Name="VideoLessonCameraPip"
            Grid.RowSpan="3"
            Margin="0"
            Padding="0"
            BackgroundColor="#CC000000"
            HorizontalOptions="Start"
            IsVisible="False"
            StrokeShape="RoundRectangle 10"
            StrokeThickness="0"
            VerticalOptions="Start"
            WidthRequest="300"
            HeightRequest="200"
            ZIndex="1000">
            <Border.GestureRecognizers>
                <PanGestureRecognizer PanUpdated="OnVideoLessonPipPanUpdated" />
            </Border.GestureRecognizers>
            <controls:ReplayKitCameraPreview
                x:Name="VideoLessonCameraPreview"
                IsActive="False" />
        </Border>

        <!--  Controles de reproducción  -->
        <Border
            Grid.Row="1"
            Margin="16"
            Padding="16"
            BackgroundColor="#FF121212"
            Stroke="#FF3A3A3A"
            StrokeShape="RoundRectangle 8"
            StrokeThickness="0">
            <VerticalStackLayout Spacing="12">

                <!--  Barra de progreso con tiempo  -->
                <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12">
                    <Label
                        Grid.Column="0"
                        FontSize="12"
                        Text="{Binding CurrentPositionText}"
                        TextColor="#FFB1B1B1"
                        VerticalOptions="Center" />
                    <Grid Grid.Column="1" RowDefinitions="14,*" RowSpacing="2">
                        <!-- Marcadores de eventos a lo largo del slider -->
                        <AbsoluteLayout
                            Grid.Row="0"
                            HeightRequest="14"
                            HorizontalOptions="Fill"
                            VerticalOptions="Center"
                            BindableLayout.ItemsSource="{Binding TimelineMarkers}">
                            <BindableLayout.ItemTemplate>
                                <DataTemplate x:DataType="models:TimelineMarker">
                                    <Button
                                        BackgroundColor="#FF373737"
                                        CornerRadius="4"
                                        FontSize="12"
                                        HeightRequest="24"
                                        MinimumHeightRequest="24"
                                        Padding="8,0"
                                        Text="{Binding Label}"
                                        TextColor="White"
                                        AbsoluteLayout.LayoutFlags="PositionProportional"
                                        AbsoluteLayout.LayoutBounds="{Binding Position, Converter={StaticResource NormalizedPositionToRectConverter}}"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SeekToTimelineMarkerCommand}"
                                        CommandParameter="{Binding .}" />
                                </DataTemplate>
                            </BindableLayout.ItemTemplate>
                        </AbsoluteLayout>

                        <Grid Grid.Row="1">
                            <!-- Ticks naranjas en la zona del slider -->
                            <AbsoluteLayout
                                HeightRequest="14"
                                HorizontalOptions="Fill"
                                VerticalOptions="Center"
                                InputTransparent="True" ZIndex="1"
                                BindableLayout.ItemsSource="{Binding TimelineMarkers}">
                                <BindableLayout.ItemTemplate>
                                    <DataTemplate x:DataType="models:TimelineMarker">
                                        <BoxView
                                            Color="#FFFF5555" WidthRequest="22" HeightRequest="5"
                                            AbsoluteLayout.LayoutFlags="PositionProportional"
                                            AbsoluteLayout.LayoutBounds="{Binding Position, Converter={StaticResource NormalizedPositionToTickRectConverter}}" />
                                    </DataTemplate>
                                </BindableLayout.ItemTemplate>
                            </AbsoluteLayout>
                            <Slider
                                x:Name="ProgressSlider"
                                DragCompleted="OnSliderDragCompleted"
                                DragStarted="OnSliderDragStarted"
                                Maximum="1"
                                MaximumTrackColor="#FF3A3A3A"
                                Minimum="0"
                                MinimumTrackColor="#FF6DDDFF"
                                ThumbColor="#FF6DDDFF"
                                ValueChanged="OnSliderValueChanged"
                                Value="{Binding Progress}" />
                        </Grid>
                    </Grid>
                    <Label
                        Grid.Column="2"
                        FontSize="12"
                        Text="{Binding DurationText}"
                        TextColor="#FFB1B1B1"
                        VerticalOptions="Center" />
                </Grid>

                <!--  Botones de control principales  -->
                <HorizontalStackLayout HorizontalOptions="Center" Spacing="12">
                    <!--  Frame anterior  -->
                    <Border
                        Padding="16,6"
                        BackgroundColor="#FF2A2A2A"
                        StrokeShape="RoundRectangle 4"
                        StrokeThickness="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding FrameBackwardCommand}" />
                        </Border.GestureRecognizers>
                        <controls:SymbolIcon
                            HeightRequest="20"
                            SymbolName="backward.frame.fill"
                            TintColor="White"
                            WidthRequest="20" />
                    </Border>

                    <!--  Retroceso 5s  -->
                    <Border
                        Padding="16,6"
                        BackgroundColor="#FF2A2A2A"
                        StrokeShape="RoundRectangle 4"
                        StrokeThickness="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding SeekBackwardCommand}" />
                        </Border.GestureRecognizers>
                        <controls:SymbolIcon
                            HeightRequest="20"
                            SymbolName="gobackward.5"
                            TintColor="White"
                            WidthRequest="20" />
                    </Border>

                    <!--  Play/Pause  -->
                    <Border
                        Padding="36,6"
                        BackgroundColor="#FF6DDDFF"
                        StrokeShape="RoundRectangle 4"
                        StrokeThickness="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding PlayPauseCommand}" />
                        </Border.GestureRecognizers>
                        <controls:SymbolIcon
                            HeightRequest="24"
                            SymbolName="{Binding PlayPauseIcon}"
                            TintColor="Black"
                            WidthRequest="24" />
                    </Border>

                    <!--  Avance 5s  -->
                    <Border
                        Padding="16,6"
                        BackgroundColor="#FF2A2A2A"
                        StrokeShape="RoundRectangle 4"
                        StrokeThickness="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding SeekForwardCommand}" />
                        </Border.GestureRecognizers>
                        <controls:SymbolIcon
                            HeightRequest="20"
                            SymbolName="goforward.5"
                            TintColor="White"
                            WidthRequest="20" />
                    </Border>

                    <!--  Frame siguiente  -->
                    <Border
                        Padding="16,6"
                        BackgroundColor="#FF2A2A2A"
                        StrokeShape="RoundRectangle 4"
                        StrokeThickness="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding FrameForwardCommand}" />
                        </Border.GestureRecognizers>
                        <controls:SymbolIcon
                            HeightRequest="20"
                            SymbolName="forward.frame.fill"
                            TintColor="White"
                            WidthRequest="20" />
                    </Border>

                    <!--  Separador  -->
                    <BoxView
                        Margin="8,0"
                        BackgroundColor="#FF3A3A3A"
                        HeightRequest="30"
                        WidthRequest="1" />

                    <!--  Velocidad  -->
                    <Border
                        Padding="26,6"
                        BackgroundColor="#FF2A2A2A"
                        StrokeShape="RoundRectangle 4"
                        StrokeThickness="0">
                        <HorizontalStackLayout Spacing="8">
                            <Label
                                FontSize="14"
                                Text="{Binding SpeedText}"
                                TextColor="White"
                                VerticalOptions="Center" />
                            <HorizontalStackLayout Spacing="4">
                                <Border
                                    Padding="16,6"
                                    BackgroundColor="#FF3A3A3A"
                                    StrokeShape="RoundRectangle 4"
                                    StrokeThickness="0">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding SetSpeedCommand}" CommandParameter="0.25" />
                                    </Border.GestureRecognizers>
                                    <Label
                                        FontSize="14"
                                        Text="0.25x"
                                        TextColor="#FFB1B1B1" />
                                </Border>
                                <Border
                                    Padding="16,6"
                                    BackgroundColor="#FF3A3A3A"
                                    StrokeShape="RoundRectangle 4"
                                    StrokeThickness="0">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding SetSpeedCommand}" CommandParameter="0.5" />
                                    </Border.GestureRecognizers>
                                    <Label
                                        FontSize="14"
                                        Text="0.5x"
                                        TextColor="#FFB1B1B1" />
                                </Border>
                                <Border
                                    Padding="16,6"
                                    BackgroundColor="#FF3A3A3A"
                                    StrokeShape="RoundRectangle 4"
                                    StrokeThickness="0">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding SetSpeedCommand}" CommandParameter="1" />
                                    </Border.GestureRecognizers>
                                    <Label
                                        FontSize="14"
                                        Text="1x"
                                        TextColor="#FFB1B1B1" />
                                </Border>
                                <Border
                                    Padding="16,6"
                                    BackgroundColor="#FF3A3A3A"
                                    StrokeShape="RoundRectangle 4"
                                    StrokeThickness="0">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding SetSpeedCommand}" CommandParameter="2" />
                                    </Border.GestureRecognizers>
                                    <Label
                                        FontSize="14"
                                        Text="2x"
                                        TextColor="#FFB1B1B1" />
                                </Border>
                            </HorizontalStackLayout>
                        </HorizontalStackLayout>
                    </Border>
                </HorizontalStackLayout>

            </VerticalStackLayout>
        </Border>

        <!--  Barra de navegación y filtros  -->
        <Border
            Grid.Row="2"
            Margin="16,0,16,16"
            Padding="12"
            BackgroundColor="#FF121212"
            Stroke="#FF3A3A3A"
            StrokeShape="RoundRectangle 8"
            StrokeThickness="0">
            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="16">
                
                <!--  Navegación anterior  -->
                <HorizontalStackLayout Grid.Column="0" Spacing="8">
                    <Border
                        Padding="12,8"
                        BackgroundColor="#FF2A2A2A"
                        IsEnabled="{Binding CanGoPrevious}"
                        Opacity="{Binding CanGoPrevious, Converter={StaticResource BoolToOpacityConverter}}"
                        StrokeShape="RoundRectangle 4"
                        StrokeThickness="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding PreviousVideoCommand}" />
                        </Border.GestureRecognizers>
                        <HorizontalStackLayout Spacing="6">
                            <controls:SymbolIcon
                                HeightRequest="16"
                                SymbolName="chevron.left"
                                TintColor="White"
                                WidthRequest="16" />
                            <Label
                                FontSize="13"
                                Text="Anterior"
                                TextColor="White"
                                VerticalOptions="Center" />
                        </HorizontalStackLayout>
                    </Border>
                </HorizontalStackLayout>
                
                <!--  Filtros y posición  -->
                <VerticalStackLayout
                    Grid.Column="1"
                    HorizontalOptions="Center"
                    Spacing="8">
                    
                    <!--  Indicador de posición en playlist  -->
                    <HorizontalStackLayout HorizontalOptions="Center" Spacing="12">
                        <Label
                            FontSize="13"
                            Text="{Binding PlaylistPositionText}"
                            TextColor="#FFB1B1B1"
                            VerticalOptions="Center" />
                        
                        <!--  Botón para mostrar/ocultar filtros  -->
                        <Border
                            Padding="10,6"
                            BackgroundColor="#FF2A2A2A"
                            StrokeShape="RoundRectangle 4"
                            StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ToggleFiltersCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="6">
                                <controls:SymbolIcon
                                    HeightRequest="14"
                                    SymbolName="line.3.horizontal.decrease"
                                    TintColor="#FF6DDDFF"
                                    WidthRequest="14" />
                                <Label
                                    FontSize="12"
                                    Text="Filtros"
                                    TextColor="#FF6DDDFF"
                                    VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>
                    </HorizontalStackLayout>
                    
                    <!--  Panel de filtros (colapsable)  -->
                    <HorizontalStackLayout
                        HorizontalOptions="Center"
                        IsVisible="{Binding ShowFilters}"
                        Spacing="12">
                        
                        <!--  Filtro de atleta (Dropdown)  -->
                        <Border
                            x:Name="AthleteDropdown"
                            Padding="10,8"
                            BackgroundColor="#FF2A2A2A"
                            StrokeShape="RoundRectangle 4"
                            StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnAthleteDropdownTapped" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="8" WidthRequest="150">
                                <Label
                                    FontSize="12"
                                    HorizontalOptions="FillAndExpand"
                                    Text="{Binding SelectedAthlete.DisplayName, FallbackValue='Atleta'}"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                                <controls:SymbolIcon
                                    HeightRequest="10"
                                    SymbolName="chevron.down"
                                    TintColor="#FF888888"
                                    VerticalOptions="Center"
                                    WidthRequest="10" />
                            </HorizontalStackLayout>
                        </Border>
                        
                        <!--  Filtro de sección (Dropdown)  -->
                        <Border
                            x:Name="SectionDropdown"
                            Padding="10,8"
                            BackgroundColor="#FF2A2A2A"
                            StrokeShape="RoundRectangle 4"
                            StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnSectionDropdownTapped" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="8" WidthRequest="130">
                                <Label
                                    FontSize="12"
                                    HorizontalOptions="FillAndExpand"
                                    Text="{Binding SelectedSection.DisplayName, FallbackValue='Sección'}"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                                <controls:SymbolIcon
                                    HeightRequest="10"
                                    SymbolName="chevron.down"
                                    TintColor="#FF888888"
                                    VerticalOptions="Center"
                                    WidthRequest="10" />
                            </HorizontalStackLayout>
                        </Border>
                        
                        <!--  Filtro de categoría (Dropdown)  -->
                        <Border
                            x:Name="CategoryDropdown"
                            Padding="10,8"
                            BackgroundColor="#FF2A2A2A"
                            StrokeShape="RoundRectangle 4"
                            StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnCategoryDropdownTapped" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="8" WidthRequest="150">
                                <Label
                                    FontSize="12"
                                    HorizontalOptions="FillAndExpand"
                                    Text="{Binding SelectedCategory.DisplayName, FallbackValue='Categoría'}"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                                <controls:SymbolIcon
                                    HeightRequest="10"
                                    SymbolName="chevron.down"
                                    TintColor="#FF888888"
                                    VerticalOptions="Center"
                                    WidthRequest="10" />
                            </HorizontalStackLayout>
                        </Border>
                        
                        <!--  Botón limpiar filtros  -->
                        <Border
                            Padding="10,6"
                            BackgroundColor="#FF3A3A3A"
                            StrokeShape="RoundRectangle 4"
                            StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ClearFiltersCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="4">
                                <controls:SymbolIcon
                                    HeightRequest="12"
                                    SymbolName="xmark"
                                    TintColor="#FFB1B1B1"
                                    WidthRequest="12" />
                                <Label
                                    FontSize="11"
                                    Text="Limpiar"
                                    TextColor="#FFB1B1B1"
                                    VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>
                    </HorizontalStackLayout>
                </VerticalStackLayout>
                
                <!--  Navegación siguiente  -->
                <HorizontalStackLayout Grid.Column="2" Spacing="8">
                    <Border
                        Padding="12,8"
                        BackgroundColor="#FF2A2A2A"
                        IsEnabled="{Binding CanGoNext}"
                        Opacity="{Binding CanGoNext, Converter={StaticResource BoolToOpacityConverter}}"
                        StrokeShape="RoundRectangle 4"
                        StrokeThickness="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding NextVideoCommand}" />
                        </Border.GestureRecognizers>
                        <HorizontalStackLayout Spacing="6">
                            <Label
                                FontSize="13"
                                Text="Siguiente"
                                TextColor="White"
                                VerticalOptions="Center" />
                            <controls:SymbolIcon
                                HeightRequest="16"
                                SymbolName="chevron.right"
                                TintColor="White"
                                WidthRequest="16" />
                        </HorizontalStackLayout>
                    </Border>
                </HorizontalStackLayout>
            </Grid>
        </Border>

    </Grid>
</ContentPage>
