<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="CrownRFEP_Reader.Views.SinglePlayerPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:controls="clr-namespace:CrownRFEP_Reader.Views.Controls"
    xmlns:converters="clr-namespace:CrownRFEP_Reader.Converters"
    xmlns:precision="clr-namespace:CrownRFEP_Reader.Controls"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:vm="clr-namespace:CrownRFEP_Reader.ViewModels"
    Title="{Binding VideoTitle}"
    x:DataType="vm:SinglePlayerViewModel"
    BackgroundColor="#FF121212"
    Shell.BackgroundColor="#FF121212"
    Shell.ForegroundColor="White"
    Shell.NavBarIsVisible="True"
    Shell.TitleColor="White">

    <ContentPage.Resources>
        <toolkit:InvertedBoolConverter x:Key="InvertedBoolConverter" />
        <converters:BoolToOpacityConverter x:Key="BoolToOpacityConverter" />
    </ContentPage.Resources>

    <Grid Padding="0" RowDefinitions="*,Auto,Auto">

        <!--  Área del vídeo  -->
        <Border
            Grid.Row="0"
            Margin="0,0,0,0"
            BackgroundColor="#FF121212"
            Stroke="#FF3A3A3A"
            StrokeShape="RoundRectangle 8"
            StrokeThickness="0">
            <Grid>
                <precision:PrecisionVideoPlayer
                    x:Name="MediaPlayer"
                    Aspect="AspectFill"
                    IsMuted="False"
                    Source="{Binding VideoPath}" />
                
                <!--  Overlay de información del video  -->
                <Border
                    Margin="16"
                    Padding="12,10"
                    BackgroundColor="#CC000000"
                    HorizontalOptions="Start"
                    IsVisible="{Binding ShowOverlay}"
                    StrokeShape="RoundRectangle 8"
                    StrokeThickness="0"
                    VerticalOptions="Start">
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding ToggleOverlayCommand}" />
                    </Border.GestureRecognizers>
                    <VerticalStackLayout Spacing="4">
                        <!--  Nombre del atleta  -->
                        <Label
                            FontAttributes="Bold"
                            FontSize="16"
                            Text="{Binding AthleteName}"
                            TextColor="White" />
                        
                        <!--  Sesión  -->
                        <HorizontalStackLayout Spacing="8">
                            <Label
                                FontSize="12"
                                Text="{Binding SessionName}"
                                TextColor="#FFAAAAAA" />
                            <Label
                                FontSize="12"
                                Text="•"
                                TextColor="#FF666666" />
                            <Label
                                FontSize="12"
                                Text="{Binding SessionPlace}"
                                TextColor="#FFAAAAAA" />
                        </HorizontalStackLayout>
                        
                        <!--  Fecha y sección  -->
                        <HorizontalStackLayout Spacing="8">
                            <Label
                                FontSize="11"
                                Text="{Binding SessionDate}"
                                TextColor="#FF888888" />
                            <Label
                                FontSize="11"
                                Text="•"
                                TextColor="#FF666666" />
                            <Label
                                FontSize="11"
                                Text="{Binding SectionText}"
                                TextColor="#FF888888" />
                        </HorizontalStackLayout>
                        
                        <!--  Duración y tamaño  -->
                        <HorizontalStackLayout Spacing="8">
                            <Label
                                FontSize="10"
                                Text="{Binding VideoDurationText, StringFormat='Duración: {0}'}"
                                TextColor="#FF666666" />
                            <Label
                                FontSize="10"
                                Text="{Binding VideoSizeText, StringFormat='({0})'}"
                                TextColor="#FF666666" />
                        </HorizontalStackLayout>
                        
                        <!--  Tags si existen  -->
                        <HorizontalStackLayout 
                            IsVisible="{Binding HasTags}"
                            Spacing="4">
                            <controls:SymbolIcon
                                HeightRequest="12"
                                SymbolName="tag.fill"
                                TintColor="#FF888888"
                                VerticalOptions="Center"
                                WidthRequest="12" />
                            <Label
                                FontSize="11"
                                Text="{Binding TagsText}"
                                TextColor="#FF888888" />
                        </HorizontalStackLayout>
                        
                        <!--  Badge si existe  -->
                        <Border
                            Margin="0,4,0,0"
                            Padding="8,4"
                            BackgroundColor="{Binding BadgeColor}"
                            IsVisible="{Binding HasBadge}"
                            StrokeShape="RoundRectangle 4"
                            StrokeThickness="0">
                            <Label
                                FontSize="11"
                                Text="{Binding BadgeText}"
                                TextColor="White" />
                        </Border>
                    </VerticalStackLayout>
                </Border>
                
                <!--  Botón para mostrar overlay cuando está oculto  -->
                <Border
                    Margin="16"
                    Padding="8"
                    BackgroundColor="#99000000"
                    HorizontalOptions="Start"
                    IsVisible="{Binding ShowOverlay, Converter={StaticResource InvertedBoolConverter}}"
                    StrokeShape="RoundRectangle 20"
                    StrokeThickness="0"
                    VerticalOptions="Start">
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding ToggleOverlayCommand}" />
                    </Border.GestureRecognizers>
                    <controls:SymbolIcon
                        HeightRequest="20"
                        SymbolName="info.circle"
                        TintColor="White"
                        WidthRequest="20" />
                </Border>
            </Grid>
        </Border>

        <!--  Controles de reproducción  -->
        <Border
            Grid.Row="1"
            Margin="16"
            Padding="16"
            BackgroundColor="#FF121212"
            Stroke="#FF3A3A3A"
            StrokeShape="RoundRectangle 8"
            StrokeThickness="0">
            <VerticalStackLayout Spacing="12">

                <!--  Barra de progreso con tiempo  -->
                <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12">
                    <Label
                        Grid.Column="0"
                        FontSize="12"
                        Text="{Binding CurrentPositionText}"
                        TextColor="#FFB1B1B1"
                        VerticalOptions="Center" />
                    <Slider
                        x:Name="ProgressSlider"
                        Grid.Column="1"
                        DragCompleted="OnSliderDragCompleted"
                        DragStarted="OnSliderDragStarted"
                        Maximum="1"
                        MaximumTrackColor="#FF3A3A3A"
                        Minimum="0"
                        MinimumTrackColor="#FF6DDDFF"
                        ThumbColor="#FF6DDDFF"
                        ValueChanged="OnSliderValueChanged"
                        Value="{Binding Progress}" />
                    <Label
                        Grid.Column="2"
                        FontSize="12"
                        Text="{Binding DurationText}"
                        TextColor="#FFB1B1B1"
                        VerticalOptions="Center" />
                </Grid>

                <!--  Botones de control principales  -->
                <HorizontalStackLayout HorizontalOptions="Center" Spacing="12">
                    <!--  Frame anterior  -->
                    <Border
                        Padding="16,6"
                        BackgroundColor="#FF2A2A2A"
                        StrokeShape="RoundRectangle 4"
                        StrokeThickness="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding FrameBackwardCommand}" />
                        </Border.GestureRecognizers>
                        <controls:SymbolIcon
                            HeightRequest="20"
                            SymbolName="backward.frame.fill"
                            TintColor="White"
                            WidthRequest="20" />
                    </Border>

                    <!--  Retroceso 5s  -->
                    <Border
                        Padding="16,6"
                        BackgroundColor="#FF2A2A2A"
                        StrokeShape="RoundRectangle 4"
                        StrokeThickness="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding SeekBackwardCommand}" />
                        </Border.GestureRecognizers>
                        <controls:SymbolIcon
                            HeightRequest="20"
                            SymbolName="gobackward.5"
                            TintColor="White"
                            WidthRequest="20" />
                    </Border>

                    <!--  Play/Pause  -->
                    <Border
                        Padding="36,6"
                        BackgroundColor="#FF6DDDFF"
                        StrokeShape="RoundRectangle 4"
                        StrokeThickness="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding PlayPauseCommand}" />
                        </Border.GestureRecognizers>
                        <controls:SymbolIcon
                            HeightRequest="24"
                            SymbolName="{Binding PlayPauseIcon}"
                            TintColor="Black"
                            WidthRequest="24" />
                    </Border>

                    <!--  Avance 5s  -->
                    <Border
                        Padding="16,6"
                        BackgroundColor="#FF2A2A2A"
                        StrokeShape="RoundRectangle 4"
                        StrokeThickness="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding SeekForwardCommand}" />
                        </Border.GestureRecognizers>
                        <controls:SymbolIcon
                            HeightRequest="20"
                            SymbolName="goforward.5"
                            TintColor="White"
                            WidthRequest="20" />
                    </Border>

                    <!--  Frame siguiente  -->
                    <Border
                        Padding="16,6"
                        BackgroundColor="#FF2A2A2A"
                        StrokeShape="RoundRectangle 4"
                        StrokeThickness="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding FrameForwardCommand}" />
                        </Border.GestureRecognizers>
                        <controls:SymbolIcon
                            HeightRequest="20"
                            SymbolName="forward.frame.fill"
                            TintColor="White"
                            WidthRequest="20" />
                    </Border>

                    <!--  Separador  -->
                    <BoxView
                        Margin="8,0"
                        BackgroundColor="#FF3A3A3A"
                        HeightRequest="30"
                        WidthRequest="1" />

                    <!--  Velocidad  -->
                    <Border
                        Padding="26,6"
                        BackgroundColor="#FF2A2A2A"
                        StrokeShape="RoundRectangle 4"
                        StrokeThickness="0">
                        <HorizontalStackLayout Spacing="8">
                            <Label
                                FontSize="14"
                                Text="{Binding SpeedText}"
                                TextColor="White"
                                VerticalOptions="Center" />
                            <HorizontalStackLayout Spacing="4">
                                <Border
                                    Padding="16,6"
                                    BackgroundColor="#FF3A3A3A"
                                    StrokeShape="RoundRectangle 4"
                                    StrokeThickness="0">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding SetSpeedCommand}" CommandParameter="0.25" />
                                    </Border.GestureRecognizers>
                                    <Label
                                        FontSize="14"
                                        Text="0.25x"
                                        TextColor="#FFB1B1B1" />
                                </Border>
                                <Border
                                    Padding="16,6"
                                    BackgroundColor="#FF3A3A3A"
                                    StrokeShape="RoundRectangle 4"
                                    StrokeThickness="0">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding SetSpeedCommand}" CommandParameter="0.5" />
                                    </Border.GestureRecognizers>
                                    <Label
                                        FontSize="14"
                                        Text="0.5x"
                                        TextColor="#FFB1B1B1" />
                                </Border>
                                <Border
                                    Padding="16,6"
                                    BackgroundColor="#FF3A3A3A"
                                    StrokeShape="RoundRectangle 4"
                                    StrokeThickness="0">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding SetSpeedCommand}" CommandParameter="1" />
                                    </Border.GestureRecognizers>
                                    <Label
                                        FontSize="14"
                                        Text="1x"
                                        TextColor="#FFB1B1B1" />
                                </Border>
                                <Border
                                    Padding="16,6"
                                    BackgroundColor="#FF3A3A3A"
                                    StrokeShape="RoundRectangle 4"
                                    StrokeThickness="0">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding SetSpeedCommand}" CommandParameter="2" />
                                    </Border.GestureRecognizers>
                                    <Label
                                        FontSize="14"
                                        Text="2x"
                                        TextColor="#FFB1B1B1" />
                                </Border>
                            </HorizontalStackLayout>
                        </HorizontalStackLayout>
                    </Border>
                </HorizontalStackLayout>

            </VerticalStackLayout>
        </Border>

        <!--  Barra de navegación y filtros  -->
        <Border
            Grid.Row="2"
            Margin="16,0,16,16"
            Padding="12"
            BackgroundColor="#FF121212"
            Stroke="#FF3A3A3A"
            StrokeShape="RoundRectangle 8"
            StrokeThickness="0">
            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="16">
                
                <!--  Navegación anterior  -->
                <HorizontalStackLayout Grid.Column="0" Spacing="8">
                    <Border
                        Padding="12,8"
                        BackgroundColor="#FF2A2A2A"
                        IsEnabled="{Binding CanGoPrevious}"
                        Opacity="{Binding CanGoPrevious, Converter={StaticResource BoolToOpacityConverter}}"
                        StrokeShape="RoundRectangle 4"
                        StrokeThickness="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding PreviousVideoCommand}" />
                        </Border.GestureRecognizers>
                        <HorizontalStackLayout Spacing="6">
                            <controls:SymbolIcon
                                HeightRequest="16"
                                SymbolName="chevron.left"
                                TintColor="White"
                                WidthRequest="16" />
                            <Label
                                FontSize="13"
                                Text="Anterior"
                                TextColor="White"
                                VerticalOptions="Center" />
                        </HorizontalStackLayout>
                    </Border>
                </HorizontalStackLayout>
                
                <!--  Filtros y posición  -->
                <VerticalStackLayout
                    Grid.Column="1"
                    HorizontalOptions="Center"
                    Spacing="8">
                    
                    <!--  Indicador de posición en playlist  -->
                    <HorizontalStackLayout HorizontalOptions="Center" Spacing="12">
                        <Label
                            FontSize="13"
                            Text="{Binding PlaylistPositionText}"
                            TextColor="#FFB1B1B1"
                            VerticalOptions="Center" />
                        
                        <!--  Botón para mostrar/ocultar filtros  -->
                        <Border
                            Padding="10,6"
                            BackgroundColor="#FF2A2A2A"
                            StrokeShape="RoundRectangle 4"
                            StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ToggleFiltersCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="6">
                                <controls:SymbolIcon
                                    HeightRequest="14"
                                    SymbolName="line.3.horizontal.decrease"
                                    TintColor="#FF6DDDFF"
                                    WidthRequest="14" />
                                <Label
                                    FontSize="12"
                                    Text="Filtros"
                                    TextColor="#FF6DDDFF"
                                    VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>
                    </HorizontalStackLayout>
                    
                    <!--  Panel de filtros (colapsable)  -->
                    <HorizontalStackLayout
                        HorizontalOptions="Center"
                        IsVisible="{Binding ShowFilters}"
                        Spacing="12">
                        
                        <!--  Filtro de atleta (Dropdown)  -->
                        <Border
                            x:Name="AthleteDropdown"
                            Padding="10,8"
                            BackgroundColor="#FF2A2A2A"
                            StrokeShape="RoundRectangle 4"
                            StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnAthleteDropdownTapped" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="8" WidthRequest="150">
                                <Label
                                    FontSize="12"
                                    HorizontalOptions="FillAndExpand"
                                    Text="{Binding SelectedAthlete.DisplayName, FallbackValue='Atleta'}"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                                <controls:SymbolIcon
                                    HeightRequest="10"
                                    SymbolName="chevron.down"
                                    TintColor="#FF888888"
                                    VerticalOptions="Center"
                                    WidthRequest="10" />
                            </HorizontalStackLayout>
                        </Border>
                        
                        <!--  Filtro de sección (Dropdown)  -->
                        <Border
                            x:Name="SectionDropdown"
                            Padding="10,8"
                            BackgroundColor="#FF2A2A2A"
                            StrokeShape="RoundRectangle 4"
                            StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnSectionDropdownTapped" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="8" WidthRequest="130">
                                <Label
                                    FontSize="12"
                                    HorizontalOptions="FillAndExpand"
                                    Text="{Binding SelectedSection.DisplayName, FallbackValue='Sección'}"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                                <controls:SymbolIcon
                                    HeightRequest="10"
                                    SymbolName="chevron.down"
                                    TintColor="#FF888888"
                                    VerticalOptions="Center"
                                    WidthRequest="10" />
                            </HorizontalStackLayout>
                        </Border>
                        
                        <!--  Filtro de categoría (Dropdown)  -->
                        <Border
                            x:Name="CategoryDropdown"
                            Padding="10,8"
                            BackgroundColor="#FF2A2A2A"
                            StrokeShape="RoundRectangle 4"
                            StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnCategoryDropdownTapped" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="8" WidthRequest="150">
                                <Label
                                    FontSize="12"
                                    HorizontalOptions="FillAndExpand"
                                    Text="{Binding SelectedCategory.DisplayName, FallbackValue='Categoría'}"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                                <controls:SymbolIcon
                                    HeightRequest="10"
                                    SymbolName="chevron.down"
                                    TintColor="#FF888888"
                                    VerticalOptions="Center"
                                    WidthRequest="10" />
                            </HorizontalStackLayout>
                        </Border>
                        
                        <!--  Botón limpiar filtros  -->
                        <Border
                            Padding="10,6"
                            BackgroundColor="#FF3A3A3A"
                            StrokeShape="RoundRectangle 4"
                            StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ClearFiltersCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="4">
                                <controls:SymbolIcon
                                    HeightRequest="12"
                                    SymbolName="xmark"
                                    TintColor="#FFB1B1B1"
                                    WidthRequest="12" />
                                <Label
                                    FontSize="11"
                                    Text="Limpiar"
                                    TextColor="#FFB1B1B1"
                                    VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>
                    </HorizontalStackLayout>
                </VerticalStackLayout>
                
                <!--  Navegación siguiente  -->
                <HorizontalStackLayout Grid.Column="2" Spacing="8">
                    <Border
                        Padding="12,8"
                        BackgroundColor="#FF2A2A2A"
                        IsEnabled="{Binding CanGoNext}"
                        Opacity="{Binding CanGoNext, Converter={StaticResource BoolToOpacityConverter}}"
                        StrokeShape="RoundRectangle 4"
                        StrokeThickness="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding NextVideoCommand}" />
                        </Border.GestureRecognizers>
                        <HorizontalStackLayout Spacing="6">
                            <Label
                                FontSize="13"
                                Text="Siguiente"
                                TextColor="White"
                                VerticalOptions="Center" />
                            <controls:SymbolIcon
                                HeightRequest="16"
                                SymbolName="chevron.right"
                                TintColor="White"
                                WidthRequest="16" />
                        </HorizontalStackLayout>
                    </Border>
                </HorizontalStackLayout>
            </Grid>
        </Border>

    </Grid>
</ContentPage>
