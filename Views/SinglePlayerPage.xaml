<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="CrownRFEP_Reader.Views.SinglePlayerPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:behaviors="clr-namespace:CrownRFEP_Reader.Behaviors"
    xmlns:controls="clr-namespace:CrownRFEP_Reader.Views.Controls"
    xmlns:converters="clr-namespace:CrownRFEP_Reader.Converters"
    xmlns:models="clr-namespace:CrownRFEP_Reader.Models"
    xmlns:precision="clr-namespace:CrownRFEP_Reader.Controls"
    xmlns:services="clr-namespace:CrownRFEP_Reader.Services"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:vm="clr-namespace:CrownRFEP_Reader.ViewModels"
    x:Name="ThisPage"
    Title="{Binding VideoTitle}"
    x:DataType="vm:SinglePlayerViewModel"
    BackgroundColor="#FF121212"
    Shell.BackgroundColor="#FF121212"
    Shell.ForegroundColor="White"
    Shell.TitleColor="White">
    <Shell.NavBarIsVisible>
        <OnPlatform x:TypeArguments="x:Boolean">
            <On Platform="WinUI" Value="False" />
            <On Platform="Default" Value="True" />
        </OnPlatform>
    </Shell.NavBarIsVisible>

    <ContentPage.Resources>
        <toolkit:InvertedBoolConverter x:Key="InvertedBoolConverter" />
        <converters:BoolToOpacityConverter x:Key="BoolToOpacityConverter" />
        <converters:TagSelectedColorConverter x:Key="TagSelectedColorConverter" />
        <converters:EventTagSelectedColorConverter x:Key="EventTagSelectedColorConverter" />
        <converters:NormalizedPositionToRectConverter x:Key="NormalizedPositionToRectConverter" />
        <converters:NormalizedPositionToTickRectConverter x:Key="NormalizedPositionToTickRectConverter" />
        <converters:BoolToColorConverter x:Key="BoolToAthleteBackgroundConverter" />
        <converters:BoolToColorConverter x:Key="BoolToTagEventBackgroundConverter" />
        <converters:BoolToColorConverter x:Key="BoolToColorConverter" />
        <converters:IsNotZeroConverter x:Key="IsNotZeroConverter" />
        <converters:NotNullOrEmptyBoolConverter x:Key="NotNullOrEmptyBoolConverter" />
        <converters:IntToBoolConverter x:Key="IntToBoolConverter" />
        <converters:IntEqualityToColorConverter x:Key="IntEqualityToColorConverter" />
        
        <!-- Altura de la fila de controles del reproductor -->
        <OnPlatform x:TypeArguments="GridLength" x:Key="PlayerControlsRowHeight">
            <On Platform="WinUI" Value="100" />
            <On Platform="iOS" Value="80" />
            <On Platform="Default" Value="170" />
        </OnPlatform>
        
        <!-- Padding para botones del reproductor -->
        <OnPlatform x:TypeArguments="Thickness" x:Key="PlayerButtonPadding">
            <On Platform="WinUI" Value="12,4" />
            <On Platform="iOS" Value="6,4" />
            <On Platform="Default" Value="16,6" />
        </OnPlatform>
        
        <!-- Padding para botón Play/Pause (más ancho) -->
        <OnPlatform x:TypeArguments="Thickness" x:Key="PlayerPlayButtonPadding">
            <On Platform="WinUI" Value="28,4" />
            <On Platform="iOS" Value="14,4" />
            <On Platform="Default" Value="36,6" />
        </OnPlatform>
        
        <!-- Padding para botones de velocidad -->
        <OnPlatform x:TypeArguments="Thickness" x:Key="PlayerSpeedButtonPadding">
            <On Platform="WinUI" Value="12,4" />
            <On Platform="iOS" Value="6,3" />
            <On Platform="Default" Value="16,6" />
        </OnPlatform>
        
        <!-- Padding para contenedor de velocidad -->
        <OnPlatform x:TypeArguments="Thickness" x:Key="PlayerSpeedContainerPadding">
            <On Platform="WinUI" Value="20,4" />
            <On Platform="iOS" Value="8,4" />
            <On Platform="Default" Value="26,6" />
        </OnPlatform>
        
        <!-- Tamaño de iconos para iOS (más pequeños) -->
        <OnPlatform x:TypeArguments="x:Double" x:Key="iOSPlayerIconSize">
            <On Platform="iOS" Value="18" />
            <On Platform="Default" Value="24" />
        </OnPlatform>

        <!-- Altura fija para la cabecera de información del vídeo (barra izquierda) -->
        <OnPlatform x:TypeArguments="x:Double" x:Key="LeftSidebarVideoInfoHeight">
            <On Platform="WinUI" Value="370" />
            <On Platform="MacCatalyst" Value="370" />
            <On Platform="iOS" Value="340" />
            <On Platform="Default" Value="370" />
        </OnPlatform>
    </ContentPage.Resources>

    <!-- Grid principal: En Windows y MacCatalyst usa 5 columnas (galería, splitter, player, splitter, sidebar), en otras plataformas usa filas -->
    <Grid x:Name="RootGrid" Padding="0">
        <Grid.RowDefinitions>
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="{StaticResource FooterHeight}" />
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
            <OnPlatform x:TypeArguments="ColumnDefinitionCollection">
                <On Platform="WinUI,MacCatalyst,iOS">
                    <ColumnDefinitionCollection>
                        <ColumnDefinition Width="340" />
                        <ColumnDefinition Width="8" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="8" />
                        <ColumnDefinition Width="380" />
                    </ColumnDefinitionCollection>
                </On>
                <On Platform="Default">
                    <ColumnDefinitionCollection>
                        <ColumnDefinition Width="*" />
                    </ColumnDefinitionCollection>
                </On>
            </OnPlatform>
        </Grid.ColumnDefinitions>

        <!-- ===================== GALERÍA DE VIDEOS (Columna 0) - Windows, MacCatalyst e iOS ===================== -->
        <Border
            x:Name="VideoGalleryPanel"
            Grid.Row="0"
            Grid.Column="0"
            Grid.RowSpan="3"
            Margin="8,8,0,8"
            Padding="0"
            BackgroundColor="#FF1A1A1A"
            StrokeShape="RoundRectangle 12"
            StrokeThickness="0">
            <Border.IsVisible>
                <OnPlatform x:TypeArguments="x:Boolean">
                    <On Platform="WinUI,MacCatalyst" Value="True" />
                    <On Platform="iOS" Value="{Binding IsLeftPanelVisible}" />
                    <On Platform="Default" Value="False" />
                </OnPlatform>
            </Border.IsVisible>
            <Grid RowDefinitions="Auto,Auto,*,Auto">
                <!-- Información del video actual (cabecera) -->
                <Border
                    Grid.Row="0"
                    Padding="12,10"
                    BackgroundColor="#FF202020"
                    HeightRequest="{StaticResource LeftSidebarVideoInfoHeight}"
                    StrokeThickness="0">
                    <Grid RowDefinitions="Auto,*" RowSpacing="10">
                        <!-- Bloque de información (no scrollea) -->
                        <VerticalStackLayout Grid.Row="0" Spacing="8">
                            <!-- Título: Atleta y Sección -->
                            <Grid ColumnDefinitions="*,Auto">
                                <VerticalStackLayout Spacing="2">
                                    <Label
                                        FontAttributes="Bold"
                                        FontSize="{StaticResource FontSizeBody}"
                                        Text="{Binding AthleteName, FallbackValue='Sin atleta asignado'}"
                                        TextColor="White"
                                        LineBreakMode="TailTruncation" />
                                    <Label
                                        FontSize="{StaticResource FontSizeSmall}"
                                        Text="{Binding SectionText, FallbackValue='Sin tramo'}"
                                        TextColor="#FF888888"
                                        LineBreakMode="TailTruncation" />
                                </VerticalStackLayout>
                                <!-- Badge de sección -->
                                <Border
                                    Grid.Column="1"
                                    Padding="8,4"
                                    BackgroundColor="#FF3A3A3A"
                                    StrokeShape="RoundRectangle 6"
                                    StrokeThickness="0"
                                    VerticalOptions="Start">
                                    <Label
                                        FontSize="{StaticResource FontSizeSmall}"
                                        FontAttributes="Bold"
                                        Text="{Binding VideoClip.Section, StringFormat='S{0}'}"
                                        TextColor="#FFB1B1B1" />
                                </Border>
                            </Grid>

                            <!-- Fila 1: Fecha/hora y Duración -->
                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                                <HorizontalStackLayout Spacing="6">
                                    <controls:SymbolIcon
                                        HeightRequest="12"
                                        WidthRequest="12"
                                        SymbolName="calendar"
                                        TintColor="#FF888888" />
                                    <Label
                                        FontSize="{StaticResource FontSizeSmall}"
                                        Text="{Binding VideoClip.CreationDateTime, StringFormat='{0:dd/MM/yyyy HH:mm}'}"
                                        TextColor="#FFAAAAAA" />
                                </HorizontalStackLayout>
                                <HorizontalStackLayout Grid.Column="1" Spacing="6">
                                    <controls:SymbolIcon
                                        HeightRequest="12"
                                        WidthRequest="12"
                                        SymbolName="clock"
                                        TintColor="#FF888888" />
                                    <Label
                                        FontSize="{StaticResource FontSizeSmall}"
                                        FontFamily="{StaticResource AppFontMono}"
                                        Text="{Binding VideoDurationText}"
                                        TextColor="#FFAAAAAA" />
                                </HorizontalStackLayout>
                            </Grid>

                            <!-- Fila 2: Tamaño del archivo -->
                            <HorizontalStackLayout Spacing="6">
                                <controls:SymbolIcon
                                    HeightRequest="12"
                                    WidthRequest="12"
                                    SymbolName="doc"
                                    TintColor="#FF888888" />
                                <Label
                                    FontSize="{StaticResource FontSizeSmall}"
                                    Text="{Binding VideoSizeText}"
                                    TextColor="#FFAAAAAA" />
                            </HorizontalStackLayout>
                        </VerticalStackLayout>

                        <!-- Área scrollable: listas de etiquetas y eventos -->
                        <ScrollView Grid.Row="1" VerticalScrollBarVisibility="Default">
                            <VerticalStackLayout Spacing="10">
                                <!-- Etiquetas (lista) -->
                                <VerticalStackLayout IsVisible="{Binding HasTags}" Spacing="6">
                                    <HorizontalStackLayout Spacing="6">
                                        <controls:SymbolIcon
                                            HeightRequest="12"
                                            WidthRequest="12"
                                            SymbolName="tag.fill"
                                            TintColor="#FF66BB6A" />
                                        <Label
                                            FontSize="{StaticResource FontSizeSmall}"
                                            FontAttributes="Bold"
                                            Text="ETIQUETAS"
                                            TextColor="#FF66BB6A" />
                                    </HorizontalStackLayout>

                                    <FlexLayout
                                        Wrap="Wrap"
                                        Direction="Row"
                                        AlignItems="Start"
                                        JustifyContent="Start"
                                        BindableLayout.ItemsSource="{Binding VideoClip.Tags}"
                                        Margin="0,2,0,0">
                                        <BindableLayout.ItemTemplate>
                                            <DataTemplate x:DataType="models:Tag">
                                                <Border
                                                    Margin="0,0,6,6"
                                                    Padding="8,4"
                                                    BackgroundColor="#FF66BB6A"
                                                    StrokeShape="RoundRectangle 10"
                                                    StrokeThickness="0">
                                                    <Label
                                                        Text="{Binding NombreTag}"
                                                        FontSize="{StaticResource FontSizeCaption}"
                                                        TextColor="White"
                                                        LineBreakMode="TailTruncation" />
                                                </Border>
                                            </DataTemplate>
                                        </BindableLayout.ItemTemplate>
                                    </FlexLayout>
                                </VerticalStackLayout>

                                <!-- Eventos (lista) -->
                                <VerticalStackLayout IsVisible="{Binding HasTagEvents}" Spacing="6">
                                    <HorizontalStackLayout Spacing="6">
                                        <controls:SymbolIcon
                                            HeightRequest="12"
                                            WidthRequest="12"
                                            SymbolName="clock.badge.checkmark"
                                            TintColor="#FFFF7043" />
                                        <Label
                                            FontSize="{StaticResource FontSizeSmall}"
                                            FontAttributes="Bold"
                                            Text="EVENTOS MARCADOS"
                                            TextColor="#FFFF7043" />
                                        <Label
                                            FontSize="{StaticResource FontSizeSmall}"
                                            Text="{Binding TagEventsCountText}"
                                            TextColor="#FFFF7043" />
                                    </HorizontalStackLayout>

                                    <VerticalStackLayout
                                        BindableLayout.ItemsSource="{Binding TagEvents}"
                                        Spacing="4"
                                        Margin="0,2,0,0">
                                        <BindableLayout.ItemTemplate>
                                            <DataTemplate x:DataType="models:TagEvent">
                                                <Border
                                                    Padding="6,4"
                                                    BackgroundColor="#FF2A2A2A"
                                                    StrokeShape="RoundRectangle 4"
                                                    StrokeThickness="0">
                                                    <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="6">
                                                        <!--  Timestamp clickable  -->
                                                        <Border
                                                            Grid.Column="0"
                                                            Padding="5,2"
                                                            BackgroundColor="#FF3A3A3A"
                                                            StrokeShape="RoundRectangle 3"
                                                            StrokeThickness="0">
                                                            <Border.GestureRecognizers>
                                                                <TapGestureRecognizer
                                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SeekToTagEventCommand}"
                                                                    CommandParameter="{Binding .}" />
                                                            </Border.GestureRecognizers>
                                                            <HorizontalStackLayout Spacing="3">
                                                                <controls:SymbolIcon
                                                                    HeightRequest="{StaticResource IconSizeXSmall}"
                                                                    SymbolName="play.fill"
                                                                    TintColor="#FFAAAAAA"
                                                                    WidthRequest="{StaticResource IconSizeXSmall}" />
                                                                <Label
                                                                    Text="{Binding TimestampFormatted}"
                                                                    FontSize="{StaticResource FontSizeCaption}"
                                                                    FontAttributes="Bold"
                                                                    TextColor="#FFAAAAAA" />
                                                            </HorizontalStackLayout>
                                                        </Border>

                                                        <!--  Nombre del tag (naranja para eventos)  -->
                                                        <Border
                                                            Grid.Column="1"
                                                            Padding="6,2"
                                                            BackgroundColor="#FFFF7043"
                                                            StrokeShape="RoundRectangle 8"
                                                            StrokeThickness="0"
                                                            HorizontalOptions="Start">
                                                            <Label
                                                                Text="{Binding TagName}"
                                                                FontSize="{StaticResource FontSizeCaption}"
                                                                TextColor="White"
                                                                MaximumWidthRequest="160"
                                                                LineBreakMode="TailTruncation" />
                                                        </Border>

                                                        <!--  Botón eliminar  -->
                                                        <Border
                                                            Grid.Column="2"
                                                            Padding="4"
                                                            BackgroundColor="#44FF5555"
                                                            StrokeShape="RoundRectangle 3"
                                                            StrokeThickness="0">
                                                            <Border.GestureRecognizers>
                                                                <TapGestureRecognizer
                                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeleteTagEventCommand}"
                                                                    CommandParameter="{Binding .}" />
                                                            </Border.GestureRecognizers>
                                                            <controls:SymbolIcon
                                                                HeightRequest="{StaticResource IconSizeXSmall}"
                                                                SymbolName="trash.fill"
                                                                TintColor="#FFFF6B6B"
                                                                WidthRequest="{StaticResource IconSizeXSmall}" />
                                                        </Border>
                                                    </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </BindableLayout.ItemTemplate>
                                    </VerticalStackLayout>
                                </VerticalStackLayout>
                            </VerticalStackLayout>
                        </ScrollView>
                    </Grid>
                </Border>
                
                <!-- Cabecera con título y contador de galería -->
                <Border
                    Grid.Row="1"
                    Padding="12,10"
                    BackgroundColor="#FF252525"
                    StrokeThickness="0">
                    <Grid RowDefinitions="Auto,Auto" RowSpacing="8">
                        <Grid Grid.Row="0" ColumnDefinitions="*,Auto">
                            <Label
                                Grid.Column="0"
                                FontAttributes="Bold"
                                FontSize="{StaticResource FontSizeBody}"
                                Text="Videos de la sesión"
                                TextColor="White"
                                VerticalOptions="Center" />
                            <Border
                                Grid.Column="1"
                                Padding="8,4"
                                BackgroundColor="#FF3A3A3A"
                                StrokeShape="RoundRectangle 10"
                                StrokeThickness="0">
                                <Label
                                    FontSize="{StaticResource FontSizeSmall}"
                                    Text="{Binding PlaylistCount}"
                                    TextColor="#FFB1B1B1"
                                    VerticalOptions="Center" />
                            </Border>
                        </Grid>
                        
                        <!-- Indicador de selección de video para comparación -->
                        <Border
                            Grid.Row="1"
                            Padding="8,6"
                            BackgroundColor="#FF9C27B0"
                            StrokeShape="RoundRectangle 6"
                            StrokeThickness="0"
                            IsVisible="{Binding IsSelectingComparisonVideo}">
                            <HorizontalStackLayout Spacing="8" HorizontalOptions="Center">
                                <controls:SymbolIcon
                                    HeightRequest="14"
                                    WidthRequest="14"
                                    SymbolName="hand.point.up.left"
                                    TintColor="White" />
                                <Label
                                    FontSize="{StaticResource FontSizeSmall}"
                                    Text="{Binding SelectedComparisonSlot, StringFormat='Selecciona video para slot {0}'}"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>
                    </Grid>
                </Border>
                
                <!-- Lista de videos -->
                <CollectionView
                    x:Name="PlaylistGallery"
                    Grid.Row="2"
                    ItemsSource="{Binding PlaylistVideos}"
                    SelectionMode="None"
                    Margin="0">
                    <CollectionView.ItemsLayout>
                        <LinearItemsLayout 
                            Orientation="Vertical"
                            ItemSpacing="2" />
                    </CollectionView.ItemsLayout>
                    
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:VideoClip">
                            <Border
                                Padding="8"
                                BackgroundColor="Transparent"
                                StrokeThickness="0">
                                <Border.Behaviors>
                                    <behaviors:HoverBackgroundBehavior />
                                </Border.Behaviors>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer 
                                        Command="{Binding Source={x:Reference ThisPage}, Path=BindingContext.SelectGalleryVideoCommand}" 
                                        CommandParameter="{Binding .}" />
                                    <DragGestureRecognizer
                                        CanDrag="True"
                                        DragStarting="OnVideoDragStarting" />
                                </Border.GestureRecognizers>
                                <Border.Triggers>
                                    <DataTrigger TargetType="Border" Binding="{Binding IsCurrentlyPlaying}" Value="True">
                                        <Setter Property="BackgroundColor" Value="#FF2A2A2A" />
                                    </DataTrigger>
                                </Border.Triggers>
                                
                                <Grid ColumnDefinitions="Auto,*" ColumnSpacing="10">
                                    <!-- Thumbnail -->
                                    <Border
                                        Grid.Column="0"
                                        WidthRequest="80"
                                        HeightRequest="45"
                                        StrokeShape="RoundRectangle 4"
                                        StrokeThickness="0">
                                        <Grid>
                                            <Image
                                                Aspect="AspectFill"
                                                BackgroundColor="{StaticResource Gray300}"
                                                Source="{Binding LocalThumbnailPath}" />
                                            <!-- Indicador de reproducción actual -->
                                            <Border
                                                BackgroundColor="#CC000000"
                                                IsVisible="{Binding IsCurrentlyPlaying}"
                                                HorizontalOptions="Fill"
                                                VerticalOptions="Fill">
                                                <controls:SymbolIcon
                                                    HeightRequest="20"
                                                    WidthRequest="20"
                                                    SymbolName="play.fill"
                                                    TintColor="#FFAAAAAA"
                                                    HorizontalOptions="Center"
                                                    VerticalOptions="Center" />
                                            </Border>
                                        </Grid>
                                    </Border>
                                    
                                    <!-- Info del video -->
                                    <VerticalStackLayout Grid.Column="1" Spacing="2" VerticalOptions="Center">
                                        <Label
                                            FontSize="{StaticResource FontSizeSmall}"
                                            LineBreakMode="TailTruncation"
                                            MaxLines="1"
                                            Text="{Binding DisplayLine1}"
                                            TextColor="White" />
                                        <Label
                                            FontSize="{StaticResource FontSizeCaption}"
                                            LineBreakMode="TailTruncation"
                                            MaxLines="1"
                                            Text="{Binding DisplayLine2}"
                                            TextColor="#FF888888" />
                                    </VerticalStackLayout>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                    
                    <CollectionView.EmptyView>
                        <VerticalStackLayout
                            HorizontalOptions="Center"
                            VerticalOptions="Center"
                            Spacing="8"
                            Padding="20">
                            <controls:SymbolIcon
                                HeightRequest="32"
                                WidthRequest="32"
                                SymbolName="film"
                                TintColor="#FF555555"
                                HorizontalOptions="Center" />
                            <Label
                                FontSize="{StaticResource FontSizeSmall}"
                                Text="No hay videos"
                                TextColor="#FF555555"
                                HorizontalOptions="Center" />
                        </VerticalStackLayout>
                    </CollectionView.EmptyView>
                </CollectionView>
                
                <!-- ===================== FOOTER DE NAVEGACIÓN (Row 3) ===================== -->
                <VerticalStackLayout Grid.Row="3" Spacing="8" Padding="12,12,12,8">
                    <BoxView HeightRequest="1" BackgroundColor="#FF3A3A3A" Margin="0,0,0,4" />
                    
                    <Label
                        FontSize="{StaticResource FontSizeSidebarMenu}"
                        Text="{Binding PlaylistPositionText}"
                        TextColor="White"
                        HorizontalOptions="Center" />
                    
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="8">
                        <!-- Anterior -->
                        <Border
                            Grid.Column="0"
                            BackgroundColor="#FF2A2A2A"
                            IsEnabled="{Binding CanGoPrevious}"
                            Opacity="{Binding CanGoPrevious, Converter={StaticResource BoolToOpacityConverter}}"
                            StrokeShape="RoundRectangle 6"
                            StrokeThickness="0">
                            <Border.Padding>
                                <OnPlatform x:TypeArguments="Thickness">
                                    <On Platform="iOS" Value="10,8,10,8" />
                                    <On Platform="Default" Value="10,6,10,6" />
                                </OnPlatform>
                            </Border.Padding>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding PreviousVideoCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="8" HorizontalOptions="Center">
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeSidebarMenu}"
                                    SymbolName="chevron.left"
                                    TintColor="White"
                                    WidthRequest="{StaticResource IconSizeSidebarMenu}" />
                                <Label
                                    FontSize="{StaticResource FontSizeSidebarMenu}"
                                    Text="Anterior"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>
                        
                        <!-- Siguiente -->
                        <Border
                            Grid.Column="1"
                            BackgroundColor="#FF2A2A2A"
                            IsEnabled="{Binding CanGoNext}"
                            Opacity="{Binding CanGoNext, Converter={StaticResource BoolToOpacityConverter}}"
                            StrokeShape="RoundRectangle 6"
                            StrokeThickness="0">
                            <Border.Padding>
                                <OnPlatform x:TypeArguments="Thickness">
                                    <On Platform="iOS" Value="10,8,10,8" />
                                    <On Platform="Default" Value="10,6,10,6" />
                                </OnPlatform>
                            </Border.Padding>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding NextVideoCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="8" HorizontalOptions="Center">
                                <Label
                                    FontSize="{StaticResource FontSizeSidebarMenu}"
                                    Text="Siguiente"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeSidebarMenu}"
                                    SymbolName="chevron.right"
                                    TintColor="White"
                                    WidthRequest="{StaticResource IconSizeSidebarMenu}" />
                            </HorizontalStackLayout>
                        </Border>
                    </Grid>
                    
                    <!-- Botón Filtros -->
                    <Border
                        BackgroundColor="#FF2A2A2A"
                        StrokeShape="RoundRectangle 6"
                        StrokeThickness="0">
                        <Border.Padding>
                            <OnPlatform x:TypeArguments="Thickness">
                                <On Platform="iOS" Value="10,8,10,8" />
                                <On Platform="Default" Value="10,6,10,6" />
                            </OnPlatform>
                        </Border.Padding>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding ToggleFiltersCommand}" />
                        </Border.GestureRecognizers>
                        <HorizontalStackLayout Spacing="8" HorizontalOptions="Center">
                            <controls:SymbolIcon
                                HeightRequest="{StaticResource IconSizeSidebarMenu}"
                                SymbolName="line.3.horizontal.decrease"
                                TintColor="#FFAAAAAA"
                                WidthRequest="{StaticResource IconSizeSidebarMenu}" />
                            <Label
                                FontSize="{StaticResource FontSizeSidebarMenu}"
                                Text="Filtros"
                                TextColor="#FFAAAAAA"
                                VerticalOptions="Center" />
                        </HorizontalStackLayout>
                    </Border>
                    
                    <!-- Panel de filtros expandible -->
                    <VerticalStackLayout
                        IsVisible="{Binding ShowFilters}"
                        Spacing="6">
                        
                        <!-- Filtro de atleta -->
                        <Border
                            x:Name="AthleteDropdownWin"
                            BackgroundColor="#FF2A2A2A"
                            StrokeShape="RoundRectangle 6"
                            StrokeThickness="0">
                            <Border.Padding>
                                <OnPlatform x:TypeArguments="Thickness">
                                    <On Platform="iOS" Value="10,8,10,8" />
                                    <On Platform="Default" Value="10,6,10,6" />
                                </OnPlatform>
                            </Border.Padding>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnAthleteDropdownTapped" />
                            </Border.GestureRecognizers>
                            <Grid ColumnDefinitions="*,Auto">
                                <Label
                                    Grid.Column="0"
                                    FontSize="{StaticResource FontSizeSidebarMenu}"
                                    Text="{Binding SelectedAthlete.DisplayName, FallbackValue='Atleta'}"
                                    TextColor="White"
                                    VerticalOptions="Center"
                                    LineBreakMode="TailTruncation" />
                                <controls:SymbolIcon
                                    Grid.Column="1"
                                    HeightRequest="{StaticResource IconSizeSidebarMenu}"
                                    SymbolName="chevron.down"
                                    TintColor="#FF888888"
                                    WidthRequest="{StaticResource IconSizeSidebarMenu}" />
                            </Grid>
                        </Border>
                        
                        <!-- Filtro de sección -->
                        <Border
                            x:Name="SectionDropdownWin"
                            BackgroundColor="#FF2A2A2A"
                            StrokeShape="RoundRectangle 6"
                            StrokeThickness="0">
                            <Border.Padding>
                                <OnPlatform x:TypeArguments="Thickness">
                                    <On Platform="iOS" Value="10,8,10,8" />
                                    <On Platform="Default" Value="10,6,10,6" />
                                </OnPlatform>
                            </Border.Padding>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnSectionDropdownTapped" />
                            </Border.GestureRecognizers>
                            <Grid ColumnDefinitions="*,Auto">
                                <Label
                                    Grid.Column="0"
                                    FontSize="{StaticResource FontSizeSidebarMenu}"
                                    Text="{Binding SelectedSection.DisplayName, FallbackValue='Sección'}"
                                    TextColor="White"
                                    VerticalOptions="Center"
                                    LineBreakMode="TailTruncation" />
                                <controls:SymbolIcon
                                    Grid.Column="1"
                                    HeightRequest="{StaticResource IconSizeSidebarMenu}"
                                    SymbolName="chevron.down"
                                    TintColor="#FF888888"
                                    WidthRequest="{StaticResource IconSizeSidebarMenu}" />
                            </Grid>
                        </Border>
                        
                        <!-- Filtro de categoría -->
                        <Border
                            x:Name="CategoryDropdownWin"
                            BackgroundColor="#FF2A2A2A"
                            StrokeShape="RoundRectangle 6"
                            StrokeThickness="0">
                            <Border.Padding>
                                <OnPlatform x:TypeArguments="Thickness">
                                    <On Platform="iOS" Value="10,8,10,8" />
                                    <On Platform="Default" Value="10,6,10,6" />
                                </OnPlatform>
                            </Border.Padding>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnCategoryDropdownTapped" />
                            </Border.GestureRecognizers>
                            <Grid ColumnDefinitions="*,Auto">
                                <Label
                                    Grid.Column="0"
                                    FontSize="{StaticResource FontSizeSidebarMenu}"
                                    Text="{Binding SelectedCategory.DisplayName, FallbackValue='Categoría'}"
                                    TextColor="White"
                                    VerticalOptions="Center"
                                    LineBreakMode="TailTruncation" />
                                <controls:SymbolIcon
                                    Grid.Column="1"
                                    HeightRequest="{StaticResource IconSizeSidebarMenu}"
                                    SymbolName="chevron.down"
                                    TintColor="#FF888888"
                                    WidthRequest="{StaticResource IconSizeSidebarMenu}" />
                            </Grid>
                        </Border>
                        
                        <!-- Botón limpiar filtros -->
                        <Border
                            BackgroundColor="#FF3A3A3A"
                            StrokeShape="RoundRectangle 6"
                            StrokeThickness="0">
                            <Border.Padding>
                                <OnPlatform x:TypeArguments="Thickness">
                                    <On Platform="iOS" Value="10,8,10,8" />
                                    <On Platform="Default" Value="10,6,10,6" />
                                </OnPlatform>
                            </Border.Padding>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ClearFiltersCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="8" HorizontalOptions="Center">
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeSidebarMenu}"
                                    SymbolName="xmark"
                                    TintColor="#FFB1B1B1"
                                    WidthRequest="{StaticResource IconSizeSidebarMenu}" />
                                <Label
                                    FontSize="{StaticResource FontSizeSidebarMenu}"
                                    Text="Limpiar filtros"
                                    TextColor="#FFB1B1B1"
                                    VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>
                    </VerticalStackLayout>
                </VerticalStackLayout>
            </Grid>
        </Border>

        <!--  Área del vídeo (Columna 2, ocupa Row 0-2 en Windows/Mac - configurado en code-behind)  -->
        <Border
            x:Name="VideoAreaBorder"
            Grid.Row="0"
            Grid.Column="2"
            Grid.RowSpan="1"
            Margin="0,0,0,0"
            BackgroundColor="#FF121212"
            Stroke="#FF3A3A3A"
            StrokeShape="RoundRectangle 8"
            StrokeThickness="0">
            
            <!-- Grid contenedor para layouts de comparación -->
            <Grid x:Name="ComparisonGrid">
                <!-- Video principal (siempre visible, posición configurable según layout) -->
                <Grid x:Name="VideoSlot1" Grid.Row="0" Grid.Column="0">
                    <Grid.GestureRecognizers>
                        <PointerGestureRecognizer
                            PointerEntered="OnVideoSlot1PointerEntered"
                            PointerExited="OnVideoSlot1PointerExited" />
                    </Grid.GestureRecognizers>
                    <precision:PrecisionVideoPlayer
                        x:Name="MediaPlayer"
                        Aspect="{Binding VideoAspect}"
                        IsMuted="{Binding IsMuted}"
                        Duration="{Binding Duration, Mode=OneWayToSource}"
                        Position="{Binding CurrentPosition, Mode=OneWayToSource}"
                        Source="{Binding VideoPath}" />
                    
                    <!--  Overlay transparente para capturar gestos de scrubbing (trackpad/mouse wheel)  -->
                    <BoxView
                        x:Name="ScrubOverlay"
                        BackgroundColor="Transparent"
                        InputTransparent="False">
                        <BoxView.Behaviors>
                            <behaviors:VideoScrubBehavior VideoIndex="0" />
                        </BoxView.Behaviors>
                    </BoxView>

                    <!-- Overlay de dibujo para análisis técnico (solo interactivo cuando el modo dibujo está activo) -->
                    <controls:AnalysisDrawingView
                        x:Name="AnalysisCanvas"
                        InputTransparent="True" />
                    
                    <!-- Indicador de video 1 (solo visible en modo multi-video) -->
                    <Border
                        Margin="8"
                        Padding="6,3"
                        BackgroundColor="#CC000000"
                        HorizontalOptions="Start"
                        VerticalOptions="Start"
                        StrokeShape="RoundRectangle 4"
                        StrokeThickness="0"
                        IsVisible="{Binding IsMultiVideoLayout}">
                        <Label Text="1" FontSize="12" FontAttributes="Bold" TextColor="White" />
                    </Border>
                    
                    <!-- Slider individual con hover (solo en modo comparación) -->
                    <Border
                        x:Name="SliderOverlay1"
                        Margin="16,0"
                        Padding="12,8"
                        BackgroundColor="#CC000000"
                        HorizontalOptions="Fill"
                        VerticalOptions="End"
                        StrokeShape="RoundRectangle 8"
                        StrokeThickness="0"
                        IsVisible="False">
                        <Slider
                            x:Name="IndividualSlider1"
                            Maximum="1"
                            MaximumTrackColor="#FF3A3A3A"
                            Minimum="0"
                            MinimumTrackColor="#FF5A5A5A"
                            ThumbColor="#FF8A8A8A"
                            ValueChanged="OnIndividualSlider1Changed" />
                    </Border>
                </Grid>
                
                <!-- Slot 2: Video de comparación o placeholder -->
                <Grid x:Name="VideoSlot2" Grid.Row="0" Grid.Column="1" IsVisible="False">
                    <Grid.GestureRecognizers>
                        <PointerGestureRecognizer
                            PointerEntered="OnVideoSlot2PointerEntered"
                            PointerExited="OnVideoSlot2PointerExited" />
                    </Grid.GestureRecognizers>
                    <!-- Placeholder cuando no hay video asignado -->
                    <Border
                        x:Name="DropZone2"
                        BackgroundColor="#FF1A1A1A"
                        IsVisible="{Binding HasComparisonVideo2, Converter={StaticResource InvertedBoolConverter}}">
                        <Border.GestureRecognizers>
                            <DropGestureRecognizer
                                AllowDrop="True"
                                DragOver="OnVideoDragOver"
                                DragLeave="OnVideoDragLeave"
                                Drop="OnVideoDropSlot2" />
                        </Border.GestureRecognizers>
                        <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center" Spacing="12">
                            <Border
                                Padding="16"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 40"
                                StrokeThickness="0">
                                <controls:SymbolIcon
                                    HeightRequest="40"
                                    WidthRequest="40"
                                    SymbolName="plus"
                                    TintColor="#FF888888" />
                            </Border>
                            <Label Text="Arrastra un video aquí" FontSize="14" TextColor="#FF888888" HorizontalOptions="Center" />
                        </VerticalStackLayout>
                    </Border>
                    
                    <!-- Video cuando está asignado -->
                    <precision:PrecisionVideoPlayer
                        x:Name="MediaPlayer2"
                        IsVisible="{Binding HasComparisonVideo2}"
                        Aspect="{Binding VideoAspect}"
                        IsMuted="True"
                        Source="{Binding ComparisonVideo2Path}" />
                    
                    <!-- Overlay para scrubbing del video 2 -->
                    <BoxView
                        x:Name="ScrubOverlay2"
                        BackgroundColor="Transparent"
                        InputTransparent="False"
                        IsVisible="{Binding HasComparisonVideo2}">
                        <BoxView.Behaviors>
                            <behaviors:VideoScrubBehavior VideoIndex="2" />
                        </BoxView.Behaviors>
                    </BoxView>
                    
                    <!-- Botón para eliminar video -->
                    <Border
                        Margin="8"
                        Padding="6"
                        BackgroundColor="#CC000000"
                        HorizontalOptions="End"
                        VerticalOptions="Start"
                        StrokeShape="RoundRectangle 4"
                        StrokeThickness="0"
                        IsVisible="{Binding HasComparisonVideo2}">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding ClearComparisonSlotCommand}" CommandParameter="2" />
                        </Border.GestureRecognizers>
                        <controls:SymbolIcon HeightRequest="14" WidthRequest="14" SymbolName="xmark" TintColor="White" />
                    </Border>
                    
                    <!-- Indicador de video 2 -->
                    <Border
                        Margin="8"
                        Padding="6,3"
                        BackgroundColor="#CC000000"
                        HorizontalOptions="Start"
                        VerticalOptions="Start"
                        StrokeShape="RoundRectangle 4"
                        StrokeThickness="0">
                        <Label Text="2" FontSize="12" FontAttributes="Bold" TextColor="White" />
                    </Border>
                    
                    <!-- Slider individual con hover -->
                    <Border
                        x:Name="SliderOverlay2"
                        Margin="16,0"
                        Padding="12,8"
                        BackgroundColor="#CC000000"
                        HorizontalOptions="Fill"
                        VerticalOptions="End"
                        StrokeShape="RoundRectangle 8"
                        StrokeThickness="0"
                        IsVisible="False">
                        <Slider
                            x:Name="IndividualSlider2"
                            Maximum="1"
                            MaximumTrackColor="#FF3A3A3A"
                            Minimum="0"
                            MinimumTrackColor="#FF5A5A5A"
                            ThumbColor="#FF8A8A8A"
                            ValueChanged="OnIndividualSlider2Changed" />
                    </Border>
                </Grid>
                
                <!-- Slot 3: Video de comparación o placeholder (para layouts 1x2 y 2x2) -->
                <Grid x:Name="VideoSlot3" Grid.Row="1" Grid.Column="0" IsVisible="False">
                    <Grid.GestureRecognizers>
                        <PointerGestureRecognizer
                            PointerEntered="OnVideoSlot3PointerEntered"
                            PointerExited="OnVideoSlot3PointerExited" />
                    </Grid.GestureRecognizers>
                    <!-- Placeholder cuando no hay video asignado -->
                    <Border
                        x:Name="DropZone3"
                        BackgroundColor="#FF1A1A1A"
                        IsVisible="{Binding HasComparisonVideo3, Converter={StaticResource InvertedBoolConverter}}">
                        <Border.GestureRecognizers>
                            <DropGestureRecognizer
                                AllowDrop="True"
                                DragOver="OnVideoDragOver"
                                DragLeave="OnVideoDragLeave"
                                Drop="OnVideoDropSlot3" />
                        </Border.GestureRecognizers>
                        <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center" Spacing="12">
                            <Border
                                Padding="16"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 40"
                                StrokeThickness="0">
                                <controls:SymbolIcon
                                    HeightRequest="40"
                                    WidthRequest="40"
                                    SymbolName="plus"
                                    TintColor="#FF888888" />
                            </Border>
                            <Label Text="Arrastra un video aquí" FontSize="14" TextColor="#FF888888" HorizontalOptions="Center" />
                        </VerticalStackLayout>
                    </Border>
                    
                    <!-- Video cuando está asignado -->
                    <precision:PrecisionVideoPlayer
                        x:Name="MediaPlayer3"
                        IsVisible="{Binding HasComparisonVideo3}"
                        Aspect="{Binding VideoAspect}"
                        IsMuted="True"
                        Source="{Binding ComparisonVideo3Path}" />
                    
                    <!-- Overlay para scrubbing del video 3 -->
                    <BoxView
                        x:Name="ScrubOverlay3"
                        BackgroundColor="Transparent"
                        InputTransparent="False"
                        IsVisible="{Binding HasComparisonVideo3}">
                        <BoxView.Behaviors>
                            <behaviors:VideoScrubBehavior VideoIndex="3" />
                        </BoxView.Behaviors>
                    </BoxView>
                    
                    <!-- Botón para eliminar video -->
                    <Border
                        Margin="8"
                        Padding="6"
                        BackgroundColor="#CC000000"
                        HorizontalOptions="End"
                        VerticalOptions="Start"
                        StrokeShape="RoundRectangle 4"
                        StrokeThickness="0"
                        IsVisible="{Binding HasComparisonVideo3}">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding ClearComparisonSlotCommand}" CommandParameter="3" />
                        </Border.GestureRecognizers>
                        <controls:SymbolIcon HeightRequest="14" WidthRequest="14" SymbolName="xmark" TintColor="White" />
                    </Border>
                    
                    <!-- Indicador de video 3 -->
                    <Border
                        Margin="8"
                        Padding="6,3"
                        BackgroundColor="#CC000000"
                        HorizontalOptions="Start"
                        VerticalOptions="Start"
                        StrokeShape="RoundRectangle 4"
                        StrokeThickness="0">
                        <Label Text="3" FontSize="12" FontAttributes="Bold" TextColor="White" />
                    </Border>
                    
                    <!-- Slider individual con hover -->
                    <Border
                        x:Name="SliderOverlay3"
                        Margin="16,0"
                        Padding="12,8"
                        BackgroundColor="#CC000000"
                        HorizontalOptions="Fill"
                        VerticalOptions="End"
                        StrokeShape="RoundRectangle 8"
                        StrokeThickness="0"
                        IsVisible="False">
                        <Slider
                            x:Name="IndividualSlider3"
                            Maximum="1"
                            MaximumTrackColor="#FF3A3A3A"
                            Minimum="0"
                            MinimumTrackColor="#FF5A5A5A"
                            ThumbColor="#FF8A8A8A"
                            ValueChanged="OnIndividualSlider3Changed" />
                    </Border>
                </Grid>
                
                <!-- Slot 4: Video de comparación o placeholder (solo para layout 2x2) -->
                <Grid x:Name="VideoSlot4" Grid.Row="1" Grid.Column="1" IsVisible="False">
                    <Grid.GestureRecognizers>
                        <PointerGestureRecognizer
                            PointerEntered="OnVideoSlot4PointerEntered"
                            PointerExited="OnVideoSlot4PointerExited" />
                    </Grid.GestureRecognizers>
                    <!-- Placeholder cuando no hay video asignado -->
                    <Border
                        x:Name="DropZone4"
                        BackgroundColor="#FF1A1A1A"
                        IsVisible="{Binding HasComparisonVideo4, Converter={StaticResource InvertedBoolConverter}}">
                        <Border.GestureRecognizers>
                            <DropGestureRecognizer
                                AllowDrop="True"
                                DragOver="OnVideoDragOver"
                                DragLeave="OnVideoDragLeave"
                                Drop="OnVideoDropSlot4" />
                        </Border.GestureRecognizers>
                        <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center" Spacing="12">
                            <Border
                                Padding="16"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 40"
                                StrokeThickness="0">
                                <controls:SymbolIcon
                                    HeightRequest="40"
                                    WidthRequest="40"
                                    SymbolName="plus"
                                    TintColor="#FF888888" />
                            </Border>
                            <Label Text="Arrastra un video aquí" FontSize="14" TextColor="#FF888888" HorizontalOptions="Center" />
                        </VerticalStackLayout>
                    </Border>
                    
                    <!-- Video cuando está asignado -->
                    <precision:PrecisionVideoPlayer
                        x:Name="MediaPlayer4"
                        IsVisible="{Binding HasComparisonVideo4}"
                        Aspect="{Binding VideoAspect}"
                        IsMuted="True"
                        Source="{Binding ComparisonVideo4Path}" />
                    
                    <!-- Overlay para scrubbing del video 4 -->
                    <BoxView
                        x:Name="ScrubOverlay4"
                        BackgroundColor="Transparent"
                        InputTransparent="False"
                        IsVisible="{Binding HasComparisonVideo4}">
                        <BoxView.Behaviors>
                            <behaviors:VideoScrubBehavior VideoIndex="4" />
                        </BoxView.Behaviors>
                    </BoxView>
                    
                    <!-- Botón para eliminar video -->
                    <Border
                        Margin="8"
                        Padding="6"
                        BackgroundColor="#CC000000"
                        HorizontalOptions="End"
                        VerticalOptions="Start"
                        StrokeShape="RoundRectangle 4"
                        StrokeThickness="0"
                        IsVisible="{Binding HasComparisonVideo4}">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding ClearComparisonSlotCommand}" CommandParameter="4" />
                        </Border.GestureRecognizers>
                        <controls:SymbolIcon HeightRequest="14" WidthRequest="14" SymbolName="xmark" TintColor="White" />
                    </Border>
                    
                    <!-- Indicador de video 4 -->
                    <Border
                        Margin="8"
                        Padding="6,3"
                        BackgroundColor="#CC000000"
                        HorizontalOptions="Start"
                        VerticalOptions="Start"
                        StrokeShape="RoundRectangle 4"
                        StrokeThickness="0">
                        <Label Text="4" FontSize="12" FontAttributes="Bold" TextColor="White" />
                    </Border>
                    
                    <!-- Slider individual con hover -->
                    <Border
                        x:Name="SliderOverlay4"
                        Margin="16,0"
                        Padding="12,8"
                        BackgroundColor="#CC000000"
                        HorizontalOptions="Fill"
                        VerticalOptions="End"
                        StrokeShape="RoundRectangle 8"
                        StrokeThickness="0"
                        IsVisible="False">
                        <Slider
                            x:Name="IndividualSlider4"
                            Maximum="1"
                            MaximumTrackColor="#FF3A3A3A"
                            Minimum="0"
                            MinimumTrackColor="#FF5A5A5A"
                            ThumbColor="#FF8A8A8A"
                            ValueChanged="OnIndividualSlider4Changed" />
                    </Border>
                </Grid>
                
                
                
                <!--  Barra de botones de edición (esquina superior derecha) - Solo para iOS/MacCatalyst  -->
                <Border
                    x:Name="ToolbarOverlay"
                    BackgroundColor="#CC000000"
                    HorizontalOptions="End"
                    StrokeShape="RoundRectangle 8"
                    StrokeThickness="0"
                    VerticalOptions="Start">
                    <Border.IsVisible>
                        <OnPlatform x:TypeArguments="x:Boolean">
                            <On Platform="WinUI,MacCatalyst" Value="False" />
                            <On Platform="Default" Value="True" />
                        </OnPlatform>
                    </Border.IsVisible>
                    <Border.Margin>
                        <OnPlatform x:TypeArguments="Thickness">
                            <On Platform="WinUI,MacCatalyst" Value="8" />
                            <On Platform="Default" Value="16" />
                        </OnPlatform>
                    </Border.Margin>
                    <Border.Padding>
                        <OnPlatform x:TypeArguments="Thickness">
                            <On Platform="WinUI,MacCatalyst" Value="12,2,12,2" />
                            <On Platform="Default" Value="8" />
                        </OnPlatform>
                    </Border.Padding>
                    <HorizontalStackLayout Spacing="4">

                        <!-- Videolección (toggle start/stop) - separado del resto -->
                        <Border
                            x:Name="VideoLessonRecordButton"
                            WidthRequest="{StaticResource ElementHeightLarge}"
                            HeightRequest="{StaticResource ElementHeightLarge}"
                            Padding="0"
                            BackgroundColor="#FF2A2A2A"
                            StrokeShape="RoundRectangle 22"
                            StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnToggleVideoLessonTapped" />
                            </Border.GestureRecognizers>
                            <Grid>
                                <controls:SymbolIcon
                                    x:Name="VideoLessonRecordIcon"
                                    WidthRequest="{StaticResource IconSizeDefault}"
                                    HeightRequest="{StaticResource IconSizeDefault}"
                                    SymbolName="record.circle"
                                    TintColor="White"
                                    HorizontalOptions="Center"
                                    VerticalOptions="Center" />
                            </Grid>
                        </Border>

                        <!-- Cronómetro de grabación -->
                        <Border
                            x:Name="RecordingTimerBorder"
                            Padding="8,4"
                            BackgroundColor="#CCFF3B30"
                            IsVisible="False"
                            StrokeShape="RoundRectangle 12"
                            StrokeThickness="0"
                            VerticalOptions="Center">
                            <HorizontalStackLayout Spacing="6">
                                <Ellipse
                                    WidthRequest="8"
                                    HeightRequest="8"
                                    Fill="#FFFF3B30"
                                    VerticalOptions="Center" />
                                <Label
                                    x:Name="RecordingTimerLabel"
                                    FontFamily="{StaticResource AppFontBody}"
                                    FontSize="{StaticResource FontSizeBody}"
                                    FontAttributes="Bold"
                                    Text="00:00"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>

                        <!-- Opciones Videolección (cámara / micrófono) -->
                        <Border
                            x:Name="VideoLessonOptionsPanel"
                            Margin="6,0,0,0"
                            Padding="6"
                            BackgroundColor="#EE1E1E1E"
                            IsVisible="True"
                            StrokeShape="RoundRectangle 10"
                            StrokeThickness="0"
                            VerticalOptions="Center">
                            <HorizontalStackLayout Spacing="6">
                                <Border
                                    x:Name="VideoLessonCameraToggle"
                                    WidthRequest="{StaticResource ElementHeightDefault}"
                                    HeightRequest="{StaticResource ElementHeightDefault}"
                                    Padding="0"
                                    BackgroundColor="#FF2A2A2A"
                                    StrokeShape="RoundRectangle 17"
                                    StrokeThickness="0">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Tapped="OnVideoLessonCameraToggleTapped" />
                                    </Border.GestureRecognizers>
                                    <Grid>
                                        <controls:SymbolIcon
                                            x:Name="VideoLessonCameraToggleIcon"
                                            WidthRequest="{StaticResource IconSizeMedium}"
                                            HeightRequest="{StaticResource IconSizeMedium}"
                                            SymbolName="video.fill"
                                            TintColor="White"
                                            HorizontalOptions="Center"
                                            VerticalOptions="Center" />
                                    </Grid>
                                </Border>

                                <Border
                                    x:Name="VideoLessonMicToggle"
                                    WidthRequest="{StaticResource ElementHeightDefault}"
                                    HeightRequest="{StaticResource ElementHeightDefault}"
                                    Padding="0"
                                    BackgroundColor="#FF2A2A2A"
                                    StrokeShape="RoundRectangle 17"
                                    StrokeThickness="0">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Tapped="OnVideoLessonMicToggleTapped" />
                                    </Border.GestureRecognizers>
                                    <Grid>
                                        <controls:SymbolIcon
                                            x:Name="VideoLessonMicToggleIcon"
                                            WidthRequest="{StaticResource IconSizeMedium}"
                                            HeightRequest="{StaticResource IconSizeMedium}"
                                            SymbolName="mic.fill"
                                            TintColor="White"
                                            HorizontalOptions="Center"
                                            VerticalOptions="Center" />
                                    </Grid>
                                </Border>
                            </HorizontalStackLayout>
                        </Border>

                        <BoxView WidthRequest="1" BackgroundColor="#FF555555" Margin="6,4" />

                        <!--  Botón Asignar Atleta  -->
                        <Border
                            Padding="8,6"
                            BackgroundColor="Transparent"
                            StrokeShape="RoundRectangle 6"
                            StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ToggleAthleteAssignPanelCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="6">
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeMedium}"
                                    SymbolName="person.badge.plus"
                                    TintColor="White"
                                    WidthRequest="{StaticResource IconSizeMedium}" />
                                <Label
                                    FontSize="{StaticResource FontSizeBody}"
                                    Text="Atleta"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>
                        
                        <BoxView WidthRequest="1" BackgroundColor="#FF555555" Margin="4,4" />
                        
                        <!--  Botón Asignar Sección  -->
                        <Border
                            Padding="8,6"
                            BackgroundColor="Transparent"
                            StrokeShape="RoundRectangle 6"
                            StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ToggleSectionAssignPanelCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="6">
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeMedium}"
                                    SymbolName="arrow.triangle.branch"
                                    TintColor="White"
                                    WidthRequest="{StaticResource IconSizeMedium}" />
                                <Label
                                    FontSize="{StaticResource FontSizeBody}"
                                    Text="Tramo"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>
                        
                        <BoxView WidthRequest="1" BackgroundColor="#FF555555" Margin="4,4" />
                        
                        <!--  Botón Asignar Etiquetas  -->
                        <Border
                            Padding="8,6"
                            BackgroundColor="Transparent"
                            StrokeShape="RoundRectangle 6"
                            StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ToggleTagsAssignPanelCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="6">
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeMedium}"
                                    SymbolName="tag.fill"
                                    TintColor="White"
                                    WidthRequest="{StaticResource IconSizeMedium}" />
                                <Label
                                    FontSize="{StaticResource FontSizeBody}"
                                    Text="Etiquetas"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>
                        
                        <BoxView WidthRequest="1" BackgroundColor="#FF555555" Margin="4,4" />
                        
                        <!--  Botón Eventos (etiquetas con timestamps)  -->
                        <Border
                            Padding="8,6"
                            BackgroundColor="Transparent"
                            StrokeShape="RoundRectangle 6"
                            StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ToggleTagEventsPanelCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="6">
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeMedium}"
                                    SymbolName="clock.badge.checkmark"
                                    TintColor="White"
                                    WidthRequest="{StaticResource IconSizeMedium}" />
                                <Label
                                    FontSize="{StaticResource FontSizeBody}"
                                    Text="Eventos"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>

                        <BoxView WidthRequest="1" BackgroundColor="#FF555555" Margin="4,4" />

                        <!-- Botón Dibujo -->
                        <Border
                            Padding="8,6"
                            BackgroundColor="Transparent"
                            StrokeShape="RoundRectangle 6"
                            StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnToggleDrawingToolsTapped" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="6">
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeMedium}"
                                    SymbolName="pencil"
                                    TintColor="White"
                                    WidthRequest="{StaticResource IconSizeMedium}" />
                                <Label
                                    FontSize="{StaticResource FontSizeBody}"
                                    Text="Dibujar"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>

                        <BoxView WidthRequest="1" BackgroundColor="#FF555555" Margin="4,4" />

                        <!-- Botón Split Time (Medidor de tiempo) -->
                        <Border
                            Padding="8,6"
                            BackgroundColor="Transparent"
                            StrokeShape="RoundRectangle 6"
                            StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ToggleSplitTimePanelCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="6">
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeMedium}"
                                    SymbolName="timer"
                                    TintColor="White"
                                    WidthRequest="16" />
                                <Label
                                    FontSize="{StaticResource FontSizeBody}"
                                    Text="Split"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>

                    </HorizontalStackLayout>
                </Border>

                <!-- Barra de herramientas de dibujo (pequeña) -->
                <Border
                    x:Name="DrawingToolsPanel"
                    Margin="16,100,16,16"
                    Padding="10"
                    BackgroundColor="#EE1E1E1E"
                    HorizontalOptions="End"
                    IsVisible="False"
                    StrokeShape="RoundRectangle 12"
                    StrokeThickness="0"
                    VerticalOptions="Start">
                    <VerticalStackLayout Spacing="8">
                        <!--  Título del panel con botón cerrar  -->
                        <Grid ColumnDefinitions="*,Auto">
                            <HorizontalStackLayout Spacing="6">
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeDefault}"
                                    SymbolName="scribble.variable"
                                    TintColor="#FF4CAF50"
                                    WidthRequest="{StaticResource IconSizeDefault}" />
                                <Label
                                    FontAttributes="Bold"
                                    FontSize="{StaticResource FontSizeSmall}"
                                    Text="Dibujar"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                            </HorizontalStackLayout>
                            <Border
                                Grid.Column="1"
                                Padding="4"
                                BackgroundColor="Transparent"
                                StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnToggleDrawingToolsTapped" />
                                </Border.GestureRecognizers>
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeMedium}"
                                    SymbolName="xmark.circle.fill"
                                    TintColor="#FF888888"
                                    WidthRequest="{StaticResource IconSizeMedium}" />
                            </Border>
                        </Grid>
                        
                        <HorizontalStackLayout Spacing="8">
                            <Border
                                x:Name="ToolStrokeButton"
                                Padding="10,6"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnSelectStrokeToolTapped" />
                                </Border.GestureRecognizers>
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeMedium}"
                                    WidthRequest="{StaticResource IconSizeMedium}"
                                    SymbolName="scribble"
                                    TintColor="White" />
                            </Border>

                            <Border
                                x:Name="ToolTextButton"
                                Padding="10,6"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnSelectTextToolTapped" />
                                </Border.GestureRecognizers>
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeMedium}"
                                    WidthRequest="{StaticResource IconSizeMedium}"
                                    SymbolName="textformat"
                                    TintColor="White" />
                            </Border>

                            <Border
                                x:Name="ToolShapeButton"
                                Padding="10,6"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnSelectShapeToolTapped" />
                                </Border.GestureRecognizers>
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeMedium}"
                                    WidthRequest="{StaticResource IconSizeMedium}"
                                    SymbolName="square.on.circle"
                                    TintColor="White" />
                            </Border>

                            <!-- Botón para desplegar opciones de tinta -->
                            <Border
                                x:Name="InkOptionsToggleButton"
                                Padding="10,6"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnToggleInkOptionsTapped" />
                                </Border.GestureRecognizers>
                                <HorizontalStackLayout Spacing="6" VerticalOptions="Center">
                                    <controls:SymbolIcon
                                        HeightRequest="{StaticResource IconSizeMedium}"
                                        WidthRequest="{StaticResource IconSizeMedium}"
                                        SymbolName="paintpalette"
                                        TintColor="White" />
                                    <Border
                                        x:Name="InkColorSwatch"
                                        HeightRequest="12"
                                        WidthRequest="12"
                                        BackgroundColor="#FFFF7043"
                                        StrokeShape="RoundRectangle 6"
                                        StrokeThickness="0"
                                        VerticalOptions="Center" />
                                </HorizontalStackLayout>
                            </Border>
                        </HorizontalStackLayout>

                        <!-- Opciones de tinta (panel expandible) -->
                        <Border
                            x:Name="InkOptionsPanel"
                            IsVisible="False"
                            Padding="8"
                            BackgroundColor="#FF2A2A2A"
                            StrokeShape="RoundRectangle 8"
                            StrokeThickness="0">
                            <VerticalStackLayout Spacing="8">
                                <HorizontalStackLayout x:Name="InkColorsRow" Spacing="8">
                                    <Border
                                        x:Name="InkColorOrangeButton"
                                        Padding="6"
                                        BackgroundColor="#FF2A2A2A"
                                        StrokeShape="RoundRectangle 6"
                                        StrokeThickness="0">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="OnSelectInkOrangeTapped" />
                                        </Border.GestureRecognizers>
                                        <Border
                                            HeightRequest="16"
                                            WidthRequest="16"
                                            BackgroundColor="#FFFF7043"
                                            StrokeShape="RoundRectangle 8"
                                            StrokeThickness="0" />
                                    </Border>

                                    <Border
                                        x:Name="InkColorWhiteButton"
                                        Padding="6"
                                        BackgroundColor="#FF2A2A2A"
                                        StrokeShape="RoundRectangle 6"
                                        StrokeThickness="0">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="OnSelectInkWhiteTapped" />
                                        </Border.GestureRecognizers>
                                        <Border
                                            HeightRequest="16"
                                            WidthRequest="16"
                                            BackgroundColor="White"
                                            StrokeShape="RoundRectangle 8"
                                            StrokeThickness="0" />
                                    </Border>

                                    <Border
                                        x:Name="InkColorBlueButton"
                                        Padding="6"
                                        BackgroundColor="#FF2A2A2A"
                                        StrokeShape="RoundRectangle 6"
                                        StrokeThickness="0">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="OnSelectInkBlueTapped" />
                                        </Border.GestureRecognizers>
                                        <Border
                                            HeightRequest="16"
                                            WidthRequest="16"
                                            BackgroundColor="#FF4A4A4A"
                                            StrokeShape="RoundRectangle 8"
                                            StrokeThickness="0" />
                                    </Border>

                                    <Border
                                        x:Name="InkColorGreenButton"
                                        Padding="6"
                                        BackgroundColor="#FF2A2A2A"
                                        StrokeShape="RoundRectangle 6"
                                        StrokeThickness="0">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="OnSelectInkGreenTapped" />
                                        </Border.GestureRecognizers>
                                        <Border
                                            HeightRequest="16"
                                            WidthRequest="16"
                                            BackgroundColor="#FF66BB6A"
                                            StrokeShape="RoundRectangle 8"
                                            StrokeThickness="0" />
                                    </Border>
                                </HorizontalStackLayout>

                                <HorizontalStackLayout x:Name="InkThicknessRow" Spacing="8">
                                    <Border
                                        x:Name="InkThickness2Button"
                                        Padding="10,6"
                                        BackgroundColor="#FF2A2A2A"
                                        StrokeShape="RoundRectangle 6"
                                        StrokeThickness="0">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="OnSelectInkThickness2Tapped" />
                                        </Border.GestureRecognizers>
                                        <Border
                                            HeightRequest="2"
                                            WidthRequest="20"
                                            BackgroundColor="White"
                                            StrokeThickness="0"
                                            VerticalOptions="Center"
                                            HorizontalOptions="Center" />
                                    </Border>

                                    <Border
                                        x:Name="InkThickness4Button"
                                        Padding="10,6"
                                        BackgroundColor="#FF2A2A2A"
                                        StrokeShape="RoundRectangle 6"
                                        StrokeThickness="0">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="OnSelectInkThickness4Tapped" />
                                        </Border.GestureRecognizers>
                                        <Border
                                            HeightRequest="4"
                                            WidthRequest="20"
                                            BackgroundColor="White"
                                            StrokeThickness="0"
                                            VerticalOptions="Center"
                                            HorizontalOptions="Center" />
                                    </Border>

                                    <Border
                                        x:Name="InkThickness6Button"
                                        Padding="10,6"
                                        BackgroundColor="#FF2A2A2A"
                                        StrokeShape="RoundRectangle 6"
                                        StrokeThickness="0">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="OnSelectInkThickness6Tapped" />
                                        </Border.GestureRecognizers>
                                        <Border
                                            HeightRequest="6"
                                            WidthRequest="20"
                                            BackgroundColor="White"
                                            StrokeThickness="0"
                                            VerticalOptions="Center"
                                            HorizontalOptions="Center" />
                                    </Border>
                                </HorizontalStackLayout>

                                <HorizontalStackLayout x:Name="InkTextSizeRow" Spacing="8">
                                    <Border
                                        x:Name="TextSizeSmallButton"
                                        Padding="10,6"
                                        BackgroundColor="#FF2A2A2A"
                                        StrokeShape="RoundRectangle 6"
                                        StrokeThickness="0">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="OnSelectTextSizeSmallTapped" />
                                        </Border.GestureRecognizers>
                                        <Label Text="A" FontSize="{StaticResource FontSizeSmall}" TextColor="White" HorizontalOptions="Center" VerticalOptions="Center" />
                                    </Border>

                                    <Border
                                        x:Name="TextSizeMediumButton"
                                        Padding="10,6"
                                        BackgroundColor="#FF2A2A2A"
                                        StrokeShape="RoundRectangle 6"
                                        StrokeThickness="0">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="OnSelectTextSizeMediumTapped" />
                                        </Border.GestureRecognizers>
                                        <Label Text="A" FontSize="{StaticResource FontSizeSubtitle}" TextColor="White" HorizontalOptions="Center" VerticalOptions="Center" />
                                    </Border>

                                    <Border
                                        x:Name="TextSizeLargeButton"
                                        Padding="10,6"
                                        BackgroundColor="#FF2A2A2A"
                                        StrokeShape="RoundRectangle 6"
                                        StrokeThickness="0">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="OnSelectTextSizeLargeTapped" />
                                        </Border.GestureRecognizers>
                                        <Label Text="A" FontSize="{StaticResource FontSizeHeader}" TextColor="White" HorizontalOptions="Center" VerticalOptions="Center" />
                                    </Border>
                                </HorizontalStackLayout>
                            </VerticalStackLayout>
                        </Border>

                        <HorizontalStackLayout x:Name="ShapeOptionsRow" IsVisible="False" Spacing="8">
                            <Border
                                x:Name="ShapeRectButton"
                                Padding="10,6"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnSelectShapeRectTapped" />
                                </Border.GestureRecognizers>
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeMedium}"
                                    WidthRequest="{StaticResource IconSizeMedium}"
                                    SymbolName="rectangle"
                                    TintColor="White" />
                            </Border>

                            <Border
                                x:Name="ShapeCircleButton"
                                Padding="10,6"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnSelectShapeCircleTapped" />
                                </Border.GestureRecognizers>
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeMedium}"
                                    WidthRequest="{StaticResource IconSizeMedium}"
                                    SymbolName="circle"
                                    TintColor="White" />
                            </Border>

                            <Border
                                x:Name="ShapeLineButton"
                                Padding="10,6"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnSelectShapeLineTapped" />
                                </Border.GestureRecognizers>
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeMedium}"
                                    WidthRequest="{StaticResource IconSizeMedium}"
                                    SymbolName="line.diagonal"
                                    TintColor="White" />
                            </Border>

                            <Border
                                x:Name="ShapeArrowButton"
                                Padding="10,6"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnSelectShapeArrowTapped" />
                                </Border.GestureRecognizers>
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeMedium}"
                                    WidthRequest="{StaticResource IconSizeMedium}"
                                    SymbolName="arrow.right"
                                    TintColor="White" />
                            </Border>
                        </HorizontalStackLayout>

                        <!-- Botones Deshacer/Rehacer/Borrar -->
                        <HorizontalStackLayout Spacing="6" HorizontalOptions="Fill">
                            <Border
                                x:Name="ToolUndoButton"
                                Padding="10,6"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0"
                                HorizontalOptions="FillAndExpand">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnUndoDrawingTapped" />
                                </Border.GestureRecognizers>
                                <HorizontalStackLayout Spacing="6" HorizontalOptions="Center">
                                    <controls:SymbolIcon
                                        HeightRequest="{StaticResource IconSizeMedium}"
                                        WidthRequest="{StaticResource IconSizeMedium}"
                                        SymbolName="arrow.uturn.backward"
                                        TintColor="White" />
                                    <Label Text="Deshacer" FontSize="{StaticResource FontSizeSmall}" TextColor="White" VerticalOptions="Center" />
                                </HorizontalStackLayout>
                            </Border>
                            
                            <Border
                                x:Name="ToolRedoButton"
                                Padding="10,6"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0"
                                HorizontalOptions="FillAndExpand">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnRedoDrawingTapped" />
                                </Border.GestureRecognizers>
                                <HorizontalStackLayout Spacing="6" HorizontalOptions="Center">
                                    <controls:SymbolIcon
                                        HeightRequest="{StaticResource IconSizeMedium}"
                                        WidthRequest="{StaticResource IconSizeMedium}"
                                        SymbolName="arrow.uturn.forward"
                                        TintColor="White" />
                                    <Label Text="Rehacer" FontSize="{StaticResource FontSizeSmall}" TextColor="White" VerticalOptions="Center" />
                                </HorizontalStackLayout>
                            </Border>
                        </HorizontalStackLayout>

                        <Border
                            x:Name="ToolClearButton"
                            Padding="10,6"
                            BackgroundColor="#FF2A2A2A"
                            StrokeShape="RoundRectangle 6"
                            StrokeThickness="0"
                            HorizontalOptions="Fill">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnClearDrawingTapped" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="8" HorizontalOptions="Center">
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeMedium}"
                                    WidthRequest="{StaticResource IconSizeMedium}"
                                    SymbolName="trash"
                                    TintColor="White" />
                                <Label Text="Borrar" FontSize="{StaticResource FontSizeSmall}" TextColor="White" VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>
                    </VerticalStackLayout>
                </Border>
                
                <!--  Contenedor de paneles overlay (solo visible en iOS/Android, no en Windows/MacCatalyst) -->
                <Grid x:Name="OverlayPanelsContainer">
                    <Grid.IsVisible>
                        <OnPlatform x:TypeArguments="x:Boolean">
                            <On Platform="WinUI,MacCatalyst" Value="False" />
                            <On Platform="Default" Value="True" />
                        </OnPlatform>
                    </Grid.IsVisible>
                
                <!--  Panel de asignación de atleta  -->
                <Border
                    Margin="16,100,16,16"
                    Padding="16"
                    BackgroundColor="#EE1E1E1E"
                    HorizontalOptions="End"
                    IsVisible="{Binding ShowAthleteAssignPanel}"
                    StrokeShape="RoundRectangle 12"
                    StrokeThickness="0"
                    VerticalOptions="Start"
                    WidthRequest="320">
                    <VerticalStackLayout Spacing="16">
                        <!--  Título del panel  -->
                        <Grid ColumnDefinitions="*,Auto">
                            <Label
                                FontAttributes="Bold"
                                FontSize="{StaticResource FontSizeSubtitle}"
                                Text="Asignar atleta al video"
                                TextColor="White" />
                            <Border
                                Grid.Column="1"
                                Padding="4"
                                BackgroundColor="Transparent"
                                StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ToggleAthleteAssignPanelCommand}" />
                                </Border.GestureRecognizers>
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeMedium}"
                                    SymbolName="xmark.circle.fill"
                                    TintColor="#FF888888"
                                    WidthRequest="{StaticResource IconSizeMedium}" />
                            </Border>
                        </Grid>
                        
                        <!--  Atleta actual  -->
                        <HorizontalStackLayout Spacing="8">
                            <Label
                                FontSize="{StaticResource FontSizeSmall}"
                                Text="Atleta actual:"
                                TextColor="#FF888888" />
                            <Label
                                FontSize="{StaticResource FontSizeSmall}"
                                FontAttributes="Bold"
                                Text="{Binding CurrentAthleteText}"
                                TextColor="#FFAAAAAA" />
                        </HorizontalStackLayout>
                        
                        <!--  Separador  -->
                        <BoxView
                            HeightRequest="1"
                            BackgroundColor="#FF3A3A3A" />
                        
                        <!--  Seleccionar atleta existente  -->
                        <Label
                            FontSize="{StaticResource FontSizeBody}"
                            Text="Seleccionar atleta existente:"
                            TextColor="#FFCCCCCC" />
                        
                        <Border
                            Padding="8,4"
                            BackgroundColor="#FF2A2A2A"
                            StrokeShape="RoundRectangle 6"
                            StrokeThickness="0">
                            <ScrollView HeightRequest="160" BackgroundColor="Transparent">
                                <VerticalStackLayout
                                    BindableLayout.ItemsSource="{Binding AllAthletes}"
                                    Spacing="4">
                                    <BindableLayout.EmptyView>
                                        <Label
                                            Text="No hay atletas disponibles"
                                            FontSize="{StaticResource FontSizeSmall}"
                                            TextColor="#FF666666"
                                            HorizontalOptions="Center"
                                            Margin="0,20" />
                                    </BindableLayout.EmptyView>
                                    <BindableLayout.ItemTemplate>
                                        <DataTemplate x:DataType="models:Athlete">
                                            <Border
                                                Padding="10,8"
                                                BackgroundColor="{Binding IsSelected, Converter={StaticResource BoolToAthleteBackgroundConverter}, ConverterParameter='#FF3A6A8A|#FF1A1A1A'}"
                                                StrokeShape="RoundRectangle 6"
                                                StrokeThickness="0"
                                                InputTransparent="False">
                                                <Border.GestureRecognizers>
                                                    <TapGestureRecognizer
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SelectAthleteToAssignCommand}"
                                                        CommandParameter="{Binding .}" />
                                                </Border.GestureRecognizers>
                                                <Label
                                                    Text="{Binding NombreCompleto}"
                                                    FontSize="{StaticResource FontSizeBody}"
                                                    TextColor="White"
                                                    LineBreakMode="TailTruncation"
                                                    InputTransparent="True" />
                                            </Border>
                                        </DataTemplate>
                                    </BindableLayout.ItemTemplate>
                                </VerticalStackLayout>
                            </ScrollView>
                        </Border>
                        
                        <Button
                            Command="{Binding AssignAthleteCommand}"
                            Text="Asignar seleccionado"
                            BackgroundColor="#FF4A4A4A"
                            TextColor="Black"
                            FontSize="{StaticResource FontSizeBody}"
                            CornerRadius="6"
                            HeightRequest="{StaticResource ElementHeightLarge}" />
                        
                        <!--  Separador con texto  -->
                        <Grid ColumnDefinitions="*,Auto,*" Margin="0,8">
                            <BoxView
                                Grid.Column="0"
                                HeightRequest="1"
                                BackgroundColor="#FF3A3A3A"
                                VerticalOptions="Center" />
                            <Label
                                Grid.Column="1"
                                Text="o crear nuevo"
                                FontSize="{StaticResource FontSizeSmall}"
                                TextColor="#FF666666"
                                Margin="8,0" />
                            <BoxView
                                Grid.Column="2"
                                HeightRequest="1"
                                BackgroundColor="#FF3A3A3A"
                                VerticalOptions="Center" />
                        </Grid>
                        
                        <!--  Crear nuevo atleta  -->
                        <Grid ColumnDefinitions="*,*" ColumnSpacing="8">
                            <Border
                                Grid.Column="0"
                                Padding="8,4"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0">
                                <Entry
                                    Text="{Binding NewAthleteName}"
                                    Placeholder="Nombre"
                                    PlaceholderColor="#FF666666"
                                    TextColor="White"
                                    BackgroundColor="Transparent" />
                            </Border>
                            <Border
                                Grid.Column="1"
                                Padding="8,4"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0">
                                <Entry
                                    Text="{Binding NewAthleteSurname}"
                                    Placeholder="Apellido"
                                    PlaceholderColor="#FF666666"
                                    TextColor="White"
                                    BackgroundColor="Transparent" />
                            </Border>
                        </Grid>
                        
                        <Button
                            Command="{Binding CreateAndAssignAthleteCommand}"
                            Text="Crear y asignar"
                            BackgroundColor="#FF4A4A4A"
                            TextColor="White"
                            FontSize="{StaticResource FontSizeBody}"
                            CornerRadius="6"
                            HeightRequest="{StaticResource ElementHeightLarge}" />
                    </VerticalStackLayout>
                </Border>
                
                <!--  Panel de asignación de sección/tramo  -->
                <Border
                    Margin="16,100,16,16"
                    Padding="16"
                    BackgroundColor="#EE1E1E1E"
                    HorizontalOptions="End"
                    IsVisible="{Binding ShowSectionAssignPanel}"
                    StrokeShape="RoundRectangle 12"
                    StrokeThickness="0"
                    VerticalOptions="Start"
                    WidthRequest="280">
                    <VerticalStackLayout Spacing="16">
                        <!--  Título del panel  -->
                        <Grid ColumnDefinitions="*,Auto">
                            <Label
                                FontAttributes="Bold"
                                FontSize="{StaticResource FontSizeSubtitle}"
                                Text="Asignar tramo/sección"
                                TextColor="White" />
                            <Border
                                Grid.Column="1"
                                Padding="4"
                                BackgroundColor="Transparent"
                                StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ToggleSectionAssignPanelCommand}" />
                                </Border.GestureRecognizers>
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeMedium}"
                                    SymbolName="xmark.circle.fill"
                                    TintColor="#FF888888"
                                    WidthRequest="{StaticResource IconSizeMedium}" />
                            </Border>
                        </Grid>
                        
                        <!--  Sección actual  -->
                        <HorizontalStackLayout Spacing="8">
                            <Label
                                FontSize="{StaticResource FontSizeSmall}"
                                Text="Tramo actual:"
                                TextColor="#FF888888" />
                            <Label
                                FontSize="{StaticResource FontSizeSmall}"
                                FontAttributes="Bold"
                                Text="{Binding CurrentSectionText}"
                                TextColor="#FFAAAAAA" />
                        </HorizontalStackLayout>
                        
                        <BoxView HeightRequest="1" BackgroundColor="#FF3A3A3A" />
                        
                        <!--  Selector de sección  -->
                        <Label
                            FontSize="{StaticResource FontSizeBody}"
                            Text="Seleccionar tramo:"
                            TextColor="#FFCCCCCC" />
                        
                        <Grid ColumnDefinitions="*,Auto,*" ColumnSpacing="12">
                            <Border
                                Grid.Column="0"
                                Padding="12,8"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding DecrementSectionCommand}" />
                                </Border.GestureRecognizers>
                                <Label
                                    Text="-"
                                    FontSize="{StaticResource FontSizeTitle}"
                                    FontAttributes="Bold"
                                    TextColor="White"
                                    HorizontalOptions="Center" />
                            </Border>
                            
                            <Label
                                Grid.Column="1"
                                Text="{Binding SectionToAssign, StringFormat='Tramo {0}'}"
                                FontSize="{StaticResource FontSizeTitle}"
                                FontAttributes="Bold"
                                TextColor="#FFFFA726"
                                VerticalOptions="Center"
                                HorizontalOptions="Center" />
                            
                            <Border
                                Grid.Column="2"
                                Padding="12,8"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding IncrementSectionCommand}" />
                                </Border.GestureRecognizers>
                                <Label
                                    Text="+"
                                    FontSize="{StaticResource FontSizeTitle}"
                                    FontAttributes="Bold"
                                    TextColor="White"
                                    HorizontalOptions="Center" />
                            </Border>
                        </Grid>
                        
                        <Button
                            Command="{Binding AssignSectionCommand}"
                            Text="Asignar tramo"
                            BackgroundColor="#FFFFA726"
                            TextColor="Black"
                            FontSize="{StaticResource FontSizeBody}"
                            CornerRadius="6"
                            HeightRequest="{StaticResource ElementHeightLarge}" />
                    </VerticalStackLayout>
                </Border>
                
                <!--  Panel de asignación de etiquetas  -->
                <Border
                    Margin="16,100,16,16"
                    Padding="16"
                    BackgroundColor="#EE1E1E1E"
                    HorizontalOptions="End"
                    IsVisible="{Binding ShowTagsAssignPanel}"
                    StrokeShape="RoundRectangle 12"
                    StrokeThickness="0"
                    VerticalOptions="Start"
                    WidthRequest="320">
                    <VerticalStackLayout Spacing="12">
                        <!--  Título del panel  -->
                        <Grid ColumnDefinitions="*,Auto">
                            <Label
                                FontAttributes="Bold"
                                FontSize="{StaticResource FontSizeSubtitle}"
                                Text="Asignar etiquetas"
                                TextColor="White" />
                            <Border
                                Grid.Column="1"
                                Padding="4"
                                BackgroundColor="Transparent"
                                StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ToggleTagsAssignPanelCommand}" />
                                </Border.GestureRecognizers>
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeMedium}"
                                    SymbolName="xmark.circle.fill"
                                    TintColor="#FF888888"
                                    WidthRequest="{StaticResource IconSizeMedium}" />
                            </Border>
                        </Grid>
                        
                        <!--  Etiquetas actuales  -->
                        <HorizontalStackLayout Spacing="8">
                            <Label
                                FontSize="{StaticResource FontSizeSmall}"
                                Text="Etiquetas actuales:"
                                TextColor="#FF888888" />
                            <Label
                                FontSize="{StaticResource FontSizeSmall}"
                                FontAttributes="Bold"
                                Text="{Binding CurrentTagsText}"
                                TextColor="#FFAAAAAA"
                                LineBreakMode="TailTruncation"
                                MaximumWidthRequest="180" />
                        </HorizontalStackLayout>
                        
                        <BoxView HeightRequest="1" BackgroundColor="#FF3A3A3A" />
                        
                        <!--  Lista de tags disponibles  -->
                        <Label
                            FontSize="{StaticResource FontSizeBody}"
                            Text="Seleccionar etiquetas:"
                            TextColor="#FFCCCCCC" />
                        
                        <ScrollView HeightRequest="150">
                            <FlexLayout
                                BindableLayout.ItemsSource="{Binding AllTags}"
                                Wrap="Wrap"
                                Direction="Row"
                                JustifyContent="Start"
                                AlignItems="Start">
                                <BindableLayout.ItemTemplate>
                                    <DataTemplate x:DataType="models:Tag">
                                        <Border
                                            Margin="0,0,8,8"
                                            Padding="8,6,4,6"
                                            BackgroundColor="{Binding IsSelected, Converter={StaticResource TagSelectedColorConverter}}"
                                            StrokeShape="RoundRectangle 12"
                                            StrokeThickness="0">
                                            <HorizontalStackLayout Spacing="4">
                                                <Label
                                                    Text="{Binding NombreTag}"
                                                    FontSize="{StaticResource FontSizeSmall}"
                                                    TextColor="White"
                                                    VerticalOptions="Center">
                                                    <Label.GestureRecognizers>
                                                        <TapGestureRecognizer 
                                                            Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ToggleTagSelectionCommand}"
                                                            CommandParameter="{Binding .}" />
                                                    </Label.GestureRecognizers>
                                                </Label>
                                                <Border
                                                    Padding="4"
                                                    BackgroundColor="#33000000"
                                                    StrokeShape="RoundRectangle 10"
                                                    StrokeThickness="0"
                                                    VerticalOptions="Center">
                                                    <Border.GestureRecognizers>
                                                        <TapGestureRecognizer 
                                                            Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeleteTagFromListCommand}"
                                                            CommandParameter="{Binding .}" />
                                                    </Border.GestureRecognizers>
                                                    <controls:SymbolIcon
                                                        HeightRequest="{StaticResource IconSizeXSmall}"
                                                        SymbolName="xmark"
                                                        TintColor="White"
                                                        WidthRequest="{StaticResource IconSizeXSmall}" />
                                                </Border>
                                            </HorizontalStackLayout>
                                        </Border>
                                    </DataTemplate>
                                </BindableLayout.ItemTemplate>
                            </FlexLayout>
                        </ScrollView>
                        
                        <!--  Separador  -->
                        <Grid ColumnDefinitions="*,Auto,*" Margin="0,4">
                            <BoxView Grid.Column="0" HeightRequest="1" BackgroundColor="#FF3A3A3A" VerticalOptions="Center" />
                            <Label Grid.Column="1" Text="o crear nueva" FontSize="{StaticResource FontSizeSmall}" TextColor="#FF666666" Margin="8,0" />
                            <BoxView Grid.Column="2" HeightRequest="1" BackgroundColor="#FF3A3A3A" VerticalOptions="Center" />
                        </Grid>
                        
                        <!--  Crear nueva etiqueta  -->
                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                            <Border
                                Grid.Column="0"
                                Padding="8,4"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0">
                                <Entry
                                    Text="{Binding NewTagName}"
                                    Placeholder="Nombre etiqueta"
                                    PlaceholderColor="#FF666666"
                                    TextColor="White"
                                    BackgroundColor="Transparent" />
                            </Border>
                            <Button
                                Grid.Column="1"
                                Command="{Binding CreateAndAddTagCommand}"
                                Text="+"
                                BackgroundColor="#FF66BB6A"
                                TextColor="White"
                                FontSize="{StaticResource FontSizeSubtitle}"
                                CornerRadius="6"
                                WidthRequest="{StaticResource ElementHeightLarge}"
                                HeightRequest="{StaticResource ElementHeightLarge}" />
                        </Grid>
                        
                        <Button
                            Command="{Binding SaveTagsCommand}"
                            Text="Guardar etiquetas"
                            BackgroundColor="#FF66BB6A"
                            TextColor="White"
                            FontSize="{StaticResource FontSizeBody}"
                            CornerRadius="6"
                            HeightRequest="{StaticResource ElementHeightLarge}" />
                    </VerticalStackLayout>
                </Border>
                
                <!--  Panel de eventos de etiquetas con timestamps  -->
                <Border
                    Margin="16,100,16,16"
                    Padding="16"
                    BackgroundColor="#EE1E1E1E"
                    HorizontalOptions="End"
                    IsVisible="{Binding ShowTagEventsPanel}"
                    StrokeShape="RoundRectangle 12"
                    StrokeThickness="0"
                    VerticalOptions="Start"
                    WidthRequest="380">
                    <VerticalStackLayout Spacing="12">
                        <!--  Título del panel  -->
                        <Grid ColumnDefinitions="*,Auto">
                            <HorizontalStackLayout Spacing="8">
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeDefault}"
                                    SymbolName="clock.badge.checkmark"
                                    TintColor="#FFFF7043"
                                    WidthRequest="{StaticResource IconSizeDefault}" />
                                <Label
                                    FontAttributes="Bold"
                                    FontSize="{StaticResource FontSizeSubtitle}"
                                    Text="Eventos del video"
                                    TextColor="White" />
                            </HorizontalStackLayout>
                            <Border
                                Grid.Column="1"
                                Padding="4"
                                BackgroundColor="Transparent"
                                StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ToggleTagEventsPanelCommand}" />
                                </Border.GestureRecognizers>
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeMedium}"
                                    SymbolName="xmark.circle.fill"
                                    TintColor="#FF888888"
                                    WidthRequest="{StaticResource IconSizeMedium}" />
                            </Border>
                        </Grid>
                        
                        <!--  Selector para añadir evento en posición actual  -->
                        <Border
                            Padding="12"
                            BackgroundColor="#FF2A2A2A"
                            StrokeShape="RoundRectangle 8"
                            StrokeThickness="0">
                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                                <VerticalStackLayout Grid.Column="0" Spacing="6">
                                    <Label
                                        FontSize="{StaticResource FontSizeSmall}"
                                        Text="Añadir evento en posición actual:"
                                        TextColor="#FF888888" />
                                    <ScrollView HeightRequest="140" BackgroundColor="Transparent">
                                        <FlexLayout
                                            BindableLayout.ItemsSource="{Binding AllEventTags}"
                                            Wrap="Wrap"
                                            Direction="Row"
                                            JustifyContent="Start"
                                            AlignItems="Start">
                                            <BindableLayout.EmptyView>
                                                <Label
                                                    Text="No hay etiquetas disponibles"
                                                    FontSize="{StaticResource FontSizeSmall}"
                                                    TextColor="#FF666666"
                                                    HorizontalOptions="Center"
                                                    Margin="0,20" />
                                            </BindableLayout.EmptyView>
                                            <BindableLayout.ItemTemplate>
                                                <DataTemplate x:DataType="models:EventTagDefinition">
                                                    <Border
                                                        Margin="0,0,8,8"
                                                        Padding="8,6,4,6"
                                                        BackgroundColor="{Binding IsSelected, Converter={StaticResource EventTagSelectedColorConverter}}"
                                                        StrokeShape="RoundRectangle 12"
                                                        StrokeThickness="0">
                                                        <Border.GestureRecognizers>
                                                            <TapGestureRecognizer
                                                                Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SelectTagToAddCommand}"
                                                                CommandParameter="{Binding .}" />
                                                        </Border.GestureRecognizers>
                                                        <HorizontalStackLayout Spacing="4">
                                                            <Label
                                                                Text="{Binding DisplayName}"
                                                                FontSize="{StaticResource FontSizeSmall}"
                                                                TextColor="White"
                                                                VerticalOptions="Center" />
                                                            <!--  Botón borrar solo para tags no de sistema  -->
                                                            <Border
                                                                Padding="4"
                                                                BackgroundColor="#33000000"
                                                                StrokeShape="RoundRectangle 10"
                                                                StrokeThickness="0"
                                                                VerticalOptions="Center"
                                                                IsVisible="{Binding IsSystem, Converter={StaticResource InvertedBoolConverter}}">
                                                                <Border.GestureRecognizers>
                                                                    <TapGestureRecognizer 
                                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeleteEventTagFromListCommand}"
                                                                        CommandParameter="{Binding .}" />
                                                                </Border.GestureRecognizers>
                                                                <controls:SymbolIcon
                                                                    HeightRequest="{StaticResource IconSizeXSmall}"
                                                                    SymbolName="xmark"
                                                                    TintColor="White"
                                                                    WidthRequest="{StaticResource IconSizeXSmall}" />
                                                            </Border>
                                                        </HorizontalStackLayout>
                                                    </Border>
                                                </DataTemplate>
                                            </BindableLayout.ItemTemplate>
                                        </FlexLayout>
                                    </ScrollView>
                                </VerticalStackLayout>
                                <Button
                                    Grid.Column="1"
                                    Command="{Binding AddTagEventCommand}"
                                    VerticalOptions="End"
                                    BackgroundColor="#FFFF7043"
                                    Padding="0"
                                    Text="+"
                                    TextColor="White"
                                    FontFamily="{StaticResource AppFontEmphasis}"
                                    FontSize="{StaticResource FontSizeTitle}"
                                    CornerRadius="6"
                                    WidthRequest="{StaticResource ElementHeightLarge}"
                                    HeightRequest="{StaticResource ElementHeightLarge}">
                                </Button>
                            </Grid>
                        </Border>
                        
                        <!--  Separador "o crear nuevo"  -->
                        <Grid ColumnDefinitions="*,Auto,*" Margin="0,4">
                            <BoxView Grid.Column="0" HeightRequest="1" BackgroundColor="#FF3A3A3A" VerticalOptions="Center" />
                            <Label Grid.Column="1" Text="o crear nuevo" FontSize="{StaticResource FontSizeSmall}" TextColor="#FF666666" Margin="8,0" />
                            <BoxView Grid.Column="2" HeightRequest="1" BackgroundColor="#FF3A3A3A" VerticalOptions="Center" />
                        </Grid>
                        
                        <!--  Crear nuevo evento  -->
                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                            <Border
                                Grid.Column="0"
                                Padding="8,4"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0">
                                <Entry
                                    Text="{Binding NewEventName}"
                                    Placeholder="Nombre del evento"
                                    PlaceholderColor="#FF666666"
                                    TextColor="White"
                                    BackgroundColor="Transparent" />
                            </Border>
                            <Button
                                Grid.Column="1"
                                Command="{Binding CreateAndAddEventCommand}"
                                Text="+"
                                BackgroundColor="#FFFF7043"
                                TextColor="White"
                                FontSize="{StaticResource FontSizeSubtitle}"
                                CornerRadius="6"
                                WidthRequest="{StaticResource ElementHeightLarge}"
                                HeightRequest="{StaticResource ElementHeightLarge}" />
                        </Grid>
                        
                        <BoxView HeightRequest="1" BackgroundColor="#FF3A3A3A" />
                        
                        <!--  Lista de eventos  -->
                        <Label
                            FontSize="{StaticResource FontSizeSmall}"
                            Text="{Binding TagEventsCountText}"
                            TextColor="#FFAAAAAA" />
                        
                        <ScrollView HeightRequest="200">
                            <VerticalStackLayout
                                BindableLayout.ItemsSource="{Binding TagEvents}"
                                Spacing="6">
                                <BindableLayout.EmptyView>
                                    <Label
                                        Text="No hay eventos marcados"
                                        FontSize="{StaticResource FontSizeSmall}"
                                        TextColor="#FF666666"
                                        HorizontalOptions="Center"
                                        Margin="0,20" />
                                </BindableLayout.EmptyView>
                                <BindableLayout.ItemTemplate>
                                    <DataTemplate x:DataType="models:TagEvent">
                                        <Border
                                            Padding="10,8"
                                            BackgroundColor="#FF2A2A2A"
                                            StrokeShape="RoundRectangle 6"
                                            StrokeThickness="0">
                                            <Grid ColumnDefinitions="Auto,*,Auto,Auto" ColumnSpacing="10">
                                                <!--  Timestamp clickable  -->
                                                <Border
                                                    Grid.Column="0"
                                                    Padding="8,4"
                                                    BackgroundColor="#FF3A3A3A"
                                                    StrokeShape="RoundRectangle 4"
                                                    StrokeThickness="0">
                                                    <Border.GestureRecognizers>
                                                        <TapGestureRecognizer 
                                                            Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SeekToTagEventCommand}"
                                                            CommandParameter="{Binding .}" />
                                                    </Border.GestureRecognizers>
                                                    <HorizontalStackLayout Spacing="4">
                                                        <controls:SymbolIcon
                                                            HeightRequest="{StaticResource IconSizeSmall}"
                                                            SymbolName="play.fill"
                                                            TintColor="#FFAAAAAA"
                                                            WidthRequest="{StaticResource IconSizeSmall}" />
                                                        <Label
                                                            Text="{Binding TimestampFormatted}"
                                                            FontSize="{StaticResource FontSizeSmall}"
                                                            FontAttributes="Bold"
                                                            TextColor="#FFAAAAAA" />
                                                    </HorizontalStackLayout>
                                                </Border>
                                                
                                                <!--  Nombre del tag  -->
                                                <Border
                                                    Grid.Column="1"
                                                    Padding="8,4"
                                                    BackgroundColor="#FFFF7043"
                                                    StrokeShape="RoundRectangle 10"
                                                    StrokeThickness="0"
                                                    HorizontalOptions="Start">
                                                    <Label
                                                        Text="{Binding TagName}"
                                                        FontSize="{StaticResource FontSizeSmall}"
                                                        TextColor="White" />
                                                </Border>
                                                
                                                <!--  Spacer  -->
                                                <BoxView Grid.Column="2" WidthRequest="0" />
                                                
                                                <!--  Botón eliminar  -->
                                                <Border
                                                    Grid.Column="3"
                                                    Padding="6"
                                                    BackgroundColor="#00FF5555"
                                                    StrokeShape="RoundRectangle 4"
                                                    StrokeThickness="0">
                                                    <Border.GestureRecognizers>
                                                        <TapGestureRecognizer 
                                                            Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeleteTagEventCommand}"
                                                            CommandParameter="{Binding .}" />
                                                    </Border.GestureRecognizers>
                                                    <controls:SymbolIcon
                                                        HeightRequest="{StaticResource IconSizeSmall}"
                                                        SymbolName="trash"
                                                        TintColor="#FFFF5555"
                                                        WidthRequest="{StaticResource IconSizeSmall}" />
                                                </Border>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </BindableLayout.ItemTemplate>
                            </VerticalStackLayout>
                        </ScrollView>
                        
                        <!--  Nota informativa  -->
                        <HorizontalStackLayout Spacing="6" Opacity="0.7">
                            <controls:SymbolIcon
                                HeightRequest="{StaticResource IconSizeSmall}"
                                SymbolName="info.circle"
                                TintColor="#FF888888"
                                WidthRequest="{StaticResource IconSizeSmall}" />
                            <Label
                                FontSize="{StaticResource FontSizeCaption}"
                                Text="Haz clic en el tiempo para ir 1s antes del evento"
                                TextColor="#FF888888" />
                        </HorizontalStackLayout>
                    </VerticalStackLayout>
                </Border>
                
                <!--  Panel de Split Time (Medidor de tiempo)  -->
                <Border
                    Margin="16,100,16,16"
                    Padding="16"
                    BackgroundColor="#EE1E1E1E"
                    HorizontalOptions="End"
                    IsVisible="{Binding ShowSplitTimePanel}"
                    StrokeShape="RoundRectangle 12"
                    StrokeThickness="0"
                    VerticalOptions="Start"
                    WidthRequest="320">
                    <Border.Triggers>
                        <DataTrigger TargetType="Border" Binding="{Binding IsAssistedModeEnabled}" Value="True">
                            <Setter Property="WidthRequest" Value="520" />
                        </DataTrigger>
                    </Border.Triggers>
                    <VerticalStackLayout Spacing="14">
                        <!--  Título del panel  -->
                        <Grid ColumnDefinitions="*,Auto">
                            <HorizontalStackLayout Spacing="8">
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeDefault}"
                                    SymbolName="timer"
                                    TintColor="#FF4FC3F7"
                                    WidthRequest="{StaticResource IconSizeDefault}" />
                                <Label
                                    FontAttributes="Bold"
                                    FontSize="{StaticResource FontSizeSubtitle}"
                                    Text="Split Time"
                                    TextColor="White" />
                                <Border
                                    Padding="6,2"
                                    BackgroundColor="#FF4CAF50"
                                    IsVisible="{Binding HasSavedSplit}"
                                    StrokeShape="RoundRectangle 8"
                                    StrokeThickness="0"
                                    VerticalOptions="Center">
                                    <Label
                                        FontSize="{StaticResource FontSizeCaption}"
                                        Text="GUARDADO"
                                        TextColor="White" />
                                </Border>
                            </HorizontalStackLayout>
                            <Border
                                Grid.Column="1"
                                Padding="4"
                                BackgroundColor="Transparent"
                                StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ToggleSplitTimePanelCommand}" />
                                </Border.GestureRecognizers>
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeMedium}"
                                    SymbolName="xmark.circle.fill"
                                    TintColor="#FF888888"
                                    WidthRequest="{StaticResource IconSizeMedium}" />
                            </Border>
                        </Grid>
                        
                        <!--  Switch Modo Asistido  -->
                        <Border
                            Padding="12,10"
                            BackgroundColor="#FF2A2A2A"
                            StrokeShape="RoundRectangle 8"
                            StrokeThickness="0">
                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                                <VerticalStackLayout Spacing="2">
                                    <Label
                                        FontAttributes="Bold"
                                        FontSize="{StaticResource FontSizeSmall}"
                                        Text="Toma asistida"
                                        TextColor="White" />
                                    <Label
                                        FontSize="{StaticResource FontSizeCaption}"
                                        Text="Configura parciales y el sistema te guía"
                                        TextColor="#FF888888" />
                                </VerticalStackLayout>
                                <Switch
                                    Grid.Column="1"
                                    IsToggled="{Binding IsAssistedModeEnabled, Mode=TwoWay}"
                                    OnColor="#FF4FC3F7"
                                    ThumbColor="White"
                                    VerticalOptions="Center" />
                            </Grid>
                        </Border>
                        
                        <!--  ===== MODO ASISTIDO: Configuración de parciales =====  -->
                        <VerticalStackLayout IsVisible="{Binding IsAssistedModeEnabled}" Spacing="12">
                            
                            <!--  Configuración: número de parciales  -->
                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10" IsVisible="{Binding IsAssistedConfiguring}">
                                <Label
                                    FontSize="{StaticResource FontSizeSmall}"
                                    Text="Número de parciales:"
                                    TextColor="#FF888888"
                                    VerticalOptions="Center" />
                                <HorizontalStackLayout Grid.Column="1" Spacing="8">
                                    <Button
                                        BackgroundColor="#FF3A3A3A"
                                        Command="{Binding DecrementAssistedLapCountCommand}"
                                        CornerRadius="4"
                                        FontSize="18"
                                        HeightRequest="36"
                                        Text="-"
                                        TextColor="White"
                                        WidthRequest="36" />
                                    <Label
                                        FontAttributes="Bold"
                                        FontSize="{StaticResource FontSizeTitle}"
                                        Text="{Binding AssistedLapCount}"
                                        TextColor="White"
                                        VerticalOptions="Center"
                                        WidthRequest="30"
                                        HorizontalTextAlignment="Center" />
                                    <Button
                                        BackgroundColor="#FF3A3A3A"
                                        Command="{Binding IncrementAssistedLapCountCommand}"
                                        CornerRadius="4"
                                        FontSize="18"
                                        HeightRequest="36"
                                        Text="+"
                                        TextColor="White"
                                        WidthRequest="36" />
                                </HorizontalStackLayout>
                            </Grid>
                            
                            <!--  Lista de parciales para nombrar  -->
                            <Border
                                Padding="10,8"
                                BackgroundColor="#FF2A2A2A"
                                IsVisible="{Binding IsAssistedConfiguring}"
                                StrokeShape="RoundRectangle 10"
                                StrokeThickness="0">
                                <VerticalStackLayout Spacing="6">
                                    <Label
                                        FontSize="{StaticResource FontSizeCaption}"
                                        Text="Nombres de parciales (máx. 8 caracteres):"
                                        TextColor="#FF888888" />
                                    <CollectionView
                                        HeightRequest="120"
                                        ItemsSource="{Binding AssistedLaps}">
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate x:DataType="models:AssistedLapDefinition">
                                                <Grid ColumnDefinitions="Auto,*" ColumnSpacing="4" Padding="0,4">
                                                    <Label
                                                        Grid.Column="0"
                                                        FontAttributes="Bold"
                                                        FontSize="{StaticResource FontSizeSmall}"
                                                        Text="{Binding PreviousPointLabel}"
                                                        TextColor="#FF4FC3F7"
                                                        VerticalOptions="Center" />
                                                    <Entry
                                                        Grid.Column="1"
                                                        BackgroundColor="#FF3A3A3A"
                                                        FontSize="{StaticResource FontSizeSmall}"
                                                        MaxLength="8"
                                                        Placeholder="Nombre"
                                                        PlaceholderColor="#FF666666"
                                                        Text="{Binding Name, Mode=TwoWay}"
                                                        TextChanged="AssistedLapEntry_TextChanged"
                                                        TextColor="White" />
                                                </Grid>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>
                                </VerticalStackLayout>
                            </Border>
                            
                            <!--  Configuraciones recientes  -->
                            <Border
                                Padding="10,8"
                                BackgroundColor="#FF252525"
                                IsVisible="{Binding HasRecentLapConfigs}"
                                StrokeShape="RoundRectangle 10"
                                StrokeThickness="0">
                                <VerticalStackLayout Spacing="6">
                                    <Label
                                        FontSize="{StaticResource FontSizeCaption}"
                                        Text="Configuraciones recientes:"
                                        TextColor="#FF888888" />
                                    <CollectionView
                                        ItemsSource="{Binding RecentLapConfigs}"
                                        SelectionMode="None">
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate x:DataType="models:LapConfigHistory">
                                                <Border
                                                    Padding="8,6"
                                                    BackgroundColor="#FF3A3A3A"
                                                    StrokeShape="RoundRectangle 6"
                                                    StrokeThickness="0"
                                                    Margin="0,2">
                                                    <Border.GestureRecognizers>
                                                        <TapGestureRecognizer
                                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:SinglePlayerViewModel}}, Path=ApplyLapConfigCommand}"
                                                            CommandParameter="{Binding .}" />
                                                    </Border.GestureRecognizers>
                                                    <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="8">
                                                        <Border
                                                            Grid.Column="0"
                                                            Padding="6,2"
                                                            BackgroundColor="#FF4FC3F7"
                                                            StrokeShape="RoundRectangle 4"
                                                            StrokeThickness="0">
                                                            <Label
                                                                FontAttributes="Bold"
                                                                FontSize="{StaticResource FontSizeCaption}"
                                                                Text="{Binding LapCount}"
                                                                TextColor="White" />
                                                        </Border>
                                                        <Label
                                                            Grid.Column="1"
                                                            FontSize="{StaticResource FontSizeCaption}"
                                                            LineBreakMode="TailTruncation"
                                                            Text="{Binding DisplaySummary}"
                                                            TextColor="White"
                                                            VerticalOptions="Center" />
                                                        <controls:SymbolIcon
                                                            Grid.Column="2"
                                                            HeightRequest="14"
                                                            SymbolName="arrow.right.circle"
                                                            TintColor="#FF888888"
                                                            WidthRequest="14" />
                                                    </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>
                                </VerticalStackLayout>
                            </Border>
                            
                            <!--  Botón Iniciar toma  -->
                            <Button
                                BackgroundColor="#FF4FC3F7"
                                Command="{Binding StartAssistedCaptureCommand}"
                                CornerRadius="8"
                                FontAttributes="Bold"
                                FontSize="{StaticResource FontSizeBody}"
                                HeightRequest="50"
                                IsVisible="{Binding IsAssistedConfiguring}"
                                Text="Iniciar toma"
                                TextColor="White" />
                            
                            <!--  Estado actual (cuando está capturando)  -->
                            <Border
                                Padding="12,10"
                                BackgroundColor="#FF1B5E20"
                                IsVisible="{Binding IsAssistedCapturing}"
                                StrokeShape="RoundRectangle 8"
                                StrokeThickness="0">
                                <Label
                                    FontAttributes="Bold"
                                    FontSize="{StaticResource FontSizeSmall}"
                                    HorizontalTextAlignment="Center"
                                    Text="{Binding AssistedStateDescription}"
                                    TextColor="White" />
                            </Border>
                            
                            <!--  Botón grande de marcado (cuando está capturando)  -->
                            <Button
                                BackgroundColor="#FF4CAF50"
                                Command="{Binding MarkAssistedPointCommand}"
                                CornerRadius="12"
                                FontAttributes="Bold"
                                FontSize="{StaticResource FontSizeHeader}"
                                HeightRequest="70"
                                IsVisible="{Binding CanMarkAssistedPoint}"
                                Text="{Binding AssistedActionButtonText}"
                                TextColor="White" />
                            
                            <!--  Lista de parciales marcados  -->
                            <Border
                                Padding="10,8"
                                BackgroundColor="#FF2A2A2A"
                                IsVisible="{Binding ShowAssistedResults}"
                                StrokeShape="RoundRectangle 10"
                                StrokeThickness="0">
                                <CollectionView
                                    HeightRequest="180"
                                    ItemsSource="{Binding AssistedLaps}">
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate x:DataType="models:AssistedLapDefinition">
                                            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="8" Padding="0,4">
                                                <Border
                                                    Grid.Column="0"
                                                    Padding="6,2"
                                                    BackgroundColor="{Binding IsCurrent, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF4FC3F7|#FF3A3A3A'}"
                                                    StrokeShape="RoundRectangle 4"
                                                    StrokeThickness="0"
                                                    WidthRequest="90">
                                                    <Label
                                                        FontAttributes="Bold"
                                                        FontSize="{StaticResource FontSizeSmall}"
                                                        HorizontalTextAlignment="Center"
                                                        Text="{Binding DisplayName}"
                                                        TextColor="White" />
                                                </Border>
                                                <controls:SymbolIcon
                                                    Grid.Column="1"
                                                    HeightRequest="16"
                                                    HorizontalOptions="Start"
                                                    IsVisible="{Binding IsMarked}"
                                                    SymbolName="checkmark.circle.fill"
                                                    TintColor="#FF4CAF50"
                                                    WidthRequest="16" />
                                                <Label
                                                    Grid.Column="2"
                                                    FontSize="{StaticResource FontSizeSmall}"
                                                    Text="{Binding MarkedTimeFormatted}"
                                                    TextColor="{Binding IsMarked, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF4CAF50|#FF666666'}"
                                                    VerticalOptions="Center" />
                                            </Grid>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>
                            </Border>
                            
                            <!--  Botón reiniciar (cuando está capturando o completado)  -->
                            <Button
                                BackgroundColor="#FF3A3A3A"
                                Command="{Binding ResetAssistedCaptureCommand}"
                                CornerRadius="8"
                                FontSize="{StaticResource FontSizeSmall}"
                                HeightRequest="40"
                                IsVisible="{Binding ShowAssistedResults}"
                                Text="Reiniciar toma"
                                TextColor="#FFAAAAAA" />
                            
                            <!--  Indicador de guardado exitoso (modo asistido)  -->
                            <Border
                                Padding="12,8"
                                BackgroundColor="#FF1B5E20"
                                IsVisible="{Binding HasSavedSplit}"
                                StrokeShape="RoundRectangle 8"
                                StrokeThickness="0">
                                <HorizontalStackLayout HorizontalOptions="Center" Spacing="8">
                                    <controls:SymbolIcon
                                        HeightRequest="18"
                                        SymbolName="checkmark.circle.fill"
                                        TintColor="#FF4CAF50"
                                        VerticalOptions="Center"
                                        WidthRequest="18" />
                                    <Label
                                        FontAttributes="Bold"
                                        FontSize="{StaticResource FontSizeSmall}"
                                        Text="¡Tiempos guardados!"
                                        TextColor="#FF4CAF50"
                                        VerticalOptions="Center" />
                                </HorizontalStackLayout>
                            </Border>
                        </VerticalStackLayout>
                        
                        <!--  ===== MODO MANUAL (original) =====  -->
                        <VerticalStackLayout IsVisible="{Binding IsManualModeEnabled}" Spacing="14">
                        
                        <!--  Indicador de guardado exitoso  -->
                        <Border
                            Padding="12,8"
                            BackgroundColor="#FF1B5E20"
                            IsVisible="{Binding HasSavedSplit}"
                            StrokeShape="RoundRectangle 8"
                            StrokeThickness="0">
                            <HorizontalStackLayout HorizontalOptions="Center" Spacing="8">
                                <controls:SymbolIcon
                                    SymbolName="checkmark.circle.fill"
                                    TintColor="#FF4CAF50"
                                    HeightRequest="20"
                                    WidthRequest="20"
                                    VerticalOptions="Center" />
                                <Label
                                    FontAttributes="Bold"
                                    FontSize="{StaticResource FontSizeBody}"
                                    Text="¡Tiempos guardados!"
                                    TextColor="#FF4CAF50"
                                    VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>
                        
                        <!--  Descripción  -->
                        <Label
                            FontSize="{StaticResource FontSizeSmall}"
                            IsVisible="{Binding HasSavedSplit, Converter={StaticResource InvertedBoolConverter}}"
                            Text="Marca un punto de inicio y fin para medir el tiempo de ejecución."
                            TextColor="#FF888888" />
                        
                        <!--  Punto de inicio  -->
                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                            <VerticalStackLayout Spacing="4">
                                <Label
                                    FontSize="{StaticResource FontSizeSmall}"
                                    Text="INICIO"
                                    TextColor="#FF888888" />
                                <Border
                                    Padding="12,8"
                                    BackgroundColor="#FF2A2A2A"
                                    StrokeShape="RoundRectangle 8"
                                    StrokeThickness="0">
                                    <Label
                                        FontAttributes="Bold"
                                        FontSize="{StaticResource FontSizeTitle}"
                                        HorizontalOptions="Center"
                                        Text="{Binding SplitStartTimeText}"
                                        TextColor="{Binding HasSplitStart, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF4FC3F7|#FF666666'}" />
                                </Border>
                            </VerticalStackLayout>
                            <Button
                                Grid.Column="1"
                                BackgroundColor="{Binding HasSavedSplit, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF3A3A3A|#FF4FC3F7'}"
                                Command="{Binding SetSplitStartCommand}"
                                CornerRadius="8"
                                HeightRequest="50"
                                IsEnabled="{Binding HasSavedSplit, Converter={StaticResource InvertedBoolConverter}}"
                                Text="Marcar"
                                TextColor="{Binding HasSavedSplit, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF666666|White'}"
                                VerticalOptions="End"
                                WidthRequest="80" />
                        </Grid>
                        
                        <!--  Punto de fin  -->
                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                            <VerticalStackLayout Spacing="4">
                                <Label
                                    FontSize="{StaticResource FontSizeSmall}"
                                    Text="FIN"
                                    TextColor="#FF888888" />
                                <Border
                                    Padding="12,8"
                                    BackgroundColor="#FF2A2A2A"
                                    StrokeShape="RoundRectangle 8"
                                    StrokeThickness="0">
                                    <Label
                                        FontAttributes="Bold"
                                        FontSize="{StaticResource FontSizeTitle}"
                                        HorizontalOptions="Center"
                                        Text="{Binding SplitEndTimeText}"
                                        TextColor="{Binding HasSplitEnd, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF4FC3F7|#FF666666'}" />
                                </Border>
                            </VerticalStackLayout>
                            <Button
                                Grid.Column="1"
                                BackgroundColor="{Binding HasSavedSplit, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF3A3A3A|#FF4FC3F7'}"
                                Command="{Binding SetSplitEndCommand}"
                                CornerRadius="8"
                                HeightRequest="50"
                                IsEnabled="{Binding HasSavedSplit, Converter={StaticResource InvertedBoolConverter}}"
                                Text="Marcar"
                                TextColor="{Binding HasSavedSplit, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF666666|White'}"
                                VerticalOptions="End"
                                WidthRequest="80" />
                        </Grid>

                        <!--  Laps  -->
                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                            <VerticalStackLayout Spacing="4">
                                <Label
                                    FontSize="{StaticResource FontSizeSmall}"
                                    Text="LAPS"
                                    TextColor="#FF888888" />
                                <Label
                                    FontSize="{StaticResource FontSizeCaption}"
                                    Text="Marca INICIO y añade laps intermedios"
                                    TextColor="#FF666666" />
                            </VerticalStackLayout>
                            <Button
                                Grid.Column="1"
                                BackgroundColor="{Binding HasSavedSplit, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF3A3A3A|#FF4FC3F7'}"
                                Command="{Binding AddSplitLapCommand}"
                                CornerRadius="8"
                                HeightRequest="50"
                                IsEnabled="{Binding HasSavedSplit, Converter={StaticResource InvertedBoolConverter}}"
                                Text="Lap"
                                TextColor="{Binding HasSavedSplit, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF666666|White'}"
                                VerticalOptions="End"
                                WidthRequest="80" />
                        </Grid>

                        <Border
                            Padding="10,8"
                            BackgroundColor="#FF2A2A2A"
                            StrokeShape="RoundRectangle 10"
                            StrokeThickness="0">
                            <Grid RowDefinitions="Auto,Auto">
                                <Label
                                    Grid.Row="0"
                                    FontSize="{StaticResource FontSizeCaption}"
                                    IsVisible="{Binding HasSplitLaps, Converter={StaticResource InvertedBoolConverter}}"
                                    Text="Sin laps todavía"
                                    TextColor="#FF666666" />

                                <CollectionView
                                    Grid.Row="1"
                                    HeightRequest="130"
                                    IsVisible="{Binding HasSplitLaps}"
                                    ItemsSource="{Binding SplitLapRows}">
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate x:DataType="models:ExecutionTimingRow">
                                            <Grid ColumnDefinitions="Auto,*" ColumnSpacing="10" Padding="0,6">
                                                <Label
                                                    Grid.Column="0"
                                                    FontSize="{StaticResource FontSizeSmall}"
                                                    Text="{Binding Title}"
                                                    TextColor="#FFAAAAAA" />
                                                <Label
                                                    Grid.Column="1"
                                                    FontAttributes="Bold"
                                                    FontSize="{StaticResource FontSizeSmall}"
                                                    HorizontalTextAlignment="End"
                                                    Text="{Binding Value}"
                                                    TextColor="White" />
                                            </Grid>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>
                            </Grid>
                        </Border>
                        
                        </VerticalStackLayout>
                        <!--  Fin modo manual  -->
                        
                        <BoxView HeightRequest="1" BackgroundColor="#FF3A3A3A" />
                        
                        <!--  Duración calculada  -->
                        <VerticalStackLayout Spacing="4">
                            <Label
                                FontSize="{StaticResource FontSizeSmall}"
                                HorizontalOptions="Center"
                                Text="DURACIÓN"
                                TextColor="#FF888888" />
                            <Border
                                Padding="16,12"
                                BackgroundColor="{Binding HasSplitDuration, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF1B5E20|#FF2A2A2A'}"
                                StrokeShape="RoundRectangle 10"
                                StrokeThickness="0">
                                <Label
                                    FontAttributes="Bold"
                                    FontSize="{StaticResource FontSizeHeader}"
                                    HorizontalOptions="Center"
                                    Text="{Binding SplitDurationText}"
                                    TextColor="{Binding HasSplitDuration, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF4CAF50|#FF666666'}" />
                            </Border>
                        </VerticalStackLayout>
                        
                        <!--  Botones de acción  -->
                        <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                            <Button
                                Grid.Column="0"
                                BackgroundColor="#FF3A3A3A"
                                Command="{Binding ClearSplitCommand}"
                                CornerRadius="8"
                                FontSize="{StaticResource FontSizeBody}"
                                HeightRequest="{StaticResource ElementHeightLarge}"
                                Text="Limpiar"
                                TextColor="#FFAAAAAA" />
                            <Button
                                Grid.Column="1"
                                BackgroundColor="{Binding CanSaveSplit, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF4CAF50|#FF3A3A3A'}"
                                Command="{Binding SaveSplitCommand}"
                                CornerRadius="8"
                                FontSize="{StaticResource FontSizeBody}"
                                HeightRequest="{StaticResource ElementHeightLarge}"
                                IsVisible="{Binding HasSavedSplit, Converter={StaticResource InvertedBoolConverter}}"
                                Text="Guardar"
                                TextColor="White" />
                        </Grid>
                    </VerticalStackLayout>
                </Border>
                
                </Grid>
                <!-- Fin del contenedor de paneles overlay -->
                
                <!-- PiP cámara (Videolección) - overlay dentro del área del vídeo (WinUI puede tapar overlays fuera del surface) -->
                <Border
                    x:Name="VideoLessonCameraPip"
                    Margin="0"
                    Padding="0"
                    BackgroundColor="#CC000000"
                    HorizontalOptions="Start"
                    IsVisible="False"
                    StrokeShape="RoundRectangle 10"
                    StrokeThickness="0"
                    VerticalOptions="Start"
                    WidthRequest="300"
                    HeightRequest="200"
                    ZIndex="1000">
                    <Border.GestureRecognizers>
                        <PanGestureRecognizer PanUpdated="OnVideoLessonPipPanUpdated" />
                    </Border.GestureRecognizers>

                    <!-- Host del preview de cámara: se instancia en code-behind por plataforma -->
                    <ContentView
                        x:Name="VideoLessonCameraHost"
                        HorizontalOptions="Fill"
                        VerticalOptions="Fill" />
                </Border>

                <!-- Cuenta atrás antes de iniciar grabación (videolección) -->
                <Label
                    x:Name="VideoLessonCountdownLabel"
                    IsVisible="False"
                    HorizontalOptions="Center"
                    VerticalOptions="Center"
                    HorizontalTextAlignment="Center"
                    VerticalTextAlignment="Center"
                    TextColor="White"
                    FontAttributes="Bold"
                    FontSize="96"
                    ZIndex="1100" />
            </Grid>
        </Border>

        <!-- ===================== GridSplitter Galería (Columna 1) - Windows y MacCatalyst ===================== -->
        <controls:GridSplitter
            x:Name="GallerySplitter"
            Grid.Row="0"
            Grid.Column="1"
            Grid.RowSpan="3"
            LeftColumnIndex="0"
            RightColumnIndex="2"
            MinLeftWidth="180"
            MinRightWidth="300"
            WidthRequest="8">
            <controls:GridSplitter.IsVisible>
                <OnPlatform x:TypeArguments="x:Boolean">
                    <On Platform="WinUI,MacCatalyst" Value="True" />
                    <On Platform="iOS" Value="{Binding IsLeftPanelVisible}" />
                    <On Platform="Default" Value="False" />
                </OnPlatform>
            </controls:GridSplitter.IsVisible>
        </controls:GridSplitter>

        <!-- ===================== GridSplitter Sidebar (Columna 3) - Windows, MacCatalyst e iOS ===================== -->
        <controls:GridSplitter
            x:Name="SidePanelSplitter"
            Grid.Row="0"
            Grid.Column="3"
            Grid.RowSpan="3"
            LeftColumnIndex="2"
            RightColumnIndex="4"
            MinLeftWidth="300"
            MinRightWidth="180"
            WidthRequest="8">
            <controls:GridSplitter.IsVisible>
                <OnPlatform x:TypeArguments="x:Boolean">
                    <On Platform="WinUI,MacCatalyst" Value="True" />
                    <On Platform="iOS" Value="{Binding IsRightPanelVisible}" />
                    <On Platform="Default" Value="False" />
                </OnPlatform>
            </controls:GridSplitter.IsVisible>
        </controls:GridSplitter>

        <!-- ===================== PANEL LATERAL (Columna 4) - Windows, MacCatalyst e iOS ===================== -->
        <!-- Contiene la barra de herramientas en disposición vertical -->
        <Border
            x:Name="SidePanel"
            Grid.Row="0"
            Grid.Column="4"
            Grid.RowSpan="3"
            Margin="0,8,8,8"
            Padding="12"
            BackgroundColor="#FF1A1A1A"
            StrokeShape="RoundRectangle 12"
            StrokeThickness="0">
            <Border.IsVisible>
                <OnPlatform x:TypeArguments="x:Boolean">
                    <On Platform="WinUI,MacCatalyst" Value="True" />
                    <On Platform="iOS" Value="{Binding IsRightPanelVisible}" />
                    <On Platform="Default" Value="False" />
                </OnPlatform>
            </Border.IsVisible>
            <Grid RowDefinitions="Auto,*">
                <!-- Barra de pestañas -->
                <Grid ColumnDefinitions="*,*,*" ColumnSpacing="6" Margin="0,0,0,12">
                    <!-- Tab Herramientas -->
                    <Border
                        Padding="10,8"
                        BackgroundColor="#FF404040"
                        Stroke="Transparent"
                        StrokeShape="RoundRectangle 6">
                        <Border.Triggers>
                            <DataTrigger TargetType="Border" Binding="{Binding IsToolsTabSelected}" Value="True">
                                <Setter Property="BackgroundColor" Value="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BackgroundColor}" />
                            </DataTrigger>
                        </Border.Triggers>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding SelectToolsTabCommand}" />
                        </Border.GestureRecognizers>
                        <Label Text="Herramientas" FontSize="{StaticResource FontSizeCaption}" TextColor="White" HorizontalOptions="Center" />
                    </Border>

                    <!-- Tab Filtros y Estadísticas -->
                    <Border
                        Grid.Column="1"
                        Padding="10,8"
                        BackgroundColor="#FF404040"
                        Stroke="Transparent"
                        StrokeShape="RoundRectangle 6">
                        <Border.Triggers>
                            <DataTrigger TargetType="Border" Binding="{Binding IsStatsTabSelected}" Value="True">
                                <Setter Property="BackgroundColor" Value="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BackgroundColor}" />
                            </DataTrigger>
                        </Border.Triggers>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding SelectStatsTabCommand}" />
                        </Border.GestureRecognizers>
                        <Label Text="Estadísticas" FontSize="{StaticResource FontSizeCaption}" TextColor="White" HorizontalOptions="Center" />
                    </Border>

                    <!-- Tab Diario de Sesión -->
                    <Border
                        Grid.Column="2"
                        Padding="10,8"
                        BackgroundColor="#FF404040"
                        Stroke="Transparent"
                        StrokeShape="RoundRectangle 6">
                        <Border.Triggers>
                            <DataTrigger TargetType="Border" Binding="{Binding IsDiaryTabSelected}" Value="True">
                                <Setter Property="BackgroundColor" Value="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BackgroundColor}" />
                            </DataTrigger>
                        </Border.Triggers>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding SelectDiaryTabCommand}" />
                        </Border.GestureRecognizers>
                        <Label Text="Diario" FontSize="{StaticResource FontSizeCaption}" TextColor="White" HorizontalOptions="Center" />
                    </Border>
                </Grid>

                <!-- ===== PESTAÑA: HERRAMIENTAS ===== -->
                <ScrollView Grid.Row="1" IsVisible="{Binding IsToolsTabSelected}">
                    <VerticalStackLayout Spacing="12">

                    <!-- Sección Videolección -->
                    <VerticalStackLayout Spacing="8">
                        <Label
                            FontSize="{StaticResource FontSizeSmall}"
                            Text="VIDEOLECCIÓN"
                            TextColor="#FF888888" />
                        
                        <HorizontalStackLayout Spacing="8">
                            <!-- Botón Grabar Videolección -->
                            <Border
                                x:Name="VideoLessonRecordButtonWin"
                                WidthRequest="{StaticResource ElementHeightLarge}"
                                HeightRequest="{StaticResource ElementHeightLarge}"
                                Padding="0"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 22"
                                StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnToggleVideoLessonTapped" />
                                </Border.GestureRecognizers>
                                <Grid>
                                    <controls:SymbolIcon
                                        x:Name="VideoLessonRecordIconWin"
                                        WidthRequest="{StaticResource IconSizeDefault}"
                                        HeightRequest="{StaticResource IconSizeDefault}"
                                        SymbolName="record.circle"
                                        TintColor="White"
                                        HorizontalOptions="Center"
                                        VerticalOptions="Center" />
                                </Grid>
                            </Border>

                            <!-- Toggle cámara -->
                            <Border
                                x:Name="VideoLessonCameraToggleWin"
                                WidthRequest="{StaticResource ElementHeightDefault}"
                                HeightRequest="{StaticResource ElementHeightDefault}"
                                Padding="0"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 17"
                                StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnVideoLessonCameraToggleTapped" />
                                </Border.GestureRecognizers>
                                <Grid>
                                    <controls:SymbolIcon
                                        x:Name="VideoLessonCameraToggleIconWin"
                                        WidthRequest="{StaticResource IconSizeMedium}"
                                        HeightRequest="{StaticResource IconSizeMedium}"
                                        SymbolName="video.fill"
                                        TintColor="White"
                                        HorizontalOptions="Center"
                                        VerticalOptions="Center" />
                                </Grid>
                            </Border>

                            <!-- Toggle micrófono -->
                            <Border
                                x:Name="VideoLessonMicToggleWin"
                                WidthRequest="{StaticResource ElementHeightDefault}"
                                HeightRequest="{StaticResource ElementHeightDefault}"
                                Padding="0"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 17"
                                StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnVideoLessonMicToggleTapped" />
                                </Border.GestureRecognizers>
                                <Grid>
                                    <controls:SymbolIcon
                                        x:Name="VideoLessonMicToggleIconWin"
                                        WidthRequest="{StaticResource IconSizeMedium}"
                                        HeightRequest="{StaticResource IconSizeMedium}"
                                        SymbolName="mic.fill"
                                        TintColor="White"
                                        HorizontalOptions="Center"
                                        VerticalOptions="Center" />
                                </Grid>
                            </Border>

                            <!-- Cronómetro de grabación -->
                            <Border
                                x:Name="RecordingTimerBorderWin"
                                Padding="8,4"
                                BackgroundColor="#CCFF3B30"
                                IsVisible="False"
                                StrokeShape="RoundRectangle 12"
                                StrokeThickness="0"
                                VerticalOptions="Center">
                                <HorizontalStackLayout Spacing="6">
                                    <Ellipse
                                        WidthRequest="8"
                                        HeightRequest="8"
                                        Fill="#FFFF3B30"
                                        VerticalOptions="Center" />
                                    <Label
                                        x:Name="RecordingTimerLabelWin"
                                        FontFamily="{StaticResource AppFontBody}"
                                        FontSize="{StaticResource FontSizeBody}"
                                        FontAttributes="Bold"
                                        Text="00:00"
                                        TextColor="White"
                                        VerticalOptions="Center" />
                                </HorizontalStackLayout>
                            </Border>
                        </HorizontalStackLayout>
                    </VerticalStackLayout>

                    <BoxView HeightRequest="1" BackgroundColor="#FF3A3A3A" />

                    <!-- Sección Metadatos -->
                    <VerticalStackLayout Spacing="8">
                        <Label
                            FontSize="{StaticResource FontSizeSmall}"
                            Text="METADATOS"
                            TextColor="#FF888888" />
                        
                        <FlexLayout Wrap="Wrap" Direction="Row" JustifyContent="Start" AlignItems="Start">
                            <!-- Botón Asignar Atleta -->
                            <Border
                                Margin="0,0,8,8"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0">
                                <Border.Padding>
                                    <OnPlatform x:TypeArguments="Thickness">
                                        <On Platform="iOS" Value="10,8,10,8" />
                                        <On Platform="Default" Value="10,6,10,6" />
                                    </OnPlatform>
                                </Border.Padding>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ToggleAthleteAssignPanelCommand}" />
                                </Border.GestureRecognizers>
                                <HorizontalStackLayout Spacing="8">
                                    <controls:SymbolIcon
                                        HeightRequest="{StaticResource IconSizeSidebarMenu}"
                                        SymbolName="person.badge.plus"
                                        TintColor="#FFAAAAAA"
                                        WidthRequest="{StaticResource IconSizeSidebarMenu}" />
                                    <Label
                                        FontSize="{StaticResource FontSizeSidebarMenu}"
                                        Text="Atleta"
                                        TextColor="White"
                                        VerticalOptions="Center" />
                                </HorizontalStackLayout>
                            </Border>
                            
                            <!-- Botón Asignar Sección -->
                            <Border
                                Margin="0,0,8,8"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0">
                                <Border.Padding>
                                    <OnPlatform x:TypeArguments="Thickness">
                                        <On Platform="iOS" Value="10,8,10,8" />
                                        <On Platform="Default" Value="10,6,10,6" />
                                    </OnPlatform>
                                </Border.Padding>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ToggleSectionAssignPanelCommand}" />
                                </Border.GestureRecognizers>
                                <HorizontalStackLayout Spacing="8">
                                    <controls:SymbolIcon
                                        HeightRequest="{StaticResource IconSizeSidebarMenu}"
                                        SymbolName="arrow.triangle.branch"
                                        TintColor="#FFAAAAAA"
                                        WidthRequest="{StaticResource IconSizeSidebarMenu}" />
                                    <Label
                                        FontSize="{StaticResource FontSizeSidebarMenu}"
                                        Text="Tramo"
                                        TextColor="White"
                                        VerticalOptions="Center" />
                                </HorizontalStackLayout>
                            </Border>
                            
                            <!-- Botón Asignar Etiquetas -->
                            <Border
                                Margin="0,0,8,8"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0">
                                <Border.Padding>
                                    <OnPlatform x:TypeArguments="Thickness">
                                        <On Platform="iOS" Value="10,8,10,8" />
                                        <On Platform="Default" Value="10,6,10,6" />
                                    </OnPlatform>
                                </Border.Padding>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ToggleTagsAssignPanelCommand}" />
                                </Border.GestureRecognizers>
                                <HorizontalStackLayout Spacing="8">
                                    <controls:SymbolIcon
                                        HeightRequest="{StaticResource IconSizeSidebarMenu}"
                                        SymbolName="tag.fill"
                                        TintColor="#FF66BB6A"
                                        WidthRequest="{StaticResource IconSizeSidebarMenu}" />
                                    <Label
                                        FontSize="{StaticResource FontSizeSidebarMenu}"
                                        Text="Etiquetas"
                                        TextColor="White"
                                        VerticalOptions="Center" />
                                </HorizontalStackLayout>
                            </Border>
                            
                            <!-- Botón Eventos -->
                            <Border
                                Margin="0,0,8,8"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0">
                                <Border.Padding>
                                    <OnPlatform x:TypeArguments="Thickness">
                                        <On Platform="iOS" Value="10,8,10,8" />
                                        <On Platform="Default" Value="10,6,10,6" />
                                    </OnPlatform>
                                </Border.Padding>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ToggleTagEventsPanelCommand}" />
                                </Border.GestureRecognizers>
                                <HorizontalStackLayout Spacing="8">
                                    <controls:SymbolIcon
                                        HeightRequest="{StaticResource IconSizeSidebarMenu}"
                                        SymbolName="clock.badge.checkmark"
                                        TintColor="#FFFF7043"
                                        WidthRequest="{StaticResource IconSizeSidebarMenu}" />
                                    <Label
                                        FontSize="{StaticResource FontSizeSidebarMenu}"
                                        Text="Eventos"
                                        TextColor="White"
                                        VerticalOptions="Center" />
                                </HorizontalStackLayout>
                            </Border>
                        </FlexLayout>
                    </VerticalStackLayout>

                    <BoxView HeightRequest="1" BackgroundColor="#FF3A3A3A" />

                    <!-- Sección Análisis -->
                    <VerticalStackLayout Spacing="8">
                        <Label
                            FontSize="{StaticResource FontSizeSmall}"
                            Text="ANÁLISIS"
                            TextColor="#FF888888" />
                        
                        <FlexLayout Wrap="Wrap" Direction="Row" JustifyContent="Start" AlignItems="Start">
                            <!-- Botón Dibujo -->
                            <Border
                                Margin="0,0,8,8"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0">
                                <Border.Padding>
                                    <OnPlatform x:TypeArguments="Thickness">
                                        <On Platform="iOS" Value="10,8,10,8" />
                                        <On Platform="Default" Value="10,6,10,6" />
                                    </OnPlatform>
                                </Border.Padding>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnToggleDrawingToolsTapped" />
                                </Border.GestureRecognizers>
                                <HorizontalStackLayout Spacing="8">
                                    <controls:SymbolIcon
                                        HeightRequest="{StaticResource IconSizeSidebarMenu}"
                                        SymbolName="pencil"
                                        TintColor="#FF4CAF50"
                                        WidthRequest="{StaticResource IconSizeSidebarMenu}" />
                                    <Label
                                        FontSize="{StaticResource FontSizeSidebarMenu}"
                                        Text="Dibujar"
                                        TextColor="White"
                                        VerticalOptions="Center" />
                                </HorizontalStackLayout>
                            </Border>

                            <!-- Botón Split Time -->
                            <Border
                                Margin="0,0,8,8"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0">
                                <Border.Padding>
                                    <OnPlatform x:TypeArguments="Thickness">
                                        <On Platform="iOS" Value="10,8,10,8" />
                                        <On Platform="Default" Value="10,6,10,6" />
                                    </OnPlatform>
                                </Border.Padding>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ToggleSplitTimePanelCommand}" />
                                </Border.GestureRecognizers>
                                <HorizontalStackLayout Spacing="8">
                                    <controls:SymbolIcon
                                        HeightRequest="{StaticResource IconSizeSidebarMenu}"
                                        SymbolName="timer"
                                        TintColor="#FFFFC107"
                                        WidthRequest="{StaticResource IconSizeSidebarMenu}" />
                                    <Label
                                        FontSize="{StaticResource FontSizeSidebarMenu}"
                                        Text="Split"
                                        TextColor="White"
                                        VerticalOptions="Center" />
                                </HorizontalStackLayout>
                            </Border>

                            <!-- Botón Comparación -->
                            <Border
                                Margin="0,0,8,8"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0">
                                <Border.Padding>
                                    <OnPlatform x:TypeArguments="Thickness">
                                        <On Platform="iOS" Value="10,8,10,8" />
                                        <On Platform="Default" Value="10,6,10,6" />
                                    </OnPlatform>
                                </Border.Padding>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ToggleComparisonPanelCommand}" />
                                </Border.GestureRecognizers>
                                <HorizontalStackLayout Spacing="8">
                                    <controls:SymbolIcon
                                        HeightRequest="{StaticResource IconSizeSidebarMenu}"
                                        SymbolName="rectangle.split.2x1"
                                        TintColor="#FF9C27B0"
                                        WidthRequest="{StaticResource IconSizeSidebarMenu}" />
                                    <Label
                                        FontSize="{StaticResource FontSizeSidebarMenu}"
                                        Text="Comparar"
                                        TextColor="White"
                                        VerticalOptions="Center" />
                                </HorizontalStackLayout>
                            </Border>
                        </FlexLayout>
                    </VerticalStackLayout>

                    <!-- Panel de Comparación (inline en sidebar) -->
                    <VerticalStackLayout IsVisible="{Binding ShowComparisonPanel}" Spacing="12">
                        <BoxView HeightRequest="1" BackgroundColor="#FF3A3A3A" />
                        <Grid ColumnDefinitions="*,Auto">
                            <Label
                                FontAttributes="Bold"
                                FontSize="{StaticResource FontSizeBody}"
                                Text="Modo de comparación"
                                TextColor="White" />
                            <Border
                                Grid.Column="1"
                                Padding="4"
                                BackgroundColor="Transparent"
                                StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ToggleComparisonPanelCommand}" />
                                </Border.GestureRecognizers>
                                <controls:SymbolIcon
                                    HeightRequest="16"
                                    SymbolName="xmark"
                                    TintColor="#FF888888"
                                    WidthRequest="16" />
                            </Border>
                        </Grid>
                        
                        <Label
                            FontSize="{StaticResource FontSizeCaption}"
                            Text="Selecciona el número de videos a comparar:"
                            TextColor="#FF888888" />
                        
                        <!-- Opciones de layout -->
                        <VerticalStackLayout Spacing="8">
                            <!-- 1 video (sin comparación) -->
                            <Border
                                Padding="12,10"
                                BackgroundColor="{Binding IsSingleLayout, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF3A3A3A|#FF2A2A2A'}"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding SetComparisonLayoutCommand}" CommandParameter="Single" />
                                </Border.GestureRecognizers>
                                <HorizontalStackLayout Spacing="10">
                                    <controls:SymbolIcon
                                        HeightRequest="20"
                                        SymbolName="rectangle"
                                        TintColor="{Binding IsSingleLayout, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF9C27B0|#FF888888'}"
                                        WidthRequest="20" />
                                    <Label
                                        FontSize="{StaticResource FontSizeBody}"
                                        Text="1 video"
                                        TextColor="White"
                                        VerticalOptions="Center" />
                                </HorizontalStackLayout>
                            </Border>
                            
                            <!-- 2x1 Horizontal -->
                            <Border
                                Padding="12,10"
                                BackgroundColor="{Binding IsHorizontal2x1Layout, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF3A3A3A|#FF2A2A2A'}"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding SetComparisonLayoutCommand}" CommandParameter="Horizontal2x1" />
                                </Border.GestureRecognizers>
                                <HorizontalStackLayout Spacing="10">
                                    <controls:SymbolIcon
                                        HeightRequest="20"
                                        SymbolName="rectangle.split.2x1"
                                        TintColor="{Binding IsHorizontal2x1Layout, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF9C27B0|#FF888888'}"
                                        WidthRequest="20" />
                                    <Label
                                        FontSize="{StaticResource FontSizeBody}"
                                        Text="2x1 Horizontal (lado a lado)"
                                        TextColor="White"
                                        VerticalOptions="Center" />
                                </HorizontalStackLayout>
                            </Border>
                            
                            <!-- 1x2 Vertical -->
                            <Border
                                Padding="12,10"
                                BackgroundColor="{Binding IsVertical1x2Layout, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF3A3A3A|#FF2A2A2A'}"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding SetComparisonLayoutCommand}" CommandParameter="Vertical1x2" />
                                </Border.GestureRecognizers>
                                <HorizontalStackLayout Spacing="10">
                                    <controls:SymbolIcon
                                        HeightRequest="20"
                                        SymbolName="rectangle.split.1x2"
                                        TintColor="{Binding IsVertical1x2Layout, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF9C27B0|#FF888888'}"
                                        WidthRequest="20" />
                                    <Label
                                        FontSize="{StaticResource FontSizeBody}"
                                        Text="1x2 Vertical (arriba/abajo)"
                                        TextColor="White"
                                        VerticalOptions="Center" />
                                </HorizontalStackLayout>
                            </Border>
                            
                            <!-- 2x2 Cuadrícula -->
                            <Border
                                Padding="12,10"
                                BackgroundColor="{Binding IsQuad2x2Layout, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF3A3A3A|#FF2A2A2A'}"
                                StrokeShape="RoundRectangle 6"
                                StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding SetComparisonLayoutCommand}" CommandParameter="Quad2x2" />
                                </Border.GestureRecognizers>
                                <HorizontalStackLayout Spacing="10">
                                    <controls:SymbolIcon
                                        HeightRequest="20"
                                        SymbolName="rectangle.split.2x2"
                                        TintColor="{Binding IsQuad2x2Layout, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF9C27B0|#FF888888'}"
                                        WidthRequest="20" />
                                    <Label
                                        FontSize="{StaticResource FontSizeBody}"
                                        Text="2x2 Cuadrícula (4 videos)"
                                        TextColor="White"
                                        VerticalOptions="Center" />
                                </HorizontalStackLayout>
                            </Border>
                        </VerticalStackLayout>
                        
                        <Label
                            FontSize="{StaticResource FontSizeCaption}"
                            Text="Actual:"
                            TextColor="#FF888888" />
                        <Label
                            FontSize="{StaticResource FontSizeBody}"
                            FontAttributes="Bold"
                            Text="{Binding ComparisonLayoutText}"
                            TextColor="#FF9C27B0" />
                    </VerticalStackLayout>

                    <!-- ===================== PANELES DE HERRAMIENTAS (inline) ===================== -->
                    
                    <!-- Panel de asignación de atleta (inline en sidebar) -->
                    <VerticalStackLayout IsVisible="{Binding ShowAthleteAssignPanel}" Spacing="12">
                        <BoxView HeightRequest="1" BackgroundColor="#FF3A3A3A" />
                        <Grid ColumnDefinitions="*,Auto">
                            <Label
                                FontAttributes="Bold"
                                FontSize="{StaticResource FontSizeBody}"
                                Text="Asignar atleta"
                                TextColor="White" />
                            <Border
                                Grid.Column="1"
                                Padding="4"
                                BackgroundColor="Transparent"
                                StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ToggleAthleteAssignPanelCommand}" />
                                </Border.GestureRecognizers>
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeMedium}"
                                    SymbolName="xmark.circle.fill"
                                    TintColor="#FF888888"
                                    WidthRequest="{StaticResource IconSizeMedium}" />
                            </Border>
                        </Grid>
                        
                        <HorizontalStackLayout Spacing="6">
                            <Label FontSize="{StaticResource FontSizeSmall}" Text="Actual:" TextColor="#FF888888" />
                            <Label FontSize="{StaticResource FontSizeSmall}" FontAttributes="Bold" Text="{Binding CurrentAthleteText}" TextColor="#FFAAAAAA" />
                        </HorizontalStackLayout>
                        
                        <Border Padding="6" BackgroundColor="#FF2A2A2A" StrokeShape="RoundRectangle 6" StrokeThickness="0">
                            <ScrollView HeightRequest="120">
                                <VerticalStackLayout BindableLayout.ItemsSource="{Binding AllAthletes}" Spacing="4">
                                    <BindableLayout.EmptyView>
                                        <Label Text="No hay atletas" FontSize="{StaticResource FontSizeSmall}" TextColor="#FF666666" HorizontalOptions="Center" Margin="0,16" />
                                    </BindableLayout.EmptyView>
                                    <BindableLayout.ItemTemplate>
                                        <DataTemplate x:DataType="models:Athlete">
                                            <Border Padding="8,6" BackgroundColor="{Binding IsSelected, Converter={StaticResource BoolToAthleteBackgroundConverter}, ConverterParameter='#FF3A6A8A|#FF1A1A1A'}" StrokeShape="RoundRectangle 4" StrokeThickness="0">
                                                <Border.GestureRecognizers>
                                                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SelectAthleteToAssignCommand}" CommandParameter="{Binding .}" />
                                                </Border.GestureRecognizers>
                                                <Label Text="{Binding NombreCompleto}" FontSize="{StaticResource FontSizeSmall}" TextColor="White" LineBreakMode="TailTruncation" />
                                            </Border>
                                        </DataTemplate>
                                    </BindableLayout.ItemTemplate>
                                </VerticalStackLayout>
                            </ScrollView>
                        </Border>
                        
                        <Button Command="{Binding AssignAthleteCommand}" Text="Asignar" BackgroundColor="#FF4A4A4A" TextColor="Black" FontSize="{StaticResource FontSizeSmall}" CornerRadius="6" HeightRequest="{StaticResource ElementHeightDefault}" />
                        
                        <Grid ColumnDefinitions="*,*" ColumnSpacing="6">
                            <Border Grid.Column="0" Padding="6,4" BackgroundColor="#FF2A2A2A" StrokeShape="RoundRectangle 4" StrokeThickness="0">
                                <Entry Text="{Binding NewAthleteName}" Placeholder="Nombre" PlaceholderColor="#FF666666" TextColor="White" BackgroundColor="Transparent" FontSize="{StaticResource FontSizeSmall}" />
                            </Border>
                            <Border Grid.Column="1" Padding="6,4" BackgroundColor="#FF2A2A2A" StrokeShape="RoundRectangle 4" StrokeThickness="0">
                                <Entry Text="{Binding NewAthleteSurname}" Placeholder="Apellido" PlaceholderColor="#FF666666" TextColor="White" BackgroundColor="Transparent" FontSize="{StaticResource FontSizeSmall}" />
                            </Border>
                        </Grid>
                        <Button Command="{Binding CreateAndAssignAthleteCommand}" Text="Crear y asignar" BackgroundColor="#FF4A4A4A" TextColor="White" FontSize="{StaticResource FontSizeSmall}" CornerRadius="6" HeightRequest="{StaticResource ElementHeightDefault}" />
                    </VerticalStackLayout>
                    
                    <!-- Panel de asignación de sección (inline en sidebar) -->
                    <VerticalStackLayout IsVisible="{Binding ShowSectionAssignPanel}" Spacing="12">
                        <BoxView HeightRequest="1" BackgroundColor="#FF3A3A3A" />
                        <Grid ColumnDefinitions="*,Auto">
                            <Label FontAttributes="Bold" FontSize="{StaticResource FontSizeBody}" Text="Asignar tramo" TextColor="White" />
                            <Border Grid.Column="1" Padding="4" BackgroundColor="Transparent" StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ToggleSectionAssignPanelCommand}" />
                                </Border.GestureRecognizers>
                                <controls:SymbolIcon HeightRequest="{StaticResource IconSizeMedium}" SymbolName="xmark.circle.fill" TintColor="#FF888888" WidthRequest="{StaticResource IconSizeMedium}" />
                            </Border>
                        </Grid>
                        
                        <HorizontalStackLayout Spacing="6">
                            <Label FontSize="{StaticResource FontSizeSmall}" Text="Actual:" TextColor="#FF888888" />
                            <Label FontSize="{StaticResource FontSizeSmall}" FontAttributes="Bold" Text="{Binding CurrentSectionText}" TextColor="#FFAAAAAA" />
                        </HorizontalStackLayout>
                        
                        <Grid ColumnDefinitions="*,Auto,*" ColumnSpacing="12">
                            <Border Grid.Column="0" Padding="10,8" BackgroundColor="#FF2A2A2A" StrokeShape="RoundRectangle 6" StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding DecrementSectionCommand}" />
                                </Border.GestureRecognizers>
                                <Label Text="-" FontSize="{StaticResource FontSizeTitle}" FontAttributes="Bold" TextColor="White" HorizontalOptions="Center" />
                            </Border>
                            <Label Grid.Column="1" Text="{Binding SectionToAssign, StringFormat='Tramo {0}'}" FontSize="{StaticResource FontSizeSubtitle}" FontAttributes="Bold" TextColor="#FFFFA726" VerticalOptions="Center" />
                            <Border Grid.Column="2" Padding="10,8" BackgroundColor="#FF2A2A2A" StrokeShape="RoundRectangle 6" StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding IncrementSectionCommand}" />
                                </Border.GestureRecognizers>
                                <Label Text="+" FontSize="{StaticResource FontSizeTitle}" FontAttributes="Bold" TextColor="White" HorizontalOptions="Center" />
                            </Border>
                        </Grid>
                        
                        <Button Command="{Binding AssignSectionCommand}" Text="Asignar tramo" BackgroundColor="#FFFFA726" TextColor="Black" FontSize="{StaticResource FontSizeSmall}" CornerRadius="6" HeightRequest="{StaticResource ElementHeightDefault}" />
                    </VerticalStackLayout>
                    
                    <!-- Panel de asignación de etiquetas (inline en sidebar) -->
                    <VerticalStackLayout IsVisible="{Binding ShowTagsAssignPanel}" Spacing="12">
                        <BoxView HeightRequest="1" BackgroundColor="#FF3A3A3A" />
                        <Grid ColumnDefinitions="*,Auto">
                            <Label FontAttributes="Bold" FontSize="{StaticResource FontSizeBody}" Text="Asignar etiquetas" TextColor="White" />
                            <Border Grid.Column="1" Padding="4" BackgroundColor="Transparent" StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ToggleTagsAssignPanelCommand}" />
                                </Border.GestureRecognizers>
                                <controls:SymbolIcon HeightRequest="{StaticResource IconSizeMedium}" SymbolName="xmark.circle.fill" TintColor="#FF888888" WidthRequest="{StaticResource IconSizeMedium}" />
                            </Border>
                        </Grid>
                        
                        <HorizontalStackLayout Spacing="6">
                            <Label FontSize="{StaticResource FontSizeSmall}" Text="Actuales:" TextColor="#FF888888" />
                            <Label FontSize="{StaticResource FontSizeSmall}" FontAttributes="Bold" Text="{Binding CurrentTagsText}" TextColor="#FFAAAAAA" LineBreakMode="TailTruncation" />
                        </HorizontalStackLayout>
                        
                        <ScrollView HeightRequest="100">
                            <FlexLayout BindableLayout.ItemsSource="{Binding AllTags}" Wrap="Wrap" Direction="Row" JustifyContent="Start" AlignItems="Start">
                                <BindableLayout.ItemTemplate>
                                    <DataTemplate x:DataType="models:Tag">
                                        <Border Margin="0,0,6,6" Padding="6,4,4,4" BackgroundColor="{Binding IsSelected, Converter={StaticResource TagSelectedColorConverter}}" StrokeShape="RoundRectangle 10" StrokeThickness="0">
                                            <HorizontalStackLayout Spacing="4">
                                                <Label Text="{Binding NombreTag}" FontSize="{StaticResource FontSizeCaption}" TextColor="White" VerticalOptions="Center">
                                                    <Label.GestureRecognizers>
                                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ToggleTagSelectionCommand}" CommandParameter="{Binding .}" />
                                                    </Label.GestureRecognizers>
                                                </Label>
                                                <Border Padding="3" BackgroundColor="#33000000" StrokeShape="RoundRectangle 8" StrokeThickness="0">
                                                    <Border.GestureRecognizers>
                                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeleteTagFromListCommand}" CommandParameter="{Binding .}" />
                                                    </Border.GestureRecognizers>
                                                    <controls:SymbolIcon HeightRequest="10" SymbolName="xmark" TintColor="White" WidthRequest="10" />
                                                </Border>
                                            </HorizontalStackLayout>
                                        </Border>
                                    </DataTemplate>
                                </BindableLayout.ItemTemplate>
                            </FlexLayout>
                        </ScrollView>
                        
                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="6">
                            <Border Grid.Column="0" Padding="6,4" BackgroundColor="#FF2A2A2A" StrokeShape="RoundRectangle 4" StrokeThickness="0">
                                <Entry Text="{Binding NewTagName}" Placeholder="Nueva etiqueta" PlaceholderColor="#FF666666" TextColor="White" BackgroundColor="Transparent" FontSize="{StaticResource FontSizeSmall}" />
                            </Border>
                            <Button Grid.Column="1" Command="{Binding CreateAndAddTagCommand}" Text="+" BackgroundColor="#FF66BB6A" TextColor="White" FontSize="{StaticResource FontSizeBody}" CornerRadius="6" WidthRequest="{StaticResource ElementHeightDefault}" HeightRequest="{StaticResource ElementHeightDefault}" />
                        </Grid>
                        
                        <Button Command="{Binding SaveTagsCommand}" Text="Guardar etiquetas" BackgroundColor="#FF66BB6A" TextColor="White" FontSize="{StaticResource FontSizeSmall}" CornerRadius="6" HeightRequest="{StaticResource ElementHeightDefault}" />
                    </VerticalStackLayout>
                    
                    <!-- Panel de eventos (inline en sidebar) -->
                    <VerticalStackLayout IsVisible="{Binding ShowTagEventsPanel}" Spacing="12">
                        <BoxView HeightRequest="1" BackgroundColor="#FF3A3A3A" />
                        <Grid ColumnDefinitions="*,Auto">
                            <HorizontalStackLayout Spacing="6">
                                <controls:SymbolIcon HeightRequest="{StaticResource IconSizeMedium}" SymbolName="clock.badge.checkmark" TintColor="#FFFF7043" WidthRequest="{StaticResource IconSizeMedium}" />
                                <Label FontAttributes="Bold" FontSize="{StaticResource FontSizeBody}" Text="Eventos" TextColor="White" />
                            </HorizontalStackLayout>
                            <Border Grid.Column="1" Padding="4" BackgroundColor="Transparent" StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ToggleTagEventsPanelCommand}" />
                                </Border.GestureRecognizers>
                                <controls:SymbolIcon HeightRequest="{StaticResource IconSizeMedium}" SymbolName="xmark.circle.fill" TintColor="#FF888888" WidthRequest="{StaticResource IconSizeMedium}" />
                            </Border>
                        </Grid>
                        
                        <Label FontSize="{StaticResource FontSizeCaption}" Text="Añadir evento en posición actual:" TextColor="#FF888888" />
                        
                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="6">
                            <ScrollView Grid.Column="0" HeightRequest="80">
                                <FlexLayout BindableLayout.ItemsSource="{Binding AllEventTags}" Wrap="Wrap" Direction="Row" JustifyContent="Start" AlignItems="Start">
                                    <BindableLayout.ItemTemplate>
                                        <DataTemplate x:DataType="models:EventTagDefinition">
                                            <Border Margin="0,0,6,6" Padding="6,4" BackgroundColor="{Binding IsSelected, Converter={StaticResource EventTagSelectedColorConverter}}" StrokeShape="RoundRectangle 10" StrokeThickness="0">
                                                <Border.GestureRecognizers>
                                                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SelectTagToAddCommand}" CommandParameter="{Binding .}" />
                                                </Border.GestureRecognizers>
                                                <Label Text="{Binding DisplayName}" FontSize="{StaticResource FontSizeCaption}" TextColor="White" />
                                            </Border>
                                        </DataTemplate>
                                    </BindableLayout.ItemTemplate>
                                </FlexLayout>
                            </ScrollView>
                            <Button Grid.Column="1" Command="{Binding AddTagEventCommand}" VerticalOptions="End" BackgroundColor="#FFFF7043" Text="+" TextColor="White" FontSize="{StaticResource FontSizeBody}" CornerRadius="6" WidthRequest="{StaticResource ElementHeightDefault}" HeightRequest="{StaticResource ElementHeightDefault}" />
                        </Grid>
                        
                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="6">
                            <Border Grid.Column="0" Padding="6,4" BackgroundColor="#FF2A2A2A" StrokeShape="RoundRectangle 4" StrokeThickness="0">
                                <Entry Text="{Binding NewEventName}" Placeholder="Nuevo evento" PlaceholderColor="#FF666666" TextColor="White" BackgroundColor="Transparent" FontSize="{StaticResource FontSizeSmall}" />
                            </Border>
                            <Button Grid.Column="1" Command="{Binding CreateAndAddEventCommand}" Text="+" BackgroundColor="#FFFF7043" TextColor="White" FontSize="{StaticResource FontSizeBody}" CornerRadius="6" WidthRequest="{StaticResource ElementHeightDefault}" HeightRequest="{StaticResource ElementHeightDefault}" />
                        </Grid>
                        
                        <Label FontSize="{StaticResource FontSizeCaption}" Text="{Binding TagEventsCountText}" TextColor="#FF888888" />
                        
                        <ScrollView HeightRequest="120">
                            <VerticalStackLayout BindableLayout.ItemsSource="{Binding TagEvents}" Spacing="4">
                                <BindableLayout.EmptyView>
                                    <Label Text="Sin eventos" FontSize="{StaticResource FontSizeCaption}" TextColor="#FF666666" HorizontalOptions="Center" Margin="0,12" />
                                </BindableLayout.EmptyView>
                                <BindableLayout.ItemTemplate>
                                    <DataTemplate x:DataType="models:TagEvent">
                                        <Border Padding="8,6" BackgroundColor="#FF2A2A2A" StrokeShape="RoundRectangle 4" StrokeThickness="0">
                                            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="8">
                                                <Border Grid.Column="0" Padding="6,3" BackgroundColor="#FF3A3A3A" StrokeShape="RoundRectangle 4" StrokeThickness="0">
                                                    <Border.GestureRecognizers>
                                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SeekToTagEventCommand}" CommandParameter="{Binding .}" />
                                                    </Border.GestureRecognizers>
                                                    <HorizontalStackLayout Spacing="4">
                                                        <controls:SymbolIcon HeightRequest="12" SymbolName="play.fill" TintColor="#FFAAAAAA" WidthRequest="12" />
                                                        <Label Text="{Binding TimestampFormatted}" FontSize="{StaticResource FontSizeCaption}" FontAttributes="Bold" TextColor="#FFAAAAAA" />
                                                    </HorizontalStackLayout>
                                                </Border>
                                                <Border Grid.Column="1" Padding="6,3" BackgroundColor="#FFFF7043" StrokeShape="RoundRectangle 8" StrokeThickness="0" HorizontalOptions="Start">
                                                    <Label Text="{Binding TagName}" FontSize="{StaticResource FontSizeCaption}" TextColor="White" />
                                                </Border>
                                                <Border Grid.Column="2" Padding="4" BackgroundColor="Transparent" StrokeThickness="0">
                                                    <Border.GestureRecognizers>
                                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeleteTagEventCommand}" CommandParameter="{Binding .}" />
                                                    </Border.GestureRecognizers>
                                                    <controls:SymbolIcon HeightRequest="14" SymbolName="trash" TintColor="#FFFF5555" WidthRequest="14" />
                                                </Border>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </BindableLayout.ItemTemplate>
                            </VerticalStackLayout>
                        </ScrollView>
                    </VerticalStackLayout>
                    
                    <!-- Panel de Split Time (inline en sidebar) -->
                    <VerticalStackLayout IsVisible="{Binding ShowSplitTimePanel}" Spacing="12">
                        <BoxView HeightRequest="1" BackgroundColor="#FF3A3A3A" />
                        <Grid ColumnDefinitions="*,Auto">
                            <HorizontalStackLayout Spacing="6">
                                <controls:SymbolIcon HeightRequest="{StaticResource IconSizeMedium}" SymbolName="timer" TintColor="#FF4FC3F7" WidthRequest="{StaticResource IconSizeMedium}" />
                                <Label FontAttributes="Bold" FontSize="{StaticResource FontSizeBody}" Text="Split Time" TextColor="White" />
                                <Border Padding="4,2" BackgroundColor="#FF4CAF50" IsVisible="{Binding HasSavedSplit}" StrokeShape="RoundRectangle 6" StrokeThickness="0">
                                    <Label FontSize="{StaticResource FontSizeCaption}" Text="✓" TextColor="White" />
                                </Border>
                            </HorizontalStackLayout>
                            <Border Grid.Column="1" Padding="4" BackgroundColor="Transparent" StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ToggleSplitTimePanelCommand}" />
                                </Border.GestureRecognizers>
                                <controls:SymbolIcon HeightRequest="{StaticResource IconSizeMedium}" SymbolName="xmark.circle.fill" TintColor="#FF888888" WidthRequest="{StaticResource IconSizeMedium}" />
                            </Border>
                        </Grid>
                        
                        <!-- Switch Modo Asistido -->
                        <Border Padding="10,8" BackgroundColor="#FF2A2A2A" StrokeShape="RoundRectangle 6" StrokeThickness="0">
                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                                <Label FontSize="{StaticResource FontSizeSmall}" Text="Toma asistida" TextColor="White" VerticalOptions="Center" />
                                <Switch Grid.Column="1" IsToggled="{Binding IsAssistedModeEnabled, Mode=TwoWay}" OnColor="#FF4FC3F7" ThumbColor="White" VerticalOptions="Center" />
                            </Grid>
                        </Border>
                        
                        <!-- Modo Manual -->
                        <VerticalStackLayout IsVisible="{Binding IsManualModeEnabled}" Spacing="10">
                            
                            <!--  Indicador de guardado exitoso  -->
                            <Border Padding="10,6" BackgroundColor="#FF1B5E20" IsVisible="{Binding HasSavedSplit}" StrokeShape="RoundRectangle 6" StrokeThickness="0">
                                <HorizontalStackLayout HorizontalOptions="Center" Spacing="6">
                                    <controls:SymbolIcon SymbolName="checkmark.circle.fill" TintColor="#FF4CAF50" HeightRequest="16" WidthRequest="16" VerticalOptions="Center" />
                                    <Label FontAttributes="Bold" FontSize="{StaticResource FontSizeSmall}" Text="¡Guardado!" TextColor="#FF4CAF50" VerticalOptions="Center" />
                                </HorizontalStackLayout>
                            </Border>
                            
                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                                <VerticalStackLayout Spacing="2">
                                    <Label FontSize="{StaticResource FontSizeCaption}" Text="INICIO" TextColor="#FF888888" />
                                    <Border Padding="8,6" BackgroundColor="#FF2A2A2A" StrokeShape="RoundRectangle 6" StrokeThickness="0">
                                        <Label FontAttributes="Bold" FontSize="{StaticResource FontSizeBody}" Text="{Binding SplitStartTimeText}" TextColor="{Binding HasSplitStart, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF4FC3F7|#FF666666'}" HorizontalOptions="Center" />
                                    </Border>
                                </VerticalStackLayout>
                                <Button Grid.Column="1" BackgroundColor="{Binding HasSavedSplit, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF3A3A3A|#FF4FC3F7'}" Command="{Binding SetSplitStartCommand}" CornerRadius="6" HeightRequest="{StaticResource ElementHeightDefault}" IsEnabled="{Binding HasSavedSplit, Converter={StaticResource InvertedBoolConverter}}" Text="Marcar" TextColor="{Binding HasSavedSplit, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF666666|White'}" VerticalOptions="End" WidthRequest="70" FontSize="{StaticResource FontSizeSmall}" />
                            </Grid>
                            
                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                                <VerticalStackLayout Spacing="2">
                                    <Label FontSize="{StaticResource FontSizeCaption}" Text="FIN" TextColor="#FF888888" />
                                    <Border Padding="8,6" BackgroundColor="#FF2A2A2A" StrokeShape="RoundRectangle 6" StrokeThickness="0">
                                        <Label FontAttributes="Bold" FontSize="{StaticResource FontSizeBody}" Text="{Binding SplitEndTimeText}" TextColor="{Binding HasSplitEnd, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF4FC3F7|#FF666666'}" HorizontalOptions="Center" />
                                    </Border>
                                </VerticalStackLayout>
                                <Button Grid.Column="1" BackgroundColor="{Binding HasSavedSplit, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF3A3A3A|#FF4FC3F7'}" Command="{Binding SetSplitEndCommand}" CornerRadius="6" HeightRequest="{StaticResource ElementHeightDefault}" IsEnabled="{Binding HasSavedSplit, Converter={StaticResource InvertedBoolConverter}}" Text="Marcar" TextColor="{Binding HasSavedSplit, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF666666|White'}" VerticalOptions="End" WidthRequest="70" FontSize="{StaticResource FontSizeSmall}" />
                            </Grid>
                            
                            <!-- Botón y lista de Laps -->
                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                                <Label FontSize="{StaticResource FontSizeCaption}" Text="LAPS" TextColor="#FF888888" VerticalOptions="Center" />
                                <Button Grid.Column="1" BackgroundColor="{Binding HasSavedSplit, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF3A3A3A|#FF4FC3F7'}" Command="{Binding AddSplitLapCommand}" CornerRadius="6" HeightRequest="{StaticResource ElementHeightDefault}" IsEnabled="{Binding HasSavedSplit, Converter={StaticResource InvertedBoolConverter}}" Text="+ Lap" TextColor="{Binding HasSavedSplit, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF666666|White'}" WidthRequest="70" FontSize="{StaticResource FontSizeSmall}" />
                            </Grid>
                            
                            <!-- Lista de laps tomados -->
                            <Border Padding="8,6" BackgroundColor="#FF2A2A2A" StrokeShape="RoundRectangle 6" StrokeThickness="0">
                                <Grid RowDefinitions="Auto,Auto">
                                    <Label Grid.Row="0" FontSize="{StaticResource FontSizeCaption}" IsVisible="{Binding HasSplitLaps, Converter={StaticResource InvertedBoolConverter}}" Text="Sin laps todavía" TextColor="#FF666666" />
                                    <CollectionView Grid.Row="1" HeightRequest="100" IsVisible="{Binding HasSplitLaps}" ItemsSource="{Binding SplitLapRows}">
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate x:DataType="models:ExecutionTimingRow">
                                                <Grid ColumnDefinitions="Auto,*" ColumnSpacing="8" Padding="0,4">
                                                    <Label Grid.Column="0" FontSize="{StaticResource FontSizeSmall}" Text="{Binding Title}" TextColor="#FFAAAAAA" />
                                                    <Label Grid.Column="1" FontAttributes="Bold" FontSize="{StaticResource FontSizeSmall}" HorizontalTextAlignment="End" Text="{Binding Value}" TextColor="White" />
                                                </Grid>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>
                                </Grid>
                            </Border>
                        </VerticalStackLayout>
                        
                        <!-- Modo Asistido -->
                        <VerticalStackLayout IsVisible="{Binding IsAssistedModeEnabled}" Spacing="10">
                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8" IsVisible="{Binding IsAssistedConfiguring}">
                                <Label FontSize="{StaticResource FontSizeSmall}" Text="Parciales:" TextColor="#FF888888" VerticalOptions="Center" />
                                <HorizontalStackLayout Grid.Column="1" Spacing="6">
                                    <Button BackgroundColor="#FF3A3A3A" Command="{Binding DecrementAssistedLapCountCommand}" CornerRadius="4" FontSize="14" HeightRequest="32" Text="-" TextColor="White" WidthRequest="32" />
                                    <Label FontAttributes="Bold" FontSize="{StaticResource FontSizeBody}" Text="{Binding AssistedLapCount}" TextColor="White" VerticalOptions="Center" WidthRequest="24" HorizontalTextAlignment="Center" />
                                    <Button BackgroundColor="#FF3A3A3A" Command="{Binding IncrementAssistedLapCountCommand}" CornerRadius="4" FontSize="14" HeightRequest="32" Text="+" TextColor="White" WidthRequest="32" />
                                </HorizontalStackLayout>
                            </Grid>
                            
                            <!--  Lista de parciales para nombrar  -->
                            <Border Padding="10,8" BackgroundColor="#FF2A2A2A" IsVisible="{Binding IsAssistedConfiguring}" StrokeShape="RoundRectangle 8" StrokeThickness="0">
                                <VerticalStackLayout Spacing="6">
                                    <Label FontSize="{StaticResource FontSizeCaption}" Text="Nombres de parciales:" TextColor="#FF888888" />
                                    <CollectionView HeightRequest="100" ItemsSource="{Binding AssistedLaps}">
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate x:DataType="models:AssistedLapDefinition">
                                                <Grid ColumnDefinitions="Auto,*" ColumnSpacing="4" Padding="0,4">
                                                    <Label Grid.Column="0" FontAttributes="Bold" FontSize="{StaticResource FontSizeSmall}" Text="{Binding PreviousPointLabel}" TextColor="#FF4FC3F7" VerticalOptions="Center" />
                                                    <Entry Grid.Column="1" BackgroundColor="#FF3A3A3A" FontSize="{StaticResource FontSizeSmall}" MaxLength="8" Placeholder="Nombre" PlaceholderColor="#FF666666" Text="{Binding Name, Mode=TwoWay}" TextChanged="AssistedLapEntry_TextChanged" TextColor="White" />
                                                </Grid>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>
                                </VerticalStackLayout>
                            </Border>
                            
                            <!--  Configuraciones recientes  -->
                            <Border Padding="10,8" BackgroundColor="#FF252525" IsVisible="{Binding HasRecentLapConfigs}" StrokeShape="RoundRectangle 8" StrokeThickness="0">
                                <VerticalStackLayout Spacing="6">
                                    <Label FontSize="{StaticResource FontSizeCaption}" Text="Configuraciones recientes:" TextColor="#FF888888" />
                                    <CollectionView ItemsSource="{Binding RecentLapConfigs}" SelectionMode="None">
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate x:DataType="models:LapConfigHistory">
                                                <Border Padding="8,6" BackgroundColor="#FF3A3A3A" StrokeShape="RoundRectangle 6" StrokeThickness="0" Margin="0,2">
                                                    <Border.GestureRecognizers>
                                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:SinglePlayerViewModel}}, Path=ApplyLapConfigCommand}" CommandParameter="{Binding .}" />
                                                    </Border.GestureRecognizers>
                                                    <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="8">
                                                        <Border Grid.Column="0" Padding="6,2" BackgroundColor="#FF4FC3F7" StrokeShape="RoundRectangle 4" StrokeThickness="0">
                                                            <Label FontAttributes="Bold" FontSize="{StaticResource FontSizeCaption}" Text="{Binding LapCount}" TextColor="White" />
                                                        </Border>
                                                        <Label Grid.Column="1" FontSize="{StaticResource FontSizeCaption}" LineBreakMode="TailTruncation" Text="{Binding DisplaySummary}" TextColor="White" VerticalOptions="Center" />
                                                        <controls:SymbolIcon Grid.Column="2" HeightRequest="14" SymbolName="arrow.right.circle" TintColor="#FF888888" WidthRequest="14" />
                                                    </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>
                                </VerticalStackLayout>
                            </Border>
                            
                            <Button BackgroundColor="#FF4FC3F7" Command="{Binding StartAssistedCaptureCommand}" CornerRadius="6" FontSize="{StaticResource FontSizeSmall}" HeightRequest="{StaticResource ElementHeightDefault}" IsVisible="{Binding IsAssistedConfiguring}" Text="Iniciar toma" TextColor="White" />
                            
                            <Border Padding="10,8" BackgroundColor="#FF1B5E20" IsVisible="{Binding ShowAssistedResults}" StrokeShape="RoundRectangle 6" StrokeThickness="0">
                                <Label FontAttributes="Bold" FontSize="{StaticResource FontSizeSmall}" HorizontalTextAlignment="Center" Text="{Binding AssistedStateDescription}" TextColor="White" />
                            </Border>
                            
                            <Button BackgroundColor="#FF4CAF50" Command="{Binding MarkAssistedPointCommand}" CornerRadius="10" FontAttributes="Bold" FontSize="{StaticResource FontSizeSubtitle}" HeightRequest="60" IsVisible="{Binding CanMarkAssistedPoint}" Text="{Binding AssistedActionButtonText}" TextColor="White" />
                            
                            <!--  Lista de parciales marcados  -->
                            <Border Padding="10,8" BackgroundColor="#FF2A2A2A" IsVisible="{Binding ShowAssistedResults}" StrokeShape="RoundRectangle 8" StrokeThickness="0">
                                <CollectionView HeightRequest="140" ItemsSource="{Binding AssistedLaps}">
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate x:DataType="models:AssistedLapDefinition">
                                            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="8" Padding="0,3">
                                                <Border Grid.Column="0" Padding="6,2" BackgroundColor="{Binding IsCurrent, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF4FC3F7|#FF3A3A3A'}" StrokeShape="RoundRectangle 4" StrokeThickness="0" WidthRequest="80">
                                                    <Label FontAttributes="Bold" FontSize="{StaticResource FontSizeCaption}" HorizontalTextAlignment="Center" Text="{Binding DisplayName}" TextColor="White" />
                                                </Border>
                                                <controls:SymbolIcon Grid.Column="1" HeightRequest="14" HorizontalOptions="Start" IsVisible="{Binding IsMarked}" SymbolName="checkmark.circle.fill" TintColor="#FF4CAF50" WidthRequest="14" />
                                                <Label Grid.Column="2" FontSize="{StaticResource FontSizeCaption}" Text="{Binding MarkedTimeFormatted}" TextColor="{Binding IsMarked, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF4CAF50|#FF666666'}" VerticalOptions="Center" />
                                            </Grid>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>
                            </Border>
                            
                            <Button BackgroundColor="#FF3A3A3A" Command="{Binding ResetAssistedCaptureCommand}" CornerRadius="6" FontSize="{StaticResource FontSizeSmall}" HeightRequest="{StaticResource ElementHeightDefault}" IsVisible="{Binding ShowAssistedResults}" Text="Reiniciar" TextColor="#FFAAAAAA" />
                            
                            <!--  Indicador de guardado exitoso (modo asistido)  -->
                            <Border Padding="10,6" BackgroundColor="#FF1B5E20" IsVisible="{Binding HasSavedSplit}" StrokeShape="RoundRectangle 6" StrokeThickness="0">
                                <HorizontalStackLayout HorizontalOptions="Center" Spacing="6">
                                    <controls:SymbolIcon SymbolName="checkmark.circle.fill" TintColor="#FF4CAF50" HeightRequest="16" WidthRequest="16" VerticalOptions="Center" />
                                    <Label FontAttributes="Bold" FontSize="{StaticResource FontSizeSmall}" Text="¡Guardado!" TextColor="#FF4CAF50" VerticalOptions="Center" />
                                </HorizontalStackLayout>
                            </Border>
                        </VerticalStackLayout>
                        
                        <!-- Duración -->
                        <VerticalStackLayout Spacing="4">
                            <Label FontSize="{StaticResource FontSizeCaption}" HorizontalOptions="Center" Text="DURACIÓN" TextColor="#FF888888" />
                            <Border Padding="12,10" BackgroundColor="{Binding HasSplitDuration, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF1B5E20|#FF2A2A2A'}" StrokeShape="RoundRectangle 8" StrokeThickness="0">
                                <Label FontAttributes="Bold" FontSize="{StaticResource FontSizeSubtitle}" HorizontalOptions="Center" Text="{Binding SplitDurationText}" TextColor="{Binding HasSplitDuration, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF4CAF50|#FF666666'}" />
                            </Border>
                        </VerticalStackLayout>
                        
                        <Grid ColumnDefinitions="*,*" ColumnSpacing="8">
                            <Button Grid.Column="0" BackgroundColor="#FF3A3A3A" Command="{Binding ClearSplitCommand}" CornerRadius="6" FontSize="{StaticResource FontSizeSmall}" HeightRequest="{StaticResource ElementHeightDefault}" Text="Limpiar" TextColor="#FFAAAAAA" />
                            <Button Grid.Column="1" BackgroundColor="{Binding CanSaveSplit, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF4CAF50|#FF3A3A3A'}" Command="{Binding SaveSplitCommand}" CornerRadius="6" FontSize="{StaticResource FontSizeSmall}" HeightRequest="{StaticResource ElementHeightDefault}" IsVisible="{Binding HasSavedSplit, Converter={StaticResource InvertedBoolConverter}}" Text="Guardar" TextColor="White" />
                        </Grid>
                    </VerticalStackLayout>
                    
                </VerticalStackLayout>
                </ScrollView>

                <!-- ===== PESTAÑA: ESTADÍSTICAS ===== -->
                <ScrollView Grid.Row="1" IsVisible="{Binding IsStatsTabSelected}">
                    <VerticalStackLayout Spacing="12">
                        
                        <!-- ===== RESUMEN PRINCIPAL DE SESIÓN ===== -->
                        <VerticalStackLayout Spacing="8">
                            <Label
                                FontSize="{StaticResource FontSizeSmall}"
                                Text="RESUMEN DE SESIÓN"
                                TextColor="#FF888888" />
                            
                            <!-- Nombre de sesión -->
                            <Label
                                FontSize="{StaticResource FontSizeBody}"
                                Text="{Binding SessionName}"
                                TextColor="White"
                                LineBreakMode="TailTruncation" />
                            
                            <!-- Grid principal de estadísticas -->
                            <Grid ColumnDefinitions="*,*,*" ColumnSpacing="6" RowSpacing="6">
                                <!-- Vídeos -->
                                <Border
                                    Padding="8"
                                    BackgroundColor="#FF2A2A2A"
                                    StrokeShape="RoundRectangle 8"
                                    StrokeThickness="0">
                                    <VerticalStackLayout HorizontalOptions="Center" Spacing="2">
                                        <Label
                                            FontAttributes="Bold"
                                            FontSize="{StaticResource FontSizeSubtitle}"
                                            HorizontalOptions="Center"
                                            Text="{Binding SessionTotalVideoCount}"
                                            TextColor="#FF6DDDFF" />
                                        <Label
                                            FontSize="{StaticResource FontSizeCaption}"
                                            HorizontalOptions="Center"
                                            Text="Vídeos"
                                            TextColor="#FF888888" />
                                    </VerticalStackLayout>
                                </Border>
                                
                                <!-- Tiempo Total -->
                                <Border
                                    Grid.Column="1"
                                    Padding="8"
                                    BackgroundColor="#FF2A2A2A"
                                    StrokeShape="RoundRectangle 8"
                                    StrokeThickness="0">
                                    <VerticalStackLayout HorizontalOptions="Center" Spacing="2">
                                        <Label
                                            FontAttributes="Bold"
                                            FontSize="{StaticResource FontSizeSubtitle}"
                                            HorizontalOptions="Center"
                                            Text="{Binding SessionTotalDurationFormatted}"
                                            TextColor="White" />
                                        <Label
                                            FontSize="{StaticResource FontSizeCaption}"
                                            HorizontalOptions="Center"
                                            Text="Tiempo"
                                            TextColor="#FF888888" />
                                    </VerticalStackLayout>
                                </Border>
                                
                                <!-- Tramos -->
                                <Border
                                    Grid.Column="2"
                                    Padding="8"
                                    BackgroundColor="#FF2A2A2A"
                                    StrokeShape="RoundRectangle 8"
                                    StrokeThickness="0">
                                    <VerticalStackLayout HorizontalOptions="Center" Spacing="2">
                                        <Label
                                            FontAttributes="Bold"
                                            FontSize="{StaticResource FontSizeSubtitle}"
                                            HorizontalOptions="Center"
                                            Text="{Binding SessionUniqueSectionsCount}"
                                            TextColor="#FFFFA726" />
                                        <Label
                                            FontSize="{StaticResource FontSizeCaption}"
                                            HorizontalOptions="Center"
                                            Text="Tramos"
                                            TextColor="#FF888888" />
                                    </VerticalStackLayout>
                                </Border>
                            </Grid>
                        </VerticalStackLayout>
                        
                        <BoxView HeightRequest="1" BackgroundColor="#FF3A3A3A" />
                        
                        <!-- ===== ATLETAS ===== -->
                        <VerticalStackLayout Spacing="8">
                            <Label
                                FontSize="{StaticResource FontSizeSmall}"
                                Text="ATLETAS"
                                TextColor="#FF888888" />
                            
                            <Grid ColumnDefinitions="*,*" ColumnSpacing="6">
                                <!-- Atletas únicos -->
                                <Border
                                    Padding="10"
                                    BackgroundColor="#FF2A2A2A"
                                    StrokeShape="RoundRectangle 8"
                                    StrokeThickness="0">
                                    <VerticalStackLayout HorizontalOptions="Center" Spacing="2">
                                        <Label
                                            FontAttributes="Bold"
                                            FontSize="{StaticResource FontSizeSubtitle}"
                                            HorizontalOptions="Center"
                                            Text="{Binding SessionUniqueAthletesCount}"
                                            TextColor="White" />
                                        <Label
                                            FontSize="{StaticResource FontSizeCaption}"
                                            HorizontalOptions="Center"
                                            Text="atletas"
                                            TextColor="#FF888888" />
                                    </VerticalStackLayout>
                                </Border>
                                
                                <!-- Videos con atleta -->
                                <Border
                                    Grid.Column="1"
                                    Padding="10"
                                    BackgroundColor="#FF2A2A2A"
                                    StrokeShape="RoundRectangle 8"
                                    StrokeThickness="0">
                                    <VerticalStackLayout HorizontalOptions="Center" Spacing="2">
                                        <Label
                                            FontAttributes="Bold"
                                            FontSize="{StaticResource FontSizeSubtitle}"
                                            HorizontalOptions="Center"
                                            Text="{Binding SessionVideosWithAthletePercent, StringFormat='{0}%'}"
                                            TextColor="#FF4CAF50" />
                                        <Label
                                            FontSize="{StaticResource FontSizeCaption}"
                                            HorizontalOptions="Center"
                                            Text="asignados"
                                            TextColor="#FF888888" />
                                    </VerticalStackLayout>
                                </Border>
                            </Grid>
                        </VerticalStackLayout>
                        
                        <BoxView HeightRequest="1" BackgroundColor="#FF3A3A3A" />
                        
                        <!-- ===== ETIQUETAS Y EVENTOS ===== -->
                        <VerticalStackLayout Spacing="8">
                            <Label
                                FontSize="{StaticResource FontSizeSmall}"
                                Text="ETIQUETAS Y EVENTOS"
                                TextColor="#FF888888" />
                            
                            <Grid ColumnDefinitions="*,*" ColumnSpacing="6">
                                <!-- Total etiquetas -->
                                <Border
                                    Padding="10"
                                    BackgroundColor="#FF2A2A2A"
                                    StrokeShape="RoundRectangle 8"
                                    StrokeThickness="0">
                                    <VerticalStackLayout HorizontalOptions="Center" Spacing="2">
                                        <Label
                                            FontAttributes="Bold"
                                            FontSize="{StaticResource FontSizeSubtitle}"
                                            HorizontalOptions="Center"
                                            Text="{Binding SessionTotalTagsCount}"
                                            TextColor="#FF66BB6A" />
                                        <Label
                                            FontSize="{StaticResource FontSizeCaption}"
                                            HorizontalOptions="Center"
                                            Text="etiquetas"
                                            TextColor="#FF888888" />
                                    </VerticalStackLayout>
                                </Border>
                                
                                <!-- Total eventos -->
                                <Border
                                    Grid.Column="1"
                                    Padding="10"
                                    BackgroundColor="#FF2A2A2A"
                                    StrokeShape="RoundRectangle 8"
                                    StrokeThickness="0">
                                    <VerticalStackLayout HorizontalOptions="Center" Spacing="2">
                                        <Label
                                            FontAttributes="Bold"
                                            FontSize="{StaticResource FontSizeSubtitle}"
                                            HorizontalOptions="Center"
                                            Text="{Binding SessionTotalEventsCount}"
                                            TextColor="#FFFF7043" />
                                        <Label
                                            FontSize="{StaticResource FontSizeCaption}"
                                            HorizontalOptions="Center"
                                            Text="eventos"
                                            TextColor="#FF888888" />
                                    </VerticalStackLayout>
                                </Border>
                            </Grid>
                        </VerticalStackLayout>
                        
                        <BoxView HeightRequest="1" BackgroundColor="#FF3A3A3A" />
                        
                        <!-- ===== EVENTOS (GRÁFICO) ===== -->
                        <VerticalStackLayout Spacing="8" IsVisible="{Binding HasSessionEventStats}">
                            <Label
                                FontSize="{StaticResource FontSizeSmall}"
                                Text="EVENTOS"
                                TextColor="#FF888888" />
                            
                            <Grid ColumnDefinitions="*,*" ColumnSpacing="6">
                                <Border
                                    Padding="10"
                                    BackgroundColor="#FF2A2A2A"
                                    StrokeShape="RoundRectangle 8"
                                    StrokeThickness="0">
                                    <VerticalStackLayout HorizontalOptions="Center" Spacing="2">
                                        <Label
                                            FontAttributes="Bold"
                                            FontSize="{StaticResource FontSizeSubtitle}"
                                            HorizontalOptions="Center"
                                            Text="{Binding TotalEventTagsCount}"
                                            TextColor="#FFFF7043" />
                                        <Label
                                            FontSize="{StaticResource FontSizeCaption}"
                                            HorizontalOptions="Center"
                                            Text="totales"
                                            TextColor="#FF888888" />
                                    </VerticalStackLayout>
                                </Border>
                                <Border
                                    Grid.Column="1"
                                    Padding="10"
                                    BackgroundColor="#FF2A2A2A"
                                    StrokeShape="RoundRectangle 8"
                                    StrokeThickness="0">
                                    <VerticalStackLayout HorizontalOptions="Center" Spacing="2">
                                        <Label
                                            FontAttributes="Bold"
                                            FontSize="{StaticResource FontSizeSubtitle}"
                                            HorizontalOptions="Center"
                                            Text="{Binding TotalUniqueEventTagsCount}"
                                            TextColor="White" />
                                        <Label
                                            FontSize="{StaticResource FontSizeCaption}"
                                            HorizontalOptions="Center"
                                            Text="tipos únicos"
                                            TextColor="#FF888888" />
                                    </VerticalStackLayout>
                                </Border>
                            </Grid>
                            
                            <!-- Gráfico de eventos -->
                            <Label
                                FontSize="{StaticResource FontSizeCaption}"
                                Margin="0,4,0,0"
                                Text="Eventos más utilizados"
                                TextColor="#FF808080" />
                            <controls:SimplePieChart
                                MinimumHeightRequest="120"
                                HorizontalOptions="Fill"
                                VerticalOptions="FillAndExpand"
                                Labels="{Binding TopEventTagNames}"
                                ShowLegend="True"
                                TextColor="White"
                                Values="{Binding TopEventTagValues}" />
                        </VerticalStackLayout>
                        
                        <BoxView HeightRequest="1" BackgroundColor="#FF3A3A3A" IsVisible="{Binding HasSessionEventStats}" />
                        
                        <!-- ===== ETIQUETAS (GRÁFICO) ===== -->
                        <VerticalStackLayout Spacing="8" IsVisible="{Binding HasSessionLabelStats}">
                            <Label
                                FontSize="{StaticResource FontSizeSmall}"
                                Text="ETIQUETAS"
                                TextColor="#FF888888" />
                            
                            <Grid ColumnDefinitions="*,*" ColumnSpacing="6">
                                <Border
                                    Padding="10"
                                    BackgroundColor="#FF2A2A2A"
                                    StrokeShape="RoundRectangle 8"
                                    StrokeThickness="0">
                                    <VerticalStackLayout HorizontalOptions="Center" Spacing="2">
                                        <Label
                                            FontAttributes="Bold"
                                            FontSize="{StaticResource FontSizeSubtitle}"
                                            HorizontalOptions="Center"
                                            Text="{Binding TotalLabelTagsCount}"
                                            TextColor="#FF66BB6A" />
                                        <Label
                                            FontSize="{StaticResource FontSizeCaption}"
                                            HorizontalOptions="Center"
                                            Text="asignadas"
                                            TextColor="#FF888888" />
                                    </VerticalStackLayout>
                                </Border>
                                <Border
                                    Grid.Column="1"
                                    Padding="10"
                                    BackgroundColor="#FF2A2A2A"
                                    StrokeShape="RoundRectangle 8"
                                    StrokeThickness="0">
                                    <VerticalStackLayout HorizontalOptions="Center" Spacing="2">
                                        <Label
                                            FontAttributes="Bold"
                                            FontSize="{StaticResource FontSizeSubtitle}"
                                            HorizontalOptions="Center"
                                            Text="{Binding TotalUniqueLabelTagsCount}"
                                            TextColor="White" />
                                        <Label
                                            FontSize="{StaticResource FontSizeCaption}"
                                            HorizontalOptions="Center"
                                            Text="únicas"
                                            TextColor="#FF888888" />
                                    </VerticalStackLayout>
                                </Border>
                            </Grid>
                            
                            <!-- Gráfico de etiquetas -->
                            <Label
                                FontSize="{StaticResource FontSizeCaption}"
                                Margin="0,4,0,0"
                                Text="Etiquetas más utilizadas"
                                TextColor="#FF808080" />
                            <controls:SimplePieChart
                                MinimumHeightRequest="120"
                                HorizontalOptions="Fill"
                                VerticalOptions="FillAndExpand"
                                Labels="{Binding TopLabelTagNames}"
                                ShowLegend="True"
                                TextColor="White"
                                Values="{Binding TopLabelTagValues}" />
                        </VerticalStackLayout>
                        
                        <BoxView HeightRequest="1" BackgroundColor="#FF3A3A3A" IsVisible="{Binding HasSessionLabelStats}" />
                        
                        <!-- ===== TABLA DE TIEMPOS POR SECCIÓN ===== -->
                        <VerticalStackLayout Spacing="8" IsVisible="{Binding HasSectionTimes}">
                            <!-- Cabecera con título y botón abrir -->
                            <Grid ColumnDefinitions="Auto,Auto,*" ColumnSpacing="8">
                                <Label
                                    FontSize="{StaticResource FontSizeSmall}"
                                    Text="TIEMPOS POR TRAMO"
                                    TextColor="#FF888888"
                                    VerticalOptions="Center" />
                                
                                <!-- Botón para abrir tabla detallada -->
                                <Border
                                    Grid.Column="1"
                                    Padding="8,4"
                                    BackgroundColor="#FF404040"
                                    StrokeShape="RoundRectangle 4"
                                    StrokeThickness="0"
                                    VerticalOptions="Center">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding OpenDetailedTimesPopupCommand}" />
                                    </Border.GestureRecognizers>
                                    <HorizontalStackLayout Spacing="4">
                                        <controls:SymbolIcon
                                            HeightRequest="14"
                                            SymbolName="arrow.up.left.and.arrow.down.right"
                                            TintColor="#FF6DDDFF"
                                            WidthRequest="14"
                                            VerticalOptions="Center" />
                                        <Label
                                            FontSize="{StaticResource FontSizeSmall}"
                                            Text="Abrir"
                                            TextColor="#FF6DDDFF"
                                            VerticalOptions="Center" />
                                    </HorizontalStackLayout>
                                </Border>
                            </Grid>
                            
                            <!-- Contenedor de secciones con tiempos -->
                            <VerticalStackLayout 
                                Spacing="12"
                                BindableLayout.ItemsSource="{Binding SectionTimes}">
                                <BindableLayout.ItemTemplate>
                                    <DataTemplate x:DataType="services:SectionWithAthleteRows">
                                        <Border
                                            Padding="10"
                                            BackgroundColor="#FF2A2A2A"
                                            StrokeShape="RoundRectangle 8"
                                            StrokeThickness="0">
                                            <VerticalStackLayout Spacing="8">
                                                <!-- Título del tramo -->
                                                <Label
                                                    FontSize="{StaticResource FontSizeBody}"
                                                    FontAttributes="Bold"
                                                    Text="{Binding SectionName}"
                                                    TextColor="#FFFFA726" />
                                                
                                                <!-- Lista de atletas con tiempos -->
                                                <Grid ColumnDefinitions="*,Auto,Auto,Auto" ColumnSpacing="6" Margin="0,0,0,4">
                                                    <Label
                                                        FontSize="{StaticResource FontSizeCaption}"
                                                        Text="Atleta"
                                                        TextColor="#FF808080"
                                                        FontAttributes="Bold" />
                                                    <Label
                                                        Grid.Column="1"
                                                        FontSize="{StaticResource FontSizeCaption}"
                                                        Text="Tiempo"
                                                        TextColor="#FF808080"
                                                        FontAttributes="Bold"
                                                        HorizontalOptions="End" />
                                                    <Label
                                                        Grid.Column="2"
                                                        FontSize="{StaticResource FontSizeCaption}"
                                                        Text="Penal."
                                                        TextColor="#FF808080"
                                                        FontAttributes="Bold"
                                                        HorizontalOptions="End"
                                                        WidthRequest="45" />
                                                    <Label
                                                        Grid.Column="3"
                                                        FontSize="{StaticResource FontSizeCaption}"
                                                        Text="Total"
                                                        TextColor="#FF808080"
                                                        FontAttributes="Bold"
                                                        HorizontalOptions="End"
                                                        WidthRequest="60" />
                                                </Grid>
                                                <VerticalStackLayout
                                                    Spacing="4"
                                                    BindableLayout.ItemsSource="{Binding Athletes}">
                                                    <BindableLayout.ItemTemplate>
                                                        <DataTemplate x:DataType="services:AthleteSectionTimeRow">
                                                            <Border
                                                                Padding="4,2"
                                                                BackgroundColor="Transparent"
                                                                Stroke="Transparent"
                                                                StrokeShape="RoundRectangle 4">
                                                                <Border.GestureRecognizers>
                                                                    <TapGestureRecognizer 
                                                                        Command="{Binding Source={x:Reference ThisPage}, Path=BindingContext.SelectVideoByIdCommand}"
                                                                        CommandParameter="{Binding VideoId}" />
                                                                    <DragGestureRecognizer
                                                                        CanDrag="True"
                                                                        DragStarting="OnTimesRowDragStarting" />
                                                                </Border.GestureRecognizers>
                                                                <VisualStateManager.VisualStateGroups>
                                                                    <VisualStateGroup x:Name="CommonStates">
                                                                        <VisualState x:Name="Normal">
                                                                            <VisualState.Setters>
                                                                                <Setter Property="BackgroundColor" Value="Transparent" />
                                                                            </VisualState.Setters>
                                                                        </VisualState>
                                                                        <VisualState x:Name="PointerOver">
                                                                            <VisualState.Setters>
                                                                                <Setter Property="BackgroundColor" Value="#30FFFFFF" />
                                                                            </VisualState.Setters>
                                                                        </VisualState>
                                                                    </VisualStateGroup>
                                                                </VisualStateManager.VisualStateGroups>
                                                                <Grid ColumnDefinitions="*,Auto,Auto,Auto" ColumnSpacing="6">
                                                                    <!-- Nombre del atleta -->
                                                                    <Label
                                                                        FontSize="{StaticResource FontSizeCaption}"
                                                                        Text="{Binding AthleteName}"
                                                                        TextColor="White"
                                                                        VerticalOptions="Center"
                                                                        LineBreakMode="TailTruncation" />
                                                                    
                                                                    <!-- Tiempo (sin penalización) -->
                                                                    <Label
                                                                        Grid.Column="1"
                                                                        FontSize="{StaticResource FontSizeCaption}"
                                                                        Text="{Binding DurationFormatted}"
                                                                        TextColor="White"
                                                                        VerticalOptions="Center"
                                                                        HorizontalOptions="End" />
                                                                    
                                                                    <!-- Penalización -->
                                                                    <Label
                                                                        Grid.Column="2"
                                                                        FontSize="{StaticResource FontSizeCaption}"
                                                                        Text="{Binding PenaltyFormatted}"
                                                                        TextColor="#FFFF5722"
                                                                        VerticalOptions="Center"
                                                                        HorizontalOptions="End"
                                                                        WidthRequest="45" />
                                                                    
                                                                    <!-- Tiempo total -->
                                                                    <Label
                                                                        Grid.Column="3"
                                                                        FontSize="{StaticResource FontSizeCaption}"
                                                                        FontAttributes="Bold"
                                                                        Text="{Binding TotalFormatted}"
                                                                        TextColor="#FF4CAF50"
                                                                        VerticalOptions="Center"
                                                                        HorizontalOptions="End"
                                                                        WidthRequest="60" />
                                                                </Grid>
                                                            </Border>
                                                        </DataTemplate>
                                                    </BindableLayout.ItemTemplate>
                                                </VerticalStackLayout>
                                            </VerticalStackLayout>
                                        </Border>
                                    </DataTemplate>
                                </BindableLayout.ItemTemplate>
                            </VerticalStackLayout>
                        </VerticalStackLayout>
                        
                        <BoxView HeightRequest="1" BackgroundColor="#FF3A3A3A" IsVisible="{Binding HasSectionTimes}" />
                        
                        <!-- ===== VIDEO ACTUAL ===== -->
                        <VerticalStackLayout Spacing="8">
                            <Label
                                FontSize="{StaticResource FontSizeSmall}"
                                Text="VIDEO ACTUAL"
                                TextColor="#FF888888" />
                            
                            <!-- Posición en playlist -->
                            <Border
                                Padding="10"
                                BackgroundColor="#FF2A2A2A"
                                StrokeShape="RoundRectangle 8"
                                StrokeThickness="0">
                                <HorizontalStackLayout Spacing="8" HorizontalOptions="Center">
                                    <controls:SymbolIcon
                                        HeightRequest="16"
                                        SymbolName="play.rectangle.on.rectangle.fill"
                                        TintColor="#FFAAAAAA"
                                        WidthRequest="16" />
                                    <Label
                                        FontSize="{StaticResource FontSizeBody}"
                                        Text="{Binding PlaylistPositionText}"
                                        TextColor="White" />
                                </HorizontalStackLayout>
                            </Border>
                            
                            <!-- Grid de stats del video -->
                            <Grid ColumnDefinitions="*,*" ColumnSpacing="6" RowDefinitions="Auto,Auto" RowSpacing="6">
                                <!-- Duración -->
                                <Border
                                    Padding="8"
                                    BackgroundColor="#FF2A2A2A"
                                    StrokeShape="RoundRectangle 6"
                                    StrokeThickness="0">
                                    <VerticalStackLayout HorizontalOptions="Center" Spacing="2">
                                        <Label
                                            FontAttributes="Bold"
                                            FontSize="{StaticResource FontSizeBody}"
                                            HorizontalOptions="Center"
                                            Text="{Binding VideoDurationText}"
                                            TextColor="White" />
                                        <Label
                                            FontSize="{StaticResource FontSizeCaption}"
                                            HorizontalOptions="Center"
                                            Text="Duración"
                                            TextColor="#FF888888" />
                                    </VerticalStackLayout>
                                </Border>
                                
                                <!-- Sección -->
                                <Border
                                    Grid.Column="1"
                                    Padding="8"
                                    BackgroundColor="#FF2A2A2A"
                                    StrokeShape="RoundRectangle 6"
                                    StrokeThickness="0">
                                    <VerticalStackLayout HorizontalOptions="Center" Spacing="2">
                                        <Label
                                            FontAttributes="Bold"
                                            FontSize="{StaticResource FontSizeBody}"
                                            HorizontalOptions="Center"
                                            Text="{Binding SectionText}"
                                            TextColor="#FFFFA726" />
                                        <Label
                                            FontSize="{StaticResource FontSizeCaption}"
                                            HorizontalOptions="Center"
                                            Text="Tramo"
                                            TextColor="#FF888888" />
                                    </VerticalStackLayout>
                                </Border>
                                
                                <!-- Tamaño -->
                                <Border
                                    Grid.Row="1"
                                    Padding="8"
                                    BackgroundColor="#FF2A2A2A"
                                    StrokeShape="RoundRectangle 6"
                                    StrokeThickness="0">
                                    <VerticalStackLayout HorizontalOptions="Center" Spacing="2">
                                        <Label
                                            FontAttributes="Bold"
                                            FontSize="{StaticResource FontSizeBody}"
                                            HorizontalOptions="Center"
                                            Text="{Binding VideoSizeText}"
                                            TextColor="White" />
                                        <Label
                                            FontSize="{StaticResource FontSizeCaption}"
                                            HorizontalOptions="Center"
                                            Text="Tamaño"
                                            TextColor="#FF888888" />
                                    </VerticalStackLayout>
                                </Border>
                                
                                <!-- Eventos del video -->
                                <Border
                                    Grid.Row="1"
                                    Grid.Column="1"
                                    Padding="8"
                                    BackgroundColor="#FF2A2A2A"
                                    StrokeShape="RoundRectangle 6"
                                    StrokeThickness="0">
                                    <VerticalStackLayout HorizontalOptions="Center" Spacing="2">
                                        <Label
                                            FontAttributes="Bold"
                                            FontSize="{StaticResource FontSizeBody}"
                                            HorizontalOptions="Center"
                                            Text="{Binding TagEventsCountText}"
                                            TextColor="#FFFF7043" />
                                        <Label
                                            FontSize="{StaticResource FontSizeCaption}"
                                            HorizontalOptions="Center"
                                            Text="Eventos"
                                            TextColor="#FF888888" />
                                    </VerticalStackLayout>
                                </Border>
                            </Grid>
                        </VerticalStackLayout>
                        
                    </VerticalStackLayout>
                </ScrollView>

                <!-- ===== PESTAÑA: DIARIO DE SESIÓN ===== -->
                <ScrollView Grid.Row="1" IsVisible="{Binding IsDiaryTabSelected}">
                    <VerticalStackLayout Spacing="16">
                        
                        <!--  Título  -->
                        <Label
                            FontAttributes="Bold"
                            FontSize="{StaticResource FontSizeSubtitle}"
                            Text="Diario de Sesión"
                            TextColor="White" />
                        
                        <!--  ===== VISTA DE RESULTADOS (cuando hay datos guardados y no está editando) =====  -->
                        <Border
                            Padding="12"
                            BackgroundColor="#FF1E1E1E"
                            StrokeShape="RoundRectangle 8"
                            StrokeThickness="0"
                            IsVisible="{Binding ShowDiaryResults}">
                            <VerticalStackLayout Spacing="12">
                                <Label
                                    FontSize="{StaticResource FontSizeBody}"
                                    Text="Tu valoración de esta sesión"
                                    TextColor="White" />
                                
                                <!--  Resultados de valoración  -->
                                <Grid ColumnDefinitions="*,*,*" ColumnSpacing="8">
                                    <!--  Físico  -->
                                    <Border
                                        Padding="8"
                                        BackgroundColor="#FF2A2A2A"
                                        StrokeShape="RoundRectangle 6"
                                        StrokeThickness="0">
                                        <VerticalStackLayout Spacing="2" HorizontalOptions="Center">
                                            <Label
                                                FontAttributes="Bold"
                                                FontSize="{StaticResource FontSizeSubtitle}"
                                                HorizontalOptions="Center"
                                                Text="{Binding DiaryValoracionFisica}"
                                                TextColor="#FF8DD3C7" />
                                            <Label
                                                FontSize="{StaticResource FontSizeCaption}"
                                                HorizontalOptions="Center"
                                                Text="Físico"
                                                TextColor="#FF808080" />
                                        </VerticalStackLayout>
                                    </Border>
                                    
                                    <!--  Mental  -->
                                    <Border
                                        Grid.Column="1"
                                        Padding="8"
                                        BackgroundColor="#FF2A2A2A"
                                        StrokeShape="RoundRectangle 6"
                                        StrokeThickness="0">
                                        <VerticalStackLayout Spacing="2" HorizontalOptions="Center">
                                            <Label
                                                FontAttributes="Bold"
                                                FontSize="{StaticResource FontSizeSubtitle}"
                                                HorizontalOptions="Center"
                                                Text="{Binding DiaryValoracionMental}"
                                                TextColor="#FFFFED6F" />
                                            <Label
                                                FontSize="{StaticResource FontSizeCaption}"
                                                HorizontalOptions="Center"
                                                Text="Mental"
                                                TextColor="#FF808080" />
                                        </VerticalStackLayout>
                                    </Border>
                                    
                                    <!--  Técnico  -->
                                    <Border
                                        Grid.Column="2"
                                        Padding="8"
                                        BackgroundColor="#FF2A2A2A"
                                        StrokeShape="RoundRectangle 6"
                                        StrokeThickness="0">
                                        <VerticalStackLayout Spacing="2" HorizontalOptions="Center">
                                            <Label
                                                FontAttributes="Bold"
                                                FontSize="{StaticResource FontSizeSubtitle}"
                                                HorizontalOptions="Center"
                                                Text="{Binding DiaryValoracionTecnica}"
                                                TextColor="#FFBEBADA" />
                                            <Label
                                                FontSize="{StaticResource FontSizeCaption}"
                                                HorizontalOptions="Center"
                                                Text="Técnico"
                                                TextColor="#FF808080" />
                                        </VerticalStackLayout>
                                    </Border>
                                </Grid>
                                
                                <!--  Notas guardadas  -->
                                <VerticalStackLayout Spacing="4" IsVisible="{Binding DiaryNotas, Converter={StaticResource NotNullOrEmptyBoolConverter}}">
                                    <Label
                                        FontSize="{StaticResource FontSizeCaption}"
                                        Text="Notas"
                                        TextColor="#FF808080" />
                                    <Label
                                        FontSize="{StaticResource FontSizeBody}"
                                        Text="{Binding DiaryNotas}"
                                        TextColor="#FFCCCCCC" />
                                </VerticalStackLayout>
                                
                                <!--  Botón Editar valoración  -->
                                <Button
                                    Padding="12,8"
                                    BackgroundColor="#FF404040"
                                    Command="{Binding EditDiaryCommand}"
                                    CornerRadius="4"
                                    HorizontalOptions="Start"
                                    Text="Editar"
                                    TextColor="White" />
                            </VerticalStackLayout>
                        </Border>
                        
                        <!--  ===== FORMULARIO DE VALORACIÓN (cuando no hay datos o está editando) =====  -->
                        <Border
                            Padding="12"
                            BackgroundColor="Transparent"
                            StrokeShape="RoundRectangle 8"
                            StrokeThickness="0"
                            IsVisible="{Binding ShowDiaryForm}">
                            <VerticalStackLayout Spacing="12">
                                <Label
                                    FontSize="{StaticResource FontSizeBody}"
                                    Text="¿Cómo te has sentido hoy?"
                                    TextColor="White" />
                                
                                <!--  Valoración Física  -->
                                <Grid ColumnDefinitions="60,*,30" ColumnSpacing="8">
                                    <Label
                                        FontSize="{StaticResource FontSizeCaption}"
                                        Text="Físico"
                                        TextColor="#FFCCCCCC"
                                        VerticalOptions="Center" />
                                    <Slider
                                        Grid.Column="1"
                                        Maximum="5"
                                        Minimum="1"
                                        MinimumTrackColor="#FF8DD3C7"
                                        MaximumTrackColor="#FF404040"
                                        ThumbColor="#FF8DD3C7"
                                        Value="{Binding DiaryValoracionFisica}" />
                                    <Label
                                        Grid.Column="2"
                                        FontAttributes="Bold"
                                        FontSize="{StaticResource FontSizeBody}"
                                        HorizontalOptions="Center"
                                        Text="{Binding DiaryValoracionFisica}"
                                        TextColor="#FF8DD3C7"
                                        VerticalOptions="Center" />
                                </Grid>
                                
                                <!--  Valoración Mental  -->
                                <Grid ColumnDefinitions="60,*,30" ColumnSpacing="8">
                                    <Label
                                        FontSize="{StaticResource FontSizeCaption}"
                                        Text="Mental"
                                        TextColor="#FFCCCCCC"
                                        VerticalOptions="Center" />
                                    <Slider
                                        Grid.Column="1"
                                        Maximum="5"
                                        Minimum="1"
                                        MinimumTrackColor="#FFFFED6F"
                                        MaximumTrackColor="#FF404040"
                                        ThumbColor="#FFFFED6F"
                                        Value="{Binding DiaryValoracionMental}" />
                                    <Label
                                        Grid.Column="2"
                                        FontAttributes="Bold"
                                        FontSize="{StaticResource FontSizeBody}"
                                        HorizontalOptions="Center"
                                        Text="{Binding DiaryValoracionMental}"
                                        TextColor="#FFFFED6F"
                                        VerticalOptions="Center" />
                                </Grid>
                                
                                <!--  Valoración Técnica  -->
                                <Grid ColumnDefinitions="60,*,30" ColumnSpacing="8">
                                    <Label
                                        FontSize="{StaticResource FontSizeCaption}"
                                        Text="Técnico"
                                        TextColor="#FFCCCCCC"
                                        VerticalOptions="Center" />
                                    <Slider
                                        Grid.Column="1"
                                        Maximum="5"
                                        Minimum="1"
                                        MinimumTrackColor="#FFBEBADA"
                                        MaximumTrackColor="#FF404040"
                                        ThumbColor="#FFBEBADA"
                                        Value="{Binding DiaryValoracionTecnica}" />
                                    <Label
                                        Grid.Column="2"
                                        FontAttributes="Bold"
                                        FontSize="{StaticResource FontSizeBody}"
                                        HorizontalOptions="Center"
                                        Text="{Binding DiaryValoracionTecnica}"
                                        TextColor="#FFBEBADA"
                                        VerticalOptions="Center" />
                                </Grid>
                            </VerticalStackLayout>
                        </Border>

                        <BoxView HeightRequest="1" BackgroundColor="#FF3A3A3A"/>
                        
                        <!--  Promedios últimos 30 días  -->
                        <VerticalStackLayout Spacing="8">
                            <Grid ColumnDefinitions="*,Auto">
                                <Label
                                    FontSize="{StaticResource FontSizeSmall}"
                                    Text="PROMEDIOS (30 DÍAS)"
                                    TextColor="#FF888888"
                                    VerticalOptions="Center" />
                                <Label
                                    Grid.Column="1"
                                    FontSize="{StaticResource FontSizeCaption}"
                                    Text="{Binding AvgValoracionCount, StringFormat='{0} sesiones'}"
                                    TextColor="#FF606060"
                                    VerticalOptions="Center" />
                            </Grid>
                            
                            <Grid ColumnDefinitions="*,*,*" ColumnSpacing="8">
                                <!--  Promedio Físico  -->
                                <Border
                                    Padding="8"
                                    BackgroundColor="#FF1E1E1E"
                                    StrokeShape="RoundRectangle 6"
                                    StrokeThickness="0">
                                    <VerticalStackLayout Spacing="2" HorizontalOptions="Center">
                                        <Label
                                            FontAttributes="Bold"
                                            FontSize="{StaticResource FontSizeSubtitle}"
                                            HorizontalOptions="Center"
                                            Text="{Binding AvgValoracionFisica, StringFormat='{0:F1}'}"
                                            TextColor="#FF8DD3C7" />
                                        <Label
                                            FontSize="{StaticResource FontSizeCaption}"
                                            HorizontalOptions="Center"
                                            Text="Físico"
                                            TextColor="#FF808080" />
                                    </VerticalStackLayout>
                                </Border>
                                
                                <!--  Promedio Mental  -->
                                <Border
                                    Grid.Column="1"
                                    Padding="8"
                                    BackgroundColor="#FF1E1E1E"
                                    StrokeShape="RoundRectangle 6"
                                    StrokeThickness="0">
                                    <VerticalStackLayout Spacing="2" HorizontalOptions="Center">
                                        <Label
                                            FontAttributes="Bold"
                                            FontSize="{StaticResource FontSizeSubtitle}"
                                            HorizontalOptions="Center"
                                            Text="{Binding AvgValoracionMental, StringFormat='{0:F1}'}"
                                            TextColor="#FFFFED6F" />
                                        <Label
                                            FontSize="{StaticResource FontSizeCaption}"
                                            HorizontalOptions="Center"
                                            Text="Mental"
                                            TextColor="#FF808080" />
                                    </VerticalStackLayout>
                                </Border>
                                
                                <!--  Promedio Técnico  -->
                                <Border
                                    Grid.Column="2"
                                    Padding="8"
                                    BackgroundColor="#FF1E1E1E"
                                    StrokeShape="RoundRectangle 6"
                                    StrokeThickness="0">
                                    <VerticalStackLayout Spacing="2" HorizontalOptions="Center">
                                        <Label
                                            FontAttributes="Bold"
                                            FontSize="{StaticResource FontSizeSubtitle}"
                                            HorizontalOptions="Center"
                                            Text="{Binding AvgValoracionTecnica, StringFormat='{0:F1}'}"
                                            TextColor="#FFBEBADA" />
                                        <Label
                                            FontSize="{StaticResource FontSizeCaption}"
                                            HorizontalOptions="Center"
                                            Text="Técnico"
                                            TextColor="#FF808080" />
                                    </VerticalStackLayout>
                                </Border>
                            </Grid>
                        </VerticalStackLayout>
                        
                        <BoxView HeightRequest="1" BackgroundColor="#FF3A3A3A"/>
                        
                        <!--  Gráfico de evolución  -->
                        <VerticalStackLayout Spacing="8">
                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                                <Label
                                    FontSize="{StaticResource FontSizeSmall}"
                                    Text="EVOLUCIÓN"
                                    TextColor="#FF888888"
                                    VerticalOptions="Center" />
                                
                                <!--  Selector de periodo  -->
                                <Grid Grid.Column="1" ColumnDefinitions="Auto,Auto,Auto,Auto" ColumnSpacing="4">
                                    <Border
                                        Padding="6,3"
                                        BackgroundColor="{Binding SelectedEvolutionPeriod, Converter={StaticResource IntEqualityToColorConverter}, ConverterParameter='0:#FF3A3A3A:#FF1E1E1E'}"
                                        StrokeShape="RoundRectangle 4"
                                        StrokeThickness="0">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding SetEvolutionPeriodCommand}" CommandParameter="0" />
                                        </Border.GestureRecognizers>
                                        <Label FontSize="{StaticResource FontSizeCaption}" Text="7d" TextColor="White" />
                                    </Border>
                                    <Border
                                        Grid.Column="1"
                                        Padding="6,3"
                                        BackgroundColor="{Binding SelectedEvolutionPeriod, Converter={StaticResource IntEqualityToColorConverter}, ConverterParameter='1:#FF3A3A3A:#FF1E1E1E'}"
                                        StrokeShape="RoundRectangle 4"
                                        StrokeThickness="0">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding SetEvolutionPeriodCommand}" CommandParameter="1" />
                                        </Border.GestureRecognizers>
                                        <Label FontSize="{StaticResource FontSizeCaption}" Text="30d" TextColor="White" />
                                    </Border>
                                    <Border
                                        Grid.Column="2"
                                        Padding="6,3"
                                        BackgroundColor="{Binding SelectedEvolutionPeriod, Converter={StaticResource IntEqualityToColorConverter}, ConverterParameter='2:#FF3A3A3A:#FF1E1E1E'}"
                                        StrokeShape="RoundRectangle 4"
                                        StrokeThickness="0">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding SetEvolutionPeriodCommand}" CommandParameter="2" />
                                        </Border.GestureRecognizers>
                                        <Label FontSize="{StaticResource FontSizeCaption}" Text="1a" TextColor="White" />
                                    </Border>
                                    <Border
                                        Grid.Column="3"
                                        Padding="6,3"
                                        BackgroundColor="{Binding SelectedEvolutionPeriod, Converter={StaticResource IntEqualityToColorConverter}, ConverterParameter='3:#FF3A3A3A:#FF1E1E1E'}"
                                        StrokeShape="RoundRectangle 4"
                                        StrokeThickness="0">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding SetEvolutionPeriodCommand}" CommandParameter="3" />
                                        </Border.GestureRecognizers>
                                        <Label FontSize="{StaticResource FontSizeCaption}" Text="Todo" TextColor="White" />
                                    </Border>
                                </Grid>
                            </Grid>
                            
                            <!--  Leyenda  -->
                            <HorizontalStackLayout Spacing="12" HorizontalOptions="Center">
                                <HorizontalStackLayout Spacing="4">
                                    <BoxView WidthRequest="10" HeightRequest="10" Color="#FF8DD3C7" CornerRadius="2" />
                                    <Label FontSize="{StaticResource FontSizeCaption}" Text="Físico" TextColor="#FF808080" />
                                </HorizontalStackLayout>
                                <HorizontalStackLayout Spacing="4">
                                    <BoxView WidthRequest="10" HeightRequest="10" Color="#FFFFED6F" CornerRadius="2" />
                                    <Label FontSize="{StaticResource FontSizeCaption}" Text="Mental" TextColor="#FF808080" />
                                </HorizontalStackLayout>
                                <HorizontalStackLayout Spacing="4">
                                    <BoxView WidthRequest="10" HeightRequest="10" Color="#FFBEBADA" CornerRadius="2" />
                                    <Label FontSize="{StaticResource FontSizeCaption}" Text="Técnico" TextColor="#FF808080" />
                                </HorizontalStackLayout>
                            </HorizontalStackLayout>
                            
                            <!--  Mensaje si no hay datos  -->
                            <Label
                                IsVisible="{Binding ValoracionEvolution.Count, Converter={StaticResource IntToBoolConverter}, ConverterParameter=invert}"
                                FontSize="{StaticResource FontSizeCaption}"
                                HorizontalOptions="Center"
                                Text="No hay datos de evolución"
                                TextColor="#FF606060" />
                            
                            <!--  Gráfico de evolución de valoraciones  -->
                            <controls:MultiLineChart 
                                IsVisible="{Binding ValoracionEvolution.Count, Converter={StaticResource IntToBoolConverter}}"
                                HeightRequest="140"
                                Values1="{Binding EvolutionFisicaValues}"
                                Values2="{Binding EvolutionMentalValues}"
                                Values3="{Binding EvolutionTecnicaValues}"
                                Labels="{Binding EvolutionLabels}"
                                MinValue="1"
                                MaxValue="5" />
                        </VerticalStackLayout>

                        <BoxView HeightRequest="1" BackgroundColor="#FF3A3A3A"/>
                        
                        <!--  Notas de sesión (solo en modo edición)  -->
                        <Border
                            Padding="12"
                            BackgroundColor="#FF1E1E1E"
                            StrokeShape="RoundRectangle 8"
                            StrokeThickness="0"
                            IsVisible="{Binding ShowDiaryForm}">
                            <VerticalStackLayout Spacing="8">
                                <Label
                                    FontSize="{StaticResource FontSizeSmall}"
                                    Text="NOTAS DE SESIÓN"
                                    TextColor="#FF888888" />
                                
                                <Editor
                                    AutoSize="TextChanges"
                                    BackgroundColor="#FF1E1E1E"
                                    MinimumHeightRequest="120"
                                    Placeholder="Escribe tus notas sobre la sesión..."
                                    PlaceholderColor="#FF606060"
                                    Text="{Binding DiaryNotas}"
                                    TextColor="White" />
                            </VerticalStackLayout>
                        </Border>
                        
                        <!--  Botón Guardar (solo en modo edición)  -->
                        <Button
                            Padding="16,10"
                            BackgroundColor="#FF303030"
                            Command="{Binding SaveDiaryCommand}"
                            CornerRadius="4"
                            HorizontalOptions="Fill"
                            Text="Guardar Diario"
                            TextColor="White"
                            IsVisible="{Binding ShowDiaryForm}" />
                        
                    </VerticalStackLayout>
                </ScrollView>

            </Grid>
        </Border>

        <!--  Controles de reproducción  -->
        <!--  En Windows/MacCatalyst/iOS: Row 1 debajo del player, en columna 2  -->
        <!--  En otras plataformas: Row 1 en columna 0  -->
        <Border
            x:Name="PlayerControlsBorder"
            Grid.Row="1"
            StrokeShape="RoundRectangle 8"
            StrokeThickness="0"
            HorizontalOptions="Fill">
            <Grid.Column>
                <OnPlatform x:TypeArguments="x:Int32">
                    <On Platform="WinUI,MacCatalyst,iOS" Value="2" />
                    <On Platform="Default" Value="0" />
                </OnPlatform>
            </Grid.Column>
            <Border.WidthRequest>
                <OnPlatform x:TypeArguments="x:Double">
                    <On Platform="WinUI" Value="-1" />
                    <On Platform="iOS" Value="-1" />
                    <On Platform="Default" Value="-1" />
                </OnPlatform>
            </Border.WidthRequest>
            <Border.HorizontalOptions>
                <OnPlatform x:TypeArguments="LayoutOptions">
                    <On Platform="WinUI,iOS" Value="Fill" />
                    <On Platform="Default" Value="Center" />
                </OnPlatform>
            </Border.HorizontalOptions>
            <Border.BackgroundColor>
                <OnPlatform x:TypeArguments="Color">
                    <On Platform="WinUI" Value="#CC121212" />
                    <On Platform="iOS" Value="#CC000000" />
                    <On Platform="Default" Value="#FF121212" />
                </OnPlatform>
            </Border.BackgroundColor>
            <Border.Margin>
                <OnPlatform x:TypeArguments="Thickness">
                    <On Platform="WinUI" Value="16,0,16,8" />
                    <On Platform="iOS" Value="8,0,8,4" />
                    <On Platform="Default" Value="16" />
                </OnPlatform>
            </Border.Margin>
            <Border.Padding>
                <OnPlatform x:TypeArguments="Thickness">
                    <On Platform="WinUI" Value="16,8" />
                    <On Platform="iOS" Value="8,6" />
                    <On Platform="Default" Value="16" />
                </OnPlatform>
            </Border.Padding>
            
            <!-- Grid contenedor único para ambos layouts -->
            <Grid>
                <!-- ===================== LAYOUT Windows/MacCatalyst/iOS: Controles centrados ===================== -->
                <Grid>
                    <Grid.IsVisible>
                        <OnPlatform x:TypeArguments="x:Boolean">
                            <On Platform="WinUI,MacCatalyst,iOS" Value="True" />
                            <On Platform="Default" Value="False" />
                        </OnPlatform>
                    </Grid.IsVisible>
                    
                    <!-- Controles centrales (slider + botones) -->
                    <Grid RowDefinitions="Auto,Auto" RowSpacing="4">
                        <!-- Fila 0: Slider con tiempo -->
                        <Grid Grid.Row="0" ColumnDefinitions="Auto,*,Auto" ColumnSpacing="8">
                            <Label
                                Grid.Column="0"
                                FontFamily="{StaticResource AppFontMono}"
                                FontSize="{StaticResource FontSizeSmall}"
                                Text="{Binding CurrentPositionText}"
                                TextColor="#FFB1B1B1"
                                VerticalOptions="Center" />
                            <Slider
                                x:Name="ProgressSliderWindows"
                                Grid.Column="1"
                                DragCompleted="OnSliderDragCompleted"
                                DragStarted="OnSliderDragStarted"
                                Maximum="1"
                                MaximumTrackColor="#FF3A3A3A"
                                Minimum="0"
                                MinimumTrackColor="#FF5A5A5A"
                                ThumbColor="#FF8A8A8A"
                                ValueChanged="OnSliderValueChanged" />
                            <Label
                                Grid.Column="2"
                                FontFamily="{StaticResource AppFontMono}"
                                FontSize="{StaticResource FontSizeSmall}"
                                Text="{Binding DurationText}"
                                TextColor="#FFB1B1B1"
                                VerticalOptions="Center" />
                        </Grid>
                        
                        <!-- Fila 1: Botones de control -->
                        <HorizontalStackLayout Grid.Row="1" HorizontalOptions="Center" Spacing="6">
                            <!-- Botones de reproducción -->
                            <Border Padding="8,4" BackgroundColor="#FF2A2A2A" StrokeShape="RoundRectangle 4" StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding FrameBackwardCommand}" />
                                </Border.GestureRecognizers>
                                <controls:SymbolIcon HeightRequest="18" WidthRequest="18" SymbolName="backward.frame.fill" TintColor="White" />
                            </Border>
                            <Border Padding="8,4" BackgroundColor="#FF2A2A2A" StrokeShape="RoundRectangle 4" StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding SeekBackwardCommand}" />
                                </Border.GestureRecognizers>
                                <controls:SymbolIcon HeightRequest="18" WidthRequest="18" SymbolName="gobackward.5" TintColor="White" />
                            </Border>
                            <Border Padding="16,4" BackgroundColor="#FF4A4A4A" StrokeShape="RoundRectangle 4" StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding PlayPauseCommand}" />
                                </Border.GestureRecognizers>
                                <controls:SymbolIcon HeightRequest="18" WidthRequest="18" SymbolName="{Binding PlayPauseIcon}" TintColor="Black" />
                            </Border>
                            <Border Padding="8,4" BackgroundColor="#FF2A2A2A" StrokeShape="RoundRectangle 4" StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding SeekForwardCommand}" />
                                </Border.GestureRecognizers>
                                <controls:SymbolIcon HeightRequest="18" WidthRequest="18" SymbolName="goforward.5" TintColor="White" />
                            </Border>
                            <Border Padding="8,4" BackgroundColor="#FF2A2A2A" StrokeShape="RoundRectangle 4" StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding FrameForwardCommand}" />
                                </Border.GestureRecognizers>
                                <controls:SymbolIcon HeightRequest="18" WidthRequest="18" SymbolName="forward.frame.fill" TintColor="White" />
                            </Border>
                            <Border Padding="8,4" BackgroundColor="#FF2A2A2A" StrokeShape="RoundRectangle 4" StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ToggleMuteCommand}" />
                                </Border.GestureRecognizers>
                                <controls:SymbolIcon HeightRequest="18" WidthRequest="18" SymbolName="{Binding MuteIcon}" TintColor="White" />
                            </Border>
                            
                            <!-- Separador -->
                            <BoxView WidthRequest="1" HeightRequest="24" BackgroundColor="#FF3A3A3A" Margin="4,0" />
                            
                            <!-- Botones toggle paneles (solo iOS) -->
                            <HorizontalStackLayout Spacing="4">
                                <HorizontalStackLayout.IsVisible>
                                    <OnPlatform x:TypeArguments="x:Boolean">
                                        <On Platform="iOS" Value="True" />
                                        <On Platform="Default" Value="False" />
                                    </OnPlatform>
                                </HorizontalStackLayout.IsVisible>
                                <!-- Toggle panel izquierdo (Galería) -->
                                <Border Padding="8,4" BackgroundColor="{Binding IsLeftPanelVisible, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF4A4A4A|#FF2A2A2A'}" StrokeShape="RoundRectangle 4" StrokeThickness="0">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding ToggleLeftPanelCommand}" />
                                    </Border.GestureRecognizers>
                                    <controls:SymbolIcon HeightRequest="18" WidthRequest="18" SymbolName="sidebar.left" TintColor="White" />
                                </Border>
                                <!-- Toggle panel derecho (Herramientas) -->
                                <Border Padding="8,4" BackgroundColor="{Binding IsRightPanelVisible, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF4A4A4A|#FF2A2A2A'}" StrokeShape="RoundRectangle 4" StrokeThickness="0">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding ToggleRightPanelCommand}" />
                                    </Border.GestureRecognizers>
                                    <controls:SymbolIcon HeightRequest="18" WidthRequest="18" SymbolName="sidebar.right" TintColor="White" />
                                </Border>
                                <!-- Separador después de toggle paneles -->
                                <BoxView WidthRequest="1" HeightRequest="24" BackgroundColor="#FF3A3A3A" Margin="4,0" />
                            </HorizontalStackLayout>
                            
                            <!-- Velocidad compacta -->
                            <HorizontalStackLayout Spacing="4">
                                <Label FontSize="{StaticResource FontSizeSmall}" Text="{Binding SpeedText}" TextColor="White" VerticalOptions="Center" />
                                <Border Padding="6,3" BackgroundColor="#FF3A3A3A" StrokeShape="RoundRectangle 4" StrokeThickness="0">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding SetSpeedCommand}" CommandParameter="0.25" />
                                    </Border.GestureRecognizers>
                                    <Label FontSize="{StaticResource FontSizeSmall}" Text="0.25x" TextColor="#FFB1B1B1" />
                                </Border>
                                <Border Padding="6,3" BackgroundColor="#FF3A3A3A" StrokeShape="RoundRectangle 4" StrokeThickness="0">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding SetSpeedCommand}" CommandParameter="0.5" />
                                    </Border.GestureRecognizers>
                                    <Label FontSize="{StaticResource FontSizeSmall}" Text="0.5x" TextColor="#FFB1B1B1" />
                                </Border>
                                <Border Padding="6,3" BackgroundColor="#FF3A3A3A" StrokeShape="RoundRectangle 4" StrokeThickness="0">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding SetSpeedCommand}" CommandParameter="1" />
                                    </Border.GestureRecognizers>
                                    <Label FontSize="{StaticResource FontSizeSmall}" Text="1x" TextColor="#FFB1B1B1" />
                                </Border>
                                <Border Padding="6,3" BackgroundColor="#FF3A3A3A" StrokeShape="RoundRectangle 4" StrokeThickness="0">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding SetSpeedCommand}" CommandParameter="2" />
                                    </Border.GestureRecognizers>
                                    <Label FontSize="{StaticResource FontSizeSmall}" Text="2x" TextColor="#FFB1B1B1" />
                                </Border>
                            </HorizontalStackLayout>
                        </HorizontalStackLayout>
                    </Grid>
                </Grid>
                
                <!-- ===================== LAYOUT legacy (otras plataformas, no iOS): Slider izquierda, botones derecha ===================== -->
                <Grid RowDefinitions="Auto,Auto" RowSpacing="8">
                    <Grid.IsVisible>
                        <OnPlatform x:TypeArguments="x:Boolean">
                            <On Platform="Android" Value="True" />
                            <On Platform="Default" Value="False" />
                        </OnPlatform>
                    </Grid.IsVisible>
                    
                    <!-- Fila 0: Controles principales -->
                    <Grid Grid.Row="0" ColumnDefinitions="*,Auto" ColumnSpacing="12">
                    <!--  Slider con tiempo (izquierda)  -->
                    <Grid Grid.Column="0" ColumnDefinitions="Auto,*,Auto" ColumnSpacing="8" VerticalOptions="Center">
                        <Label
                            Grid.Column="0"
                            FontFamily="{StaticResource AppFontMono}"
                            FontSize="11"
                            Text="{Binding CurrentPositionText}"
                            TextColor="#FFB1B1B1"
                            VerticalOptions="Center" />
                        <Slider
                            x:Name="ProgressSliderIOS"
                            Grid.Column="1"
                            DragCompleted="OnSliderDragCompleted"
                            DragStarted="OnSliderDragStarted"
                            Maximum="1"
                            MaximumTrackColor="#FF3A3A3A"
                            Minimum="0"
                            MinimumTrackColor="#FF5A5A5A"
                            ThumbColor="#FF8A8A8A"
                            ValueChanged="OnSliderValueChanged" />
                        <Label
                            Grid.Column="2"
                            FontFamily="{StaticResource AppFontMono}"
                            FontSize="11"
                            Text="{Binding DurationText}"
                            TextColor="#FFB1B1B1"
                            VerticalOptions="Center" />
                    </Grid>
                    
                    <!--  Botones de control (derecha)  -->
                    <HorizontalStackLayout Grid.Column="1" Spacing="4" VerticalOptions="Center">
                        <!--  Frame anterior  -->
                        <Border Padding="6,4" BackgroundColor="#FF2A2A2A" StrokeShape="RoundRectangle 4" StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding FrameBackwardCommand}" />
                            </Border.GestureRecognizers>
                            <controls:SymbolIcon HeightRequest="16" WidthRequest="16" SymbolName="backward.frame.fill" TintColor="White" />
                        </Border>
                        <!--  Retroceso 5s  -->
                        <Border Padding="6,4" BackgroundColor="#FF2A2A2A" StrokeShape="RoundRectangle 4" StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding SeekBackwardCommand}" />
                            </Border.GestureRecognizers>
                            <controls:SymbolIcon HeightRequest="16" WidthRequest="16" SymbolName="gobackward.5" TintColor="White" />
                        </Border>
                        <!--  Play/Pause  -->
                        <Border Padding="12,4" BackgroundColor="#FF4A4A4A" StrokeShape="RoundRectangle 4" StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding PlayPauseCommand}" />
                            </Border.GestureRecognizers>
                            <controls:SymbolIcon HeightRequest="16" WidthRequest="16" SymbolName="{Binding PlayPauseIcon}" TintColor="Black" />
                        </Border>
                        <!--  Avance 5s  -->
                        <Border Padding="6,4" BackgroundColor="#FF2A2A2A" StrokeShape="RoundRectangle 4" StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding SeekForwardCommand}" />
                            </Border.GestureRecognizers>
                            <controls:SymbolIcon HeightRequest="16" WidthRequest="16" SymbolName="goforward.5" TintColor="White" />
                        </Border>
                        <!--  Frame siguiente  -->
                        <Border Padding="6,4" BackgroundColor="#FF2A2A2A" StrokeShape="RoundRectangle 4" StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding FrameForwardCommand}" />
                            </Border.GestureRecognizers>
                            <controls:SymbolIcon HeightRequest="16" WidthRequest="16" SymbolName="forward.frame.fill" TintColor="White" />
                        </Border>
                        <!--  Mute  -->
                        <Border Padding="6,4" BackgroundColor="#FF2A2A2A" StrokeShape="RoundRectangle 4" StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ToggleMuteCommand}" />
                            </Border.GestureRecognizers>
                            <controls:SymbolIcon HeightRequest="16" WidthRequest="16" SymbolName="{Binding MuteIcon}" TintColor="White" />
                        </Border>
                        <!--  Separador  -->
                        <BoxView WidthRequest="1" HeightRequest="20" BackgroundColor="#FF3A3A3A" Margin="4,0" />
                        <!--  Navegación anterior  -->
                        <Border Padding="6,4" BackgroundColor="#FF2A2A2A" StrokeShape="RoundRectangle 4" StrokeThickness="0"
                                IsEnabled="{Binding CanGoPrevious}" Opacity="{Binding CanGoPrevious, Converter={StaticResource BoolToOpacityConverter}}">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding PreviousVideoCommand}" />
                            </Border.GestureRecognizers>
                            <controls:SymbolIcon HeightRequest="14" WidthRequest="14" SymbolName="chevron.left" TintColor="White" />
                        </Border>
                        <!--  Posición + Filtros  -->
                        <Label FontSize="10" Text="{Binding PlaylistPositionText}" TextColor="#FFB1B1B1" VerticalOptions="Center" />
                        <Border Padding="6,4" BackgroundColor="#FF2A2A2A" StrokeShape="RoundRectangle 4" StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ToggleFiltersCommand}" />
                            </Border.GestureRecognizers>
                            <controls:SymbolIcon HeightRequest="12" WidthRequest="12" SymbolName="line.3.horizontal.decrease" TintColor="#FFAAAAAA" />
                        </Border>
                        <!--  Navegación siguiente  -->
                        <Border Padding="6,4" BackgroundColor="#FF2A2A2A" StrokeShape="RoundRectangle 4" StrokeThickness="0"
                                IsEnabled="{Binding CanGoNext}" Opacity="{Binding CanGoNext, Converter={StaticResource BoolToOpacityConverter}}">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding NextVideoCommand}" />
                            </Border.GestureRecognizers>
                            <controls:SymbolIcon HeightRequest="14" WidthRequest="14" SymbolName="chevron.right" TintColor="White" />
                        </Border>
                    </HorizontalStackLayout>
                    </Grid>
                    
                    <!-- Fila 1: Panel de filtros iOS (visible cuando ShowFilters=True) -->
                    <HorizontalStackLayout
                        Grid.Row="1"
                        HorizontalOptions="Center"
                        IsVisible="{Binding ShowFilters}"
                        Spacing="8">
                        
                        <!--  Filtro de atleta  -->
                        <Border
                            x:Name="AthleteDropdownIOS"
                            Padding="8,6"
                            BackgroundColor="#FF2A2A2A"
                            StrokeShape="RoundRectangle 4"
                            StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnAthleteDropdownTapped" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="6">
                                <Label
                                    FontSize="11"
                                    MaximumWidthRequest="100"
                                    LineBreakMode="TailTruncation"
                                    Text="{Binding SelectedAthlete.DisplayName, FallbackValue='Atleta'}"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                                <controls:SymbolIcon
                                    HeightRequest="10"
                                    SymbolName="chevron.down"
                                    TintColor="#FF888888"
                                    WidthRequest="10" />
                            </HorizontalStackLayout>
                        </Border>
                        
                        <!--  Filtro de sección  -->
                        <Border
                            x:Name="SectionDropdownIOS"
                            Padding="8,6"
                            BackgroundColor="#FF2A2A2A"
                            StrokeShape="RoundRectangle 4"
                            StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnSectionDropdownTapped" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="6">
                                <Label
                                    FontSize="11"
                                    MaximumWidthRequest="100"
                                    LineBreakMode="TailTruncation"
                                    Text="{Binding SelectedSection.DisplayName, FallbackValue='Sección'}"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                                <controls:SymbolIcon
                                    HeightRequest="10"
                                    SymbolName="chevron.down"
                                    TintColor="#FF888888"
                                    WidthRequest="10" />
                            </HorizontalStackLayout>
                        </Border>
                        
                        <!--  Filtro de categoría  -->
                        <Border
                            x:Name="CategoryDropdownIOS"
                            Padding="8,6"
                            BackgroundColor="#FF2A2A2A"
                            StrokeShape="RoundRectangle 4"
                            StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnCategoryDropdownTapped" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="6">
                                <Label
                                    FontSize="11"
                                    MaximumWidthRequest="100"
                                    LineBreakMode="TailTruncation"
                                    Text="{Binding SelectedCategory.DisplayName, FallbackValue='Categoría'}"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                                <controls:SymbolIcon
                                    HeightRequest="10"
                                    SymbolName="chevron.down"
                                    TintColor="#FF888888"
                                    WidthRequest="10" />
                            </HorizontalStackLayout>
                        </Border>
                        
                        <!--  Botón limpiar filtros  -->
                        <Border
                            Padding="8,6"
                            BackgroundColor="#FF2A2A2A"
                            StrokeShape="RoundRectangle 4"
                            StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ClearFiltersCommand}" />
                            </Border.GestureRecognizers>
                            <controls:SymbolIcon
                                HeightRequest="12"
                                SymbolName="xmark.circle.fill"
                                TintColor="#FF888888"
                                WidthRequest="12" />
                        </Border>
                    </HorizontalStackLayout>
                </Grid>
            
                <!-- ===================== LAYOUT otras plataformas: Slider arriba, botones abajo ===================== -->
                <VerticalStackLayout>
                <VerticalStackLayout.IsVisible>
                    <OnPlatform x:TypeArguments="x:Boolean">
                        <On Platform="iOS" Value="False" />
                        <On Platform="WinUI" Value="False" />
                        <On Platform="MacCatalyst" Value="False" />
                        <On Platform="Default" Value="True" />
                    </OnPlatform>
                </VerticalStackLayout.IsVisible>
                <VerticalStackLayout.Spacing>
                    <OnPlatform x:TypeArguments="x:Double">
                        <On Platform="WinUI" Value="4" />
                        <On Platform="Default" Value="12" />
                    </OnPlatform>
                </VerticalStackLayout.Spacing>

                <!--  Barra de progreso con tiempo  -->
                <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12">
                    <Label
                        Grid.Column="0"
                        FontFamily="{StaticResource AppFontMono}"
                        FontSize="{StaticResource FontSizeSmall}"
                        Text="{Binding CurrentPositionText}"
                        TextColor="#FFB1B1B1"
                        VerticalOptions="Center" />
                    <Grid Grid.Column="1" RowDefinitions="14,*" RowSpacing="2">
                        <!-- Marcadores de eventos a lo largo del slider -->
                        <AbsoluteLayout
                            Grid.Row="0"
                            HeightRequest="14"
                            HorizontalOptions="Fill"
                            VerticalOptions="Center"
                            BindableLayout.ItemsSource="{Binding TimelineMarkers}">
                            <BindableLayout.ItemTemplate>
                                <DataTemplate x:DataType="models:TimelineMarker">
                                    <Button
                                        BackgroundColor="#FF373737"
                                        CornerRadius="4"
                                        FontSize="{StaticResource FontSizeSmall}"
                                        HeightRequest="24"
                                        MinimumHeightRequest="24"
                                        Padding="8,0"
                                        Text="{Binding Label}"
                                        TextColor="White"
                                        AbsoluteLayout.LayoutFlags="PositionProportional"
                                        AbsoluteLayout.LayoutBounds="{Binding Position, Converter={StaticResource NormalizedPositionToRectConverter}}"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SeekToTimelineMarkerCommand}"
                                        CommandParameter="{Binding .}" />
                                </DataTemplate>
                            </BindableLayout.ItemTemplate>
                        </AbsoluteLayout>

                        <Grid Grid.Row="1">
                            <!-- Ticks naranjas en la zona del slider -->
                            <AbsoluteLayout
                                HeightRequest="14"
                                HorizontalOptions="Fill"
                                VerticalOptions="Center"
                                InputTransparent="True" ZIndex="1"
                                BindableLayout.ItemsSource="{Binding TimelineMarkers}">
                                <BindableLayout.ItemTemplate>
                                    <DataTemplate x:DataType="models:TimelineMarker">
                                        <BoxView
                                            Color="#FFFF5555" WidthRequest="22" HeightRequest="5"
                                            AbsoluteLayout.LayoutFlags="PositionProportional"
                                            AbsoluteLayout.LayoutBounds="{Binding Position, Converter={StaticResource NormalizedPositionToTickRectConverter}}" />
                                    </DataTemplate>
                                </BindableLayout.ItemTemplate>
                            </AbsoluteLayout>
                            <Slider
                                x:Name="ProgressSlider"
                                DragCompleted="OnSliderDragCompleted"
                                DragStarted="OnSliderDragStarted"
                                Maximum="1"
                                MaximumTrackColor="#FF3A3A3A"
                                Minimum="0"
                                MinimumTrackColor="#FF5A5A5A"
                                ThumbColor="#FF8A8A8A"
                                ValueChanged="OnSliderValueChanged" />
                        </Grid>
                    </Grid>
                    <Label
                        Grid.Column="2"
                        FontFamily="{StaticResource AppFontMono}"
                        FontSize="{StaticResource FontSizeSmall}"
                        Text="{Binding DurationText}"
                        TextColor="#FFB1B1B1"
                        VerticalOptions="Center" />
                </Grid>

                <!--  Botones de control principales  -->
                <HorizontalStackLayout HorizontalOptions="Center">
                    <HorizontalStackLayout.Spacing>
                        <OnPlatform x:TypeArguments="x:Double">
                            <On Platform="iOS" Value="6" />
                            <On Platform="Default" Value="12" />
                        </OnPlatform>
                    </HorizontalStackLayout.Spacing>
                    <!--  Frame anterior  -->
                    <Border
                        Padding="{StaticResource PlayerButtonPadding}"
                        BackgroundColor="#FF2A2A2A"
                        StrokeShape="RoundRectangle 4"
                        StrokeThickness="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding FrameBackwardCommand}" />
                        </Border.GestureRecognizers>
                        <controls:SymbolIcon
                            SymbolName="backward.frame.fill"
                            TintColor="White">
                            <controls:SymbolIcon.HeightRequest>
                                <OnPlatform x:TypeArguments="x:Double">
                                    <On Platform="iOS" Value="18" />
                                    <On Platform="Default" Value="24" />
                                </OnPlatform>
                            </controls:SymbolIcon.HeightRequest>
                            <controls:SymbolIcon.WidthRequest>
                                <OnPlatform x:TypeArguments="x:Double">
                                    <On Platform="iOS" Value="18" />
                                    <On Platform="Default" Value="24" />
                                </OnPlatform>
                            </controls:SymbolIcon.WidthRequest>
                        </controls:SymbolIcon>
                    </Border>

                    <!--  Retroceso 5s  -->
                    <Border
                        Padding="{StaticResource PlayerButtonPadding}"
                        BackgroundColor="#FF2A2A2A"
                        StrokeShape="RoundRectangle 4"
                        StrokeThickness="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding SeekBackwardCommand}" />
                        </Border.GestureRecognizers>
                        <controls:SymbolIcon
                            SymbolName="gobackward.5"
                            TintColor="White">
                            <controls:SymbolIcon.HeightRequest>
                                <OnPlatform x:TypeArguments="x:Double">
                                    <On Platform="iOS" Value="18" />
                                    <On Platform="Default" Value="24" />
                                </OnPlatform>
                            </controls:SymbolIcon.HeightRequest>
                            <controls:SymbolIcon.WidthRequest>
                                <OnPlatform x:TypeArguments="x:Double">
                                    <On Platform="iOS" Value="18" />
                                    <On Platform="Default" Value="24" />
                                </OnPlatform>
                            </controls:SymbolIcon.WidthRequest>
                        </controls:SymbolIcon>
                    </Border>

                    <!--  Play/Pause  -->
                    <Border
                        Padding="{StaticResource PlayerPlayButtonPadding}"
                        BackgroundColor="#FF4A4A4A"
                        StrokeShape="RoundRectangle 4"
                        StrokeThickness="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding PlayPauseCommand}" />
                        </Border.GestureRecognizers>
                        <controls:SymbolIcon
                            SymbolName="{Binding PlayPauseIcon}"
                            TintColor="Black">
                            <controls:SymbolIcon.HeightRequest>
                                <OnPlatform x:TypeArguments="x:Double">
                                    <On Platform="iOS" Value="18" />
                                    <On Platform="Default" Value="24" />
                                </OnPlatform>
                            </controls:SymbolIcon.HeightRequest>
                            <controls:SymbolIcon.WidthRequest>
                                <OnPlatform x:TypeArguments="x:Double">
                                    <On Platform="iOS" Value="18" />
                                    <On Platform="Default" Value="24" />
                                </OnPlatform>
                            </controls:SymbolIcon.WidthRequest>
                        </controls:SymbolIcon>
                    </Border>

                    <!--  Avance 5s  -->
                    <Border
                        Padding="{StaticResource PlayerButtonPadding}"
                        BackgroundColor="#FF2A2A2A"
                        StrokeShape="RoundRectangle 4"
                        StrokeThickness="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding SeekForwardCommand}" />
                        </Border.GestureRecognizers>
                        <controls:SymbolIcon
                            SymbolName="goforward.5"
                            TintColor="White">
                            <controls:SymbolIcon.HeightRequest>
                                <OnPlatform x:TypeArguments="x:Double">
                                    <On Platform="iOS" Value="18" />
                                    <On Platform="Default" Value="24" />
                                </OnPlatform>
                            </controls:SymbolIcon.HeightRequest>
                            <controls:SymbolIcon.WidthRequest>
                                <OnPlatform x:TypeArguments="x:Double">
                                    <On Platform="iOS" Value="18" />
                                    <On Platform="Default" Value="24" />
                                </OnPlatform>
                            </controls:SymbolIcon.WidthRequest>
                        </controls:SymbolIcon>
                    </Border>

                    <!--  Frame siguiente  -->
                    <Border
                        Padding="{StaticResource PlayerButtonPadding}"
                        BackgroundColor="#FF2A2A2A"
                        StrokeShape="RoundRectangle 4"
                        StrokeThickness="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding FrameForwardCommand}" />
                        </Border.GestureRecognizers>
                        <controls:SymbolIcon
                            SymbolName="forward.frame.fill"
                            TintColor="White">
                            <controls:SymbolIcon.HeightRequest>
                                <OnPlatform x:TypeArguments="x:Double">
                                    <On Platform="iOS" Value="18" />
                                    <On Platform="Default" Value="24" />
                                </OnPlatform>
                            </controls:SymbolIcon.HeightRequest>
                            <controls:SymbolIcon.WidthRequest>
                                <OnPlatform x:TypeArguments="x:Double">
                                    <On Platform="iOS" Value="18" />
                                    <On Platform="Default" Value="24" />
                                </OnPlatform>
                            </controls:SymbolIcon.WidthRequest>
                        </controls:SymbolIcon>
                    </Border>

                    <!--  Mute  -->
                    <Border
                        Padding="{StaticResource PlayerButtonPadding}"
                        BackgroundColor="#FF2A2A2A"
                        StrokeShape="RoundRectangle 4"
                        StrokeThickness="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding ToggleMuteCommand}" />
                        </Border.GestureRecognizers>
                        <controls:SymbolIcon
                            SymbolName="{Binding MuteIcon}"
                            TintColor="White">
                            <controls:SymbolIcon.HeightRequest>
                                <OnPlatform x:TypeArguments="x:Double">
                                    <On Platform="iOS" Value="18" />
                                    <On Platform="Default" Value="24" />
                                </OnPlatform>
                            </controls:SymbolIcon.HeightRequest>
                            <controls:SymbolIcon.WidthRequest>
                                <OnPlatform x:TypeArguments="x:Double">
                                    <On Platform="iOS" Value="18" />
                                    <On Platform="Default" Value="24" />
                                </OnPlatform>
                            </controls:SymbolIcon.WidthRequest>
                        </controls:SymbolIcon>
                    </Border>

                    <!--  Separador (oculto en iOS)  -->
                    <BoxView
                        Margin="8,0"
                        BackgroundColor="#FF3A3A3A"
                        HeightRequest="30"
                        WidthRequest="1">
                        <BoxView.IsVisible>
                            <OnPlatform x:TypeArguments="x:Boolean">
                                <On Platform="iOS" Value="False" />
                                <On Platform="Default" Value="True" />
                            </OnPlatform>
                        </BoxView.IsVisible>
                    </BoxView>

                    <!--  Velocidad (oculto en iOS - muy grande)  -->
                    <Border
                        Padding="{StaticResource PlayerSpeedContainerPadding}"
                        BackgroundColor="#FF2A2A2A"
                        StrokeShape="RoundRectangle 4"
                        StrokeThickness="0">
                        <Border.IsVisible>
                            <OnPlatform x:TypeArguments="x:Boolean">
                                <On Platform="iOS" Value="False" />
                                <On Platform="Default" Value="True" />
                            </OnPlatform>
                        </Border.IsVisible>
                        <HorizontalStackLayout Spacing="8">
                            <Label
                                FontSize="{StaticResource FontSizeBody}"
                                Text="{Binding SpeedText}"
                                TextColor="White"
                                VerticalOptions="Center" />
                            <HorizontalStackLayout Spacing="4">
                                <Border
                                    Padding="{StaticResource PlayerSpeedButtonPadding}"
                                    BackgroundColor="#FF3A3A3A"
                                    StrokeShape="RoundRectangle 4"
                                    StrokeThickness="0">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding SetSpeedCommand}" CommandParameter="0.25" />
                                    </Border.GestureRecognizers>
                                    <Label
                                        FontSize="{StaticResource FontSizeBody}"
                                        Text="0.25x"
                                        TextColor="#FFB1B1B1" />
                                </Border>
                                <Border
                                    Padding="{StaticResource PlayerSpeedButtonPadding}"
                                    BackgroundColor="#FF3A3A3A"
                                    StrokeShape="RoundRectangle 4"
                                    StrokeThickness="0">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding SetSpeedCommand}" CommandParameter="0.5" />
                                    </Border.GestureRecognizers>
                                    <Label
                                        FontSize="{StaticResource FontSizeBody}"
                                        Text="0.5x"
                                        TextColor="#FFB1B1B1" />
                                </Border>
                                <Border
                                    Padding="{StaticResource PlayerSpeedButtonPadding}"
                                    BackgroundColor="#FF3A3A3A"
                                    StrokeShape="RoundRectangle 4"
                                    StrokeThickness="0">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding SetSpeedCommand}" CommandParameter="1" />
                                    </Border.GestureRecognizers>
                                    <Label
                                        FontSize="{StaticResource FontSizeBody}"
                                        Text="1x"
                                        TextColor="#FFB1B1B1" />
                                </Border>
                                <Border
                                    Padding="{StaticResource PlayerSpeedButtonPadding}"
                                    BackgroundColor="#FF3A3A3A"
                                    StrokeShape="RoundRectangle 4"
                                    StrokeThickness="0">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding SetSpeedCommand}" CommandParameter="2" />
                                    </Border.GestureRecognizers>
                                    <Label
                                        FontSize="{StaticResource FontSizeBody}"
                                        Text="2x"
                                        TextColor="#FFB1B1B1" />
                                </Border>
                            </HorizontalStackLayout>
                        </HorizontalStackLayout>
                    </Border>
                </HorizontalStackLayout>

            </VerticalStackLayout>
            </Grid>
        </Border>

        <!--  Barra de navegación y filtros (oculta en iOS, WinUI y MacCatalyst - en desktop está integrada en panel lateral)  -->
        <Border
            x:Name="NavigationFiltersBorder"
            Grid.Row="2"
            Grid.Column="0"
            Stroke="#FF3A3A3A"
            StrokeShape="RoundRectangle 8"
            StrokeThickness="0">
            <Border.IsVisible>
                <OnPlatform x:TypeArguments="x:Boolean">
                    <On Platform="iOS" Value="False" />
                    <On Platform="WinUI" Value="False" />
                    <On Platform="MacCatalyst" Value="False" />
                    <On Platform="Default" Value="True" />
                </OnPlatform>
            </Border.IsVisible>
            <Border.BackgroundColor>
                <OnPlatform x:TypeArguments="Color">
                    <On Platform="WinUI" Value="#FF121212" />
                    <On Platform="Default" Value="#FF121212" />
                </OnPlatform>
            </Border.BackgroundColor>
            <Border.Margin>
                <OnPlatform x:TypeArguments="Thickness">
                    <On Platform="WinUI" Value="16,0,16,8" />
                    <On Platform="Default" Value="16,0,16,16" />
                </OnPlatform>
            </Border.Margin>
            <Border.Padding>
                <OnPlatform x:TypeArguments="Thickness">
                    <On Platform="WinUI" Value="8,4" />
                    <On Platform="Default" Value="12" />
                </OnPlatform>
            </Border.Padding>
            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="16">
                
                <!--  Navegación anterior  -->
                <HorizontalStackLayout Grid.Column="0" Spacing="8">
                    <Border
                        Padding="12,8"
                        BackgroundColor="#FF2A2A2A"
                        IsEnabled="{Binding CanGoPrevious}"
                        Opacity="{Binding CanGoPrevious, Converter={StaticResource BoolToOpacityConverter}}"
                        StrokeShape="RoundRectangle 4"
                        StrokeThickness="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding PreviousVideoCommand}" />
                        </Border.GestureRecognizers>
                        <HorizontalStackLayout Spacing="6">
                            <controls:SymbolIcon
                                HeightRequest="{StaticResource IconSizeMedium}"
                                SymbolName="chevron.left"
                                TintColor="White"
                                WidthRequest="{StaticResource IconSizeMedium}" />
                            <Label
                                FontSize="{StaticResource FontSizeBody}"
                                Text="Anterior"
                                TextColor="White"
                                VerticalOptions="Center" />
                        </HorizontalStackLayout>
                    </Border>
                </HorizontalStackLayout>
                
                <!--  Filtros y posición  -->
                <VerticalStackLayout
                    Grid.Column="1"
                    HorizontalOptions="Center"
                    Spacing="8">
                    
                    <!--  Indicador de posición en playlist  -->
                    <HorizontalStackLayout HorizontalOptions="Center" Spacing="12">
                        <Label
                            FontSize="{StaticResource FontSizeBody}"
                            Text="{Binding PlaylistPositionText}"
                            TextColor="#FFB1B1B1"
                            VerticalOptions="Center" />
                        
                        <!--  Botón para mostrar/ocultar filtros  -->
                        <Border
                            Padding="10,6"
                            BackgroundColor="#FF2A2A2A"
                            StrokeShape="RoundRectangle 4"
                            StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ToggleFiltersCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="6">
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeSmall}"
                                    SymbolName="line.3.horizontal.decrease"
                                    TintColor="#FFAAAAAA"
                                    WidthRequest="{StaticResource IconSizeSmall}" />
                                <Label
                                    FontSize="{StaticResource FontSizeSmall}"
                                    Text="Filtros"
                                    TextColor="#FFAAAAAA"
                                    VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>
                    </HorizontalStackLayout>
                    
                    <!--  Panel de filtros (colapsable)  -->
                    <HorizontalStackLayout
                        HorizontalOptions="Center"
                        IsVisible="{Binding ShowFilters}"
                        Spacing="12">
                        
                        <!--  Filtro de atleta (Dropdown)  -->
                        <Border
                            x:Name="AthleteDropdown"
                            Padding="10,8"
                            BackgroundColor="#FF2A2A2A"
                            StrokeShape="RoundRectangle 4"
                            StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnAthleteDropdownTapped" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="8" WidthRequest="150">
                                <Label
                                    FontSize="{StaticResource FontSizeSmall}"
                                    HorizontalOptions="FillAndExpand"
                                    Text="{Binding SelectedAthlete.DisplayName, FallbackValue='Atleta'}"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeXSmall}"
                                    SymbolName="chevron.down"
                                    TintColor="#FF888888"
                                    VerticalOptions="Center"
                                    WidthRequest="{StaticResource IconSizeXSmall}" />
                            </HorizontalStackLayout>
                        </Border>
                        
                        <!--  Filtro de sección (Dropdown)  -->
                        <Border
                            x:Name="SectionDropdown"
                            Padding="10,8"
                            BackgroundColor="#FF2A2A2A"
                            StrokeShape="RoundRectangle 4"
                            StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnSectionDropdownTapped" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="8" WidthRequest="130">
                                <Label
                                    FontSize="{StaticResource FontSizeSmall}"
                                    HorizontalOptions="FillAndExpand"
                                    Text="{Binding SelectedSection.DisplayName, FallbackValue='Sección'}"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeXSmall}"
                                    SymbolName="chevron.down"
                                    TintColor="#FF888888"
                                    VerticalOptions="Center"
                                    WidthRequest="{StaticResource IconSizeXSmall}" />
                            </HorizontalStackLayout>
                        </Border>
                        
                        <!--  Filtro de categoría (Dropdown)  -->
                        <Border
                            x:Name="CategoryDropdown"
                            Padding="10,8"
                            BackgroundColor="#FF2A2A2A"
                            StrokeShape="RoundRectangle 4"
                            StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnCategoryDropdownTapped" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="8" WidthRequest="150">
                                <Label
                                    FontSize="{StaticResource FontSizeSmall}"
                                    HorizontalOptions="FillAndExpand"
                                    Text="{Binding SelectedCategory.DisplayName, FallbackValue='Categoría'}"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeXSmall}"
                                    SymbolName="chevron.down"
                                    TintColor="#FF888888"
                                    VerticalOptions="Center"
                                    WidthRequest="{StaticResource IconSizeXSmall}" />
                            </HorizontalStackLayout>
                        </Border>
                        
                        <!--  Botón limpiar filtros  -->
                        <Border
                            Padding="10,6"
                            BackgroundColor="#FF3A3A3A"
                            StrokeShape="RoundRectangle 4"
                            StrokeThickness="0">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ClearFiltersCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="4">
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeSmall}"
                                    SymbolName="xmark"
                                    TintColor="#FFB1B1B1"
                                    WidthRequest="{StaticResource IconSizeSmall}" />
                                <Label
                                    FontSize="{StaticResource FontSizeSmall}"
                                    Text="Limpiar"
                                    TextColor="#FFB1B1B1"
                                    VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>
                    </HorizontalStackLayout>
                </VerticalStackLayout>
                
                <!--  Navegación siguiente  -->
                <HorizontalStackLayout Grid.Column="2" Spacing="8">
                    <Border
                        Padding="12,8"
                        BackgroundColor="#FF2A2A2A"
                        IsEnabled="{Binding CanGoNext}"
                        Opacity="{Binding CanGoNext, Converter={StaticResource BoolToOpacityConverter}}"
                        StrokeShape="RoundRectangle 4"
                        StrokeThickness="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding NextVideoCommand}" />
                        </Border.GestureRecognizers>
                        <HorizontalStackLayout Spacing="6">
                            <Label
                                FontSize="{StaticResource FontSizeBody}"
                                Text="Siguiente"
                                TextColor="White"
                                VerticalOptions="Center" />
                            <controls:SymbolIcon
                                HeightRequest="{StaticResource IconSizeMedium}"
                                SymbolName="chevron.right"
                                TintColor="White"
                                WidthRequest="{StaticResource IconSizeMedium}" />
                        </HorizontalStackLayout>
                    </Border>
                </HorizontalStackLayout>
            </Grid>
        </Border>

        <!-- ===================== APP FOOTER (Fila 3) ===================== -->
        <controls:AppFooter
            Grid.Row="3"
            Grid.ColumnSpan="5"
            ShowSyncInfo="{Binding IsMultiVideoLayout}"
            SyncStatusText="{Binding SyncStatusText}"
            SyncDeltaText="{Binding SyncDeltaText}" />

        <!-- ===== POPUP: TABLA DE TIEMPOS DETALLADA ===== -->
        <Grid
            Grid.RowSpan="2"
            Grid.ColumnSpan="3"
            BackgroundColor="#CC000000"
            IsVisible="{Binding ShowDetailedTimesPopup}">
            <Border
                Margin="12"
                Padding="12"
                BackgroundColor="#FF1E1E1E"
                HorizontalOptions="Fill"
                VerticalOptions="Fill"
                Stroke="#FF3A3A3A"
                StrokeShape="RoundRectangle 4"
                StrokeThickness="1">
                <Grid RowDefinitions="Auto,*,Auto" RowSpacing="16">
                    <!-- Cabecera -->
                    <Grid ColumnDefinitions="*,Auto,Auto,Auto,Auto,Auto" ColumnSpacing="12">
                        <VerticalStackLayout Grid.Column="0" Spacing="2">
                            <Label
                                FontAttributes="None"
                                FontSize="{StaticResource FontSizeTitle}"
                                Text="Tiempos por Sección"
                                TextColor="White" />
                            <Label
                                FontSize="{StaticResource FontSizeSmall}"
                                LineBreakMode="TailTruncation"
                                Text="{Binding VideoClip.Session.DisplayName}"
                                TextColor="#FFCCCCCC" />
                        </VerticalStackLayout>
                        
                        <!-- Selector de atleta de referencia (dropdown estilo chip) -->
                        <Grid Grid.Column="1" ColumnDefinitions="*,Auto" ColumnSpacing="6" VerticalOptions="Center">
                            <!-- Botón que abre el dropdown -->
                            <Border
                                Grid.Column="0"
                                Padding="12,8"
                                BackgroundColor="#FF404040"
                                Stroke="#FF3A3A3A"
                                StrokeShape="RoundRectangle 4"
                                MinimumWidthRequest="180">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ToggleAthleteDropdownCommand}" />
                                </Border.GestureRecognizers>
                                <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                                    <Label
                                        Grid.Column="0"
                                        FontSize="{StaticResource FontSizeSubtitle}"
                                        Text="{Binding SelectedDetailedTimesAthleteName}"
                                        TextColor="White"
                                        LineBreakMode="TailTruncation"
                                        VerticalOptions="Center" />
                                    <controls:SymbolIcon
                                        Grid.Column="1"
                                        HeightRequest="12"
                                        SymbolName="chevron.down"
                                        TintColor="#FFB1B1B1"
                                        WidthRequest="12"
                                        VerticalOptions="Center" />
                                </Grid>
                            </Border>
                            <!-- Botón limpiar -->
                            <Border
                                Grid.Column="1"
                                Padding="6"
                                BackgroundColor="Transparent"
                                Stroke="Transparent"
                                StrokeShape="RoundRectangle 4"
                                IsVisible="{Binding HasSelectedDetailedTimesAthlete}">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ClearDetailedTimesAthleteCommand}" />
                                </Border.GestureRecognizers>
                                <controls:SymbolIcon
                                    HeightRequest="{StaticResource IconSizeSmall}"
                                    SymbolName="xmark.circle.fill"
                                    TintColor="#FFB1B1B1"
                                    WidthRequest="{StaticResource IconSizeSmall}" />
                            </Border>
                        </Grid>
                        
                        <!-- Botón de opciones de informe -->
                        <Border
                            Grid.Column="2"
                            Padding="10,8"
                            BackgroundColor="#FF404040"
                            Stroke="#FF3A3A3A"
                            StrokeShape="RoundRectangle 4"
                            VerticalOptions="Center">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ToggleReportOptionsPanelCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="6">
                                <controls:SymbolIcon
                                    HeightRequest="14"
                                    SymbolName="slider.horizontal.3"
                                    TintColor="White"
                                    WidthRequest="14"
                                    VerticalOptions="Center" />
                                <Label
                                    FontSize="{StaticResource FontSizeSubtitle}"
                                    Text="Secciones"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                                <controls:SymbolIcon
                                    HeightRequest="10"
                                    SymbolName="chevron.down"
                                    TintColor="#FFB1B1B1"
                                    WidthRequest="10"
                                    VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>
                        
                        <!-- Botones Exportar -->
                        <Border
                            Grid.Column="3"
                            Padding="10,8"
                            BackgroundColor="#FF404040"
                            Stroke="#FF3A3A3A"
                            StrokeShape="RoundRectangle 4"
                            VerticalOptions="Center"
                            Opacity="{Binding IsExportingDetailedTimes, Converter={StaticResource BoolToOpacityConverter}}">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ExportDetailedTimesHtmlCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="6">
                                <controls:SymbolIcon
                                    HeightRequest="14"
                                    SymbolName="arrow.down.doc"
                                    TintColor="White"
                                    WidthRequest="14"
                                    VerticalOptions="Center" />
                                <Label
                                    FontSize="{StaticResource FontSizeSubtitle}"
                                    Text="HTML"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>
                        <Border
                            Grid.Column="4"
                            Padding="10,8"
                            BackgroundColor="#FF404040"
                            Stroke="#FF3A3A3A"
                            StrokeShape="RoundRectangle 4"
                            VerticalOptions="Center"
                            Opacity="{Binding IsExportingDetailedTimes, Converter={StaticResource BoolToOpacityConverter}}">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ExportDetailedTimesPdfCommand}" />
                            </Border.GestureRecognizers>
                            <HorizontalStackLayout Spacing="6">
                                <controls:SymbolIcon
                                    HeightRequest="14"
                                    SymbolName="doc.richtext"
                                    TintColor="White"
                                    WidthRequest="14"
                                    VerticalOptions="Center" />
                                <Label
                                    FontSize="{StaticResource FontSizeSubtitle}"
                                    Text="PDF"
                                    TextColor="White"
                                    VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </Border>
                        
                        <Border
                            Grid.Column="5"
                            Padding="6"
                            BackgroundColor="Transparent"
                            Stroke="Transparent"
                            StrokeShape="RoundRectangle 4"
                            VerticalOptions="Start">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding CloseDetailedTimesPopupCommand}" />
                            </Border.GestureRecognizers>
                            <controls:SymbolIcon
                                HeightRequest="{StaticResource IconSizeLarge}"
                                SymbolName="xmark"
                                TintColor="#FFB1B1B1"
                                WidthRequest="{StaticResource IconSizeLarge}" />
                        </Border>
                    </Grid>
                    
                    <!-- Contenido HTML/SVG (gráficos + tablas) -->
                    <Grid Grid.Row="1">
                        <Border
                            BackgroundColor="White"
                            StrokeShape="RoundRectangle 12"
                            StrokeThickness="0">
                            <WebView BackgroundColor="White">
                                <WebView.Source>
                                    <HtmlWebViewSource Html="{Binding DetailedTimesHtml}" />
                                </WebView.Source>
                            </WebView>
                        </Border>
                        <ActivityIndicator
                            IsRunning="{Binding IsLoadingDetailedTimes}"
                            IsVisible="{Binding IsLoadingDetailedTimes}"
                            Color="#FF6DDDFF"
                            HeightRequest="48"
                            WidthRequest="48"
                            HorizontalOptions="Center"
                            VerticalOptions="Center" />
                    </Grid>
                    
                    <!-- Pie -->
                    <Label
                        Grid.Row="2"
                        FontSize="{StaticResource FontSizeSmall}"
                        Text="Lap = tiempo parcial · Acum. = tiempo acumulado · CV% = Coeficiente de Variación = (σ / x̄) × 100 (menor = más consistente)"
                        TextColor="#FFCCCCCC"
                        VerticalOptions="Center" />
                    
                    <!-- ===== DROPDOWNS FLOTANTES (absolutos sobre todo el contenido) ===== -->
                    
                    <!-- Dropdown flotante de atletas -->
                    <Border
                        Grid.RowSpan="3"
                        Margin="0,52,380,0"
                        Padding="8"
                        BackgroundColor="#FF404040"
                        HorizontalOptions="End"
                        IsVisible="{Binding IsAthleteDropdownExpanded}"
                        Stroke="#FF3A3A3A"
                        StrokeShape="RoundRectangle 4"
                        StrokeThickness="1"
                        VerticalOptions="Start"
                        ZIndex="200"
                        MaximumHeightRequest="280"
                        MinimumWidthRequest="220"
                        InputTransparent="False">
                        <ScrollView MaximumHeightRequest="260">
                            <VerticalStackLayout
                                BindableLayout.ItemsSource="{Binding DetailedTimesAthletes}"
                                Spacing="2">
                                <BindableLayout.ItemTemplate>
                                    <DataTemplate x:DataType="models:AthletePickerItem">
                                        <Border
                                            Padding="12,8"
                                            BackgroundColor="Transparent"
                                            Stroke="Transparent"
                                            StrokeShape="RoundRectangle 4">
                                            <Border.GestureRecognizers>
                                                <TapGestureRecognizer 
                                                    Command="{Binding Source={x:Reference ThisPage}, Path=BindingContext.SelectDetailedTimesAthleteCommand}"
                                                    CommandParameter="{Binding .}" />
                                            </Border.GestureRecognizers>
                                            <Label
                                                FontSize="{StaticResource FontSizeSubtitle}"
                                                Text="{Binding DisplayName}"
                                                TextColor="White"
                                                VerticalOptions="Center" />
                                        </Border>
                                    </DataTemplate>
                                </BindableLayout.ItemTemplate>
                            </VerticalStackLayout>
                        </ScrollView>
                    </Border>
                    
                    <!-- Panel flotante de opciones de secciones -->
                    <Border
                        Grid.RowSpan="3"
                        Margin="0,52,200,0"
                        Padding="16"
                        BackgroundColor="#FF404040"
                        HorizontalOptions="End"
                        IsVisible="{Binding ShowReportOptionsPanel}"
                        Stroke="#FF3A3A3A"
                        StrokeShape="RoundRectangle 8"
                        StrokeThickness="1"
                        VerticalOptions="Start"
                        ZIndex="300"
                        MinimumWidthRequest="300"
                        InputTransparent="False">
                        <VerticalStackLayout Spacing="12">
                            <Label
                                FontAttributes="None"
                                FontSize="{StaticResource FontSizeSubtitle}"
                                Text="Secciones del informe"
                                TextColor="White" />
                            
                            <!-- Presets -->
                            <HorizontalStackLayout Spacing="8">
                                <Border
                                    Padding="8,4"
                                    BackgroundColor="#FF3A3A3A"
                                    Stroke="Transparent"
                                    StrokeShape="RoundRectangle 4">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding ApplyQuickSummaryPresetCommand}" />
                                    </Border.GestureRecognizers>
                                    <Label
                                        FontSize="{StaticResource FontSizeSmall}"
                                        Text="Resumen rápido"
                                        TextColor="#FF6DDDFF" />
                                </Border>
                                <Border
                                    Padding="8,4"
                                    BackgroundColor="#FF3A3A3A"
                                    Stroke="Transparent"
                                    StrokeShape="RoundRectangle 4">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding ApplyFullAnalysisPresetCommand}" />
                                    </Border.GestureRecognizers>
                                    <Label
                                        FontSize="{StaticResource FontSizeSmall}"
                                        Text="Análisis completo"
                                        TextColor="#FF6DDDFF" />
                                </Border>
                                <Border
                                    Padding="8,4"
                                    BackgroundColor="#FF3A3A3A"
                                    Stroke="Transparent"
                                    StrokeShape="RoundRectangle 4">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding ApplyAthleteReportPresetCommand}" />
                                    </Border.GestureRecognizers>
                                    <Label
                                        FontSize="{StaticResource FontSizeSmall}"
                                        Text="Informe atleta"
                                        TextColor="#FF6DDDFF" />
                                </Border>
                            </HorizontalStackLayout>
                            
                            <BoxView HeightRequest="1" BackgroundColor="#FF3A3A3A" />
                            
                            <!-- Checkboxes de secciones -->
                            <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto,Auto,Auto,Auto" RowSpacing="10" ColumnSpacing="16">
                                <HorizontalStackLayout Grid.Row="0" Grid.Column="0" Spacing="8">
                                    <CheckBox IsChecked="{Binding ReportOptions.ShowSessionHeader}" Color="#FF6DDDFF" />
                                    <Label Text="Cabecera de sesión" TextColor="White" FontSize="{StaticResource FontSizeSmall}" VerticalOptions="Center" />
                                </HorizontalStackLayout>
                                <HorizontalStackLayout Grid.Row="0" Grid.Column="1" Spacing="8">
                                    <CheckBox IsChecked="{Binding ReportOptions.ShowTrainingSummary}" Color="#FF6DDDFF" />
                                    <Label Text="Resumen entrenamiento" TextColor="White" FontSize="{StaticResource FontSizeSmall}" VerticalOptions="Center" />
                                </HorizontalStackLayout>
                                
                                <HorizontalStackLayout Grid.Row="1" Grid.Column="0" Spacing="8">
                                    <CheckBox IsChecked="{Binding ReportOptions.ShowGroupConsistency}" Color="#FF6DDDFF" />
                                    <Label Text="Consistencia grupo" TextColor="White" FontSize="{StaticResource FontSizeSmall}" VerticalOptions="Center" />
                                </HorizontalStackLayout>
                                <HorizontalStackLayout Grid.Row="1" Grid.Column="1" Spacing="8">
                                    <CheckBox IsChecked="{Binding ReportOptions.ShowMinMaxCharts}" Color="#FF6DDDFF" />
                                    <Label Text="Gráficos Min-Max" TextColor="White" FontSize="{StaticResource FontSizeSmall}" VerticalOptions="Center" />
                                </HorizontalStackLayout>
                                
                                <HorizontalStackLayout Grid.Row="2" Grid.Column="0" Spacing="8">
                                    <CheckBox IsChecked="{Binding ReportOptions.ShowTimeTables}" Color="#FF6DDDFF" />
                                    <Label Text="Tablas de tiempos" TextColor="White" FontSize="{StaticResource FontSizeSmall}" VerticalOptions="Center" />
                                </HorizontalStackLayout>
                                <HorizontalStackLayout Grid.Row="2" Grid.Column="1" Spacing="8">
                                    <CheckBox IsChecked="{Binding ReportOptions.ShowIndividualConsistency}" Color="#FF6DDDFF" />
                                    <Label Text="Consistencia individual" TextColor="White" FontSize="{StaticResource FontSizeSmall}" VerticalOptions="Center" />
                                </HorizontalStackLayout>
                                
                                <HorizontalStackLayout Grid.Row="3" Grid.Column="0" Spacing="8">
                                    <CheckBox IsChecked="{Binding ReportOptions.ShowLapAnalysis}" Color="#FF6DDDFF" />
                                    <Label Text="Análisis de parciales" TextColor="White" FontSize="{StaticResource FontSizeSmall}" VerticalOptions="Center" />
                                </HorizontalStackLayout>
                                <HorizontalStackLayout Grid.Row="3" Grid.Column="1" Spacing="8">
                                    <CheckBox IsChecked="{Binding ReportOptions.ShowRanking}" Color="#FF6DDDFF" />
                                    <Label Text="Ranking" TextColor="White" FontSize="{StaticResource FontSizeSmall}" VerticalOptions="Center" />
                                </HorizontalStackLayout>
                                
                                <HorizontalStackLayout Grid.Row="4" Grid.Column="0" Spacing="8">
                                    <CheckBox IsChecked="{Binding ReportOptions.ShowPenalties}" Color="#FF6DDDFF" />
                                    <Label Text="Penalizaciones" TextColor="White" FontSize="{StaticResource FontSizeSmall}" VerticalOptions="Center" />
                                </HorizontalStackLayout>
                                <HorizontalStackLayout Grid.Row="4" Grid.Column="1" Spacing="8">
                                    <CheckBox IsChecked="{Binding ReportOptions.ShowAthleteProfile}" Color="#FF6DDDFF" />
                                    <Label Text="Perfil del atleta" TextColor="White" FontSize="{StaticResource FontSizeSmall}" VerticalOptions="Center" />
                                </HorizontalStackLayout>
                            </Grid>
                            
                            <BoxView HeightRequest="1" BackgroundColor="#FF3A3A3A" />
                            
                            <!-- Botón aplicar -->
                            <Button
                                BackgroundColor="#FF6DDDFF"
                                Command="{Binding ToggleReportOptionsPanelCommand}"
                                Text="Aplicar"
                                TextColor="#FF1E1E1E"
                                HeightRequest="36"
                                Padding="16,0" />
                        </VerticalStackLayout>
                    </Border>
                </Grid>
            </Border>
        </Grid>

    </Grid>
</ContentPage>